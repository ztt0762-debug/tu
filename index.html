<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ‰ä½ æ—§çš„metaå’Œiconé“¾æ¥ â–¼â–¼â–¼ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">


<!-- 1. (æ ¸å¿ƒ) ä¸ºè‹¹æœè®¾å¤‡è®¾ç½®ä¸»å±å¹•å›¾æ ‡ -->
<link rel="apple-touch-icon" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<link rel="apple-touch-icon" sizes="167x167" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">

<!-- 2. (æ ¸å¿ƒ) é“¾æ¥åˆ°manifestæ–‡ä»¶ -->
<link rel="manifest" href="manifest.json">

<!-- 3. (æ ¸å¿ƒ) å‘Šè¯‰è‹¹æœè®¾å¤‡ï¼Œè¿™æ˜¯ä¸€ä¸ªWebåº”ç”¨ï¼Œå¯ä»¥å…¨å±æ˜¾ç¤º -->
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- 4. (æ ¸å¿ƒ) è®¾ç½®è‹¹æœè®¾å¤‡å…¨å±æ¨¡å¼ä¸‹çš„çŠ¶æ€æ æ ·å¼ -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- 5. (å¯é€‰) è®¾ç½®åº”ç”¨åœ¨ä¸»å±å¹•ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜ -->
<meta name="apple-mobile-web-app-title" content="EPhoneï¼ˆå…”kæœºç‰ˆï¼‰">

<!-- 6. (å…¼å®¹) ä¸ºéƒ¨åˆ†å®‰å“æµè§ˆå™¨æä¾›æ”¯æŒ -->
<meta name="mobile-web-app-capable" content="yes">

<!-- 7. (å¤‡ç”¨) æ ‡å‡†æµè§ˆå™¨é¡µç­¾å›¾æ ‡ -->
<link rel="icon" type="image/png" href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg">
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


    <title>EPhoneï¼ˆå…”kæœºç‰ˆï¼‰</title>

    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://phoebeboo.github.io/mewoooo/pp.js" defer></script>
    <script src="main-app.js" defer></script>
    <script src="https://zhazhashidashuaige.github.io/doudai/game-hall.js" defer></script>

    <style>
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff;    --status-bar-text-color: var(--accent-color); }
/* â–¼â–¼â–¼ ç”¨è¿™å—ç»ˆæä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ html å’Œ body æ ·å¼ â–¼â–¼â–¼ */
html {
    -webkit-text-size-adjust: 100%;
    height: 100%; /* ç¡®ä¿htmlå…ƒç´ ä¹Ÿèƒ½æ’‘æ»¡ */
}

body {
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    background-color: #f0f2f5;
    height: 100%; /* è®©bodyä¹Ÿæ’‘æ»¡çˆ¶å…ƒç´ (html) */
    overflow: hidden; /* é˜²æ­¢bodyæœ¬èº«å‡ºç°æ»šåŠ¨æ¡ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 2. è®© #phone-screen æˆä¸ºæ–°çš„â€œæ ¹â€å®¹å™¨ï¼Œæ’‘æ»¡æ•´ä¸ªæµè§ˆå™¨çª—å£ */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ #phone-screen æ ·å¼ â–¼â–¼â–¼ */
#phone-screen {
    width: 100%;
    height: 100vh;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #ffffff; /* â˜… ä¿®æ”¹è¿™é‡Œä¸ºç™½è‰² */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 3. ã€æ ¸å¿ƒã€‘éšè—æ‰æ¨¡æ‹Ÿå™¨çš„çŠ¶æ€æ  */
#status-bar {
    display: none;
}

/* 4. ã€æ ¸å¿ƒã€‘è®©æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨è‡ªåŠ¨é€‚åº”iPhoneçš„â€œåˆ˜æµ·â€å®‰å…¨åŒº */
.header, .qzone-header {
    /* ä½¿ç”¨ env(safe-area-inset-top) è‡ªåŠ¨è·å–é¡¶éƒ¨å®‰å…¨è·ç¦» */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* 5. ã€æ ¸å¿ƒã€‘è®©èŠå¤©è¾“å…¥æ¡†å’Œåº•éƒ¨å¯¼èˆªæ è‡ªåŠ¨é€‚åº”iPhoneåº•éƒ¨çš„â€œå°é»‘æ¡â€å®‰å…¨åŒº */
#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

#chat-list-bottom-nav {
     padding-bottom: env(safe-area-inset-bottom);
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

      /* ä¿®æ”¹åçš„ä»£ç å— */
/* â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å¯çˆ±åœ†æ¶¦ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ status-bar å’Œ battery æ ·å¼ â–¼â–¼â–¼ */

#status-bar { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    padding: 12px 20px; 
    display: none; 
    justify-content: space-between; 
    align-items: center; 
    color: var(--accent-color); /* â˜… ä¿®æ”¹ï¼šçŠ¶æ€æ æ–‡å­—/å›¾æ ‡é¢œè‰²ï¼Œç°åœ¨ä¼šè·Ÿéšä¸»é¢˜è‰²ï¼ */
    z-index: 10; 
    font-size: 14px; 
    box-sizing: border-box; 
    pointer-events: none; 
    /* â˜… æ–°å¢ï¼šä½¿ç”¨ä½ çš„è‡ªå®šä¹‰å­—ä½“ï¼Œå¹¶åŠ ä¸ŠæŸ”å’Œçš„å…‰æ™•ï¼Œè®©å®ƒæ›´å¯çˆ± */
    font-family: 'bulangni', sans-serif; 
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.5); 
}

#status-bar-time { 
    font-weight: 600; 
}

.battery-container { 
    display: flex; 
    align-items: center; 
    gap: 5px; 
}

.battery-icon { 
    width: 25px; 
    height: 12px; 
    border: 1.5px solid currentColor; /* â˜… è¾¹æ¡†åŠ ç²—ä¸€ç‚¹ç‚¹ */
    border-radius: 5px; /* â˜… ä¿®æ”¹ï¼šå¢åŠ åœ†è§’ï¼Œè®©å®ƒæ›´åœ†æ¶¦å¯çˆ± */
    position: relative; 
    padding: 1px; 
}

.battery-icon::after { 
    content: ''; 
    position: absolute; 
    right: -4px; /* å¾®è°ƒä½ç½® */
    top: 2.5px; 
    width: 2px; 
    height: 5px; 
    background-color: currentColor; 
    border-radius: 0 2px 2px 0; /* â˜… å¤´éƒ¨å°å—ä¹Ÿå˜åœ†æ¶¦ */
}

.battery-level { 
    height: 100%; 
    background-color: currentColor; /* â˜… é»˜è®¤å¡«å……è‰²ä¹Ÿè·Ÿéšä¸»é¢˜è‰² */
    border-radius: 3px; /* â˜… å†…éƒ¨å¡«å……æ¡ä¹Ÿå˜åœ†æ¶¦ */
    transition: width 0.5s ease; 
}

/* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè®©å……ç”µæ—¶ä¹Ÿæ˜¾ç¤ºä¸»é¢˜è‰²ï¼ */
.battery-container.charging .battery-level { 
    animation: charge-breath 2s infinite; 
}
@keyframes charge-breath { 
    0%, 100% { opacity: 1; } 
    50% { opacity: 0.7; } 
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€ç»ˆæä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç å®Œæ•´æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ .screen æ ·å¼ â–¼â–¼â–¼ */
.screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;  /* â˜… æ–°å¢ */
    bottom: 0; /* â˜… æ–°å¢ */
    width: 100%; /* ä¿ç•™ */
    /* height: 100%; */ /* â˜… æ³¨é‡Šæˆ–åˆ é™¤æ‰è¿™ä¸€è¡Œ */

    display: flex;
    flex-direction: column;
    overflow: hidden;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
       .header {
    position: relative;
    z-index: 15;
    flex-shrink: 0;
    padding: 15px 15px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    
    /* â–¼â–¼â–¼ æ–°å¢ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼ */
    height: 110px;               /* â˜… æ–°å¢ï¼šå¼ºåˆ¶è®¾ç½®ä¸€ä¸ªç»Ÿä¸€çš„é«˜åº¦ */
    box-sizing: border-box;     /* â˜… æ–°å¢ï¼šç¡®ä¿é«˜åº¦è®¡ç®—åŒ…å«å†…è¾¹è· */
    /* â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² */
}

        .header .header-actions { display: flex; align-items: center; gap: 5px; }
        /* â–¼â–¼â–¼ ã€è§¦æ‘¸åŒºåŸŸä¼˜åŒ–ç‰ˆã€‘æ›¿æ¢æ—§çš„ .header .back-btn, .header .action-btn æ ·å¼ â–¼â–¼â–¼ */
.header .back-btn, .header .action-btn {
    font-size: 24px; /* ä¿æŒå›¾æ ‡å¤§å°ä¸å˜ */
    cursor: pointer;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;

    /* --- æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ --- */
    width: 40px;              /* 1. å°†æŒ‰é’®å®½åº¦ä»30pxå¢åŠ åˆ°40px */
    height: 40px;             /* 2. å°†æŒ‰é’®é«˜åº¦ä»30pxå¢åŠ åˆ°40px */
    border-radius: 50%;       /* 3. (å¯é€‰ä½†æ¨è) è®©æŒ‰é’®å˜æˆåœ†å½¢ï¼Œæ›´ç¾è§‚ */
    transition: background-color 0.2s; /* 4. ä¸ºæ‚¬åœæ•ˆæœæ·»åŠ å¹³æ»‘åŠ¨ç”» */
}

/* ã€æ–°å¢ã€‘ä¸ºæŒ‰é’®æ·»åŠ æ‚¬åœ/ç‚¹å‡»æ—¶çš„èƒŒæ™¯è‰²ï¼Œç»™ç”¨æˆ·æ˜ç¡®çš„åé¦ˆ */
.header .back-btn:hover, .header .action-btn:hover {
    background-color: rgba(0, 0, 0, 0.05); /* é¼ æ ‡æ”¾ä¸Šå»æ—¶ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯ */
}
#phone-screen.dark-mode .header .back-btn:hover,
#phone-screen.dark-mode .header .action-btn:hover {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœé¢œè‰² */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


.header .action-btn {
    font-size: 16px; /* ä¸“é—¨ä¸ºâ€œä¸Šä¼ â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰é’®ç¼©å°å­—å· */
    font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€ç‚¹è®©å®ƒæ›´æ¸…æ™° */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
/* â–¼â–¼â–¼ ã€ç»ˆæåˆå¹¶ä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç å®Œæ•´æ›¿æ¢æ‰æ—§çš„ #home-screen, #clock-container, .app-grid æ ·å¼ â–¼â–¼â–¼ */
        
/* 1. (æ ¸å¿ƒ) ä¸ºé”å±å’Œä¸»å±å¹•åº”ç”¨ç›¸åŒçš„å…¨å±å¸ƒå±€ (æ­¤éƒ¨åˆ†ä¿æŒä¸å˜) */
#lock-screen, 
#home-screen {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    
    /* ç”¨paddingæŠŠå†…å®¹æŒ¤è¿›æ¥ï¼ŒåŒæ—¶è®©èƒŒæ™¯é“ºæ»¡å®‰å…¨åŒº */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: 20px;
    padding-right: 20px;
    
    box-sizing: border-box;
}

/* 2. (æ ¸å¿ƒ) å•ç‹¬å¤„ç†é”å±çš„æ–‡å­—ï¼Œè®©å®ƒè‡ªåŠ¨è´´åº• (è¿™æ˜¯æœ¬æ¬¡çš„å”¯ä¸€ä¿®æ”¹) */
#lock-screen-content {
    margin-top: auto; /* å…³é”®ï¼šè‡ªåŠ¨å°†æ­¤å…ƒç´ æ¨åˆ°å®¹å™¨åº•éƒ¨ */
    margin-bottom: 40px; /* â˜… æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ margin-bottom å‘ä¸Šæ¨å¼€ï¼Œè€Œä¸æ˜¯padding */
    text-align: center;
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    font-size: 16px;
    font-weight: 500;
}

/* 3. ä¿æŒä¸»å±å¹•çš„æ—¶é’Ÿå’ŒAppå›¾æ ‡å¸ƒå±€ä¸å˜ */
#clock-container {
    text-align: center;
    color: white;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    margin-bottom: 20px;
    flex-shrink: 0;
    margin-top: 60px; 
}
.app-grid {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
    padding: 20px;
    margin-bottom: 30px; 
}



/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: var(--secondary-bg); margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
/* ä¿®æ”¹åçš„ #world-book-list æ ·å¼ */
/* ã€ç»ˆæä¿®å¤ç‰ˆã€‘ä¸–ç•Œä¹¦ä¸»ç•Œé¢åˆ—è¡¨æ ·å¼ */
#world-book-list {
    flex-grow: 1;          /* è®©åˆ—è¡¨å æ®æ‰€æœ‰å‰©ä½™çš„å‚ç›´ç©ºé—´ */
    overflow-y: auto;      /* å†…å®¹è¶…å‡ºæ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
    min-height: 0;         /* è§£å†³Flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å…¼å®¹æ€§é—®é¢˜ */
    background-color: var(--secondary-bg); /* ä¿ç•™ä½ å–œæ¬¢çš„èƒŒæ™¯è‰² */
    /* æˆ‘ä»¬ä¸å†éœ€è¦ padding-top å’Œ margin-top è¿™ä¸¤ä¸ªæŠ€å·§äº† */
}


/* ä¿®æ”¹åçš„ #chat-list æ ·å¼ï¼Œé€‚é…äº†iOSåº•éƒ¨å®‰å…¨åŒº */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 110px; 
    /* æ ¸å¿ƒä¿®å¤ï¼šå°†åº•éƒ¨å†…è¾¹è·ä» 8px å¢åŠ åˆ° 60pxï¼Œä¸ºå¯¼èˆªæ ç•™å‡ºè¶³å¤Ÿç©ºé—´ */
    padding-bottom: calc(60px + env(safe-area-inset-bottom)); 
    box-sizing: border-box;
}


        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        /* ä¿®æ”¹åçš„ä»£ç  */
/* â–¼â–¼â–¼ ç”¨è¿™å—ã€ç»ˆæä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ #chat-interface-screen å’Œ #chat-messages æ ·å¼ â–¼â–¼â–¼ */

/* 1. èŠå¤©å±å¹•æ€»å®¹å™¨ï¼šè®©å®ƒæˆä¸ºä¸€ä¸ªæ’‘æ»¡å±å¹•çš„Flexåˆ—å¸ƒå±€ */
#chat-interface-screen { 
    background-size: cover; 
    background-position: center; 
    display: flex; /* <-- æ ¸å¿ƒï¼šå¿…é¡»æ˜¯flexå¸ƒå±€ */
    flex-direction: column; /* <-- æ ¸å¿ƒï¼šå­å…ƒç´ å‚ç›´æ’åˆ— */
    height: 100%; /* <-- æ ¸å¿ƒï¼šæ’‘æ»¡çˆ¶å®¹å™¨ */
    overflow: hidden; /* <-- æ ¸å¿ƒï¼šé˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
}

/* 2. èŠå¤©æ¶ˆæ¯åŒºåŸŸï¼šè®©å®ƒè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ï¼Œè€Œä¸æ˜¯å›ºå®šé«˜åº¦ */
#chat-messages {
    flex-grow: 1;           /* â˜…â˜…â˜… æœ€æœ€å…³é”®çš„ä¸€è¡Œï¼è®©å®ƒè‡ªåŠ¨ä¼¸ç¼©ï¼Œå¡«æ»¡å‰©ä½™ç©ºé—´ â˜…â˜…â˜… */
    min-height: 0;          /* ä¸€ä¸ªç¥å¥‡çš„ä¿é™©ä¸ï¼Œè§£å†³Flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å…¼å®¹é—®é¢˜ */
    overflow-y: auto;       /* å†…å®¹è¶…å‡ºæ—¶ï¼Œå…è®¸è‡ªèº«å‚ç›´æ»šåŠ¨ */
    overflow-x: hidden;
    padding: 10px 15px;     /* ä¿ç•™èˆ’é€‚çš„å·¦å³å†…è¾¹è· */
    box-sizing: border-box;

    /* 
     * ä¿ç•™ä½ çš„å¤´éƒ¨é€‚é…æ–¹æ¡ˆï¼š
     * ä¸ºé¡¶éƒ¨åŠé€æ˜çš„headerç•™å‡ºç©ºé—´ï¼ŒåŒæ—¶è®©èƒŒæ™¯å›¾èƒ½é€ä¸Šå»ã€‚
     * 110pxæ˜¯headerçš„é«˜åº¦, -80pxæ˜¯å‘ä¸Šæ‹‰çš„è·ç¦»ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„headeræ ·å¼å¾®è°ƒã€‚
    */
    padding-top: 110px;
    margin-top: -80px;

    /* ä¿æŒå†…éƒ¨æ¶ˆæ¯æ°”æ³¡çš„flexå¸ƒå±€ */
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

/* â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰€æœ‰æ—§çš„ .sender-name æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¿™æ˜¯å‘é€è€…ä¿¡æ¯è¡Œ (åå­—+æ ‡ç­¾) çš„æ€»å®¹å™¨ */
/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘æ˜µç§°/å¤´è¡”ä¸Šç§»ä¿®å¤ â–¼â–¼â–¼ */
/* 
  ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ .group-sender-line æ ·å¼ã€‚
  å®ƒå°†æŠŠåå­—å’Œæ ‡ç­¾æ•´ä½“å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œé¿å…é®æŒ¡æ°”æ³¡ã€‚
*/

.group-sender-line {
    display: flex;
    align-items: center; 
    gap: 8px; 
    font-size: 11px;
    color: #666;
    position: absolute; 
    
    /* â˜…â˜…â˜… ä¿®æ”¹è¿™é‡Œï¼šä» -16px æ”¹ä¸º -18pxï¼Œè®©å®ƒå‘ä¸Šç§»åŠ¨2åƒç´  â˜…â˜…â˜… */
    /* ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½ï¼Œç»§ç»­å‡å°è¿™ä¸ªå€¼ï¼ˆæ¯”å¦‚-20pxï¼‰è®©å®ƒæ›´é«˜ */
    top: -18px;      

    left: 50px;       
    white-space: nowrap; 

    /* ã€æ–°å¢ã€‘ä¸ºäº†ä¿è¯å±‚çº§ï¼Œç¡®ä¿å®ƒåœ¨æ°”æ³¡ä¹‹ä¸Š */
    z-index: 1; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 2. æˆ‘ä»¬ä¸å†éœ€è¦é’ˆå¯¹ .sender-name çš„ç‰¹æ®Šå®šä½äº†ï¼Œå› ä¸ºç°åœ¨éƒ½ç”± .group-sender-line æ§åˆ¶ */
/* æ‰€ä»¥ï¼Œå¯ä»¥æŠŠæ—§çš„ .message-wrapper.ai .sender-name è§„åˆ™åˆ æ‰ï¼Œæˆ–è€…ç”¨è¿™ä¸ªç©ºçš„è§„åˆ™è¦†ç›–æ‰å®ƒ */
.message-wrapper.ai .sender-name {
    /* è¿™ä¸ªè§„åˆ™ç°åœ¨æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®ƒå·²ç»è¢«æ–°çš„ .group-sender-line æ›¿ä»£äº† */
}


/* 3. ã€å…¨æ–°ã€‘è¿™æ˜¯èŠå¤©ç•Œé¢å†…ï¼Œè·Ÿåœ¨åå­—åé¢çš„èº«ä»½å’Œå¤´è¡”æ ‡ç­¾çš„ä¸“å±æ ·å¼ */
.group-sender-tags {
    display: inline-flex; /* ç¡®ä¿å®ƒè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ª flex å®¹å™¨ï¼Œè®©å†…éƒ¨çš„æ ‡ç­¾èƒ½æ°´å¹³æ’åˆ— */
    align-items: center;
    gap: 5px; /* æ ‡ç­¾ä¹‹é—´çš„é—´è· */
}

.group-role-tag, .group-title-tag {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 8px; /* åœ†æ¶¦çš„èƒ¶å›Šå½¢çŠ¶ */
    font-weight: 500;
    line-height: 1.4;
}

/* ç¾¤ä¸»å’Œç®¡ç†å‘˜çš„é¢œè‰² */
.group-role-tag.owner {
    background-color: #FFF2C2;
    color: #D98C00;
    border: 1px solid #FFE89D;
}
.group-role-tag.admin {
    background-color: #D4EDDA;
    color: #155724;
    border: 1px solid #C3E6CB;
}

/* â–¼â–¼â–¼ ã€ç‹¬å®¶ç»ˆæä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ .group-title-tag æ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·å°†è¿™æ•´å—ä»£ç ç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. å…ˆä¸ºã€æ‰€æœ‰ã€‘å¤´è¡”è®¾ç½®ä½ æƒ³è¦çš„ç´«è‰²ä½œä¸ºé»˜è®¤å€¼ */
.group-title-tag {
    background-color: #E9E7FD !important; /* æ·¡ç´«è‰²èƒŒæ™¯ */
    color: #5E548E !important;           /* æ·±ç´«è‰²æ–‡å­— */
    border: 1px solid #D9D5F8 !important; /* ç¨æ·±çš„ç´«è‰²è¾¹æ¡† */
}

/* 2. ç„¶åï¼Œå•ç‹¬ä¸ºã€ç®¡ç†å‘˜ã€‘çš„å¤´è¡”è®¾ç½®ç»¿è‰² */
.group-role-tag.admin ~ .group-title-tag {
    background-color: #D4EDDA !important; /* å¤åˆ¶ç®¡ç†å‘˜æ ‡ç­¾çš„ç»¿è‰² */
    color: #155724 !important;
    border: 1px solid #C3E6CB !important;
}

/* 3. åŒç†ï¼Œä¸ºã€ç¾¤ä¸»ã€‘çš„å¤´è¡”è®¾ç½®é»„è‰² */
.group-role-tag.owner ~ .group-title-tag {
    background-color: #FFF2C2 !important; /* å¤åˆ¶ç¾¤ä¸»æ ‡ç­¾çš„é»„è‰² */
    color: #D98C00 !important;
    border: 1px solid #FFE89D !important;
}


/* === å¤œé—´æ¨¡å¼é€‚é… (åŸç†ç›¸åŒ) === */

/* å¤œé—´æ¨¡å¼ä¸‹çš„é»˜è®¤ç´«è‰² */
#phone-screen.dark-mode .group-title-tag {
    background-color: #3B3355 !important;
    color: #C3B9E7 !important;
    border-color: #514777 !important;
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„ç®¡ç†å‘˜ç»¿è‰² */
#phone-screen.dark-mode .group-role-tag.admin ~ .group-title-tag {
    background-color: #104A3C !important;
    color: #76DDC4 !important;
    border-color: #176854 !important;
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„ç¾¤ä¸»é»„è‰² */
#phone-screen.dark-mode .group-role-tag.owner ~ .group-title-tag {
    background-color: #594200 !important;
    color: #FFD466 !important;
    border-color: #795B00 !important;
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* === ã€å…¨æ–°ã€‘æ¶ˆæ¯å¸ƒå±€ä¸æ—¶é—´æˆ³æ ·å¼ === */

/* 1. æ¶ˆæ¯å•å…ƒçš„æ€»å®¹å™¨ (é‡æ„) */
.message-wrapper {
    display: flex;          /* ä½¿ç”¨Flexå¸ƒå±€ */
    gap: 8px;               /* æ°”æ³¡å’Œæ—¶é—´æˆ³ä¹‹é—´çš„é—´è· */
    align-items: flex-end;  /* æ ¸å¿ƒï¼šè®©æ°”æ³¡å’Œæ—¶é—´æˆ³åº•éƒ¨å¯¹é½ */
    position: relative;
    max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å®½ä¸€ç‚¹ï¼Œå› ä¸ºæ—¶é—´æˆ³ç°åœ¨åœ¨å¤–é¢äº† */
}

/* 2. AIæ¶ˆæ¯å•å…ƒé å·¦ */
.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; /* å¤´åƒã€æ°”æ³¡ã€æ—¶é—´æˆ³ï¼Œä»å·¦åˆ°å³æ’åˆ— */
}

/* 3. ç”¨æˆ·æ¶ˆæ¯å•å…ƒé å³ */
.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; /* æ—¶é—´æˆ³ã€æ°”æ³¡ã€å¤´åƒï¼Œä»å³åˆ°å·¦æ’åˆ— */
}

/* 4. æ°”æ³¡å’Œå¤´åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸å˜) */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    /* ç§»é™¤æ—§çš„ position: absolute */
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
    margin-bottom: 5px;  /* è®©å®ƒå’Œæ°”æ³¡åº•éƒ¨æœ‰è½»å¾®çš„å¯¹é½åç§»ï¼Œæ›´ç¾è§‚ */
    flex-shrink: 0;      /* é˜²æ­¢è¢«å‹ç¼© */
}

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        /* ä¿®æ”¹èŠå¤©è¾“å…¥æ¡†åŒºåŸŸçš„ padding */
#chat-input-area { 
    flex-shrink: 0; 
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¢åŠ äº†ä¸Šã€å·¦ã€å³çš„å†…è¾¹è·ï¼Œè®©æ•´ä¸ªåŒºåŸŸæ›´â€œå®½æ•â€ â–¼â–¼â–¼ */
    padding: 10px 12px; 
    background-color: rgba(247, 247, 247, 0.8); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    border-top: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    gap: 5px; 
}

/* ä¿®æ”¹iPhoneåº•éƒ¨å®‰å…¨åŒºçš„é€‚é… */
#chat-input-area {
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šå°†è¿™é‡Œçš„ 8px ä¹ŸåŒæ­¥ä¸º 10pxï¼Œä¿æŒä¸€è‡´ â–¼â–¼â–¼ */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal {
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°†å®šä½æ–¹å¼ä» absolute æ”¹ä¸º fixed â–¼â–¼â–¼ */
    position: fixed; 
    /* â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² */
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0,0,0,0.4); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 100; 
}

        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* å…³é”®ï¼šåœ¨Yè½´å›åˆ°åŸä½çš„åŒæ—¶ï¼Œä¿æŒXè½´çš„å±…ä¸­å˜æ¢ */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.sticker-image {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå°†æœ€å¤§å®½é«˜ä» 100px å¢åŠ åˆ° 140pxï¼Œè®©èŠå¤©ä¸­çš„è¡¨æƒ…åŒ…å˜å¤§ */
    max-width: 140px; 
    max-height: 140px;
    display: block;
    object-fit: contain;
}
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
#sticker-grid, #exclusive-sticker-grid, #common-sticker-grid {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: grid;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå°† 80px å¢å¤§åˆ° 100pxï¼Œè®©æ¯ä¸ªè¡¨æƒ…æ ¼å­å˜å¤§ */
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
    gap: 15px;
}
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    top: 100%; 
    margin-top: 5px;
    left: 0;
    right: 0;
    max-height: 400px; /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œ â˜…â˜…â˜… æˆ‘æŠŠé«˜åº¦ä» 150px å¢åŠ åˆ°äº† 350px */
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å†…è¾¹è·ï¼Œè®©æ¯ä¸€è¡Œæ›´é«˜æ›´å®½ */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- æ–°å¢ï¼šå°†å­—ä½“å¤§å°ä»é»˜è®¤å€¼æ”¾å¤§åˆ°15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    font-size: var(--chat-font-size, 13px);
    /* --- ä¿®æ­£ç»“æŸ --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ .message-bubble .content æ ·å¼ â–¼â–¼â–¼ */
/* é€šç”¨å†…å®¹åŒºæ ·å¼ï¼Œä¸ºæ—¶é—´æˆ³å’Œå­—ä½“å¤§å°åšå‡†å¤‡ */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼ºåˆ¶é•¿å•è¯æˆ–URLæ¢è¡Œï¼Œé˜²æ­¢æ’‘ç ´æ°”æ³¡ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        /* === æ°”æ³¡ä¸»é¢˜æ ·å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/* è¿™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ ·å¼ */
#font-preview {
    transition: font-family 0.3s ease;}

/* === èŠå¤©åˆ—è¡¨ç•Œé¢æ–°å¢æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
#chat-list-bottom-nav {
    position: absolute; /* è®©å®ƒå›ºå®šåœ¨åº•éƒ¨ */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /* ç¡®ä¿å®ƒåœ¨è§†å›¾ä¹‹ä¸Š */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 13px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* === åŠ¨æ€ç•Œé¢ (QZone) æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    /* position: absolute;  <-- æŠŠè¿™ä¸ªæ”¹æˆ relative */
    position: relative;
    z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "å¥½å‹åŠ¨æ€"æ–‡å­— */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- åˆ é™¤è¿™ä¸ªï¼Œå› ä¸ºheaderä¸å†æ˜¯absoluteäº† */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; /* è®©å¤´åƒå’Œæ˜µç§°åŒºåŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å†…ï¼Œä¸€åŠåœ¨å¤– */
    left: 20px;
    display: flex;
    align-items: flex-end; /* è®©æ˜µç§°å’Œå¤´åƒåº•éƒ¨å¯¹é½ */
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /* å¾®è°ƒä½ç½® */
}

/* ç¼–è¾‘æŒ‰é’®çš„é€šç”¨æ ·å¼ */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /* ä¸æ˜µç§°çš„é—´è· */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* è„±ç¦»flexå¸ƒå±€çš„å¯¹é½ */
    bottom: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
}

/* === è®©ç¼–è¾‘åŠŸèƒ½æ›´â€œéšå½¢â€ === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /* æ‚¬åœæ—¶ç¨å¾®å˜æš—ï¼Œç»™ç”¨æˆ·åé¦ˆ */
}
/* éšè—æ‰æ—§çš„ã€ç‹¬ç«‹çš„ç¼–è¾‘æŒ‰é’® */
.qzone-edit-btn {
    display: none;
}

/* === æ§åˆ¶ Header å’Œ Bottom Nav çš„æ˜¾éš === */
/* é»˜è®¤éšè—åŠ¨æ€ç•Œé¢çš„ Header */
#qzone-screen .qzone-header {
    display: none;
}
/* å½“åŠ¨æ€è§†å›¾æ¿€æ´»æ—¶ï¼Œæ˜¾ç¤ºå®ƒçš„Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* å½“è¿›å…¥åŠ¨æ€è§†å›¾æ—¶ï¼Œéšè—ä¸»Headerå’Œåº•éƒ¨å¯¼èˆªæ  */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-group-container:first-child {
    margin-top: 10px; 
}

/* â–²â–²â–² æ–°æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠæ‰€æœ‰è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === åŠ¨æ€åŠŸèƒ½æ æ ·å¼ === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /* ä¸Šè¾¹è·æ›´å¤§ï¼Œä¸ºæµ®åŠ¨çš„å¤´åƒç•™å‡ºç©ºé—´ */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/* ç”¨ä¼ªå…ƒç´ åˆ›å»ºåˆ†éš”çº¿ */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* === åŠ¨æ€å¸–å­åˆ—è¡¨æ ·å¼ === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºè¾¹è· */
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¸–å­ä¹‹é—´çš„é—´è· */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ç²˜è´´åˆ°æœ«å°¾ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ ·å¼ === */
#post-public-text {
    min-height: 80px; /* ç¡®ä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é¢„è§ˆæ¯”ä¾‹ */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† - æ¨¡å¼åˆ‡æ¢æ ·å¼ === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /* é»˜è®¤éƒ½éšè— */
}

.post-mode-content.active {
    display: block; /* æ¿€æ´»çš„æ‰æ˜¾ç¤º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* === ç›¸å†Œé¡µé¢èƒŒæ™¯è‰² === */
#album-screen {
    background-color: #f0f2f5; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„æµ…ç°è‰²ï¼Œæ¯”çº¯ç™½æ›´æŠ¤çœ¼ */
}

/* === ç›¸å†Œé¡µé¢ç½‘æ ¼å¸ƒå±€ === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ªç›¸å†Œ */
    gap: 15px;
}

/* === ç›¸å†Œé¡¹ç›®æ ·å¼ (ç¾åŒ–) === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /* ç»™æ•´ä¸ªé¡¹ç›®ä¹ŸåŠ ä¸ªåœ†è§’ */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ä¸ºæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /* å°é¢åŠ è½½å‰çš„å ä½é¢œè‰² */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é˜²æ­¢é•¿åå­—æ¢è¡Œ */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/* â–²â–²â–² æ–°çš„ CSS ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ç›¸å†Œç…§ç‰‡è¯¦æƒ…é¡µ === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* æ¯è¡Œæ˜¾ç¤º3å¼ ç…§ç‰‡ï¼Œå¹¶ä¿æŒé—´è· */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ä¸ºæ­£æ–¹å½¢ */
    border-radius: 6px;
    overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
    background-color: #e9ecef; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ç¬¦é¢œè‰² */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
    cursor: pointer;
}

/* åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease;
}

/* é¼ æ ‡æ‚¬åœåœ¨ç…§ç‰‡ä¸Šæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡†æ ·å¼ === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸ºè§†å£çš„90% */
    max-height: 85vh; /* å›¾ç‰‡æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /* ä¸ºå›¾ç‰‡çš„åˆ‡æ¢æ·»åŠ ä¸€ç‚¹å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    transition: opacity 0.2s ease-in-out;
}

/* å…³é—­æŒ‰é’® */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/* å·¦å³å¯¼èˆªç®­å¤´ */
#photo-viewer-modal .nav-arrow {
    position: absolute; /* ç°åœ¨æˆ‘ä»¬ç”¨ç»å¯¹å®šä½æ¥æ§åˆ¶ç®­å¤´ */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /* åœ¨æ‰‹æœºå±å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /* ç¡®ä¿ç®­å¤´åœ¨æœ€ä¸Šå±‚ */
}

#photo-viewer-prev-btn {
    left: 5px; /* å®šä½å·¦ç®­å¤´ */
}

#photo-viewer-next-btn {
    right: 5px; /* å®šä½å³ç®­å¤´ */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/* å½“ç®­å¤´è¢«ç¦ç”¨æ—¶ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼ æˆ–æœ€åä¸€å¼ ï¼‰ */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’åŒºCSS â–¼â–¼â–¼ */

/* === å¸–å­å†…å®¹åŒº - ç›¸å¯¹å®šä½å®¹å™¨ === */
/* === å¸–å­å†…å®¹åŒº === */
.post-main-content {
    /* å®ƒç°åœ¨åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ ·å¼äº† */
}

/* === å¸–å­äº’åŠ¨å›¾æ ‡åŒº (æ–°æ ·å¼) === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /* è®©å›¾æ ‡é å³å¯¹é½ */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šç»™å›¾æ ‡åŒºåŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /* é»˜è®¤ç°è‰² */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* å›¾æ ‡æ¿€æ´»(ç‚¹èµ/æ”¶è—å)çš„æ ·å¼ */
.action-icon.active {
    color: #ff5252; /* æ¿€æ´»åå˜çº¢è‰² */
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
}

.action-icon.active.favorite {
    color: #ffc107; /* æ”¶è—ç”¨é»„è‰² */
}

.action-icon.active svg {
    fill: currentColor; /* æ¿€æ´»åå¡«å……é¢œè‰² */
}

/* ç‚¹å‡»æ—¶çš„åŠ¨ç”»æ•ˆæœ */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* === å¸–å­åº•éƒ¨è¯„è®ºåŒºæ ·å¼ (ç°åœ¨æ˜¯ç‹¬ç«‹éƒ¨åˆ†) === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¡æµ…è‰²çº¿åˆ†éš” */
    display: flex;
    align-items: center;
    gap: 8px; /* è°ƒæ•´æ•´ä½“é—´è· */
}

/* è¯„è®ºåŒºå®¹å™¨ */
.comment-section {
    flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/* æ–°å¢çš„å‘é€æŒ‰é’®æ ·å¼ */
.comment-send-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯å°çº¢ç‚¹é€šç”¨æ ·å¼ === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/* èŠå¤©ç•Œé¢è¿”å›æŒ‰é’®ä¸Šçš„å°çº¢ç‚¹ (åªæ˜¾ç¤ºç‚¹ï¼Œä¸æ˜¾ç¤ºæ•°å­—) */
.back-btn-indicator {
    top: 0;
    right: -8px; /* æ”¾åˆ°è¿”å›ç®­å¤´å³ä¸Šè§’ */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === è¯„è®ºåˆ—è¡¨å®¹å™¨ === */
.post-comments-container {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
    display: flex;
    flex-direction: column;
    gap: 8px; /* è¯„è®ºä¹‹é—´çš„é—´è· */
    font-size: 13px; /* ç»Ÿä¸€è¯„è®ºåŒºå­—ä½“å¤§å° */
}

/* æ¯ä¸€æ¡è¯„è®º */
.comment-item {
    line-height: 1.5;
}

/* è¯„è®ºè€…çš„åå­—ï¼ŒåŠ ç²—å¹¶ä½¿ç”¨ä¸»é¢˜è‰² */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /* å’Œè¯„è®ºå†…å®¹ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
}

/* è¯„è®ºå†…å®¹ */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å¸–å­ç‚¹èµåŒºåŸŸæ ·å¼ === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 8px 10px; /* å†…è¾¹è· */
    font-size: 13px;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è“è‰² */
    background-color: #f0f5fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /* å’Œä¸Šæ–¹çš„å›¾æ ‡ä¿æŒä¸€ç‚¹è·ç¦» */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* è®©SVGå›¾æ ‡ç»§æ‰¿çˆ¶å…ƒç´ çš„é¢œè‰² */
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === @æåŠ å¼¹å‡ºèœå•æ ·å¼ === */
.at-mention-popup {
    position: absolute; /* ç›¸å¯¹äºçˆ¶å…ƒç´ å®šä½ */
    bottom: 100%; /* æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†çš„ä¸Šæ–¹ */
    left: 40px; /* å’Œè¾“å…¥æ¡†å·¦ä¾§å¯¹é½ (è€ƒè™‘äº†å¤´åƒå®½åº¦) */
    width: calc(100% - 40px); /* å®½åº¦å’Œè¾“å…¥æ¡†å·®ä¸å¤š */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /* é»˜è®¤éšè— */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘æ›¿æ¢æ‰ä½ ç°æœ‰çš„ #favorites-list æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ”¶è—è§†å›¾æˆä¸ºä¸€ä¸ªflexå®¹å™¨, ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* ç¡®ä¿æ”¶è—é¡µçš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å‹ç¼© */
#favorites-view > .header {
    flex-shrink: 0;
}

/* === æ”¶è—åˆ—è¡¨æ ·å¼ (ä¿®æ­£å) === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <-- æ–°å¢è¿™è¡Œï¼Œç¦æ­¢æ°´å¹³æ»šåŠ¨ */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
}

/* å¡ç‰‡å¤´éƒ¨ï¼ŒåŒ…å«å¤´åƒã€åå­—å’Œæ¥æº */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡å†…å®¹ */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
}

/* åˆ é™¤æŒ‰é’® */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœç´¢æ æ ·å¼ === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
    position: relative; /* ä¸ºäº†å®šä½æ¸…é™¤æŒ‰é’® */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /* å³ä¾§ç•™å‡ºæ¸…é™¤æŒ‰é’®çš„ä½ç½® */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ†è§’çŸ©å½¢ï¼Œæ›´ç°ä»£åŒ– */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === èŠå¤©ç•Œé¢å¤šé€‰æ“ä½œæ ä¼˜åŒ– === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* === æ”¶è—é¡µé¢å¤šé€‰æ¨¡å¼æ ·å¼ === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* é€‰æ‹©æ¡†çš„æ ·å¼ */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦è¾¹å¤–é¢ */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œå¡ç‰‡å‘å³ç§»åŠ¨ï¼Œéœ²å‡ºé€‰æ‹©æ¡† */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/* é€‰ä¸­åçš„æ ·å¼ */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* åº•éƒ¨æ“ä½œæ  (ç»ˆæä¿®æ­£ç‰ˆ) */
#favorites-action-bar {
    position: absolute; /* â˜… æ”¹ä¸º absoluteï¼Œç›¸å¯¹äº #phone-screen å®šä½ */
    bottom: 0;
    left: 0;
    right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’‘æ»¡å®½åº¦ */
    width: auto;        /* â˜… æ”¹ä¸º autoï¼Œè®© left/right å†³å®šå®½åº¦ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width å·²ç»ä¸éœ€è¦äº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ å·²ç»é™åˆ¶äº†å®½åº¦ */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* === ã€ä¿®æ­£ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨æ§ä»¶åˆ‡æ¢é€»è¾‘ === */

/* é»˜è®¤çŠ¶æ€ï¼šéšè—å¤šé€‰æ§ä»¶ */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/* é»˜è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºé»˜è®¤æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šéšè—é»˜è®¤æ§ä»¶ */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºå¤šé€‰æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€å·æŒ‰é’® === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /* æ˜¾è‘—å¢å¤§å­—ä½“å¤§å°ï¼Œä½¿å…¶è§†è§‰ä¸Šä¸æ—è¾¹çš„å›¾æ ‡åŒ¹é… */
    font-weight: 300;  /* ä½¿ç”¨æ›´ç»†çš„å­—é‡ï¼Œè®©åŠ å·çœ‹èµ·æ¥æ›´æ¸…çˆ½ï¼Œä¸æ˜¾ç²—ç¬¨ */
    position: relative;/* å…è®¸è¿›è¡Œä½ç½®å¾®è°ƒ */
    top: -1px;         /* å­—ä½“æ”¾å¤§åï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œä½¿å…¶è§†è§‰ä¸Šæ›´å±…ä¸­ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* é¢„è§ˆåŒºå®¹å™¨æ ·å¼ */
#settings-preview-area {
    width: 100%;
    height: 180px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    display: flex;
    flex-direction: column;
    gap: 10px; /* é¢„è§ˆæ°”æ³¡ä¹‹é—´çš„é—´è· */
    border: 1px solid var(--border-color);
    position: relative; /* ä¸ºäº†å®šä½èƒŒæ™¯ */
}

/* é¢„è§ˆåŒºçš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå®èŠå¤©ç•Œé¢åŒæ­¥ */
#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

/* è®©é¢„è§ˆæ°”æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

/* é¢„è§ˆåŒºå†…ä½¿ç”¨çš„å¤´åƒè¦å°ä¸€ç‚¹ */
#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}

#settings-preview-area .message-bubble .timestamp {
    display: none; /* é¢„è§ˆåŒºä¸éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: var(--secondary-bg); /* <-- ä¿®æ”¹è¿™é‡Œï¼Œä½¿ç”¨å˜é‡ */
}


.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„å®¹å™¨ */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„æ–‡æœ¬æ¡†æ‹‰å¼€è·ç¦» */
    flex-wrap: wrap; /* å¦‚æœæŒ‰é’®å¤ªå¤šå¯ä»¥æ¢è¡Œ */
}

/* å•ä¸ªæ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„æ ·å¼ */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œæ›´å‹å¥½ */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â€œâ€¦â€æŒ‰é’®çš„æ ·å¼ */
.post-actions-btn {
    margin-left: auto; /* å…³é”®ï¼šè®©å®ƒè‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/* åŠ¨æ€ç¼–è¾‘æ¨¡æ€æ¡†çš„æ ·å¼ (å®ƒå°†å¤ç”¨ç°æœ‰çš„æ“ä½œèœå•æ ·å¼) */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ç»Ÿä¸€é‡ç½®è½¬è´¦å¡ç‰‡å†…æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¢œè‰² */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å‘å…‰æˆ–é˜´å½±æ•ˆæœ */
    color: white !important;      /* å¼ºåˆ¶é”å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
}

/* åˆ†åˆ«é”å®šå„è‡ªçš„å­—ä½“å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ï¼Œç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ï¼Œç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
.header > span:nth-child(2) {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¡€ä¸Šï¼Œå†å‘å·¦æ¨2åƒç´  */
    
    /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ ·å¼ â–¼â–¼â–¼ */
#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; /* è¦†ç›–é»˜è®¤çš„ margin-bottom */
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è”ç³»äººé€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#member-management-list {
    padding: 0; /* ç§»é™¤é»˜è®¤paddingï¼Œè®©åˆ—è¡¨é¡¹æ’‘æ»¡ */
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; /* æ–°å»ºç”¨ç»¿è‰²ï¼Œä»¥ç¤ºåŒºåˆ† */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–ä»£ä»˜å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; /* æ©™é»„è‰²èƒŒæ™¯ */
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–å“åº”çŠ¶æ€æ ·å¼ â–¼â–¼â–¼ */

/* === åŒæ„æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; /* ç»¿è‰²è¾¹æ¡† */
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: 'âœ…  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

/* === æ‹’ç»æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; /* çº¢è‰²è¾¹æ¡† */
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: 'âŒ ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

/* å¼ºåˆ¶é‡å†™ request-title å†…å®¹çš„æŠ€å·§ */
.message-bubble[class*="status-"] .request-title {
    font-size: 0; /* éšè—åŸå§‹æ–‡æœ¬ */
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; /* è®©ä¼ªå…ƒç´ æ˜¾ç¤ºæ–°æ–‡æœ¬ */
}
.message-bubble.status-paid .request-title::after {
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½";
}
.message-bubble.status-rejected .request-title::after {
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚";
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚çš„ç”¨æˆ·æ“ä½œæŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé—´ */
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ç¡®ä¿è¿™äº›é¡µé¢çš„å†…å®¹åŒºèƒ½æ­£ç¡®æ»šåŠ¨ï¼ŒåŒæ—¶èƒŒæ™¯é€æ˜ä»¥æ˜¾ç¤ºçˆ¶çº§é¢œè‰² */
#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    /* ä¸å†éœ€è¦èƒŒæ™¯è‰²ï¼Œè®©çˆ¶å…ƒç´ å†³å®š */
}
#font-settings-screen,
#wallpaper-screen {
    /* å°†èƒŒæ™¯è‰²è®¾ç½®ä¸ºå˜é‡ï¼Œè¿™æ ·å¤œé—´æ¨¡å¼æ‰èƒ½è¦†ç›–å®ƒ */
    background-color: var(--secondary-bg);
}
/* å£çº¸è®¾ç½®é¡µé¢çš„é¢„è§ˆåŒºæ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦é¢å¤–è°ƒæ•´ */
#wallpaper-screen .form-container {
    align-items: center; /* ä¿æŒå†…å®¹å±…ä¸­ */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚ä¸è§†é¢‘é€šè¯ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */

/* --- æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† --- */
#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

/* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—ã€æœ€ç»ˆç»“æ„é‡å†™ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„ video-call ç›¸å…³CSS â–¼â–¼â–¼ */

/* 1. é€šè¯å±å¹•æ€»å®¹å™¨ (ä¿æŒä¸å˜) */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex; /* â˜… æ ¸å¿ƒï¼šå®ƒä¾ç„¶æ˜¯flexå®¹å™¨ */
    flex-direction: column;
    overflow: hidden;
}

/* 2. é¡¶éƒ¨æ å’Œåº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) */
.video-call-top-bar, .video-call-controls {
    position: absolute;
    left: 0;
    width: 100%;
    z-index: 10;
    box-sizing: border-box;
    pointer-events: none; /* è®©å®ƒä»¬ä¸å½±å“ä¸‹æ–¹å†…å®¹çš„ç‚¹å‡» */
}
.video-call-top-bar {
    top: 0;
    padding: 15px 20px 30px; /* å¢åŠ åº•éƒ¨padding */
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    text-align: center;
}
.video-call-controls {
    bottom: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    pointer-events: all; /* æ§åˆ¶æŒ‰é’®éœ€è¦èƒ½ç‚¹å‡» */
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}

/* 3. ã€æ ¸å¿ƒé‡æ„ã€‘é»˜è®¤æ–‡å­—é€šè¯çš„æ€»å®¹å™¨ */
#text-call-interface {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* 4. ã€æ ¸å¿ƒé‡æ„ã€‘å¤´åƒåŒºåŸŸ */
.video-call-avatar-area {
    flex-shrink: 0; /* â˜… æ ¸å¿ƒï¼šé«˜åº¦é›·æ‰“ä¸åŠ¨ï¼Œç»ä¸å‹ç¼© */
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 100px; /* â˜… æ ¸å¿ƒï¼šä¸é¡¶éƒ¨çŠ¶æ€æ æ‹‰å¼€è·ç¦» */
    padding-bottom: 20px; /* â˜… æ ¸å¿ƒï¼šä¸ä¸‹æ–¹æ°”æ³¡åŒºæ‹‰å¼€è·ç¦» */
}

/* 5. ã€æ ¸å¿ƒé‡æ„ã€‘æ°”æ³¡åŒºåŸŸ */
#video-call-main {
    flex-grow: 1; /* â˜… æ ¸å¿ƒï¼šå æ®æ‰€æœ‰å‰©ä½™çš„å‚ç›´ç©ºé—´ */
    min-height: 0; /* â˜… æ ¸å¿ƒï¼šä¸€ä¸ªé˜²æ­¢flexæº¢å‡ºçš„é‡è¦ä¿é™©ä¸ */
    margin: 0 15px 130px 15px; /* â˜… æ ¸å¿ƒï¼šå®šä¹‰å››å‘¨è¾¹ç•Œï¼Œåº•éƒ¨ç•™è¶³ç©ºé—´ç»™æŒ‰é’® */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.08); /* ç¨å¾®è°ƒäº®ä¸€ç‚¹èƒŒæ™¯ */
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 6. å¤´åƒç½‘æ ¼å’Œå¤´åƒæœ¬èº«æ ·å¼ (å¾®è°ƒ) */
#participant-avatars-grid {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}
.participant-avatar-wrapper {
    text-align: center;
}
.participant-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 13px;
    color: #ccc;
}
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7. æ§åˆ¶æŒ‰é’®æ ·å¼ (ä¿æŒä¸å˜) */
.control-btn {
    width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer;
    background-repeat: no-repeat; background-position: center;
    transition: transform 0.2s, background-color 0.2s;
    pointer-events: all;
}
.control-btn:active { transform: scale(0.9); }
.control-btn.speak-btn { background-color: rgba(255,255,255,0.2); background-size: 55%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'); }
.control-btn.hangup-btn { background-color: #ff3b30; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>'); }
.control-btn.join-btn { background-color: #007bff; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>'); }

/* â–²â–²â–² æ–°CSSæ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯å¯¹è¯æ°”æ³¡æ ·å¼ â–¼â–¼â–¼ */
.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; /* AIå‘è¨€é å·¦ */
}

.call-message-bubble.user-speech {
    background-color: #4cd964; /* ç”¨æˆ·å‘è¨€ç”¨ç»¿è‰²ï¼Œç±»ä¼¼å¾®ä¿¡ */
    align-self: flex-end;   /* ç”¨æˆ·å‘è¨€é å³ */
    text-align: left; /* ç¡®ä¿ç”¨æˆ·æ°”æ³¡å†…çš„æ–‡å­—æ˜¯å·¦å¯¹é½çš„ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: center;   /* æ°´å¹³å±…ä¸­ */
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰å¼€è·ç¦» */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* 1. åŠ¨æ€å¸–å­çš„å¤–å±‚å®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ¥å®šä½å’Œè£å‰ª */
.qzone-post-container {
    position: relative; /* è®©å†…éƒ¨çš„åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    overflow: hidden;   /* éšè—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆ é™¤æŒ‰é’® */
    border-radius: 12px;/* å’Œå†…éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ†è§’ */
}

/* 2. å¯æ»‘åŠ¨çš„å†…å®¹å¡ç‰‡ï¼Œå¢åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); /* ç¡®ä¿å®ƒæœ‰èƒŒæ™¯è‰²ï¼Œèƒ½ç›–ä½ä¸‹é¢çš„åˆ é™¤æŒ‰é’® */
    position: relative; /* ç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
    z-index: 2;
}

/* 3. ã€æ ¸å¿ƒã€‘è¿™å°±æ˜¯é‚£ä¸ªâ€œåˆ é™¤â€æŒ‰é’®çš„æ ·å¼ï¼*/
.qzone-post-delete-action {
    position: absolute; /* ç»å¯¹å®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    background-color: #ff3b30; /* æ‚¨æƒ³è¦çš„çº¢è‰²èƒŒæ™¯ */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; /* ç¡®ä¿å®ƒåœ¨å¡ç‰‡ä¸‹é¢ */
}

/* 4. å½“å¡ç‰‡å·¦æ»‘æ—¶ï¼ŒæŠŠå®ƒå‘å·¦ç§»åŠ¨ï¼Œéœ²å‡ºåˆ é™¤æŒ‰é’® */
.qzone-post-item.swiped {
    transform: translateX(-90px); /* ç§»åŠ¨çš„è·ç¦»å’Œåˆ é™¤æŒ‰é’®çš„å®½åº¦ä¸€è‡´ */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ ·å¼ï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. â€œæ‹ä¸€æ‹â€çš„å±å¹•éœ‡åŠ¨åŠ¨ç”» */
@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

/* 2. â€œæ‹ä¸€æ‹â€ç³»ç»Ÿæç¤ºæ¶ˆæ¯çš„æ ·å¼ */
.system-message {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* è®©â€œæ‹ä¸€æ‹â€ç±»å‹çš„ wrapper å±…ä¸­ */
.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}
/* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°”æ³¡çš„æ ·å¼ */
.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šè®©é¡¶éƒ¨æ“ä½œæ å¯ä»¥æ¨ªå‘æ»šåŠ¨ === */
#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    /* --- æ ¸å¿ƒä»£ç å¼€å§‹ --- */
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨çŠ¶æ€æ æ ·å¼ === */

/* === ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨çŠ¶æ€æ æ ·å¼ === */

/* â–¼â–¼â–¼ ç”¨è¿™å—ã€å±…ä¸­ä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ #chat-header-title-wrapper æ ·å¼ â–¼â–¼â–¼ */
#chat-header-title-wrapper {
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šè®©æ ‡é¢˜åŒºåŸŸç»å¯¹å±…ä¸­ --- */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    /* ------------------------------------ */
    
    /* ä¿æŒå…¶å†…éƒ¨å…ƒç´ ï¼ˆæ ‡é¢˜å’ŒçŠ¶æ€ï¼‰çš„å¸ƒå±€ä¸å˜ */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px; 
    
    /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
    max-width: 60%;
    
    /* æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†éœ€è¦ flex-grow: 1; äº†ï¼Œå› ä¸ºç»å¯¹å®šä½å·²ç»ä½¿å…¶è„±ç¦»äº†flexå¸ƒå±€æµ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ä»£ç æ›¿æ¢ä½ æ—§çš„ #chat-header-main-line æ ·å¼ â–¼â–¼â–¼ */
#chat-header-main-line {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; /* è®©å…¬å‘ŠæŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€ç»ˆæä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ #chat-header-title æ ·å¼ â–¼â–¼â–¼ */
#chat-header-title {
    font-size: 16px;
    font-weight: 600;
    
    /* (è¿™ä¸¤è¡Œæ˜¯ä¸Šæ¬¡ä¿®å¤å®šä½é—®é¢˜çš„ï¼Œå¿…é¡»ä¿ç•™ï¼) */
    position: static !important;
    transform: none !important;

    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæˆ‘ä»¬å·²ç»æŠŠå¯¼è‡´çœç•¥å·çš„å››è¡Œä»£ç å…¨éƒ¨åˆ æ‰äº†ï¼ â˜…â˜…â˜… */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */




/* 3. çŠ¶æ€æ å®¹å™¨ */
#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

/* 4. çŠ¶æ€å°åœ†ç‚¹ */
.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; /* é»˜è®¤ç»¿è‰²ï¼Œä»£è¡¨åœ¨çº¿ */
    transition: background-color 0.3s ease;
}

/* å½“AIçŠ¶æ€ä¸ºâ€œå¿™ç¢Œâ€æˆ–â€œç¦»å¼€â€æ—¶ï¼Œè®©åœ†ç‚¹å˜ç°è‰² */
#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

/* 5. çŠ¶æ€æ–‡æœ¬ */
.status-text {
    font-weight: 500;
}

/* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›å¿†å¡ç‰‡æ ·å¼ === */

/* 1. å¡ç‰‡æ€»å®¹å™¨ï¼šè¿™é‡Œè´Ÿè´£å®šä¹‰æ•´ä½“çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡† */
.memory-card {
    background-color: #fffaf0; /* ç»Ÿä¸€çš„ã€æ¸©æš–çš„ç±³é»„è‰²èƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå†…è¾¹è· */
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; /* è®©å®ƒæˆä¸ºflexå®¹å™¨ï¼Œæ–¹ä¾¿å†…éƒ¨å…ƒç´ æ’åˆ— */
    flex-direction: column; /* è®©å¤´éƒ¨å’Œå†…å®¹å‚ç›´å †å  */
    gap: 8px; /* åœ¨å¤´éƒ¨å’Œå†…å®¹ä¹‹é—´åˆ›é€ ä¸€ä¸ªè‡ªç„¶çš„é—´è· */
}

/* 2. å¤´éƒ¨å®¹å™¨ï¼šç°åœ¨åªè´Ÿè´£å¸ƒå±€å’Œåˆ†å‰²çº¿ */
.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²çº¿é¢œè‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
    padding-bottom: 8px; 
}

/* 3. æ—¥æœŸæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

/* 4. ä½œè€…æ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. å†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

/* === ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶å¡ç‰‡æ ·å¼ === */
.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

/* === ã€å…¨æ–°ã€‘èŠå¤©é”å®šé®ç½©å±‚æ ·å¼ === */
#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; /* æ¯”è¾“å…¥æ¡†é«˜ï¼Œæ¯”è´´çº¸é¢æ¿ä½ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; /* é‡‘è‰²æ–‡å­— */
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'ğŸ§§';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°”æ³¡ä¸­çš„æ ·å¼ */
.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* æŠ•ç¥¨å¡ç‰‡ä¸»ä½“ */
.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; /* ç»“æŸåå˜ç° */
}

/* æŠ•ç¥¨é—®é¢˜ */
.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

/* æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* å•ä¸ªæŠ•ç¥¨é€‰é¡¹ */
.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

/* ç”¨æˆ·å·²æŠ•ç¥¨çš„é€‰é¡¹æ ·å¼ */
.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

/* æŠ•ç¥¨è¿›åº¦æ¡ */
.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

/* é€‰é¡¹å†…å®¹ï¼ˆæ–‡å­—å’Œç¥¨æ•°ï¼‰ï¼Œç¡®ä¿åœ¨è¿›åº¦æ¡ä¹‹ä¸Š */
.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

/* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/* åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡†çš„é€‰é¡¹è¾“å…¥ */
.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©å¤´éƒ¨â€œæ­£åœ¨è¾“å…¥â€çŠ¶æ€æ ·å¼ === */
#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appå›¾æ ‡è®¾ç½®æ ·å¼ â–¼â–¼â–¼ */
#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢å¸ƒå±€ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ä¿®æ­£æ»šåŠ¨é—®é¢˜ */
#wallpaper-screen .form-container {
    /* æ ¸å¿ƒä¿®æ­£1: è§£å†³flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å†²çªï¼Œè®©æ»šåŠ¨æ¡èƒ½æ­£å¸¸å‡ºç° */
    min-height: 0; 
}

/* 2. ä¿®æ­£å£çº¸é¢„è§ˆè¢«å‹æ‰çš„é—®é¢˜ */
#wallpaper-preview {
    /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é¢„è§ˆæ¡†è¢«è¿‡å¤šçš„å†…å®¹æŒ¤å‹å˜å½¢ï¼Œè®©å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
    flex-shrink: 0; 
}
/* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½æ ·å¼ (æ— å›¾ç‰ˆ) â–¼â–¼â–¼ */

/* 1. æµè§ˆå™¨ç•Œé¢èƒŒæ™¯è‰²å’Œå†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

/* 2. èŠå¤©æ°”æ³¡ä¸­çš„é“¾æ¥å¡ç‰‡æ ·å¼ (æ— å›¾ç‰ˆ) */
.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 210px; 
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; /* è®©å›¾æ ‡å’Œæ–‡å­—æ°´å¹³å¯¹é½ */
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å•æ¡è¯„è®ºçš„å®¹å™¨ï¼Œç°åœ¨éœ€è¦ç›¸å¯¹å®šä½ */
.comment-item {
    position: relative;
    padding-right: 25px; /* åœ¨å³ä¾§ç•™å‡ºåˆ é™¤æŒ‰é’®çš„ç©ºé—´ */
}

/* è¯„è®ºåˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* é¼ æ ‡æ‚¬åœåœ¨è¯„è®ºä¸Šæ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.comment-item:hover .comment-delete-btn {
    opacity: 1;
}

.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€è¯·æ±‚7ã€‘ä¸»å±å¹•é¢„è®¾ä¿å­˜æŒ‰é’®ä¸»é¢˜è‰²é€‚é… (è¯·å°†è¿™å—ä»£ç ä¹Ÿç²˜è´´åˆ° <style> çš„æœ«å°¾) â–¼â–¼â–¼ */
#save-home-preset-btn {
    background-color: var(--accent-color);
    color: white;
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¤é¢„è§ˆæ â€ */
#reply-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    padding: 8px 12px;
    margin: 0 8px 8px 8px; /* å’Œè¾“å…¥æ¡†å‘¨å›´çš„è¾¹è·ä¿æŒä¸€è‡´ */
    background-color: rgba(0, 0, 0, 0.05);
    border-left: 3px solid var(--accent-color);
    border-radius: 6px;
    position: relative;
    font-size: 13px;
    color: var(--text-secondary);
}

#phone-screen.dark-mode #reply-preview-bar {
    background-color: rgba(255, 255, 255, 0.1);
}

.reply-preview-content .sender {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-preview-content .text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; /* ç¡®ä¿çœç•¥å·ç”Ÿæ•ˆ */
    max-width: 95%;
}

#cancel-reply-btn {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    cursor: pointer;
    font-size: 14px;
}

/* 2. æ¶ˆæ¯æ°”æ³¡å†…éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å—â€ */
.quoted-message {
    padding: 6px 10px;
    margin-bottom: 6px;
    background-color: rgba(0, 0, 0, 0.04);
    border-left: 2px solid var(--accent-color);
    border-radius: 4px;
    font-size: 0.9em; /* å­—ä½“æ¯”æ­£æ–‡å°ä¸€ç‚¹ */
    opacity: 0.8;
    /* (å·²ç§»é™¤ overflow: hidden;) */
}

#phone-screen.dark-mode .quoted-message {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: #a0cff1;
}

.quoted-message .quoted-sender {
    font-weight: 600;
    color: var(--accent-color);
}
#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: #a0cff1;
}

.quoted-message .quoted-content {
    color: var(--text-secondary);
    white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è®¸æ–‡æœ¬æ­£å¸¸æ¢è¡Œ */
    word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼ºåˆ¶é•¿å•è¯æˆ–è¿ç»­å­—ç¬¦æ–­å¼€ï¼Œé˜²æ­¢æº¢å‡º */
    display: block;
    /* (å·²ç§»é™¤ overflow å’Œ text-overflowï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¤šè¡Œæ˜¾ç¤ºè€Œä¸æ˜¯å•è¡Œçœç•¥å·) */
}

/* === å­—ä½“é¢„è§ˆæ¡†æ ·å¼ (ä¿®æ­£å) === */

/* å°†å®ƒä¿®æ”¹ä¸º â–¼â–¼â–¼ */
#font-preview {
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f0f2f5; /* ç»Ÿä¸€ä¸ºæ›´æµ…çš„ç°è‰²ï¼Œç„¶åè®©å¤œé—´æ¨¡å¼CSSå»è¦†ç›– */
    transition: background-color 0.3s, border-color 0.3s;
}

/* é¢„è§ˆæ¡†é‡Œçš„æ–‡å­—é¢œè‰²ï¼Œé»˜è®¤æ˜¯é»‘è‰² */
#font-preview p {
    color: var(--text-primary);
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿®æ­£æ ·å¼ */
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
    border-color: #38383a;     /* æš—è‰²è¾¹æ¡† */
}

/* å¤œé—´æ¨¡å¼ä¸‹ï¼Œé¢„è§ˆæ¡†é‡Œçš„æ–‡å­—å˜ä¸ºç™½è‰² */
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
.transfer-actions-content {
    background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
    border-radius: 20px;
    width: 290px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é˜´å½± */
    text-align: center;
    position: relative;
    border: 1px solid #ffcce0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.transfer-actions-header {
    font-size: 20px;
    font-weight: bold;
    color: #a35c7b; /* æ·±ç²‰è‰²æ ‡é¢˜ */
    margin-bottom: 15px;
}

.transfer-actions-body p {
    font-size: 15px;
    color: #555;
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.transfer-actions-footer {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.transfer-actions-footer .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: white;
}

.transfer-actions-footer .action-btn:active {
    transform: scale(0.95);
}

.transfer-actions-footer .action-btn.accept {
    background: linear-gradient(135deg, #ff85b3, #ff69b4);
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
}

.transfer-actions-footer .action-btn.decline {
    background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.transfer-actions-content .cancel-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: #a35c7b;
    font-size: 20px;
    line-height: 28px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯çº¢ç‚¹æ ·å¼ === */
.unread-count-wrapper {
    flex-shrink: 0;
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px; /* è®©çº¢ç‚¹å’Œåå­—å·®ä¸å¤šé«˜ */
}

.unread-count {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background-color: #ff3b30; /* iOS é£æ ¼çš„çº¢è‰² */
    color: white;
    font-size: 13px;
    font-weight: 500;
    line-height: 20px;
    text-align: center;
    border-radius: 10px; /* åœ†è§’çŸ©å½¢ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ä¸å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

/* ç¡®ä¿é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
#call-history-screen {
    background-color: #f0f2f5;
}

/* é€šè¯è®°å½•å¡ç‰‡æ ·å¼ */
.call-record-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid var(--accent-color);
}
.call-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* å¡ç‰‡å¤´éƒ¨ï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é•¿ */
.call-record-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.call-record-card .card-header .duration {
    font-weight: 500;
    color: var(--text-primary);
}

/* å¡ç‰‡ä¸»ä½“ï¼šå‚ä¸è€…å¤´åƒ */
.call-record-card .card-body {
    display: flex;
    align-items: center;
}
.call-record-card .participants-avatars {
    display: flex;
    align-items: center;
}
.call-record-card .participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* è®©å¤´åƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„å †å æ•ˆæœ */
.call-record-card .participant-avatar:not(:first-child) {
    margin-left: -12px;
}
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

/* --- é€šè¯è¯¦æƒ…å¼¹çª—æ ·å¼ --- */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
}
.transcript-entry {
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
    word-break: break-word;
}
.transcript-entry.user {
    background-color: #dcf8c6; /* ç±»ä¼¼å¾®ä¿¡çš„ç»¿è‰² */
    align-self: flex-end;
}
.transcript-entry.assistant {
    background-color: #ffffff;
    align-self: flex-start;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

#chat-list-title {
    cursor: pointer;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•å¡ç‰‡ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

.call-record-card .card-body {
    /* å°† body æ”¹ä¸º flex å¸ƒå±€ï¼Œè®©æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯å‚ç›´æ’åˆ— */
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯ä¹‹é—´çš„é—´è· */
}

.call-record-card .custom-title {
    font-size: 16px;
    font-weight: 600; /* åŠ ç²—ï¼Œè®©å®ƒåƒä¸ªæ ‡é¢˜ */
    color: var(--text-primary);
    padding-bottom: 8px; /* æ ‡é¢˜ä¸‹çš„ç•™ç™½ */
    border-bottom: 1px solid var(--border-color); /* åœ¨æ ‡é¢˜ä¸‹åŠ ä¸€æ¡åˆ†å‰²çº¿ */
    margin-bottom: 4px; /* å’Œä¸‹é¢çš„å‚ä¸è€…ä¿¡æ¯æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

.call-record-card .participants-info {
    /* è¿™ä¸ªæ–°å®¹å™¨è®©å¤´åƒå’Œâ€œä¸xxâ€èƒ½æ°´å¹³å¯¹é½ */
    display: flex;
    align-items: center;
}

/* å‚ä¸è€…åå­—çš„æ ·å¼å¾®è°ƒï¼Œè®©å®ƒä¸é‚£ä¹ˆçªå‡º */
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 500; /* ä¸å†åŠ ç²— */
    font-size: 14px; /* ç¨å¾®å°ä¸€ç‚¹ */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¯­éŸ³æ–‡å­—å†…å®¹çš„æ ·å¼ */
.voice-transcript {
    font-size: 14px;         /* æ–‡å­—å¤§å° */
    line-height: 1.6;        /* è¡Œé«˜ï¼Œè®©å¤šè¡Œæ–‡æœ¬æ›´æ˜“è¯» */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²ï¼Œä¸è¯­éŸ³æ¡åŒºåˆ† */
    padding: 8px 12px;       /* å†…è¾¹è· */
    margin-top: 6px;         /* å’Œä¸Šæ–¹çš„è¯­éŸ³æ¡æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    background-color: rgba(0, 0, 0, 0.04); /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    border-radius: 6px;      /* åœ†è§’ */
    word-break: break-word;  /* ç¡®ä¿é•¿æ–‡æœ¬èƒ½æ­£å¸¸æ¢è¡Œ */
    display: none;           /* é»˜è®¤éšè— */
}

#phone-screen.dark-mode .voice-transcript {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}

/* 2. æ—‹è½¬åŠ è½½åŠ¨ç”»çš„æ ·å¼ */
.loading-spinner {
    display: none; /* é»˜è®¤éšè— */
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color); /* æ—‹è½¬éƒ¨åˆ†çš„é¢œè‰² */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 8px; /* å’Œæ³¢å½¢å›¾ã€æ—¶é•¿ä¿æŒä¸€ç‚¹é—´è· */
}

/* 3. å®šä¹‰æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */
#shared-history-viewer-content {
    display: flex;
    flex-direction: column; /* è®©æ°”æ³¡å‚ç›´æ’åˆ— */
    gap: 20px; /* åœ¨æ¯ä¸ªæ°”æ³¡ä¹‹é—´å¢åŠ 20åƒç´ çš„é—´è· */
    padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å†…è¾¹è·ï¼Œé¿å…æ°”æ³¡è´´è¾¹ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾å™¨å’Œæ­Œè¯æ ·å¼ â–¼â–¼â–¼ */
#music-player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    background-color: rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50px);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#music-player-overlay.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.music-player-window { 
    width: 70%; 
    min-height: 420px;
    background-color: rgba(255, 255, 255, 0.6); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-radius: 25px; 
    box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
    border: 1px solid rgba(255, 255, 255, 0.18); 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    color: #1f1f1f; 
    position: relative;
    justify-content: space-between;
    padding-bottom: 15px;
}

.music-player-top-actions {
    position: absolute;
    top: 15px;
    left: 15px;
    right: 15px;
    width: calc(100% - 30px);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-left-cluster {
    display: flex;
    align-items: center;
    gap: 15px;
}
#music-return-btn, #music-exit-btn {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
}
#music-exit-btn {
    font-size: 24px;
    font-weight: 400;
}

.music-progress-bar-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    margin-bottom: 10px;
}
.time-display {
    font-size: 11px;
    color: #888;
    width: 35px;
    text-align: center;
    flex-shrink: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}
.progress-bar {
    flex-grow: 1;
    height: 5px;
    background-color: #e5e5e5;
    border-radius: 2.5px;
    cursor: pointer;
}
.progress-bar-fill {
    width: 0%;
    height: 100%;
    background-color: #333;
    border-radius: 2.5px;
}

#music-lyrics-container {
    width: 100%;
    height: 192px;
    overflow: hidden;
    position: relative;
    -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
    mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
}

#music-lyrics-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 1.5;
    transition: all 0.5s ease;
    opacity: 0.7;
    transform: scale(0.95);
}

.lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    transform: scale(1);
}

.music-player-controls-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-controls {
    margin-top: 0;
}

#music-return-btn, #music-exit-btn, #music-playlist-btn {
    position: relative;
}

#music-return-btn { top: -2px; }
#music-playlist-btn { top: -3px; }

.playlist-item-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.playlist-action-btn {
    font-size: 18px;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
}
.playlist-action-btn:hover { color: #000; }
.delete-track-btn { font-size: 24px; color: #ff3b30; }
.delete-track-btn:hover { color: #c00; }
.lyrics-btn { font-weight: 500; }

/* â–¼â–¼â–¼ ã€æœ€ç»ˆå¤´åƒæ”¾å¤§ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰€æœ‰ç›¸å…³çš„å¤´åƒå°ºå¯¸è§„åˆ™ â–¼â–¼â–¼ */

/* 1. æ™®é€šå¤´åƒæ ·å¼ï¼ˆæ— æ¡†ï¼‰ */
.message-bubble .avatar {
    width: 38px;  /* â˜… ä¿®æ”¹ç‚¹ï¼šå°†å°ºå¯¸ä» 34px æ”¾å¤§åˆ° 42px */
    height: 38px; /* â˜… ä¿®æ”¹ç‚¹ï¼šé«˜åº¦ä¹ŸåŒæ­¥æ”¾å¤§ */
    border-radius:  20%;
    object-fit: cover;
    flex-shrink: 0; 
}

/* 2. å¸¦æ¡†å¤´åƒçš„å®¹å™¨æ ·å¼ */
.avatar-with-frame {
    position: relative;
    width: 41px;  /* â˜… ä¿®æ”¹ç‚¹ï¼šå°ºå¯¸ä¸æ™®é€šå¤´åƒä¿æŒä¸€è‡´ */
    height: 41px; /* â˜… ä¿®æ”¹ç‚¹ï¼šé«˜åº¦ä¹ŸåŒæ­¥æ”¾å¤§ */
    flex-shrink: 0;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ â–¼â–¼â–¼ */

/* 1. æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦æ ·å¼ */
.recalled-message-placeholder {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
    cursor: pointer; /* è®©å®ƒçœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
}

/* 2. å¤œé—´æ¨¡å¼ä¸‹çš„é€‚é… */
#phone-screen.dark-mode .recalled-message-placeholder {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 3. AIæ’¤å›æ¶ˆæ¯æ—¶çš„åŠ¨ç”»æ•ˆæœ */
@keyframes recall-animation {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

.message-wrapper.recalled-animation {
  animation: recall-animation 0.3s ease-out forwards;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* å¼ºåˆ¶æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦ä¸æ¢è¡Œï¼Œå¹¶ä¿æŒå†…å®¹å±…ä¸­ */
.recalled-message-placeholder {
    white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡æœ¬æ¢è¡Œ */
    display: inline-block; /* è®©èƒŒæ™¯æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
    padding: 4px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.world-book-group-container {
    border-bottom: 1px solid var(--border-color);
}
.world-book-group-container:first-child {
    border-top: 1px solid var(--border-color);
}
.world-book-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}
.world-book-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}
.world-book-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}
.world-book-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}
.world-book-group-content {
    max-height: 100000px; /* <--- å°±æ˜¯ä¿®æ”¹è¿™é‡Œï¼ŒæŠŠå€¼æ”¹å¤§å³å¯ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.world-book-group-content.collapsed {
    max-height: 0;
}
#phone-screen.dark-mode .world-book-group-header {
    background-color: #1c1c1e;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…/è½¬è´¦æ¨¡æ€æ¡†é¡µç­¾æ ·å¼ â–¼â–¼â–¼ */
.frame-tabs {
    display: flex;
    background-color: #f0f0f0;
    padding: 4px;
    margin: 15px;
    border-radius: 8px;
}
.frame-tab {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #555;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}
.frame-tab.active {
    background-color: #ffffff;
    color: #000000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µå…¨æ–°çš„CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. åˆ†ç±»æ–‡ä»¶å¤¹çš„æ ·å¼ */
.wb-category-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5; /* ç»™æ–‡ä»¶å¤¹ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰²ä»¥åŒºåˆ† */
    font-weight: 600; /* åŠ ç²—å­—ä½“ */
}
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}


/* 2. å±•å¼€/æ”¶èµ·çš„å°ç®­å¤´ */
.wb-category-header .arrow {
    font-size: 12px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

/* 3. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶ï¼Œç®­å¤´æ—‹è½¬ */
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 4. å­˜æ”¾ä¹¦ç±æ¡ç›®çš„å®¹å™¨ */
.wb-book-container {
    padding-left: 20px; /* æ ¸å¿ƒï¼šè®©ä¹¦ç±æ¡ç›®å‘å†…ç¼©è¿›ï¼Œçœ‹èµ·æ¥åƒåœ¨æ–‡ä»¶å¤¹é‡Œ */
    max-height: 100000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ï¼Œç”¨äºåŠ¨ç”» */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

/* 5. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶ï¼Œä¹¦ç±å®¹å™¨çš„é«˜åº¦å˜ä¸º0ï¼Œå®ç°åŠ¨ç”»æ•ˆæœ */
.wb-book-container.collapsed {
    max-height: 0;
}

/* 6. å•ä¸ªä¹¦ç±æ¡ç›®ï¼ˆè¦†ç›–é»˜è®¤çš„labelæ ·å¼ï¼Œå¾®è°ƒé—´è·ï¼‰ */
.wb-book-container label {
    padding: 8px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦å…³è”é€‰æ‹©å™¨ - è§†è§‰ä¼˜åŒ– â–¼â–¼â–¼ */

/* 1. è®©åˆ†ç±»æ ‡é¢˜æ›´çªå‡º */
.wb-category-header > span:last-of-type {
    font-size: 14px;
    font-weight: 700; /* åŠ ç²— */
    color: var(--text-primary);
}

/* 2. ä¸ºç®­å¤´è®¾ç½®ä¸€ä¸ªæ¼‚äº®çš„é¢œè‰²å¾ªç¯ */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+1) .arrow { color: #007bff; } /* è“è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+2) .arrow { color: #28a745; } /* ç»¿è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+3) .arrow { color: #fd7e14; } /* æ©™è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+4) .arrow { color: #6f42c1; } /* ç´«è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+5) .arrow { color: #dc3545; } /* çº¢è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+6) .arrow { color: #ffc107; } /* é»„è‰² */

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%; /* è®©çª—å£é«˜ä¸€ç‚¹ */
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* æ¯è¡Œè‡ªåŠ¨å¡«å……ï¼Œæœ€å°70pxå®½ */
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; /* ä¸ºé¢„è§ˆå›¾åšå‡†å¤‡ */
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}

/* â–¼â–¼â–¼ æŠŠè¿™äº›CSSåŠ å›å» â–¼â–¼â–¼ */

.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%; /* å¸¦æ¡†çš„å¤´åƒé€šå¸¸æ˜¯åœ†çš„ */
    object-fit: cover;
    z-index: 1;
}
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„èŠå¤©å’Œå¿ƒå£°å¤´åƒæ¡†è§„åˆ™ â–¼â–¼â–¼ */

.avatar-with-frame .avatar-frame,
#inner-voice-avatar-frame {
    position: absolute;
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°†å®½é«˜ç»Ÿä¸€è®¾ç½®ä¸º125%ï¼Œç¡®ä¿èƒ½å®Œå…¨åŒ…è£¹34pxçš„å¤´åƒï¼Œå¹¶ç•™å‡ºæ¼‚äº®çš„è¾¹è· */
    width: 125%; 
    height: 125%;

    /* æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ ‡å‡†çš„-50%æ¥ç²¾ç¡®å®šä½ï¼Œç¡®ä¿å¤´åƒæ¡†å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -50%); 
    
    /* æ ¸å¿ƒä¿®æ”¹3ï¼šå°†å®šä½åŸºç‚¹ä¹Ÿæ”¹ä¸ºæ ‡å‡†çš„50%ï¼Œä¸transformé…åˆä½¿ç”¨ */
    top: 50%;
    left: 50%;

    z-index: 2;
    pointer-events: none;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆç¾åŒ–ç‰ˆã€‘èŠå¤©åˆ—è¡¨å·¦æ»‘ç½®é¡¶åŠŸèƒ½æ ·å¼ (å·²ä¿®å¤Bug) â–¼â–¼â–¼ */

/* 1. å¤–å±‚åŒ…è£¹å®¹å™¨ (å·²ç§»é™¤ display:flex) */
.chat-list-item-swipe-container {
    position: relative;
    overflow: hidden;
}

/* 2. å¯æ»‘åŠ¨çš„å†…å®¹åŒº (ä¿æŒä¸å˜) */
.chat-list-item-content {
    position: relative;
    z-index: 2;
    background-color: var(--secondary-bg);
    transition: transform 0.3s ease, background-color 0.3s ease;
    width: 100%;
    flex-shrink: 0;
}

/* 3. ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç½®é¡¶èŠå¤©æ—¶ï¼Œä½¿ç”¨å¯¹æ¯”åº¦æ›´å¼ºçš„èƒŒæ™¯è‰² */
.chat-list-item-content.pinned {
    background-color: #f0f2f5; /* æ—¥é—´æ¨¡å¼ä¸‹çš„ç½®é¡¶é¢œè‰² (å·²åŠ æ·±) */
}
#phone-screen.dark-mode .chat-list-item-content.pinned {
    background-color: #3a3a3c; /* å¤œé—´æ¨¡å¼ä¸‹çš„ç½®é¡¶é¢œè‰² (å·²åŠ æ·±) */
}

/* 4. éšè—çš„æ“ä½œæŒ‰é’®åŒºåŸŸ (ä¿æŒä¸å˜) */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
}

/* 5. å•ä¸ªæ“ä½œæŒ‰é’®çš„æ ·å¼ (ä¿æŒä¸å˜) */
.swipe-action-btn {
    height: 100%;
    padding: 0 20px;
    border: none;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
}

.swipe-action-btn.pin { background-color: #f0ad4e; }
.swipe-action-btn.unpin { background-color: #777; }
.swipe-action-btn.delete { background-color: #ff3b30; }

/* 6. å½“å†…å®¹åŒºè¢«æ»‘å¼€æ—¶ (ä¿æŒä¸å˜) */
.chat-list-item-content.swiped {
    transform: translateX(-160px);
}

/* 7. åˆ†å‰²çº¿çš„æ­£ç¡®é€»è¾‘ (ä¿æŒä¸å˜) */
.chat-list-item {
    border-bottom: none;
}
.chat-list-item-swipe-container:not(:last-child) {
     border-bottom: 1px solid var(--border-color);
}
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-of-type {
    border-top: 1px solid var(--border-color);
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ .date-stamp æ ·å¼ â–¼â–¼â–¼ */

/* æ—¥æœŸæˆ³çš„å¤–å±‚åŒ…è£¹ï¼Œè®©å®ƒåƒç³»ç»Ÿæ¶ˆæ¯ä¸€æ ·å±…ä¸­ */
.date-stamp-wrapper {
    justify-content: center;
    align-self: center;
    margin: 10px 0;
    max-width: 80%;
}

/* æ—¥æœŸæˆ³çš„æ°”æ³¡æœ¬èº« */
.date-stamp-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* é€‚é…å¤œé—´æ¨¡å¼ */
#phone-screen.dark-mode .date-stamp-bubble {
    background-color: rgba(255, 255, 255, 0.15);
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-list-time {
    font-size: 12px;
    color: var(--text-secondary);
    text-align: right;
    margin-left: 8px; /* å’Œä¸­é—´çš„ä¿¡æ¯åŒºæ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    flex-shrink: 0;   /* é˜²æ­¢åœ¨ç©ºé—´ä¸è¶³æ—¶è¢«å‹ç¼© */
    align-self: flex-start; /* è®©å®ƒå’Œé¡¶éƒ¨çš„åå­—å¯¹é½ */
    padding-top: 2px; /* å¾®è°ƒå‚ç›´ä½ç½® */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-list-right-column {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* è®©å†…å®¹é å³å¯¹é½ */
    gap: 4px; /* åœ¨æ—¶é—´å’Œçº¢ç‚¹ä¹‹é—´åŠ ä¸€ç‚¹ç‚¹é—´è· */
    flex-shrink: 0;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é”å±ä¸å¯†ç ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */

/* 1. é”å±ç•Œé¢çš„æ€»å®¹å™¨ */
#lock-screen {
    /* æ ¸å¿ƒï¼šç”¨ä¸€ä¸ªéå¸¸é«˜çš„ z-index ç¡®ä¿å®ƒèƒ½è¦†ç›–æ‰€æœ‰å…¶ä»–å±å¹• */
    z-index: 999; 
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* è®©æ—¶é’Ÿå’Œæç¤ºè¯­ä¸Šä¸‹åˆ†å¸ƒ */
    align-items: center;
    padding: 80px 20px 50px 20px;
    box-sizing: border-box;
    transition: transform 0.3s ease-out;
}

/* 2. é”å±æ—¶é’Ÿ (å¤ç”¨ä¸»å±å¹•æ—¶é’Ÿçš„æ ·å¼) */
#lock-clock-container {
    text-align: center;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    flex-shrink: 0;
}
#lock-main-time {
    font-size: 80px;
    font-weight: 200;
}
#lock-main-date {
    font-size: 18px;
    font-weight: 500;
}

/* 3. â€œå‘ä¸Šè½»æ‰«â€çš„æç¤ºæ–‡å­—å’ŒåŠ¨ç”» */
#unlock-hint {
    font-size: 16px;
    font-weight: 500;
    text-shadow: 0 1px 4px rgba(0,0,0,0.3);
    /* æ·»åŠ ä¸€ä¸ªå‘¼å¸åŠ¨ç”»ï¼Œå¸å¼•ç”¨æˆ·æ³¨æ„ */
    animation: hint-pulse 2s infinite ease-in-out;
}
@keyframes hint-pulse {
    0%, 100% { opacity: 0.7; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-5px); }
}

/* 4. å¯†ç è¾“å…¥å¼¹çª—çš„é®ç½©å±‚ */
#password-modal-overlay {
    /* ä½¿ç”¨ä¸€ä¸ªåŠé€æ˜çš„æ¯›ç»ç’ƒæ•ˆæœèƒŒæ™¯ */
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000; /* æ¯”é”å±æ›´é«˜ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* 5. å¯†ç è¾“å…¥å¼¹çª—çš„å†…å®¹åŒº */
.password-modal-content {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    width: 280px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 15px;
    color: #333;
}
.password-modal-content p {
    font-size: 17px;
    font-weight: 600;
    margin: 0;
}

/* 6. å¯†ç è¾“å…¥æ¡† */
#password-input-field {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
    box-sizing: border-box;
    background-color: rgba(255,255,255,0.7);
}
#password-input-field:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* 7. å¯†ç å¼¹çª—çš„æŒ‰é’®åŒºåŸŸ */
.password-actions {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}
.password-actions button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
}
#password-cancel-btn {
    background-color: #e9ecef;
    color: #495057;
}
#password-confirm-btn {
    background-color: var(--accent-color);
    color: white;
}

/* 8. å¯†ç é”™è¯¯æ—¶çš„æ™ƒåŠ¨åŠ¨ç”» */
@keyframes shake-error {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
.password-modal-content.error {
    animation: shake-error 0.4s ease-in-out;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ .bubble-preset-manager æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯ä½ è¦ä¿®æ”¹å‰çš„ä»£ç  */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡/APIæ ·å¼é¢„è®¾åŠŸèƒ½CSS â–¼â–¼â–¼ */
.bubble-preset-manager {
    display: flex;
    align-items: baseline; /* æ ¸å¿ƒä¿®æ”¹ï¼šä» center æ”¹ä¸º baseline */
    gap: 10px; /* å…ƒç´ ä¹‹é—´çš„é—´è· */
}



/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* ä¸‹æ‹‰æ¡†çš„æ ·å¼ï¼Œè®©å®ƒå æ®å¤§éƒ¨åˆ†ç©ºé—´ */
.bubble-preset-manager select {
    flex-grow: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
}

/* ç®¡ç†æŒ‰é’®çš„æ ·å¼ï¼Œè®©å®ƒå°å·§ç²¾è‡´ */
.bubble-preset-manager .action-btn {
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    padding: 8px 10px;
    font-size: 13px;
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©é”å±å’Œä¸»å±å¹•å¯ä»¥å †å  */
/* æ ¸å¿ƒï¼šæŠŠé”å±å’Œä¸»å±å¹•éƒ½è®¾ä¸ºç»å¯¹å®šä½ï¼Œè¿™æ ·å®ƒä»¬æ‰èƒ½é‡å  */
#lock-screen, #home-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 2. å®šä¹‰æ¯›ç»ç’ƒèƒŒæ™¯å±‚çš„æ ·å¼ */
#lock-screen-background-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å®ƒçš„å±‚çº§ç°åœ¨å’Œä¸»å±å¹•ä¸€æ ·ä½ */
    
    background-size: cover;
    background-position: center;

    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘é­”æ³•åœ¨è¿™é‡Œï¼æˆ‘ä»¬ç›´æ¥æ¨¡ç³Šè¿™ä¸ªå…ƒç´ æœ¬èº« */
    filter: blur(20px);
    -webkit-filter: blur(20px);
    
    /* (å¯é€‰ä½†æ¨è) è½»å¾®æ”¾å¤§å¯ä»¥é¿å…æ¨¡ç³Šåè¾¹ç¼˜å˜æš—ï¼Œæ•ˆæœæ›´å¥½ */
    transform: scale(1.1); 

    /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘é»˜è®¤éšè—ï¼Œä¸”å¸¦æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â–¼â–¼â–¼ */

/* === ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä¸–ç•Œä¹¦é€‰æ‹©å™¨åˆ—è¡¨æ ·å¼ === */

/* 1. åˆ†ç±»æ–‡ä»¶å¤¹è¡Œæ ·å¼ï¼šç”¨flexå’Œgapåˆ›å»ºå›ºå®šé—´è·ï¼Œéå¸¸ç¨³å®š */
.wb-category-header {
    display: flex;
    align-items: center;
    gap: 8px; /* ç®­å¤´ã€å¤é€‰æ¡†ã€æ–‡å­—ä¹‹é—´çš„å›ºå®šé—´è· */
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5;
    font-weight: 600;
    overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
}

/* 2. åˆ†ç±»æ–‡ä»¶å¤¹é‡Œçš„æ–‡å­—æ ·å¼ï¼šåªè´Ÿè´£æˆªæ–­ï¼Œä¸è´Ÿè´£å¸ƒå±€ */
.wb-category-header > span:last-of-type {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1; /* å…è®¸æ–‡å­—éƒ¨åˆ†åœ¨ç©ºé—´ä¸è¶³æ—¶è¢«å‹ç¼© */
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºåˆ†ç±»å’Œä¹¦ç›®é‡Œçš„å¤é€‰æ¡†â€œè§£ç»‘â€å…¨å±€æ ·å¼ï¼ */
.wb-category-header input[type="checkbox"],
.wb-book-container input[type="checkbox"] {
    width: auto !important; /* è®©å®ƒæ¢å¤è‡ªå·±çš„å¤©ç„¶å¤§å°ï¼Œ!importantç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§ */
    flex-shrink: 0;         /* é˜²æ­¢å®ƒè¢«å‹ç¼©ï¼Œä¿æŒå®Œæ•´ */
}

/* 4. å…·ä½“ä¹¦ç›®è¡Œçš„æ ·å¼ï¼šå¼ºåˆ¶ä»å·¦è¾¹å¼€å§‹æ’åˆ—ï¼Œè§£å†³ä¸åŒè®¾å¤‡çš„æ˜¾ç¤ºå·®å¼‚ */
.wb-book-container label {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* å¼ºåˆ¶æ‰€æœ‰å†…å®¹ä»å·¦è¾¹å¼€å§‹å¯¹é½ */
    padding: 8px 12px;
    gap: 10px; /* å¤é€‰æ¡†å’Œæ–‡å­—çš„é—´è· */
    overflow: hidden;
}

/* 5. å…·ä½“ä¹¦ç›®çš„æ–‡å­—æ ·å¼ */
.wb-book-container label .wb-book-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
    flex-shrink: 1; /* åŒæ ·å…è®¸å®ƒè¢«å‹ç¼© */
}

/* 6. å¤œé—´æ¨¡å¼é€‚é… (ä¿æŒä¸å˜) */
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e;
}

/* 7. å°ç®­å¤´çš„æ ·å¼ (ä¿æŒä¸å˜) */
.wb-category-header .arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
    flex-shrink: 0; /* é˜²æ­¢ç®­å¤´è¢«å‹ç¼© */
}
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 8. ä¹¦ç±å®¹å™¨çš„æ ·å¼ (ä¿æŒä¸å˜) */
.wb-book-container {
    padding-left: 20px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.wb-book-container.collapsed {
    max-height: 0;
}


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¼ æ ‡æ‹–åŠ¨å·¥å…·æ æ—¶çš„æ‰‹åŠ¿æ ·å¼ â–¼â–¼â–¼ */
#chat-input-actions-top.grabbing {
    cursor: grabbing;
    cursor: -webkit-grabbing;
    user-select: none; /* é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€SVGç»ˆæç‰ˆã€‘å‘é€å®šä½åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. åŸºç¡€å¡ç‰‡å’Œæ°”æ³¡æ ·å¼ (ä¿æŒä¸å˜) */
.message-bubble.is-location .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
.location-card { width: 230px; background-color: #f7f7f7; border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }

/* 2. ã€æ ¸å¿ƒå‡çº§ã€‘åœ°å›¾åŒºåŸŸç°åœ¨ç›´æ¥ç”¨äºå®¹çº³SVG */
.location-map-area {
    height: 90px;
    background-color: #f0f2f5;
    background-image:
        linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    padding: 5px; /* ç»™SVGä¸€ç‚¹å‘¼å¸ç©ºé—´ */
    box-sizing: border-box;
}
.location-map-area svg {
    width: 100%;
    height: 100%;
}

/* 3. ã€å…¨æ–°ã€‘SVGå†…éƒ¨å…ƒç´ çš„æ ·å¼ */
/* è½¨è¿¹æ›²çº¿ */
.svg-trajectory-path {
    stroke-width: 2px;
    stroke: rgba(180, 180, 180, 0.8);
    stroke-dasharray: 3 3; /* è™šçº¿æ•ˆæœ */
    fill: none;
}
/* å®šä½ç‚¹ (èµ·ç‚¹/ç»ˆç‚¹) */
.svg-pin {
    stroke-width: 2px;
    stroke: white;
}
.svg-pin.user-pin { fill: #4CAF50; } /* ç»¿è‰²ç”¨æˆ·ç‚¹ */
.svg-pin.ai-pin { fill: #ff5252; } /* çº¢è‰²AIç‚¹ */

/* è„šå°å›¾æ ‡ */
.svg-footprint {
    font-size: 14px;
    fill: rgba(0, 0, 0, 0.4);
}
/* é€”ç»ç‚¹åœ°åæ ‡ç­¾ */
.svg-location-label {
    font-size: 10px;
    font-weight: 500;
    fill: #555;
    /* ç»™æ–‡å­—ä¸€ç‚¹ç™½è‰²çš„æè¾¹ï¼Œè®©å®ƒåœ¨å¤æ‚èƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
    stroke: white;
    stroke-width: 2px;
    paint-order: stroke;
}

/* 4. å¡ç‰‡åº•éƒ¨ä¿¡æ¯åŒºåŸŸ (å·²å‡çº§) */
.location-info { padding: 12px; }
.location-address {
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 8px;
    color: #333;
}
.location-address .name-tag {
    font-weight: 600;
    color: var(--text-primary);
}
.location-address p.hidden { display: none; }
.location-distance {
    font-size: 12px;
    color: var(--text-secondary);
    border-top: 1px solid #e9e9e9;
    padding-top: 8px;
    text-align: center;
}
/* â–²â–²â–² å‡çº§ç‰ˆCSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–° | ä¿®å¤ç‰ˆã€‘â€œä¸€é”®é‡rollâ€æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
#reroll-btn {
    /* --- ç›´æ¥å¤ç”¨å…¶ä»–æŒ‰é’®çš„æ ·å¼ï¼Œç¡®ä¿å¤–è§‚ç»Ÿä¸€ --- */
    font-size: 24px;
    padding: 0;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    color: var(--text-primary);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    /* æ ¸å¿ƒä¿®å¤ï¼šè¾¹æ¡†é¢œè‰²å’Œå…¶ä»–æŒ‰é’®ç»Ÿä¸€ */
    border: 1px solid rgba(0,0,0,0.05); 
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* ç§»é™¤å¯¼è‡´å·®å¼‚çš„é˜´å½± */
    box-shadow: none; 

    /* ä¿ç•™åŸæœ‰çš„äº¤äº’åŠ¨æ•ˆ */
    transition: opacity 0.2s, transform 0.1s;
}

#reroll-btn:hover {
    opacity: 0.8;
}

#reroll-btn:active {
    transform: scale(0.9);
}

#reroll-btn svg {
    width: 20px;
    height: 20px;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€æœ€ç»ˆç¾åŒ–ç‰ˆã€‘æ‚¬æµ®æ­Œè¯æ æ ·å¼ â–¼â–¼â–¼ */
#floating-lyrics-bar {
    position: absolute;
    /* ã€é—®é¢˜1ä¿®å¤ã€‘é»˜è®¤ä½ç½®æ”¹ä¸ºé¡¶éƒ¨ */
    top: 50px; 
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px; /* åœ¨æ­Œè¯å’ŒæŒ‰é’®é—´å¢åŠ é—´è· */

    width: 90%; 
    max-width: 320px; /* åŒæ—¶è®¾ä¸€ä¸ªæœ€å¤§åƒç´ å®½åº¦ï¼Œé¿å…åœ¨å®½å±ä¸Šè¿‡é•¿ */
    padding: 8px 12px; /* ç¨å¾®å¢åŠ ä¸€ç‚¹å†…è¾¹è·ä»¥é€‚åº”æ–°å®½åº¦ */
    background-color: rgba(0, 0, 0, 0); 
    
    /* ã€é—®é¢˜3éœ€è¦ã€‘ä¸ºå­—ä½“é¢œè‰²å’ŒèƒŒæ™¯é€æ˜åº¦æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
    transition: background-color 0.3s, opacity 0.3s;

    color: white;
    font-size: 14px;
    font-weight: 500; /* å­—ä½“ç¨å¾®åŠ ç²— */
    text-align: center;
    border-radius: 12px;
    
    /* æ–‡å­—é˜´å½±ï¼Œè®©å®ƒåœ¨ä»»ä½•èƒŒæ™¯ä¸‹éƒ½æ¸…æ™° */
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); 
    
    cursor: pointer;
    user-select: none;
    
    /* ã€é—®é¢˜4éœ€è¦ã€‘ä¸ºå…³é—­æŒ‰é’®å‡†å¤‡ */
    overflow: visible; /* å…è®¸æŒ‰é’®è¶…å‡ºèŒƒå›´ */
}

/* ã€é—®é¢˜4éœ€è¦ã€‘å…³é—­æŒ‰é’®çš„æ ·å¼ */
#floating-lyrics-bar .close-btn,
#floating-lyrics-bar #lyrics-settings-btn {
    position: absolute;
    top: -8px;
    width: 20px;
    height: 20px;
    background-color: rgba(0,0,0,0.6);
    color: white;
    border-radius: 50%;
    border: 1px solid white;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
    display: flex; /* ç¡®ä¿SVGèƒ½å±…ä¸­ */
    align-items: center;
    justify-content: center;
}

/* æŠŠå…³é—­æŒ‰é’®å’Œè®¾ç½®æŒ‰é’®åˆ†å¼€æ”¾ç½® */
#floating-lyrics-bar .close-btn { right: -8px; line-height: 18px; font-size: 14px; }
#floating-lyrics-bar #lyrics-settings-btn { right: 22px; } /* æ”¾åœ¨å…³é—­æŒ‰é’®æ—è¾¹ */

/* é¼ æ ‡æ‚¬åœåœ¨æ•´ä¸ªæ­Œè¯æ ä¸Šæ—¶ï¼Œä¸€èµ·æ˜¾ç¤ºå®ƒä»¬ */
#floating-lyrics-bar:hover .close-btn,
#floating-lyrics-bar:hover #lyrics-settings-btn {
    opacity: 1;
}

#floating-lyrics-bar.dragging {
    cursor: grabbing;
    cursor: -webkit-grabbing;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* è§’è‰²é€‰æ‹©åˆ—è¡¨é¡¹ */
.character-select-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
}
.character-select-item:hover {
    background-color: #f5f5f5;
}
.character-select-item img {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 12px;
}
.character-select-item .name {
    font-weight: 500;
}

/* è§’è‰²æ‰‹æœºçš„èŠå¤©æ°”æ³¡ (ç®€åŒ–ç‰ˆ) */
.character-chat-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 80%;
    word-break: break-word;
    line-height: 1.5;
}
.character-chat-bubble.sent {
    background-color: #dcf8c6;
    align-self: flex-end; /* è‡ªå·±å‘çš„é å³ */
}
.character-chat-bubble.received {
    background-color: #ffffff;
    align-self: flex-start; /* æ”¶åˆ°çš„é å·¦ */
}

/* â–¼â–¼â–¼ ã€ç¾åŒ–ç‰ˆã€‘è§’è‰²æ‰‹æœºæ•°æ®åˆ—è¡¨é¡¹æ ·å¼ â–¼â–¼â–¼ */
.character-data-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0; /* è¾¹æ¡†é¢œè‰²å˜æµ… */
    margin: 8px 10px; /* å¢åŠ å¤–è¾¹è·ï¼Œå½¢æˆå¡ç‰‡æ„Ÿ */
    border-radius: 8px; /* å¢åŠ åœ†è§’ */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* å¢åŠ éå¸¸æ·¡çš„é˜´å½± */
    transition: transform 0.2s, box-shadow 0.2s; /* å¢åŠ æ‚¬æµ®åŠ¨ç”» */
    background-color: var(--secondary-bg);
}

.character-data-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.character-data-item .title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333; /* æ ‡é¢˜é¢œè‰²åŠ æ·± */
}
.character-data-item .content {
    font-size: 14px;
    color: #555;
    line-height: 1.6;
    white-space: pre-wrap;
}
.character-data-item .meta {
    font-size: 12px;
    color: #888;
    margin-top: 10px;
    padding-top: 8px; /* åœ¨metaä¸Šæ–¹å¢åŠ ä¸€ç‚¹è·ç¦»å’Œåˆ†å‰²çº¿ */
    border-top: 1px solid #f5f5f5;
    display: flex;
    justify-content: space-between;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V3ä¿®æ­£ç‰ˆã€‘è§’è‰²æ‰‹æœºâ€œç”»ä¸­ç”»â€æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒä¿®æ­£1ã€‘è®©æ‰‹æœºå¤–å£³å®¹å™¨å æ®æ•´ä¸ªå±å¹•ï¼Œå¹¶ç”¨å†…è¾¹è·æŠŠæ‰‹æœºæ¡†â€œæ¨â€ä¸‹æ¥ */
#character-phone-container {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #ffffff; /* â˜…â˜…â˜… æŠŠè¿™é‡Œæ”¹ä¸ºçº¯ç™½è‰² â˜…â˜…â˜… */
    padding-top: 50px; 
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
}


/* 2. æ‰‹æœºè¾¹æ¡†æ ·å¼ (ä¿®æ”¹å) */
.character-phone-frame {
    width: 95%;
    height: 98%;
    background-color: #111;
    border-radius: 30px;
    padding: 10px;
    box-shadow: none; /* â˜…â˜…â˜… å°±æ˜¯ä¿®æ”¹è¿™é‡Œ â˜…â˜…â˜… */
    box-sizing: border-box;
    position: relative;
    display: flex;
}

/* â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ #character-app-grid .app-icon .icon-bg è§„åˆ™ â–¼â–¼â–¼ */
#character-app-grid .app-icon .icon-bg {
    width: 65px;  /* æ¢å¤åŸæ¥çš„å°ºå¯¸ */
    height: 65px; /* æ¢å¤åŸæ¥çš„å°ºå¯¸ */
    border-radius: 18px; /* æ¢å¤åŸæ¥çš„åœ†è§’ */
    background-color: #fff5f7; /* è®¾ç½®ä¸ºä½ æƒ³è¦çš„æ·¡ç²‰è‰²èƒŒæ™¯ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 3. ã€æ ¸å¿ƒä¿®æ­£2ã€‘ç¼©å°APPå›¾æ ‡å†…çš„SVG */
#character-app-grid .app-icon .icon-bg svg {
    width: 60%;  /* â˜…â˜…â˜… å°†SVGçš„å®½åº¦ç¼©å°åˆ°å…¶å®¹å™¨çš„60% â˜…â˜…â˜… */
    height: 60%; /* â˜…â˜…â˜… é«˜åº¦ä¹ŸåŒæ­¥ç¼©å° â˜…â˜…â˜… */
}

/* 4. å…¶ä½™æ ·å¼ä¿æŒä¸å˜ */
.character-phone-inner-screen {
    flex-grow: 1;
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    background-color: var(--secondary-bg) !important; /* ä½¿ç”¨å˜é‡ */
}
.character-phone-notch {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 20px;
    border-radius: 0 0 10px 10px;
    z-index: 10;
}
.character-phone-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
.character-phone-page.active {
    opacity: 1;
    visibility: visible;
    z-index: 5;
}
/* â–¼â–¼â–¼ ç”¨è¿™å—ã€é€æ˜æ¯›ç»ç’ƒç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ .character-phone-header æ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ç”¨è¿™å—ã€é€æ˜æ¯›ç»ç’ƒç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ .character-phone-header æ ·å¼ â–¼â–¼â–¼ */

.character-phone-header {
    flex-shrink: 0;
    margin: 10px 12px 10px; /* â˜… ä¿®æ”¹ç‚¹1: å°†ä¸Šè¾¹è· 35px æ”¹ä¸º 0ï¼Œè®©å®ƒè´´é¡¶ */
    height: 50px;           /* â˜… ä¿®æ”¹ç‚¹2: å°†é«˜åº¦ä» 48px å¢åŠ åˆ° 56pxï¼Œè®©å®ƒæ›´é«˜ä¸€ç‚¹ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šå˜æˆä¸€ä¸ªæ›´åœ†æ¶¦çš„èƒ¶å›Šå½¢çŠ¶ */
    border-radius: 24px; /* å°†åœ†è§’ä»16pxå¢åŠ åˆ°24pxï¼Œçœ‹èµ·æ¥æ›´åœ†æ¶¦ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹2ï¼šè®¾ç½®ä¸€ä¸ªå‡ ä¹é€æ˜çš„ã€å¸¦æœ‰æ¯›ç»ç’ƒæ•ˆæœçš„èƒŒæ™¯ */
    background-color: rgba(180, 180, 180, 0.2); /* é™ä½ä¸é€æ˜åº¦ï¼Œè¥é€ é€æ˜æ„Ÿ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);

    /* â˜… æ ¸å¿ƒä¿®æ”¹3ï¼šè®©è¾¹æ¡†å’Œé˜´å½±æ›´ç²¾è‡´ï¼Œä»¥é€‚åº”é€æ˜æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.2); /* è¾¹æ¡†ä¹Ÿè°ƒå¾—æ›´é€æ˜ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);   /* é˜´å½±ç¨å¾®è°ƒæ•´ï¼Œæ›´æŸ”å’Œ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹4ï¼šå¼ºåˆ¶æ–‡å­—å’Œå›¾æ ‡é¢œè‰²å˜ä¸ºç™½è‰²ï¼Œå¹¶åŠ ä¸Šé˜´å½±ä»¥ä¿è¯æ¸…æ™° */
    color: #ffffff; /* æ ‡é¢˜æ–‡å­—å˜ä¸ºç™½è‰² */
    text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* ç»™æ–‡å­—åŠ ä¸€ç‚¹é˜´å½±ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªäº®çœ‹ä¸æ¸… */

    /* å¸ƒå±€éƒ¨åˆ†ä¿æŒä¸å˜ */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 12px;
    box-sizing: border-box;
    font-size: 16px;
}


/* â˜…â˜…â˜…ã€é‡è¦ã€‘ä¸ºäº†ç¡®ä¿æ‰€æœ‰å›¾æ ‡éƒ½å˜æˆç™½è‰²ï¼Œè¯·æŠŠä¸‹é¢è¿™æ®µæ–°ä»£ç ä¹ŸåŠ åˆ°<style>é‡Œ â˜…â˜…â˜… */
.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: #ffffff !important;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â˜…â˜…â˜…ã€é‡è¦ã€‘ä¸ºäº†ç¡®ä¿æ‰€æœ‰å›¾æ ‡éƒ½å˜æˆç™½è‰²ï¼Œè¯·æŠŠä¸‹é¢è¿™æ®µæ–°ä»£ç ä¹ŸåŠ åˆ°<style>é‡Œ â˜…â˜…â˜… */
.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: #ffffff !important;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.character-phone-header .action-btn svg,
.character-phone-header .back-btn svg {
    color: var(--accent-color);
}
#character-chat-history-messages {
     background-color: var(--secondary-bg) !important; /* ä½¿ç”¨å˜é‡ */      /* â˜…â˜…â˜… ç§»é™¤èƒŒæ™¯å›¾ç‰‡ â˜…â˜…â˜… */
}
/* â–²â–²â–² æ ·å¼ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V5æœ€ç»ˆä¿®å¤ç‰ˆã€‘è§’è‰²æ‰‹æœºAPPå›¾æ ‡å¸ƒå±€ä¿®æ­£ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ æ‰¾åˆ° #character-app-grid.app-grid-standardï¼Œä¿®æ”¹å…¶ä¸­çš„ padding-top å±æ€§ â–¼â–¼â–¼ */

#character-app-grid.app-grid-standard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px 15px;
    padding: 20px;
    padding-top: 95px; /* â˜…â˜…â˜… æŠŠ 50px æ”¹æˆ 95pxï¼Œä¸ºæ–°é¡¶æ ç•™å‡ºç©ºé—´ â˜…â˜…â˜… */
    box-sizing: border-box;
    width: 100%;
    flex-direction: initial; 
    align-items: initial;
}

/* â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ ·å¼ä¿®æ­£ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå¾®ä¿¡é£æ ¼èŠå¤©æ°”æ³¡æ ·å¼ â–¼â–¼â–¼ */

/* 1. èŠå¤©è®°å½•ç•Œé¢çš„èƒŒæ™¯è‰² */
#character-chat-history-messages {
    /* ç§»é™¤ä¹‹å‰ç‰ˆæœ¬å¯èƒ½å­˜åœ¨çš„èƒŒæ™¯å›¾ç‰‡ */
    background-image: none;
}

/* 2. æ¶ˆæ¯æ°”æ³¡çš„é€šç”¨å®¹å™¨æ ·å¼ */
.character-chat-bubble-container {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    margin-bottom: 12px;
    max-width: 80%; /* é™åˆ¶æ°”æ³¡æœ€å¤§å®½åº¦ */
}

/* 3. æ°”æ³¡çš„å†…å®¹åŒºåŸŸ */
.character-chat-bubble {
    position: relative;
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word;
    border-radius: 6px;
    font-size: 15px;
}

/* 4. å¤´åƒæ ·å¼ */
.character-chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 6px; /* å¾®ä¿¡é£æ ¼çš„åœ†è§’çŸ©å½¢å¤´åƒ */
    flex-shrink: 0;
}

/* --- æˆ‘æ–¹ï¼ˆè§’è‰²è‡ªå·±ï¼‰çš„æ°”æ³¡ --- */
.character-chat-bubble-container.sent {
    align-self: flex-end; /* æ•´ä½“é å³ */
    flex-direction: row-reverse; /* å¸ƒå±€åè½¬ï¼šå†…å®¹ -> å¤´åƒ */
}
.character-chat-bubble-container.sent .character-chat-bubble {
    background-color: #95ec69; /* å¾®ä¿¡ç»¿ */
    color: #000;
}
/* æˆ‘æ–¹æ°”æ³¡çš„å°å°¾å·´ */
.character-chat-bubble-container.sent .character-chat-bubble::after {
    content: "";
    position: absolute;
    right: -4px;
    top: 10px;
    width: 0;
    height: 0;
    border: 4px solid transparent;
    border-left-color: #95ec69;
    border-right: 0;
}

/* --- å¯¹æ–¹ï¼ˆNPCæˆ–ç”¨æˆ·ï¼‰çš„æ°”æ³¡ --- */
.character-chat-bubble-container.received {
    align-self: flex-start; /* æ•´ä½“é å·¦ */
}
/* å¯¹æ–¹æ°”æ³¡çš„å°å°¾å·´ */
.character-chat-bubble-container.received .character-chat-bubble::before {
    content: "";
    position: absolute;
    left: -4px;
    top: 10px;
    width: 0;
    height: 0;
    border: 4px solid transparent;
    border-right-color: #ffffff;
    border-left: 0;
}
/* â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼ */
.character-chat-bubble-container.received .character-chat-bubble {
    background-color: #ffffff; /* å¾®ä¿¡ç™½ */
    color: #000;
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* --- åŠŸèƒ½æ€§é‡ç½®ï¼šé’ˆå¯¹å›¾ç‰‡/è¡¨æƒ…åŒ…ï¼Œè®©æ°”æ³¡â€œæ¶ˆå¤±â€ --- */
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image) {
    background: transparent !important;
    padding: 0 !important;
    border-radius: 0;
}
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image)::before,
.character-chat-bubble-container .character-chat-bubble:has(img.sticker-image)::after {
    content: none !important;
}
/* â–²â–²â–² æ ·å¼æ·»åŠ ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºæ–°å¢APPé¡µé¢æ ·å¼ â–¼â–¼â–¼ */

/* 1. ç›¸å†Œé¡µé¢çš„ç½‘æ ¼å¸ƒå±€ */
#character-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼ å›¾ */
    gap: 4px;
    padding: 4px;
}
.character-album-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: #e0e0e0;
    cursor: pointer;
}
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 2. é“¶è¡Œé¡µé¢çš„ä½™é¢æ˜¾ç¤º */
.character-bank-balance-card {
    margin: 15px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.character-bank-balance-card .label {
    font-size: 14px;
    opacity: 0.8;
}
.character-bank-balance-card .amount {
    font-size: 32px;
    font-weight: 600;
    margin-top: 5px;
}

/* 3. é“¶è¡Œäº¤æ˜“è®°å½•çš„é¢œè‰² */
.character-data-item .transaction-amount {
    font-weight: 600;
}
.character-data-item .transaction-amount.income {
    color: #4CAF50; /* æ”¶å…¥ä¸ºç»¿è‰² */
}
.character-data-item .transaction-amount.expense {
    color: #F44336; /* æ”¯å‡ºä¸ºçº¢è‰² */
}

/* â–²â–²â–² æ ·å¼æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V5ä¿®æ­£ç‰ˆã€‘è§’è‰²æ‰‹æœºç›¸å†Œç½‘æ ¼å¸ƒå±€ â–¼â–¼â–¼ */
#character-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼ å›¾ */
    gap: 4px;
    padding: 4px;
}
.character-album-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: #e0e0e0;
    cursor: pointer;
}
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
/* â–²â–²â–² æ ·å¼ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Markdownæ¸²æŸ“å¢å¼ºæ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸ºè§’è‰²æ‰‹æœºé‡Œçš„æ‰€æœ‰Markdownå†…å®¹è®¾ç½®åŸºç¡€æ ·å¼ */
.character-data-item .content h1,
.character-data-item .content h2,
.character-data-item .content h3,
.character-data-item .content p {
    margin: 0 0 10px 0; /* ç»Ÿä¸€æ ‡é¢˜å’Œæ®µè½çš„ä¸‹è¾¹è· */
}
.character-data-item .content h1 { font-size: 1.5em; font-weight: 600; }
.character-data-item .content h2 { font-size: 1.3em; font-weight: 600; }
.character-data-item .content h3 { font-size: 1.1em; font-weight: 600; }

/* 2. åˆ é™¤çº¿æ ·å¼ */
.character-data-item .content del {
    color: #8a8a8a;
}

/* 3. é®æŒ¡/å‰§é€æ•ˆæœ */
.character-data-item .content .spoiler {
    background-color: #333;
    color: #333; /* æ–‡å­—å’ŒèƒŒæ™¯ä¸€ä¸ªè‰²ï¼Œå®ç°éšè— */
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
/* ç‚¹å‡»æˆ–é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå†…å®¹ */
.character-data-item .content .spoiler:hover,
.character-data-item .content .spoiler:active {
    background-color: #f0f0f0;
    color: #000;
}

/* â–²â–²â–² æ ·å¼æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºæ—¥è®°ç¾åŒ–ä¸åˆ é™¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©æ—¥è®°åˆ—è¡¨æœ‰æ›´å¥½çš„è¾¹è· */
#character-diary-list {
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* å¢åŠ æ—¥è®°ä¹‹é—´çš„é—´è· */
}

/* 2. ç¾åŒ–å•ç¯‡æ—¥è®°å¡ç‰‡ */
#character-diary-list .character-data-item {
    background-color: #fffaf0; /* æ¸©æš–çš„ç±³é»„è‰²èƒŒæ™¯ */
    border-left: 4px solid #ffc107; /* å·¦ä¾§åŠ ä¸€æ¡è£…é¥°çº¿ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    padding-bottom: 35px; /* ä¸ºåº•éƒ¨çš„æ—¥æœŸç•™å‡ºç©ºé—´ */
}

/* 3. ç¾åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ŒæŠŠå®ƒæ”¾åˆ°å³ä¸‹è§’ */
#character-diary-list .character-data-item .meta {
    position: absolute;
    bottom: 8px;
    right: 12px;
    border-top: none; /* ç§»é™¤åŸæ¥çš„ä¸Šè¾¹æ¡† */
    padding-top: 0;
    font-size: 11px;
    color: #bfa87a;
}

/* 4. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.diary-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.05);
    color: #bfa87a;
    border: none;
    cursor: pointer;
    font-size: 20px;
    line-height: 26px;
    text-align: center;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease-in-out;
}
/* é¼ æ ‡æ‚¬åœåœ¨æ—¥è®°ä¸Šæ—¶æ˜¾ç¤ºæŒ‰é’® */
#character-diary-list .character-data-item:hover .diary-delete-btn {
    opacity: 1;
}
.diary-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ ·å¼æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6æœ€ç»ˆä¿®å¤ç‰ˆã€‘è§’è‰²æ‰‹æœºç›¸å†Œå¸ƒå±€é˜²æº¢å‡º â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘ä¸ºç›¸å†Œç½‘æ ¼çš„å®¹å™¨å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
#character-album-grid.list-container {
    overflow-x: hidden;
}

/* 2. é‡æ–°å®šä¹‰ç½‘æ ¼å¸ƒå±€ */
#character-album-grid {
    display: grid;
    /* ã€æ ¸å¿ƒã€‘æ¯è¡Œ3ä¸ªï¼Œä½†è¿™æ¬¡æˆ‘ä»¬ç”¨calc()ç²¾ç¡®è®¡ç®—å®½åº¦ */
    grid-template-columns: repeat(3, calc(33.333% - 4px)); 
    gap: 6px; /* ç¨å¾®å¢å¤§é—´éš™ï¼Œè®©calcæœ‰è®¡ç®—ç©ºé—´ */
    padding: 6px; /* å†…è¾¹è·å’Œé—´éš™ä¿æŒä¸€è‡´ */
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·å’Œè¾¹æ¡†è¢«åŒ…å«åœ¨æ€»å®½åº¦å†… */
    align-content: start; /* <--- å°±æ˜¯åŠ ä¸Šè¿™ä¸€è¡Œï¼ */
}

/* 3. ç¨å¾®ç¼©å°å›¾ç‰‡ï¼Œç¡®ä¿å®ƒä»¬ä¸ä¼šæ’‘ç ´å®¹å™¨ */
.character-album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block; /* ç§»é™¤å›¾ç‰‡ä¸‹æ–¹çš„å¾®å°ç©ºéš™ */
}

/* â–²â–²â–² æ ·å¼ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6ç‹¬å®¶å®šåˆ¶ã€‘è§’è‰²æ‰‹æœºä¿¡çº¸é£æ ¼æ—¥è®°æ ·å¼ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘é‡å¡‘æ—¥è®°å¡ç‰‡ï¼Œè®©å®ƒåƒä¸€å¼ ä¿¡çº¸ */
#character-diary-list .character-data-item {
    background-color: #fdfaf2; /* æ¸©æš–ã€æŸ”å’Œçš„ç±³ç™½/æµ…é»„è‰²ï¼Œæ¨¡æ‹Ÿä¿¡çº¸ */
    border: 1px solid #eaddc7;  /* æ·¡æ·¡çš„çº¸å¼ è¾¹ç¼˜è‰² */
    border-left: 3px solid #d4bda5; /* å·¦ä¾§åŠ ä¸€æ¡ç¨æ·±çš„çº¿ï¼Œåƒè£…è®¢çº¿ */
    box-shadow: 2px 2px 6px rgba(0,0,0,0.06); /* æ›´æŸ”å’Œçš„é˜´å½± */
    position: relative;
    padding: 20px 15px 15px 20px; /* è°ƒæ•´å†…è¾¹è·ï¼Œç»™â€œå°ä¸œè¥¿â€ç•™å‡ºç©ºé—´ */
    font-family: Georgia, 'Times New Roman', 'Kaiti TC', 'STKaiti', serif; /* ä½¿ç”¨æ›´å…¸é›…çš„è¡¬çº¿å­—ä½“ */
}

/* 2. ã€å°ä¸œè¥¿ã€‘ç”¨ä¼ªå…ƒç´ åœ¨å·¦ä¸Šè§’æ·»åŠ ä¸€ä¸ªç²¾è‡´çš„çº¸å¤¹ */
#character-diary-list .character-data-item::before {
    content: 'ğŸ“'; /* è¿™æ˜¯ä¸€ä¸ªEmojiçº¸å¤¹ï¼Œç®€å•åˆæœ‰æ•ˆ */
    position: absolute;
    top: -12px;
    left: 15px;
    font-size: 24px;
    transform: rotate(-25deg); /* è®©çº¸å¤¹æœ‰ä¸€ä¸ªéšæ„çš„è§’åº¦ */
    opacity: 0.8;
}

/* 3. ã€æ ¸å¿ƒã€‘é‡ç½®Markdownå†…å®¹çš„å­—ä½“ï¼Œç¡®ä¿å®ƒä»¬ç»§æ‰¿ä¿¡çº¸çš„å­—ä½“ */
#character-diary-list .character-data-item .content,
#character-diary-list .character-data-item .content h1,
#character-diary-list .character-data-item .content h2,
#character-diary-list .character-data-item .content h3 {
    font-family: inherit; /* å¼ºåˆ¶ç»§æ‰¿çˆ¶å…ƒç´ çš„å­—ä½“ */
    color: #4a443b; /* ä½¿ç”¨æ·±æ£•è‰²æ–‡å­—ï¼Œæ›´æœ‰è´¨æ„Ÿ */
}

#character-diary-list .character-data-item .content p {
    margin: 0 0 12px 0;
}

/* 4. å°†æ—¥æœŸç§»åŠ¨åˆ°å³ä¸Šè§’ï¼Œåƒä¿¡çº¸çš„è½æ¬¾æ—¥æœŸ */
#character-diary-list .character-data-item .meta {
    position: absolute;
    top: 10px;
    right: 12px;
    font-size: 11px;
    color: #ae9c82; /* åŒ¹é…ä¿¡çº¸é£æ ¼çš„æ—¥æœŸé¢œè‰² */
    font-style: italic; /* æ–œä½“æ›´æœ‰æ‰‹å†™æ„Ÿ */
    border-top: none;
    padding-top: 0;
}

/* 5. ç¾åŒ–åˆ é™¤æŒ‰é’®ï¼Œè®©å®ƒæ›´èå…¥ä¿¡çº¸é£æ ¼ */
#character-diary-list .character-data-item .diary-delete-btn {
    background-color: transparent;
    color: #c9bbae;
    font-size: 22px;
    transition: all 0.2s ease;
}

#character-diary-list .character-data-item .diary-delete-btn:hover {
    background-color: #e44d44;
    color: white;
    transform: scale(1.1);
}

/* â–²â–²â–² æ ·å¼æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå…¨APPç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. è´­ç‰©è½¦æ ·å¼ --- */
.character-cart-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.character-cart-item:last-child {
    border-bottom: none;
}
.cart-item-icon {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
    background-color: #f0f2f5;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-secondary);
}
.cart-item-info {
    flex-grow: 1;
}
.cart-item-info .title {
    font-weight: 500;
}
.cart-item-info .store {
    font-size: 12px;
    color: var(--text-secondary);
}
.cart-item-price {
    font-weight: 600;
    font-size: 15px;
}

/* --- 2. æµè§ˆå™¨å†å²æ ·å¼ --- */
.character-browser-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}
.character-browser-item:hover {
    background-color: #f9f9f9;
}
.browser-item-icon {
    font-size: 20px;
    color: var(--text-secondary);
}

/* --- 3. é“¶è¡Œäº¤æ˜“æ˜ç»†æ ·å¼ --- */
.character-bank-transaction {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.transaction-details {
    display: flex;
    align-items: center;
    gap: 12px;
}
.transaction-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    color: white;
}

/* --- 4. è¡ŒåŠ¨è½¨è¿¹ (æ—¶é—´çº¿) æ ·å¼ --- */
.character-trajectory-list {
    padding: 20px 15px 20px 30px; /* å·¦ä¾§ç•™å‡ºæ—¶é—´çº¿çš„ç©ºé—´ */
}
.character-trajectory-item {
    position: relative;
    padding-bottom: 25px;
}
/* æ—¶é—´è½´çš„ç«–çº¿ */
.character-trajectory-item::before {
    content: '';
    position: absolute;
    top: 5px;
    left: -18px;
    width: 2px;
    height: 100%;
    background-color: #e0e0e0;
}
.character-trajectory-item:last-child::before {
    display: none; /* æœ€åä¸€ä¸ªæ¡ç›®æ²¡æœ‰çº¿ */
}
/* æ—¶é—´è½´çš„åœ†ç‚¹ */
.character-trajectory-item::after {
    content: '';
    position: absolute;
    top: 5px;
    left: -23px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--accent-color);
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--accent-color);
}
.trajectory-item-content .meta {
    margin-top: 4px; /* è®©æ—¶é—´å’Œåœ°ç‚¹ç¦»æ ‡é¢˜è¿‘ä¸€ç‚¹ */
}

/* --- 5. APPä½¿ç”¨è®°å½• (è¿›åº¦æ¡) æ ·å¼ --- */
.character-app-usage-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}
.app-usage-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}
.app-usage-header .name {
    font-weight: 500;
}
.app-usage-header .duration {
    color: var(--text-secondary);
}
.app-usage-bar-container {
    width: 100%;
    height: 6px;
    background-color: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}
.app-usage-bar {
    height: 100%;
    background-color: var(--accent-color);
    border-radius: 3px;
    transition: width 0.5s ease-in-out;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åå°æ´»åŠ¨è®¾ç½®ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
.char-list-item {
    display: flex;
    align-items: center;
    padding: 8px 5px;
    border-bottom: 1px solid #eee;
}
.char-list-item:last-child {
    border-bottom: none;
}
.char-list-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
}
.char-list-item .char-name {
    flex-grow: 1;
}
.char-list-item .char-freq-badge {
    font-size: 11px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 10px;
    color: white;
}
.char-freq-badge.low { background-color: #28a745; }
.char-freq-badge.medium { background-color: #fd7e14; }
.char-freq-badge.high { background-color: #dc3545; }
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯å¯è§†åŒ–ç•Œé¢æ ·å¼ === */

/* 1. å¯è§†åŒ–ç•Œé¢çš„æ€»å®¹å™¨ï¼Œç¡®ä¿å®ƒèƒ½è¦†ç›–æ•´ä¸ªå±å¹• */
#visual-call-interface {
    width: 100%;
    height: 100%;
    position: relative; /* è®©å†…éƒ¨å…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    background-color: #1c1c1e; /* æ·±è‰²èƒŒæ™¯ */
    display: flex; /* ä½¿ç”¨flexå¸ƒå±€ï¼Œæ–¹ä¾¿å†…å®¹æ’åˆ— */
    flex-direction: column;
}

/* 2. è§†é¢‘èƒŒæ™¯å±‚ï¼Œç”¨äºæ”¾ç½®å¤§å°å›¾ */
.video-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* ç¡®ä¿å®ƒåœ¨æœ€åº•å±‚ */
}

/* 3. å¤§å°å›¾çš„é€šç”¨å®¹å™¨æ ·å¼ */
.video-container {
    position: absolute;
    background-color: #000;
    overflow: hidden;
    transition: all 0.3s ease-in-out; /* ä¸ºåˆ‡æ¢é•œå¤´æ·»åŠ åŠ¨ç”» */
}
.video-container img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
}

/* 4. å¤§å›¾æ ·å¼ (é»˜è®¤å æ»¡å…¨å±) */
#video-main-view {
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 5. å°å›¾æ ·å¼ (ç”»ä¸­ç”») */
#video-pip-view {
    top: 60px; /* è·ç¦»é¡¶éƒ¨ä¸€æ®µè·ç¦» */
    right: 15px;
    width: 100px; /* å°çª—å®½åº¦ */
    height: 178px; /* å°çª—é«˜åº¦ (ä¿æŒç«–å±æ¯”ä¾‹) */
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer; /* æç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡» */
}

/* 6. èŠå¤©æ°”æ³¡åŒºåŸŸ (è¦†ç›–åœ¨è§†é¢‘ä¹‹ä¸Š) */
#video-call-messages-visual {
    position: relative;
    z-index: 5; /* å±‚çº§æ¯”è§†é¢‘é«˜ */
    flex-grow: 1; /* å æ®é™¤äº†é¡¶éƒ¨å’Œåº•éƒ¨æ ä¹‹å¤–çš„æ‰€æœ‰ç©ºé—´ */
    padding: 15px;
    overflow-y: auto; /* å†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
    display: flex;
    flex-direction: column;
    gap: 15px;
    /* å…³é”®ï¼šä¸ºäº†ä¸è®©æ»šåŠ¨æ¡å½±å“ç¾è§‚ï¼ŒæŠŠå®ƒéšè—æ‰ */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE 10+ */
}
#video-call-messages-visual::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera*/
}

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€å°å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„æ°”æ³¡æ ·å¼ï¼Œå®ç°ã€æ— æ¨¡ç³Šã€‘æ•ˆæœ â–¼â–¼â–¼ */

/* 7. ã€æ— æ¨¡ç³Šã€‘é«˜æ¸…é€æ˜èŠå¤©æ°”æ³¡ */
.visual-call-bubble {
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    line-height: 1.5;
    word-break: break-word;
    color: white;

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå½»åº•ç§»é™¤ backdrop-filter (æ¨¡ç³Š) æ•ˆæœ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæä¾›ä¸€ä¸ªç®€å•çš„åŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œä»¥è¡¬æ‰˜æ–‡å­— */
    background-color: rgba(0, 0, 0, 0.3); /* è¿™æ˜¯ä¸€ä¸ªå…³é”®å€¼ï¼Œå¯ä»¥åœ¨ 0.2 (æ›´é€) åˆ° 0.4 (æ›´æ·±) ä¹‹é—´å¾®è°ƒ */

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ›´æ¸…æ™°çš„è¾¹æ¡†æ¥å®šä¹‰æ°”æ³¡è½®å»“ */
    border: 1px solid rgba(255, 255, 255, 0.25);

    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåŒ–æ–‡å­—é˜´å½±ï¼Œç¡®ä¿åœ¨ä»»ä½•æ¸…æ™°èƒŒæ™¯ä¸‹éƒ½ç»å¯¹å¯è¯» */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
}

.visual-call-bubble.user {
    align-self: flex-end;
    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç”¨æˆ·æ°”æ³¡ä¹Ÿä½¿ç”¨æ— æ¨¡ç³Šçš„åŠé€æ˜èƒŒæ™¯ */
    background-color: rgba(40, 160, 70, 0.3); /* ä½¿ç”¨ä¸€ä¸ªæ›´æ·±çš„ç»¿è‰²æ¥ä¿è¯å¯¹æ¯”åº¦ */
    border-color: rgba(255, 255, 255, 0.3);
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



.visual-call-bubble.ai {
    align-self: flex-start; /* AIçš„å‘è¨€é å·¦ */
}

/* 8. é¡¶éƒ¨å’Œåº•éƒ¨æ çš„å±‚çº§è¦æœ€é«˜ */
#visual-call-interface .video-call-top-bar,
#visual-call-interface .video-call-controls {
    z-index: 10;
}

/* 9. æ–°å¢çš„æ§åˆ¶æŒ‰é’®å›¾æ ‡ (ä½¿ç”¨SVG) */
.control-btn.reroll-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>');
    background-size: 50%;
}
.control-btn.switch-camera-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>');
    background-size: 50%;
}

/* 10. æŒ‚æ–­æŒ‰é’®éœ€è¦ä¸€ä¸ªæ–°IDæ¥åŒºåˆ† */
#hang-up-btn-visual {
    /* æ ·å¼ç»§æ‰¿è‡ª .hangup-btnï¼Œæ— éœ€é¢å¤–æ·»åŠ  */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä¸–ç•Œä¹¦é€‰æ‹©å™¨åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */

/* 1. åˆ†ç±»æ–‡ä»¶å¤¹è¡Œæ ·å¼ï¼šç”¨gapåˆ›å»ºå›ºå®šé—´è·ï¼Œè¶…ç¨³å®š */
.wb-category-header {
    display: flex;
    align-items: center;
    gap: 8px; /* ç®­å¤´ã€å¤é€‰æ¡†ã€æ–‡å­—ä¹‹é—´çš„å›ºå®šé—´è· */
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5;
    font-weight: 600;
    overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤– */
}

/* 2. åˆ†ç±»æ–‡ä»¶å¤¹é‡Œçš„æ–‡å­—æ ·å¼ï¼šåªè´Ÿè´£æˆªæ–­ï¼Œä¸è´Ÿè´£å¸ƒå±€ */
.wb-category-header > span:last-of-type {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºåˆ†ç±»æ–‡ä»¶å¤¹å’Œä¹¦ç›®é‡Œçš„å¤é€‰æ¡†â€œè§£ç»‘â€å…¨å±€æ ·å¼ï¼ */
.wb-category-header input[type="checkbox"],
.wb-book-container input[type="checkbox"] {
    width: auto !important; /* è®©å®ƒæ¢å¤è‡ªå·±çš„å¤©ç„¶å¤§å°ï¼Œ!importantç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§ */
    flex-shrink: 0;         /* é˜²æ­¢å®ƒè¢«å‹ç¼© */
}

/* 4. å…·ä½“ä¹¦ç›®è¡Œçš„æ ·å¼ï¼šå¼ºåˆ¶ä»å·¦è¾¹å¼€å§‹æ’åˆ—ï¼Œè§£å†³iOSé—®é¢˜ */
.wb-book-container label {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* å¼ºåˆ¶æ‰€æœ‰å†…å®¹ä»å·¦è¾¹å¼€å§‹ï¼*/
    padding: 8px 12px;
    gap: 10px; /* å¤é€‰æ¡†å’Œæ–‡å­—çš„é—´è· */
    overflow: hidden;
}

/* 5. å…·ä½“ä¹¦ç›®çš„æ–‡å­—æ ·å¼ */
.wb-book-container label .wb-book-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
}

/* 6. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e;
}

/* 7. å°ç®­å¤´çš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
.wb-category-header .arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
}
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 8. ä¹¦ç±å®¹å™¨çš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
.wb-book-container {
    padding-left: 20px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.wb-book-container.collapsed {
    max-height: 0;
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—ä½“é¢„è®¾åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

#font-preset-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px; /* å¡æ§½ä¹‹é—´çš„é—´è· */
}

.font-preset-slot {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#phone-screen.dark-mode .font-preset-slot {
    border-color: #38383a;
}

.font-preset-slot.empty {
    justify-content: center;
    align-items: center;
    min-height: 80px;
    border-style: dashed;
}

.font-preview-text {
    font-size: 22px;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    min-height: 30px;
    transition: font-family 0.3s ease;
}

#phone-screen.dark-mode .font-preview-text {
    background-color: #2c2c2e;
    color: #fff;
}

.font-preset-info {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
}

.font-preset-actions {
    display: flex;
    gap: 10px;
    width: 100%;
}

.preset-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background-color: var(--accent-color);
    color: white;
}

.preset-btn.secondary {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-btn.secondary {
    background-color: #3e3e42;
    border-color: #545458;
}

.preset-btn.delete {
    background-color: #ffdde5;
    color: #ff3b30;
    border: 1px solid #ffc2d1;
    max-width: 80px; /* è®©åˆ é™¤æŒ‰é’®çª„ä¸€ç‚¹ */
    flex: 0 0 auto;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* ã€ç¾åŒ– V2ã€‘è®©åå°æ´»åŠ¨è®¾ç½®çš„æŒ‰é’®æ›´åœ†æ¶¦ã€æ›´ç«‹ä½“ */
#background-activity-details .form-button-secondary {
    border-radius: 20px; /* å¤§å¹…å¢åŠ åœ†è§’ï¼Œå½¢æˆèƒ¶å›Šå½¢çŠ¶ */
    padding-top: 10px;   /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´é«˜ */
    padding-bottom: 10px;/* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´é«˜ */
    font-weight: 500;    /* å­—ä½“ç¨å¾®åŠ ç²—ä¸€ç‚¹ */
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
}

/* ä¸ºæŒ‰é’®æ·»åŠ ä¸€ä¸ªå¾®å¦™çš„ç‚¹å‡»æ•ˆæœ */
#background-activity-details .form-button-secondary:active {
    transform: scale(0.96); /* ç‚¹å‡»æ—¶è½»å¾®ç¼©å° */
    opacity: 0.8;         /* ç‚¹å‡»æ—¶ç¨å¾®å˜æ·¡ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™æ®µæ–°æ ·å¼ â–¼â–¼â–¼ */
#music-search-results-modal .modal-content {
    z-index: 220; /* è¿™ä¸ªå€¼æ¯”æ’­æ”¾åˆ—è¡¨çš„ 210 è¦é«˜ */
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}

.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢æºé€‰æ‹©å¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
#music-source-selector-modal .modal-body label {
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}
#music-source-selector-modal .modal-body input[type="radio"] {
    width: 18px;
    height: 18px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å¸ƒå±€å¾®è°ƒç‰ˆã€‘æ ·å¼ï¼Œæ›¿æ¢æ‰ä¸Šä¸€æ¬¡çš„æ—§æ ·å¼ â–¼â–¼â–¼ */

/* 1. é—ªçƒåŠ¨ç”» (ä¿æŒä¸å˜) */
@keyframes flash-char {
    0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 3px rgba(255,192,203, 0); }
    50% { opacity: 0.8; transform: scale(1.08); box-shadow: 0 0 12px rgba(255,192,203, 0.9); }
}
@keyframes flash-user {
    0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 3px rgba(173,216,230, 0); }
    50% { opacity: 0.8; transform: scale(1.08); box-shadow: 0 0 12px rgba(173,216,230, 0.9); }
}

/* 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒæ•´å¤´åƒå®¹å™¨çš„ä¸‹è¾¹è· */
#music-avatars-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 8px; /* <<<< ä» 25px å‡å°åˆ° 8pxï¼Œè®©å®ƒå’Œä¸‹é¢çš„æ–‡å­—æ›´è¿‘ */
    position: relative;
    z-index: 5;
}

/* 3. å•ä¸ªå¤´åƒæ ·å¼ (ä¿æŒä¸å˜) */
#music-avatars-container img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 4. åˆ†å¼€é—ªçƒåŠ¨ç”» (ä¿æŒä¸å˜) */
#music-avatars-container.flashing #music-char-avatar {
    animation: flash-char 2.2s infinite ease-in-out;
}
#music-avatars-container.flashing #music-user-avatar {
    animation: flash-user 2.2s infinite ease-in-out 0.3s;
}

/* 5. å¿ƒç”µå›¾æ ·å¼ (ä¿æŒä¸å˜) */
#heartbeat-line {
    width: 80px;
    height: 30px;
    overflow: visible;
    margin: 0 -15px;
    opacity: 0;
    transition: opacity 0.5s;
}
#music-avatars-container.flashing #heartbeat-line {
    opacity: 1;
}
.heartbeat-path {
    stroke: #FFC0CB;
    stroke-width: 1.5;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: draw-line 2.2s infinite linear;
    filter: drop-shadow(0 0 3px #FFC0CB); 
}
.heartbeat-heart {
    display: none;
}
@keyframes draw-line {
    to { stroke-dashoffset: 0; }
}

/* 6. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒæ•´â€œä¸€èµ·å¬äº†â€æ–‡å­—çš„æ ·å¼å’Œè¾¹è· */
#music-time-counter {
    margin-bottom: 20px; /* <<<< ç°åœ¨ç”±å®ƒæ¥è´Ÿè´£å’Œä¸‹é¢çš„å°é¢æ‹‰å¼€è·ç¦» */
    font-size: 11px;
    color: #666; /* é¢œè‰²ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
    text-align: center;
}

/* 7. å”±ç‰‡æ—‹è½¬åŠ¨ç”» (ä¿æŒä¸å˜) */
@keyframes spin-record {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 8. å°é¢å’Œæ­Œè¯çš„åˆ‡æ¢å®¹å™¨ (ä¿æŒä¸å˜) */
#music-display-area {
    width: 192px;
    height: 192px;
    margin-bottom: 15px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.3s ease;
}
#music-display-area:active {
    transform: scale(0.98);
}

/* 9. æ­Œæ›²å°é¢ (ä¿æŒä¸å˜) */
#music-album-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: block;
}
#music-album-cover.rotating {
    animation: spin-record 10s linear infinite;
}
#music-album-cover.paused {
    animation-play-state: paused;
}

/* 10. å…¶ä»–æ ·å¼ (ä¿æŒä¸å˜) */
#music-lyrics-container { display: none; }
#music-display-area.show-lyrics #music-album-cover { display: none; }
#music-display-area.show-lyrics #music-lyrics-container { display: block; }
#music-player-song-title { margin-bottom: 2px; }
#music-player-artist { margin-bottom: 10px; }
.music-player-window { min-height: 480px; }

/* â–²â–²â–² å¸ƒå±€å¾®è°ƒç‰ˆæ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘æå‡æœç´¢ç›¸å…³å¼¹çª—çš„å±‚çº§ â–¼â–¼â–¼ */
#music-source-selector-modal,
#custom-modal-overlay {
    z-index: 250 !important; /* è¿™ä¸ªå€¼å¿…é¡»é«˜äºæ’­æ”¾åˆ—è¡¨(210)ï¼Œ!importantç¡®ä¿å®ƒæ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ */
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šæŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- 1. éšè—æ—§çš„ä¸»å±å¹•å…ƒç´  --- */
/* æˆ‘ä»¬ä¸å†éœ€è¦æ—§çš„é”å±æ—¶é’Ÿå’Œå›¾æ ‡ç½‘æ ¼äº†ï¼Œæ–°çš„å¸ƒå±€ä¼šå®Œå…¨å–ä»£å®ƒä»¬ */
#home-screen #clock-container,
#home-screen .app-grid {
    display: none !important;
}

/* --- 2. ã€æ ¸å¿ƒã€‘é‡æ–°å®šä¹‰ä¸»å±å¹•å¸ƒå±€ --- */
/* 
   è¿™å°†æŠŠä½ çš„ä¸»å±å¹•ä»ä¸€ä¸ªç®€å•çš„å‚ç›´åˆ—è¡¨ï¼Œå˜æˆä¸€ä¸ªæ’‘æ»¡å…¨å±ã€
   ä½¿ç”¨Flexboxå¸ƒå±€çš„å¼ºå¤§å®¹å™¨ï¼Œä¸ºæ–°çš„â€œæ¡Œé¢å¼â€å¸ƒå±€æ‰“ä¸‹åŸºç¡€ã€‚
*/
/* --- 2. ã€æ ¸å¿ƒã€‘é‡æ–°å®šä¹‰ä¸»å±å¹•å¸ƒå±€ --- */
#home-screen {
    /* ä½¿ç”¨ä¸€ä¸ªæ¼‚äº®çš„çº¿æ€§æ¸å˜ä½œä¸ºé»˜è®¤èƒŒæ™¯ï¼Œå½“ç„¶ä½ å¯ä»¥åœ¨â€œå¤–è§‚è®¾ç½®â€é‡Œéšæ—¶æ¢æ‰å®ƒ */
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    background-size: cover;
    background-position: center;
    
    /* é€‚é…iPhoneåˆ˜æµ·å’Œåº•éƒ¨å®‰å…¨åŒº */
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    
    /* â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼ */
    padding-left: 0;
    padding-right: 0;
    /* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

    /* ä½¿ç”¨Flexboxè®©å†…å®¹åŒºå’ŒDockæ ä¸Šä¸‹åˆ†ç¦» */
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%; /* ç¡®ä¿å®ƒæ’‘æ»¡å±å¹• */
}


/* --- 3. ä¸­é—´ä¸»è¦å†…å®¹åŒº (ä¸ªäººèµ„æ–™å¡ + å°ç»„ä»¶ + Appå›¾æ ‡) --- */
#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 30px; /* å¡ç‰‡å’Œä¸‹æ–¹å›¾æ ‡çš„é—´è· */
    align-items: center;
    margin-top: 20px; /* è·ç¦»å±å¹•é¡¶éƒ¨ä¸€ç‚¹è·ç¦» */
}

/* --- 4. ä¸ªäººèµ„æ–™å¡ç‰‡ (è¿™æ˜¯è§†è§‰æ ¸å¿ƒ) --- */

/* 4a. å¡ç‰‡å¤–å±‚å®¹å™¨ï¼šè¿™æ˜¯æ‰€æœ‰å†…éƒ¨å…ƒç´ å®šä½çš„â€œé”šç‚¹â€ */
#profile-widget {
    position: relative; /* å…³é”®ï¼šè®©å†…éƒ¨çš„å¤´åƒå’Œä¼ªå…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒè¿›è¡Œç»å¯¹å®šä½ */
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}

/* 4b. èƒŒæ™¯å¤´å›¾ï¼šåªç»™é¡¶éƒ¨è®¾ç½®åœ†è§’ */
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; /* åªç»™é¡¶éƒ¨è®¾ç½®åœ†è§’ */
    position: relative;
    z-index: 1; /* å±‚çº§1ï¼šåœ¨æœ€ä¸‹æ–¹ */
}

/* 4c. å¤´åƒå®¹å™¨ï¼šç²¾ç¡®å®šä½ï¼Œä½¿å…¶ä¸­å¿ƒçº¿ä¸å¤´å›¾åº•éƒ¨å¯¹é½ */
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; /* ä»é¡¶éƒ¨å‘ä¸‹åç§»ï¼Œè®©å®ƒä¸€åŠåœ¨å¤´å›¾ä¸Šï¼Œä¸€åŠåœ¨ä¸‹é¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; /* ç™½è‰²èƒŒæ™¯æ¿ï¼Œè®©å¤´åƒæ›´çªå‡º */
    padding: 4px; /* ç™½è‰²è¾¹æ¡†çš„æ•ˆæœ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; /* å±‚çº§3ï¼šæœ€é«˜å±‚ï¼Œå‹ä½ä¸€åˆ‡ */
}

#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 4d. ç™½è‰²ä¿¡æ¯å¡ç‰‡ï¼šä½¿ç”¨è´Ÿå¤–è¾¹è·å®ç°æ— ç¼æ‹¼æ¥ */
#profile-widget .profile-info {
  /* ã€ä¿®æ”¹åã€‘ç™½è‰²åˆ°é€æ˜çš„æ¸å˜èƒŒæ™¯ï¼Œå¹¶åŠ ä¸Šä¸€å±‚æŸ”å’Œçš„é˜´å½± */
background: linear-gradient(to bottom, rgba(255, 255, 255, 0.85) 20%, rgba(255, 255, 255, 0));
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-radius: 24px;
    
    /* æ ¸å¿ƒé­”æ³•ï¼šä½¿ç”¨è´Ÿå¤–è¾¹è·ï¼Œå°†å¡ç‰‡å‘ä¸Šç§»åŠ¨ï¼Œä¸å¤´å›¾å’Œå¤´åƒé‡å  */
    margin-top: -24px; 
    
    /* åŒæ—¶ï¼Œä¸ºä¸Šç§»çš„å¤´åƒç•™å‡ºç²¾ç¡®çš„ç©ºé—´ï¼Œé¿å…æ–‡å­—å‹ä½å¤´åƒ */
    padding-top: 54px; /* å¤´åƒåŠå¾„(40px) + é¢å¤–é—´è·(14px) */
    
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; /* å±‚çº§2ï¼šåœ¨å¤´å›¾ä¹‹ä¸Šï¼Œä½†åœ¨å¤´åƒä¹‹ä¸‹ */
}

/* 4e. ä¸ªäººèµ„æ–™å†…éƒ¨çš„æ–‡å­—æ ·å¼ */
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}

/* --- 5. æ¡Œé¢å¼å¸ƒå±€ (å°ç»„ä»¶ + Appå›¾æ ‡) --- */
#desktop-layout {
    display: grid; /* ä½¿ç”¨Gridå¸ƒå±€ï¼Œè½»æ¾å®ç°ä¸¤åˆ— */
    grid-template-columns: 1fr 1.1fr; /* å·¦çª„å³å®½çš„ä¸¤åˆ— */
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: row;
    justify-content: space-between; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°† space-around æ”¹ä¸º space-between */
    align-items: start;
    width: 100%;
}

/* å³ä¾§Appå›¾æ ‡å®¹å™¨ */
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* ä¸¤åˆ—å›¾æ ‡ */
    gap: 25px;
    align-content: start;
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img { width: 100%; height: 100%; object-fit: cover; border-radius: 0; }
.desktop-app-icon .label { color: #333; font-size: 13px; font-weight: 500; }
.desktop-app-icon:active .icon-bg-desktop { transform: scale(0.9); }


/* --- 6. åº•éƒ¨ Dock æ  --- */
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15); /* ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content; /* å®½åº¦è‡ªé€‚åº”å†…å®¹ */
    flex-shrink: 0;
}

/* --- 7. ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ä¸ºå¯ç¼–è¾‘å…ƒç´ æ·»åŠ è§†è§‰åé¦ˆ --- */
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* é¼ æ ‡æ‚¬åœæ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªåŠé€æ˜çš„è™šçº¿å¤–æ¡†ï¼Œå¹¶è½»å¾®å˜æš—ï¼Œæç¤ºç”¨æˆ·è¿™é‡Œå¯ä»¥ç‚¹ */
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(0, 0, 0, 0.4);
    opacity: 0.85;
    border-radius: 4px; /* è®©å¤–æ¡†ä¹Ÿæœ‰ä¸€ç‚¹åœ†è§’ */
}

/* --- 8. ã€é”å±å…¼å®¹ã€‘è®©é”å±å’Œä¸»å±å¹•å¯ä»¥å †å  --- */
#lock-screen, #home-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#lock-screen {
    z-index: 999; /* ç¡®ä¿é”å±åœ¨æœ€ä¸Šå±‚ */
}
/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ¡Œé¢å°ç»„ä»¶æ ·å¼ â–¼â–¼â–¼ */

/* å•ä¸ªå°ç»„ä»¶çš„æ€»å®¹å™¨ */
.custom-widget-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; /* å„ä¸ªå…ƒç´ ä¹‹é—´çš„å‚ç›´é—´è· */
}

.widget-bubble {
    position: relative;
    background-color: rgba(255, 255, 255, 0.9);
    color: #333;
    padding: 8px 12px;
    border-radius: 20px; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ åœ†è§’ï¼Œå®ç°èƒ¶å›Šæ„Ÿ */
    font-size: 13px;
    font-weight: 500;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤ min-widthï¼Œè®©å®½åº¦è‡ªé€‚åº”å†…å®¹ */
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}


/* ç”¨ä¼ªå…ƒç´ ç»™æ°”æ³¡åŠ ä¸€ä¸ªå°å°¾å·´ï¼ŒæŒ‡å‘ä¸‹é¢çš„åœ†å½¢å›¾ç‰‡ */
.widget-bubble::after {
    content: '';
    position: absolute;
    bottom: -6px; /* å°¾å·´åœ¨æ°”æ³¡ä¸‹æ–¹ */
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px 6px 0;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.9) transparent transparent transparent;
}

.widget-circle-uploader {
    width: 65px; /* ä» 80px ç¼©å° */
    height: 65px; /* ä» 80px ç¼©å° */
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    padding: 3px;
    background-color: transparent; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†èƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜ */ 
    box-sizing: border-box;
}


/* è¿™æ˜¯æ›¿æ¢åçš„ç¬¬äºŒå— */
.widget-circle-uploader img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%; /* ã€æ ¸å¿ƒã€‘è®©å›¾ç‰‡ä¹Ÿå˜æˆåœ†å½¢ï¼Œå®Œç¾é€‚åº”å†…è¾¹è· */
}


/* ä¸‹æ–¹çš„é€æ˜æ–‡å­—åŒºåŸŸ */
.widget-subtext {
    background: transparent;
    border: none;
    color:  #333;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); /* åŠ ä¸€ç‚¹æ–‡å­—é˜´å½±æ›´æ¸…æ™° */
    font-size: 13px;
    font-weight: 500;
    text-align: center;
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€V3æœ€ç»ˆç¾åŒ–ç‰ˆã€‘ä¸»å±å¹•ç¾åŒ–é¢„è®¾åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
.preset-manager-container {
    width: 100%;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-manager-container {
    border-top-color: #3a3a3c;
}
.preset-manager-container .form-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.preset-manager-controls {
    display: grid;
    grid-template-columns: 1fr 1fr; /* ã€æ ¸å¿ƒã€‘2x2 ç½‘æ ¼å¸ƒå±€ */
    gap: 12px; /* æŒ‰é’®é—´è· */
    width: 100%;
}
.preset-btn-capsule {
    padding: 12px 15px; /* å¢åŠ å‚ç›´å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´é«˜æ›´å¯çˆ± */
    border: none;
    border-radius: 25px; /* æ›´å¤§çš„åœ†è§’ï¼Œèƒ¶å›Šæ„Ÿæ›´å¼º */
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08); /* å¢åŠ ä¸€ç‚¹ç«‹ä½“é˜´å½± */
}
.preset-btn-capsule:active {
    transform: scale(0.96);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.preset-btn-capsule:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    box-shadow: none;
    background-color: #e9ecef !important; /* ç¦ç”¨æ—¶ç»Ÿä¸€ç”¨ç°è‰² */
    color: #adb5bd !important;
    border-color: #dee2e6 !important;
}
#phone-screen.dark-mode .preset-btn-capsule:disabled {
    background-color: #3a3a3c !important;
    color: #545458 !important;
}
.preset-btn-apply {
    background-color: var(--accent-color); /* åº”ç”¨æŒ‰é’®ä½¿ç”¨ä¸»é¢˜è‰² */
    color: white;
    grid-column: 1 / -1; /* ã€æ ¸å¿ƒã€‘è®©åº”ç”¨æŒ‰é’®ç‹¬å ä¸€è¡Œï¼Œæ›´çªå‡º */
}
.preset-btn-save {
    background-color: #4cd964; /* ä¿å­˜ç”¨ç»¿è‰²ï¼Œä»£è¡¨åˆ›å»º */
    color: white;
}
.preset-btn-secondary {
    background-color: #f8f9fa;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .preset-btn-secondary {
    background-color: #3a3a3c;
    border-color: #545458;
}
.preset-btn-delete {
    background-color: #ffdde5;
    color: #ff3b30;
}
#phone-screen.dark-mode .preset-btn-delete {
    background-color: #5c2b2b;
    color: #ff8a80;
}
/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€V6æœ€ç»ˆä¿®å¤ç‰ˆã€‘å¤œé—´æ¨¡å¼ç»ˆæé€‚é… (å·²ä¿®å¤æ‰€æœ‰é¡µé¢é€‚é…é—®é¢˜) â–¼â–¼â–¼ */

/* æ ¸å¿ƒï¼šå½“ #phone-screen æ‹¥æœ‰ .dark-mode ç±»æ—¶ï¼Œæ¿€æ´»ä»¥ä¸‹æ‰€æœ‰æ ·å¼ */

/* 1. å…¨å±€é‡æ–°å®šä¹‰é¢œè‰²å˜é‡ */
#phone-screen.dark-mode {
  --secondary-bg: #1c1c1e;
  --border-color: #38383a;
  --text-primary: #ffffff;
  --text-secondary: #8e8e93;
  --status-bar-text-color: #ffffff;
}

/* 2. ã€åŸºç¡€ã€‘ä¸ºæ‰€æœ‰å±å¹•å’Œä¸»è¦å®¹å™¨è®¾ç½®åŸºç¡€æ·±è‰²èƒŒæ™¯ */
#phone-screen.dark-mode,
#phone-screen.dark-mode .screen,
#phone-screen.dark-mode #chat-list,
#phone-screen.dark-mode #world-book-list,
#phone-screen.dark-mode .list-container,
#phone-screen.dark-mode .form-container,
#phone-screen.dark-mode #chat-messages {
    background-color: #000000 !important;
}

/* 3. ã€ä¸»å±å¹•ã€‘ä¸“å±æ ·å¼ (ä»è¢«åˆ é™¤çš„ä»£ç ä¸­æ¢å¤å¹¶æ•´åˆ) */
#phone-screen.dark-mode #home-screen {
    background: #111827; /* æ·±è“è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #desktop-dock {
    background-color: rgba(55, 65, 81, 0.5); /* Dockæ æ·±ç°è‰²ç»ç’ƒæ•ˆæœ */
}
#phone-screen.dark-mode .desktop-app-icon .label,
#phone-screen.dark-mode .widget-subtext {
    color: #e5e7eb; /* æ¡Œé¢æ–‡å­—å˜ä¸ºæµ…ç°è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.7); /* åŠ å¼ºé˜´å½± */
}
#phone-screen.dark-mode #profile-widget .profile-info {
    background: linear-gradient(to bottom, rgba(28, 28, 30, 0.85) 20%, rgba(28, 28, 30, 0)); /* ä¿¡æ¯å¡ç‰‡æ·±ç°è‰²æ¸å˜ */
    color: #f9fafb;
}
#phone-screen.dark-mode #profile-username,
#phone-screen.dark-mode #profile-bio,
#phone-screen.dark-mode #profile-location span {
    color: #f9fafb; /* ä¿¡æ¯å¡ç‰‡ä¸»æ–‡å­—ç™½è‰² */
}
#phone-screen.dark-mode #profile-sub-username,
#phone-screen.dark-mode #profile-location {
    color: #9ca3af; /* ä¿¡æ¯å¡ç‰‡æ¬¡è¦æ–‡å­—ç°è‰² */
}
#phone-screen.dark-mode #profile-location {
    background-color: rgba(255,255,255,0.1); /* åœ°ç‚¹èƒŒæ™¯å˜äº® */
}
#phone-screen.dark-mode .widget-bubble {
    background-color: rgba(55, 65, 81, 0.9); /* å°ç»„ä»¶æ°”æ³¡æ·±ç°è‰² */
    color: #e5e7eb; /* å°ç»„ä»¶æ–‡å­—æµ…ç°è‰² */
}
#phone-screen.dark-mode .widget-bubble::after {
    border-top-color: rgba(55, 65, 81, 0.9); /* å°å°¾å·´é¢œè‰²åŒæ­¥ */
}

/* 4. ã€ä¿®å¤ã€‘é€‚é…æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨Header */
#phone-screen.dark-mode .header,
#phone-screen.dark-mode .qzone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important; 
}

/* 5. ã€ä¿®å¤ã€‘é€‚é…æ‰€æœ‰é€šç”¨ç»„ä»¶ (å¼¹çª—ã€è¾“å…¥æ¡†ç­‰) */
#phone-screen.dark-mode #chat-input-area,
#phone-screen.dark-mode #chat-list-bottom-nav {
    background-color: rgba(28, 28, 30, 0.85);
    border-top-color: var(--border-color);
}
#phone-screen.dark-mode #chat-input {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
}
#phone-screen.dark-mode .modal-content,
#phone-screen.dark-mode #custom-modal {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .modal-header, 
#phone-screen.dark-mode .modal-footer,
#phone-screen.dark-mode .custom-modal-footer {
    border-color: var(--border-color);
}
#phone-screen.dark-mode .form-group input,
#phone-screen.dark-mode .form-group select,
#phone-screen.dark-mode .form-group textarea {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
}
#phone-screen.dark-mode .list-item,
#phone-screen.dark-mode .chat-list-item-swipe-container:not(:last-child) {
    border-bottom-color: var(--border-color);
}
#phone-screen.dark-mode .list-item:hover,
#phone-screen.dark-mode .chat-list-item:hover {
    background-color: #2c2c2e;
}

/* 6. ã€è§£å†³ã€‘å­—ä½“é¢„è®¾ & å¤–è§‚è®¾ç½®é¡µé¢æ·±åº¦é€‚é… */
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #wallpaper-screen {
    background-color: #000000;
}
#phone-screen.dark-mode .font-preset-slot,
#phone-screen.dark-mode #font-preview,
#phone-screen.dark-mode #wallpaper-preview {
    background-color: var(--secondary-bg);
    border-color: var(--border-color);
}
#phone-screen.dark-mode .preset-btn.secondary {
    background-color: #3e3e42;
    border-color: #545458;
}

/* 7. ã€è§£å†³ã€‘â€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½æ‰€æœ‰å†…éƒ¨é¡µé¢æ·±åº¦é€‚é… */
#phone-screen.dark-mode #character-phone-container {
    background-color: #000000;
}
#phone-screen.dark-mode .character-phone-frame {
    background-color: #111;
}
#phone-screen.dark-mode .character-phone-inner-screen,
#phone-screen.dark-mode .character-phone-page {
    background-color: #000000;
}
#phone-screen.dark-mode .character-phone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom: 1px solid #38383a !important;
}
#phone-screen.dark-mode #character-app-grid .label {
    color: #e5e7eb;
}
#phone-screen.dark-mode .character-chat-list .chat-list-item:hover {
    background-color: #1c1c1e;
}
#phone-screen.dark-mode #character-chat-history-messages {
    background-color: #0e0e0e !important;
}
#phone-screen.dark-mode .character-chat-bubble.received {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .character-data-item,
#phone-screen.dark-mode .character-bank-transaction,
#phone-screen.dark-mode .character-cart-item,
#phone-screen.dark-mode .character-browser-item {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode .character-data-item .title,
#phone-screen.dark-mode .character-data-item .content,
#phone-screen.dark-mode .cart-item-price {
    color: var(--text-primary);
}
#phone-screen.dark-mode .character-bank-balance-card {
    background: linear-gradient(135deg, #3a3a3c, #1c1c1e);
}
#phone-screen.dark-mode #character-diary-list .character-data-item {
    background-color: #1a1510;
    border-color: #4a443b;
    border-left-color: #8c7d6b;
}
#phone-screen.dark-mode #character-select-item .name {
    color: #80CBC4 !important; /* æŸ”å’Œçš„é’è‰² */
}

/* 8. ã€æ–°å¢ã€‘ä¿®å¤èŠå¤©åˆ—è¡¨åˆ†ç»„æ ‡é¢˜çš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode .chat-group-header {
    background-color: #1c1c1e;
}
#phone-screen.dark-mode .chat-list-item-content.pinned {
    background-color: #3a3a3c;
}

/* â–²â–²â–² CSS ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 1.1ï¼šå°†è¿™æ•´å—ã€ç»ˆæä¿®å¤ç‰ˆã€‘CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ !important å¼ºåˆ¶æå‡ä¼˜å…ˆçº§ï¼Œè¦†ç›–æ‰æ‰€æœ‰æ£ä¹±çš„å†…è”æ ·å¼ */

/* 1. ä¸ºæ‰€æœ‰éœ€è¦é€‚é…çš„å±å¹•å¼ºåˆ¶è®¾ç½®çº¯é»‘èƒŒæ™¯ */
#phone-screen.dark-mode #wallpaper-screen,
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #api-settings-screen,
#phone-screen.dark-mode #character-selection-screen,
#phone-screen.dark-mode #world-book-screen,
#phone-screen.dark-mode #world-book-editor-screen,
#phone-screen.dark-mode .form-container, /* ç¡®ä¿æ‰€æœ‰è¡¨å•å®¹å™¨ä¹Ÿé€‚é… */
#phone-screen.dark-mode .list-container { /* ç¡®ä¿æ‰€æœ‰åˆ—è¡¨å®¹å™¨ä¹Ÿé€‚é… */
    background-color: #000000 !important;
}

/* 2. ä¸ºâ€œæŸ¥æ‰‹æœºâ€å†…éƒ¨çš„æ‰€æœ‰é¡µé¢å¼ºåˆ¶è®¾ç½®çº¯é»‘èƒŒæ™¯ */
#phone-screen.dark-mode .character-phone-inner-screen,
#phone-screen.dark-mode .character-phone-page {
    background-color: #000000 !important;
}
#phone-screen.dark-mode #character-chat-history-messages {
    background-color: #0e0e0e !important; /* èŠå¤©è®°å½•ç”¨æ·±ç°è‰² */
}

/* 3. ä¿®å¤é¡µé¢å†…éƒ¨ç»„ä»¶çš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode #font-preview,
#phone-screen.dark-mode #wallpaper-preview {
    background-color: #1c1c1e !important;
    border-color: #38383a !important;
}

/* 4. ä¿®å¤â€œæŸ¥æ‰‹æœºâ€é‡Œå¯¹æ–¹çš„èŠå¤©æ°”æ³¡é¢œè‰² */
#phone-screen.dark-mode .character-chat-bubble.received {
    background-color: #2c2c2e !important;
}
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘æå‡æ‰€æœ‰å¼¹çª—çš„å±‚çº§ â–¼â–¼â–¼ */
#music-source-selector-modal,
#music-search-results-modal {
    z-index: 250 !important; /* è¿™ä¸ªå€¼é«˜äºæ’­æ”¾åˆ—è¡¨(210)ï¼Œ!importantç¡®ä¿å®ƒæ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ */
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘é€šç”¨æ“ä½œèœå•æŒ‰é’® */
#preset-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none; /* ç§»é™¤è¾¹æ¡† */
    border-radius: 20px; /* â˜…â˜…â˜… ä¿®æ”¹è¿™é‡Œï¼æŠŠ 12px æ”¹æˆäº† 20px â˜…â˜…â˜… */
    padding: 14px;
    font-size: 16px; /* å­—ä½“ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
    font-weight: 500;
    margin-bottom: 8px; /* æŒ‰é’®ä¹‹é—´çš„å‚ç›´é—´è· */
    background-color: #f0f0f0; /* ç»Ÿä¸€çš„æµ…ç°è‰²èƒŒæ™¯ */
    color: var(--text-primary);
    transition: background-color 0.2s, transform 0.1s; /* æ·»åŠ åŠ¨ç”» */
}

/* é¼ æ ‡æ‚¬åœå’Œç‚¹å‡»æ•ˆæœ */
#preset-actions-modal .custom-modal-footer button:hover {
    background-color: #e0e0e0;
}
#preset-actions-modal .custom-modal-footer button:active {
    transform: scale(0.98); /* ç‚¹å‡»æ—¶è½»å¾®ç¼©å° */
}

/* å•ç‹¬ç¾åŒ–â€œåˆ é™¤â€æŒ‰é’® */
#preset-actions-modal .custom-modal-footer button.btn-danger {
    background-color: #ffe5e5;
    color: #ff3b30;
}
#preset-actions-modal .custom-modal-footer button.btn-danger:hover {
    background-color: #ffcccc;
}

/* ç¾åŒ–â€œå–æ¶ˆâ€æŒ‰é’® */
#preset-actions-modal .custom-modal-footer button:last-child {
    background-color: #e9ecef;
    margin-top: 4px; /* å’Œä¸Šé¢çš„æŒ‰é’®ç¨å¾®æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}
#preset-actions-modal .custom-modal-footer button:last-child:hover {
    background-color: #dcdfe3;
}

/* ç§»é™¤æŒ‰é’®ä¹‹é—´çš„åˆ†å‰²çº¿ */
#preset-actions-modal .custom-modal-footer button {
    border-bottom: none !important;
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒä¿®æ­£ã€‘æå‡é€šç”¨æ“ä½œèœå•çš„å±‚çº§ï¼Œç¡®ä¿å®ƒèƒ½è¦†ç›–æ’­æ”¾åˆ—è¡¨ */
#preset-actions-modal {
    z-index: 220; /* è¿™ä¸ªå€¼æ¯”æ’­æ”¾åˆ—è¡¨(210)æ›´é«˜ï¼Œå°±ä¸ä¼šè¢«æŒ¡ä½äº† */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œæŸ¥æ‰‹æœºâ€å†…å®¹æ·»åŠ çš„åˆ é™¤æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.character-data-item, .character-cart-item, .character-browser-item, .character-bank-transaction, .character-trajectory-item, .character-app-usage-item, .character-album-item {
    position: relative; /* è®©åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    padding-right: 35px; /* åœ¨å³è¾¹ç»™åˆ é™¤æŒ‰é’®ç•™å‡ºä½ç½® */
}

.item-delete-btn {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    background-color: #f0f0f0;
    color: #888;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.item-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå¾®ä¿¡æ¶ˆæ¯åˆ é™¤æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.character-chat-bubble-container {
    position: relative; /* è®©åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
}

.message-delete-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #555;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
}

.character-chat-bubble-container:hover .message-delete-btn {
    opacity: 1; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */
}

.message-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}

/* æ ¹æ®æ¶ˆæ¯æ˜¯å·¦æ˜¯å³ï¼Œè°ƒæ•´åˆ é™¤æŒ‰é’®çš„ä½ç½® */
.character-chat-bubble-container.sent .message-delete-btn {
    left: -28px;
}
.character-chat-bubble-container.received .message-delete-btn {
    right: -28px;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² CSS ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘å¼ºåˆ¶ä¿®æ­£æ‰€æœ‰è®¾ç½®é¡µé¢çš„åº•éƒ¨å®‰å…¨åŒº â–¼â–¼â–¼ */
#font-settings-screen .form-container,
#wallpaper-screen .form-container,
#api-settings-screen .form-container,
#css-editor-screen .form-container {
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘iOSé£æ ¼çš„æ»‘åŠ¨å¼€å…³æ ·å¼ â–¼â–¼â–¼ */

.toggle-switch-label {
    display: flex;
    align-items: center;
    justify-content: space-between; /* è®©æ–‡å­—å’Œå¼€å…³ä¸¤ç«¯å¯¹é½ */
    cursor: pointer;
    user-select: none;
    width: 100%;
    padding: 10px 0; /* å¢åŠ ä¸€ç‚¹ä¸Šä¸‹é—´è· */
}

.toggle-switch-text {
    font-weight: 500;
    color: var(--text-primary);
}

/* éšè—åŸå§‹çš„ checkbox */
.toggle-switch-label input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

/* å¼€å…³çš„è½¨é“ */
.toggle-switch-slider {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
    background-color: #e9e9eb;
    border-radius: 34px;
    transition: background-color 0.2s;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* å¼€å…³çš„æ»‘å— (é‚£ä¸ªç™½è‰²åœ†ç‚¹) */
.toggle-switch-slider::before {
    content: "";
    position: absolute;
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

/* å½“ checkbox è¢«é€‰ä¸­æ—¶ï¼Œæ”¹å˜è½¨é“çš„é¢œè‰² */
.toggle-switch-label input:checked + .toggle-switch-slider {
    background-color: #34c759; /* iOS é£æ ¼çš„ç»¿è‰² */
}

/* å½“ checkbox è¢«é€‰ä¸­æ—¶ï¼Œç§»åŠ¨æ»‘å— */
.toggle-switch-label input:checked + .toggle-switch-slider::before {
    transform: translateX(20px);
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºä½ æ–°å¢çš„é¢œè‰²æ ·å¼ â–¼â–¼â–¼ */

/* 1. æŠŠæ—¶é—´çš„é¢œè‰²å¼ºåˆ¶è®¾ç½®ä¸ºé»‘è‰² */
#status-bar-time {
    color: #000000 !important; /* !important ç¡®ä¿å®ƒä¼˜å…ˆçº§æœ€é«˜ */
}

/* 2. æŠŠç”µæ± å®¹å™¨å†…çš„æ‰€æœ‰ä¸œè¥¿ï¼ˆå›¾æ ‡è¾¹æ¡†ã€ç”µé‡æ¡ã€ç™¾åˆ†æ¯”æ–‡å­—ï¼‰éƒ½è®¾ç½®ä¸ºç»¿è‰² */
#status-bar-battery {
    color: #4CAF50 !important; /* è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çœ‹çš„ç»¿è‰² */
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯æ­¥éª¤1éœ€è¦ç²˜è´´çš„æ–°æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ¯ä¸€æ¡è¯„è®ºéƒ½å˜æˆå¯ç‚¹å‡»çš„ */
.comment-item {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå°æ‰‹å½¢çŠ¶ */
    transition: background-color 0.2s; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„èƒŒæ™¯è‰²è¿‡æ¸¡åŠ¨ç”» */
    border-radius: 4px; /* ç»™ä¸€ç‚¹ç‚¹åœ†è§’ï¼Œæ›´å¥½çœ‹ */
    padding: 2px 5px; /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·ï¼Œè®©ç‚¹å‡»åŒºåŸŸæ›´å¤§ */
    margin: 0 -5px; /* æŠŠä¸Šé¢çš„å†…è¾¹è·æŠµæ¶ˆæ‰ï¼Œä¿æŒå¯¹é½ */
}
.comment-item:hover {
    background-color: #f0f2f5; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶ï¼Œç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
}
#phone-screen.dark-mode .comment-item:hover {
    background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœé¢œè‰² */
}

/* â€œå›å¤â€è¿™ä¸¤ä¸ªå­—çš„æ ·å¼ */
.comment-item .reply-text {
    color: var(--text-secondary);
    margin: 0 4px; /* å’Œä¸¤è¾¹çš„åå­—æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

/* è¢«å›å¤è€…çš„åå­—æ ·å¼ */
.comment-item .reply-target-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®°å½•æœç´¢åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* æœç´¢ç»“æœåˆ—è¡¨ */
#chat-search-results-list {
    flex-grow: 1; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
    overflow-y: auto; /* å†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
}

/* å•æ¡æœç´¢ç»“æœçš„æ ·å¼ */
.search-result-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    gap: 12px; /* å¤´åƒå’Œå†…å®¹çš„é—´è· */
    align-items: flex-start;
}
.search-result-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: #2c2c2e;
}

/* ç»“æœä¸­çš„å¤´åƒ */
.search-result-item .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* ç»“æœå³ä¾§ä¿¡æ¯ï¼ˆåå­—ã€æ—¶é—´ã€å†…å®¹ï¼‰ */
.search-result-info {
    display: flex;
    flex-direction: column;
    gap: 4px; /* ä¿¡æ¯å†…éƒ¨çš„å‚ç›´é—´è· */
    overflow: hidden; /* é˜²æ­¢å†…å®¹è¿‡é•¿æº¢å‡º */
}

/* åå­—å’Œæ—¶é—´çš„å®¹å™¨ */
.search-result-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.search-result-meta .name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

/* æ¶ˆæ¯å†…å®¹ */
.search-result-content {
    font-size: 14px;
    line-height: 1.5;
    word-break: break-all; /* ç¡®ä¿é•¿æ–‡æœ¬èƒ½æ¢è¡Œ */
}

/* ã€æ ¸å¿ƒã€‘å…³é”®è¯é«˜äº®æ ·å¼ */
.highlight {
    background-color: #FFDE5C; /* äº®é»„è‰²èƒŒæ™¯ */
    color: #5D4037; /* æ·±æ£•è‰²æ–‡å­—ï¼Œå¯¹æ¯”æ›´æ¸…æ™° */
    font-weight: bold;
    padding: 1px 3px;
    border-radius: 3px;
}

/* è·³è½¬åæ¶ˆæ¯çš„é—ªçƒåŠ¨ç”» */
@keyframes flash-highlight {
    0% { background-color: transparent; }
    25% { background-color: rgba(255, 222, 92, 0.7); }
    100% { background-color: transparent; }
}
.message-bubble.flash {
    animation: flash-highlight 1.5s ease-out;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘è§£å†³æœç´¢ç»“æœçœ‹ä¸è§çš„é—®é¢˜ â–¼â–¼â–¼ */
#chat-search-screen .form-container {
    padding-bottom: 20px; /* ç»™åº•éƒ¨ä¸€ç‚¹ç©ºé—´ */
}

#search-results-list {
    flex-grow: 1; /* æ ¸å¿ƒï¼šè®©ç»“æœåˆ—è¡¨å æ®æ‰€æœ‰å‰©ä½™çš„å‚ç›´ç©ºé—´ */
    overflow-y: auto; /* æ ¸å¿ƒï¼šå¦‚æœç»“æœå¤ªå¤šï¼Œè®©å®ƒè‡ªå·±å‡ºç°æ»šåŠ¨æ¡ */
    min-height: 0; /* ä¸€ä¸ªç¥å¥‡çš„CSSå±æ€§ï¼Œç”¨äºè§£å†³flexå¸ƒå±€ä¸‹çš„æº¢å‡ºé—®é¢˜ */
    border-top: 1px solid var(--border-color); /* åœ¨ç»“æœå’ŒæŒ‰é’®ä¹‹é—´åŠ ä¸€æ¡åˆ†å‰²çº¿ï¼Œæ›´ç¾è§‚ */
    margin-top: 15px; /* å’Œä¸Šé¢çš„æŒ‰é’®æ‹‰å¼€è·ç¦» */
    padding-top: 10px; /* åˆ—è¡¨é¡¶éƒ¨çš„å†…è¾¹è· */
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ç»Ÿä¸€æ ·å¼ï¼Œè®©å›¾æ ‡å’Œæ–‡å­—æŒ‰é’®å¯¹é½ */
#music-playlist-panel .playlist-header .panel-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„åƒåœ¾æ¡¶æ ·å¼ â–¼â–¼â–¼ */

/* è®¾ç½®åƒåœ¾æ¡¶å›¾æ ‡çš„é»˜è®¤æ ·å¼ */
#delete-expired-songs-btn svg {
    color: inherit; /* æ ¸å¿ƒä¿®æ”¹1: å¹³æ—¶é¢œè‰²ç»§æ‰¿çˆ¶å…ƒç´ ï¼Œå’Œ"æœ¬åœ°"ç­‰æ–‡å­—é¢œè‰²ä¸€æ ·ï¼Œä¿æŒä½è°ƒ */
    transition: color 0.2s, transform 0.2s; /* æ·»åŠ transformè¿‡æ¸¡æ•ˆæœ */
    transform: translateY(3px); /* æ ¸å¿ƒä¿®æ”¹2: è®©å›¾æ ‡æ•´ä½“ä¸‹ç§»3åƒç´ ï¼Œè§†è§‰ä¸Šæ›´å¯¹é½ */
}

/* è®¾ç½®é¼ æ ‡æ‚¬åœ/ç‚¹å‡»æ—¶çš„æ ·å¼ */
#delete-expired-songs-btn:hover svg,
#delete-expired-songs-btn:active svg {
    color: #ff3b30; /* æ ¸å¿ƒä¿®æ”¹3: é¼ æ ‡æ”¾ä¸Šå»æˆ–ç‚¹å‡»æ—¶ï¼Œæ‰å˜ä¸ºé†’ç›®çš„çº¢è‰² */
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒã€‘ä¸“é—¨ä¸ºè§’è‰²æ‰‹æœºé‡Œçš„æ—¥è®°åˆ é™¤æŒ‰é’®ï¼Œé‡æ–°å®šä¹‰ä½ç½® */
#character-diary-list .character-data-item .item-delete-btn {
    top: auto;         /* è§£é™¤é¡¶éƒ¨çš„å®šä½ */
    right: auto;       /* è§£é™¤å³ä¾§çš„å®šä½ */
    bottom: 8px;       /* å®šä½åˆ°è·ç¦»åº•éƒ¨8åƒç´  */
    left: 8px;         /* å®šä½åˆ°è·ç¦»å·¦ä¾§8åƒç´  */
    opacity: 0;        /* ä¿æŒé»˜è®¤éšè— */
    transition: opacity 0.2s ease; /* ä¿æŒæ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
}

/* ã€ç¾åŒ–ã€‘é¼ æ ‡æ‚¬åœåœ¨æ•´å¼ æ—¥è®°å¡ç‰‡ä¸Šæ—¶ï¼Œæ‰æ˜¾ç¤ºè¿™ä¸ªæŒ‰é’® */
#character-diary-list .character-data-item:hover .item-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è·³åŠ¨çš„å¿ƒåŠ¨ç”» */
@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
#char-heart-btn svg {
    animation: heartbeat 1.5s infinite ease-in-out;
}

/* 2. å¿ƒå£°é¢æ¿ä¸»å†…å®¹æ ·å¼ (å·²ä¿®å¤) */
#inner-voice-avatar-wrapper::after {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 1.5px solid transparent; /* é»˜è®¤æ˜¯é€æ˜è¾¹æ¡†ï¼Œçœ‹ä¸è§ */
    border-radius: 50%;
    pointer-events: none;
    transition: border-color 0.2s ease-in-out; /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
}
/* ã€æ ¸å¿ƒã€‘ä»…å½“æ²¡æœ‰å¤´åƒæ¡†æ—¶(.has-border)ï¼Œæ‰æ˜¾ç¤ºçº¢çº¿ */
#inner-voice-avatar-wrapper.has-border::after {
    border-color: #ff8a80; /* ä½ æƒ³è¦çš„çº¢è‰²è½®å»“çº¿ */
}

#inner-voice-content-area p {
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦å’Œç©ºæ ¼ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
}

/* 3. å†å²è®°å½•é¢æ¿æ ·å¼ */
.inner-voice-history-item {
    background-color: #fff;
    margin: 10px;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.history-item-timestamp {
    font-size: 11px;
    color: #999;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 8px;
}
.history-item-content p {
    margin: 0 0 8px 0;
    font-size: 13px;
    line-height: 1.5;
    color: #444;
}
.history-item-content strong {
    font-size: 12px;
}
/* â–²â–²â–² å¿ƒå£°åŠŸèƒ½æ ·å¼ç»“æŸ â–²â–²â–² */
/* ã€å…¨æ–°ã€‘å¿ƒå£°å†å²è®°å½•å•æ¡åˆ é™¤æŒ‰é’®æ ·å¼ */
.inner-voice-history-item {
    position: relative; /* è®©åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
}

.history-item-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #888;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    transition: all 0.2s ease;
}

.history-item-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–¼â–¼â–¼ åœ¨è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼šã€ä¸»é¢˜è‰²ç‰ˆã€‘å¯çˆ±åœ†æ¶¦æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. å†æ¬¡è®¾ç½®é€šç”¨çš„â€œå¯çˆ±åŸºç¡€â€ --- */
#save-theme-btn,
#save-as-new-theme-btn,
#export-theme-btn,
#import-theme-btn,
#rename-theme-btn,
#delete-theme-btn {
    border: none;
    border-radius: 25px; /* å¯çˆ±çš„èƒ¶å›Šå½¢çŠ¶ */
    padding: 12px 18px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease-in-out;
    margin-top: 5px !important;
}

/* --- 2. å¯çˆ±çš„â€œæŒ‰ä¸‹â€æ•ˆæœ --- */
#save-theme-btn:active,
#save-as-new-theme-btn:active,
#export-theme-btn:active,
#import-theme-btn:active,
#rename-theme-btn:active,
#delete-theme-btn:active {
    transform: scale(0.97);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* --- 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºä¸åŒåŠŸèƒ½çš„æŒ‰é’®è®¾ç½®é…å¥—é¢œè‰² --- */

/* â€œä¿å­˜â€ å’Œ â€œå¦å­˜ä¸ºâ€ï¼šä½¿ç”¨å…¨å±€ä¸»é¢˜è‰²ï¼ */
#save-theme-btn,
#save-as-new-theme-btn {
    background-color: var(--accent-color); /* è¿™å°±æ˜¯ä½ çš„ä¸»é¢˜è‰²ï¼ */
    color: white;
}

/* â€œå¯¼å‡ºâ€ã€â€œå¯¼å…¥â€ã€â€œé‡å‘½åâ€ï¼šä½¿ç”¨æŸ”å’Œçš„æ¬¡è¦æ ·å¼ */
#export-theme-btn,
#import-theme-btn,
#rename-theme-btn {
    background-color: #f0f2f5;           /* æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
    color: var(--accent-color);          /* æ–‡å­—ä½¿ç”¨ä¸»é¢˜è‰² */
    border: 1px solid var(--accent-color); /* å†åŠ ä¸€ä¸ªä¸»é¢˜è‰²çš„è¾¹æ¡†ï¼Œæ›´ç²¾è‡´ */
}

/* â€œåˆ é™¤â€æŒ‰é’®ï¼šè¿˜æ˜¯ç”¨å¯çˆ±çš„ç²‰çº¢è‰²æ¥æé†’ï¼Œé˜²æ­¢è¯¯è§¦ */
#delete-theme-btn {
    background-color: #ffdde5; /* æ·¡æ·¡çš„æ¨±èŠ±ç²‰èƒŒæ™¯ */
    color: #ff3b30;           /* æ–‡å­—ç”¨é†’ç›®çš„çº¢è‰² */
    border: 1px solid #ffc2d1;
}

/* --- 4. é¼ æ ‡æ”¾åˆ°ä¸åŒæŒ‰é’®ä¸Šæ—¶çš„é¢œè‰²å˜åŒ– --- */
#save-theme-btn:hover,
#save-as-new-theme-btn:hover {
    opacity: 0.85; /* ä¸»é¢˜è‰²æŒ‰é’®å˜æ·¡ä¸€ç‚¹ç‚¹ */
}

#export-theme-btn:hover,
#import-theme-btn:hover,
#rename-theme-btn:hover {
    background-color: #e9ecef; /* æ¬¡è¦æŒ‰é’®èƒŒæ™¯åŠ æ·±ä¸€ç‚¹ç‚¹ */
}

#delete-theme-btn:hover {
    background-color: #ffc2d1; /* åˆ é™¤æŒ‰é’®èƒŒæ™¯åŠ æ·±ä¸€ç‚¹ç‚¹ */
}

/* â–²â–²â–² å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.action-icon.summon-npc svg {
    stroke-width: 1.5; /* è®©å›¾æ ‡çº¿æ¡ç¨å¾®ç²—ä¸€ç‚¹ï¼Œæ›´æ¸…æ™° */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—å¸¦æœ‰è¯¦ç»†æ³¨é‡Šã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„å¾®åšä¸»é¡µå¸ƒå±€CSS â–¼â–¼â–¼ */

/* 1. ä¸ªäººä¸»é¡µçš„æ»šåŠ¨å®¹å™¨ (ä¿æŒä¸å˜) */
#weibo-profile-page {
    flex-grow: 1;
    overflow-y: auto;
    background-color: #f0f2f5;
}

/* 2. å¤´éƒ¨å®¹å™¨ï¼šè´Ÿè´£èƒŒæ™¯å›¾ï¼Œå¹¶ä¸ºä¸‹æ–¹å†…å®¹ç•™å‡ºç©ºé—´ */
.weibo-profile-header {
    position: relative;
    height: 240px;
    /* 
      â˜…â˜…â˜… æ‰‹åŠ¨è°ƒæ•´åŒºï¼šå¾®åšå†…å®¹ä¸ä¸Šæ–¹åŒºåŸŸçš„ã€ä¸Šä¸‹é—´è·ã€‘ â˜…â˜…â˜…
      è¿™ä¸ªå€¼å†³å®šäº†ä½ çš„ç¬¬ä¸€æ¡å¾®åšï¼Œå’Œä¸Šæ–¹ä¸ªäººä¿¡æ¯åŒºåŸŸçš„è·ç¦»ã€‚
      - æ•°å€¼è¶Šå¤§ï¼Œé—´è·è¶Šå¤§ï¼Œå¾®åšå†…å®¹ç¦»å¾—è¶Šè¿œã€‚
      - æ•°å€¼è¶Šå°ï¼Œé—´è·è¶Šå°ï¼Œå¾®åšå†…å®¹ç¦»å¾—è¶Šè¿‘ã€‚
      æˆ‘å·²å°†å®ƒä» 90px å‡å°åˆ°äº† 20pxï¼Œä½ å¯ä»¥æ ¹æ®å–œå¥½å†å¾®è°ƒã€‚
    */
    margin-bottom: -5px;/* â˜… ä¿®æ”¹è¿™é‡Œ â˜… */
}

/* 3. èƒŒæ™¯å›¾æ ·å¼ (ä¿æŒä¸å˜) */
.weibo-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 4. å¤´åƒå®¹å™¨ï¼šå®ç°æ‚¬æµ®æ•ˆæœçš„æ ¸å¿ƒ */
.weibo-avatar-container {
    position: absolute;
    z-index: 3;
    width: 80px;
    height: 80px;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transform: none;

    /* â˜…â˜…â˜… æ‰‹åŠ¨è°ƒæ•´åŒº1: å¤´åƒä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */

    /* --- å·¦å³ä½ç½® --- */
    /* æ•°å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•°å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 15px; /* â˜… ä¿®æ”¹è¿™é‡Œ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•°å€¼è¶Šå° (æ¯”å¦‚ -50px), è¶Šå¾€ä¸‹ã€‚æ•°å€¼è¶Šå¤§ (æ¯”å¦‚ -30px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 50px; /* â˜… ä¿®æ”¹è¿™é‡Œ */
}

.weibo-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}


/* 5. æ˜µç§°å’ŒèŒä¸šä¿¡æ¯ */
/* â˜…â˜…â˜… æ‰‹åŠ¨è°ƒæ•´åŒº2: æ˜µç§°ä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */
.weibo-nickname {
    position: absolute;
    z-index: 2;
    color: #1f1f1f;
    text-shadow: none;
    font-size: 18px;
    font-weight: 600;

    /* --- å·¦å³ä½ç½® --- */
    /* æ•°å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•°å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 35px; /* â˜… ä¿®æ”¹è¿™é‡Œ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•°å€¼è¶Šå° (æ¯”å¦‚ -60px), è¶Šå¾€ä¸‹ã€‚æ•°å€¼è¶Šå¤§ (æ¯”å¦‚ -50px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 30px; /* â˜… ä¿®æ”¹è¿™é‡Œ */
}

/* â–¼â–¼â–¼ ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰æ—§çš„ â–¼â–¼â–¼ */
#weibo-user-profession-display {
    position: absolute;
    left: 35px;          /* ä¿®æ”¹ï¼šä» left æ”¹ä¸º rightï¼Œè®©å®ƒé å³å¯¹é½ */
    bottom: -5px;        /* ä¿®æ”¹ï¼šè°ƒæ•´å‚ç›´ä½ç½®ï¼Œåœ¨å¤´åƒä¸‹æ–¹ */
    z-index: 2;
    font-size: 13px;
    color: #8a8a8a;
    text-shadow: none;
    text-align: right;    /* æ–°å¢ï¼šè®©æ–‡å­—æœ¬èº«ä¹Ÿé å³å¯¹é½ï¼Œæ›´ç¾è§‚ */
    cursor: pointer;      /* æ–°å¢ï¼šé¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºä¸ºå°æ‰‹å½¢çŠ¶ */
}








/* 6. å…³æ³¨/ç²‰ä¸/å¾®åšæ•°æ® */
/* â˜…â˜…â˜… æ‰‹åŠ¨è°ƒæ•´åŒº3: å…³æ³¨/ç²‰ä¸/å¾®åš ä½ç½® (å·¦å³ + ä¸Šä¸‹) â˜…â˜…â˜… */
.weibo-stats {
    position: absolute;
    z-index: 2;
    display: flex;
    gap: 20px;

    /* --- å·¦å³ä½ç½® --- */
    /* æ•°å€¼è¶Šå¤§ï¼Œè¶Šå¾€å³ã€‚æ•°å€¼è¶Šå°ï¼Œè¶Šå¾€å·¦ã€‚*/
    left: 35px; /* â˜… ä¿®æ”¹è¿™é‡Œ */

    /* --- ä¸Šä¸‹ä½ç½® --- */
    /* æ•°å€¼è¶Šå° (æ¯”å¦‚ -90px), è¿™è¡Œæ•°æ®è¶Šå¾€ä¸‹ã€‚æ•°å€¼è¶Šå¤§ (æ¯”å¦‚ -70px), è¶Šå¾€ä¸Šã€‚*/
    bottom: 15px; /* â˜… ä¿®æ”¹è¿™é‡Œ */
}


/* 7. å•ä¸ªæ•°æ®é¡¹æ ·å¼ (ä¿æŒä¸å˜) */
.weibo-stat-item {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 5px;
}
.weibo-stat-number {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    text-shadow: none;
}
.weibo-stat-label {
    font-size: 13px;
    color: #888;
    text-shadow: none;
}

/* 8. å¾®åšFeedåˆ—è¡¨ (ä¿æŒä¸å˜) */
#my-weibo-feed-list {
    padding-top: 15px;
}

/* â–²â–²â–² å¾®åšæ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšé¡µé¢æ¡†æ¶å’Œåº•éƒ¨å¯¼èˆªæ ·å¼ â–¼â–¼â–¼ */
#weibo-screen {
    display: flex;
    flex-direction: column;
}
.weibo-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
    flex-direction: column;
    background-color: #f0f2f5;
}
.weibo-view.active {
    display: flex; /* åªæ˜¾ç¤ºæ¿€æ´»çš„é¡µé¢ */
}
/* â–¼â–¼â–¼ ã€å¸ƒå±€ç»Ÿä¸€ä¿®å¤ç‰ˆã€‘ç”¨è¿™å—ä»£ç å®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ #weibo-bottom-nav æ ·å¼ â–¼â–¼â–¼ */
#weibo-bottom-nav {
    /* --- æ ¸å¿ƒä¿®æ”¹ --- */
    position: absolute; /* 1. æ”¹ä¸ºç»å¯¹å®šä½ï¼Œè®©å®ƒæµ®åŠ¨èµ·æ¥ */
    bottom: 0;          /* 2. å›ºå®šåœ¨åº•éƒ¨ */
    left: 0;            /* 3. å·¦ä¾§å¯¹é½ */
    width: 100%;        /* 4. å®½åº¦æ’‘æ»¡ */
    
    /* --- å…¶ä»–æ ·å¼ä¿æŒä¸å˜ --- */
    z-index: 15;
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding-bottom: env(safe-area-inset-bottom);
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.weibo-nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
}
.weibo-nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}
/* â–²â–²â–² å¾®åšæ¡†æ¶æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšå…³æ³¨åˆ—è¡¨å¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
#weibo-following-list-container {
    height: 100%;
    overflow-y: auto; /* ã€æ ¸å¿ƒã€‘å†…å®¹è¶…å‡ºæ—¶æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
}
.weibo-following-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #f0f0f0;
}
.weibo-following-item:last-child {
    border-bottom: none;
}
.weibo-following-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}
.weibo-following-name {
    font-weight: 500;
    color: var(--text-primary);
}
/* â–²â–²â–² å…³æ³¨åˆ—è¡¨æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®©ä¸ªäººä¸»é¡µå¯ç¼–è¾‘çš„å…ƒç´ æœ‰ç‚¹å‡»æ‰‹åŠ¿ â–¼â–¼â–¼ */
#weibo-avatar-img,
#weibo-nickname,
#weibo-posts-item, /* æˆ‘ä»¬è®©æ•´ä¸ªâ€œå¾®åšâ€åŒºåŸŸå¯ç‚¹å‡» */
#weibo-fans-item,  /* æ•´ä¸ªâ€œç²‰ä¸â€åŒºåŸŸå¯ç‚¹å‡» */
#weibo-background-img /* èƒŒæ™¯å›¾ä¹Ÿå¯ç‚¹å‡» */ {
    cursor: pointer;
    transition: opacity 0.2s;
}
#weibo-avatar-img:hover,
#weibo-nickname:hover,
#weibo-posts-item:hover,
#weibo-fans-item:hover,
#weibo-background-img:hover {
    opacity: 0.8; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶å˜æ·¡ä¸€ç‚¹ï¼Œç»™ç”¨æˆ·åé¦ˆ */
}
/* â–²â–²â–² ç‚¹å‡»æ‰‹åŠ¿æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #weibo-page-container æ ·å¼ â–¼â–¼â–¼ */
#weibo-page-container {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºç»å¯¹å®šä½çš„å¯¼èˆªæ é¢„ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ */
    /* 50px æ˜¯å¯¼èˆªæ çš„å¤§è‡´é«˜åº¦ï¼Œenv() ç”¨äºé€‚é…iPhoneåº•éƒ¨çš„å°é»‘æ¡ */
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è¢«æ­£ç¡®è®¡ç®—åœ¨å†… */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* ç¡®ä¿ä¸ªäººä¸»é¡µçš„å†…å®¹å¯ä»¥æ»šåŠ¨ */
#weibo-profile-page {
    overflow-y: auto;
    height: 100%;
}
/* â–²â–²â–² ä¿®å¤CSSç»“æŸ â–²â–²â–² */

/* â–²â–²â–² ä¿®å¤CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘æå‡å¾®åšå…³æ³¨åˆ—è¡¨å¼¹çª—çš„å±‚çº§ â–¼â–¼â–¼ */
#weibo-following-modal {
    z-index: 1001; /* ç¡®ä¿å®ƒèƒ½è¦†ç›–åœ¨å…¶ä»–é¡µé¢ä¹‹ä¸Š */
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšå¸–å­æ ·å¼ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšå¸–å­æ ·å¼ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* === å¾®åšå¸–å­ä¸“å±æ ·å¼ (å·²å’ŒåŠ¨æ€åˆ†ç¦») === */
/* === å¾®åšå¸–å­ä¸“å±æ ·å¼ (åœ†è§’å¡ç‰‡ç‰ˆ) === */
.weibo-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px; /* â˜… ä¿®æ”¹è¿™é‡Œï¼Œå¢åŠ åœ†è§’ï¼Œè®©å®ƒå˜å¾—åœ†æ¶¦å¯çˆ± */
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); /* â˜… æ–°å¢æŸ”å’Œçš„é˜´å½±ï¼Œè¥é€ å¡ç‰‡æ‚¬æµ®æ„Ÿ */
    /* â˜… æ—§çš„ border-bottom åˆ†å‰²çº¿å·²ç»è¢«ç§»é™¤äº†ï¼Œç°åœ¨ç”±çˆ¶å®¹å™¨çš„ gap å±æ€§è´Ÿè´£é—´è· */
}
.weibo-post-item:last-child {
    /* è¿™ä¸ªè§„åˆ™ç°åœ¨ä¹Ÿä¸éœ€è¦äº†ï¼Œä½†ä¿ç•™ç€ä¹Ÿæ²¡å…³ç³» */
    border-bottom: none;
}

.weibo-post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.weibo-post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.weibo-post-info {
    display: flex;
    flex-direction: column;
}

.weibo-post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.weibo-post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.weibo-post-content {
    font-size: 15px; /* å¾®åšæ­£æ–‡å­—ä½“ç¨å¤§ */
    line-height: 1.7;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
    margin-bottom: 10px;
}

.weibo-post-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.weibo-post-footer {
    border-top: 1px solid #f0f0f0;
    padding-top: 8px;
    margin-top: 10px;
}

.weibo-post-actions {
    display: flex;
    justify-content: space-around; /* ä¸‰ä¸ªæŒ‰é’®å‡åˆ†ç©ºé—´ */
    margin-bottom: 10px;
}

.weibo-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
}
.weibo-action-btn.liked {
    color: #ff5252; /* ç‚¹èµåå˜çº¢ */
}
.weibo-action-btn svg {
    width: 20px;
    height: 20px;
}

.weibo-comments-container {
    padding: 10px;
    background-color: #f7f7f7;
    border-radius: 8px;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
}

.weibo-comment-item .weibo-commenter-name {
    font-weight: 600;
    color: var(--accent-color);
}
.weibo-comment-item .weibo-comment-reply-tag {
    color: var(--text-secondary);
    margin: 0 4px;
}

.weibo-comment-input-area {
    display: flex;
    gap: 8px;
}

.weibo-comment-input {
    flex-grow: 1;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    padding: 8px 12px;
    font-size: 13px;
}

.weibo-comment-send-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 0 15px;
    font-size: 13px;
    cursor: pointer;
}
/* â–²â–²â–² å¾®åšä¸“å±æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å•æ¡è¯„è®ºçš„å®¹å™¨ï¼Œç°åœ¨éœ€è¦ç›¸å¯¹å®šä½ï¼Œå¹¶ä¸ºåˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
.weibo-comment-item {
    position: relative;
    padding-right: 25px; 
}

/* è¯„è®ºåˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    background-color: transparent; /* èƒŒæ™¯é€æ˜ */
    border: none; /* æ— è¾¹æ¡† */
    font-size: 20px; /* æ”¾å¤§"Ã—"å· */
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* é¼ æ ‡æ‚¬åœåœ¨æ•´æ¡è¯„è®ºä¸Šæ—¶ï¼Œæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.weibo-comment-item:hover .comment-delete-btn {
    opacity: 1;
}

/* é¼ æ ‡æ‚¬åœåœ¨åˆ é™¤æŒ‰é’®ä¸Šæ—¶ï¼Œç»™ä¸€ç‚¹åé¦ˆæ•ˆæœ */
.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30; /* å˜çº¢è‰² */
}

#phone-screen.dark-mode .comment-delete-btn:hover {
    background-color: #3a3a3c; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœèƒŒæ™¯è‰² */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšçƒ­æœæ ·å¼ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* === å¾®åšçƒ­æœåˆ—è¡¨æ ·å¼ === */
#weibo-hot-search-list {
    background-color: var(--secondary-bg);
}

.hot-search-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.hot-search-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .hot-search-item:hover {
    background-color: #2c2c2e;
}

.hot-search-rank {
    width: 30px;
    font-size: 16px;
    font-weight: bold;
    color: var(--text-secondary);
    text-align: center;
    flex-shrink: 0;
}
/* å‰ä¸‰åç”¨ä¸åŒçš„é¢œè‰²çªå‡ºæ˜¾ç¤º */
.hot-search-item[data-rank="1"] .hot-search-rank { color: #f44336; }
.hot-search-item[data-rank="2"] .hot-search-rank { color: #ff9800; }
.hot-search-item[data-rank="3"] .hot-search-rank { color: #ffc107; }

.hot-search-content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow: hidden;
}

.hot-search-topic {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.hot-search-tag {
    font-size: 10px;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
}
.hot-search-tag.hot { background-color: #f44336; }
.hot-search-tag.new { background-color: #ff9800; }
.hot-search-tag.rec { background-color: #2196f3; }

/* â–²â–²â–² å¾®åšçƒ­æœæ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©å¸–å­å¤´éƒ¨æˆä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½å‚è€ƒç‚¹ */
.weibo-post-header {
    position: relative; /* å…³é”®ï¼ */
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.weibo-post-delete-btn {
    position: absolute; /* ç»å¯¹å®šä½ï¼Œè®©å®ƒæµ®åŠ¨èµ·æ¥ */
    top: 10px;          /* è·ç¦»é¡¶éƒ¨10åƒç´  */
    right: 15px;         /* è·ç¦»å³ä¾§15åƒç´  */
    width: 26px;
    height: 26px;
    background-color: rgba(0, 0, 0, 0.08); /* åŠé€æ˜çš„èƒŒæ™¯ */
    color: var(--text-secondary); /* ä½¿ç”¨å…¨å±€çš„æ¬¡è¦æ–‡å­—é¢œè‰² */
    border: none;
    border-radius: 50%; /* åœ†å½¢ */
    font-size: 20px;    /* "Ã—"å·çš„å¤§å° */
    line-height: 26px;  /* è®©"Ã—"å·å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„åŠ¨ç”»æ•ˆæœ */
}

/* é¼ æ ‡æ”¾ä¸Šå»æ—¶ï¼Œå˜æˆé†’ç›®çš„çº¢è‰² */
.weibo-post-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¾®åšå¸ƒå±€ç»ˆæä¿®å¤ã€‘çœŸæ­£è§£å†³æ‰€æœ‰é¡µé¢æ»šåŠ¨ä¸åˆ°åº•çš„é—®é¢˜ â–¼â–¼â–¼ */

/* 1. å¤–å±‚å®¹å™¨ä¸å†éœ€è¦â€œå«å­â€ï¼Œå®ƒçš„ä»»åŠ¡åªæ˜¯æ’‘å¼€ç©ºé—´ */
#weibo-page-container {
    flex-grow: 1;
    position: relative;
    overflow: hidden; /* ä¿æŒä¸å˜ */
}

/* 2. ã€æ ¸å¿ƒã€‘æŠŠâ€œå«å­â€åŠ åˆ°çœŸæ­£æ»šåŠ¨çš„åˆ—è¡¨è‡ªå·±èº«ä¸Šï¼ */
#weibo-profile-page,
#weibo-following-feed-list,
#weibo-hot-search-list,
#weibo-plaza-feed-list,
#weibo-hottopic-feed-list {
    flex-grow: 1;
    overflow-y: auto;
    
    /* 
       é­”æ³•å°±åœ¨è¿™é‡Œï¼æˆ‘ä»¬ä¸ºæ¯ä¸ªåˆ—è¡¨çš„åº•éƒ¨ï¼Œ
       éƒ½åŠ ä¸Šä¸€ä¸ªå’Œå¯¼èˆªæ ä¸€æ ·é«˜çš„å†…è¾¹è·ï¼ˆâ€œå«å­â€ï¼‰ã€‚
       è¿™æ ·åˆ—è¡¨æ»šåŠ¨åˆ°åº•æ—¶ï¼Œæœ€åä¸€æ¡è¯„è®ºå°±ä¼šè¢«è¿™ä¸ªå†…è¾¹è·å‘ä¸Šæ¨ï¼Œ
       æ­£å¥½æ˜¾ç¤ºåœ¨åº•éƒ¨å¯¼èˆªæ çš„ä¸Šæ–¹ï¼Œä¸ä¼šå†è¢«æŒ¡ä½äº†ï¼
    */
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è¢«æ­£ç¡®è®¡ç®— */
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#post-visibility-groups label {
    display: block;
    padding: 5px 0;
}
#post-visibility-groups input {
    margin-right: 8px;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¾®åšå¸ƒå±€ç»ˆæä¿®å¤ã€‘è§£å†³æ‰€æœ‰é¡µé¢æ»šåŠ¨ä¸åˆ°åº•çš„é—®é¢˜ â–¼â–¼â–¼ */

/* 1. ç§»é™¤å¤–å±‚å®¹å™¨ä¸Šé”™è¯¯çš„å¤šä½™â€œå«å­â€ */
#weibo-page-container {
    padding-bottom: 0 !important;
}

/* 2. ã€æ ¸å¿ƒã€‘æŠŠâ€œå«å­â€ï¼ˆpadding-bottomï¼‰åŠ åˆ°çœŸæ­£æ»šåŠ¨çš„åˆ—è¡¨è‡ªå·±èº«ä¸Šï¼*/
#weibo-profile-page,
#weibo-following-feed-list,
#weibo-hot-search-list,
#weibo-plaza-feed-list,
#weibo-hottopic-feed-list {
    /* 
       é­”æ³•å°±åœ¨è¿™é‡Œï¼æˆ‘ä»¬ä¸ºæ¯ä¸ªåˆ—è¡¨çš„åº•éƒ¨ï¼Œ
       éƒ½åŠ ä¸Šä¸€ä¸ªå’Œå¯¼èˆªæ ä¸€æ ·é«˜çš„å†…è¾¹è·ï¼ˆâ€œå«å­â€ï¼‰ã€‚
       calc(50px + env(safe-area-inset-bottom)) ä¼šè‡ªåŠ¨è®¡ç®—å¯¼èˆªæ é«˜åº¦å’ŒiPhoneåº•éƒ¨å®‰å…¨åŒºé«˜åº¦ã€‚
    */
    padding-bottom: calc(50px + env(safe-area-inset-bottom)) !important;
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è¢«æ­£ç¡®è®¡ç®— */
}
/* â–¼â–¼â–¼ ã€é—®é¢˜1ä¿®å¤ã€‘å¾®åšç¼–è¾‘èµ„æ–™æŒ‰é’®å¼ºåˆ¶æ˜¾ç¤º â–¼â–¼â–¼ */
/* è¯·å°†è¿™æ®µä»£ç ç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ */
#edit-weibo-profile-btn {
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤ºä¸ºflexå®¹å™¨ */
    align-items: center;
    justify-content: center;
    color: var(--accent-color) !important; /* å¼ºåˆ¶ä½¿ç”¨ä¸»é¢˜è‰² */
}
#edit-weibo-profile-btn svg {
    stroke: currentColor !important; /* ç¡®ä¿SVGå›¾æ ‡ç»§æ‰¿ä¸Šé¢çš„é¢œè‰² */
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©å…³æ³¨åˆ—è¡¨çš„æ¯ä¸€è¡Œéƒ½èƒ½å®¹çº³æ–°æŒ‰é’® */
.weibo-following-item {
    align-items: center; /* ç¡®ä¿å¤´åƒã€åå­—å’ŒæŒ‰é’®å‚ç›´å±…ä¸­å¯¹é½ */
}

/* 2. è¿™æ˜¯ä½ æ–°å¢çš„â€œæ“ä½œâ€æŒ‰é’®çš„æ ·å¼ */
.weibo-action-trigger-btn {
    margin-left: auto; /* æ ¸å¿ƒï¼šè®©æŒ‰é’®è‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
    padding: 5px 8px;
    cursor: pointer;
    border-radius: 50%; /* åœ†å½¢æŒ‰é’®ï¼Œæ›´ç¾è§‚ */
    transition: background-color 0.2s;
}
.weibo-action-trigger-btn:hover {
    background-color: #e0e0e0;
}
#phone-screen.dark-mode .weibo-action-trigger-btn:hover {
    background-color: #3a3a3c;
}
.weibo-action-trigger-btn svg {
    width: 20px;
    height: 20px;
    stroke: var(--text-secondary); /* å›¾æ ‡é¢œè‰²è·Ÿéšä¸»é¢˜ */
    display: block; /* è§£å†³ä¸€äº›å¯¹é½é—®é¢˜ */
}

/* 3. ä¸ºæ“ä½œå¼¹çª—é‡Œçš„å•é€‰æŒ‰é’®ç¾åŒ–ä¸€ä¸‹ */
#weibo-action-type-select label {
    display: block;
    padding: 8px;
    border-radius: 6px;
    transition: background-color 0.2s;
}
#weibo-action-type-select label:hover {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #weibo-action-type-select label:hover {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¼¹çª—å±‚çº§ä¿®å¤ã€‘ç²˜è´´è¿™æ®µä»£ç åˆ°æ ·å¼æœ«å°¾ â–¼â–¼â–¼ */
#weibo-action-modal {
    z-index: 1002; /* è¿™ä¸ªå€¼æ¯”å…³æ³¨åˆ—è¡¨(1001)æ›´é«˜ï¼Œå°±ä¸ä¼šè¢«ç›–ä½äº† */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®ºå›/å°ç»„åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. å°ç»„åˆ—è¡¨å¡ç‰‡æ ·å¼ */
.forum-group-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.forum-group-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.12);
}
.forum-group-icon {
    font-size: 28px;
    margin-bottom: 10px;
}
.forum-group-name {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 5px;
}
.forum-group-desc {
    font-size: 12px;
    color: var(--text-secondary);
}

/* 2. å¸–å­åˆ—è¡¨é¡¹æ ·å¼ */
.forum-post-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
}
.forum-post-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .forum-post-item:hover {
    background-color: #2c2c2e;
}
.post-item-title {
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 8px;
}
.post-item-meta {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    justify-content: space-between;
}

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #post-detail-content æ ·å¼ â–¼â–¼â–¼ */
#post-detail-content {
    flex-grow: 1;      /* æ ¸å¿ƒï¼šè®©å®ƒå æ®æ‰€æœ‰å¯ç”¨çš„å‚ç›´ç©ºé—´ */
    overflow-y: auto;  /* æ ¸å¿ƒï¼šå¦‚æœå†…å®¹è¶…å‡ºï¼Œåˆ™å…è®¸è‡ªèº«æ»šåŠ¨ */
    display: flex;
    flex-direction: column;
    padding: 20px;     /* ä¿ç•™èˆ’é€‚çš„å†…è¾¹è· */
    /* ä¸å†éœ€è¦ä¸ºç»å¯¹å®šä½çš„è¾“å…¥æ¡†ç•™å‡ºé¢å¤–çš„padding-bottom */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
.post-detail-header h1 {
    font-size: 22px;
    margin: 0 0 10px 0;
}
.post-detail-meta {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
}
.post-detail-body {
    font-size: 16px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}
.post-comments-section {
    padding-top: 20px;
}
.post-comments-section h3 {
    font-size: 16px;
    margin: 0 0 15px 0;
    border-left: 3px solid var(--accent-color);
    padding-left: 10px;
}
.post-comment-item {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .post-comment-item {
    border-bottom-color: #2c2c2e;
}
.comment-author {
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 5px;
}
.comment-content {
    font-size: 14px;
    line-height: 1.6;
}

/* 4. å¸–å­é¡µåº•éƒ¨è¾“å…¥æ¡† */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #post-comment-input-area æ ·å¼ â–¼â–¼â–¼ */
#post-comment-input-area {
    /* 
      æˆ‘ä»¬ç§»é™¤äº† position: absolute; å’Œç›¸å…³çš„ bottom, left å±æ€§ï¼Œ
      è®©å®ƒä»ä¸€ä¸ªâ€œæµ®åŠ¨å±‚â€å˜å›ä¸€ä¸ªæ­£å¸¸çš„å—çº§å…ƒç´ ï¼Œè‡ªç„¶åœ°æ’åœ¨å†…å®¹ä¸‹æ–¹ã€‚
      å…¶ä»–çš„æ ·å¼ä¼šä» .chat-input-area ç±»ç»§æ‰¿ï¼Œæ— éœ€æ‹…å¿ƒã€‚
    */
    width: 100%;
    box-sizing: border-box;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–²â–²â–² è®ºå›æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€å…¨æ–°ã€‘çš„è®ºå›ç¾åŒ–CSSï¼Œç²˜è´´åˆ°<style>æ ‡ç­¾çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. ç¾åŒ–å¸–å­è¯¦æƒ…é¡µåº•éƒ¨çš„è¯„è®ºè¾“å…¥åŒºåŸŸ */
#post-comment-input-area {
    padding: 10px 15px; /* å¢åŠ å†…è¾¹è·ï¼Œè®©å®ƒä¸è´´è¾¹ */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* 2. ã€æ ¸å¿ƒã€‘ç¾åŒ–è¯„è®ºè¾“å…¥æ¡†æœ¬èº« */
#post-comment-input-area #post-comment-input {
    background-color: #f0f2f5; /* æµ…ç°è‰²èƒŒæ™¯ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    border: none;
    border-radius: 18px; /* åœ†è§’ï¼Œæ›´æŸ”å’Œ */
    padding: 10px 15px;
    font-size: 14px;
    resize: none; /* ç¦æ­¢ç”¨æˆ·æ‹–æ‹½å¤§å° */
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #post-comment-input-area #post-comment-input {
    background-color: #2c2c2e;
}

/* 3. ç¾åŒ–å‘é€æŒ‰é’® */
#post-comment-input-area #send-post-comment-btn {
    height: 36px;
    border-radius: 18px; /* å’Œè¾“å…¥æ¡†ä¿æŒä¸€è‡´çš„åœ†è§’ */
    padding: 0 20px;
}

/* 4. ã€æ–°å¢ã€‘AIç”Ÿæˆè¯„è®ºæŒ‰é’®çš„æ ·å¼ */
.generate-comments-container {
    padding: 10px 20px 0 20px;
    border-bottom: 8px solid #f0f2f5;
}

#phone-screen.dark-mode .generate-comments-container {
    border-bottom-color: #000;
}

#generate-forum-comments-btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    background-color: #e9f5ff;
    color: var(--accent-color);
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

#generate-forum-comments-btn:hover {
    background-color: #d4eaff;
}
/* â–²â–²â–² è®ºå›ç¾åŒ–CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®ºå›å¸–å­/è¯„è®ºå¤´åƒä¸æ¥¼å±‚æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¸–å­ä½œè€…åŒºåŸŸï¼šä½¿ç”¨flexå¸ƒå±€è®©å¤´åƒå’Œåå­—å¹¶æ’ */
#post-detail-content .post-detail-header {
    display: flex;
    align-items: center;
    gap: 12px; /* å¤´åƒå’Œå³ä¾§ä¿¡æ¯çš„é—´è· */
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
}

/* 2. å¸–å­ä½œè€…çš„å¤´åƒæ ·å¼ */
.post-author-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* 3. åŒ…è£¹ä½œè€…åå­—å’Œæ—¶é—´çš„å®¹å™¨ */
.post-author-info {
    display: flex;
    flex-direction: column;
}

/* 4. ç§»é™¤æ—§çš„æ ‡é¢˜å’Œmetaå¤–è¾¹è·ï¼Œå› ä¸ºflexå¸ƒå±€ä¼šå¤„ç†é—´è· */
#post-detail-content .post-detail-header h1,
#post-detail-content .post-detail-meta {
    margin: 0;
}
#post-detail-content .post-detail-header h1 {
    font-size: 18px; /* æ ‡é¢˜å¯ä»¥ç¨å¾®å°ä¸€ç‚¹ï¼Œæ›´åè°ƒ */
    margin-bottom: 4px;
}

/* 5. è¯„è®ºåŒºæ¯ä¸€æ¡è¯„è®ºçš„å¸ƒå±€ */
.post-comment-item {
    display: flex;
    gap: 10px; /* å¤´åƒå’Œå³ä¾§å†…å®¹çš„é—´è· */
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .post-comment-item {
    border-bottom-color: #2c2c2e;
}

/* 6. è¯„è®ºè€…çš„å°å¤´åƒ */
.comment-avatar-small {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* 7. åŒ…è£¹è¯„è®ºæ‰€æœ‰æ–‡å­—å†…å®¹çš„å®¹å™¨ */
.comment-details {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

/* 8. è¯„è®ºçš„å¤´éƒ¨ï¼šåŒ…å«åå­—å’Œæ¥¼å±‚ */
.comment-header-line {
    display: flex;
    justify-content: space-between; /* è®©åå­—é å·¦ï¼Œæ¥¼å±‚é å³ */
    align-items: center;
    margin-bottom: 5px;
}

/* 9. è¯„è®ºæ¥¼å±‚å·çš„æ ·å¼ */
.comment-floor {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

/* 10. ç§»é™¤æ—§çš„è¯„è®ºä½œè€…å¤–è¾¹è· */
.post-comment-item .comment-author {
    margin-bottom: 0;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä¿®å¤è®ºå›è¯„è®ºåŒºå®½åº¦é—®é¢˜çš„æ–°å¢ä»£ç  â–¼â–¼â–¼ */
#post-comment-input-area #post-comment-input {
    flex-grow: 1; /* â˜…â˜…â˜… æ ¸å¿ƒä»£ç å°±æ˜¯è¿™è¡Œï¼è®©è¾“å…¥æ¡†è‡ªåŠ¨ä¼¸å±•ï¼Œå æ»¡æ‰€æœ‰å¯ç”¨å®½åº¦ â˜…â˜…â˜… */
    
    /* ä¸‹é¢è¿™äº›æ˜¯ç¾åŒ–æ ·å¼ï¼Œè®©å®ƒå’Œå…¶ä»–è¾“å…¥æ¡†é£æ ¼ç»Ÿä¸€ï¼Œè¿™æ¬¡æ²¡æœ‰ä¿®æ”¹é«˜åº¦å“¦ */
    border: none;
    background-color: #f0f2f5; 
    border-radius: 18px;       
    padding: 10px 15px;        
    font-size: 14px;
    resize: none;             
    box-sizing: border-box;    
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #post-comment-input-area #post-comment-input {
    background-color: #2c2c2e;
}
/* â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œæ›¿æ¢æ‰ä½ æ—§çš„æ‰€æœ‰å¡”ç½—ç‰Œç›¸å…³CSS â–¼â–¼â–¼ */

/* 1. å åœç»“æœå¼¹çª—å†…çš„æ ·å¼ï¼ˆçº¯æ–‡å­—ç‰ˆï¼‰ */
#tarot-result-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
.tarot-result-question {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    background-color: #f0f2f5;
    padding: 8px 12px;
    border-radius: 8px;
    width: 95%;
    text-align: center;
}
#phone-screen.dark-mode .tarot-result-question {
    background-color: #2c2c2e;
}
.tarot-spread-container {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
}
.tarot-card-wrapper {
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
#phone-screen.dark-mode .tarot-card-wrapper {
    background-color: #1c1c1e;
}
.tarot-card-position {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 4px;
}
.tarot-card-name {
    font-size: 14px;
}

/* 3. å†å²è®°å½•æ ·å¼ (ä¿æŒä¸å˜) */
#tarot-history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.tarot-history-item {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
    position: relative;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .tarot-history-item {
    background-color: #2c2c2e;
}
.tarot-history-item .question { font-weight: 600; margin-bottom: 8px; }
.tarot-history-item .details { font-size: 13px; color: var(--text-secondary); white-space: pre-wrap; }
.tarot-history-delete-btn {
    position: absolute;
    top: 5px; right: 5px; width: 24px; height: 24px;
    background-color: #e0e0e0; color: #888; border-radius: 50%;
    border: none; cursor: pointer; font-size: 18px; line-height: 24px; text-align: center;
}
#phone-screen.dark-mode .tarot-history-delete-btn {
    background-color: #3e3e42;
}
/* â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šä»è¿™é‡Œå¼€å§‹å¤åˆ¶æ›¿æ¢ â–¼â–¼â–¼ */

#lovers-space-screen {
    background-color: #f0f2f5;   /* ä¿ç•™ä¸€ä¸ªå¤‡ç”¨èƒŒæ™¯è‰² */
    background-size: cover;      /* èƒŒæ™¯å›¾è¦†ç›–æ•´ä¸ªåŒºåŸŸ */
    background-position: center; /* èƒŒæ™¯å›¾å±…ä¸­æ˜¾ç¤º */
    background-repeat: no-repeat;/* èƒŒæ™¯å›¾ä¸é‡å¤ */
}

/* å¤´éƒ¨ */
#ls-header {
    height: 220px;
    position: relative;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº† background-size å’Œ background-position */
    color: white;
    flex-shrink: 0;
    background-color: transparent; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘è®©å¤´éƒ¨èƒŒæ™¯å˜é€æ˜ï¼Œä»¥æ˜¾ç¤ºä¸‹æ–¹çš„å…¨å±èƒŒæ™¯ */
}

/* â–²â–²â–² ç¬¬1æ­¥ï¼šå¤åˆ¶æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² */

/* --- ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä¿®å¤æƒ…ä¾£ç©ºé—´é¡¶éƒ¨æŒ‰é’®æ— æ³•ç‚¹å‡»çš„é—®é¢˜ --- */
/* --- ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä¿®å¤é®ç½©å±‚æ‹¦æˆªç‚¹å‡»çš„é—®é¢˜ --- */

.ls-header-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.2));
    
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šè®©è¿™ä¸ªé®ç½©å±‚å¯¹é¼ æ ‡äº‹ä»¶â€œé€æ˜â€ï¼ â–¼â–¼â–¼ */
    pointer-events: none; 
    /* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
}


/* --- ã€å·²ä¿®å¤ã€‘æƒ…ä¾£ç©ºé—´é¡¶éƒ¨æ å±‚çº§é—®é¢˜ --- */

.ls-header-top-bar {
    position: relative;
    z-index: 3; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°†å±‚çº§ä» 2 æå‡åˆ° 3 â˜…â˜…â˜… */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    padding-top: calc(15px + env(safe-area-inset-top));
}

#ls-char-name {
    font-size: 18px;
    font-weight: 600;
}
#ls-switch-char-btn { font-size: 16px; }

.ls-header-avatars {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 2;
}
.ls-header-avatars img {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.ls-header-avatars .heart-icon {
    font-size: 28px;
    color: #ff4d6d;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
}

/* â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ #ls-tab-bar å’Œ .ls-tab-item æ ·å¼ â–¼â–¼â–¼ */

/* é¡µç­¾æ  (V2 - æ‚¬æµ®æ’‘æ»¡ç‰ˆ) */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æ‚¬æµ®èƒ¶å›Šæœ€ç»ˆç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ #ls-tab-bar æ ·å¼ â–¼â–¼â–¼ */
#ls-tab-bar {
    display: flex;
    flex-shrink: 0;
    position: relative;
    z-index: 5;

    /* --- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ --- */
    /* 1. ä½¿ç”¨ margin å®ç°ä¸Šä¸‹å·¦å³çš„è¾¹è·ï¼Œè¥é€ æ‚¬æµ®æ„Ÿ */
   margin: -20px 5px 10px 5px; /* æŠŠå·¦å³çš„ 15px æ”¹æˆäº† 5px */
    
    /* 2. ä¸ºæ‰€æœ‰å››ä¸ªè§’éƒ½è®¾ç½®åœ†è§’ï¼Œå½¢æˆå¯çˆ±çš„èƒ¶å›Šå½¢çŠ¶ */
    border-radius: 25px; 

    background-color: var(--secondary-bg);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* é˜´å½±å¯ä»¥è®©æ‚¬æµ®æ„Ÿæ›´å¼º */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* å•ä¸ªé¡µç­¾é¡¹ç›® (V2) */
.ls-tab-item {
    flex: 1;
    text-align: center;
    /* æ ¸å¿ƒä¿®æ”¹ï¼špadding ä» 12px å¢åŠ åˆ° 15pxï¼Œè®©å¯¼èˆªæ ã€æ‹‰é•¿ä¸€ç‚¹ã€‘(æ›´é«˜) */
    padding: 15px 0;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    /* æ–°å¢ï¼šä¸ºå›¾æ ‡çš„ç¼©æ”¾å’Œé¢œè‰²å˜åŒ–æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
    transition: color 0.2s ease;
}

/* æ¿€æ´»çŠ¶æ€çš„é¡µç­¾ (V2) */
.ls-tab-item.active {
    color: var(--accent-color);
}

/* æ¿€æ´»çŠ¶æ€çš„ä¸‹åˆ’çº¿æŒ‡ç¤ºå™¨ (ä¿æŒä¸å˜) */
.ls-tab-item.active::after {
    content: '';
    position: absolute;
    bottom: 8px; /* å¾®è°ƒä½ç½®ä»¥é€‚åº”æ›´é«˜çš„å¯¼èˆªæ  */
    left: 50%;
    transform: translateX(-50%);
    width: 28px;
    height: 3px;
    background-color: var(--accent-color);
    border-radius: 1.5px;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºSVGå›¾æ ‡æ–°å¢çš„æ ·å¼ï¼Œè¯·æŠŠå®ƒä¹Ÿç²˜è´´åˆ°<style>é‡Œ â–¼â–¼â–¼ */
.ls-tab-item svg {
    width: 24px;
    height: 24px;
    /* ä¸ºå›¾æ ‡çš„å¤§å°å’Œç²—ç»†å˜åŒ–æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
    transition: all 0.2s ease-in-out;
}

/* æ¿€æ´»çŠ¶æ€çš„å›¾æ ‡ï¼Œä¼šå˜å¾—æ›´ç²—ã€æ›´å¤§ä¸€ç‚¹ï¼Œéå¸¸é†’ç›® */
.ls-tab-item.active svg {
    stroke-width: 2.5;
    transform: scale(1.1);
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */

/* å†…å®¹åŒºåŸŸ */
#ls-content-area {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
}
.ls-view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    display: none;
    padding: 15px;
    box-sizing: border-box;
}
.ls-view.active {
    display: block;
}

/* æµ®åŠ¨æ·»åŠ æŒ‰é’® */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€ç»ˆæå±…ä¸­ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .ls-fab-btn æ ·å¼ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ è¿™æ˜¯SVGé€‚é…ç‰ˆçš„æœ€ç»ˆä»£ç  â–¼â–¼â–¼ */
.ls-fab-btn {
    position: fixed;
    bottom: calc(30px + env(safe-area-inset-bottom));
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 10;
    
    /* ä¾ç„¶ä½¿ç”¨Flexboxæ¥å±…ä¸­SVGå›¾æ ‡ */
    display: flex;
    justify-content: center;
    align-items: center;

    /* ç§»é™¤æ‰€æœ‰ä¸å­—ä½“ç›¸å…³çš„å±æ€§ */
    /* font-size: 28px; (å·²ç§»é™¤) */
    /* line-height: normal; (å·²ç§»é™¤) */
}

/* (å¯é€‰) å¦‚æœä½ è§‰å¾—SVGæœ‰ç‚¹å°æˆ–å¤§ï¼Œå¯ä»¥å¾®è°ƒå®ƒçš„å¤§å° */
.ls-fab-btn svg {
    width: 24px;
    height: 24px;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* è¯´è¯´å¡ç‰‡ */
#ls-moments-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
/* è¯´è¯´å¡ç‰‡ */
/* ... */
.ls-moment-card {
    position: relative; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå°±æ˜¯åŠ ä¸Šè¿™ä¸€è¡Œï¼ â˜…â˜…â˜… */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    display: flex;
    gap: 12px;
}
/* ... */

.ls-moment-card .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
}
.ls-moment-card .moment-main {
    display: flex;
    flex-direction: column;
}
.ls-moment-card .author {
    font-weight: 600;
    color: var(--text-primary);
}
.ls-moment-card .content {
    margin-top: 5px;
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}
.ls-moment-card .timestamp {
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-secondary);
}

/* ç›¸å†Œåˆ—è¡¨ */
/* â–¼â–¼â–¼ ç”¨è¿™å—æ–°æ ·å¼æ›¿æ¢æ—§çš„ #ls-album-list â–¼â–¼â–¼ */
#ls-album-list {
    display: grid;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä»2åˆ—å˜ä¸º3åˆ—ï¼Œé—´è·ä»15pxç¼©å°ä¸º5px */
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
.ls-album-item {
    cursor: pointer;
}
.ls-album-item .cover {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: #e9ecef;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
}
.ls-album-item .name {
    font-weight: 500;
    text-align: center;
}

/* ç…§ç‰‡ä¸Šä¼ é¢„è§ˆ */
#ls-photo-preview-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}
.ls-photo-preview-item {
    position: relative;
    aspect-ratio: 1 / 1;
}
.ls-photo-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}
.ls-photo-preview-item .remove-btn {
    position: absolute;
    top: -5px; right: -5px;
    width: 20px; height: 20px;
    background-color: #ff3b30;
    color: white;
    border-radius: 50%;
    border: none;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
}

/* æƒ…ä¹¦å’Œåˆ†äº«åˆ—è¡¨ */
.ls-list-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    cursor: pointer;
}
.ls-list-item .title {
    font-weight: 500;
    margin-bottom: 5px;
}
.ls-list-item .meta {
    font-size: 12px;
    color: var(--text-secondary);
}
.ls-share-item .share-type {
    display: inline-block;
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
    margin-right: 8px;
    color: white;
}
.share-type.song { background-color: #28a745; }
.share-type.movie { background-color: #fd7e14; }
.share-type.book { background-color: #6f42c1; }
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ã€æ ¸å¿ƒä¿®å¤ã€‘è®©æ ‡é¢˜ç»å¯¹å±…ä¸­ï¼Œä¸å†å—ä¸¤è¾¹æŒ‰é’®æ•°é‡å½±å“ */
#ls-header #ls-char-name {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 60%; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢ä¸æŒ‰é’®é‡å  */
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ã€æ–°å¢ã€‘å¤´åƒå’Œè®¡æ•°å™¨çš„æ€»å®¹å™¨ï¼Œè´Ÿè´£æ•´ä½“å®šä½ */
.ls-avatar-and-counter-wrapper {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2;
    display: flex;
    flex-direction: column; /* è®©å¤´åƒå’Œè®¡æ•°å™¨å‚ç›´æ’åˆ— */
    align-items: center; /* æ°´å¹³å±…ä¸­ */
    gap: 10px; /* å¤´åƒå’Œè®¡æ•°å™¨ä¹‹é—´çš„å‚ç›´é—´è· */
}

/* ã€ä¿®æ”¹ã€‘ç§»é™¤æ—§çš„å¤´åƒç»å¯¹å®šä½ï¼Œå› ä¸ºå®ƒç°åœ¨è¢«æ–°å®¹å™¨ç®¡ç†äº† */
.ls-header-avatars {
    position: static; /* æ”¹ä¸ºé™æ€å®šä½ */
    transform: none;
    bottom: auto;
    left: auto;
    /* å…¶ä»–æ ·å¼ï¼ˆå¦‚å¤´åƒå¤§å°ã€è¾¹æ¡†ç­‰ï¼‰ä¿æŒä¸å˜ */
}

/* ã€ä¿®æ”¹ã€‘ç§»é™¤æ—§çš„è®¡æ•°å™¨å®šä½æ ·å¼ï¼Œè®©å®ƒåœ¨æ–°å®¹å™¨é‡Œè‡ªç„¶æ’åˆ— */
#ls-days-counter {
    position: static;
    margin-top: 0;
    /* å…¶ä»–æ ·å¼ï¼ˆå¦‚å­—ä½“é¢œè‰²ã€é˜´å½±ç­‰ï¼‰ä¿æŒä¸å˜ */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©ç›¸å†Œé¡¹ç›®æˆä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½å‚è€ƒç‚¹ */
.ls-album-item .cover {
    position: relative; /* å…³é”®ï¼ */
    overflow: hidden; /* é˜²æ­¢åˆ é™¤æŒ‰é’®æº¢å‡ºåœ†è§’ */
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.ls-photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 24px; /* ç¡®ä¿ "Ã—" å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease;
    z-index: 5; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* 3. é¼ æ ‡æ‚¬åœåœ¨å°é¢ä¸Šæ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.ls-album-item .cover:hover .ls-photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºæƒ…ä¾£ç©ºé—´â€œè¯´è¯´â€æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */

/* è¯´è¯´å¡ç‰‡åº•éƒ¨çš„äº’åŠ¨åŒºï¼ˆè¯„è®ºè¾“å…¥ã€åˆ é™¤æŒ‰é’®ç­‰ï¼‰ */
.ls-moment-footer {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* å’Œå†…å®¹åŒºåˆ†éš”å¼€ */
}

/* è¯„è®ºåˆ—è¡¨çš„å®¹å™¨ */
.ls-moment-comments-container {
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ¯æ¡è¯„è®ºä¹‹é—´çš„é—´è· */
    font-size: 14px;
    margin-bottom: 10px;
}

/* æ¯ä¸€æ¡è¯„è®ºçš„æ ·å¼ */
.ls-comment-item {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    padding-right: 25px; /* ç»™åˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
    line-height: 1.5;
}

.ls-comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è‰² */
    margin-right: 5px;
}

/* è¯„è®ºçš„åˆ é™¤æŒ‰é’® */
.ls-comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
}

/* é¼ æ ‡æ”¾ä¸Šå»æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.ls-comment-item:hover .ls-comment-delete-btn {
    opacity: 1;
}
.ls-comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}

/* è¯„è®ºè¾“å…¥åŒºåŸŸçš„æ ·å¼ */
.ls-comment-input-area {
    display: flex;
    gap: 8px;
    align-items: center;
}

.ls-comment-input-area input {
    flex-grow: 1;
    border: none;
    background-color: #f0f2f5;
    border-radius: 15px;
    padding: 8px 12px;
    font-size: 14px;
}

.ls-comment-input-area button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
}

/* è¯´è¯´å¡ç‰‡æœ¬èº«çš„åˆ é™¤æŒ‰é’® */
.ls-moment-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.08);
    color: var(--text-secondary);
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
}
.ls-moment-card:hover .ls-moment-delete-btn {
    opacity: 1; /* é¼ æ ‡æ”¾ä¸Šå»æ‰æ˜¾ç¤º */
}
.ls-moment-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿¡çº¸ç¾åŒ–ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„æ‰€æœ‰æƒ…ä¹¦CSS â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æƒ…ä¾£ç©ºé—´æƒ…ä¹¦åŠŸèƒ½æ ·å¼ --- */

/* 1. æƒ…ä¹¦åˆ—è¡¨ä¸ºç©ºæ—¶çš„æç¤º (ä¸å˜) */
#ls-letters-list .ls-empty-placeholder {
    text-align: center;
    color: var(--text-secondary);
    padding: 50px 0;
}

/* 2. å•ä¸ªæƒ…ä¹¦å¡ç‰‡çš„æ ·å¼ (å·²ä¿®æ”¹) */
.ls-love-letter-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    gap: 12px;
    align-items: center;
}
.ls-love-letter-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* 3. æƒ…ä¹¦å›¾æ ‡çš„æ ·å¼ (ä¸å˜) */
.ls-love-letter-item .letter-icon {
    flex-shrink: 0;
    width: 45px;
    height: 45px;
    color: #ff8fab;
}

/* 4. æƒ…ä¹¦ä¸»è¦ä¿¡æ¯åŒº (å·²ä¿®æ”¹ï¼ŒåŠ å…¥å¤´åƒ) */
.ls-love-letter-item .letter-info {
    flex-grow: 1;
    overflow: hidden;
}
/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ”¶ä»¶äººåŒºåŸŸç°åœ¨åŒ…å«å¤´åƒå’Œåå­— */
.ls-love-letter-item .letter-recipient {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 5px;
}
.ls-love-letter-item .letter-recipient .avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}
.ls-love-letter-item .letter-preview {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. å‘ä¿¡äººä¿¡æ¯ (ä¸å˜) */
.ls-love-letter-item .letter-sender {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-secondary);
}
.ls-love-letter-item .letter-sender .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
}

/* 6. ã€å…¨æ–°ã€‘æƒ…ä¹¦è¯¦æƒ…æŸ¥çœ‹å™¨ (ä¿¡çº¸æ ·å¼) */
#ls-letter-viewer-modal {
    z-index: 1001; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}
.ls-letter-viewer-content {
    background-color: #fdfaef; /* æ¸©é¦¨çš„ç±³é»„è‰²ä¿¡çº¸èƒŒæ™¯ */
    width: 90%;
    max-width: 340px;
    height: 75%;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    font-family: 'Kaiti', 'STKaiti', serif; /* ä½¿ç”¨æ›´å…¸é›…çš„æ¥·ä½“ */
}
.letter-viewer-header {
    padding: 15px;
    border-bottom: 1px dashed #e0d9c7;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #5d4037;
}
.letter-viewer-header .meta-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
}
.letter-viewer-header .recipient-info .label {
    font-size: 13px;
    color: #a1887f;
}
.letter-viewer-header .recipient-info .name {
    font-size: 16px;
    font-weight: 600;
}
.letter-viewer-body {
    flex-grow: 1;
    padding: 20px;
    font-size: 16px;
    line-height: 2; /* æ›´å¤§çš„è¡Œé«˜ï¼Œæ¨¡æ‹Ÿæ‰‹å†™ä¿¡çš„èˆ’é€‚æ„Ÿ */
    color: #4a443b;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
.letter-viewer-footer {
    padding: 15px;
    border-top: 1px dashed #e0d9c7;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.letter-viewer-footer .sender-info {
    font-size: 14px;
    color: #5d4037;
    font-weight: 600;
}
.letter-viewer-footer .sender-info .timestamp {
    font-size: 11px;
    color: #a1887f;
    font-weight: normal;
}
.letter-viewer-footer .letter-actions {
    display: flex;
    gap: 10px;
}
.letter-viewer-footer .letter-actions button {
    padding: 8px 15px;
    border-radius: 15px;
    border: 1px solid #d4bda5;
    background-color: transparent;
    color: #8c7b6c;
    cursor: pointer;
    font-size: 14px;
}
.letter-viewer-footer .letter-actions button.primary {
    background-color: #ff8fab;
    color: white;
    border-color: #ff8fab;
}

/* â–²â–²â–² æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºæƒ…ä¹¦æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©æƒ…ä¹¦å¡ç‰‡å¯ä»¥ä½œä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½å‚è€ƒç‚¹ */
.ls-love-letter-item {
    position: relative; /* å…³é”®ï¼ */
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.ls-letter-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #888;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
    z-index: 5; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* 3. é¼ æ ‡æ‚¬åœåœ¨æ•´å¼ å¡ç‰‡ä¸Šæ—¶ï¼Œæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.ls-love-letter-item:hover .ls-letter-delete-btn {
    opacity: 1;
}

/* 4. é¼ æ ‡æ‚¬åœåœ¨åˆ é™¤æŒ‰é’®ä¸Šæ—¶ï¼Œç»™ä¸€ç‚¹åé¦ˆæ•ˆæœ */
.ls-letter-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¾£æé—®æ ·å¼ --- */

#ls-questions-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.ls-question-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden; /* é˜²æ­¢å†…éƒ¨å…ƒç´ æº¢å‡ºåœ†è§’ */
}

.ls-question-section,
.ls-answer-section {
    padding: 15px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.ls-question-section {
    border-bottom: 1px dashed var(--border-color);
}

.ls-question-card .qa-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
}

.ls-question-card .qa-main {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.ls-question-card .qa-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ls-question-card .qa-author {
    font-weight: 600;
}

.ls-question-card .qa-timestamp {
    font-size: 11px;
    color: var(--text-secondary);
}

.ls-question-card .qa-content {
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}

.ls-answer-placeholder {
    padding: 20px;
    text-align: center;
}

.ls-answer-btn {
    padding: 8px 20px;
    border: 1px solid var(--accent-color);
    background-color: transparent;
    color: var(--accent-color);
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œæƒ…ä¾£æé—®â€æ–°å¢çš„åˆ é™¤æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©æé—®å¡ç‰‡å¯ä»¥ä½œä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½å‚è€ƒç‚¹ */
.ls-question-card {
    position: relative; /* å…³é”®ï¼ */
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.ls-question-delete-btn {
    position: absolute; /* ç»å¯¹å®šä½ï¼Œè®©å®ƒæµ®åŠ¨èµ·æ¥ */
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.08); /* åŠé€æ˜çš„èƒŒæ™¯ */
    color: var(--text-secondary); /* ä½¿ç”¨å…¨å±€çš„æ¬¡è¦æ–‡å­—é¢œè‰² */
    border: none;
    border-radius: 50%; /* åœ†å½¢ */
    font-size: 18px;    /* "Ã—"å·çš„å¤§å° */
    line-height: 24px;  /* è®©"Ã—"å·å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease; /* æ·»åŠ å¹³æ»‘çš„åŠ¨ç”»æ•ˆæœ */
    z-index: 5; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

/* 3. é¼ æ ‡æ‚¬åœåœ¨æ•´å¼ å¡ç‰‡ä¸Šæ—¶ï¼Œæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.ls-question-card:hover .ls-question-delete-btn {
    opacity: 1;
}

/* 4. é¼ æ ‡æ‚¬åœåœ¨åˆ é™¤æŒ‰é’®ä¸Šæ—¶ï¼Œç»™ä¸€ç‚¹åé¦ˆæ•ˆæœ */
.ls-question-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºâ€œåˆ†äº«â€åŠŸèƒ½æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */

.ls-share-item .title {
    font-weight: 600; /* æ ‡é¢˜åŠ ç²— */
}

/* â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤æ¢è¡Œé—®é¢˜ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„ .ls-share-item .summary æ ·å¼ â–¼â–¼â–¼ */
.ls-share-item .summary {
    font-size: 14px;
    color: #666;
    margin-top: 8px;
    line-height: 1.6;
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå…è®¸æ–‡å­—è‡ªåŠ¨æ¢è¡Œ --- */
    white-space: normal;     /* <--- å…è®¸æ¢è¡Œ */
    overflow: visible;       /* <--- å…è®¸å†…å®¹æº¢å‡ºå®¹å™¨ï¼ˆå³æ˜¾ç¤ºå¤šè¡Œï¼‰ */
    text-overflow: clip;     /* <--- ç¦ç”¨çœç•¥å· */
    word-break: break-word;  /* <--- é˜²æ­¢è¶…é•¿å•è¯æˆ–é“¾æ¥æ’‘ç ´å¸ƒå±€ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


#phone-screen.dark-mode .ls-share-item .summary {
    color: #a0a0a0;
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æƒ…ä¾£ç©ºé—´ä¸“å±éŸ³ä¹æ’­æ”¾å™¨çš„CSSæ ·å¼ â–¼â–¼â–¼ */

/* æ’­æ”¾å™¨ä¸»çª—å£çš„é®ç½©å±‚ */
#ls-music-player-overlay {
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* æ’­æ”¾åˆ—è¡¨é¢æ¿çš„æ ·å¼ (ç›´æ¥å¤ç”¨ç°æœ‰çš„) */
#ls-music-playlist-panel {
    /* æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ .music-playlist-panel çš„ç°æœ‰æ ·å¼ï¼Œçœå»é‡å¤ä»£ç  */
}

/* â–²â–²â–² CSSæ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* ã€æ–°å¢ã€‘éšè—æƒ…ä¾£ç©ºé—´æ’­æ”¾å™¨ä¸­ä¸éœ€è¦çš„æŒ‰é’® */
#ls-music-player-overlay #ls-playlist-btn,
#ls-music-player-overlay #ls-prev-btn,
#ls-music-player-overlay #ls-next-btn {
    display: none;
}

/* ã€æ–°å¢ã€‘å±…ä¸­æ’­æ”¾/æš‚åœæŒ‰é’® */
#ls-music-player-overlay .music-controls {
    justify-content: center; /* è®©å‰©ä¸‹çš„æŒ‰é’®å±…ä¸­ */
}

/* â–²â–²â–² CSSä»£ç æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* ã€æ–°å¢ã€‘æƒ…ä¾£ç©ºé—´æ’­æ”¾å™¨å°é¢/æ­Œè¯åˆ‡æ¢æ ·å¼ */
#ls-display-area.show-lyrics #ls-album-cover {
    display: none; /* å½“æœ‰ show-lyrics ç±»æ—¶ï¼Œéšè—å°é¢ */
}
#ls-display-area.show-lyrics #ls-lyrics-container {
    display: block !important; /* å½“æœ‰ show-lyrics ç±»æ—¶ï¼Œæ˜¾ç¤ºæ­Œè¯ */
}

/* ã€æ–°å¢ã€‘æ­Œè¯è¡Œæ ·å¼ */
#ls-lyrics-container .lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    opacity: 0.7;
    transition: all 0.5s ease;
}
#ls-lyrics-container .lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    font-weight: 600;
}
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¾£ç•ªèŒ„é’Ÿæ ·å¼ --- */

/* ä¸»é¡µå¸ƒå±€ */
#ls-pomodoro-home {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

#ls-pomodoro-start-btn-container {
    padding: 20px;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
#ls-pomodoro-start-btn-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.12);
}
#ls-pomodoro-start-icon {
    font-size: 32px;
    color: var(--accent-color);
    line-height: 1;
}
#ls-pomodoro-start-btn-container p {
    margin: 8px 0 0 0;
    font-weight: 500;
    color: var(--text-primary);
}

/* å†å²è®°å½•åˆ—è¡¨ */
#ls-pomodoro-history-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.pomodoro-history-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    cursor: pointer;
}
.pomodoro-history-item:hover {
    background-color: #f9f9f9;
}
.pomodoro-history-item .task {
    font-weight: 500;
    margin-bottom: 5px;
}
.pomodoro-history-item .meta {
    font-size: 12px;
    color: var(--text-secondary);
}

/* â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™æ•´å—ã€é”æœºå…¨å±ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ #ls-pomodoro-timer-active æ ·å¼ â–¼â–¼â–¼ */
#ls-pomodoro-timer-active {
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°†å®šä½æ–¹å¼ä» absolute æ”¹ä¸º fixed */
    /* è¿™ä¼šè®©è®¡æ—¶å™¨ç•Œé¢è„±ç¦»åŸæ¥çš„â€œæƒ…ä¾£ç©ºé—´â€é¡µé¢ï¼Œæµ®åŠ¨åœ¨æ•´ä¸ªæ‰‹æœºå±å¹•çš„æœ€é¡¶å±‚ï¼*/
    position: fixed; 
    
    /* æ ¸å¿ƒä¿®æ”¹2ï¼šç”¨è¿™å››ä¸ªå±æ€§è®©å®ƒæ’‘æ»¡æ•´ä¸ªå±å¹• */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* æ ¸å¿ƒä¿®æ”¹3ï¼šè®¾ç½®ä¸€ä¸ªè¶…é«˜çš„å±‚çº§ï¼Œç¡®ä¿å®ƒèƒ½ç›–ä½æ‰€æœ‰ä¸œè¥¿ï¼Œå®ç°â€œé”æœºâ€æ•ˆæœ */
    z-index: 2000; 
    
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 50px 20px;
    box-sizing: border-box;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);

    /* (å¯é€‰ä¼˜åŒ–) ä¸ºiPhoneçš„åˆ˜æµ·å’Œåº•éƒ¨å°é»‘æ¡ç•™å‡ºå®‰å…¨è·ç¦»ï¼Œè®©ç•Œé¢æ›´ç¾è§‚ */
    padding-top: calc(50px + env(safe-area-inset-top));
    padding-bottom: calc(50px + env(safe-area-inset-bottom));
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼ */
.pomodoro-char-avatar-container {
    position: relative;
    text-align: center;
    width: 100%; /* <-- å°±æ˜¯æ–°å¢äº†è¿™ä¸€è¡Œï¼ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
#pomodoro-char-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.8);
    cursor: pointer;
    transition: transform 0.2s;
}
#pomodoro-char-avatar:active {
    transform: scale(0.9);
}
/* â–¼â–¼â–¼ ç”¨è¿™æ®µã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç å®Œæ•´æ›¿æ¢æ—§çš„ #pomodoro-char-log æ ·å¼ â–¼â–¼â–¼ */
#pomodoro-char-log {
    position: absolute;
    top: 100%;
    margin-top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.65);
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 14px;
    max-width: 80%; /* <-- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼è®©æ°”æ³¡å¯ä»¥å˜å¾—æ›´å®½ */
    width: max-content; /* <-- æ–°å¢ï¼ç¡®ä¿æ°”æ³¡å®½åº¦æ ¹æ®å†…å®¹è‡ªé€‚åº”ï¼Œä½†ä¸ä¼šè¶…è¿‡80% */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, margin-top 0.3s; /* margin-topè®©åŠ¨ç”»æ›´å¹³æ»‘ */
    pointer-events: none;
    white-space: pre-wrap;
    box-sizing: border-box; /* æ–°å¢ï¼é˜²æ­¢å†…è¾¹è·å¯¼è‡´å¸ƒå±€é—®é¢˜ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


#pomodoro-char-log::after {
    content: '';
    position: absolute;
    bottom: 100%; /* <-- ä¿®æ”¹è¿™é‡Œ */
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border: 6px solid transparent;
    border-bottom-color: rgba(0,0,0,0.65); /* <-- ä¿®æ”¹è¿™é‡Œ */
}


#pomodoro-char-log.visible {
    opacity: 1;
    visibility: visible; /* æ–°å¢ */
    margin-bottom: 22px; /* æ ¸å¿ƒä¿®å¤3: æ˜¾ç¤ºæ—¶å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œæœ‰ä¸€ä¸ªâ€œå†’å‡ºæ¥â€çš„åŠ¨ç”»æ•ˆæœ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



/* æ—¶é—´å’Œä»»åŠ¡æ˜¾ç¤º */
.pomodoro-timer-display {
    text-align: center;
}
#pomodoro-current-task {
    font-size: 20px;
    font-weight: 500;
    margin-bottom: 10px;
}
#pomodoro-time {
    font-size: 72px;
    font-weight: 200;
    letter-spacing: 2px;
}

/* ç»“æŸæŒ‰é’® */
#pomodoro-end-btn {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    border: 2px solid white;
    background-color: rgba(255,255,255,0.2);
    color: white;
    border-radius: 25px;
    cursor: pointer;
}

/* å†å²è¯¦æƒ…å¼¹çª—å†…çš„èŠå¤©æ°”æ³¡ */
#pomodoro-history-viewer-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.pomodoro-log-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 80%;
    background-color: #f0f0f0;
    align-self: flex-start;
    line-height: 1.5;
}
#phone-screen.dark-mode .pomodoro-log-bubble {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* --- ä¿®å¤æ–°å¢åŠŸèƒ½å¯¼è‡´çš„æ»šåŠ¨æ¡é—®é¢˜ --- */

/* 1. å¼ºåˆ¶éšè—ä½ ä¸è¦çš„â€œæƒ…ä¾£ç©ºé—´æ’­æ”¾åˆ—è¡¨â€ */
#ls-music-playlist-panel {
    display: none !important;
}

/* 2. ç¡®ä¿ä¸»å±å¹•å®¹å™¨ç»å¯¹ä¸ä¼šå‡ºç°æ»šåŠ¨æ¡ï¼Œå®ç°å›ºå®šæ•ˆæœ */
#phone-screen {
    overflow: hidden !important;
}



/* === ã€åœˆå­è¯„è®ºåŒºç»ˆæä¿®å¤ - è¦†ç›–ç»§æ‰¿ç‰ˆã€‘ === */

/* 
   é—®é¢˜æ ¹æºï¼šåœˆå­è¯„è®ºåŒº(#post-comment-input-area)é”™è¯¯åœ°ç»§æ‰¿äº†
   ä¸»èŠå¤©è¾“å…¥åŒº(.chat-input-area)çš„æ ·å¼ï¼Œå¯¼è‡´å¸ƒå±€é”™ä¹±ã€‚
   ä»¥ä¸‹ä»£ç å°†é’ˆå¯¹åœˆå­å±å¹•(#post-screen)ä¸‹çš„è¯„è®ºåŒºè¿›è¡Œå¼ºåˆ¶è¦†ç›–ã€‚
*/

/* 1. å¼ºåˆ¶é‡ç½®è¯„è®ºåŒºå®¹å™¨çš„å¸ƒå±€ï¼Œè®©å®ƒæ°´å¹³æ’åˆ—ã€å‚ç›´å±…ä¸­ */
#post-screen #post-comment-input-area {
    display: flex !important;
    flex-direction: row !important; /* å¼ºåˆ¶æ¨ªå‘æ’åˆ— */
    align-items: center !important;  /* å¼ºåˆ¶å‚ç›´å±…ä¸­ï¼Œå®ç°å¹³è¡Œ */
    gap: 10px !important;            /* è®¾ç½®è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„é—´è· */
}

/* 2. ç¡®ä¿å†…å±‚å®¹å™¨ä¹Ÿæ­£ç¡®ä¼¸å±• */
#post-screen #post-comment-input-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

/* 3. å¼ºåˆ¶è¾“å…¥æ¡†çš„æ ·å¼ï¼Œå¹¶è®©å®ƒå¡«æ»¡ç©ºé—´ */
#post-screen #post-comment-input {
    flex-grow: 1 !important; /* è§£å†³å³ä¾§ç©ºç™½çš„å…³é”®ï¼ */
    min-height: 40px;
    background-color: #f0f2f5 !important;
    border-radius: 20px !important;
    border: none !important;
    padding: 10px 15px !important;
    font-size: 14px !important;
    line-height: 1.5;
    resize: none;
    box-sizing: border-box;
}

/* 4. å¼ºåˆ¶å‘é€æŒ‰é’®çš„æ ·å¼ */
#post-screen #send-post-comment-btn {
    height: 40px !important;
    padding: 0 20px !important;
    border-radius: 20px !important;
    background-color: var(--accent-color) !important;
    color: white !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    border: none !important;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #post-screen #post-comment-input {
    background-color: #2c2c2e !important;
}
/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„ä¸»å±å¹•æ»‘åŠ¨æ ·å¼ â–¼â–¼â–¼ */

/* ä¸»å±å¹•æ»‘åŠ¨å®¹å™¨ */
.home-screen-slider {
    width: 100%;
    height: 100%; /* ç¡®ä¿å®ƒèƒ½æ’‘æ»¡çˆ¶å®¹å™¨ */
    display: flex; /* è®©ä¸¤é¡µå¹¶æ’ç«™å¥½ */
    overflow-x: auto; /* å…è®¸æ°´å¹³æ»šåŠ¨ */
    overflow-y: hidden; /* ç¦æ­¢å‚ç›´æ»šåŠ¨ */
    scroll-snap-type: x mandatory; /* è¿™å°±æ˜¯æ»‘åŠ¨çš„é­”æ³•ï¼è®©å®ƒè‡ªåŠ¨å¸é™„åˆ°æ¯ä¸€é¡µ */
    -webkit-overflow-scrolling: touch; /* åœ¨iOSä¸Šå®ç°æ›´å¹³æ»‘çš„æ»šåŠ¨ */
    scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ (Firefox) */
    -ms-overflow-style: none;  /* éšè—æ»šåŠ¨æ¡ (IE) */
}
.home-screen-slider::-webkit-scrollbar {
    display: none; /* éšè—æ»šåŠ¨æ¡ (Chrome, Safari) */
}

.home-page {
    width: 100%; /* æ¯ä¸€é¡µéƒ½å æ»¡æ•´ä¸ªå±å¹•å®½åº¦ */
    height: 100%;
    flex-shrink: 0; /* é˜²æ­¢é¡µé¢è¢«å‹ç¼©å˜å½¢ */
    scroll-snap-align: start; /* ç¡®ä¿æ¯æ¬¡éƒ½å¯¹é½é¡µé¢çš„å¼€å§‹ä½ç½® */
    
    /* è®©é¡µé¢å†…éƒ¨çš„å†…å®¹å¯ä»¥æ»šåŠ¨ */
    overflow-y: auto;
    padding: 0 20px; /* ä¿æŒå’Œä½ åŸæ¥ä¸€æ ·çš„å·¦å³è¾¹è· */
    box-sizing: border-box;
    position: relative; /* â˜…â˜…â˜… åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œï¼ â˜…â˜…â˜… */
}


/* åˆ†é¡µå°åœ†ç‚¹çš„å®¹å™¨ */
.pagination-dots {
    position: absolute;
    bottom: calc(100px + env(safe-area-inset-bottom)); /* æ”¾åœ¨Dockæ ä¸Šæ–¹ */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px; /* åœ†ç‚¹ä¹‹é—´çš„é—´è· */
}

/* å•ä¸ªå°åœ†ç‚¹ */
.pagination-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.4); /* æœªé€‰ä¸­æ—¶çš„é¢œè‰² */
    transition: background-color 0.3s ease; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„é¢œè‰²è¿‡æ¸¡åŠ¨ç”» */
}

/* è¢«é€‰ä¸­çš„å°åœ†ç‚¹ */
.pagination-dots .dot.active {
    background-color: rgba(255, 255, 255, 0.9); /* é€‰ä¸­æ—¶å˜å¾—æ›´äº® */
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* è¿™æ˜¯ç¬¬äºŒé¡µå¸ƒå±€çš„å…¨æ–°æ ·å¼ (V2 ç¾åŒ–ç‰ˆ) */

/* 1. æŠŠå¤´åƒå°ç»„ä»¶å®šä½åˆ°å·¦åŠå±çš„ä¸­é—´ */
#second-page-left-widget {
    position: absolute;
    top: 50px; 
    left: 25%; 
    transform: translateX(-50%); 
}

/* â˜…â˜…â˜… è¿™æ˜¯ä¸ºå¤´åƒå°ç»„ä»¶æ–°å¢çš„æ”¾å¤§å’Œç»†è¾¹æ¡†æ ·å¼ â˜…â˜…â˜… */
#second-page-left-widget .widget-circle-uploader {
    width: 65px;  /* å¤´åƒå®½åº¦ä» 65px æ”¾å¤§åˆ° 80px */
    height: 65px; /* å¤´åƒé«˜åº¦ä» 65px æ”¾å¤§åˆ° 80px */
    border-width: 1px; /* è½®å»“çº¿ä» 2px å‡å°åˆ° 1pxï¼Œå˜å¾—å¾ˆç»† */
    padding: 1px; /* â˜…â˜…â˜… åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œï¼ŒæŠŠç¼éš™å‡å°åˆ°1åƒç´  â˜…â˜…â˜… */
}
/* 2. æŠŠå³ä¸Šè§’çš„å›¾æ ‡æ”¹ä¸ºå¹¶æ’æ’åˆ— */
#second-page-top-right-apps {
    position: absolute;
    top: 50px;
    right: 30px;
    display: flex;
    gap: 30px; /* â˜…â˜…â˜… å›¾æ ‡é—´è·ä» 25px å¢åŠ åˆ° 30pxï¼Œæ‹‰å¼€è·ç¦» â˜…â˜…â˜… */
}

/* 3. æ–‡å­—é¢œè‰²æ ·å¼ä¿æŒä¸å˜ */
#second-page-top-right-apps .desktop-app-icon .label {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘å®Œæ•´æ›¿æ¢æ‰ä½ ä¸Šæ¬¡æ·»åŠ çš„ã€å…³äºç¬¬äºŒé¡µå¤´åƒçš„æ‰€æœ‰CSS â–¼â–¼â–¼ */

/* 1. å®¹å™¨ï¼šç§»é™¤å…ƒç´ é—´è·ï¼Œè®©å¤´åƒå’Œæ°”æ³¡é æ‹¢ (ä¿æŒä¸å˜) */
#second-page-left-widget {
    /* â˜…â˜…â˜… åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªå®½åº¦ï¼Œä½œä¸ºâ€œä¸»å®½åº¦â€ â˜…â˜…â˜… */
    width: 150px;
    gap: 0;
}

#second-page-bubble {
    margin-top: -10px;
    padding: 10px 15px;
    border-radius: 30px;
    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹1ï¼šç§»é™¤ min-width å’Œ display: inline-block â˜…â˜…â˜… */
    /* min-width: 140px; */
    /* display: inline-block; */

    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹2ï¼šæ·»åŠ ä¸‹é¢è¿™ä¸‰è¡Œï¼Œè®©å®ƒå æ»¡çˆ¶å®¹å™¨å®½åº¦å¹¶å±…ä¸­ â˜…â˜…â˜… */
    width: 100%;
    box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šæ’‘ç ´å¸ƒå±€ */
    text-align: center;     /* è®©æ–‡å­—åœ¨å˜å®½çš„å®¹å™¨é‡Œå±…ä¸­ */
    
    background-color: rgba(255, 255, 255, 0.4);
    color: #1c1c1e;
    text-shadow: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    z-index: 1;
}



/* â˜…â˜…â˜… ä¿®æ”¹ç‚¹2ï¼šåœ¨è¿™é‡Œæ˜ç¡®ç§»é™¤é‚£ä¸ªä¸æƒ³è¦çš„å°–è§’ â˜…â˜…â˜… */
#second-page-bubble::after {
    content: none; /* å¼ºåˆ¶ç§»é™¤ç»§æ‰¿è‡ª .widget-bubble çš„å°–è§’ä¼ªå…ƒç´  */
}

/* 3. æå‡å¤´åƒå±‚çº§ (ä¿æŒä¸å˜) */
#second-page-left-widget .widget-circle-uploader {
    position: relative; 
    z-index: 2;         
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. æ–°å¢æ°”æ³¡çš„å®¹å™¨ï¼Œè´Ÿè´£æ•´ä½“å¸ƒå±€å’Œå®½åº¦ */
#new-bubbles-container {
    display: flex;
    align-items: center;
    gap: 8px;
    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°†å›ºå®šçš„ 180px æ”¹ä¸º 100%ï¼Œè®©å®ƒè‡ªåŠ¨è·Ÿéšçˆ¶å®¹å™¨ â˜…â˜…â˜… */
    width: 100%;
    margin-top: 8px;
}


/* â–¼â–¼â–¼ ç”¨è¿™å—ã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ—§çš„ #flat-capsule-bubble æ ·å¼ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®æ”¹åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ #flat-capsule-bubble æ ·å¼ â–¼â–¼â–¼ */
#flat-capsule-bubble {
    flex-grow: 1;
    min-width: auto;
    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹1ï¼šé«˜åº¦ä» 44px å‡å°åˆ° 38px â˜…â˜…â˜… */
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 15px;
    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹2ï¼šæ–°å¢èƒŒæ™¯è‰²ï¼Œå°†é€æ˜åº¦ä» 0.4 æå‡åˆ° 0.6ï¼Œè®©å®ƒæ›´ä¸é€æ˜ â˜…â˜…â˜… */
    background-color: rgba(255, 255, 255, 0.4);
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

#flat-capsule-bubble::after {
    content: none; /* ç§»é™¤ç»§æ‰¿æ¥çš„å°å°¾å·´ */
}


/* â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®æ”¹åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ #circular-bubble æ ·å¼ â–¼â–¼â–¼ */
#circular-bubble {
    flex-shrink: 0;
    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹1ï¼šå®½åº¦å’Œé«˜åº¦éƒ½ä» 44px å‡å°åˆ° 38px â˜…â˜…â˜… */
    width: 35px;
    height: 35px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-width: auto;
    /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹2ï¼šæ–°å¢èƒŒæ™¯è‰²ï¼Œä¸èƒ¶å›Šæ°”æ³¡ä¿æŒä¸€è‡´ï¼Œæ›´ä¸é€æ˜ â˜…â˜…â˜… */
    background-color: rgba(255, 255, 255, 0.4);
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 4. ç§»é™¤åœ†å½¢æ°”æ³¡çš„å°å°¾å·´ */
#circular-bubble::after {
    content: none;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. æ–°å¤´åƒç»„ä»¶çš„å®šä½ï¼šä¸­é—´åä¸Š */
#second-page-center-avatar {
    position: absolute;
    top: 235px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•°å€¼è¶Šå°è¶Šé ä¸Š */
    transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
    z-index: 5; /* ç¡®ä¿å®ƒåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
}

/* 2. æ–°å¤´åƒçš„å°ºå¯¸å’Œæ ·å¼ï¼šæ¯”ç¬¬ä¸€ä¸ªå¤§ï¼Œä¸”æ²¡æœ‰è½®å»“çº¿ */
#second-page-center-avatar .widget-circle-uploader {
    width: 85px;  /* æ¯”ç¬¬ä¸€ä¸ªå¤´åƒ(65px)å¤§ä¸€åœˆ */
    height: 85px; /* ä¿æŒæ­£åœ† */
    border: none; /* ç§»é™¤è½®å»“çº¿ */
    padding: 0;   /* ç§»é™¤å†…è¾¹è·ï¼Œè®©å›¾ç‰‡å¡«æ»¡ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è¿™æ˜¯åŒ…è£¹å¤´åƒå’Œæ‰€æœ‰æ–°æ°”æ³¡çš„æ€»å®¹å™¨ (V2 åŠ å¤§ç‰ˆ) */
/* 1. è¿™æ˜¯åŒ…è£¹å¤´åƒå’Œæ‰€æœ‰æ–°æ°”æ³¡çš„æ€»å®¹å™¨ (V2 åŠ å¤§ç‰ˆ) */
#center-avatar-wrapper {
    position: absolute;
    /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°†å›ºå®šå€¼æ”¹ä¸ºå¯è°ƒèŠ‚çš„å˜é‡ï¼Œå¹¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼ 190px */
    top: var(--second-page-center-avatar-top-offset, 190px); 
    transform: translateX(-55%);
    z-index: 5;
    
    /* â˜… ä¿®æ”¹ç‚¹ï¼šæŠŠè¿™ä¸ªâ€œçœ‹ä¸è§çš„ç›’å­â€çš„å°ºå¯¸å˜å¤§ */
    width: 300px;  /* ä» 250px å¢åŠ åˆ°äº† 300px */
    height: 180px; /* ä» 150px å¢åŠ åˆ°äº† 180px */
}





/* 2. æŠŠä½ åŸæ¥çš„å¤´åƒåœ¨æ€»å®¹å™¨é‡Œå±…ä¸­ï¼Œè¿™æ ·å®ƒçš„ä½ç½®çœ‹èµ·æ¥å’ŒåŸæ¥ä¸€æ¨¡ä¸€æ · */
#second-page-center-avatar {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    /* æˆ‘ä»¬ä¸å†éœ€è¦å®ƒè‡ªå·±æ¥å®šä½äº†ï¼Œæ‰€ä»¥æŠŠæ—§çš„å®šä½æ ·å¼ç§»é™¤ */
}

#avatar-subtitle {
    position: absolute;
    bottom:  20px; /* â˜… ä¿®æ”¹ç‚¹ï¼šæŠŠå®ƒä»å®¹å™¨å¤–é¢ç§»åˆ°é‡Œé¢ï¼Œä½ç½®æ›´åè°ƒ */
    left: 50%;
    transform: translateX(-50%);
    
    background-color: transparent;
    border: none;
    outline: none;
    
    color: white;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    cursor: pointer;
    padding: 2px 8px;
}


/* è¿™æ˜¯å››ä¸ªè§’è½æ°”æ³¡çš„é€šç”¨æ ·å¼ */
.corner-bubble {
    position: absolute;
    background-color: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 8px 12px;
    color: white;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    min-width: 80px; 
    cursor: pointer;
}

/* â–¼â–¼â–¼ åœ¨è¿™é‡Œåˆ†åˆ«ä¿®æ”¹å››ä¸ªè§’è½çš„ä½ç½® â–¼â–¼â–¼ */

/* 5. åˆ†åˆ«å®šä½å››ä¸ªè§’è½çš„æ°”æ³¡ */
#bubble-top-left {
    top: 40px;    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€ä¸‹ã€‘ç§» */
    left: -15px;   /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€å³ã€‘ç§» */
}

#bubble-top-right {
    top: 40px;    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€ä¸‹ã€‘ç§» */
    right: -15px;  /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€å·¦ã€‘ç§» */
}

#bubble-bottom-left {
    bottom: 40px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€ä¸Šã€‘ç§» */
    left: -15px;   /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€å³ã€‘ç§» */
}

#bubble-bottom-right {
    bottom: 40px; /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€ä¸Šã€‘ç§» */
    right: -15px;  /* æ§åˆ¶å·¦å³ä½ç½®ï¼Œæ•°å€¼è¶Šå¤§è¶Šã€å¾€å·¦ã€‘ç§» */
}
/* â–¼â–¼â–¼ ã€è¿™æ˜¯ä¿®æ”¹åçš„ç‰ˆæœ¬ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼ */

/* 1. æ€»å®¹å™¨ï¼šç§»é™¤äº†é¡¶éƒ¨çš„å†…è¾¹è· */
#new-custom-widget {
    position: absolute;
    bottom: 30px;
    right: 20px;
    width: 50%;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
    /* padding-top: 50px;  <-- è¿™è¡Œå·²ç»è¢«åˆ æ‰äº† */
}

/* 2. ã€å…¨æ–°ã€‘å¤´éƒ¨å®¹å™¨ï¼šè´Ÿè´£è®©æœˆä»½å’Œå¤´åƒæ°´å¹³æ’åˆ— */
/* è¿™æ˜¯å¤´éƒ¨å®¹å™¨ï¼šè´Ÿè´£è®©æœˆä»½å’Œå¤´åƒæ°´å¹³æ’åˆ— */
#new-widget-header {
    width: 100%;
    display: flex;
    justify-content: flex-end; /* ä¿®æ”¹ï¼šè®©æ‰€æœ‰å†…å®¹éƒ½é å³å¯¹é½ */
    align-items: center;
    gap: 70px; /* æ–°å¢ï¼šåœ¨æœˆä»½å’Œå¤´åƒä¹‹é—´åŠ ä¸€ç‚¹é—´è· */
    margin-bottom: 5px;
}



/* 3. æœˆä»½ï¼šç§»é™¤äº†ç»å¯¹å®šä½ï¼Œç°åœ¨æ˜¯æ™®é€šçš„flexé¡¹ç›® */
#widget-month-display {
    font-size: 25px;
    font-weight: 300;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    line-height: 1;
}

/* 4. å¤´åƒï¼šç§»é™¤äº†ä¸å¿…è¦çš„æ ·å¼ï¼Œå› ä¸ºå¸ƒå±€ç”±çˆ¶å®¹å™¨æ§åˆ¶äº† */
#new-custom-widget #new-widget-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    outline: none;
}

/* 5. å¯ç¼–è¾‘æ–‡å­—å’Œåˆ†å‰²çº¿ (ä¿æŒä¸å˜) */
#new-custom-widget .new-widget-text {
    background: transparent;
    border: none;
    outline: none;
    padding: 2px 4px;
    border-radius: 3px;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    font-size: 13px;
    text-align: right;
    width: 100%;
    box-sizing: border-box;
}

#new-custom-widget .new-widget-divider {
    width: 60%;
    height: 1px;
    border-top: 1px dashed rgba(255, 255, 255, 0.3);
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€ç²¾è‡´ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„è®ºå›å¸–å­åˆ é™¤æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¸–å­åˆ—è¡¨é¡¹æ ·å¼ (ä¿æŒä¸å˜ï¼Œåªæ˜¯ç¡®ä¿å³ä¾§æœ‰è¶³å¤Ÿç©ºé—´) */
.forum-post-item {
    position: relative;
    padding-right: 40px; 
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ–°æ ·å¼ - å°å·§ç²¾è‡´ç‰ˆ */
.forum-post-delete-btn {
    position: absolute;
    top: 50%;
    right: 12px; /* ç¦»è¾¹ç¼˜ç¨å¾®è¿‘ä¸€ç‚¹ */
    transform: translateY(-50%);

    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå°ºå¯¸å˜å° --- */
    width: 24px;
    height: 24px;

    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå¤–è§‚æ›´ç²¾è‡´ --- */
    background-color: transparent; /* é»˜è®¤èƒŒæ™¯é€æ˜ï¼Œä¸çªå…€ */
    color: var(--text-secondary);  /* é»˜è®¤é¢œè‰²ä½¿ç”¨æ¬¡è¦æ–‡å­—çš„ç°è‰²ï¼Œæ›´æŸ”å’Œ */
    border: none;
    border-radius: 50%;
    font-size: 18px;      /* å‡å° "Ã—" çš„å¤§å° */
    line-height: 24px;    /* ç¡®ä¿ "Ã—" å‚ç›´å±…ä¸­ */
    text-align: center;
    cursor: pointer;
    
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šäº¤äº’åŠ¨æ•ˆ --- */
    transition: all 0.2s ease; /* ä¸ºæ‰€æœ‰å˜åŒ–æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
}

/* 3. é¼ æ ‡æ‚¬åœæ—¶çš„åé¦ˆæ•ˆæœ */
.forum-post-delete-btn:hover {
    background-color: #ff3b30; /* æ‚¬åœæ—¶æ‰æ˜¾ç¤ºé†’ç›®çš„çº¢è‰²èƒŒæ™¯ */
    color: white;              /* "Ã—" å˜ä¸ºç™½è‰² */
    transform: translateY(-50%) scale(1.1); /* è½»å¾®æ”¾å¤§ï¼Œæ›´æœ‰åŠ¨æ„Ÿ */
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* 1. å®šä¹‰ä¸€ä¸ªé€šç”¨çš„ã€æ§åˆ¶æ‰€æœ‰ä¸»å±å¹•æ–‡å­—é¢œè‰²çš„å˜é‡ (ä¿æŒä¸å˜) */
#phone-screen {
    --home-icon-widget-text-color: #FFFFFF;
}

/* 2. ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€ä¸ªâ€œè¶…çº§é€‰æ‹©å™¨â€ï¼Œä¸€æ¬¡æ€§é€‰ä¸­æ‰€æœ‰éœ€è¦å˜è‰²çš„æ–‡å­— */
/* è¿™æ¬¡æˆ‘ä»¬åŠ å…¥äº†é¡¶éƒ¨çŠ¶æ€æ å’Œåº•éƒ¨Dockæ çš„å›¾æ ‡æ–‡å­— */
.desktop-app-icon .label,                        /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤äº†å‰é¢çš„IDé™å®šï¼Œè®©å®ƒèƒ½åŒæ—¶é€‰ä¸­ä¸»å±å¹•å’ŒDockæ çš„å›¾æ ‡æ–‡å­— â–¼â–¼â–¼ */
#desktop-widget-column .widget-bubble,           
#desktop-widget-column .widget-subtext,        
#second-page-left-widget .widget-bubble,           
#second-page-left-widget .widget-subtext,        
#avatar-subtitle,                                
.corner-bubble,                                   
#new-custom-widget .new-widget-text,              
#widget-month-display,
#status-bar                                     /* â˜…â˜…â˜… æ–°å¢ï¼šé¡¶éƒ¨çŠ¶æ€æ  â˜…â˜…â˜… */
{
    color: var(--home-icon-widget-text-color) !important;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6) 
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å»é™¤ä¸»å±å¹•å­—ä½“é˜´å½±çš„æ ·å¼ â–¼â–¼â–¼ */
#phone-screen.no-home-font-shadow .app-icon .label,
#phone-screen.no-home-font-shadow .desktop-app-icon .label,
#phone-screen.no-home-font-shadow .widget-bubble,
#phone-screen.no-home-font-shadow .widget-subtext,
#phone-screen.no-home-font-shadow #avatar-subtitle,
#phone-screen.no-home-font-shadow .corner-bubble,
#phone-screen.no-home-font-shadow .new-widget-text,
#phone-screen.no-home-font-shadow #widget-month-display,
#phone-screen.no-home-font-shadow #profile-username,
#phone-screen.no-home-font-shadow #profile-sub-username,
#phone-screen.no-home-font-shadow #profile-bio,
#phone-screen.no-home-font-shadow #profile-location,
#phone-screen.no-home-font-shadow #clock-container {
    text-shadow: none !important;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšä¸»é¡µå¤´åƒæ¡†çš„ä¸“å±æ ·å¼ â–¼â–¼â–¼ */
.weibo-avatar-container .weibo-avatar-frame{
    position: absolute;
    width: 121%; /* ç›¸å¯¹å¤§å°ï¼Œä½ å¯ä»¥å¾®è°ƒ */
    height: 121%;
    /* ä½¿ç”¨transformè¿›è¡Œç²¾ç¡®å®šä½ï¼Œç¡®ä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¡®ä¿åœ¨å¤´åƒä¹‹ä¸Š */
    pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}


/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšå¸–å­ä½œè€…å¤´åƒæ¡†çš„ä¸“å±æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯å¸–å­å¤´éƒ¨ï¼Œå¤´åƒå’Œæ¡†çš„æ€»å®¹å™¨ */
.weibo-post-header .avatar-with-frame {
    position: relative;
    /* æ ¸å¿ƒï¼šå°ºå¯¸å’ŒåŸæ¥çš„å¤´åƒä¿æŒä¸€è‡´ */
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}

/* å®¹å™¨å†…çš„å¤´åƒå›¾ç‰‡ */
.weibo-post-header .avatar-with-frame .avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1; /* ç¡®ä¿åœ¨æ¡†çš„ä¸‹é¢ */
}

/* å®¹å™¨å†…çš„å¤´åƒæ¡†å›¾ç‰‡ */
.weibo-post-header .avatar-with-frame .avatar-frame {
    position: absolute;
    width: 121%; /* ç›¸å¯¹å¤§å°ï¼Œä½ å¯ä»¥å¾®è°ƒ */
    height: 121%;
    /* ä½¿ç”¨transformè¿›è¡Œç²¾ç¡®å®šä½ï¼Œç¡®ä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¡®ä¿åœ¨å¤´åƒä¹‹ä¸Š */
    pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸»å±å¹•å¤´åƒæ¡†çš„ä¸“å±æ ·å¼ â–¼â–¼â–¼ */
#profile-widget .profile-avatar-container .weibo-avatar-frame {
    position: absolute;
    width: 121%; /* ç›¸å¯¹å¤§å°ï¼Œä½ å¯ä»¥å¾®è°ƒ */
    height: 121%;
    /* ä½¿ç”¨transformè¿›è¡Œç²¾ç¡®å®šä½ï¼Œç¡®ä¿å®Œç¾å±…ä¸­ */
    transform: translate(-50%, -57%);
    top: 50%;
    left: 50%;
    z-index: 4; /* ç¡®ä¿åœ¨å¤´åƒä¹‹ä¸Š */
    pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶å¯ä»¥ç©¿é€å®ƒ */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ æŠŠè¿™æ®µå…¨æ–°çš„CSSï¼Œç²˜è´´åˆ°ä½  <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

.weibo-background {
    /* æ ¸å¿ƒä»£ç ï¼šä½¿ç”¨ mask-image åˆ›å»ºä¸€ä¸ªä»ä¸Šåˆ°ä¸‹çš„æ¸å˜è’™ç‰ˆ */
    
    /* a. -webkit- å‰ç¼€æ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆçš„ Chrome å’Œ Safari æµè§ˆå™¨ */
    -webkit-mask-image: linear-gradient(
        to bottom,          /* æ¸å˜æ–¹å‘ï¼šä»ä¸Šåˆ°ä¸‹ */
        
        /* â˜…â˜…â˜… è¿™é‡Œæ˜¯ä½ å¯ä»¥è‡ªå·±è°ƒæ•´çš„åœ°æ–¹ â˜…â˜…â˜… */
        black 60%,          /* å‰60%çš„éƒ¨åˆ†æ˜¯å®Œå…¨ä¸é€æ˜çš„ (é»‘è‰²=ä¸é€æ˜) */
        transparent 100%    /* ä»60%çš„ä½ç½®å¼€å§‹ï¼Œåˆ°åº•éƒ¨(100%)ï¼Œé€æ¸è¿‡æ¸¡åˆ°å®Œå…¨é€æ˜ */
    );
    
    /* b. è¿™æ˜¯æ ‡å‡†è¯­æ³•ï¼Œå…¼å®¹ç°ä»£æµè§ˆå™¨ */
    mask-image: linear-gradient(
        to bottom,
        black 60%,
        transparent 100%
    );
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­åˆ†ç±»æ ‡ç­¾æ ·å¼ â–¼â–¼â–¼ */
.category-tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.category-tag {
    font-size: 11px;
    font-weight: 500;
    color: var(--accent-color);
    background-color: #e7f3ff;
    padding: 3px 8px;
    border-radius: 10px;
}
#phone-screen.dark-mode .category-tag {
    background-color: rgba(10, 132, 255, 0.2);
    color: #0A84FF;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°ç»„åˆ†ç±»ç­›é€‰åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* ç­›é€‰å›¾æ ‡çš„æ ·å¼ */
.header .filter-btn {
    font-size: 20px; /* å›¾æ ‡å¤§å° */
    cursor: pointer;
    color: var(--accent-color); /* è·Ÿéšä¸»é¢˜è‰² */
    position: relative; /* ä¸ºäº†å®šä½å°çº¢ç‚¹ */
}

/* å½“ç­›é€‰ç”Ÿæ•ˆæ—¶ï¼Œå›¾æ ‡ä¸Šæ˜¾ç¤ºä¸€ä¸ªå°ç‚¹æç¤º */
.header .filter-btn.active::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 8px;
    height: 8px;
    background-color: #ff3b30;
    border-radius: 50%;
    border: 1.5px solid var(--secondary-bg);
}

/* ç­›é€‰å¼¹çª—å†…çš„åˆ†ç±»åˆ—è¡¨ */
#forum-filter-category-list {
    display: flex;
    flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
    gap: 10px; /* æ ‡ç­¾ä¹‹é—´çš„é—´è· */
    padding: 10px;
}

#forum-filter-category-list label {
    display: inline-flex;
    align-items: center;
    background-color: #f0f2f5;
    padding: 6px 12px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

#phone-screen.dark-mode #forum-filter-category-list label {
    background-color: #3a3a3c;
}

#forum-filter-category-list input[type="checkbox"] {
    display: none; /* éšè—åŸå§‹çš„å¤é€‰æ¡† */
}

/* é€‰ä¸­åçš„æ ·å¼ */
#forum-filter-category-list input[type="checkbox"]:checked + span {
    color: white;
    font-weight: 500;
}

/* é»˜è®¤ç»™æ ‡ç­¾ä¸€ä¸ªå¥½çœ‹çš„é¢œè‰²å¾ªç¯ */
#forum-filter-category-list label:nth-of-type(6n+1) input:checked + span { background-color: #007bff; }
#forum-filter-category-list label:nth-of-type(6n+2) input:checked + span { background-color: #28a745; }
#forum-filter-category-list label:nth-of-type(6n+3) input:checked + span { background-color: #fd7e14; }
#forum-filter-category-list label:nth-of-type(6n+4) input:checked + span { background-color: #6f42c1; }
#forum-filter-category-list label:nth-of-type(6n+5) input:checked + span { background-color: #dc3545; }
#forum-filter-category-list label:nth-of-type(6n+6) input:checked + span { background-color: #ffc107; }

/* æ ‡ç­¾å†…çš„æ–‡å­—éƒ¨åˆ†ï¼Œä¹Ÿéœ€è¦è®¾ç½®æ ·å¼ï¼Œç‰¹åˆ«æ˜¯é€‰ä¸­åçš„èƒŒæ™¯è‰² */
#forum-filter-category-list label span {
    padding: 6px 12px;
    margin: -6px -12px; /* æŠµæ¶ˆlabelçš„paddingï¼Œè®©èƒŒæ™¯è‰²å¡«æ»¡ */
    border-radius: 15px;
    transition: all 0.2s ease;
}
/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸¸æˆå¤§å…æ ·å¼ â–¼â–¼â–¼ */
#game-hall-grid {
    display: grid;
    grid-template-columns: 1fr; /* æ¯è¡Œä¸€ä¸ªæ¸¸æˆ */
    gap: 15px; /* æ¸¸æˆå¡ç‰‡ä¹‹é—´çš„é—´è· */
}

.game-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.game-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.game-card .game-icon {
    font-size: 32px;
    width: 50px;
    height: 50px;
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f0f2f5;
    border-radius: 10px;
}

#phone-screen.dark-mode .game-card .game-icon {
    background-color: #2c2c2e;
}

.game-card .game-info .game-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--text-primary);
}

.game-card .game-info .game-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 4px;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ€æ¸¸æˆæ ·å¼ â–¼â–¼â–¼ */

/* æ¸¸æˆè®¾ç½®é¡µçš„ç©å®¶é€‰æ‹©åˆ—è¡¨ */
.player-selection-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
}
.player-selection-item:last-child {
    border-bottom: none;
}
.player-selection-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
}
.player-selection-item img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}
.player-selection-item .name {
    font-weight: 500;
}
.player-selection-item .type-tag {
    font-size: 11px;
    color: var(--text-secondary);
    background-color: #f0f0f0;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: auto;
}

/* æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ */
#werewolf-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

/* ç©å®¶åº§ä½ç½‘æ ¼ */
#werewolf-players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 10px;
    padding: 10px;
    flex-shrink: 0;
}

.player-seat {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.player-seat .player-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid transparent;
    object-fit: cover;
    transition: all 0.3s ease;
}
.player-seat .player-avatar.speaking {
    border-color: #4cd964; /* ç»¿è‰²è¾¹æ¡†è¡¨ç¤ºæ­£åœ¨å‘è¨€ */
    box-shadow: 0 0 10px #4cd964;
}
.player-seat .player-avatar.dead {
    filter: grayscale(100%);
    opacity: 0.5;
}
.player-seat .player-name {
    font-size: 12px;
    font-weight: 500;
    text-align: center;
    max-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.player-seat .player-role-indicator {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background-color: #ff3b30; /* çº¢è‰²ä»£è¡¨ç‹¼äºº */
    color: white;
    font-size: 12px;
    font-weight: bold;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
    border: 1px solid white;
}

/* æ¸¸æˆæ—¥å¿—åŒºåŸŸ */
#werewolf-log-container {
    flex-grow: 1;
    background-color: rgba(0,0,0,0.05);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    margin: 10px 0;
    min-height: 0; /* flexå¸ƒå±€ä¸‹æ»šåŠ¨çš„å…³é”® */
}
.log-entry {
    padding: 6px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    font-size: 14px;
    line-height: 1.5;
}
.log-entry.system {
    color: var(--accent-color);
    font-weight: bold;
    text-align: center;
    background-color: rgba(0, 123, 255, 0.05);
    border-radius: 5px;
}
.log-entry.speech .speaker {
    font-weight: 600;
}

/* ç©å®¶æ“ä½œåŒº */
#werewolf-action-area {
    flex-shrink: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    min-height: 50px;
}
#werewolf-action-area button {
    padding: 10px 20px;
}
#werewolf-action-area .vote-target-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}
#werewolf-action-area .vote-target-btn {
    padding: 8px 12px;
    font-size: 13px;
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#werewolf-action-area .vote-target-btn.selected {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
/* â–²â–²â–² ç‹¼äººæ€æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ€å‘è¨€æ—¥å¿—ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* åŒ…å«å¤´åƒå’Œæ–‡å­—çš„æ€»å®¹å™¨ */
.log-entry.speech {
    display: flex;
    align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    gap: 10px;               /* å¤´åƒå’Œæ–‡å­—çš„é—´è· */
    padding: 8px 6px;
    border-bottom: 1px solid rgba(0,0,0,0.05); /* æ¯æ¡å‘è¨€ä¹‹é—´çš„åˆ†å‰²çº¿ */
}

/* å‘è¨€è€…çš„åœ†å½¢å°å¤´åƒ */
.speech-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%; /* å®Œç¾åœ†å½¢ */
    flex-shrink: 0;     /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
    object-fit: cover;
}

/* åŒ…è£¹åå­—å’Œå‘è¨€å†…å®¹çš„æ–°å®¹å™¨ */
.speech-content {
    display: flex;
    flex-direction: column; /* åå­—å’Œå†…å®¹å‚ç›´æ’åˆ— */
    gap: 2px;
}

/* å‘è¨€è€…åå­—çš„æ ·å¼ */
.speech-content .speaker {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²ï¼Œä¸é‚£ä¹ˆåˆºçœ¼ */
}

/* å‘è¨€å†…å®¹çš„æ ·å¼ */
.speech-content .speech-text {
    word-break: break-word; /* ç¡®ä¿é•¿ç¯‡å‘è¨€èƒ½æ­£ç¡®æ¢è¡Œ */
    line-height: 1.6;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */



/* â–¼â–¼â–¼ ã€è¿™æ˜¯ä¸ºä½ æ–°å¢çš„Xç¤¾äº¤Appå›¾æ ‡æ ·å¼ã€‘ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#second-page-x-social-app {
    position: absolute;
    /* æ§åˆ¶ä¸Šä¸‹ä½ç½®ã€‚æˆ‘æŠŠå€¼è°ƒå¤§äº†ï¼Œè®©å®ƒæ›´é ä¸‹ï¼Œå’Œâ€œåœˆå­â€å›¾æ ‡å¯¹é½ */
    top: 100px;  /* â˜… ä¿®æ”¹è¿™é‡Œ â˜… */
    
    /* æ§åˆ¶å·¦å³ä½ç½®ã€‚æˆ‘æŠŠå€¼è°ƒå°äº†ï¼Œè®©å®ƒæ›´é å³ï¼Œå’Œâ€œæƒ…ä¾£ç©ºé—´â€å›¾æ ‡å¯¹é½ */
    right: 0px; /* â˜… ä¿®æ”¹è¿™é‡Œ â˜… */
}

/* æŠŠæ–°å›¾æ ‡çš„æ–‡å­—ä¹Ÿå˜æˆç™½è‰²ï¼Œå’Œå…¶ä»–å›¾æ ‡ç»Ÿä¸€ */
#second-page-x-social-app .label {
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾Ÿæ±¤æ¸¸æˆæ ·å¼ â–¼â–¼â–¼ */

.sts-log-entry {
    padding: 8px 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    line-height: 1.6;
}

/* ç³»ç»Ÿæ¶ˆæ¯ (è°œé¢ã€æç¤ºç­‰) */
.sts-log-entry.system {
    background-color: #e9ecef;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
}
#phone-screen.dark-mode .sts-log-entry.system {
    background-color: #2c2c2e;
}

/* ç©å®¶æé—® */
.sts-log-entry.question {
    background-color: #fff;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .sts-log-entry.question {
    background-color: #1c1c1e;
}
.sts-log-entry .speaker {
    font-weight: 600;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾Ÿæ±¤ - å‡ºé¢˜äººå›ç­”æ°”æ³¡ç¾åŒ– â–¼â–¼â–¼ */
.sts-log-entry.answer {
    text-align: right;
}
.sts-log-entry.answer .answer-text {
    display: inline-block;
    padding: 8px 12px; /* å¢åŠ å†…è¾¹è·ï¼Œè®©æ°”æ³¡æ›´é¥±æ»¡ */
    border-radius: 18px; /* å¢åŠ åœ†è§’ */
    font-weight: 500; /* å­—ä½“ä¸ç”¨å¤ªç²— */
    background-color: #f0f2f5; /* ç»Ÿä¸€çš„ã€ä¸­æ€§çš„æµ…ç°è‰²èƒŒæ™¯ */
    color: var(--text-primary); /* æ–‡å­—é¢œè‰²ä½¿ç”¨ä¸»é¢˜çš„ä¸»è‰²ï¼Œé€‚é…å¤œé—´æ¨¡å¼ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.08); /* ç¨å¾®è°ƒæ•´é˜´å½± */
}

/* ç§»é™¤æ—§çš„ã€æŒ‰é¢œè‰²åŒºåˆ†çš„æ ·å¼ï¼Œç¡®ä¿æ‰€æœ‰å›ç­”éƒ½ç”¨ä¸Šé¢çš„æ–°æ ·å¼ */
.sts-log-entry.answer .answer-text.yes,
.sts-log-entry.answer .answer-text.no,
.sts-log-entry.answer .answer-text.irrelevant {
    background-color: #f0f2f5; /* ç¡®ä¿æ‰€æœ‰éƒ½ç”¨è¿™ä¸ªé¢œè‰² */
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode .sts-log-entry.answer .answer-text,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.yes,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.no,
#phone-screen.dark-mode .sts-log-entry.answer .answer-text.irrelevant {
     background-color: #3a3a3c; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ·±ç°è‰² */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* AIçŒœæµ‹ */
.sts-log-entry.guess {
    font-style: italic;
    color: #fd7e14;
    border-left: 3px solid #fd7e14;
    padding-left: 12px;
}

/* ç©å®¶åº§ä½ä¸Šçš„èº«ä»½æŒ‡ç¤ºå™¨ */
.player-seat .player-role-indicator.riddle-master {
    background-color: #ffc107; /* é»„è‰²ä»£è¡¨å‡ºé¢˜äºº */
    display: flex;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾Ÿæ±¤èŠå¤©æ—¥å¿—ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
.sts-log-entry.question,
.sts-log-entry.answer,
.sts-log-entry.guess {
    display: flex;
    align-items: flex-start; /* å¤´åƒå’Œæ°”æ³¡é¡¶éƒ¨å¯¹é½ */
    gap: 10px;
    max-width: 85%;
    margin-bottom: 12px;
}

/* æé—®å’ŒçŒœæµ‹é å·¦ */
.sts-log-entry.question,
.sts-log-entry.guess {
    align-self: flex-start;
}

/* å›ç­”é å³ */
.sts-log-entry.answer {
    align-self: flex-end;
    flex-direction: row-reverse; /* å…³é”®ï¼šè®©å¤´åƒåœ¨å³è¾¹ */
}

/* å¤´åƒæ ·å¼ */
.sts-log-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾Ÿæ±¤èŠå¤©æ—¥å¿—ç¾åŒ–æ ·å¼ (æ°”æ³¡é€æ˜ç‰ˆ) â–¼â–¼â–¼ */
.sts-log-entry.question .sts-log-content,
.sts-log-entry.guess .sts-log-content {
    background-color: transparent; /* <-- ä¿®æ”¹ç‚¹1ï¼šèƒŒæ™¯æ”¹ä¸ºé€æ˜ */
    border-radius: 8px;
    padding: 8px 12px;
    border: none; /* <-- ä¿®æ”¹ç‚¹2ï¼šç§»é™¤è¾¹æ¡†ï¼Œè®©å®ƒå½»åº•â€œæ¶ˆå¤±â€ */
}

#phone-screen.dark-mode .sts-log-entry.question .sts-log-content,
#phone-screen.dark-mode .sts-log-entry.guess .sts-log-content {
    background-color: #1c1c1e;
}

/* ä¿®æ­£å›ç­”æ°”æ³¡çš„æ ·å¼ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å— */
.sts-log-entry.answer .answer-text {
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
.player-seat .player-avatar.active-turn {
    border-color: #007bff; /* ä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºè¾¹æ¡†é¢œè‰² */
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.7); /* æ·»åŠ å‘å…‰æ•ˆæœ */
    animation: sts-pulse-glow 1.5s infinite ease-in-out; /* åº”ç”¨åŠ¨ç”» */
}

@keyframes sts-pulse-glow {
    0%, 100% {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
    }
    50% {
        box-shadow: 0 0 25px rgba(0, 123, 255, 1);
    }
}
/* â–¼â–¼â–¼ ã€æµ·é¾Ÿæ±¤å¸ƒå±€ä¿®å¤ã€‘è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
#sts-game-log {
    display: flex;
    flex-direction: column;
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æµ·é¾Ÿæ±¤èŠå¤©æ—¥å¿—ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
.sts-log-entry.question,
.sts-log-entry.answer,
.sts-log-entry.guess {
    display: flex;
    align-items: flex-start; /* å¤´åƒå’Œæ°”æ³¡é¡¶éƒ¨å¯¹é½ */
    gap: 10px;
    max-width: 85%;
    margin-bottom: 12px;
    /* ç§»é™¤æ—§çš„èƒŒæ™¯å’Œè¾¹æ¡†ï¼Œå› ä¸ºç°åœ¨ç”±å­å…ƒç´ å¤„ç† */
    background-color: transparent;
    border: none;
}

/* æé—®å’ŒçŒœæµ‹ï¼ˆçŒœé¢˜æ–¹ï¼‰é å·¦ */
.sts-log-entry.question,
.sts-log-entry.guess {
    align-self: flex-start;
}

/* å›ç­”ï¼ˆå‡ºé¢˜äººï¼‰é å³ */
.sts-log-entry.answer {
    align-self: flex-end;
    flex-direction: row-reverse; /* å…³é”®ï¼šè®©å¤´åƒåœ¨å³è¾¹ */
}

/* å¤´åƒæ ·å¼ */
.sts-log-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

/* åŒ…å«å‘è¨€äººå’Œå†…å®¹çš„æ°”æ³¡ */
.sts-log-entry.question .sts-log-content,
.sts-log-entry.guess .sts-log-content {
    background-color: #fff;
    border-radius: 8px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
}

#phone-screen.dark-mode .sts-log-entry.question .sts-log-content,
#phone-screen.dark-mode .sts-log-entry.guess .sts-log-content {
    background-color: #1c1c1e;
}

/* ä¿®æ­£å›ç­”æ°”æ³¡çš„æ ·å¼ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å— */
.sts-log-entry.answer .answer-text {
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* è®©æ—¥å¿—å®¹å™¨æ”¯æŒflexå¸ƒå±€çš„å¯¹é½ */
#sts-game-log {
    display: flex;
    flex-direction: column;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æµ·é¾Ÿæ±¤è¾“å…¥åŒºç»ˆæä¿®å¤ç‰ˆã€‘ â–¼â–¼â–¼ */

/* 1. å¼ºåˆ¶é‡ç½®æ•´ä¸ªè¾“å…¥åŒºåŸŸçš„å¸ƒå±€ä¸ºâ€œæ¨ªå‘æ’åˆ—â€å¹¶â€œå‚ç›´å±…ä¸­â€ */
#sts-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important; /* æ ¸å¿ƒä¿®æ­£ï¼šä» flex-end æ”¹ä¸º centerï¼Œå®ç°å‚ç›´å±…ä¸­ */
    gap: 8px !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨çš„ main-row ä¹Ÿå‚ç›´å±…ä¸­ï¼Œå¹¶è®©å®ƒå¡«æ»¡ç©ºé—´ */
#sts-action-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important; /* æ ¸å¿ƒä¿®æ­£ï¼šå†…éƒ¨ä¹Ÿä¿æŒå‚ç›´å±…ä¸­ */
    gap: 8px !important;
}

/* 3. ç¾åŒ–è¾“å…¥æ¡†æœ¬èº«ï¼Œå¹¶è®©å®ƒè‡ªåŠ¨æ’‘æ»¡å®½åº¦ */
#sts-action-area #sts-question-input {
    flex-grow: 1; 
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px; 
    line-height: 1.5;
}

/* 4. ç»Ÿä¸€æ‰€æœ‰æŒ‰é’®çš„é«˜åº¦å’Œæ ·å¼ï¼Œè®©å®ƒä»¬å’Œè¾“å…¥æ¡†å®Œç¾é€‚é… */
#sts-action-area #guess-sts-answer-btn,
#sts-action-area #send-sts-question-btn {
    height: 40px; 
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
}

/* 5. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #sts-action-area #sts-question-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰§æœ¬æ€æ¸¸æˆæ ·å¼ â–¼â–¼â–¼ */

/* æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ */
#script-kill-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 10px;
    box-sizing: border-box;
}

/* ç©å®¶åº§ä½åŒº (å¤ç”¨ç‹¼äººæ€çš„æ ·å¼) */
#script-kill-players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 10px;
    padding: 10px;
    flex-shrink: 0;
}

/* æ¸¸æˆæ—¥å¿—åŒº (å¤ç”¨ç‹¼äººæ€çš„æ ·å¼) */
#script-kill-log-container {
    flex-grow: 1;
    background-color: rgba(0,0,0,0.05);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    margin: 10px 0;
    min-height: 0; /* flexå¸ƒå±€ä¸‹æ»šåŠ¨çš„å…³é”® */
}

/* ç©å®¶æ“ä½œåŒº (å¤ç”¨ç‹¼äººæ€çš„æ ·å¼) */
#script-kill-action-area {
    flex-shrink: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    min-height: 50px;
}
#script-kill-action-area button {
    padding: 10px 20px;
}

/* æŠ•ç¥¨é€‰é¡¹æ ·å¼ */
#sk-vote-options-list label {
    display: block;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
}
#sk-vote-options-list label:hover {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #sk-vote-options-list label:hover {
    background-color: #2c2c2e;
}

/* çº¿ç´¢å¡ç‰‡æ ·å¼ */
.sk-evidence-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.sk-evidence-card .source {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.sk-evidence-card .description {
    font-size: 14px;
    line-height: 1.6;
}

/* â–²â–²â–² å‰§æœ¬æ€æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ã€å…¨æ–°ã€‘å‰§æœ¬æ€å¯è§†åŒ–ç¼–è¾‘å™¨æ ·å¼ */

/* è§’è‰²/çº¿ç´¢å¡ç‰‡çš„å®¹å™¨ */
.sk-item-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-color: #f0f2f5;
    padding: 10px;
    border-radius: 8px;
    min-height: 50px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .sk-item-container {
    background-color: #2c2c2e;
}

/* å•ä¸ªè§’è‰²/çº¿ç´¢çš„å¡ç‰‡ */
.sk-editor-item {
    background-color: var(--secondary-bg);
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sk-editor-item .item-info .item-name {
    font-weight: 600;
}
.sk-editor-item .item-info .item-meta {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡ä¸Šçš„ç¼–è¾‘/åˆ é™¤æŒ‰é’® */
.sk-editor-item .item-actions {
    display: flex;
    gap: 8px;
}
.sk-editor-item .item-actions button {
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 5px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆæ ·å¼ â–¼â–¼â–¼ */

/* æ¸¸æˆæ—¥å¿—åŒºåŸŸ */
#guess-what-game-log {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* å•æ¡æ—¥å¿—æ¡ç›® */
.guess-log-entry {
    padding: 8px 12px;
    border-radius: 12px;
    line-height: 1.6;
    max-width: 90%;
    word-break: break-word;
}

/* ç³»ç»Ÿæç¤ºï¼Œä¾‹å¦‚æ¸¸æˆå¼€å§‹ã€è°çš„å›åˆ */
.guess-log-entry.system {
    background-color: #e9ecef;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
    font-size: 13px;
    align-self: center;
}
#phone-screen.dark-mode .guess-log-entry.system {
    background-color: #2c2c2e;
}

/* ç©å®¶å‘è¨€çš„æ°”æ³¡ï¼ˆé€šç”¨ï¼‰ */
.guess-log-entry.user-turn,
.guess-log-entry.ai-turn {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

/* ç©å®¶å‘è¨€å†…å®¹ */
.guess-log-entry .bubble {
    background-color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .guess-log-entry .bubble {
    background-color: #2c2c2e;
}

/* AIå‘è¨€æ°”æ³¡ï¼ˆé å·¦ï¼‰ */
.guess-log-entry.ai-turn {
    align-self: flex-start;
}

/* ç”¨æˆ·å‘è¨€æ°”æ³¡ï¼ˆé å³ï¼‰ */
.guess-log-entry.user-turn {
    align-self: flex-end;
    flex-direction: row-reverse; /* å¤´åƒåœ¨å³è¾¹ */
}
.guess-log-entry.user-turn .bubble {
    background-color: #dcf8c6; /* ç±»ä¼¼å¾®ä¿¡çš„ç»¿è‰² */
}
#phone-screen.dark-mode .guess-log-entry.user-turn .bubble {
    background-color: #3b5b32; /* å¤œé—´æ¨¡å¼ä¸‹çš„ç»¿è‰² */
}

/* æ°”æ³¡å†…çš„å¤´åƒ */
.guess-log-entry .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* æ°”æ³¡å†…çš„åå­—å’Œå†…å®¹ */
.guess-log-entry .name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* æ¸¸æˆè¾“å…¥åŒºç¾åŒ– */
#guess-what-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important; /* ä¿æŒå‚ç›´å±…ä¸­ */
    gap: 8px !important;
    width: 100%; /* æ–°å¢ï¼šè®©æ•´ä¸ªå®¹å™¨æ’‘æ»¡å®½åº¦ */
    box-sizing: border-box; /* æ–°å¢ï¼šç¡®ä¿å†…è¾¹è·å’Œè¾¹æ¡†è¢«æ­£ç¡®è®¡ç®—åœ¨å†… */
}


#guess-what-action-area #guess-what-user-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
}
#guess-what-action-area #send-guess-what-input-btn {
    height: 40px;
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
}
#phone-screen.dark-mode #guess-what-action-area #guess-what-user-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}

/* â–²â–²â–² â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆæ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å‰§æœ¬æ€AIç”Ÿæˆå™¨å¸ƒå±€ä¿®å¤ã€‘è¯·å°†è¿™æ•´å—å…¨æ–°çš„CSSç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘è®©æ•´ä¸ªå¼¹çª—çš„å†…å®¹åŒº(modal-body)èƒ½å¤Ÿæ­£ç¡®åœ°æ’‘æ»¡å‰©ä½™ç©ºé—´å¹¶æ»šåŠ¨ */
#sk-ai-generator-modal .modal-body {
    flex-grow: 1;      /* å…è®¸å†…å®¹åŒºå æ® header å’Œ footer ä¹‹é—´çš„æ‰€æœ‰å¯ç”¨å‚ç›´ç©ºé—´ */
    min-height: 0;     /* è§£å†³flexå¸ƒå±€ä¸­ä¸€ä¸ªå¸¸è§çš„æ»šåŠ¨æ¡å¤±æ•ˆé—®é¢˜ï¼Œéå¸¸å…³é”® */
    /* overflow-y: auto;  <-- è¿™ä¸ªå±æ€§ä½ çš„ .modal-body å·²ç»æœ‰äº†ï¼Œæ‰€ä»¥ä¸ç”¨é‡å¤å†™ */
}

/* 2. ã€æ ¸å¿ƒã€‘æŒ‡å®šåŒ…å«â€œé¢„è§ˆæ¡†â€çš„é‚£ä¸ª form-group ä¹Ÿéœ€è¦èƒ½å¤Ÿå¼¹æ€§å¢é•¿ */
/* æˆ‘ä»¬ç”¨ :last-of-type ç²¾å‡†å®šä½åˆ°æœ€åä¸€ä¸ª .form-group */
#sk-ai-generator-modal .modal-body .form-group:last-of-type {
    flex-grow: 1;       /* è®©å®ƒåƒæ‰æ‰€æœ‰å‰©ä½™çš„å‚ç›´ç©ºé—´ */
    min-height: 0;      /* åŒæ ·æ˜¯ä¸ºäº†å…¼å®¹æ€§ */
    display: flex;        /* æŠŠå®ƒè‡ªå·±ä¹Ÿå˜æˆflexå®¹å™¨ */
    flex-direction: column; /* è®©å®ƒé‡Œé¢çš„ label å’Œ preview å‚ç›´æ’åˆ— */
}

/* 3. ã€æ ¸å¿ƒã€‘æœ€åï¼Œç¡®ä¿é¢„è§ˆæ¡†æœ¬èº«èƒ½å¤Ÿæ’‘æ»¡å®ƒçš„çˆ¶å®¹å™¨ï¼Œå¹¶ä¸”åœ¨å†…å®¹è¿‡å¤šæ—¶è‡ªå·±æ»šåŠ¨ */
#sk-ai-result-preview {
    flex-grow: 1;      /* æ’‘æ»¡çˆ¶å®¹å™¨(.form-group)çš„ç©ºé—´ */
    overflow-y: auto;  /* å½“ä»£ç è¶…å‡ºæ—¶ï¼Œæ˜¾ç¤ºå®ƒè‡ªå·±çš„æ»šåŠ¨æ¡ï¼Œè€Œä¸æ˜¯è®©æ•´ä¸ªå¼¹çª—æ»šåŠ¨ */
    
    /* (å¯é€‰ç¾åŒ–) ç»™ä¸€ä¸ªæœ€å°é«˜åº¦ï¼Œé˜²æ­¢åœ¨æ²¡å†…å®¹æ—¶å®Œå…¨å¡Œé™· */
    min-height: 100px; 
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€æ¸¸æˆè¾“å…¥åŒºç»ˆæä¿®å¤ç‰ˆã€‘ â–¼â–¼â–¼ */

/* 1. å¼ºåˆ¶é‡ç½®ä¸¤ä¸ªæ¸¸æˆè¾“å…¥åŒºåŸŸçš„å®¹å™¨å¸ƒå±€ */
#sts-action-area,
#guess-what-action-area {
    display: flex !important;
    flex-direction: row !important; /* å…³é”®ï¼šä»çºµå‘æ”¹ä¸ºæ¨ªå‘ */
    align-items: center !important;  /* å…³é”®ï¼šè®©æ‰€æœ‰å­å…ƒç´ å‚ç›´å±…ä¸­ */
    gap: 8px !important;            /* è®¾ç½®å…ƒç´ ä¹‹é—´çš„é—´è· */
    width: 100%;                     /* æ–°å¢ï¼šè®©æ•´ä¸ªå®¹å™¨å®½åº¦æ’‘æ»¡ */
    box-sizing: border-box;          /* æ–°å¢ï¼šç¡®ä¿å†…è¾¹è·å’Œè¾¹æ¡†è¢«æ­£ç¡®è®¡ç®— */
}

/* 2. å¼ºåˆ¶å†…éƒ¨çš„ .chat-input-main-row ä¹Ÿèƒ½æ­£ç¡®ä¼¸å±•å’Œå¯¹é½ */
#sts-action-area .chat-input-main-row,
#guess-what-action-area .chat-input-main-row {
    flex-grow: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

/* 3. ç¾åŒ–è¾“å…¥æ¡†æœ¬èº«ï¼Œå¹¶è®©å®ƒè‡ªåŠ¨æ’‘æ»¡å®½åº¦ */
#sts-action-area #sts-question-input,
#guess-what-action-area #guess-what-user-input {
    flex-grow: 1; /* æ ¸å¿ƒï¼šè®©è¾“å…¥æ¡†è‡ªåŠ¨ä¼¸å±•ï¼Œå æ»¡æ‰€æœ‰å¯ç”¨å®½åº¦ */
    min-height: 40px; /* ä¿è¯æœ€å°é«˜åº¦ */
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    box-sizing: border-box;
}

/* 4. ç»Ÿä¸€æ‰€æœ‰æŒ‰é’®çš„é«˜åº¦å’Œæ ·å¼ï¼Œè®©å®ƒä»¬å’Œè¾“å…¥æ¡†å®Œç¾é€‚é… */
#sts-action-area button,
#guess-what-action-area button {
    height: 40px; 
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    font-size: 14px;
    font-weight: 600;
}

/* 5. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #sts-action-area #sts-question-input,
#phone-screen.dark-mode #guess-what-action-area #guess-what-user-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* === ã€ç‹¬å®¶å®šåˆ¶ã€‘éšè—æ¸¸æˆå¤§å…è¿”å›æŒ‰é’®çš„ "é€€å‡º" æ–‡å­— === */
#exit-werewolf-game-btn,
#exit-sts-game-btn,
#exit-script-kill-game-btn,
#exit-guess-what-game-btn,
#exit-ludo-game-btn,
#exit-undercover-game-btn { /* <--- ä¿®æ”¹åœ¨è¿™é‡Œ */
    font-size: 0 !important;
    color: transparent !important;
}

#exit-werewolf-game-btn::before,
#exit-sts-game-btn::before,
#exit-script-kill-game-btn::before,
#exit-guess-what-game-btn::before,
#exit-ludo-game-btn::before,
#exit-undercover-game-btn::before { /* <--- è¿˜æœ‰è¿™é‡Œ */
    content: 'â€¹';
    font-size: 24px !important;
    color: var(--accent-color) !important;
}

/* â–¼â–¼â–¼ ã€V3æœ€ç»ˆç‰ˆã€‘æ¸¸æˆå‘è¨€è¾“å…¥åŒºé€šç”¨ç¾åŒ–æ ·å¼ (å·²å±…ä¸­) â–¼â–¼â–¼ */

/* 1. è®©æ‰€æœ‰æ¸¸æˆçš„å‘è¨€åŒºåŸŸå®¹å™¨éƒ½æ°´å¹³å±…ä¸­ */
#werewolf-action-area.speaking-mode,
#script-kill-action-area.speaking-mode,
#undercover-action-area.speaking-mode { /* â˜… æ–°å¢äº† #undercover-action-area */
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 10px 12px !important; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©åŒºåŸŸä¸è´´åº• */
    box-sizing: border-box;
    justify-content: center; /* â˜…â˜…â˜… è¿™å°±æ˜¯å®ç°å±…ä¸­çš„æ ¸å¿ƒä»£ç ï¼ â˜…â˜…â˜… */
}

/* 2. ç¾åŒ–æ‰€æœ‰æ¸¸æˆçš„å‘è¨€è¾“å…¥æ¡† */
#werewolf-action-area.speaking-mode #user-speech-input,
#script-kill-action-area.speaking-mode #user-sk-speech-input,
#undercover-action-area.speaking-mode #undercover-user-speech-input {
    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘ä»¬ç§»é™¤äº† flex-grow: 1; å±æ€§ï¼â˜…â˜…â˜… */
    /* è¿™æ ·è¾“å…¥æ¡†å°±ä¸ä¼šæ— é™ä¼¸å±•ï¼Œè€Œæ˜¯ä¿æŒä¸€ä¸ªè‡ªç„¶çš„å®½åº¦ */
    
    border: 1px solid #ccc; /* å¢åŠ ä¸€ä¸ªæ·¡æ·¡çš„è¾¹æ¡†ï¼Œè®©å®ƒæ›´æ¸…æ™° */
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    width: auto; /* ç¡®ä¿å®½åº¦æ˜¯è‡ªé€‚åº”çš„ */
    height: auto;
    min-width: 200px; /* ç»™ä¸€ä¸ªæœ€å°å®½åº¦ï¼Œé˜²æ­¢å†…å®¹å°‘æ—¶å¤ªçª„ */
}

/* 3. ç¾åŒ–æ‰€æœ‰æ¸¸æˆçš„â€œå‘è¨€/ç»“æŸå‘è¨€â€æŒ‰é’® */
#werewolf-action-area.speaking-mode #end-speech-btn,
#script-kill-action-area.speaking-mode #sk-end-speech-btn,
#undercover-action-area.speaking-mode #undercover-end-speech-btn {
    height: 40px;
    border-radius: 20px;
    padding: 0 20px; /* å¢åŠ å·¦å³å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´é¥±æ»¡ */
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
    margin: 0 !important; 
    width: auto !important;
    background-color: var(--accent-color);
    color: white;
    border: none;
}

/* 4. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #werewolf-action-area.speaking-mode #user-speech-input,
#phone-screen.dark-mode #script-kill-action-area.speaking-mode #user-sk-speech-input,
#phone-screen.dark-mode #undercover-action-area.speaking-mode #undercover-user-speech-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
    border-color: #444; /* å¤œé—´æ¨¡å¼ä¸‹çš„è¾¹æ¡†é¢œè‰² */
}

/* â–²â–²â–² æœ€ç»ˆç‰ˆæ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

#chat-pet {
    transition: transform 0.2s ease-out; /* ä¸ºæ‹–åŠ¨æ·»åŠ ä¸€ç‚¹å¹³æ»‘è¿‡æ¸¡ */
}

#chat-pet:active {
    cursor: grabbing;
    transform: scale(1.1); /* æ‹–åŠ¨æ—¶ç¨å¾®æ”¾å¤§ï¼Œç»™ç”¨æˆ·åé¦ˆ */
    filter: brightness(0.9);
}

#chat-pet img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* è‡ªå®šä¹‰å›¾ç‰‡ç­‰æ¯”ç¼©æ”¾ */
    -webkit-user-drag: none; /* é˜²æ­¢å›¾ç‰‡è¢«æ„å¤–æ‹–åŠ¨ */
    user-drag: none;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©æ•°å€¼é¢æ¿æ ·å¼ â–¼â–¼â–¼ */

#pet-stats-area {
    display: flex;
    flex-direction: column;
    gap: 12px; /* æ¯ä¸ªæ•°å€¼æ¡ä¹‹é—´çš„é—´è· */
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

#phone-screen.dark-mode #pet-stats-area {
    background-color: #2c2c2e;
}

.stat-bar-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.stat-bar-container .stat-label {
    width: 60px; /* å›ºå®šæ ‡ç­¾å®½åº¦ï¼Œè®©è¿›åº¦æ¡å¯¹é½ */
    font-size: 14px;
    font-weight: 500;
    flex-shrink: 0;
}

.stat-bar {
    flex-grow: 1;
    height: 18px;
    background-color: #e9ecef;
    border-radius: 9px;
    overflow: hidden;
    position: relative;
}

#phone-screen.dark-mode .stat-bar {
    background-color: #3e3e42;
}

.stat-bar-fill {
    height: 100%;
    border-radius: 9px;
    transition: width 0.5s ease-in-out;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
}

/* ä¸ºä¸åŒçš„æ•°å€¼æ¡è®¾ç½®ä¸åŒçš„é¢œè‰² */
#pet-hunger-bar .stat-bar-fill {
    background: linear-gradient(135deg, #fd7e14, #ffc107);
}
#pet-happiness-bar .stat-bar-fill {
    background: linear-gradient(135deg, #28a745, #20c997);
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©äº²å¯†åº¦è¿›åº¦æ¡é¢œè‰² â–¼â–¼â–¼ */
#pet-intimacy-user-bar .stat-bar-fill {
    background: linear-gradient(135deg, #ff8fab, #ffc3a0); /* å¯¹ä½ ï¼šæ¸©æš–çš„ç²‰æ©™è‰² */
}
#pet-intimacy-char-bar .stat-bar-fill {
    background: linear-gradient(135deg, #a1c4fd, #c2e9fb); /* å¯¹Taï¼šæŸ”å’Œçš„å¤©è“è‰² */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©èŠå¤©ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#pet-chat-messages .message-wrapper {
    max-width: 85%;
}

#pet-chat-messages .message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

#pet-chat-messages .message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
}

#pet-chat-messages .message-bubble .content {
    padding: 8px 12px;
    border-radius: 10px;
    line-height: 1.5;
}

#pet-chat-messages .message-wrapper.user {
    align-self: flex-end;
}
#pet-chat-messages .message-wrapper.user .message-bubble {
    flex-direction: row-reverse;
}
#pet-chat-messages .message-wrapper.user .content {
    background-color: #dcf8c6;
}

#pet-chat-messages .message-wrapper.pet {
    align-self: flex-start;
}
#pet-chat-messages .message-wrapper.pet .content {
    background-color: #fff;
}

#phone-screen.dark-mode #pet-chat-messages {
    background-color: #000;
}
#phone-screen.dark-mode #pet-chat-messages .message-wrapper.user .content {
    background-color: #26491d;
}
#phone-screen.dark-mode #pet-chat-messages .message-wrapper.pet .content {
    background-color: #2c2c2e;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å¸ƒå±€ç»ˆæä¿®å¤ã€‘ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ä½ ä¸Šä¸€æ¬¡æ·»åŠ çš„å® ç‰©èŠå¤©è¾“å…¥æ¡†æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©å¼¹çª—å†…å®¹åŒºé€‚é…æ–°å¸ƒå±€ (ä¿æŒä¸å˜) */
#pet-chat-modal .modal-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 2. æ¶ˆæ¯åŒºåŸŸ (ä¿æŒä¸å˜) */
#pet-chat-modal #pet-chat-messages {
    flex-grow: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 20px 15px;
    background-color: #f0f2f5;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 3. æ°”æ³¡æ ·å¼ (ä¿æŒä¸å˜) */
#pet-chat-modal .message-bubble .content { padding: 0; background: transparent; box-shadow: none; border: none; }
#pet-chat-modal .message-wrapper.user .content { background-color: #007AFF; color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; max-width: 100%; }
#pet-chat-modal .message-wrapper.pet .content { background-color: #ffffff; color: #1c1c1e; padding: 10px 14px; border-radius: 18px 18px 18px 4px; max-width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

/* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤åŒºåŸŸ â–¼â–¼â–¼ --- */

/* 4. é‡ç½®è¾“å…¥åŒºåŸŸçš„èƒŒæ™¯å’Œè¾¹æ¡† (ä¿æŒä¸å˜) */
#pet-chat-modal #pet-chat-input-area {
    border-top: 1px solid #e0e0e0;
    background-color: #f7f7f7;
    padding: 10px 12px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* 5. ã€æ ¸å¿ƒä¿®å¤ã€‘è®©è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®çš„å®¹å™¨å˜æˆ Flex å¸ƒå±€ */
#pet-chat-modal #pet-chat-input-area .chat-input-main-row {
    display: flex;           /* å…³é”®ï¼šè®©å†…éƒ¨å…ƒç´ æ¨ªå‘æ’åˆ— */
    align-items: center;     /* å…³é”®ï¼šè®©è¾“å…¥æ¡†å’ŒæŒ‰é’®å‚ç›´å±…ä¸­å¯¹é½ï¼Œå®ç°â€œå¹³è¡Œâ€ */
    gap: 8px;                /* è¾“å…¥æ¡†å’ŒæŒ‰é’®ä¹‹é—´çš„é—´è· */
}

/* 6. ç¾åŒ–è¾“å…¥æ¡†ï¼Œå¹¶ã€è®©å®ƒæ’‘æ»¡å®½åº¦ã€‘ */
#pet-chat-modal #pet-chat-input {
    flex-grow: 1;            /* å…³é”®ï¼šè®©è¾“å…¥æ¡†å æ®æ‰€æœ‰å‰©ä½™çš„å®½åº¦ */
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 18px;
    padding: 8px 15px;
    line-height: 1.5;
    min-height: 38px;
    max-height: 100px;
    resize: none;            /* ç¦æ­¢ç”¨æˆ·æ‰‹åŠ¨æ‹–æ‹½å¤§å° */
    box-sizing: border-box;  /* ç¡®ä¿paddingä¸ä¼šæ’‘ç ´å¸ƒå±€ */
}

/* 7. ç¾åŒ–å‘é€æŒ‰é’®ï¼Œå¹¶å›ºå®šå…¶å¤§å° */
#pet-chat-modal #send-to-pet-btn {
    flex-shrink: 0;          /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    background-color: #007AFF;
    color: white;
    border: none;
    border-radius: 18px;
    height: 38px;
    padding: 0 20px;
    font-weight: 600;
    cursor: pointer;         /* é¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºå°æ‰‹ */
}

/* 8. å¤œé—´æ¨¡å¼é€‚é… (ä¿æŒä¸å˜) */
#phone-screen.dark-mode #pet-chat-modal #pet-chat-messages { background-color: #000; }
#phone-screen.dark-mode #pet-chat-modal .message-wrapper.pet .content { background-color: #2c2c2e; }
#phone-screen.dark-mode #pet-chat-modal #pet-chat-input-area { background-color: #1c1c1e; border-top-color: #38383a; }
#phone-screen.dark-mode #pet-chat-modal #pet-chat-input { background-color: #2c2c2e; border-color: #38383a; color: white; }

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ç»ªæ—¥è®°æ ·å¼ --- */

/* æ—¥è®°è§†å›¾ä¸»å®¹å™¨ */
#ls-diary-view {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* æ—¥å†å®¹å™¨ */
.ls-calendar-wrapper {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.ls-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 600;
}

.ls-calendar-header button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--accent-color);
}

.ls-calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.ls-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.ls-calendar-day {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
    padding-top: 4px;
}
.ls-calendar-day:hover {
    background-color: #f0f2f5;
}
.ls-calendar-day.empty {
    cursor: default;
    pointer-events: none;
}
.ls-calendar-day.today .day-number {
    background-color: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    line-height: 22px;
}

.ls-calendar-day .day-number {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 4px;
}

.ls-calendar-day .mood-emojis {
    display: flex;
    gap: 4px;
    font-size: 16px;
    position: absolute;
    bottom: 5px;
}

/* å¿ƒæƒ…ç½å­ */
.ls-mood-jar-wrapper {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
}

.ls-mood-jar-wrapper h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
}

/* â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ .ls-mood-jar æ ·å¼ â–¼â–¼â–¼ */
.ls-mood-jar {
    width: 100%;
    max-width: 100%;           /* â˜… æ ¸å¿ƒä¿®æ”¹1: ä½¿ç”¨max-widthé˜²æ­¢æº¢å‡º */
    box-sizing: border-box;    /* â˜… æ ¸å¿ƒä¿®æ”¹2: ç¡®ä¿paddingä¸ä¼šå¯¼è‡´å®½åº¦è®¡ç®—é”™è¯¯ */
    min-height: 80px;
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-content: flex-start;
    justify-content: center;
    overflow: auto; /* â˜… æ ¸å¿ƒä¿®æ”¹3 (ä¿é™©): å¦‚æœå†…å®¹å®åœ¨å¤ªå¤šï¼Œå°±ç”¨æ»šåŠ¨æ¡å…œåº• */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


.ls-mood-jar .mood-emoji-item {
    font-size: 22px;
}

/* æ—¥è®°ç¼–è¾‘å¼¹çª— */
#ls-emoji-selector .emoji-option {
    padding: 5px;
    border-radius: 8px;
    transition: background-color 0.2s;
}
#ls-emoji-selector .emoji-option.selected {
    background-color: #e0e0e0;
    transform: scale(1.2);
}

/* æ—¥è®°æŸ¥çœ‹å¼¹çª— */
.ls-diary-entry-block {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid var(--accent-color);
}
.ls-diary-entry-block .entry-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.ls-diary-entry-block .entry-header .mood-emoji {
    font-size: 32px;
}
.ls-diary-entry-block .entry-header .author {
    font-weight: 600;
    font-size: 16px;
}
.ls-diary-entry-block .entry-content {
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æ—¥è®°é€šçŸ¥å¡ç‰‡æ ·å¼ --- */

/* 1. è®©åŒ…è£¹å¡ç‰‡çš„æ°”æ³¡æœ¬èº«å˜é€æ˜ */
.message-bubble.is-ls-diary-notification .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 2. å¡ç‰‡ä¸»ä½“æ ·å¼ */
.ls-diary-notification-card {
    width: 220px; /* å¡ç‰‡å®½åº¦ */
    background: linear-gradient(135deg, #fff5f8, #ffebee); /* æ¸©æŸ”çš„ç²‰è‰²æ¸å˜èƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    border: 1px solid #ffdde1; /* æ·¡æ·¡çš„ç²‰è‰²è¾¹æ¡† */
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden; /* éšè—æº¢å‡ºçš„è£…é¥°å…ƒç´  */
    transition: transform 0.2s, box-shadow 0.2s; /* æ·»åŠ ç‚¹å‡»åŠ¨æ•ˆ */
}
.ls-diary-notification-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 3. å¡ç‰‡å³ä¸Šè§’çš„è£…é¥°æ€§å›¾æ ‡ */
.ls-diary-notification-card::before {
    content: 'ğŸ’Œ';
    position: absolute;
    top: -5px;
    right: 10px;
    font-size: 30px;
    opacity: 0.1;
    transform: rotate(15deg);
}

/* 4. å¡ç‰‡å¤´éƒ¨ï¼ˆå›¾æ ‡å’Œæ ‡é¢˜ï¼‰ */
.ls-diary-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
    color: #c85c7c; /* ç¨æ·±çš„ç²‰è‰²ï¼Œä¿è¯æ¸…æ™°åº¦ */
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(200, 92, 124, 0.2);
}

/* 5. å¡ç‰‡æ­£æ–‡ */
.ls-diary-card-body p {
    font-size: 14px;
    color: #5c474b; /* æ·±æ£•è‰²ï¼Œæ˜“äºé˜…è¯» */
    margin: 0 0 12px 0;
    line-height: 1.6;
}

/* 6. å¡ç‰‡åº•éƒ¨æç¤ºæ–‡å­— */
.ls-diary-card-footer {
    font-size: 12px;
    color: #c85c7c;
    text-align: right;
    font-weight: 500;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */


/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘å® ç‰©äº’åŠ¨æŒ‰é’® 2x2 ç½‘æ ¼å¸ƒå±€ (æœ€ç»ˆåŠ å¼ºç‰ˆ) â–¼â–¼â–¼ */

/* 1. ä½¿ç”¨ !important å¼ºåˆ¶å¼€å¯ç½‘æ ¼å¸ƒå±€ï¼Œå¯¹æŠ—æ ·å¼å†²çª */
#pet-interaction-area {
    display: grid !important;        /* å…³é”®ï¼šå¼ºåˆ¶ä½¿ç”¨ grid å¸ƒå±€ */
    grid-template-columns: 1fr 1fr;  /* ä¸¤åˆ—ç½‘æ ¼ */
    gap: 10px;                       /* æŒ‰é’®é—´è· */
    max-width: 220px;                /* é€‚å½“æ”¾å®½æœ€å¤§å®½åº¦ï¼Œç»™æŒ‰é’®æ›´å¤šç©ºé—´ */
    margin: 15px auto !important;    /* å¼ºåˆ¶å±…ä¸­ */
}

/* 2. è°ƒæ•´æŒ‰é’®å°ºå¯¸ï¼Œå¹¶å¼ºåˆ¶æ–‡å­—ä¸æ¢è¡Œ */
#pet-interaction-area button {
    /* å°ºå¯¸å’Œæ–‡å­— */
    padding: 8px 12px;
    font-size: 14px;
    white-space: nowrap;             /* å…³é”®ï¼šå¼ºåˆ¶æ–‡å­—åœ¨åŒä¸€è¡Œæ˜¾ç¤ºï¼Œé˜²æ­¢æ¢è¡Œ */
    
    /* å½¢çŠ¶å’Œç¾åŒ– */
    border-radius: 18px;
    width: 100%;
    font-weight: 600;
    background-color: #f0f2f5;
    color: var(--accent-color);
    border: 1.5px solid var(--accent-color);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* 3. äº¤äº’æ•ˆæœä¿æŒä¸å˜ */
#pet-interaction-area button:hover {
    background-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#pet-interaction-area button:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* â–²â–²â–² ç¾åŒ–æ ·å¼ç»“æŸ â–²â–²â–² */


/* --- ã€æœ€ç»ˆç‰ˆã€‘æƒ…ä¾£ç©ºé—´å³ä¸Šè§’æŒ‰é’®ç¾åŒ–ä¸ç‹¬ç«‹å¾®è°ƒ --- */

/* 1. æ”¶ç´§æŒ‰é’®å®¹å™¨çš„æ•´ä½“é—´è· */
#ls-header .header-actions {
    gap: 0px; /* â˜… ä¿®æ”¹è¿™é‡Œï¼šå°†æŒ‰é’®é—´çš„é—´è·å‡å°åˆ°0ï¼Œè®©å®ƒä»¬ç´§æŒ¨ç€ */
}

/* 2. ä¿æŒæŒ‰é’®çš„åŸºç¡€æ ·å¼ï¼ˆè¿™éƒ¨åˆ†ä¸å˜ï¼‰ */
#ls-header .action-btn {
    padding: 8px; 
    border-radius: 50%;
    transition: background-color 0.2s;
}
#ls-header .action-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

/* 3. ã€æ ¸å¿ƒã€‘ä¸ºæ¯ä¸ªæŒ‰é’®æ·»åŠ ç‹¬ç«‹çš„å¾®è°ƒåŠŸèƒ½ */

/* â€œè®¾ç½®â€æŒ‰é’®çš„ç‹¬ç«‹ä½ç½® */
#ls-settings-btn {
    position: relative; /* å¯ç”¨ç›¸å¯¹å®šä½ï¼Œè¿™æ˜¯å¾®è°ƒçš„å…³é”® */
    top: 0px;           /* ã€è°ƒä¸Šä¸‹ã€‘: æ­£æ•°å¾€ä¸‹ç§»ï¼Œè´Ÿæ•°å¾€ä¸Šç§» */
    left: 40px;          /* ã€è°ƒå·¦å³ã€‘: æ­£æ•°å¾€å³ç§»ï¼Œè´Ÿæ•°å¾€å·¦ç§» */
}

/* â€œæ›´æ¢èƒŒæ™¯â€æŒ‰é’®çš„ç‹¬ç«‹ä½ç½® */
#ls-change-bg-btn {
    position: relative;
    top: 0px;          
    left: 30px;          
}

/* â€œåˆ‡æ¢â€æŒ‰é’®çš„ç‹¬ç«‹ä½ç½® */
#ls-switch-char-btn {
    position: relative;
    top: -5px;
    left: 15px;
}

/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘æƒ…ä¾£ç©ºé—´å¿ƒåŠ¨éŸ³æ³¢å›¾æ ‡ â–¼â–¼â–¼ */

/* 1. ç§»é™¤æ—§çš„çˆ±å¿ƒå­—ç¬¦å’Œå‘å…‰æ•ˆæœ */
.ls-header-avatars .heart-icon {
    font-size: 0; /* è®©'â¤'å­—ç¬¦æ¶ˆå¤± */
    text-shadow: none; /* ç§»é™¤æ–‡å­—é˜´å½± */
    
    /* 2. ä¸ºæ–°å›¾æ ‡è®¾ç½®ä¸€ä¸ªå®¹å™¨å¤§å°ï¼Œæ‚¨å¯ä»¥æ ¹æ®å–œå¥½å¾®è°ƒ */
    width: 80px;
    height: 28px;
    
    /* 3. ã€æ ¸å¿ƒã€‘å°†ä½ å›¾ç‰‡ä¸­çš„éŸ³æ³¢å¿ƒåŠ¨å›¾è®¾ç½®ä¸ºèƒŒæ™¯ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='24' viewBox='0 0 80 24'%3E%3Cg fill='%23ff8fab'%3E%3Crect x='0' y='10' width='3' height='4' rx='1.5'/%3E%3Crect x='5' y='8' width='3' height='8' rx='1.5'/%3E%3Crect x='10' y='11' width='3' height='2' rx='1.5'/%3E%3Crect x='15' y='6' width='3' height='12' rx='1.5'/%3E%3Crect x='20' y='9' width='3' height='6' rx='1.5'/%3E%3Cpath transform='translate(25 0) scale(1.1)' d='M22 8.879c0-5.323-5.326-5.323-7.5-1.121C12.277 2.235 7 3.556 7 8.879 7 14.155 14.5 20 14.5 20S22 14.155 22 8.879z'/%3E%3Crect x='55' y='9' width='3' height='6' rx='1.5'/%3E%3Crect x='60' y='6' width='3' height='12' rx='1.5'/%3E%Crect x='65' y='11' width='3' height='2' rx='1.5'/%3E%3Crect x='70' y='8' width='3' height='8' rx='1.5'/%3E%3Crect x='75' y='10' width='3' height='4' rx='1.5'/%3E%3C/g%3E%3C/svg%3E");
    background-size: contain; /* ç¡®ä¿å›¾æ ‡å®Œæ•´æ˜¾ç¤º */
    background-repeat: no-repeat;
    background-position: center;
    
    /* 4. ï¼ˆå¯é€‰ï¼‰å¾®è°ƒå‚ç›´ä½ç½®ï¼Œè®©å®ƒå’Œå¤´åƒæ›´å¯¹é½ */
    position: relative;
    top: -2px; 
}

/* â–²â–²â–² å®šåˆ¶æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºä½ æ–°å¢çš„æ—¥å†å±…ä¸­ä¿®å¤ä»£ç  â–¼â–¼â–¼ */

/* 1. å¼ºåˆ¶è®©æ¯ä¸€å¤©çš„æ ¼å­å†…å®¹éƒ½ä¸è¦æº¢å‡ºï¼Œé¿å…äº’ç›¸å½±å“ */
.ls-calendar-day {
    overflow: hidden;
    text-align: center; /* å†æ¬¡å¼ºè°ƒæ–‡æœ¬å±…ä¸­ï¼Œæ›´ç¨³å®š */
}

/* 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å°†è“åœˆæœ¬èº«ä¹Ÿå˜æˆä¸€ä¸ªflexå±…ä¸­å®¹å™¨ */
/* è¿™èƒ½ç¡®ä¿é‡Œé¢çš„æ•°å­—ï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šåœ¨åœˆåœˆçš„æ­£ä¸­é—´ */
.ls-calendar-day.today .day-number {
    display: flex;
    justify-content: center;
    align-items: center;
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘æƒ…ä¾£ç©ºé—´è¿”å›æŒ‰é’®ç¾åŒ– â–¼â–¼â–¼ */
#ls-header .back-btn {
    /* 1. æ ¸å¿ƒä¿®æ”¹ï¼šå°†ç®­å¤´é¢œè‰²è®¾ä¸ºæ‚¨æƒ³è¦çš„ç™½è‰² */
    color: white;
    
    /* 2. ç»Ÿä¸€æ ·å¼ï¼šè®©å®ƒå’Œåœˆå­è¿”å›æŒ‰é’®ä¸€æ ·ï¼Œæ‹¥æœ‰40x40pxçš„åœ†å½¢ç‚¹å‡»åŒºåŸŸ */
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

/* 3. ä¸ºå®ƒæ·»åŠ ä¸å…¶ä»–æŒ‰é’®ç»Ÿä¸€çš„ã€æ¼‚äº®çš„æ‚¬åœæ•ˆæœ */
#ls-header .back-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šé€‰æ‹©æ¡†ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©æ¯ä¸ªé€‰é¡¹çš„æ ‡ç­¾(label)æˆä¸ºä¸€ä¸ªflexå®¹å™¨ */
.memory-link-option {
    display: flex;
    align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
    gap: 10px;           /* å…ƒç´ ä¹‹é—´çš„é—´è· */
    padding: 8px 12px !important;  /* å¢åŠ å†…è¾¹è·ï¼Œ!importantç¡®ä¿ç”Ÿæ•ˆ */
    cursor: pointer;
}

/* 2. å•ç‹¬ä¸ºå¤é€‰æ¡†è®¾ç½®æ ·å¼ï¼Œé˜²æ­¢è¢«å…¨å±€æ ·å¼å½±å“ */
.memory-link-option input[type="checkbox"] {
    width: 18px !important;  /* å›ºå®šå®½åº¦ */
    height: 18px !important; /* å›ºå®šé«˜åº¦ */
    margin: 0 !important;    /* ç§»é™¤å¤–è¾¹è· */
    flex-shrink: 0;          /* é˜²æ­¢è¢«å‹ç¼© */
}

/* 3. è®¾ç½®å¤´åƒçš„æ ·å¼ */
.memory-link-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%; /* åœ†å½¢å¤´åƒ */
    object-fit: cover;  /* ä¿è¯å›¾ç‰‡ä¸å˜å½¢ */
    flex-shrink: 0;     /* é˜²æ­¢è¢«å‹ç¼© */
}

/* 4. è®¾ç½®åå­—çš„æ ·å¼ */
.memory-link-name {
    /* é»˜è®¤æ ·å¼å³å¯ï¼Œå®ƒä¼šè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šé€‰æ‹©æ¡†ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
#memory-link-checkboxes-container label {
    display: flex;           /* 1. ä½¿ç”¨Flexå¸ƒå±€ï¼Œè®©å¤´åƒå’Œæ–‡å­—æ¨ªå‘æ’åˆ— */
    align-items: center;     /* 2. å‚ç›´å±…ä¸­å¯¹é½ */
    gap: 10px;               /* 3. åœ¨å¤´åƒã€å¤é€‰æ¡†å’Œæ–‡å­—ä¹‹é—´åˆ›å»ºé—´è· */
    padding: 10px 12px;      /* 4. å¢åŠ å†…è¾¹è·ï¼Œè®©æ¯ä¸€è¡Œæ›´é«˜ã€æ›´æ˜“äºç‚¹å‡» */
    cursor: pointer;         /* 5. é¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºå°æ‰‹å›¾æ ‡ */
    transition: background-color 0.2s; /* 6. æ·»åŠ æ‚¬åœæ•ˆæœ */
}

#memory-link-checkboxes-container label:hover {
    background-color: #f0f2f5; /* 7. é¼ æ ‡æ‚¬åœæ—¶ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
}

#memory-link-checkboxes-container .avatar-preview {
    width: 30px;             /* 8. è®¾ç½®å¤´åƒçš„å°ºå¯¸ */
    height: 30px;
    border-radius: 50%;      /* 9. åœ†å½¢å¤´åƒ */
    object-fit: cover;       /* 10. ç¡®ä¿å›¾ç‰‡ä¸å˜å½¢ */
    flex-shrink: 0;          /* 11. é˜²æ­¢å¤´åƒåœ¨ç©ºé—´ä¸è¶³æ—¶è¢«å‹ç¼© */
}

#memory-link-checkboxes-container input[type="checkbox"] {
    /* 12. è°ƒæ•´å¤é€‰æ¡†çš„å¤§å°å’Œä½ç½®ï¼Œä½¿å…¶æ›´åè°ƒ */
    width: 18px;
    height: 18px;
    margin: 0;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V6 æœ€ç»ˆä¿®æ­£ç‰ˆã€‘å¿ƒå£°é¢æ¿ï¼ˆè¾¹æ¡†é—®é¢˜ä¿®å¤ï¼‰ â–¼â–¼â–¼ */

/* 1. åŸºç¡€å¸ƒå±€ (ä¿æŒä¸å˜) */
#inner-voice-modal .modal-body { position: relative; min-height: 450px; }
#inner-voice-avatar-wrapper,
#inner-voice-char-name,
#inner-voice-adopter-info { position: absolute; transition: all 0.3s ease; }

/* 2. è§’è‰²ä¸»å¤´åƒçš„å®¹å™¨ï¼šåœ¨è¿™é‡Œæ·»åŠ  padding å’Œ background-color */
#inner-voice-avatar-wrapper {
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 65px;
    height: 65px;
    border-radius: 50%;
    
    /* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼ --- */
    padding: 4px; /* â˜… æ–°å¢ï¼šå‘å†…æŒ¤å‹4åƒç´ ï¼Œä¸ºçº¢çº¿ç•™å‡ºç©ºé—´ã€‚ä½ å¯ä»¥è‡ªå·±è°ƒæ•´è¿™ä¸ªæ•°å€¼ï¼Œæ¯”å¦‚3pxæˆ–5px */
    background-color: #fff; /* â˜… æ–°å¢ï¼šè®©å†…è¾¹è·çš„åŒºåŸŸæ˜¾ç¤ºä¸ºç™½è‰²ï¼Œå½¢æˆä¸€ä¸ªâ€œç™½ç¯â€ */
    box-sizing: border-box; /* â˜… æ–°å¢ï¼šç¡®ä¿paddingä¸ä¼šæŠŠå®¹å™¨æ’‘å¤§ï¼Œè¿™å¾ˆé‡è¦ */
    /* --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² --- */

    box-shadow: 0 0 0 1.5px transparent;
    transition: box-shadow 0.2s ease-in-out;
}

/* å½“éœ€è¦æ˜¾ç¤ºè¾¹æ¡†æ—¶ï¼Œæ”¹å˜ box-shadow çš„é¢œè‰² (å·²ä¿®æ”¹ä¸ºç²‰è‰²) */
#inner-voice-avatar-wrapper.has-border {
    box-shadow: 0 0 0 1.5px #ff8fab; /*  <-- å°±æ˜¯ä¿®æ”¹è¿™é‡Œï¼*/
}


/* 4. ç§»é™¤ä¹‹å‰åˆ¶é€ å†²çªçš„ ::after ä¼ªå…ƒç´  (ä¿æŒä¸å˜) */
#inner-voice-avatar-wrapper::after {
    display: none;
}

/* è§’è‰²ä¸»å¤´åƒçš„å›¾ç‰‡æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
#inner-voice-avatar-wrapper #inner-voice-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: none; 
}

/* å¤´åƒæ¡†çš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆå¾®è°ƒç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„èŠå¤©å’Œå¿ƒå£°å¤´åƒæ¡†è§„åˆ™ â–¼â–¼â–¼ */

.avatar-with-frame .avatar-frame,
#inner-voice-avatar-frame {
    position: absolute;
    width: 110%;
    height: 115%;
    transform: translate(-50%, -56%);
    top: 50%;
    left: 50%;
    z-index: 2;
    pointer-events: none;
}


/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* 5. è§’è‰²åå­—å’Œé¢†å…»äººä¿¡æ¯çš„ä½ç½® (ä¿æŒä¸å˜) */
#inner-voice-char-name {
    top: 95px; left: 50%; transform: translateX(-50%); font-weight: 600; font-size: 16px; color: #333; text-align: center;
}
#inner-voice-adopter-info {
    top: 125px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666;
}
#inner-voice-adopter-info img { width: 24px; height: 24px; border-radius: 50%; }

/* 6. å†…å®¹åŒºè·ç¦» (ä¿æŒä¸å˜) */
#inner-voice-content-area { margin-top: 165px; }

/* â–¼â–¼â–¼ ã€å…¨æ–° | CSSå˜é‡ç‰ˆã€‘å¿ƒå£°é¢æ¿å¡ç‰‡å’Œæ ‡ç­¾æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯å¿ƒå£°é¢æ¿é‡Œï¼Œæ¯ä¸ªé¡¹ç›®ï¼ˆä¾‹å¦‚â€œæœè£…â€çš„æ•´ä¸ªå¡ç‰‡ï¼‰çš„æ ·å¼ */
#inner-voice-content-area > div {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘ä»¬æŠŠé¢œè‰²å’Œé€æ˜åº¦å˜æˆäº†å¯ä»¥è¢«JSä¿®æ”¹çš„å˜é‡ */
    background-color: rgba(var(--iv-card-bg-rgb, 255, 255, 255), var(--iv-card-opacity, 0.7));

    border-radius: 16px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    transition: background-color 0.3s; /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
}

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘å¿ƒå£°é¢æ¿æ ‡ç­¾æ ·å¼ â–¼â–¼â–¼ */

/* 1. å…ˆå®šä¹‰æ‰€æœ‰æ ‡ç­¾çš„é€šç”¨æ ·å¼ï¼Œç¡®ä¿å½¢çŠ¶ã€å­—ä½“é¢œè‰²ã€é˜´å½±ç­‰éƒ½ä¿æŒä¸å˜ */
#inner-voice-content-area strong {
    padding: 3px 10px;
    border-radius: 12px;
    color: white !important; /* å¼ºåˆ¶å­—ä½“é¢œè‰²ä¸ºç™½è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* ä¿æŒæ–‡å­—é˜´å½± */
}

/* 2. ç„¶åï¼Œå†ä¸ºæ¯ä¸ªæ ‡ç­¾å•ç‹¬è®¾ç½®å¯å˜çš„èƒŒæ™¯é¢œè‰² */
#inner-voice-content-area div:nth-of-type(1) strong {
    background-color: var(--iv-color-clothing, #f0a1a8); /* æœè£… */
}
#inner-voice-content-area div:nth-of-type(2) strong {
    background-color: var(--iv-color-behavior, #81c784); /* è¡Œä¸º */
}
#inner-voice-content-area div:nth-of-type(3) strong {
    background-color: var(--iv-color-thoughts, #64b5f6); /* å¿ƒå£° */
}
#inner-voice-content-area div:nth-of-type(4) strong {
    background-color: var(--iv-color-naughty, #ba68c8); /* åå¿ƒæ€ */
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */


/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* â–²â–²â–² å®šåˆ¶æ ·å¼ç»“æŸ â–²â–²â–² */

/*
  ã€ç‹¬å®¶å®šåˆ¶ã€‘å•ç‹¬ä¿®æ”¹å¿ƒå£°å¤´åƒæ¡†çš„å¤§å°å’Œä½ç½®
  ä½¿ç”¨è¯´æ˜ï¼š
  1. å°†ä¸‹é¢è¿™æ•´å—ä»£ç ç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ã€‚
  2. ä¿®æ”¹ä¸‹é¢çš„ width, height, top, left çš„æ•°å€¼æ¥è°ƒæ•´å¤´åƒæ¡†ã€‚
*/
#inner-voice-avatar-frame {
    /*
     * æ§åˆ¶å¤§å°ï¼šæ•°å€¼è¶Šå¤§ï¼Œå¤´åƒæ¡†è¶Šå¤§ã€‚
     * ä¾‹å¦‚ï¼š120% (æ¯”åŸæ¥å°), 150% (æ¯”åŸæ¥å¤§)
     */
    width: 100%; 
    height: 100%; 

    /*
     * æ§åˆ¶ä½ç½®ï¼šä»¥å¤´åƒä¸­å¿ƒä¸ºåŸç‚¹ (50%, 50%) è¿›è¡Œå¾®è°ƒ
     */

    /* æ§åˆ¶ã€ä¸Šä¸‹ã€‘ä½ç½®ï¼šå°äº50%åˆ™ä¸Šç§»ï¼Œå¤§äº50%åˆ™ä¸‹ç§» */
    top: 43%; /* ç¤ºä¾‹ï¼šç¨å¾®å‘ä¸Šç§»åŠ¨äº†ä¸€ç‚¹ */

    /* æ§åˆ¶ã€å·¦å³ã€‘ä½ç½®ï¼šå°äº50%åˆ™å·¦ç§»ï¼Œå¤§äº50%åˆ™å³ç§» */
    left: 50%; /* ç¤ºä¾‹ï¼šä¿æŒæ°´å¹³å±…ä¸­ */
    
    /* 
      ä»¥ä¸‹ä¸ºä¿æŒå±…ä¸­å’Œæ˜¾ç¤ºæ•ˆæœå¿…é¡»çš„å±æ€§ï¼Œè¯·å‹¿ä¿®æ”¹ 
    */
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšç§ä¿¡åŠŸèƒ½çš„æ‰€æœ‰æ–°æ ·å¼ï¼Œè¯·ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- ç§ä¿¡åˆ—è¡¨é¡µé¢ --- */
#weibo-dm-list .dm-list-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
#weibo-dm-list .dm-list-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode #weibo-dm-list .dm-list-item:hover {
    background-color: #2c2c2e;
}
#weibo-dm-list .dm-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}
#weibo-dm-list .dm-info {
    flex-grow: 1;
    overflow: hidden;
}
#weibo-dm-list .dm-name {
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 4px;
}
#weibo-dm-list .dm-last-msg {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- ç§ä¿¡è¯¦æƒ…é¡µé¢ --- */
#weibo-dm-messages {
    background-color: #f0f2f5 !important;
}
#phone-screen.dark-mode #weibo-dm-messages {
    background-color: #000000 !important;
}

/* å¤ç”¨ä¸»èŠå¤©ç•Œé¢çš„æ°”æ³¡æ ·å¼ï¼Œä½†ä¸ºç²‰ä¸å’Œè§’è‰²å®šä¹‰ç‰¹å®šå¯¹é½æ–¹å¼ */
#weibo-dm-messages .message-wrapper.fan {
    align-self: flex-start;
}
#weibo-dm-messages .message-wrapper.fan .message-bubble {
    flex-direction: row;
}
#weibo-dm-messages .message-wrapper.fan .content {
    background-color: #ffffff;
    border-radius: 2px 18px 18px 18px;
}

#weibo-dm-messages .message-wrapper.char {
    align-self: flex-end;
}
#weibo-dm-messages .message-wrapper.char .message-bubble {
    flex-direction: row-reverse;
}
#weibo-dm-messages .message-wrapper.char .content {
    background-color: #ff8200; /* å¾®åšæ©™è‰² */
    color: white;
    border-radius: 18px 2px 18px 18px;
}

#phone-screen.dark-mode #weibo-dm-messages .message-wrapper.fan .content {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode #weibo-dm-messages .message-wrapper.char .content {
    background-color: #e67300;
}

/* â˜…â˜…â˜… è¿™æ˜¯ä½ éœ€è¦çš„ã€åˆ é™¤æŒ‰é’®ã€‘çš„æ ·å¼ â˜…â˜…â˜… */
.dm-message-delete-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #555;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
}
/* é¼ æ ‡æ‚¬åœåœ¨æ¶ˆæ¯ä¸Šæ—¶æ˜¾ç¤ºæŒ‰é’® */
#weibo-dm-messages .message-wrapper:hover .dm-message-delete-btn {
    opacity: 1;
}
.dm-message-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* è°ƒæ•´æŒ‰é’®ä½ç½®ï¼Œè®©å®ƒå‡ºç°åœ¨æ°”æ³¡æ—è¾¹ */
#weibo-dm-messages .message-wrapper.fan .dm-message-delete-btn {
    right: -28px; /* ä¿®æ”¹ï¼šä» left æ”¹ä¸º rightï¼ŒæŠŠå®ƒæ”¾åˆ°å³è¾¹ */
    left: auto;   /* æ–°å¢ï¼šå–æ¶ˆå·¦ä¾§å®šä½ï¼Œç¡®ä¿ right ç”Ÿæ•ˆ */
}
#weibo-dm-messages .message-wrapper.char .dm-message-delete-btn {
    right: -28px;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ€»ç»“åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* æ€»ç»“ç®¡ç†å¼¹çª—å†…çš„åˆ—è¡¨ */
#summary-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* å•æ¡æ€»ç»“å¡ç‰‡ */
.summary-item-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid var(--border-color);
    position: relative;
}

#phone-screen.dark-mode .summary-item-card {
    background-color: #2c2c2e;
}

.summary-item-card .summary-content {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.summary-item-card .summary-meta {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
}

.summary-item-card .summary-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 8px;
}

.summary-item-card .summary-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    padding: 5px;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* èŠå¤©æ€»ç»“å¼¹çª—åº•éƒ¨æŒ‰é’®çš„ç¾åŒ– */
#summary-viewer-modal .modal-footer button {
    width: auto; /* è®©å®½åº¦è‡ªé€‚åº” */
    margin-top: 0; /* ç§»é™¤é¡¶éƒ¨å¤–è¾¹è· */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- â€œæ¡ƒå®â€App æ•´ä½“å¸ƒå±€ --- */
#taobao-screen {
    background-color: #f0f2f5;
}

/* é¡¶éƒ¨é¡µç­¾ */
.taobao-tabs {
    display: flex;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
}
.taobao-tab {
    flex: 1;
    padding: 12px 0;
    text-align: center;
    font-weight: 500;
    color: var(--text-secondary);
    border: none;
    background: none;
    cursor: pointer;
    position: relative;
}
.taobao-tab.active {
    color: #FF5722; /* æ·˜å®æ©™ */
}
.taobao-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 3px;
    background-color: #FF5722;
    border-radius: 1.5px;
}

/* å†…å®¹åŒºåŸŸ */
.taobao-content {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
}
.taobao-view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    display: none;
    padding: 15px;
    box-sizing: border-box;
}
.taobao-view.active {
    display: block;
}

/* --- é¦–é¡µ/å•†å“è§†å›¾ --- */
#product-category-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px; /* for scrollbar */
    scrollbar-width: none;
    -ms-overflow-style: none;
}
#product-category-tabs::-webkit-scrollbar { display: none; }

#product-category-tabs .category-tab-btn {
    padding: 6px 12px;
    border-radius: 15px;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    white-space: nowrap;
    cursor: pointer;
}
#product-category-tabs .category-tab-btn.active {
    background-color: #FFEFE9;
    color: #FF5722;
    border-color: #FF5722;
}

.product-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.product-card {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    cursor: pointer;
}
.product-card .product-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    background-color: #f0f2f5;
}
.product-card .product-info {
    padding: 8px;
}
.product-card .product-name {
    font-size: 14px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.8em; /* ä¿è¯ä¸¤è¡Œçš„é«˜åº¦ */
}
.product-card .product-price {
    font-size: 16px;
    font-weight: bold;
    color: #FF5722;
    margin-top: 5px;
}
.product-card .product-price::before {
    content: 'Â¥';
    font-size: 12px;
    margin-right: 2px;
}

/* --- æˆ‘çš„/ä½™é¢è§†å›¾ --- */
#user-balance-container {
    background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 100%);
    color: white;
    padding: 30px 20px;
    border-radius: 12px;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
#user-balance-container h2 {
    font-size: 40px;
    margin: 10px 0 20px 0;
}
#top-up-btn {
    background-color: rgba(255,255,255,0.9);
    color: #FF5722;
}

/* --- è®¢å•/ç‰©æµè§†å›¾ --- */
.order-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.order-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    display: flex;
    gap: 12px;
}
.order-item .product-image {
    width: 70px;
    height: 70px;
    border-radius: 6px;
    flex-shrink: 0;
}
.order-item .order-info {
    flex-grow: 1;
}
.order-item .product-name {
    font-weight: 500;
}
.order-item .order-status {
    font-size: 13px;
    color: #28a745;
    margin-top: 8px;
    font-weight: 500;
}
.order-item .order-time {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- â€œæ¡ƒå®â€App æœç´¢æ æ ·å¼ --- */
.taobao-search-bar {
    display: flex;
    gap: 10px;
    padding: 0 0 15px 0; /* åªåœ¨ä¸‹æ–¹ç•™å‡ºé—´è· */
}

#product-search-input {
    flex-grow: 1;
    border: 1px solid #FF5722;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
}

#product-search-btn {
    background-color: #FF5722;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 0 20px;
    font-weight: 500;
    cursor: pointer;
}

/* --- AIç”Ÿæˆç»“æœå¼¹çª—å†…çš„æ ·å¼ --- */
#ai-product-results-grid .product-card {
    position: relative; /* ä¸ºäº†å®šä½â€œæ·»åŠ â€æŒ‰é’® */
    padding-bottom: 40px; /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */
    cursor: default; /* åœ¨å¼¹çª—é‡Œï¼Œå¡ç‰‡æœ¬èº«ä¸å¯ç‚¹å‡» */
}

.add-to-my-page-btn {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    width: calc(100% - 16px);
    padding: 8px 0;
    background-color: #4CAF50; /* ç»¿è‰²ï¼Œä»£è¡¨æ·»åŠ  */
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.add-to-my-page-btn:hover {
    background-color: #45a049;
}

.add-to-my-page-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}


/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- è´­ç‰©è½¦é¡µç­¾ä¸Šçš„å°çº¢ç‚¹ --- */
.taobao-tab {
    position: relative;
}
#cart-item-count-badge {
    position: absolute;
    top: 5px;
    right: 15px;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #FF5722;
    color: white;
    font-size: 11px;
    border-radius: 9px;
    line-height: 18px;
}

/* --- å•†å“å¡ç‰‡ä¸Šçš„â€œåŠ å…¥è´­ç‰©è½¦â€æŒ‰é’® --- */
.product-card .add-cart-btn {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 28px;
    height: 28px;
    background-color: #FF5722;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}
.product-card .add-cart-btn:active {
    transform: scale(0.9);
}

/* --- è´­ç‰©è½¦åˆ—è¡¨ --- */
#cart-item-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 70px; /* ä¸ºåº•éƒ¨çš„ç»“ç®—æ ç•™å‡ºç©ºé—´ */
}
.cart-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.cart-item .product-image {
    width: 80px;
    height: 80px;
    border-radius: 6px;
    flex-shrink: 0;
    cursor: pointer; /* è®©å›¾ç‰‡å¯ç‚¹å‡» */
}
.cart-item .cart-item-info {
    flex-grow: 1;
    cursor: pointer; /* è®©ä¿¡æ¯åŒºä¹Ÿå¯ç‚¹å‡» */
}
.cart-item .product-name {
    font-weight: 500;
}
.cart-item .product-price {
    color: #FF5722;
    font-weight: bold;
    margin-top: 8px;
}
.cart-item .quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}
.cart-item .quantity-controls button {
    width: 24px;
    height: 24px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 50%;
    cursor: pointer;
}
.cart-item .delete-cart-item-btn {
    width: 30px;
    height: 30px;
    border: none;
    background: none;
    color: #999;
    font-size: 24px;
    cursor: pointer;
    flex-shrink: 0;
}

/* --- è´­ç‰©è½¦ç»“ç®—æ  --- */
#cart-checkout-bar {
    position: fixed; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä» absolute æ”¹ä¸º fixed â˜…â˜…â˜… */
    bottom: 0;
    left: 0;
    right: 0; /* (æ¨è) é…åˆ left:0 è‡ªåŠ¨æ’‘æ»¡å®½åº¦ï¼Œæ›´ç¨³å¦¥ */
    /* width: 100%; (å¯ä»¥ä¿ç•™æˆ–åˆ é™¤) */
    z-index: 10; /* (æ¨è) ç¡®ä¿å®ƒå§‹ç»ˆåœ¨æœ€ä¸Šå±‚ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: var(--secondary-bg);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
}

#cart-checkout-bar .total-price {
    font-weight: bold;
}
#cart-checkout-bar #cart-total-price {
    color: #FF5722;
    font-size: 18px;
}
#cart-checkout-bar #checkout-btn {
    background-color: #FF5722;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
}

/* --- å•†å“è¯¦æƒ…å¼¹çª— --- */
#product-detail-body {
    text-align: center;
}
#product-detail-body .product-image {
    width: 80%;
    max-width: 250px;
    border-radius: 8px;
    margin-bottom: 15px;
}
#product-detail-body .product-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
}
#product-detail-body .product-price {
    font-size: 24px;
    font-weight: bold;
    color: #FF5722;
    margin-bottom: 20px;
}
#product-detail-body .product-price::before {
    content: 'Â¥';
    font-size: 16px;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- å•†å“è¯¦æƒ…å¼¹çª— - è¯„ä»·åŒº --- */
#product-reviews-section {
    padding: 0 15px 15px 15px; /* å’Œä¸»ä½“å†…å®¹ä¿æŒä¸€è‡´çš„å†…è¾¹è· */
    border-top: 1px solid var(--border-color);
    margin-top: 15px;
}
#product-reviews-section h3 {
    font-size: 16px;
    margin: 15px 0;
}
#product-reviews-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 150px; /* ç»™ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œå†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
    overflow-y: auto;
    margin-bottom: 15px;
}
.product-review-item {
    font-size: 14px;
    line-height: 1.6;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 10px;
}
.product-review-item .review-author {
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 5px;
}
#generate-reviews-btn {
    width: 100%;
    margin-top: 10px;
    background-color: #fff7e6;
    color: #fa8c16;
    border-color: #ffd591;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ä½™é¢æ˜ç»†åˆ—è¡¨æ ·å¼ --- */
.transaction-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.transaction-info .description {
    font-weight: 500;
}
.transaction-info .timestamp {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}
.transaction-amount {
    font-weight: bold;
    font-size: 16px;
}
.transaction-amount.income {
    color: #4CAF50; /* æ”¶å…¥ä¸ºç»¿è‰² */
}
.transaction-amount.expense {
    color: #F44336; /* æ”¯å‡ºä¸ºçº¢è‰² */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºç‰©æµè¯¦æƒ…é¡µæ–°å¢çš„æ ·å¼ï¼Œè¯·ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

#logistics-content-area {
    padding: 20px;
    background-color: #f5f5f5;
}

#phone-screen.dark-mode #logistics-content-area {
    background-color: #121212;
}

/* é¡¶éƒ¨å•†å“ä¿¡æ¯å¡ç‰‡ */
.logistics-product-summary {
    display: flex;
    gap: 15px;
    padding: 15px;
    margin-bottom: 20px;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}

.logistics-product-summary .product-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    flex-shrink: 0;
}

.logistics-product-summary .info .name {
    font-weight: 600;
    font-size: 15px;
}

.logistics-product-summary .info .status {
    font-size: 13px;
    color: #FF5722; /* æ·˜å®æ©™ */
    margin-top: 5px;
    font-weight: 500;
}

/* æ—¶é—´è½´å®¹å™¨ */
.logistics-timeline {
    position: relative;
    padding-left: 25px; /* ä¸ºæ—¶é—´è½´çš„ç«–çº¿å’Œåœ†ç‚¹ç•™å‡ºç©ºé—´ */
    background-color: var(--secondary-bg);
    padding: 20px 20px 20px 30px;
    border-radius: 12px;
}

/* æ—¶é—´è½´çš„ç«–çº¿ */
.logistics-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 20px;
    bottom: 20px;
    width: 2px;
    background-color: #e0e0e0;
}

#phone-screen.dark-mode .logistics-timeline::before {
    background-color: #38383a;
}

/* æ¯ä¸€ä¸ªç‰©æµæ­¥éª¤ */
.logistics-step {
    position: relative;
    margin-bottom: 25px;
}

.logistics-step:last-child {
    margin-bottom: 0;
}

/* æ—¶é—´è½´ä¸Šçš„åœ†ç‚¹ */
.logistics-step::before {
    content: '';
    position: absolute;
    left: -22px; 
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #ccc;
    border: 2px solid var(--secondary-bg);
    z-index: 1;
}

/* æœ€æ–°çš„ä¸€æ¡ç‰©æµçŠ¶æ€ï¼Œè®©å®ƒçš„åœ†ç‚¹æ›´çªå‡º */
.logistics-step:first-child::before {
    background-color: #FF5722;
    transform: scale(1.3);
}

.logistics-step-content .status-text {
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 5px;
    line-height: 1.5;
}

.logistics-step-content .timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œåˆ†äº«ç»™Taä»£ä»˜â€æŒ‰é’®æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */
#share-cart-to-char-btn {
    background-color: #FF9800; /* ä½¿ç”¨ä¸€ä¸ªæ¸©æš–çš„æ©™è‰²ï¼ŒåŒºåˆ«äºç»“ç®—æŒ‰é’® */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s; /* æ·»åŠ æ‚¬åœæ•ˆæœ */
}
#share-cart-to-char-btn:hover {
    background-color: #F57C00;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œè´­ç‰©è½¦ä»£ä»˜è¯·æ±‚â€æ–°å¢çš„å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©åŒ…è£¹å¡ç‰‡çš„æ°”æ³¡æœ¬èº«å˜é€æ˜ */
.message-bubble.is-cart-share-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 2. å¡ç‰‡ä¸»ä½“æ ·å¼ */
.cart-share-card {
    width: 230px;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    border: 2px solid transparent; /* ä¸ºä¸åŒçŠ¶æ€å‡†å¤‡çš„è¾¹æ¡† */
    transition: all 0.3s ease;
}

/* 3. å¡ç‰‡å¤´éƒ¨ */
.cart-share-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background-color: #FFF8E1; /* æ¸©æš–çš„ç±³é»„è‰² */
    color: #FFA000;
}
.cart-share-header .icon {
    font-size: 24px;
    font-weight: bold;
}
.cart-share-header .title {
    font-size: 16px;
    font-weight: 600;
}

/* 4. å¡ç‰‡å†…å®¹åŒºåŸŸ */
.cart-share-body {
    padding: 15px;
    text-align: center;
}
.cart-share-body .label {
    font-size: 13px;
    color: #888;
}
.cart-share-body .amount {
    font-size: 32px;
    font-weight: 700;
    color: #FF5722; /* æ·˜å®æ©™ */
    margin: 5px 0 15px 0;
}
.cart-share-body .status-text {
    font-weight: 500;
    color: var(--accent-color);
}

/* 5. ä¸åŒçŠ¶æ€ä¸‹çš„æ ·å¼ */
.cart-share-card.paid {
    border-color: #4CAF50; /* ç»¿è‰² */
}
.cart-share-card.paid .status-text {
    color: #4CAF50;
}
.cart-share-card.rejected {
    border-color: #F44336; /* çº¢è‰² */
    opacity: 0.8;
}
.cart-share-card.rejected .status-text {
    color: #F44336;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œä¸ºTaè´­ä¹°â€å’Œç¤¼ç‰©é€šçŸ¥å¡ç‰‡æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */

/* 1. â€œä¸ºTaè´­ä¹°â€æŒ‰é’®çš„æ ·å¼ */
#buy-for-char-btn {
    background-color: #4CAF50; /* ä½¿ç”¨ä¸€ä¸ªä»£è¡¨â€œç¤¼ç‰©â€çš„ç»¿è‰² */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}
#buy-for-char-btn:hover {
    background-color: #45a049;
}

/* 2. è®©åŒ…è£¹ç¤¼ç‰©å¡ç‰‡çš„æ°”æ³¡å˜é€æ˜ */
.message-bubble.is-gift-notification .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 3. ç¤¼ç‰©é€šçŸ¥å¡ç‰‡ä¸»ä½“æ ·å¼ */
.gift-card {
    width: 230px;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
.gift-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background-color: #e8f5e9; /*æ·¡æ·¡çš„ç»¿è‰²èƒŒæ™¯*/
    color: #2e7d32;
}
.gift-card-header .icon {
    font-size: 24px;
    font-weight: bold;
}
.gift-card-header .title {
    font-size: 16px;
    font-weight: 600;
}
.gift-card-body {
    padding: 15px;
}
.gift-card-body .greeting {
    font-size: 14px;
    margin-bottom: 10px;
}
.gift-card-items {
    font-size: 13px;
    color: #555;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 10px;
}
.gift-card-footer {
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
    font-weight: bold;
}
.gift-card-footer .total-price {
    color: #FF5722;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©è§’è‰²ä¸»é¡µçš„å†…å®¹åŒºå¯ä»¥ç‹¬ç«‹æ»šåŠ¨ */
#weibo-char-profile-page {
    flex-grow: 1;
    overflow-y: auto;
    background-color: #f0f2f5;
}

/* 2. ä¿®æ­£å¤œé—´æ¨¡å¼ä¸‹ä¸»é¡µå’Œæ–°é¡µé¢çš„èƒŒæ™¯è‰² */
#phone-screen.dark-mode #weibo-profile-page,
#phone-screen.dark-mode #weibo-char-profile-page {
    background-color: #000;
}

/* 3. ä¸ºè§’è‰²ä¸»é¡µä¸Šçš„èŒä¸šæ˜¾ç¤ºæ·»åŠ æ ·å¼ (å·²ä¿®æ”¹) */
#weibo-char-profession-display {
    position: absolute;
    /* å®šä½ï¼šä»å³ä¾§æ ‡ç­¾æ”¹ä¸ºä¸â€œå…³æ³¨â€æ•°æ®å·¦å¯¹é½ */
    left: 35px;
    /* å‚ç›´ä½ç½®ï¼šæ”¾åœ¨â€œå…³æ³¨â€æ•°æ®è¡Œçš„ä¸‹æ–¹ï¼Œ-5pxä¼šè®©å®ƒæ›´é ä¸‹ä¸€ç‚¹ */
    bottom: -5px;
    right: auto; /* æ¸…é™¤æ‰æ—§çš„ right å®šä½ï¼Œé¿å…å†²çª */
    z-index: 2;
    
    /* å¤–è§‚ï¼šä»åŠé€æ˜æ ‡ç­¾æ”¹ä¸ºå’Œä½ ä¸»é¡µä¸€è‡´çš„ç°è‰²æ™®é€šæ–‡å­— */
    font-size: 13px;
    color: #8a8a8a;
    text-shadow: none;
    background-color: transparent;
    padding: 0;
    border-radius: 0;
}


/* 4. ç»™å…³æ³¨åˆ—è¡¨çš„â€œæŸ¥çœ‹ä¸»é¡µâ€æŒ‰é’®æ·»åŠ æ ·å¼ */
.weibo-following-item .view-profile-btn {
    margin-left: auto; /* è®©æŒ‰é’®è‡ªåŠ¨é å³ */
    padding: 5px 10px;
    font-size: 13px;
    font-weight: 500;
    color: var(--accent-color);
    background-color: #e7f3ff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
}
#phone-screen.dark-mode .weibo-following-item .view-profile-btn {
    background-color: rgba(0, 123, 255, 0.2);
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å±‚çº§ä¿®å¤ã€‘è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å¼ºåˆ¶æå‡å¤´åƒæ¡†é€‰æ‹©å¼¹çª—çš„å±‚çº§ï¼Œç¡®ä¿å®ƒèƒ½è¦†ç›–åœ¨å…¶ä»–å¼¹çª—ä¹‹ä¸Š */
#avatar-frame-modal {
    z-index: 1005; 
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„ã€åŒ…è£¹å¤´åƒçš„å¯ç‚¹å‡»åŒºåŸŸçš„æ ·å¼ */
.weibo-post-avatar-clickable {
    cursor: pointer; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºä¸ºå°æ‰‹å½¢çŠ¶ */
    transition: opacity 0.2s ease-in-out; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”» */
}

/* é¼ æ ‡æ‚¬åœæ—¶ï¼Œè®©å¤´åƒç¨å¾®å˜æš—ä¸€ç‚¹ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæ˜ç¡®çš„åé¦ˆ */
.weibo-post-avatar-clickable:hover {
    opacity: 0.85;
}

/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯­éŸ³æ’­æ”¾åŠ¨ç”»æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-voice-message.playing .voice-waveform div {
    animation: wave-play 1s ease-in-out infinite;
}

@keyframes wave-play {
  0%, 100% { height: 2px; }
  25% { height: 12px; }
  50% { height: 6px; }
  75% { height: 18px; }
}
/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */


/* ============ â€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½ç¾åŒ–ä»£ç  v2.0 (æ”¯æŒè‡ªå®šä¹‰å›¾ç‰‡) å¼€å§‹ ============ */

/* --- æ­¥éª¤1: ç¼©å°å›¾æ ‡å°ºå¯¸ (ä¿æŒä¸å˜) --- */
#character-app-grid .app-icon .icon-bg {
    width: 50px !important;
    height: 50px !important;
    border-radius: 13px !important;
}
#character-app-grid .app-icon .label {
    font-size: 12px;
}

/* --- æ­¥éª¤2: å°†å®¹å™¨æ”¹ä¸ºè‡ªç”±å®šä½çš„â€œæ¡Œé¢â€å¸ƒå±€ (ä¿æŒä¸å˜) --- */
#character-app-grid {
    display: block !important;
    grid-template-columns: none !important;
    gap: 0 !important;
    position: relative !important;
    height: 100% !important;
}

/* --- æ­¥éª¤3: è®©æ‰€æœ‰Appå›¾æ ‡â€œæµ®â€èµ·æ¥ (ä¿æŒä¸å˜) --- */
#character-app-grid .app-icon {
    position: absolute !important;
}

/* --- æ­¥éª¤4: ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæˆ‘ä»¬æ–°çš„å›¾ç‰‡ä½è®¾ç½®æ ·å¼ --- */
.char-phone-widget {
    position: absolute;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* åŠ ä¸ªé˜´å½±æ›´å¥½çœ‹ */
    border: 2px solid rgba(255,255,255,0.5); /* åŠ ä¸ªç™½è¾¹æ›´æœ‰è´¨æ„Ÿ */
    overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
    cursor: pointer; /* é¼ æ ‡æ”¾ä¸Šå»æ˜¯å°æ‰‹å½¢çŠ¶ï¼Œæç¤ºå¯ä»¥ç‚¹å‡» */
    transition: transform 0.2s ease; /* æ·»åŠ ç‚¹å‡»åŠ¨æ•ˆ */
    background-color: #e0e0e0; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½é¢œè‰² */
}
.char-phone-widget:active {
    transform: scale(0.95); /* ç‚¹å‡»æ—¶ç¼©å°ä¸€ç‚¹ç‚¹ */
}
.char-phone-widget img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡ä¸”ä¸å˜å½¢ */
}

/* ============================================== */
/* === â˜…â˜…â˜… æ‰‹åŠ¨ç²¾è°ƒåŒºï¼šåœ¨è¿™é‡Œä¿®æ”¹ä½ç½®å’Œå¤§å° â˜…â˜…â˜… === */
/* ============================================== */

/* --- å·¦ä¸Šè§’çš„å›¾ç‰‡ä½ --- */
#char-phone-widget-1 {
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€ä¸Šä¸‹ä½ç½®ã€‘(æ•°å­—è¶Šå¤§è¶Šå¾€ä¸‹)--- */
    top: 60px;
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€å·¦å³ä½ç½®ã€‘(æ•°å­—è¶Šå¤§è¶Šå¾€å³)--- */
    left: 20px;
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€å¤§å°ã€‘--- */
    width: 110px;
    height: 110px;
    border-radius: 22px; /* åœ†è§’ (å»ºè®®æ˜¯å®½åº¦çš„1/5å·¦å³) */
}

/* --- å³ä¸‹è§’çš„å›¾ç‰‡ä½ --- */
#char-phone-widget-2 {
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€ä¸Šä¸‹ä½ç½®ã€‘(æ•°å­—è¶Šå¤§è¶Šå¾€ä¸Š)--- */
    bottom: 60px;
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€å·¦å³ä½ç½®ã€‘(æ•°å­—è¶Šå¤§è¶Šå¾€å·¦)--- */
    right: 20px;
    /* --- åœ¨è¿™é‡Œè°ƒæ•´ã€å¤§å°ã€‘--- */
    width: 110px;
    height: 110px;
    border-radius: 22px; /* åœ†è§’ */
}

/* --- APP å›¾æ ‡ä½ç½®è°ƒæ•´ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜) --- */
#character-app-grid .app-icon:nth-child(1) { top: 70px; left: 150px; }
#character-app-grid .app-icon:nth-child(2) { top: 70px; left: 215px; }
#character-app-grid .app-icon:nth-child(3) { top: 155px; left: 30px; }
#character-app-grid .app-icon:nth-child(4) { top: 155px; left: 95px; }
#character-app-grid .app-icon:nth-child(5) { top: 155px; left: 160px; }
#character-app-grid .app-icon:nth-child(6) { top: 240px; left: 225px; }
#character-app-grid .app-icon:nth-child(7) { top: 240px; left: 30px; }
#character-app-grid .app-icon:nth-child(8) { top: 240px; left: 95px; }
#character-app-grid .app-icon:nth-child(9) { top: 325px; left: 30px; }
#character-app-grid .app-icon:nth-child(10) { top: 325px; left: 95px; }

/* ============ â€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½ç¾åŒ–ä»£ç  ç»“æŸ ============ */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘åªä¸ºâ€œå¾®åšâ€å’Œâ€œç²‰ä¸â€å¢åŠ ç‚¹å‡»åŒºåŸŸ â–¼â–¼â–¼ */

/*
 * æ ¸å¿ƒåŸç†ä¸å˜ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨äº†æ›´ç²¾ç¡®çš„ ID é€‰æ‹©å™¨ï¼Œ
 * åªé€‰ä¸­ #weibo-posts-item (å¾®åš) å’Œ #weibo-fans-item (ç²‰ä¸) è¿™ä¸¤ä¸ªå…ƒç´ ã€‚
 */
#weibo-posts-item,
#weibo-fans-item {
    padding: 8px 10px;
    margin: -8px -10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

/* ä¸ºè¿™ä¸¤ä¸ªæŒ‰é’®æ·»åŠ ç‚¹å‡»æ—¶çš„èƒŒæ™¯è‰²åé¦ˆ */
#weibo-posts-item:active,
#weibo-fans-item:active {
    background-color: rgba(0, 0, 0, 0.08); /* ç‚¹å‡»æ—¶ç»™ä¸€ä¸ªæ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
}

/* åœ¨å¤œé—´æ¨¡å¼ä¸‹çš„ç‚¹å‡»åé¦ˆé¢œè‰² */
#phone-screen.dark-mode #weibo-posts-item:active,
#phone-screen.dark-mode #weibo-fans-item:active {
    background-color: rgba(255, 255, 255, 0.1);
}
/* â–²â–²â–² æœ€ç»ˆä¿®å¤ç‰ˆæ ·å¼ç»“æŸ â–²â–²â–² */


/* ======================================================================= /
/ === â˜…â˜…â˜… è§’è‰²æ‰‹æœºæ¡Œé¢ç¾åŒ–å¸ƒå±€ v16.0 (å‚ç›´å±…ä¸­åç§»ç‰ˆ) â˜…â˜…â˜… === /
/ ======================================================================= */

/* --- 1. æ€»æ§åˆ¶å° & å¸ƒå±€å˜é‡ --- */
#character-phone-screen {
    position: relative !important;
    
    /* --- â˜…â˜…â˜… å”¯ä¸€çš„ã€å‚ç›´ä½ç½®ã€‘æ€»æ§åˆ¶å™¨ â˜…â˜…â˜… --- */
    /* è°ƒæ•´è¿™ä¸ªå€¼ï¼Œå°±èƒ½è®©æ‰€æœ‰å›¾æ ‡å’Œå°ç»„ä»¶ä¸€èµ·ä¸Šä¸‹ç§»åŠ¨ */
    /* å¢åŠ æ•°å€¼ = æ•´ä½“ä¸‹ç§»ï¼›å‡å°æ•°å€¼ = æ•´ä½“ä¸Šç§» */
    /* æˆ‘å¸®ä½ è®¾ç½®äº†ä¸€ä¸ªçœ‹èµ·æ¥æ¯”è¾ƒå±…ä¸­çš„åˆå§‹å€¼ */
    --global-vertical-offset: 10px;
    
    /* (æ°´å¹³å±…ä¸­éƒ¨åˆ†ï¼Œä¿æŒä¸å˜) */
    --grid-width: 345px;
    --grid-left-edge: calc((100% - var(--grid-width)) / 2);
}

/* --- 2. å‡†å¤‡å·¥ä½œ (ä¿æŒä¸å˜) --- */
#character-app-grid {
    position: absolute !important; top: 0; left: 0; width: 100%; height: 100%;
    display: block !important; grid-template-columns: none !important; gap: 0 !important;
}
#character-app-grid .app-icon,
#char-phone-widget-1,
#char-phone-widget-2 {
    position: absolute !important;
}

/* --- 3. Appå›¾æ ‡æ ·å¼ (ä¿æŒä¸å˜) --- */
#character-app-grid .app-icon .icon-bg {
    width: 40px !important; height: 40px !important;
    background: transparent !important; box-shadow: none !important; border: none !important;
}
#character-app-grid .app-icon .label {
    font-size: 12px; color: #fff; padding-top: 8px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* --- 4. å°ç»„ä»¶ä½ç½®å’Œå°ºå¯¸ (â˜…æ ¸å¿ƒä¿®æ”¹: åº”ç”¨å…¨å±€åç§») --- */
#char-phone-widget-1 {
    top: calc(var(--global-vertical-offset) + 90px); /* 90px æ˜¯ä½ å›ºå®šçš„å€¼ */
    left: calc(var(--grid-left-edge) + 30px);
    width: 135px; height: 135px; border-radius: 22px;
}
#char-phone-widget-2 {
    top: calc(var(--global-vertical-offset) + 480px); /* 480px æ˜¯ä½ å›ºå®šçš„å€¼ */
    left: calc(var(--grid-left-edge) + 180px);
    width: 135px; height: 135px; border-radius: 22px;
}

/* --- 5. Appå›¾æ ‡ä½ç½® (â˜…æ ¸å¿ƒä¿®æ”¹: åº”ç”¨å…¨å±€åç§») --- */
/* ç¬¬1è¡Œ */
#character-app-grid .app-icon:nth-child(1) { top: calc(var(--global-vertical-offset) + 155px); left: calc(var(--grid-left-edge) + 185px); }
#character-app-grid .app-icon:nth-child(2) { top: calc(var(--global-vertical-offset) + 155px); left: calc(var(--grid-left-edge) + 250px); }
/* ç¬¬2è¡Œ */
#character-app-grid .app-icon:nth-child(3) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 30px); }
#character-app-grid .app-icon:nth-child(4) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 105px); }
#character-app-grid .app-icon:nth-child(5) { top: calc(var(--global-vertical-offset) + 270px); left: calc(var(--grid-left-edge) + 180px); }
/* ç¬¬3è¡Œ */
#character-app-grid .app-icon:nth-child(6) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 105px); }
#character-app-grid .app-icon:nth-child(7) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 185px); }
#character-app-grid .app-icon:nth-child(8) { top: calc(var(--global-vertical-offset) + 375px); left: calc(var(--grid-left-edge) + 250px); }
/* ç¬¬4è¡Œ */
#character-app-grid .app-icon:nth-child(9) { top: calc(var(--global-vertical-offset) + 480px); left: calc(var(--grid-left-edge) + 30px); }
#character-app-grid .app-icon:nth-child(10) { top: calc(var(--global-vertical-offset) + 480px); left: calc(var(--grid-left-edge) + 105px); }


/* â–¼â–¼â–¼ ã€æŸ¥æ‰‹æœºåŠŸèƒ½ | å›¾æ ‡å¯¹é½ç»ˆæä¿®å¤ V4ã€‘ â–¼â–¼â–¼ */
/*
 * è§£å†³æ–¹æ¡ˆï¼š
 * 1. (ä¿ç•™) ä½¿ç”¨è´Ÿå¤–è¾¹è·ï¼Œå°†åº”ç”¨å(.label)å‘ä¸Šæ‹‰ï¼Œä½¿å…¶ç´§è´´å›¾æ ‡ã€‚
 * 2. (æ–°å¢) å¯¹åŒ…å«é»˜è®¤SVGå›¾æ ‡çš„æ•´ä¸ª.app-iconå…ƒç´ ï¼Œä¹Ÿä½¿ç”¨ä¸€ä¸ªè´Ÿçš„margin-topï¼Œ
 *    ä½¿å…¶æ•´ä½“å‘ä¸Šç§»åŠ¨ï¼Œä»è€Œå’Œå…¶ä»–è‡ªå®šä¹‰å›¾æ ‡åœ¨å‚ç›´æ–¹å‘ä¸Šå®Œç¾å¯¹é½ã€‚
 */

/* æ­¥éª¤1ï¼šè®©æ–‡å­—ç´§è´´å›¾æ ‡ (è¿™æ˜¯ä¸Šæ¬¡çš„æˆåŠŸä¿®å¤ï¼Œæˆ‘ä»¬ä¿ç•™å®ƒ) */
#character-app-grid .app-icon:has(.icon-bg > svg) .label {
    margin-top: -7px !important;
    padding-top: 0px !important;
}

/* æ­¥éª¤2ï¼šè®©å›¾æ ‡å’Œæ–‡å­—ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå‘ä¸Šç§»åŠ¨ */
#character-app-grid .app-icon:has(.icon-bg > svg) {
    margin-top: -8px; /* è¿™ä¸ªè´Ÿå€¼ä¼šæŠŠæ•´ä¸ªå›¾æ ‡+æ–‡å­—çš„ç»„åˆå‘ä¸Šæ‹‰ */
}
/* â–²â–²â–² ä¿®å¤ä»£ç ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯æ­¥éª¤1éœ€è¦ç²˜è´´çš„æ–°æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ¯ä¸€æ¡è¯„è®ºéƒ½å˜æˆå¯ç‚¹å‡»çš„ï¼Œå¹¶å¢åŠ æ‚¬åœæ•ˆæœ */
.weibo-comment-item {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå°æ‰‹å½¢çŠ¶ */
    transition: background-color 0.2s; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„èƒŒæ™¯è‰²è¿‡æ¸¡åŠ¨ç”» */
    border-radius: 4px; /* ç»™ä¸€ç‚¹ç‚¹åœ†è§’ï¼Œæ›´å¥½çœ‹ */
    padding: 2px 5px; /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·ï¼Œè®©ç‚¹å‡»åŒºåŸŸæ›´å¤§ */
    margin: 0 -5px; /* æŠŠä¸Šé¢çš„å†…è¾¹è·æŠµæ¶ˆæ‰ï¼Œä¿æŒå¯¹é½ */
}
.weibo-comment-item:hover {
    background-color: #f0f2f5; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶ï¼Œç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
}
#phone-screen.dark-mode .weibo-comment-item:hover {
    background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœé¢œè‰² */
}

/* â€œå›å¤â€è¿™ä¸¤ä¸ªå­—çš„æ ·å¼ï¼Œè®©å®ƒæ›´æŸ”å’Œ */
.weibo-comment-item .weibo-comment-reply-tag {
    color: var(--text-secondary);
    margin: 0 4px; /* å’Œä¸¤è¾¹çš„åå­—æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

/* è¢«å›å¤è€…çš„åå­—æ ·å¼ï¼Œè®©å®ƒå’Œæ™®é€šè¯„è®ºè€…åå­—ä¸€æ ·å¯ä»¥ç‚¹å‡» */
.weibo-comment-item .reply-target-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºAppå†…å£çº¸æ ·å¼ â–¼â–¼â–¼ */

/* å½“å†…éƒ¨å±å¹•æœ‰å£çº¸æ—¶ï¼Œè®¾ç½®èƒŒæ™¯å›¾çš„æ˜¾ç¤ºæ–¹å¼ */
.character-phone-inner-screen.has-app-wallpaper {
    background-size: cover;
    background-position: center;
}

/* å…³é”®ï¼šè®©æ‰€æœ‰Appé¡µé¢çš„å†…å®¹åˆ—è¡¨èƒŒæ™¯å˜é€æ˜ */
.character-phone-inner-screen.has-app-wallpaper .list-container,
.character-phone-inner-screen.has-app-wallpaper #character-chat-history-messages {
    background-color: transparent !important;
}

/* ä¸ºäº†ä¿è¯æ–‡å­—çš„å¯è¯»æ€§ï¼Œæˆ‘ä»¬ç»™åˆ—è¡¨é¡¹å’Œå¡ç‰‡åŠ ä¸ŠåŠé€æ˜çš„èƒŒæ™¯ */
.character-phone-inner-screen.has-app-wallpaper .character-data-item,
.character-phone-inner-screen.has-app-wallpaper .character-cart-item,
.character-phone-inner-screen.has-app-wallpaper .character-browser-item,
.character-phone-inner-screen.has-app-wallpaper .character-bank-transaction,
.character-phone-inner-screen.has-app-wallpaper .chat-list-item {
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* åŒæ ·ä¸ºèŠå¤©æ°”æ³¡å¢åŠ åŠé€æ˜æ•ˆæœ */
.character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.received .character-chat-bubble {
    background-color: rgba(255, 255, 255, 0.85);
}
.character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.sent .character-chat-bubble {
    background-color: rgba(149, 236, 105, 0.85); /* å¾®ä¿¡ç»¿ï¼Œä½†å¸¦ä¸€ç‚¹é€æ˜ */
}

/* é€‚é…å¤œé—´æ¨¡å¼çš„åŠé€æ˜é¢œè‰² */
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-data-item,
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .chat-list-item {
     background-color: rgba(28, 28, 30, 0.7);
}
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.received .character-chat-bubble {
    background-color: rgba(44, 44, 46, 0.85);
}
#phone-screen.dark-mode .character-phone-inner-screen.has-app-wallpaper .character-chat-bubble-container.sent .character-chat-bubble {
     background-color: rgba(48, 93, 32, 0.85); /* å¤œé—´æ¨¡å¼çš„ç»¿è‰² */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œæ¸¸æˆåˆ†äº«â€æ–°å¢çš„é¢œè‰²æ ·å¼ â–¼â–¼â–¼ */
.share-type.game {
    background-color: #9c27b0; /* ä¸€ä¸ªä»£è¡¨æ¸¸æˆçš„ç¥ç§˜ç´«è‰² */
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒåŠ¨é£è¡Œæ£‹æ ·å¼ â–¼â–¼â–¼ */

/* --- æ¸¸æˆä¸»ç•Œé¢å¸ƒå±€ --- */
#ludo-game-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 15px;
    box-sizing: border-box;
    gap: 15px;
    background-color: #fff0f5; /* æ¸©æŸ”çš„æ·¡ç²‰è‰²èƒŒæ™¯ */
}

#phone-screen.dark-mode #ludo-game-content {
    background-color: #2c1e22; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ·±ç²‰ç´«è‰² */
}

/* --- æ£‹ç›˜å®¹å™¨ä¸æ£‹ç›˜æœ¬èº« --- */
#ludo-board-container {
    position: relative;
    width: 100%;
    height: 280px; /* ç»™æ£‹ç›˜ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    flex-shrink: 0;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    padding: 10px;
    box-sizing: border-box;
}

#ludo-board {
    display: grid;
    grid-template-columns: repeat(10, 1fr); /* 10x6çš„ç½‘æ ¼å¸ƒå±€ */
    grid-template-rows: repeat(6, 1fr);
    width: 100%;
    height: 100%;
    gap: 3px;
}

/* --- æ£‹ç›˜æ ¼å­æ ·å¼ --- */
.ludo-cell {
    border-radius: 4px;
    background-color: rgba(255, 192, 203, 0.3); /* æ·¡æ·¡çš„ç²‰è‰²æ ¼å­ */
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
    font-weight: bold;
    color: #db7093;
}

/* èµ·ç‚¹å’Œç»ˆç‚¹æ ¼å­ */
.ludo-cell.start { background-color: #90ee90; color: #2e8b57; }
.ludo-cell.end { background-color: #ffd700; color: #b8860b; }

/* ç‰¹æ®Šäº‹ä»¶æ ¼å­ */
.ludo-cell.event-truth { background-color: #ffb6c1; } /* çœŸå¿ƒè¯ */
.ludo-cell.event-dare { background-color: #add8e6; }  /* å¤§å†’é™© */
.ludo-cell.event-kiss { background-color: #ff69b4; }  /* äº²äº² */
.ludo-cell.event-hug { background-color: #ffdab9; }   /* æŠ±æŠ± */

.ludo-cell .cell-number {
    font-size: 10px;
    position: absolute;
    top: 2px;
    left: 3px;
    color: rgba(0,0,0,0.2);
}

/* --- æ£‹å­æ ·å¼ --- */
.ludo-piece {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
}
.ludo-piece.user { border-color: #87cefa; }
.ludo-piece.char { border-color: #ffc0cb; }

/* --- æ¸¸æˆæ—¥å¿— --- */
#ludo-log-container {
    flex-grow: 1;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    padding: 10px;
    overflow-y: auto;
    min-height: 0;
}
#ludo-game-log .log-entry {
    padding: 6px 8px;
    font-size: 14px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    line-height: 1.5;
}
#ludo-game-log .log-entry.system {
    color: #db7093;
    font-style: italic;
    text-align: center;
}
#ludo-game-log .log-entry.user { color: #007bff; }
#ludo-game-log .log-entry.char { color: #e83e8c; }
#ludo-game-log .log-entry strong { font-weight: 900; }


/* --- æ“ä½œåŒºä¸éª°å­åŠ¨ç”» --- */
#ludo-action-area {
    flex-shrink: 0;
    padding: 10px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60px;
}
#ludo-dice-container {
    perspective: 1000px;
}
.dice {
    width: 50px;
    height: 50px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 1s;
    cursor: pointer;
}
.dice.rolling { animation: roll-dice 1.5s ease-out; }
@keyframes roll-dice {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    100% { transform: rotateX(1080deg) rotateY(720deg); }
}
.dice .face {
    position: absolute;
    width: 50px;
    height: 50px;
    border: 1px solid #ccc;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    font-weight: bold;
}
.face.front  { transform: rotateY(0deg) translateZ(25px); }
.face.back   { transform: rotateY(180deg) translateZ(25px); }
.face.right  { transform: rotateY(90deg) translateZ(25px); }
.face.left   { transform: rotateY(-90deg) translateZ(25px); }
.face.top    { transform: rotateX(90deg) translateZ(25px); }
.face.bottom { transform: rotateX(-90deg) translateZ(25px); }

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é£è¡Œæ£‹é—®é¢˜ç±»å‹æ ‡ç­¾æ ·å¼ â–¼â–¼â–¼ */
.question-type-tag {
    font-size: 10px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 10px;
    color: white;
    margin-left: 10px;
    flex-shrink: 0;
}
.question-type-tag.both-answer {
    background-color: #ff8fab; /* ç²‰è‰²ä»£è¡¨å…±åŒå›ç­” */
}
.question-type-tag.single-answer {
    background-color: #87ceeb; /* è“è‰²ä»£è¡¨ä¸€äººå›ç­” */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é£è¡Œæ£‹ç»“ç®—å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
#ludo-summary-content h3 {
    text-align: center;
    color: var(--accent-color);
    margin-bottom: 15px;
    font-size: 20px;
    font-weight: bold;
}
#ludo-summary-content .ludo-qa-log {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    max-height: 300px; /* ç»™é—®ç­”è®°å½•ä¸€ä¸ªæœ€å¤§é«˜åº¦ï¼Œå†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
    overflow-y: auto;
}
#ludo-summary-content h4 {
    margin-bottom: 10px;
    color: var(--text-primary);
}
#ludo-summary-content .qa-item {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}
#ludo-summary-content .qa-item:last-child {
    border-bottom: none;
}
#ludo-summary-content .qa-question {
    font-weight: 600;
    color: #db7093; /* ä¸€ä¸ªå¯çˆ±çš„ç²‰ç´«è‰² */
    margin-bottom: 8px;
}
#ludo-summary-content .qa-answer {
    padding-left: 15px;
    font-size: 14px;
    color: var(--text-secondary);
}
#ludo-summary-content .qa-answer strong {
    color: var(--text-primary);
}
#phone-screen.dark-mode #ludo-summary-content .qa-answer {
    color: #bbb;
}


/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘è§’è‰²æ‰‹æœºæ¶ˆæ¯åˆ—è¡¨ - å¯çˆ±ç£¨ç ‚é€æ˜åœ†è§’ç‰ˆ v3.0 â–¼â–¼â–¼ */

/* 1. ç»™æ¶ˆæ¯åˆ—è¡¨å®¹å™¨å¢åŠ å†…è¾¹è·å’Œé—´è·ï¼Œä¸ºå¡ç‰‡ç•™å‡ºå‘¼å¸ç©ºé—´ */
#character-chat-list.list-container {
    padding: 15px 10px;
    display: flex;
    flex-direction: column;
    gap: 15px; /* â€œæˆ‘â€çš„å¡ç‰‡å’Œâ€œå…¶ä»–äººâ€å¡ç‰‡ä¹‹é—´çš„é—´è· */
}

/* 2. é‡ç½®æ‰€æœ‰åˆ—è¡¨é¡¹çš„åŸºç¡€æ ·å¼ï¼Œç§»é™¤æ—§çš„è¾¹æ¡† */
#character-chat-list .chat-list-item {
    border-bottom: none !important;
}

/* 3. ã€ä½ çš„ä¸“å±ã€‘å•ç‹¬è®¾ç½®â€œæˆ‘çš„æ¶ˆæ¯â€(ç¬¬ä¸€ä¸ª)çš„å¯çˆ±èƒ¶å›Šæ ·å¼ */
#character-chat-list > .chat-list-item {
    background-color: rgba(255, 255, 255, 0.1); /* è¶…çº§é€æ˜çš„ç™½è‰²èƒŒæ™¯ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 25px; /* å¯çˆ±çš„èƒ¶å›Šåœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.15); /* æ·¡æ·¡çš„äº®è¾¹ï¼Œå¢åŠ è´¨æ„Ÿ */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* æŸ”å’Œçš„é˜´å½±ï¼Œè¥é€ æ‚¬æµ®æ„Ÿ */
    padding: 15px; /* å¢åŠ å†…è¾¹è·ï¼Œè®©å†…å®¹æ›´èˆ’æœ */
    color: white; /* æ–‡å­—é¢œè‰²ä¹Ÿå˜æˆç™½è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* ç»™æ–‡å­—åŠ ä¸€ç‚¹é˜´å½±ä¿è¯æ¸…æ™°åº¦ */
}
#character-chat-list > .chat-list-item .last-msg {
    color: rgba(255, 255, 255, 0.7); /* é¢„è§ˆæ¶ˆæ¯çš„æ–‡å­—é¢œè‰²æ·¡ä¸€ç‚¹ */
}


/* 4. ã€ä½ çš„ä¸“å±ã€‘è®¾ç½®â€œå…¶ä»–äººæ¶ˆæ¯â€å®¹å™¨çš„æ ·å¼ */
.npc-chat-group {
    background-color: rgba(255, 255, 255, 0.1); /* åŒæ ·è¶…çº§é€æ˜ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 25px; /* å®¹å™¨æœ¬èº«ä¹Ÿæ˜¯åœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden; /* å…³é”®ï¼è®©å†…éƒ¨çš„åˆ—è¡¨é¡¹ä¸¥æ ¼éµå®ˆå®¹å™¨çš„åœ†è§’ */
    padding: 5px 0; /* å®¹å™¨å†…éƒ¨çš„ä¸Šä¸‹ç•™ç™½ */
}

/* 5. è®¾ç½®å®¹å™¨å†…éƒ¨å•ä¸ªæ¶ˆæ¯çš„æ ·å¼ */
.npc-chat-group .chat-list-item {
    background-color: transparent !important; /* å†…éƒ¨çš„é¡¹å®Œå…¨é€æ˜ */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important; /* ç”¨æ·¡æ·¡çš„äº®çº¿åˆ†éš” */
    padding: 12px 15px;
    color: white; /* æ–‡å­—é¢œè‰²ä¹Ÿæ˜¯ç™½è‰² */
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.npc-chat-group .chat-list-item .last-msg {
    color: rgba(255, 255, 255, 0.7);
}

/* 6. ç§»é™¤å®¹å™¨å†…ã€æœ€åä¸€ä¸ªã€‘æ¶ˆæ¯çš„ä¸‹åˆ’çº¿ï¼Œè®©å¡ç‰‡åº•éƒ¨æ›´å¹²å‡€ */
.npc-chat-group .chat-list-item:last-child {
    border-bottom: none !important;
}
/* â–²â–²â–² å®šåˆ¶ç»“æŸ â–²â–²â–² */



/* ======================================================================= */
/* ===         ä¿®å¤â€œæŸ¥æ‰‹æœº-å¤–è§‚è®¾ç½®â€ä¸­é¢„è§ˆå›¾è¿‡å¤§çš„é—®é¢˜ v1.0         === */
/* ======================================================================= */

/* 1. ä¿®å¤æ‰‹æœºå£çº¸å’ŒAppå†…å£çº¸çš„é¢„è§ˆ */
/* 
   é—®é¢˜åŸå› ï¼šä¹‹å‰çš„æ ·å¼æ˜¯ background-size: coverï¼Œä¼šå¼ºåˆ¶å›¾ç‰‡å¡«æ»¡é¢„è§ˆæ¡†ï¼Œå¯¼è‡´è£å‰ªã€‚
   è§£å†³æ–¹æ¡ˆï¼šæ”¹ä¸º background-size: containï¼Œè®©å›¾ç‰‡åœ¨æ¡†å†…å®Œæ•´æ˜¾ç¤ºã€‚
*/
#char-phone-wallpaper-preview,
#char-phone-app-wallpaper-preview {
    background-size: contain !important; 
    background-repeat: no-repeat !important; /* é˜²æ­¢å›¾ç‰‡åœ¨æ— æ³•å¡«æ»¡æ—¶é‡å¤å¹³é“º */
}

/* 2. ä¿®å¤ä¸¤ä¸ªæ¡Œé¢å°ç»„ä»¶çš„å›¾ç‰‡é¢„è§ˆ */
/* 
   é—®é¢˜åŸå› ï¼šå’Œä¸Šé¢ç±»ä¼¼ï¼Œä½†å¯¹äº<img>æ ‡ç­¾ï¼Œæ§åˆ¶æ˜¾ç¤ºæ–¹å¼çš„å±æ€§æ˜¯ object-fitã€‚
   è§£å†³æ–¹æ¡ˆï¼šåŒæ ·å°† cover æ”¹ä¸º containã€‚
*/
#char-phone-widget-preview-1,
#char-phone-widget-preview-2 {
    object-fit: contain !important;
    /* (å¯é€‰ç¾åŒ–) ä¸ºæ²¡æœ‰å›¾ç‰‡æ—¶çš„é¢„è§ˆæ¡†åŠ ä¸ªåº•è‰²ï¼Œæ›´å¥½çœ‹ */
    background-color: #f0f2f5; 
}
/* ======================================================================= */
/* ===         ã€V2 æœ€ç»ˆä¿®å¤ã€‘ä¿®å¤æŸ¥æ‰‹æœº-å°ç»„ä»¶é¢„è§ˆå›¾è¿‡å¤§é—®é¢˜         === */
/* ======================================================================= */

#char-phone-widget-preview-1,
#char-phone-widget-preview-2 {
    background-size: contain !important;      /* æ ¸å¿ƒï¼šè®©èƒŒæ™¯å›¾å®Œæ•´æ˜¾ç¤º */
    background-repeat: no-repeat !important; /* é˜²æ­¢å›¾ç‰‡é‡å¤å¹³é“º */
    background-position: center !important;  /* ç¡®ä¿å›¾ç‰‡å±…ä¸­ */
}


/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘å¿ƒåŠ¨é£è¡Œæ£‹è¾“å…¥æ¡† - ç²‰è‰²æŒ‰é’®ç‰ˆ v1.0 â–¼â–¼â–¼ */

/* 1. è¾“å…¥åŒºåŸŸçš„å®¹å™¨æ ·å¼ (ä¿æŒä¸å˜) */
#ludo-action-area {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 10px 12px !important;
}

/* 2. æ–‡æœ¬è¾“å…¥æ¡†çš„æ ·å¼ (ä¿æŒä¸å˜) */
#ludo-action-area #ludo-user-speech-input {
    flex-grow: 1; 
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px; 
    line-height: 1.5;
    box-sizing: border-box;
}

/* 3. â€œç¡®è®¤å›ç­”â€æŒ‰é’®çš„æ ·å¼ (å·²ä¿®æ”¹ä¸ºç²‰è‰²) */
#ludo-action-area .form-button {
    width: auto !important;
    height: 40px; 
    border-radius: 20px;
    padding: 0 20px;
    flex-shrink: 0; 
    font-size: 14px;
    font-weight: 600;
    margin: 0 !important;
    border: none;
    cursor: pointer;
    
    /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨å¯çˆ±çš„ç²‰è‰²æ¸å˜å’Œé˜´å½± â˜…â˜…â˜… */
    background: linear-gradient(135deg, #ff8fab, #fb6f92);
    color: white;
    box-shadow: 0 4px 10px rgba(251, 111, 146, 0.3);
    transition: all 0.2s ease-in-out;
}

/* â˜…â˜…â˜… æ–°å¢ï¼šä¸ºæŒ‰é’®æ·»åŠ æ›´ç”ŸåŠ¨çš„äº¤äº’æ•ˆæœ â˜…â˜…â˜… */
#ludo-action-area .form-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(251, 111, 146, 0.4);
}
#ludo-action-area .form-button:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 5px rgba(251, 111, 146, 0.3);
}

/* 4. å¤œé—´æ¨¡å¼é€‚é… (ä¿æŒä¸å˜) */
#phone-screen.dark-mode #ludo-action-area #ludo-user-speech-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}
/* â–²â–²â–² ç¾åŒ–ä»£ç ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°é¢æ¿èƒŒæ™¯å›¾æ ·å¼ â–¼â–¼â–¼ */
#inner-voice-main-panel.modal-content {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    /* æˆ‘ä»¬ç»™å®ƒåŠ ä¸€ä¸ªè¿‡æ¸¡æ•ˆæœï¼Œè®©èƒŒæ™¯åˆ‡æ¢æ›´å¹³æ»‘ */
    transition: background-image 0.3s ease-in-out;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œè°æ˜¯å§åº•â€æ¸¸æˆæ ·å¼ â–¼â–¼â–¼ */

/* ç©å®¶å¤´åƒä¸Šæ˜¾ç¤ºè§’è‰²èº«ä»½çš„å°å›¾æ ‡ */
.player-seat .player-role-display {
    position: absolute;
    bottom: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 5px;
    font-weight: bold;
}

/* â€œä½ è¯´æˆ‘çŒœâ€å‘è¨€è¾“å…¥åŒºçš„ç¾åŒ– */
#undercover-action-area.speaking-mode {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 0;
}
#undercover-action-area.speaking-mode #undercover-user-speech-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
    width: auto !important; 
    height: auto !important;
}
#undercover-action-area.speaking-mode #undercover-end-speech-btn {
    height: 40px;
    border-radius: 20px;
    padding: 0 15px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
    margin: 0 !important; 
    width: auto !important;
    background-color: var(--accent-color);
    color: white;
    border: none;
}
#phone-screen.dark-mode #undercover-action-area.speaking-mode #undercover-user-speech-input {
    background-color: #2c2c2e;
    color: var(--text-primary);
}

/* â–¼â–¼â–¼ ç¬¬2æ­¥ï¼šå°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘ç”¨æˆ·å‘å‡ºçš„â€œè§£é™¤å…³ç³»â€å¡ç‰‡æ ·å¼ --- */

/* 1. è®©å¡ç‰‡çš„å®¹å™¨æ°”æ³¡å˜é€æ˜ï¼Œæ¶ˆé™¤é»˜è®¤èƒŒæ™¯ */
.message-bubble.is-ls-disconnect .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* 2. å¡ç‰‡ä¸»ä½“æ ·å¼ */
.lovers-space-disconnect-card {
    width: 220px; /* å®½åº¦å¯ä»¥è‡ªå·±è°ƒæ•´ */
    background: linear-gradient(135deg, #f5f7fa, #e9ecef); /* æµ…ç°è‰²æ¸å˜ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    border-radius: 12px;
    border: 1px solid #ced4da;
    display: flex;
    align-items: center;
    gap: 15px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* 3. å¤œé—´æ¨¡å¼ä¸‹çš„å¡ç‰‡é¢œè‰² */
#phone-screen.dark-mode .lovers-space-disconnect-card {
    background: linear-gradient(135deg, #495057, #343a40);
    border-color: #6c757d;
}

/* 4. å¿ƒç¢ Emoji å›¾æ ‡çš„æ ·å¼ */
.lovers-space-disconnect-card .icon {
    font-size: 32px; /* Emoji å¤§å° */
    line-height: 1;
}

/* 5. æ–‡å­—åŒºåŸŸçš„æ ·å¼ */
.lovers-space-disconnect-card .text-content .title {
    font-weight: 600;
    font-size: 16px;
    color: var(--text-primary);
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯Userè‡ªå·±çš„ç§ä¿¡åŠŸèƒ½çš„æ‰€æœ‰æ–°æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. ç§ä¿¡åˆ—è¡¨é¡µé¢ --- */
#user-dm-list-container .dm-list-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
#user-dm-list-container .dm-list-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode #user-dm-list-container .dm-list-item:hover {
    background-color: #2c2c2e;
}
#user-dm-list-container .dm-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}
#user-dm-list-container .dm-info {
    flex-grow: 1;
    overflow: hidden;
}
#user-dm-list-container .dm-name-line {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
}
#user-dm-list-container .dm-name {
    font-weight: 600;
    font-size: 16px;
}
#user-dm-list-container .dm-persona-tag {
    font-size: 10px;
    color: var(--text-secondary);
    background-color: #f0f0f0;
    padding: 2px 6px;
    border-radius: 4px;
}
#phone-screen.dark-mode #user-dm-list-container .dm-persona-tag {
    background-color: #3a3a3c;
}
#user-dm-list-container .dm-last-msg {
    font-size: 14px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- 2. ç§ä¿¡è¯¦æƒ…é¡µé¢ (èŠå¤©ç•Œé¢) --- */
#user-dm-messages-container {
    background-color: #f0f2f5 !important;
}
#phone-screen.dark-mode #user-dm-messages-container {
    background-color: #000000 !important;
}

/* å¤ç”¨ä¸»èŠå¤©ç•Œé¢çš„æ°”æ³¡æ ·å¼ï¼Œä½†ä¸ºç²‰ä¸å’ŒUserå®šä¹‰ç‰¹å®šå¯¹é½æ–¹å¼ */
#user-dm-messages-container .message-wrapper.fan {
    align-self: flex-start;
}
#user-dm-messages-container .message-wrapper.fan .message-bubble {
    flex-direction: row;
}
#user-dm-messages-container .message-wrapper.fan .content {
    background-color: #ffffff; /* ç²‰ä¸ç”¨ç™½è‰²æ°”æ³¡ */
    color: var(--text-primary);
    border-radius: 2px 18px 18px 18px;
}

#user-dm-messages-container .message-wrapper.user-self { /* ä½¿ç”¨æ–°classï¼Œé¿å…å†²çª */
    align-self: flex-end;
}
#user-dm-messages-container .message-wrapper.user-self .message-bubble {
    flex-direction: row-reverse;
}
/* ä½ è‡ªå·±çš„æ¶ˆæ¯ï¼Œä½¿ç”¨å¾®åšçš„æ©™è‰² */
#user-dm-messages-container .message-wrapper.user-self .content {
    background-color: #ff8200; 
    color: white;
    border-radius: 18px 2px 18px 18px;
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #user-dm-messages-container .message-wrapper.fan .content {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode #user-dm-messages-container .message-wrapper.user-self .content {
    background-color: #e67300;
}

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ user-dm-input-area ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. ç§ä¿¡è¾“å…¥åŒºåŸŸçš„æ•´ä½“èƒŒæ™¯å’Œè¾¹è· (è¿™éƒ¨åˆ†ä¿æŒä¸å˜) --- */
#user-dm-input-area {
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    padding: 10px 12px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* --- 2. æ ¸å¿ƒå¸ƒå±€ï¼šå¼ºåˆ¶è¾“å…¥æ¡†å’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œ --- */
/* æˆ‘ä»¬ç”¨ä¸€ä¸ªæ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œæ¥ç¡®ä¿æ ·å¼èƒ½ç”Ÿæ•ˆ */
#user-dm-detail-screen .chat-input-main-row {
    display: flex;         /* å…³é”®ï¼šè®¾ä¸ºflexå¸ƒå±€ */
    flex-direction: row;   /* å…³é”®ï¼šå¼ºåˆ¶æ¨ªå‘æ’åˆ— */
    align-items: flex-end; /* è®©å¤šè¡Œè¾“å…¥æ—¶ï¼ŒæŒ‰é’®å’Œè¾“å…¥æ¡†åº•éƒ¨å¯¹é½ï¼Œæ›´å¥½çœ‹ */
    gap: 8px;              /* è¾“å…¥æ¡†å’ŒæŒ‰é’®ç»„ä¹‹é—´çš„é—´è· */
}

/* --- 3. è¾“å…¥æ¡†ï¼šè®©å®ƒè‡ªåŠ¨ä¼¸å±•ï¼Œå æ»¡å·¦ä¾§æ‰€æœ‰ç©ºé—´ --- */
#user-dm-input-area #user-dm-input {
    flex-grow: 1; /* å…³é”®ï¼ */
    
    /* ä¸‹é¢æ˜¯è¾“å…¥æ¡†çš„å¤–è§‚ï¼Œä¿æŒä¸å˜ */
    border: 1px solid #ddd;
    border-radius: 18px;
    padding: 8px 15px;
    line-height: 1.5;
    min-height: 38px;
    max-height: 100px;
    resize: none;
    background-color: #fff;
}

/* --- 4. æŒ‰é’®å®¹å™¨ï¼šè®©æ‰€æœ‰æŒ‰é’®åœ¨é‡Œé¢æ¨ªå‘æ’åˆ— --- */
#user-dm-input-area #input-actions-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®ä»¬è¢«æŒ¤å‹å˜å½¢ */
}

/* --- 5. ã€ä½ çš„è¦æ±‚ã€‘ä¿®æ”¹â€œå‘é€â€æŒ‰é’®ä¸ºåœ†è§’çŸ©å½¢ --- */
#user-dm-input-area #user-dm-send-btn {
    height: 38px;
    border-radius: 8px; /* â˜…â˜…â˜… ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œï¼ä» 18px æ”¹ä¸º 8px â˜…â˜…â˜… */
    background-color: #ff8200;
    /* --- ä»¥ä¸‹ä¸ºè¡¥å……æ ·å¼ï¼Œè®©æŒ‰é’®æ›´å¥½çœ‹ --- */
    border: none;
    color: white;
    font-weight: 600;
    font-size: 14px;
    padding: 0 15px; /* è®©æ–‡å­—ä¸é‚£ä¹ˆæ‹¥æŒ¤ */
}

/* --- 6. å…¶ä»–ä¸¤ä¸ªå›¾æ ‡æŒ‰é’®çš„æ ·å¼ (ä¿æŒä¸å˜) --- */
#user-dm-input-area .chat-action-icon-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    padding: 0;
    font-size: 24px;
    background-color: rgba(0,0,0,0.05);
    color: var(--text-primary);
    border: 1px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

/* --- 7. å¤œé—´æ¨¡å¼é€‚é… (ä¿æŒä¸å˜) --- */
#phone-screen.dark-mode #user-dm-input-area {
    background-color: #1c1c1e;
    border-top-color: #38383a;
}
#phone-screen.dark-mode #user-dm-input-area #user-dm-input {
    background-color: #2c2c2e;
    border-color: #38383a;
    color: white;
}
#phone-screen.dark-mode #user-dm-input-area .chat-action-icon-btn {
     background-color: rgba(255,255,255,0.1);
     border-color: rgba(255,255,255,0.1);
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºUserç§ä¿¡è¾“å…¥æ¡†æ–°å¢çš„æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

#user-dm-input-area #input-actions-wrapper {
    display: flex;
    align-items: flex-end; /* ç¡®ä¿æŒ‰é’®åº•éƒ¨å¯¹é½ */
    gap: 8px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
}

/* å¤ç”¨ä¸»èŠå¤©ç•Œé¢çš„å°å›¾æ ‡æŒ‰é’®æ ·å¼ */
#user-dm-input-area .chat-action-icon-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    padding: 0;
    font-size: 24px;
    background-color: rgba(0,0,0,0.05);
    color: var(--text-primary);
    border: 1px solid rgba(0,0,0,0.05);
}

#phone-screen.dark-mode #user-dm-input-area .chat-action-icon-btn {
     background-color: rgba(255,255,255,0.1);
     border-color: rgba(255,255,255,0.1);
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯Userç§ä¿¡åˆ é™¤åŠŸèƒ½çš„æ‰€æœ‰æ–°æ ·å¼ â–¼â–¼â–¼ */

/* --- å•æ¡æ¶ˆæ¯åˆ é™¤æŒ‰é’® --- */
/* 1. è®©æ¯æ¡æ¶ˆæ¯çš„å®¹å™¨å¯ä»¥ä½œä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½å‚è€ƒç‚¹ */
#user-dm-messages-container .message-wrapper {
    position: relative;
}

/* 2. åˆ é™¤æŒ‰é’®æœ¬èº«çš„æ ·å¼ */
.user-dm-message-delete-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.1);
    color: #555;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease;
    z-index: 10;
}

/* 3. é¼ æ ‡æ‚¬åœåœ¨æ•´æ¡æ¶ˆæ¯ä¸Šæ—¶ï¼Œæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
#user-dm-messages-container .message-wrapper:hover .user-dm-message-delete-btn {
    opacity: 1;
}
.user-dm-message-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}

/* 4. æ ¹æ®æ¶ˆæ¯æ˜¯ç²‰ä¸çš„è¿˜æ˜¯ä½ çš„ï¼Œå†³å®šæŒ‰é’®çš„ä½ç½® */
#user-dm-messages-container .message-wrapper.fan .user-dm-message-delete-btn {
    right: -28px; /* æ”¾åœ¨æ°”æ³¡å³è¾¹ */
}
#user-dm-messages-container .message-wrapper.user-self .user-dm-message-delete-btn {
    left: -28px; /* æ”¾åœ¨æ°”æ³¡å·¦è¾¹ */
}

/* --- å·¦æ»‘åˆ é™¤æ•´ä¸ªå¯¹è¯ --- */
/* 1. æ»‘åŠ¨å®¹å™¨ */
.user-dm-list-item-swipe-container {
    position: relative;
    overflow: hidden;
    background-color: var(--secondary-bg);
}

/* 2. å¯æ»‘åŠ¨çš„å†…å®¹åŒº */
.user-dm-list-item-content {
    position: relative;
    z-index: 2;
    background-color: inherit;
    transition: transform 0.3s ease;
}
.user-dm-list-item-content.swiped {
    transform: translateX(-80px); /* å‘å·¦æ»‘åŠ¨80pxï¼Œéœ²å‡ºåˆ é™¤æŒ‰é’® */
}

/* 3. éšè—åœ¨åé¢çš„æ“ä½œæŒ‰é’®åŒºåŸŸ */
.user-dm-swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
}

/* 4. â€œåˆ é™¤â€æŒ‰é’®çš„æ ·å¼ */
.user-dm-swipe-actions .swipe-action-btn {
    height: 100%;
    padding: 0 20px;
    border: none;
    color: white;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    background-color: #ff3b30; /* çº¢è‰²èƒŒæ™¯ */
}

/* 5. ä¿®å¤åˆ†å‰²çº¿ï¼Œè®©æ»‘åŠ¨æ•ˆæœæ›´å®Œç¾ */
#user-dm-list-container .dm-list-item {
    border-bottom: none; /* ç§»é™¤åŸå§‹çš„åˆ†å‰²çº¿ */
}
#user-dm-list-container .user-dm-list-item-swipe-container:not(:last-child) {
    border-bottom: 1px solid var(--border-color); /* åœ¨æ»‘åŠ¨å®¹å™¨ä¸Šæ·»åŠ æ–°åˆ†å‰²çº¿ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç»­ç«èŠ±å›¾æ ‡æ ·å¼ â–¼â–¼â–¼ */
.streak-indicator {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 13px; /* è°ƒæ•´äº†å­—ä½“å¤§å°ï¼Œè®©å®ƒæ›´ç²¾è‡´ */
    color: #ff6f00; /* æ¸©æš–çš„æ©™è‰² */
    font-weight: bold;
    margin-left: 8px; /* å’Œè§’è‰²åå­—æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    text-shadow: 0 0 5px rgba(255, 152, 0, 0.5); /* åŠ ä¸€ç‚¹å‘å…‰æ•ˆæœ */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†åˆ—è¡¨æ ·å¼ --- */
#member-management-list .list-container-title {
    padding: 10px 15px;
    font-size: 14px;
    color: var(--text-secondary);
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #member-management-list .list-container-title {
    background-color: #1c1c1e;
}

#member-management-list .member-management-item {
    background-color: var(--secondary-bg);
}

/* å•ä¸ªæˆå‘˜é¡¹ */
.member-management-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 6px; /* æ–¹å½¢åœ†è§’å¤´åƒ */
    margin-right: 12px;
}

/* æˆå‘˜ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´è¡”ã€èº«ä»½ï¼‰ */
.member-management-item .info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.member-management-item .info .name {
    font-weight: 500;
}
.member-management-item .info .tags {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* èº«ä»½æ ‡ç­¾ï¼ˆç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰ */
.member-management-item .role-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    color: white;
}
.role-tag.owner { background-color: #ffc107; } /* é»„è‰² */
.role-tag.admin { background-color: #28a745; } /* ç»¿è‰² */

/* å¤´è¡”æ ‡ç­¾ */
.member-management-item .title-tag {
    font-size: 11px;
    color: var(--text-secondary);
    background-color: #f0f2f5;
    padding: 2px 6px;
    border-radius: 4px;
}
#phone-screen.dark-mode .member-management-item .title-tag {
    background-color: #3a3a3c;
}

/* æ“ä½œæŒ‰é’® */
.member-management-item .actions {
    display: flex;
    gap: 8px;
}
.member-management-item .actions button {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background-color: #f8f9fa;
}
#phone-screen.dark-mode .member-management-item .actions button {
    background-color: #3e3e42;
    border-color: #545458;
}
.member-management-item .actions button.danger {
    border-color: #ff4d4f;
    color: #ff4d4f;
}

/* --- ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å†…çš„èº«ä»½/å¤´è¡”æ ‡ç­¾ --- */
.group-sender-tags {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-left: 6px;
    vertical-align: middle;
}
.group-role-tag, .group-title-tag {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 8px;
    font-weight: 500;
    line-height: 1.4;
}
.group-role-tag.owner {
    background-color: #FFF2C2;
    color: #D98C00;
    border: 1px solid #FFE89D;
}
.group-role-tag.admin {
    background-color: #D4EDDA;
    color: #155724;
    border: 1px solid #C3E6CB;
}
.group-title-tag {
    background-color: #f0f2f5;
    color: var(--text-secondary);
}

#phone-screen.dark-mode .group-role-tag.owner { background-color: #594200; color: #FFD466; border-color: #795B00;}
#phone-screen.dark-mode .group-role-tag.admin { background-color: #104A3C; color: #76DDC4; border-color: #176854;}
#phone-screen.dark-mode .group-title-tag { background-color: #3a3a3c; }

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘è¯·å°†è¿™æ®µã€å…¨æ–°ã€‘çš„CSSä»£ç ï¼Œç²˜è´´åˆ°<style>æ ‡ç­¾çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¸å¿ƒï¼šä¸“é—¨ä¸ºç”¨æˆ·ï¼ˆuserï¼‰åœ¨ç¾¤èŠä¸­çš„æ¶ˆæ¯è¡Œå®šä¹‰æ ·å¼ */
.message-wrapper.user .group-sender-line {
    /* 1. å®šä½ï¼šä»å·¦ä¾§å®šä½æ”¹ä¸ºå³ä¾§å®šä½ï¼Œä¸ä½ çš„å¤´åƒå¯¹é½ */
    left: auto;
    right: 50px; /* åŸæ¥æ˜¯ left: 50px */

    /* 2. å¸ƒå±€ç¿»è½¬ï¼šè¿™æ˜¯å®ç°â€œæ ‡ç­¾åœ¨å·¦ï¼Œæ˜µç§°åœ¨å³â€çš„å…³é”®ï¼*/
    flex-direction: row-reverse; 
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘ŠåŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„ç¾¤å…¬å‘Šå°é»‘æ¿å›¾æ ‡çš„æ ·å¼ */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ä»£ç æ›¿æ¢ä½ æ—§çš„ #group-announcement-btn æ ·å¼ â–¼â–¼â–¼ */
#group-announcement-btn {
    display: none; /* JSæ§åˆ¶æ˜¾ç¤ºï¼Œä¿æŒä¸å˜ */
    position: absolute; /* æ ¸å¿ƒä¿®æ”¹ï¼šç»å¯¹å®šä½ */
    left: 100%; /* å®šä½åœ¨æ ‡é¢˜çš„å³è¾¹ */
    top: 50%; /* å‚ç›´å±…ä¸­çš„ç¬¬ä¸€æ­¥ */
    transform: translateY(-50%); /* å‚ç›´å±…ä¸­çš„ç¬¬äºŒæ­¥ */
    margin-left: 5px; /* ä¸æ ‡é¢˜çš„é—´è· */

    /* ä¿æŒè§†è§‰æ ·å¼ */
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    cursor: pointer;
    color: var(--accent-color);
    transition: background-color 0.2s;
    border-radius: 50%;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
#group-announcement-btn:hover {
    background-color: rgba(0,0,0,0.05); /* é¼ æ ‡æ‚¬åœæ—¶ç»™ä¸€ç‚¹åé¦ˆ */
}
#phone-screen.dark-mode #group-announcement-btn:hover {
    background-color: rgba(255,255,255,0.1);
}

/* å…¬å‘Šå¼¹çª—çš„æ ·å¼ */
#group-announcement-modal .modal-content {
    height: 70%; /* è®©å¼¹çª—é«˜ä¸€äº›ï¼Œæ–¹ä¾¿çœ‹å…¬å‘Š */
}

/* å…¬å‘Šå†…å®¹çš„æ˜¾ç¤ºåŒºåŸŸ */
#group-announcement-modal .modal-body {
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
    line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œæ›´æ˜“è¯» */
    font-size: 15px;
}

/* ç¼–è¾‘å…¬å‘Šæ—¶ï¼Œæ–‡æœ¬åŸŸçš„æ ·å¼ */
#group-announcement-modal textarea {
    width: 100%;
    height: 100%; /* å æ»¡æ•´ä¸ªå†…å®¹åŒº */
    min-height: 300px;
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    font-size: 15px;
    line-height: 1.7;
    resize: vertical; /* å…è®¸ç”¨æˆ·å‚ç›´æ‹–åŠ¨è°ƒæ•´å¤§å° */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘ç¾¤èŠæ˜µç§°ä¸æ ‡ç­¾é¡ºåºä¿®å¤ â–¼â–¼â–¼ */

/* 1. å…¨å±€å®šä¹‰æ˜¾ç¤ºé¡ºåºï¼šè®©æ ‡ç­¾æ°¸è¿œåœ¨åå­—å‰é¢ */
.group-sender-line > .group-sender-tags {
    order: 1;
}
.group-sender-line > .sender-name {
    order: 2;
}

/* 2. ä¸ºã€AI/ä»–äººæ¶ˆæ¯ã€‘è®¾ç½®å¯¹é½æ–¹å¼ (é å·¦) */
.message-wrapper.ai .group-sender-line {
    justify-content: flex-start; /* ç¡®ä¿å†…å®¹ä»å·¦è¾¹å¼€å§‹ */
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¿®æ­£ã€ä½ çš„æ¶ˆæ¯ã€‘çš„å¯¹é½æ–¹å¼ (é å³) */
/* è¿™å—ä»£ç ä¼šè¦†ç›–æ‰æ—§çš„ã€å¯¼è‡´é¡ºåºé”™ä¹±çš„è§„åˆ™ */
.message-wrapper.user .group-sender-line {
    left: auto;
    right: 50px; /* ä¿æŒåŸæœ‰çš„å³ä¾§å®šä½ */
    flex-direction: row; /* ç§»é™¤æ—§çš„â€œåè½¬â€æ•ˆæœ */
    justify-content: flex-end; /* è®©å†…å®¹å—æ•´ä½“é å³ï¼Œè¿™æ ·åå­—å°±èƒ½è´´è¿‘ä½ çš„å¤´åƒäº† */
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·è¡¨æƒ…é¢æ¿æ‰¹é‡åˆ é™¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. å½“è¡¨æƒ…é¢æ¿è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œéšè—â€œæ·»åŠ /ä¸Šä¼ â€æŒ‰é’® */
#sticker-panel.selection-mode #add-sticker-btn,
#sticker-panel.selection-mode #upload-sticker-btn {
    display: none;
}

/* 2. ä¸ºè¡¨æƒ…æ ¼å­æ·»åŠ é€‰æ‹©æ¡†çš„è§†è§‰æ•ˆæœ */
.sticker-item.in-selection-mode::before {
    content: '';
    position: absolute;
    top: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.2);
    background-color: rgba(255,255,255,0.7);
    transition: all 0.2s ease-in-out;
}

/* 3. å½“è¡¨æƒ…è¢«é€‰ä¸­æ—¶ï¼Œè®©é€‰æ‹©æ¡†å˜æˆå¸¦å¯¹å‹¾çš„âˆš */
.sticker-item.selected::before {
    background-color: var(--accent-color); /* ä½¿ç”¨ä½ çš„ä¸»é¢˜è‰² */
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* 4. åº•éƒ¨æ‰¹é‡åˆ é™¤æ“ä½œæ çš„æ ·å¼ */
#sticker-panel-footer {
    padding: 10px 15px;
    /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

#sticker-panel-footer button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background-color: #ff3b30; /* é†’ç›®çš„çº¢è‰² */
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

#sticker-panel-footer button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…æ‰¹é‡åˆ é™¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. å½“è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œéšè—é¡¶éƒ¨çš„â€œæ‰¹é‡æ·»åŠ /æœ¬åœ°ä¸Šä¼ â€æŒ‰é’® */
#char-sticker-manager-screen.selection-mode .panel-btn {
    display: none;
}

/* 2. è§’è‰²è¡¨æƒ…åŒ…çš„åº•éƒ¨æ“ä½œæ æ ·å¼ï¼Œå’Œç”¨æˆ·è¡¨æƒ…åŒ…çš„ç±»ä¼¼ */
#char-sticker-footer {
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

#char-sticker-footer button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background-color: #ff3b30;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

#char-sticker-footer button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

/* 3. ä¸ºé¡µç­¾å†…å®¹åŒºæ·»åŠ  active ç±»ï¼Œç”¨äºJSæ§åˆ¶æ˜¾ç¤º/éšè— */
.frame-content {
    display: none;
}
.frame-content.active {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå¿ƒå£°é¢æ¿ç¼–è¾‘åŠŸèƒ½æ–°å¢çš„CSS â–¼â–¼â–¼ */

/* å½“å¤´éƒ¨æœ‰è¿™ä¸ªclassæ—¶ï¼Œå¼ºåˆ¶éšè—åº•éƒ¨è¾¹æ¡† */
#inner-voice-main-panel .modal-header.no-border {
    border-bottom: none !important;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* å¼ºåˆ¶æå‡â€œå¿ƒå£°æ ·å¼ç¼–è¾‘å™¨â€çš„å±‚çº§ï¼Œç¡®ä¿å®ƒèƒ½è¦†ç›–åœ¨å¿ƒå£°é¢æ¿ä¹‹ä¸Š */
#inner-voice-editor-modal {
    z-index: 1001; /* è¿™ä¸ªå€¼æ¯”å¿ƒå£°é¢æ¿çš„é»˜è®¤å±‚çº§(1000)è¦é«˜ */
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå¿ƒå£°é¢æ¿å›¾æ ‡æ–°å¢çš„é¢œè‰²æ§åˆ¶æ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸ºå¿ƒå£°é¢æ¿å®šä¹‰ä¸€ä¸ªCSSå˜é‡ï¼Œå¹¶è®¾ç½®é»˜è®¤é¢œè‰² */
#inner-voice-main-panel {
    --iv-icon-color: #ff8a80; /* ä½ å¯ä»¥ä¿®æ”¹è¿™ä¸ªé»˜è®¤çš„ç²‰çº¢è‰² */
}

/* 2. è®©æ‰€æœ‰ç›®æ ‡å›¾æ ‡çš„é¢œè‰²éƒ½ä½¿ç”¨è¿™ä¸ªå˜é‡ */
#close-inner-voice-modal {
    color: var(--iv-icon-color);
}

#inner-voice-edit-btn svg,
#change-inner-voice-bg-btn svg,
#inner-voice-history-btn svg {
    /* æ ¸å¿ƒï¼šå°†å›¾æ ‡çš„çº¿æ¡é¢œè‰²è®¾ç½®ä¸ºæˆ‘ä»¬å®šä¹‰çš„å˜é‡ */
    stroke: var(--iv-icon-color);
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIç”Ÿæˆç¾¤æˆå‘˜æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
#member-management-actions #ai-generate-members-btn {
    background-color: #007bff; /* ä¸€ä¸ªé†’ç›®çš„è“è‰² */
    color: white;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜Appæ ·å¼ (V5 - ç»ˆæä¿®å¤ç‰ˆ) â–¼â–¼â–¼ */

#date-a-live-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #date-a-live-screen {
    background-color: #000;
}

/* â˜…â˜…â˜… è¿™æ˜¯æœ¬æ¬¡å”¯ä¸€çš„ã€ä½†æœ€å…³é”®çš„ä¿®æ”¹åŒºåŸŸ â˜…â˜…â˜… */
#dating-scene-content {
    flex: 1; /* â˜…â˜…â˜… æ ¸å¿ƒ1: è®©å†…å®¹åŒºå æ®çˆ¶å®¹å™¨ï¼ˆå±å¹•ï¼‰çš„æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    min-height: 0; /* â˜…â˜…â˜… æ ¸å¿ƒ2: flexå¸ƒå±€çš„ä¸€ä¸ªé‡è¦æŠ€å·§ï¼Œé˜²æ­¢å†…å®¹æº¢å‡ºæ—¶äº§ç”Ÿæ„å¤–çš„å¸ƒå±€é—®é¢˜ */
    overflow-y: auto; /* â˜…â˜…â˜… æ ¸å¿ƒ3: å½“å†…å®¹è¶…å‡ºå®¹å™¨é«˜åº¦æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ï¼*/

    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px; 
}
/* â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜… */


.dating-scene-card {
    width: 100%;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative; 
    transition: transform 0.3s ease, opacity 0.3s ease;
    
    /* ä¿æŒå¡ç‰‡å†…éƒ¨ä¸ºå‚ç›´flexå¸ƒå±€ï¼Œç¡®ä¿å›¾ç‰‡åœ¨ä¸Šï¼Œæ–‡å­—åœ¨ä¸‹ */
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* é˜²æ­¢å¡ç‰‡è‡ªèº«è¢«æ„å¤–å‹ç¼© */
}

.dating-scene-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    z-index: 5;
    opacity: 0;
    transition: background-color 0.2s;
}
.dating-scene-card:hover .dating-scene-delete-btn {
    opacity: 1;
}
.dating-scene-delete-btn:hover {
    background-color: #ff3b30;
}

.dating-scene-image-container {
    width: 100%;
    aspect-ratio: 16 / 10;
    background-color: #e9ecef;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-secondary);
    font-size: 14px;
    flex-shrink: 0; 
}
#phone-screen.dark-mode .dating-scene-image-container {
    background-color: #2c2c2e;
}

.dating-scene-image-container .loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(0,0,0,0.1);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.dating-scene-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.dating-scene-info {
    padding: 15px;
    text-align: center;
    flex-shrink: 0; /* é˜²æ­¢æ–‡å­—åŒºåŸŸè¢«å‹ç¼© */
}

.dating-scene-info .name {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.dating-scene-info .cost {
    font-size: 16px;
    color: #FF5722;
    font-weight: bold;
    margin-top: 8px;
}
/* â–²â–²â–² æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å€Ÿé’±åˆ—è¡¨é¡¹ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
#borrow-money-char-list .character-select-item {
    gap: 12px; /* åœ¨å¤´åƒå’Œåå­—ä¹‹é—´å¢åŠ ä¸€äº›é—´è· */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å€Ÿæ¡å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-borrow-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
}

.borrow-card {
    width: 220px;
    border-radius: 12px;
    background: linear-gradient(135deg, #e0c3fc, #8ec5fc); /* æ¸©æŸ”çš„ç´«è“è‰²æ¸å˜ */
    color: white;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(142, 197, 252, 0.4);
    position: relative;
    overflow: hidden;
}
.borrow-card::before {
    content: 'ğŸ’¸'; /* é£é’±çš„Emojiä½œä¸ºè£…é¥° */
    position: absolute;
    top: -5px;
    right: 10px;
    font-size: 32px;
    opacity: 0.15;
    transform: rotate(15deg);
}

.borrow-card .borrow-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}
.borrow-card .borrow-header span {
    color: #4a00e0; /* æ·±ç´«è‰²çªå‡ºå€Ÿé’±å¯¹è±¡ */
    text-shadow: 0 0 5px rgba(255,255,255,0.5);
}

.borrow-card .borrow-body .label {
    font-size: 13px;
    opacity: 0.8;
}

.borrow-card .borrow-body .amount {
    font-size: 32px;
    font-weight: 700;
    margin: 4px 0 10px 0;
}

.borrow-card .borrow-body .reason {
    font-size: 12px;
    line-height: 1.5;
    opacity: 0.9;
    padding-top: 8px;
    margin-top: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    word-break: break-all;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* 1. ä¸»å®¹å™¨ (ä¿æŒä¸å˜) */
#dating-game-screen {
    background-color: #000;
    color: white;
}

/* 2. èƒŒæ™¯å›¾å±‚ (æœ€åº•å±‚) */
#dating-game-background {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    transition: background-image 0.5s ease-in-out, filter 0.5s ease-in-out;
    filter: blur(3px) brightness(0.8);
    transform: scale(1.05);
    z-index: 1; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ˜ç¡®æŒ‡å®šå±‚çº§ä¸º 1 â˜…â˜…â˜… */
}

/* 4. UIå±‚ (æœ€é¡¶å±‚) */
.dating-game-ui-overlay {
    position: relative; /* ç›¸å¯¹å®šä½ï¼Œå› ä¸ºå®ƒéœ€è¦è‡ªç„¶åœ°æ’åœ¨æœ€ä¸Šå±‚ */
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* å°†å†…å®¹æ¨åˆ°åº•éƒ¨ */
    padding-bottom: calc(env(safe-area-inset-bottom) + 15px);
    box-sizing: border-box;
    z-index: 3; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ˜ç¡®æŒ‡å®šå±‚çº§ä¸º 3ï¼Œæ¯”ç«‹ç»˜é«˜ï¼Œç¡®ä¿å®ƒæ°¸è¿œåœ¨æœ€ä¸Šé¢ï¼ â˜…â˜…â˜… */
}
#dating-game-screen .header {
    position: absolute;
    top: 0;
    width: 100%;
    box-sizing: border-box;
    background-color: rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    color: white;
}
#dating-game-screen .header .back-btn {
    color: white;
}

/* --- â–¼â–¼â–¼ è¿™é‡Œæ˜¯æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒåŒºåŸŸ â–¼â–¼â–¼ --- */

.dating-game-textbox {
    display: flex; /* 1. æ”¹ä¸ºFlexå¸ƒå±€ */
    flex-direction: column;
    justify-content: space-between; /* 2. è®©å†…å®¹å’Œæç¤ºåˆ†å¼€ */
    background-color: rgba(0, 0, 0, 0.75);
    padding: 15px 20px;
    margin: 0 15px 15px 15px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    min-height: 120px; /* 3. è®¾ç½®ä¸€ä¸ªå›ºå®šçš„æœ€å°é«˜åº¦ */
    transition: opacity 0.5s, transform 0.5s;
    cursor: pointer;
    /* 4. ç§»é™¤ overflow: autoï¼Œç¦æ­¢å…¶è‡ªèº«æ»šåŠ¨ */
}

/* --- â–¼â–¼â–¼ åœ¨ .dating-game-textbox è§„åˆ™ä¹‹åï¼Œç²˜è´´ä¸‹é¢è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼ --- */

/* æ–‡æœ¬å†…å®¹çš„å®¹å™¨ï¼Œæˆ‘ä»¬ç»™å®ƒä¸€ä¸ªæ·¡å…¥æ·¡å‡ºçš„åŠ¨ç”» */
.dating-game-textbox #dating-game-text-content {
    transition: opacity 0.2s ease-in-out;
}
/* å½“å¥å­åˆ‡æ¢æ—¶ï¼Œå…ˆè®©æ—§å¥å­æ·¡å‡º */
.dating-game-textbox #dating-game-text-content.fade-out {
    opacity: 0;
}

/* â€œç‚¹å‡»ç»§ç»­â€çš„æç¤º */
.dating-game-textbox .continue-indicator {
    display: block;
    text-align: right;
    margin-top: 10px;
    font-size: 14px;
    color: #888;
    animation: pulse-indicator 1.5s infinite;
}
@keyframes pulse-indicator {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² --- */


.dating-game-choices {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0 15px;
    margin-bottom: 15px;
}

.dating-game-choice-btn {
    width: 100%;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    border-radius: 25px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    transition: background-color 0.2s, transform 0.1s;
}

.dating-game-choice-btn.input-action {
    background-color: rgba(0, 123, 255, 0.4);
    border-color: rgba(0, 123, 255, 0.6);
}

.dating-game-choice-btn:hover {
    background-color: rgba(255, 255, 255, 0.4);
}
.dating-game-choice-btn:active {
    transform: scale(0.98);
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜-æ–‡æ¸¸ç•Œé¢UIå¢å¼ºæ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸ºæ–‡æ¸¸ç•Œé¢é¡¶éƒ¨æ æ·»åŠ æŒ‰é’®å®¹å™¨ (è¿™æ®µä»£ç å·²åŒ…å«åœ¨æ­¥éª¤1ä¸­ï¼Œå¦‚æœå·²æ·»åŠ å¯å¿½ç•¥) */
#dating-game-screen .header {
    justify-content: space-between;
}

/* 3. ç«‹ç»˜å±‚ (ä¸­é—´å±‚) */
#dating-game-sprite-container {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: auto;
    max-height: 80%;
    pointer-events: none;
    transition: all 0.5s ease-in-out;
    z-index: 2; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ˜ç¡®æŒ‡å®šå±‚çº§ä¸º 2ï¼Œæ¯”èƒŒæ™¯é«˜ â˜…â˜…â˜… */
}
#dating-game-sprite-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
}

/* 3. è®¾ç½®å¼¹çª—æ ·å¼ */
#dating-game-settings-modal .modal-content {
    height: 85%;
}
#dating-game-settings-modal .form-group {
    margin-bottom: 15px;
}
#dating-game-settings-modal hr {
    margin: 15px 0;
}
#dating-game-settings-modal .modal-body {
    padding-bottom: 15px;
}

/* 4. ç«‹ç»˜å®šä½æ§åˆ¶çš„æ ·å¼ */
.position-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}
.position-controls label {
    flex-shrink: 0;
}
.position-controls input[type="range"] {
    flex-grow: 1;
}

/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œç«‹ç»˜é¢„è®¾â€åŠŸèƒ½æ–°å¢çš„æ‰€æœ‰CSSæ ·å¼ â–¼â–¼â–¼ */

/* --- ç«‹ç»˜ç»„ç¼–è¾‘å™¨ --- */
.sprite-edit-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid var(--border-color);
    position: relative;
    display: flex;
    gap: 15px;
    align-items: flex-start;
}
#phone-screen.dark-mode .sprite-edit-card {
    background-color: #2c2c2e;
}

.sprite-edit-card .preview-container {
    width: 80px;
    height: 120px;
    background-color: #e9ecef;
    border-radius: 6px;
    border: 1px dashed #ccc;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    flex-shrink: 0;
}
#phone-screen.dark-mode .sprite-edit-card .preview-container {
    background-color: #3a3a3c;
    border-color: #555;
}

.sprite-edit-card .fields-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-grow: 1;
}
.sprite-edit-card textarea {
    min-height: 50px;
    resize: vertical;
}

.sprite-edit-card .delete-sprite-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background-color: #ff3b30;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
}

/* --- ç«‹ç»˜ç»„ç®¡ç†åˆ—è¡¨ --- */
.sprite-group-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}
.sprite-group-list-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .sprite-group-list-item:hover {
    background-color: #2c2c2e;
}
.sprite-group-list-item .group-name {
    font-weight: 500;
}
.sprite-group-list-item .group-actions button {
    margin-left: 8px;
    padding: 5px 10px;
    font-size: 13px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜-ç«‹ç»˜å®šä½æ§åˆ¶æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯åŒ…è£¹æ¯ä¸ªæ»‘å—ï¼ˆæ ‡ç­¾+æ»‘å—æœ¬èº«ï¼‰çš„å®¹å™¨ */
.sprite-edit-card .position-controls {
    display: flex;
    align-items: center;
    gap: 10px; /* æ ‡ç­¾å’Œæ»‘å—çš„é—´è· */
    margin-top: 8px;
}

/* è¿™æ˜¯â€œX ä½ç½®â€ã€â€œY ä½ç½®â€ã€â€œå¤§å°â€è¿™äº›æ–‡å­—æ ‡ç­¾çš„æ ·å¼ */
.sprite-edit-card .position-controls label {
    flex-shrink: 0; /* é˜²æ­¢æ ‡ç­¾æ–‡å­—è¢«å‹ç¼©æ¢è¡Œ */
    width: 90px;    /* ç»™ä¸€ä¸ªå›ºå®šçš„å®½åº¦ï¼Œè®©æ‰€æœ‰æ»‘å—èƒ½å·¦å¯¹é½ */
    font-size: 13px;
    color: var(--text-secondary);
}

/* è¿™æ˜¯æ»‘å—æ—è¾¹çš„å®æ—¶æ•°å€¼æ˜¾ç¤ºçš„æ ·å¼ */
.sprite-edit-card .position-controls .pos-value {
    font-weight: 500;
    color: var(--text-primary);
}

/* è¿™æ˜¯æ»‘å—æœ¬èº«çš„æ ·å¼ */
.sprite-edit-card .position-controls input[type="range"] {
    flex-grow: 1; /* è®©æ»‘å—å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    width: 100%;  /* ç¡®ä¿å®ƒèƒ½æ’‘æ»¡ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯çº¦ä¼šåœºæ™¯ä¸“å±çš„â€œå¥½æ„Ÿåº¦â€å’Œâ€œæ¬²æœ›å€¼â€å¿ƒå½¢UIæ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€ç‹¬å®¶å®šåˆ¶ã€‘è¿™æ˜¯ä¸ºä½ ä¿®æ”¹åçš„â€œå·¦ä¸Šè§’â€ç‰ˆæœ¬ â–¼â–¼â–¼ */

/* è¿™æ˜¯åŒ…è£¹ä¸¤ä¸ªæ•°å€¼æ¡çš„æ€»å®¹å™¨ */
#dating-values-container {
    position: absolute;
    
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šè°ƒæ•´å‚ç›´ä½ç½®ï¼ŒæŠŠå®ƒæ˜ç¡®åœ°æ”¾åˆ°Headerä¸‹æ–¹ â–¼â–¼â–¼ */
    /* ä½ çš„Headeré«˜åº¦æ˜¯110pxï¼Œæˆ‘ä»¬å†åŠ 10pxçš„é—´è·ï¼Œæ‰€ä»¥è®¾ç½®ä¸º120px */
    top: 120px; 
    
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šè°ƒæ•´æ°´å¹³ä½ç½®ï¼Œä»å³è¾¹ç§»åŠ¨åˆ°å·¦è¾¹ â–¼â–¼â–¼ */
    left: 15px; /* åŸæ¥æ˜¯ right: 15px; */

    z-index: 5;
    display: none;
    flex-direction: column;
    gap: 8px;
    
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šè®©å†…éƒ¨å…ƒç´ é å·¦å¯¹é½ï¼Œæ›´å¥½çœ‹ â–¼â–¼â–¼ */
    align-items: flex-start; /* åŸæ¥æ˜¯ align-items: flex-end; */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */


/* è¿™æ˜¯æ¯ä¸€è¡Œæ•°å€¼æ¡ï¼ˆä¾‹å¦‚â€œæµªæ¼«å€¼â€é‚£ä¸€è¡Œï¼‰çš„æ ·å¼ */
.value-display {
    display: flex;
    align-items: center;
    gap: 4px; /* å¿ƒä¸å¿ƒä¹‹é—´çš„é—´è· */
    background-color: rgba(0, 0, 0, 0.2); /* ç»™ä¸€ä¸ªåŠé€æ˜çš„æ·±è‰²èƒŒæ™¯æ¿ï¼Œè®©å¿ƒå½¢æ›´çªå‡º */
    padding: 4px 8px;
    border-radius: 12px;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* è¿™æ˜¯å•ä¸ªå¿ƒå½¢å›¾æ ‡çš„æ ·å¼ */
.value-display svg {
    width: 20px;
    height: 20px;
    stroke-width: 1.5; /* æè¾¹å®½åº¦ */
    transition: all 0.3s ease-in-out; /* ä¸ºå¡«å……å’Œé¢œè‰²å˜åŒ–æ·»åŠ åŠ¨ç”» */
}

/* è¿™æ˜¯â€œæµªæ¼«å€¼â€å›¾æ ‡çš„é¢œè‰² */
#romance-value svg {
    color: #ff8fab; /* å¯çˆ±çš„ç²‰çº¢è‰² */
    stroke: #ffc2d1; /* æè¾¹ç”¨æ›´æ·¡çš„ç²‰è‰² */
}
/* è¿™æ˜¯â€œæ€§æ¬²å€¼â€å›¾æ ‡çš„é¢œè‰² */
#lust-value svg {
    color: #ffde59; /* è¯±äººçš„é‡‘é»„è‰² */
    stroke: #ffeda6; /* æè¾¹ç”¨æ›´æ·¡çš„é»„è‰² */
}

/* â€œç©ºå¿ƒâ€çŠ¶æ€ï¼šå¡«å……è‰²ä¸ºé€æ˜ */
.value-display svg .heart-fill {
    fill: transparent;
}
/* â€œå®å¿ƒâ€çŠ¶æ€ï¼šå¡«å……è‰²ä¸ºå›¾æ ‡çš„é¢œè‰² */
.value-display svg.filled .heart-fill {
    fill: currentColor;
}
/* â–²â–²â–² æ–°å¢CSSæ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå®Œæˆåº¦è¿›åº¦æ¡æ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºä½ ä¿®å¤åçš„è¿›åº¦æ¡æ ·å¼ â–¼â–¼â–¼ */

/* è¿™æ˜¯è¿›åº¦æ¡çš„å®¹å™¨ (å·²ç§»è‡³åº•éƒ¨) */
#dating-completion-bar-container {
    position: absolute;
    bottom: calc(20px + env(safe-area-inset-bottom)); 
    
    /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
    left: 15px;
    right: 15px;
    height: 18px;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 9px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset;
    overflow: hidden;
    z-index: 4;
    display: none;
    transition: width 0.5s ease-in-out;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* è¿›åº¦æ¡çš„å¡«å……éƒ¨åˆ† */
#dating-completion-bar-fill {
    width: 0%; /* åˆå§‹ä¸º0% */
    height: 100%;
    /* ä½¿ç”¨ä¸€ä¸ªæ¼‚äº®çš„ç²‰è‰²æ¸å˜ä½œä¸ºå¡«å……è‰² */
    background: linear-gradient(90deg, #ff8fab, #fb6f92);
    border-radius: 9px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* å¹³æ»‘çš„å®½åº¦å˜åŒ–åŠ¨ç”» */
}

/* è¿›åº¦æ¡ä¸Šçš„ç™¾åˆ†æ¯”æ–‡å­— */
#dating-completion-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    color: white;
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0,0,0,0.6); /* æ–‡å­—é˜´å½±ï¼Œç¡®ä¿æ¸…æ™° */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šç»“ç®—å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

#dating-summary-overlay {
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.dating-summary-card {
    background-color: transparent;
    width: 320px;
    height: 500px;
    perspective: 1000px; /* ä¸º3Dç¿»è½¬æ•ˆæœè®¾ç½®é€è§† */
}

.dating-summary-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    border-radius: 20px;
}

/* å½“å¡ç‰‡è¢«ç¿»è½¬æ—¶ */
.dating-summary-card.is-flipped .dating-summary-card-inner {
    transform: rotateY(180deg);
}

/* å¡ç‰‡çš„æ­£é¢å’ŒèƒŒé¢ */
.card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden; /* Safari */
    backface-visibility: hidden;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
}

/* æ­£é¢æ ·å¼ */
.card-front {
    color: white;
    background: linear-gradient(135deg, #a8b2c5, #8e9eab); /* æœŸå¾…ä¹‹å¤œçš„é»˜è®¤ç°è‰²æ¸å˜ */
    transition: background 0.3s;
}

/* ä¸åŒè¯„çº§çš„èƒŒæ™¯é¢œè‰² */
.card-front.romantic {
    background: linear-gradient(135deg, #ff8fab, #fb6f92); /* ç²‰è‰²æ¸å˜ */
}
.card-front.passionate {
    background: linear-gradient(135deg, #FFF9C4, #FFF176); /* å…¨æ–°ä¿®æ”¹ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸æ¼‚äº®çš„æ·¡é»„è‰²æ¸å˜ */
}

/* â–¼â–¼â–¼ è¿™æ˜¯ä¸ºä½ å®šåˆ¶çš„â€œå®Œç¾ä¹‹å¤œâ€è–°è¡£è‰è‰²ï¼Œè¯·ç”¨å®ƒæ›¿æ¢æ—§çš„ .card-front.perfect æ ·å¼ â–¼â–¼â–¼ */
.card-front.perfect {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šè¿™é‡Œä½¿ç”¨äº†ä»æ·¡ç´«åˆ°ç•¥æ·±ç´«è‰²çš„ä¼˜é›…æ¸å˜ï¼Œè¥é€ å‡ºæµªæ¼«æ¢¦å¹»çš„æ„Ÿè§‰ */
    background: linear-gradient(135deg, #d1c4e9, #b39ddb); 
}

.card-front #summary-card-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    object-fit: cover;
    margin-bottom: 20px;
}

.card-front #summary-card-rating {
    font-size: 28px;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    margin: 0 0 10px 0;
}

.card-front .summary-card-tip {
    font-size: 14px;
    opacity: 0.8;
    margin-top: auto; /* å°†æç¤ºæ¨åˆ°åº•éƒ¨ */
}

.summary-card-actions {
    display: flex;
    gap: 15px;
    width: 100%;
    margin-top: 20px;
}

.summary-card-actions button {
    flex: 1;
    padding: 12px;
    border-radius: 20px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

#summary-share-btn {
    background-color: rgba(255, 255, 255, 0.9);
    color: #333;
}
#summary-close-btn {
    background-color: rgba(0, 0, 0, 0.2);
    color: white;
}

/* èƒŒé¢æ ·å¼ */
.card-back {
    background-color: #f8f9fa;
    color: #333;
    transform: rotateY(180deg);
    justify-content: flex-start; /* å†…å®¹ä»é¡¶éƒ¨å¼€å§‹ */
}

.card-back-header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;
}
.card-back-header span {
    font-weight: 600;
}
.card-back-header button {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 16px;
    cursor: pointer;
}

.card-back-content {
    width: 100%;
    flex-grow: 1;
    overflow-y: auto;
    text-align: left;
    line-height: 1.6;
    font-size: 14px;
}
.card-back-content p {
    margin: 0 0 10px 0;
}

/* èŠå¤©è®°å½•é‡Œåˆ†äº«å¡ç‰‡çš„æ ·å¼ */
.message-bubble.is-dating-summary .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
}

.dating-summary-chat-card {
    width: 220px;
    height: 120px;
    border-radius: 12px;
    padding: 15px;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.dating-summary-chat-card::before {
    content: 'ğŸ’–';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 40px;
    opacity: 0.1;
    transform: rotate(-15deg);
}

.dating-summary-chat-card .rating {
    font-size: 20px;
    font-weight: bold;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.dating-summary-chat-card .tip {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 8px;
}
/* â–²â–²â–² æ–°å¢CSSæ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘çº¦ä¼šå†å²è®°å½•åŠŸèƒ½æ ·å¼ --- */

/* --- ã€å…¨æ–° | å·²ä¿®å¤å¸ƒå±€ã€‘çº¦ä¼šå†å²è®°å½•åŠŸèƒ½æ ·å¼ --- */

/* å†å²è®°å½•é¡µé¢çš„ä¸»å®¹å™¨ï¼Œç°åœ¨è´Ÿè´£æ»šåŠ¨å’Œå¸ƒå±€ */
#dating-history-list {
    background-color: #f0f2f5; /* ä¿æŒåŸæœ‰çš„èƒŒæ™¯è‰² */
    
    /* â–¼â–¼â–¼ è¿™æ˜¯è§£å†³æ‹¥æŒ¤å’Œé‡å é—®é¢˜çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ */
    display: flex;             /* 1. ä½¿ç”¨ Flex å¸ƒå±€ï¼Œè®©å¡ç‰‡ä»¬å¬è¯åœ°æ’åˆ— */
    flex-direction: column;    /* 2. è®¾ç½®ä¸ºå‚ç›´æ–¹å‘ï¼Œä»ä¸Šåˆ°ä¸‹å †å  */
    gap: 15px;                 /* 3. åœ¨æ¯å¼ å¡ç‰‡ä¹‹é—´åˆ›å»º 15px çš„å‚ç›´é—´è· */
    padding: 20px 15px;        /* 4. åœ¨åˆ—è¡¨çš„ä¸Šä¸‹(20px)å’Œå·¦å³(15px)éƒ½åŠ ä¸Šå†…è¾¹è·ï¼Œè®©æ•´ä½“ä¸æ‹¥æŒ¤ */
    box-sizing: border-box;    /* (æ¨è) ç¡®ä¿å†…è¾¹è·ä¸ä¼šå½±å“å¸ƒå±€è®¡ç®— */
    
    /* 
       æ»šåŠ¨æ¡çš„åŠŸèƒ½ç”±å®ƒçš„çˆ¶å®¹å™¨ .list-container æä¾›ï¼Œ
       æˆ‘ä»¬åœ¨è¿™é‡Œæ­£ç¡®åœ°è®¾ç½®äº†å¸ƒå±€ï¼Œçˆ¶å®¹å™¨å°±èƒ½æ­£å¸¸æ»šåŠ¨äº†ï¼
    */
}

#phone-screen.dark-mode #dating-history-list {
    background-color: #1c1c1e; /* å¤œé—´æ¨¡å¼çš„èƒŒæ™¯è‰² */
}

/* å†å²åˆ—è¡¨ä¸­çš„å¡ç‰‡ï¼Œæˆ‘ä»¬è®©å®ƒæ›´é€‚åˆåˆ—è¡¨æ˜¾ç¤º */
#dating-history-list .dating-summary-card {
    width: 100%; /* å¡ç‰‡å®½åº¦æ’‘æ»¡ (ä¿æŒä¸å˜) */
    height: 180px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ï¼Œè®©åˆ—è¡¨æ›´æ•´é½ (ä¿æŒä¸å˜) */
    position: relative; 
    transform: none;
    left: auto;
    top: auto;
    margin: 0; /* (ä¿æŒä¸å˜) */
    
    /* ã€æ–°å¢ã€‘é˜²æ­¢å¡ç‰‡åœ¨ Flex å¸ƒå±€ä¸­è¢«æ„å¤–å‹ç¼©å˜å½¢ */
    flex-shrink: 0; 
}

/* å†å²åˆ—è¡¨ä¸­çš„å¡ç‰‡ï¼Œæ­£é¢æ ·å¼å¾®è°ƒ */
#dating-history-list .card-front {
    padding: 15px;
    justify-content: center;
    cursor: pointer; /* é¼ æ ‡æ”¾ä¸Šå»æ—¶æ˜¾ç¤ºå°æ‰‹ï¼Œæç¤ºå¯ä»¥ç‚¹å‡» */
}

#dating-history-list .card-front img {
    width: 70px !important;
    height: 70px !important;
    margin-bottom: 10px !important;
    border-radius: 50% !important;
    border: 3px solid rgba(255,255,255,0.7) !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
}

#dating-history-list .card-front h2 {
    font-size: 22px !important;
    margin: 0 0 5px 0 !important;
}

#dating-history-list .card-front p {
    margin-top: 5px !important;
}

/* å†å²åˆ—è¡¨ä¸­çš„å¡ç‰‡ï¼ŒèƒŒé¢æ ·å¼å¾®è°ƒ */
#dating-history-list .card-back-header {
    flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
}
#dating-history-list .card-back-content {
    font-family: sans-serif; /* èƒŒé¢å¯ä»¥ç”¨æ›´æ˜“è¯»çš„éè¡¬çº¿å­—ä½“ */
    font-size: 13px;
    line-height: 1.6;
}

/* â–²â–²â–² æ–°å¢CSSæ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€V4 - ç»ˆæä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„Stickerç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¿™æ˜¯æ¯ä¸ªè¡¨æƒ…çš„â€œæ ¼å­â€ï¼Œç°åœ¨å®ƒæ˜¯ä¸€ä¸ªflexå®¹å™¨ï¼Œè´Ÿè´£è®©å›¾ç‰‡å’Œæ–‡å­—å‚ç›´å±…ä¸­æ’åˆ— */
.sticker-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px; /* å›¾ç‰‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
    cursor: pointer;
}

/* â–¼â–¼â–¼ è¿™æ˜¯ä¿®æ”¹åçš„ä»£ç  â–¼â–¼â–¼ */
/* 2. ã€æ ¸å¿ƒã€‘è¿™æ˜¯ä¸“é—¨ç”¨æ¥æ˜¾ç¤ºâ€œå›¾ç‰‡â€çš„div */
.sticker-image {
    width: 100px;  /* â˜… ä¿®æ”¹ï¼šä» 80px å¢å¤§åˆ° 100px */
    height: 100px; /* â˜… ä¿®æ”¹ï¼šä» 80px å¢å¤§åˆ° 100px */
    position: relative; 
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border-radius: 10px;
    background-color: white; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}


/* 3. è¿™æ˜¯æè¿°æ–‡å­—çš„æ ·å¼ (æ”¯æŒæœ€å¤š2è¡Œ) */
.sticker-name {
    font-size: 12px;
    color: var(--text-secondary);
    text-align: center;
    width: 100%;
    line-height: 1.4;
    height: calc(12px * 1.4 * 2); /* é¢„ç•™ä¸¤è¡Œçš„é«˜åº¦ï¼Œé˜²æ­¢å¸ƒå±€è·³åŠ¨ */
    
    /* å®ç°æœ€å¤šä¸¤è¡Œçš„çœç•¥å·æ•ˆæœ */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    word-break: break-all;
}

/* 4. åˆ é™¤æŒ‰é’®çš„æ ·å¼ï¼Œç°åœ¨å®ƒçš„çˆ¶çº§æ˜¯ .sticker-image */
.sticker-image .delete-btn {
    display: none;
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    background-color: #ff3b30;
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 20px;
    font-size: 14px;
    cursor: pointer;
    border: 2px solid white;
    z-index: 10;
}

/* 5. ã€å·²ä¿®å¤ã€‘é€‰æ‹©æ¨¡å¼ä¸‹çš„å‹¾é€‰æ ‡è®°æ ·å¼ */
.sticker-image.in-selection-mode::before {
    content: '';
    position: absolute;
    top: 4px;
    right: 4px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid rgba(120, 120, 128, 0.4);
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    transition: all 0.2s ease-in-out;
    box-sizing: border-box;
}

.sticker-image.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    font-weight: bold;
    text-align: center;
    line-height: 18px;
}

/* â–²â–²â–² V4 ä¿®å¤ç‰ˆCSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…é¢æ¿åˆ†ç±»åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. åˆ†ç±»é¡µç­¾æ å®¹å™¨ */
#sticker-category-tabs {
    flex-shrink: 0;
    padding: 10px 15px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    overflow-x: auto;
    
    /* éšè—æ»šåŠ¨æ¡ï¼Œè®©ç•Œé¢æ›´å¹²å‡€ */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
#sticker-category-tabs::-webkit-scrollbar {
    display: none;
}

/* 2. å•ä¸ªåˆ†ç±»èƒ¶å›ŠæŒ‰é’® */
.sticker-category-btn {
    padding: 6px 15px;
    border: 1px solid transparent;
    border-radius: 16px; /* åœ†æ¶¦çš„èƒ¶å›Šå½¢çŠ¶ */
    background-color: #e9ecef;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
    transition: all 0.2s ease-in-out;
}

/* å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode .sticker-category-btn {
    background-color: #3a3a3c;
}

/* 3. æ¿€æ´»çŠ¶æ€çš„èƒ¶å›ŠæŒ‰é’® */
.sticker-category-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* 4. åˆ†ç±»ç®¡ç†å¼¹çª—å†…çš„åˆ—è¡¨é¡¹ */
#sticker-category-list label {
    display: block;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 6px;
}
#sticker-category-list label input {
    margin-right: 8px;
    vertical-align: middle;
}
#sticker-category-list label:hover {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #sticker-category-list label:hover {
    background-color: #2c2c2e;
}

/* 5. ç¼–è¾‘æ¨¡å¼ä¸‹åº•éƒ¨æ“ä½œæ çš„å¸ƒå±€ */
#sticker-panel-footer {
    display: flex;
    gap: 10px;
}
#sticker-panel-footer button {
    flex: 1; /* è®©ä¸¤ä¸ªæŒ‰é’®å¹³åˆ†å®½åº¦ */
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

    </style>
    <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œ â–¼â–¼â–¼ -->
    <style id="custom-theme-style"></style>

</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œç²˜è´´æ‚¬æµ®æ­Œè¯æ çš„ä»£ç  â–¼â–¼â–¼ -->
<div id="floating-lyrics-bar">
    <span id="floating-lyric-text">â™ª</span>
    <!-- ã€é—®é¢˜4ä¿®å¤ã€‘ç”¨åŒ…å«SVGçš„divæ›¿æ¢æ—§çš„span -->
    <div id="lyrics-settings-btn" style="cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </div>
    <span class="close-btn">Ã—</span>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼ -->
<div id="lock-screen-background-blur" style="display: none;"></div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
            
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä¿®æ”¹åçš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ <div id="home-screen"...>...</div> â–¼â–¼â–¼ -->
<div id="home-screen" class="screen active">
    
    <!-- æˆ‘ä»¬ç”¨ä¸€ä¸ªæ»‘åŠ¨å®¹å™¨æŠŠé¡µé¢åŒ…èµ·æ¥ -->
    <div class="home-screen-slider">
        <!-- è¿™æ˜¯ä½ çš„ç¬¬ä¸€é¡µï¼Œæˆ‘ä»¬æŠŠåŸæ¥çš„å†…å®¹éƒ½æ”¾è¿›æ¥ -->
        <div class="home-page">
            <div id="main-content-area">
                <div id="profile-widget">
                    <img id="profile-banner-img" src="https://i.postimg.cc/k495F4W5/profile-banner.jpg" class="editable-image">
                    <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ profile-avatar-container â–¼â–¼â–¼ -->
<div class="profile-avatar-container">
    <img id="profile-avatar-img" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image">
    <!-- â–¼â–¼â–¼ æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªç”¨äºæ˜¾ç¤ºå¤´åƒæ¡†çš„imgå…ƒç´  â–¼â–¼â–¼ -->
    <img id="profile-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

                    <div class="profile-info">
                        <p id="profile-username" class="editable-text">ä½ çš„æ˜µç§°</p>
                        <p id="profile-sub-username" class="editable-text">@your_id</p>
                        <p id="profile-bio" class="editable-text">ç‚¹å‡»è¿™é‡Œç¼–è¾‘ä½ çš„ä¸ªæ€§ç­¾å</p>
                        <p id="profile-location" class="editable-text" data-placeholder="ç‚¹å‡»ç¼–è¾‘åœ°ç‚¹"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg><span>ç‚¹å‡»ç¼–è¾‘åœ°ç‚¹</span></p>
                    </div>
                </div>
                <div id="desktop-layout">
                    <div id="desktop-widget-column">
                        <div class="custom-widget-container">
                            <div id="widget-bubble-1" class="widget-bubble editable-text" contenteditable="true">ç‚¹å‡»ç¼–è¾‘æ–‡å­—</div>
                            <div class="widget-circle-uploader">
                                <img id="widget-image-1" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡">
                            </div>
                            <div id="widget-subtext-1" class="widget-subtext editable-text" contenteditable="true">ç‚¹å‡»ç¼–è¾‘æ–‡å­—</div>
                        </div>
                        <div class="custom-widget-container">
                            <div id="widget-bubble-2" class="widget-bubble editable-text" contenteditable="true">ç‚¹å‡»ç¼–è¾‘æ–‡å­—</div>
                            <div class="widget-circle-uploader">
                                <img id="widget-image-2" src="https://i.postimg.cc/k495F4W5/profile-banner.jpg" class="editable-image" title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡">
                            </div>
                            <div id="widget-subtext-2" class="widget-subtext editable-text" contenteditable="true">ç‚¹å‡»ç¼–è¾‘æ–‡å­—</div>
                        </div>
                    </div>
                    <div id="desktop-app-container">
                        <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                        <div class="desktop-app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œä¹¦"></div><span class="label">ä¸–ç•Œä¹¦</span></div>
                        <div id="check-phone-btn" class="desktop-app-icon">
                            <div class="icon-bg-desktop"><img id="icon-img-check-phone" src="https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg" alt="æŸ¥æ‰‹æœº"></div>
                            <span class="label">æŸ¥æ‰‹æœº</span>
                        </div>
                        <div class="desktop-app-icon" id="weibo-app-icon">
                            <div class="icon-bg-desktop"><img id="icon-img-weibo" src="https://i.postimg.cc/PqBY5wBq/weibo-icon.png" alt="å¾®åš"></div>
                            <span class="label">å¾®åš</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„ç¬¬äºŒé¡µï¼Œç°åœ¨æ˜¯è‡ªå®šä¹‰å¸ƒå±€ -->
<div class="home-page">
<!-- è¿™æ˜¯å·¦åŠè¾¹çš„å¤´åƒå°ç»„ä»¶ -->
<div id="second-page-left-widget" class="custom-widget-container">
    <div class="widget-circle-uploader">
        <img id="widget-image-3" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡">
    </div>
    
    <!-- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„å¯ç¼–è¾‘èƒ¶å›Šæ°”æ³¡ â–¼â–¼â–¼ -->
    <div id="second-page-bubble" class="widget-bubble editable-text" contenteditable="true">
        ç‚¹å‡»ç¼–è¾‘æ–‡å­—
    </div>
    <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™æ®µå…¨æ–°çš„HTMLä»£ç  â–¼â–¼â–¼ -->
<div id="new-bubbles-container">
    <div id="flat-capsule-bubble" class="widget-bubble editable-text" contenteditable="true">å¯ç¼–è¾‘</div>
    <div id="circular-bubble" class="widget-bubble editable-text" contenteditable="true">æ–‡å­—</div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

</div>
    <!-- è¿™æ˜¯å³ä¸Šè§’çš„ä¸¤ä¸ªå¹¶æ’å›¾æ ‡ -->
    <div id="second-page-top-right-apps">
        <div class="desktop-app-icon" onclick="showScreen('forum-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-forum" src="https://i.postimg.cc/pr0T3WfC/douban-icon.png" alt="åœˆå­"></div>
            <span class="label">åœˆå­</span>
        </div>
        <div class="desktop-app-icon" id="lovers-space-app-icon">
            <div class="icon-bg-desktop"><img id="icon-img-lovers-space" src="https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png" alt="æƒ…ä¾£ç©ºé—´"></div>
            <span class="label">æƒ…ä¾£ç©ºé—´</span>
        </div>

<!-- è¿™æ˜¯ä½ ç°åœ¨çš„ä»£ç  -->
<div id="second-page-x-social-app" class="desktop-app-icon" onclick="showScreen('x-social-screen')">
    <div class="icon-bg-desktop"><img id="icon-img-x-social" src="https://i.postimg.cc/8P1H0vQ8/x-logo.png" alt="Xç¤¾äº¤"></div>
    <span class="label">Xç¤¾äº¤</span>
</div>



<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ id="center-avatar-wrapper" çš„é‚£ä¸ª div â–¼â–¼â–¼ -->
<div id="center-avatar-wrapper">
    <!-- è¿™æ˜¯ä½ åŸæ¥çš„å¤´åƒï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨äº†æ–°å®¹å™¨çš„ä¸­å¿ƒ -->
    <div id="second-page-center-avatar" class="custom-widget-container">
        <div class="widget-circle-uploader">
            <img id="widget-image-4" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image" title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡">
        </div>
    </div>
    
    <!-- è¿™æ˜¯ä¿®å¤åçš„ã€å¤´åƒä¸‹æ–¹çš„å¯ç¼–è¾‘æ–‡å­—æ¡† -->
    <div id="avatar-subtitle" class="editable-text">ç‚¹å‡»ç¼–è¾‘æ–‡å­—</div>

    <!-- è¿™æ˜¯ä¿®å¤åçš„ã€å¤´åƒå››ä¸ªè§’çš„å¯ç¼–è¾‘æ°”æ³¡ -->
    <div class="corner-bubble editable-text" id="bubble-top-left">å·¦ä¸Šè§’</div>
    <div class="corner-bubble editable-text" id="bubble-top-right">å³ä¸Šè§’</div>
    <div class="corner-bubble editable-text" id="bubble-bottom-left">å·¦ä¸‹è§’</div>
    <div class="corner-bubble editable-text" id="bubble-bottom-right">å³ä¸‹è§’</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨ç¬¬äºŒä¸ª <div class="home-page"> çš„é—­åˆæ ‡ç­¾å‰ï¼Œç²˜è´´ä¸‹é¢è¿™æ®µä»£ç  â–¼â–¼â–¼ -->
<div style="position: absolute; top: 100px; right: 85px;">
    <div class="desktop-app-icon" onclick="showScreen('game-hall-screen')">
        <div class="icon-bg-desktop">
            <img id="icon-img-game-hall" src="https://i.postimg.cc/P5gL5z2g/game-controller-icon.png" alt="æ¸¸æˆå¤§å…">
        </div>
        <span class="label">æ¸¸æˆå¤§å…</span>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢å›¾æ ‡ä»£ç ç»“æŸ â–²â–²â–² -->
    </div>
<!-- â–¼â–¼â–¼ ã€è¿™æ˜¯ä¿®æ”¹åçš„ç‰ˆæœ¬ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ id="new-custom-widget" â–¼â–¼â–¼ -->
<div id="new-custom-widget">
    <!-- æˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°çš„å®¹å™¨æŠŠæœˆä»½å’Œå¤´åƒåŒ…èµ·æ¥ -->
    <div id="new-widget-header">
        <div id="widget-month-display"></div>
        <img id="new-widget-avatar" src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg" class="editable-image">
    </div>
    <div id="new-widget-text-1" class="new-widget-text editable-text" contenteditable="true">å¯ç¼–è¾‘æ–‡å­—</div>
    <div class="new-widget-divider"></div>
    <div id="new-widget-text-2" class="new-widget-text editable-text" contenteditable="true">å¯ç¼–è¾‘æ–‡å­—</div>
    <div class="new-widget-divider"></div>
    <div id="new-widget-text-3" class="new-widget-text editable-text" contenteditable="true">å¯ç¼–è¾‘æ–‡å­—</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€æ•´å—ã€å…¨æ–°çš„ä»£ç ã€‘ï¼Œç²˜è´´åˆ°ç¬¬äºŒä¸ª <div class="home-page"> çš„ã€å†…éƒ¨ã€‘æœ€åº•éƒ¨ â–¼â–¼â–¼ -->
<!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„â€œæ¡ƒå®â€Appå›¾æ ‡ -->
<div style="position: absolute; bottom: 75px; left: 35px;">
    <div class="desktop-app-icon" id="taobao-app-icon">
        <div class="icon-bg-desktop"><img id="icon-img-taobao" src="https://i.postimg.cc/k47tXg1j/taologo.png" alt="æ¡ƒå®"></div>
        <span class="label" style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">æ¡ƒå®</span>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼ -->
<!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„â€œçº¦ä¼šå¤§ä½œæˆ˜â€Appå›¾æ ‡ -->
<div style="position: absolute; bottom: 75px; left: 120px;">
    <div class="desktop-app-icon" id="date-a-live-app-icon">
        <div class="icon-bg-desktop"><img id="icon-img-date-a-live" src="https://i.postimg.cc/W36mYgP5/DAL-icon.jpg" alt="çº¦ä¼šå¤§ä½œæˆ˜"></div>
        <span class="label" style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">çº¦ä¼šå¤§ä½œæˆ˜</span>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
</div>
    </div>
    
    <!-- åº•éƒ¨ Dock æ ä¿æŒä¸å˜ -->
    <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè®¾ç½®"></div><span class="label">APIè®¾ç½®</span></div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')"><div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="å­—ä½“"></div><span class="label">å­—ä½“</span></div>
        <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§‚è®¾ç½®"></div>
            <span class="label">å¤–è§‚è®¾ç½®</span>
        </div>
    </div>

    <!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„å°åœ†ç‚¹ -->
    <div class="pagination-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—åŠŸèƒ½æœ€å…¨ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ id="weibo-screen" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
<div id="weibo-screen" class="screen">
    <!-- è¿™ä¸ªå®¹å™¨å°†å­˜æ”¾å¾®åšçš„æ‰€æœ‰é¡µé¢ -->
    <div id="weibo-page-container">

        <!-- é¡µé¢1: æˆ‘çš„ä¸»é¡µ (å·²æ”¹é€ ) -->
        <div id="weibo-my-profile-view" class="weibo-view active">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>æˆ‘çš„ä¸»é¡µ</span>
                <div class="header-actions">
                              <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ç§ä¿¡æŒ‰é’® â–¼â–¼â–¼ -->
            <span class="action-btn" id="weibo-my-dms-btn" title="æˆ‘çš„ç§ä¿¡">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            </span>
            <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªâ€œç¼–è¾‘â€æŒ‰é’® -->
                    <span class="action-btn" id="edit-weibo-profile-btn" title="ç¼–è¾‘èµ„æ–™">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </span>
                    <span class="action-btn" id="create-weibo-post-btn" style="font-size: 28px; font-weight: 300;">+</span>
                </div>
            </div>
            <!-- ä¸»é¡µå†…å®¹åŒº -->
            <div id="weibo-profile-page">
                <div class="weibo-profile-header">
                    <img id="weibo-background-img" src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg" class="weibo-background">
                  <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ weibo-avatar-container â–¼â–¼â–¼ -->
<div class="weibo-avatar-container">
    <img id="weibo-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" class="weibo-avatar">
    <!-- â–¼â–¼â–¼ æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªç”¨äºæ˜¾ç¤ºå¤´åƒæ¡†çš„imgå…ƒç´  â–¼â–¼â–¼ -->
    <img id="weibo-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

                    <div class="weibo-nickname" id="weibo-nickname">ä½ çš„æ˜µç§°</div>
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªæ˜¾ç¤ºèŒä¸šçš„åœ°æ–¹ -->
                    <!-- â–¼â–¼â–¼ ç”¨è¿™è¡Œæ–°ä»£ç æ›¿æ¢æ‰æ—§çš„ â–¼â–¼â–¼ -->
<div id="weibo-user-profession-display">ç‚¹å‡»è®¾ç½®èŒä¸š</div>

                    <div class="weibo-stats">
                        <div id="weibo-following-btn" class="weibo-stat-item">
                            <span id="weibo-following-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">å…³æ³¨</span>
                        </div>
                        <div id="weibo-posts-item" class="weibo-stat-item">
                            <span id="weibo-posts-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">å¾®åš</span>
                        </div>
                        <div id="weibo-fans-item" class="weibo-stat-item">
                            <span id="weibo-fans-count" class="weibo-stat-number">0</span>
                            <span class="weibo-stat-label">ç²‰ä¸</span>
                        </div>
                    </div>
                </div>
                <div id="my-weibo-feed-list" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- â€œæˆ‘çš„å¾®åšâ€åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <!-- é¡µé¢2: å…³æ³¨çš„äºº (ä¿æŒä¸å˜) -->
        <div id="weibo-following-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>å…³æ³¨çš„äºº</span>
                <span class="action-btn" id="clear-following-feed-btn" style="font-size: 16px; font-weight: 500;">æ¸…ç©º</span>
            </div>
            <div id="weibo-following-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <!-- å…³æ³¨çš„äººçš„å¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- é¡µé¢3: çƒ­æœ (ä¿æŒä¸å˜) -->
        <div id="weibo-hot-search-view" class="weibo-view">
             <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>çƒ­æœ</span>
                <div class="header-actions">
                    <span class="action-btn" id="generate-hot-search-btn" title="ç”Ÿæˆçƒ­æœ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-hot-search-list" style="flex-grow: 1; overflow-y: auto;">
                <p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’æ”¾å¤§é•œç”Ÿæˆçƒ­æœ</p>
            </div>
        </div>

        <!-- é¡µé¢4: å¹¿åœº (ä¿æŒä¸å˜) -->
        <div id="weibo-plaza-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span>å¹¿åœº</span>
                <div class="header-actions">
                    <span class="action-btn" id="generate-plaza-feed-btn" title="ç”Ÿæˆå¹¿åœºåŠ¨æ€">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-plaza-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 0;">
                 <p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’æ”¾å¤§é•œç”Ÿæˆå¹¿åœºåŠ¨æ€</p>
            </div>
        </div>

        <!-- é¡µé¢5: çƒ­æœè¯¦æƒ…é¡µ (ä¿æŒä¸å˜) -->
        <div id="weibo-hottopic-feed-view" class="weibo-view">
            <div class="header">
                <span class="back-btn" id="back-from-hottopic-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
                <span id="weibo-hottopic-title">çƒ­æœè¯é¢˜</span>
                <div class="header-actions">
                     <span class="action-btn" id="refresh-hottopic-feed-btn" title="æ¢ä¸€æ‰¹">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </span>
                </div>
            </div>
            <div id="weibo-hottopic-feed-list" style="flex-grow: 1; overflow-y: auto; padding: 0;">
                <!-- çƒ­æœå¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div id="weibo-bottom-nav">
        <div class="weibo-nav-item" data-view="weibo-hot-search-view">çƒ­æœ</div>
        <div class="weibo-nav-item" data-view="weibo-plaza-view">å¹¿åœº</div>
        <div class="weibo-nav-item" data-view="weibo-following-view">å…³æ³¨çš„äºº</div>
        <div class="weibo-nav-item active" data-view="weibo-my-profile-view">æˆ‘çš„å¾®åš</div>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->
   
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€æœ€ç»ˆç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ id="world-book-screen" çš„ div â–¼â–¼â–¼ -->
<div id="world-book-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>ä¸–ç•Œä¹¦</span>
        <div class="header-actions">
            
            <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â˜…â˜…â˜… -->
            <!-- æˆ‘ä»¬æŠŠ "å¯¼å…¥" ä¸¤ä¸ªå­—ï¼Œæ¢æˆäº†ä¸€æ®µSVGä»£ç ï¼Œå¹¶åŠ ä¸Šäº† title æç¤º -->
            <span class="action-btn" id="import-world-book-btn" title="å¯¼å…¥ä¸–ç•Œä¹¦">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            </span>
            <!-- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² -->

            <span class="action-btn" id="manage-world-book-categories-btn">ç®¡ç†åˆ†ç±»</span>
            <span class="action-btn" id="add-world-book-btn">+</span>
        </div>
    </div>
    <div id="world-book-list"></div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ä¹¦å</label>
                        <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                    </div>

        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œæ·»åŠ åˆ†ç±»é€‰æ‹© â–¼â–¼â–¼ -->
        <div class="form-group">
            <label for="world-book-category-select">åˆ†ç±»</label>
            <select id="world-book-category-select">
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å†…å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨â€œå‘é€å›¾ç‰‡â€åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label for="api-key">å¯†é’¥ (ç›´è¿è½®è¯¢ç”¨è‹±æ–‡é€—å·éš”å¼€)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div>
<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€å…¨æ–°çš„HTMLä»£ç ã€‘ç²˜è´´åˆ° â€œæ¨¡å‹â€ ä¸‹æ‹‰æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label>API é¢„è®¾</label>
    <div class="bubble-preset-manager"> <!-- å¤ç”¨ç°æœ‰æ ·å¼ -->
        <select id="api-preset-select" class="form-group select"></select>
        <button id="manage-api-presets-btn" class="action-btn">ç®¡ç†</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€å…¨æ–°çš„HTMLä»£ç ã€‘ç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="temperature-slider">æ¨¡å‹æ¸©åº¦ (Temperature): <span id="temperature-value">0.8</span></label>
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px; margin-bottom: 10px;">
        æ•°å€¼è¶Šé«˜ï¼Œå›å¤è¶Šéšæœºã€æœ‰åˆ›é€ æ€§ï¼Œä½†å¯èƒ½åç¦»äººè®¾ã€‚æ•°å€¼è¶Šä½ï¼Œå›å¤è¶Šç¨³å®šã€å¯é¢„æµ‹ã€‚æ¨èå€¼: 0.7 - 1.2
    </p>
    <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="0.8" style="width: 100%;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button>

<!-- â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œæ˜¯å…¨æ–°çš„åå°æ´»åŠ¨è®¾ç½®åŒº â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">

<!-- 1. æ€»å¼€å…³ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        å¯ç”¨åå°è§’è‰²æ´»åŠ¨ (æ€»å¼€å…³)
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            è­¦å‘Šï¼šå¼€å¯åä¼šæ˜¾è‘—å¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨ï¼
        </p>
    </label>
    <!-- ã€é‡è¦ã€‘æˆ‘ä»¬æŠŠåŸæ¥çš„ checkbox æ¢æˆäº†æ›´ç¾è§‚çš„ iOS é£æ ¼å¼€å…³ -->
    <label class="toggle-switch">
        <input type="checkbox" id="background-activity-switch">
        <span class="slider"></span>
    </label>
</div>

<!-- 2. åå°æ´»åŠ¨è¯¦ç»†è®¾ç½® (é»˜è®¤éšè—ï¼Œç”±æ€»å¼€å…³æ§åˆ¶) -->
<div id="background-activity-details" style="display: none;">
    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
        <label for="background-interval-input" style="margin-bottom: 0;">
            åå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’)
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å»ºè®®å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè´¹ç”¨è¶Šä½ï¼Œä½†è§’è‰²ååº”è¶Šæ…¢ã€‚
            </p>
        </label>
        <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
    </div>

    <!-- 3. è§’è‰²é€‰æ‹©ä¸é¢‘ç‡è®¾ç½® -->
    <div class="form-group">
        <label>è®¾ç½®è§’è‰²æ´»åŠ¨é¢‘ç‡</label>
        <div id="background-activity-char-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
            <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="bg-select-all-chars" class="form-button-secondary" style="flex:1; margin:0;">å…¨é€‰</button>
            <button id="bg-deselect-all-chars" class="form-button-secondary" style="flex:1; margin:0;">å…¨ä¸é€‰</button>
        </div>
    </div>

    <div class="form-group">
    <label>ä¸ºé€‰ä¸­è§’è‰²è®¾ç½®é¢‘ç‡</label>
    <div style="display: flex; gap: 10px;">
        <button class="form-button-secondary bg-freq-btn" data-freq="low" style="flex:1; margin:0; border-color: #28a745;">ä½</button>
        <button class="form-button-secondary bg-freq-btn" data-freq="medium" style="flex:1; margin:0; border-color: #fd7e14;">ä¸­</button>
        <button class="form-button-secondary bg-freq-btn" data-freq="high" style="flex:1; margin:0; border-color: #dc3545;">é«˜</button>
        <!-- â–¼â–¼â–¼ å°±æ˜¯æ–°å¢äº†è¿™ä¸ªâ€œå…³é—­â€æŒ‰é’® â–¼â–¼â–¼ -->
        <button class="form-button-secondary bg-freq-btn" data-freq="none" style="flex:1; margin:0; border-color: #aaa;">å…³é—­</button>
    </div>
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 8px;">
        é¢‘ç‡è¶Šé«˜ï¼Œè§’è‰²ä¸»åŠ¨è¡Œä¸ºçš„æ¦‚ç‡è¶Šå¤§ï¼Œè´¹ç”¨ä¹Ÿè¶Šé«˜ã€‚
    </p>
</div>
</div>
<!-- â–²â–²â–² å…¨æ–°çš„åå°æ´»åŠ¨è®¾ç½®åŒºç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIè¢«æ‹‰é»‘åå†·é™æœŸ (å°æ—¶)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            è¢«æ‹‰é»‘è¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼ŒAIæ‰æœ‰å‡ ç‡é‡æ–°ç”³è¯·å¥½å‹ã€‚
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">
<p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">ä»¥ä¸‹æ˜¯ Minimax è¯­éŸ³ï¼ˆTTSï¼‰çš„è®¾ç½®ï¼Œç”¨äºAIå‘é€è¯­éŸ³æ¶ˆæ¯ã€‚</p>
<div class="form-group">
    <label for="minimax-group-id">Minimax Group ID</label>
    <input type="text" id="minimax-group-id" placeholder="è¾“å…¥ä½ çš„ Minimax Group ID">
</div>
<div class="form-group">
    <label for="minimax-api-key">Minimax API Key</label>
    <input type="password" id="minimax-api-key" placeholder="è¾“å…¥ä½ çš„ Minimax API Key">
</div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="minimax-speech-model-select">Minimax è¯­éŸ³æ¨¡å‹ (TTS Model)</label>
    <select id="minimax-speech-model-select">
        <!-- é€‰é¡¹å°†ç”±JSå¡«å…… -->
    </select>
</div>
<button class="form-button" id="fetch-minimax-speech-models-btn">æ‹‰å–è¯­éŸ³æ¨¡å‹</button>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<hr style="margin:20px 0; opacity:.3">
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<button class="form-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>
			<hr style="margin:20px 0; opacity:.3">
<button class="form-button form-button-secondary" id="clear-orphaned-data-btn" style="margin-top: 10px; border-color: #ff9966; color: #ff9966;">ğŸ§¹ æ¸…ç†å¤±æ•ˆæ•°æ®</button>
			<button class="form-button" id="export-data-btn">å¯¼å‡ºæ•°æ®</button>

<!-- â‘  æ™®é€šæŒ‰é’®ï¼Œå’Œâ€œå¯¼å‡ºâ€ä¸€ä¸ª class -->
<button class="form-button" id="import-btn">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>

<!-- â‘¡ çœŸæ­£çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå®Œå…¨éšè— -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ chat-list-screen â–¼â–¼â–¼ -->
<div id="chat-list-screen" class="screen">
    
    <!-- ä¸»å¤´éƒ¨ (åªåœ¨æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º) -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
<span id="chat-list-title">æ¶ˆæ¯</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <!-- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„å¯¼å…¥æŒ‰é’® â–¼â–¼â–¼ -->
<span class="action-btn" id="import-character-card-btn" title="å¯¼å…¥è§’è‰²å¡">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
</span>
<!-- â–²â–²â–² å¯¼å…¥æŒ‰é’®ç»“æŸ â–²â–²â–² -->
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
    </div>

    <!-- åŠ¨æ€ç•Œé¢è§†å›¾ -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- è¿™ä¸ªæŒ‰é’®ç°åœ¨åªè´Ÿè´£ä»åŠ¨æ€è¿”å› -->
            <span>å¥½å‹åŠ¨æ€</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="å¤´åƒ">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>è¯´è¯´</span></div>
                <div class="action-item" id="create-post-btn"><span>åŠ¨æ€</span></div>
                <div class="action-item" id="open-album-btn"><span>ç›¸å†Œ</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">â€¹</span>
        <span>æˆ‘çš„æ”¶è—</span>
        <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
        <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
    </div>

        <!-- ã€æ–°å¢ã€‘æœç´¢æ å®¹å™¨ -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- æ–°å¢ï¼šæ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆ é™¤ (0)</button>
</div>

    </div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å›å¿†å½•ç•Œé¢è§†å›¾ â–¼â–¼â–¼ -->
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn">â€¹</span>
        <span>æˆ‘ä»¬çš„å›å¿†</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- å›å¿†å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

   
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>æ¶ˆæ¯</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>åŠ¨æ€</span>
    </div>
    <!-- â–¼â–¼â–¼ åœ¨â€œåŠ¨æ€â€å’Œâ€œæ”¶è—â€ä¹‹é—´ï¼ŒåŠ å…¥è¿™ä¸ªæ–°é¡µç­¾ â–¼â–¼â–¼ -->
    <div class="nav-item" data-view="memories-view">
        <span>å›å¿†</span>
    </div>
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <div class="nav-item" data-view="favorites-view">
        <span>æ”¶è—</span>
    </div>
</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="chat-list-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">â€¹</span>
        <span>æˆ‘çš„ç›¸å†Œ</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="album-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">â€¹</span>
        <span id="album-photos-title">ç›¸å†Œåç§°</span>
        <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. å…³é—­æŒ‰é’® -->
    <button id="photo-viewer-close-btn">Ã—</button>
    
    <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
    
    <!-- 3. å›¾ç‰‡å®¹å™¨ -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ">
    </div>
    
    <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç²˜è´´åˆ° #album-photos-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ‚¨æ–‡ä»¶ä¸­æ—§çš„ #chat-interface-screen åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="chat-interface-screen" class="screen">

<div class="header">
    <!-- é»˜è®¤æ§ä»¶ï¼šåŒ…å«æ ‡é¢˜ã€çŠ¶æ€æ å’Œå¸¸è§„æŒ‰é’® -->
    <div class="default-controls">
        <span class="back-btn" id="back-to-list-btn">â€¹</span>
        
        <!-- æ ‡é¢˜å’ŒçŠ¶æ€çš„å®¹å™¨ -->
        <div id="chat-header-title-wrapper">
            <div id="chat-header-main-line">
                <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘ŠæŒ‰é’® â–¼â–¼â–¼ -->
    <span id="group-announcement-btn" title="ç¾¤å…¬å‘Š">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="7" y1="15" x2="17" y2="15"></line>
        </svg>
    </span>
    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
            </div>
            <div id="chat-header-status">
                <span class="status-dot"></span>
                <span class="status-text">åœ¨çº¿</span>
            </div>
        </div>

        <div class="header-actions">
            <!-- ã€æ­£ç¡®ä½ç½®ã€‘å¿ƒå£°æŒ‰é’®åœ¨è¿™é‡Œ -->
            <span class="action-btn" id="char-heart-btn" title="å¿ƒå£°" style="display: none; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#ff4d6d" stroke="#ffc3d0" stroke-width="1.5">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </span>
            <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
            <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è®¾ç½®"></span>
        </div>
    </div>

    <!-- å¤šé€‰æ¨¡å¼æ§ä»¶ -->
    <div class="selection-controls">
        <span id="selection-cancel-btn">å–æ¶ˆ</span>
        <span id="selection-count"></span>
        <div class="header-actions">
           <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
           <span id="selection-share-btn" class="action-btn">åˆ†äº«</span> 
           <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">åˆ é™¤</span>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ åœ¨ #chat-interface-screen å†…ï¼Œheader çš„ div ä¹‹åæ·»åŠ  â–¼â–¼â–¼ -->

<div id="chat-pet-container" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 10;">
    <div id="chat-pet" style="display: none; position: absolute; cursor: grab; user-select: none; pointer-events: all; font-size: 80px; line-height: 1; text-align: center;">
        <!-- å® ç‰©ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>

    <!-- è¾“å…¥åŒºåŸŸ (è¿™æ˜¯ä¿®æ”¹åçš„æœ€ç»ˆç‰ˆæœ¬) -->
    <div id="chat-input-area">
        <div id="reply-preview-bar">
            <div class="reply-preview-content">
                <div class="sender">å›å¤ xxx:</div>
                <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹...</div>
            </div>
            <span id="cancel-reply-btn">Ã—</span>
        </div>
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg></button>
            
            <!-- â€œé‡æ–°ç”Ÿæˆå›å¤â€æŒ‰é’®çš„æ–°å®¶ -->
            <button id="reroll-btn" class="action-button" title="é‡æ–°ç”Ÿæˆå›å¤"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg></button>
            
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
            </svg>
            </button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
            <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="å‘èµ·å¤–å–è¯·æ±‚"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
            <button id="video-call-btn" class="chat-action-icon-btn action-button" title="è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
            <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
            <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="å‘èµ·æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
            <button id="share-link-btn" class="chat-action-icon-btn action-button" title="åˆ†äº«é“¾æ¥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
            <button id="send-location-btn" class="chat-action-icon-btn action-button" title="å‘é€å®šä½">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
            </button>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢ä½ åŸæ¥çš„é‚£ä¸ª <button id="open-tarot-btn">...</button> â–¼â–¼â–¼ -->
<button id="open-tarot-btn" class="chat-action-icon-btn action-button" title="å¡”ç½—å åœ">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- èƒŒæ™¯å·¦ä¾§å¡ç‰Œ -->
        <path d="M7 6.5L4 7.5V17.5L7 16.5V6.5Z" stroke="currentColor" stroke-width="2.6" stroke-linejoin="round"/>
        <!-- èƒŒæ™¯å³ä¾§å¡ç‰Œ -->
        <path d="M17 6.5L20 7.5V17.5L17 16.5V6.5Z" stroke="currentColor" stroke-width="2.6" stroke-linejoin="round"/>
        <!-- å‰æ–¹ä¸­å¿ƒå¡ç‰Œ -->
        <rect x="7" y="5" width="10" height="15" rx="1.5" stroke="currentColor" stroke-width="2.6"/>
        <!-- ä¸­å¿ƒå¡ç‰Œçš„æ˜Ÿæ˜Ÿ -->
        <path d="M12 9.5L13.12 11.79L15.61 12.17L13.8 13.92L14.24 16.4L12 15.2L9.76 16.4L10.2 13.92L8.39 12.17L10.88 11.79L12 9.5Z" fill="currentColor"/>
    </svg>
</button>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€æ­ªå¤´æ€Â·æ»¡åˆ†å¯çˆ±çŒ«ã€‘è¯·ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„å® ç‰©æŒ‰é’® <button> â–¼â–¼â–¼ -->
<button id="pet-action-btn" class="chat-action-icon-btn action-button" title="æˆ‘çš„å® ç‰©">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- ä¸»ä½“è½®å»“: è€³æœµä¸å¯¹ç§°ï¼Œè¥é€ æ­ªå¤´æ•ˆæœ -->
        <path d="M3.5 14.5C3.5 20.5 20.5 20.5 20.5 14.5C20.5 9 17.5 5.5 12.5 8.7C6.5 4.5 3.5 9 3.5 14.5Z" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
        <!-- çœ¼ç› -->
        <circle cx="8.5" cy="15" r="1.5" fill="currentColor"/>
        <circle cx="15.5" cy="15" r="1.5" fill="currentColor"/>
        <!-- å·¦è¾¹ä¸¤æ ¹å°èƒ¡é¡» -->
        <path d="M4.5 14.3L2.5 13.3" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <path d="M4.5 15.7L2.5 16.7" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <!-- å³è¾¹ä¸¤æ ¹å°èƒ¡é¡» -->
        <path d="M19.5 14.3L21.5 13.3" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        <path d="M19.5 15.7L21.5 16.7" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
    </svg>
</button>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->





        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¤"></button>
                <button id="send-btn" class="action-button">å‘é€</button>
            </div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #sticker-panel â–¼â–¼â–¼ -->
<div id="sticker-panel">
    <div id="sticker-panel-header">
        <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
        <span class="title">è¡¨æƒ…åŒ…</span>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ–°å¢â€œç¼–è¾‘â€å’Œâ€œå®Œæˆâ€æŒ‰é’® -->
        <div style="display: flex; gap: 10px;">
            <span class="panel-btn" id="edit-user-stickers-btn">ç¼–è¾‘</span>
            <span class="panel-btn" id="done-user-stickers-btn" style="display: none;">å®Œæˆ</span>
            <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
            <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
        </div>
    </div>
    <div id="sticker-grid"></div>
    <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨åº•éƒ¨æ–°å¢ä¸€ä¸ªç”¨äºæ‰¹é‡åˆ é™¤çš„æ“ä½œæ ï¼Œé»˜è®¤éšè— -->
<!-- åœ¨ #sticker-panel ä¸­ï¼Œæ‰¾åˆ° id="sticker-panel-footer" -->
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ #sticker-panel-footer â–¼â–¼â–¼ -->
<div id="sticker-category-tabs">
    <!-- åˆ†ç±»èƒ¶å›Šå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
</div>
<div id="sticker-panel-footer" style="display: none;">
    <!-- â˜… æ–°å¢ï¼šâ€œç§»åŠ¨åˆ°åˆ†ç±»â€æŒ‰é’® -->
    <button id="move-selected-stickers-btn">ç§»åŠ¨åˆ°åˆ†ç±»...</button>
    <!-- è¿™æ˜¯ä½ å·²æœ‰çš„åˆ é™¤æŒ‰é’® -->
    <button id="delete-selected-user-stickers-btn">åˆ é™¤å·²é€‰ (0)</button>
</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<input type="file" id="sticker-upload-input" accept="image/*" style="display: none;" multiple>
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <!-- éŸ³ä¹æ’­æ”¾å™¨ (ä¿æŒä¸å˜) -->
<div id="music-player-overlay">
<div class="music-player-window">
    <!-- 1. é¡¶éƒ¨å¤´åƒåŒºåŸŸ -->
    <div id="music-avatars-container">
        <img id="music-char-avatar" src="" alt="è§’è‰²å¤´åƒ">
        <svg id="heartbeat-line" viewBox="0 0 80 30">
            <path class="heartbeat-path" d="M 5 15 Q 20 0 30 15 T 55 15 L 75 15"></path>
            <path class="heartbeat-heart" d="M 0 -2 a 2 2 0 0 1 4 0 v 2 a 2 2 0 0 1 -4 0 z"></path>
        </svg>
        <img id="music-user-avatar" src="" alt="ç”¨æˆ·å¤´åƒ">
    </div>
    
    <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬æŠŠè¿™è¡Œæ–‡å­—ç§»åˆ°äº†è¿™é‡Œ â–¼â–¼â–¼ -->
    <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>

    <!-- 2. é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
    <div class="music-player-top-actions">
        <div class="top-left-cluster">
            <button id="music-return-btn">â€¹</button>
            <button id="music-exit-btn">Ã—</button>
        </div>
        <span id="music-playlist-btn">â˜°</span>
    </div>

    <!-- 3. å°é¢å’Œæ­Œè¯çš„åˆ‡æ¢å®¹å™¨ -->
    <div id="music-display-area">
        <img id="music-album-cover" src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png" alt="æ­Œæ›²å°é¢">
        <div id="music-lyrics-container">
            <div id="music-lyrics-list">
                <div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>
            </div>
        </div>
    </div>

    <!-- 4. æ­Œæ›²ä¿¡æ¯ -->
    <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
    <div id="music-player-artist">...</div>
    
    <!-- 5. æ’­æ”¾æ§åˆ¶åŒº (ä¿æŒä¸å˜) -->
    <div class="music-player-controls-wrapper">
        <div class="music-progress-bar-container">
            <div id="music-current-time" class="time-display">0:00</div>
            <div class="progress-bar">
                <div id="music-progress-fill" class="progress-bar-fill"></div>
            </div>
            <div id="music-total-time" class="time-display">0:00</div>
        </div>
        <div class="music-controls">
            <button id="music-prev-btn">â—€</button>
            <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
            <button id="music-next-btn">â–¶</button>
            <button id="music-mode-btn">é¡ºåº</button>
            <button id="toggle-lyrics-bar-btn" title="æ¡Œé¢æ­Œè¯">æ‚¬æµ®</button>
        </div>
    </div>
</div>

    </div>
</div>
    
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ id="music-playlist-panel" åŠå…¶æ‰€æœ‰å†…éƒ¨å†…å®¹ â–¼â–¼â–¼ -->
<div id="music-playlist-panel">
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ â–¼â–¼â–¼ -->
<div class="playlist-header">
    <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
    <span>æ’­æ”¾åˆ—è¡¨</span>
    <div>
        <!-- â–¼â–¼â–¼ æˆ‘ä»¬æŠŠåƒåœ¾æ¡¶å›¾æ ‡ç§»åˆ°äº†'æœ¬åœ°'çš„å·¦è¾¹ â–¼â–¼â–¼ -->
        <span class="panel-btn" id="delete-expired-songs-btn" title="æ¸…ç†å¤±æ•ˆçš„æœç´¢æ­Œæ›²">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </span>
        <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
        <span class="panel-btn" id="add-song-url-btn">URL</span>
        <span class="panel-btn" id="add-song-search-btn">æœç´¢</span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ä½ åŸæ¥çš„ id="wallpaper-screen" â–¼â–¼â–¼ -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ‡é¢˜æ”¹ä¸ºâ€œå¤–è§‚è®¾ç½®â€ï¼Œæ›´é€šç”¨ -->
        <span>å¤–è§‚è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <!-- é”å±å£çº¸è®¾ç½® (å…¨æ–°) -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);">é”å±è®¾ç½®</label>
        </div>
        <div id="lockscreen-wallpaper-preview" class="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
        <button class="form-button" onclick="document.getElementById('lockscreen-wallpaper-upload-input').click();">ä¸Šä¼ é”å±å£çº¸</button>
        <input type="file" id="lockscreen-wallpaper-upload-input" accept="image/*" hidden>
        
        <div class="form-group" style="width: 100%; margin-top: 15px;">
            <label for="password-set-input">é”å±å¯†ç  (ç•™ç©ºåˆ™æ— å¯†ç )</label>
            <input type="text" id="password-set-input" placeholder="è®¾ç½®ä½ çš„è§£é”å¯†ç ">
        </div>
        
        <hr style="width: 80%; opacity: 0.3; margin: 20px 0;">

        <!-- ä¸»å±å¹•å£çº¸è®¾ç½® (åŸæœ‰) -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);">ä¸»å±å¹•è®¾ç½®</label>
        </div>
        <div id="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ° wallpaper-preview çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="enable-lock-screen-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å¯ç”¨é”å±ç•Œé¢</span>
        <input type="checkbox" id="enable-lock-screen-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„â€œæ˜¾ç¤ºçŠ¶æ€æ â€å¼€å…³ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="show-status-bar-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">æ˜¾ç¤ºçŠ¶æ€æ </span>
        <input type="checkbox" id="show-status-bar-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->


        <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button>
        <input type="file" id="wallpaper-upload-input" accept="image/*">

<!-- â–¼â–¼â–¼ å°†ã€ä¸‹é¢æ•´å—ä»£ç ã€‘ï¼Œå®Œæ•´æ›¿æ¢ä¸ºä¸‹é¢è¿™æ®µã€å…¨æ–°çš„ä»£ç ã€‘ â–¼â–¼â–¼ -->
<div class="form-group" style="display: none;">
    <label for="theme-toggle-switch" style="margin-bottom: 0;">å¤œé—´æ¨¡å¼</label>
    <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle-switch">
        <span class="slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- === â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æ–°å¢çš„ç¾åŒ–åŠŸèƒ½UI â–¼â–¼â–¼ === -->
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">æ‰‹æœºç¾åŒ– (CSS)</label>
    </div>

    <!-- ä¸»é¢˜é€‰æ‹©å’Œç®¡ç† -->
    <div class="form-group">
        <label for="theme-selector">é€‰æ‹©å·²å­˜æ–¹æ¡ˆ</label>
        <div style="display: flex; gap: 10px;">
            <select id="theme-selector" style="flex-grow: 1;"></select>
            <button id="rename-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px;">é‡å‘½å</button>
            <button id="delete-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px; background-color: #ffdddd; color: #ff3b30;">åˆ é™¤</button>
        </div>
    </div>

    <!-- CSS ä»£ç ç¼–è¾‘åŒº -->
    <div class="form-group">
        <label for="theme-css-editor">ç¾åŒ–ä»£ç ç¼–è¾‘åŒº</label>
        <textarea id="theme-css-editor" rows="10" style="font-family: monospace; font-size: 12px; resize: vertical;" placeholder="åœ¨è¿™é‡Œç²˜è´´æˆ–ç¼–è¾‘ç¾åŒ–ä»£ç ..."></textarea>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <button id="apply-theme-btn" class="form-button">åº”ç”¨å½“å‰ä»£ç </button>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="save-theme-btn" class="form-button-secondary" style="flex:1;">ä¿å­˜</button>
        <button id="save-as-new-theme-btn" class="form-button-secondary" style="flex:1;">å¦å­˜</button>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="export-theme-btn" class="form-button-secondary" style="flex:1;">å¯¼å‡ºæ–¹æ¡ˆ</button>
        <button id="import-theme-btn" class="form-button-secondary" style="flex:1;">å¯¼å…¥æ–¹æ¡ˆ</button>
        <input type="file" id="import-theme-input" accept=".json" hidden>
    </div>
    <!-- === â–²â–²â–² æ–°å¢UIç»“æŸ â–²â–²â–² === -->
<!-- â–¼â–¼â–¼ ã€V3æœ€ç»ˆç¾åŒ–ç‰ˆã€‘ä¸»å±å¹•ç¾åŒ–é¢„è®¾åŠŸèƒ½UI â–¼â–¼â–¼ -->
<div class="preset-manager-container">
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">ä¸»å±å¹•é¢„è®¾</label>
    </div>
    <div class="form-group">
        <select id="home-preset-selector" class="form-group select"></select>
        <div class="preset-manager-controls">
            <!-- ç‹¬å ä¸€è¡Œçš„åº”ç”¨æŒ‰é’® -->
            <button id="apply-home-preset-btn" class="preset-btn-capsule preset-btn-apply" disabled>åº”ç”¨</button>
            
            <!-- 2x2 ç½‘æ ¼æŒ‰é’® -->
            <button id="save-home-preset-btn" class="preset-btn-capsule preset-btn-save">ä¿å­˜</button>
            <!-- â–¼â–¼â–¼ å°±æ˜¯åœ¨è¿™é‡Œæ–°å¢äº†â€œæ›´æ–°â€æŒ‰é’® â–¼â–¼â–¼ -->
            <button id="update-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>æ›´æ–°</button>
            <button id="rename-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>é‡å‘½å</button>
            <button id="import-home-preset-btn" class="preset-btn-capsule preset-btn-secondary">å¯¼å…¥</button>
            <button id="export-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>å¯¼å‡º</button>
            <button id="delete-home-preset-btn" class="preset-btn-capsule preset-btn-delete" disabled>åˆ é™¤</button>
            
            <input type="file" id="import-home-preset-input" accept=".json" hidden>
        </div>
    </div>
</div>
<!-- â–²â–²â–² UIæ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æ­¥éª¤2ï¼šç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„é¢œè‰²é€‰æ‹©å™¨HTML â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">ä¸»å±å¹•å›¾æ ‡åŠå°ç»„ä»¶å­—ä½“é¢œè‰²</label>
</div>
<div class="form-group">
    <label for="home-icon-widget-text-color-picker">è‡ªå®šä¹‰å­—ä½“é¢œè‰²</label>
    <input type="color" id="home-icon-widget-text-color-picker" value="#FFFFFF" style="width: 100%; height: 40px; padding: 0; border-radius: 8px;">
</div>
<!-- â–²â–²â–² æ­¥éª¤2 HTMLä»£ç æ›¿æ¢ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="remove-home-font-shadow-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å»é™¤ä¸»å±å¹•å­—ä½“é˜´å½±</span>
        <input type="checkbox" id="remove-home-font-shadow-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

        <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢å›¾æ ‡è®¾ç½®åŒºåŸŸ -->
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">App å›¾æ ‡è®¾ç½®</label>
        </div>
        <div id="icon-settings-grid">
            <!-- å›¾æ ‡è®¾ç½®é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°â€œAppå›¾æ ‡è®¾ç½®â€çš„ div ä¹‹å â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">ä¸»å±å¹• App åç§°</label>
</div>
<div id="icon-rename-grid" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
    <!-- App åç§°è¾“å…¥æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ å°†è¿™æ®µæ–°ä»£ç ï¼Œç²˜è´´åˆ°â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€æŒ‰é’®çš„ã€ä¸Šæ–¹ã€‘ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">é“ƒå£°è®¾ç½®</label>
</div>
<div class="form-group" style="width: 100%;">
    <label for="ringtone-url-input">æ¥ç”µé“ƒå£° URL (.mp3, .wav, etc.)</label>
    <input type="text" id="ringtone-url-input" placeholder="è¾“å…¥éŸ³é¢‘æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥...">
</div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" style="width: 100%; margin-top: 15px;">
    <label for="notification-sound-url-input">æ¶ˆæ¯æç¤ºéŸ³ URL (.mp3, .wav, etc.)</label>
    <input type="text" id="notification-sound-url-input" placeholder="è¾“å…¥éŸ³é¢‘æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥...">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼ŒæŠŠä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€æŒ‰é’®çš„ã€ä¸Šæ–¹ã€‘ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">å…¨å±€èŠå¤©èƒŒæ™¯</label>
</div>
<div id="global-bg-preview" class="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
<button class="form-button" onclick="document.getElementById('global-bg-upload-input').click();">ä¸Šä¼ å…¨å±€èƒŒæ™¯</button>
<input type="file" id="global-bg-upload-input" accept="image/*" hidden>
<button class="form-button form-button-secondary" id="remove-global-bg-btn" style="margin-top: 10px;">ç§»é™¤å…¨å±€èƒŒæ™¯</button>
<button class="form-button form-button-secondary" id="clear-all-single-bgs-btn" style="margin-top: 10px; border-color: #ff3b30; color: #ff3b30;">ä¸€é”®æ¸…ç©ºæ‰€æœ‰å•äººèŠå¤©èƒŒæ™¯</button>
<!-- â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² -->
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æŒ‰é’®æ–‡å­—ä¹Ÿæ”¹ä¸€ä¸‹ -->
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½ HTML â–¼â–¼â–¼ -->
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn">â€¹</span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
        <!-- æ–‡ç« å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<div id="font-settings-screen" class="screen">
    <div class="header">
    <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
    <span>å­—ä½“é¢„è®¾</span>
    <span style="width: 30px;"></span> <!-- ä¿ç•™è¿™ä¸ªå ä½ç¬¦ï¼Œè®©æ ‡é¢˜èƒ½å®Œç¾å±…ä¸­ -->
</div>
    <div class="form-container" style="gap: 20px;">
        <!-- å­—ä½“é¢„è®¾å¡æ§½çš„å®¹å™¨ -->
        <div id="font-preset-container">
            <!-- 5ä¸ªå¡æ§½å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

        <!-- å…¨å±€å­—ä½“é¢„è§ˆåŒº -->
        <div class="form-group" style="width:100%;">
            <label>å½“å‰å…¨å±€å­—ä½“é¢„è§ˆ</label>
            <div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                <p style="margin: 0;">è¿™æ˜¯å…¨å±€å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
            </div>
        </div>

        <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
    </div>
</div>

<!-- è¿™ä¸ªæ˜¯éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œç”¨æ¥å¤„ç†æœ¬åœ°ä¸Šä¼  -->
<input type="file" id="font-preset-local-upload" accept=".ttf,.otf,.woff,.woff2" style="display: none;">


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½çš„æ‰€æœ‰HTMLç•Œé¢ (V3ç»ˆæç‰ˆ) â–¼â–¼â–¼ -->

<!-- 1. è§’è‰²é€‰æ‹©å±å¹• (ä¿æŒä¸å˜) -->
<div id="character-selection-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é€‰æ‹©è¦æŸ¥çœ‹çš„æ‰‹æœº</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="character-selection-list" class="list-container"></div>
</div>

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ id="character-phone-container" åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="character-phone-container" class="screen">
    <div class="character-phone-frame">
        <div class="character-phone-notch"></div>
        <div class="character-phone-inner-screen">
            
            <!-- 1. è§’è‰²æ‰‹æœºçš„ä¸»ç•Œé¢ -->
            <div id="character-phone-screen" class="character-phone-page active">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-screen="character-selection-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-phone-owner-name"></span>
                    <div class="header-actions">
                        <span class="action-btn" id="clear-character-data-btn" title="æ¸…ç©ºå…¨éƒ¨æ•°æ®">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-character-data-btn" title="åˆ·æ–°å…¨éƒ¨æ•°æ®">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L20.5 10M3.5 14a9 9 0 0114.85 3.36L20.5 14"/></svg>
                        </span>
                    </div>
                </div>
                <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ®µå…¨æ–°çš„HTMLä»£ç  â–¼â–¼â–¼ -->
<!-- è¿™æ˜¯å·¦ä¸Šè§’çš„å°ç»„ä»¶ -->
<div id="char-phone-widget-1" class="char-phone-widget">
    <img id="char-phone-widget-img-1" src="">
</div>
<!-- è¿™æ˜¯å³ä¸‹è§’çš„å°ç»„ä»¶ -->
<div id="char-phone-widget-2" class="char-phone-widget">
    <img id="char-phone-widget-img-2" src="">
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                <div id="character-app-grid" class="app-grid-standard" style="padding-top: 60px;"></div>
            </div>

            <!-- 2. è§’è‰²æ‰‹æœº - èŠå¤©åˆ—è¡¨ -->
            <div id="character-chat-list-screen" class="character-phone-page">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æ¶ˆæ¯</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæ¶ˆæ¯é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-npc-chats-btn" title="æ¸…ç©ºæ‰€æœ‰NPCèŠå¤©">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-chat-message-btn" title="ç”Ÿæˆæ–°èŠå¤©">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-chat-list" class="list-container" style="padding: 0;"></div>
            </div>

            <!-- 3. è§’è‰²æ‰‹æœº - å…·ä½“èŠå¤©è®°å½• -->
            <div id="character-chat-history-screen" class="character-phone-page">
                <div class="header character-phone-header">
                     <span class="back-btn" data-target-page="character-chat-list-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-chat-with-name"></span>
                </div>
                <div id="character-chat-history-messages" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #e5ddd5;"></div>
            </div>

            <!-- 4. è§’è‰²æ‰‹æœº - è´­ç‰©è½¦ -->
            <div id="character-shopping-cart-screen" class="character-phone-page">
                <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                         <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>è´­ç‰©è½¦</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šè´­ç‰©è½¦é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-cart-items-btn" title="æ¸…ç©ºè´­ç‰©è½¦">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-cart-item-btn" title="æ·»åŠ æ–°å•†å“">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </span>
                    </div>
                </div>
                <div id="character-shopping-cart-list" class="list-container"></div>
            </div>

            <!-- 5. è§’è‰²æ‰‹æœº - å¤‡å¿˜å½• -->
            <div id="character-memos-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>å¤‡å¿˜å½•</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šå¤‡å¿˜å½•é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-memos-btn" title="æ¸…ç©ºå¤‡å¿˜å½•">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-memo-btn" title="å†™æ–°å¤‡å¿˜å½•">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-memos-list" class="list-container"></div>
            </div>

            <!-- 6. è§’è‰²æ‰‹æœº - æµè§ˆå™¨ -->
            <div id="character-browser-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æµè§ˆå™¨</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæµè§ˆå™¨é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-browser-history-btn" title="æ¸…ç©ºå†å²è®°å½•">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-browser-history-btn" title="ç”Ÿæˆæ–°å†å²">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-browser-list" class="list-container"></div>
            </div>

            <!-- 7. è§’è‰²æ‰‹æœº - æµè§ˆå™¨æœç´¢ç»“æœè¯¦æƒ… -->
            <div id="character-browser-detail-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-browser-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span id="character-browser-detail-title">æœç´¢ç»“æœ</span>
                </div>
                <div id="character-browser-detail-content" class="list-container" style="padding: 15px; line-height: 1.7;"></div>
            </div>

            <!-- 8. è§’è‰²æ‰‹æœº - ç›¸å†Œ -->
            <div id="character-album-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>ç›¸å†Œ</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šç›¸å†Œé¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-album-photos-btn" title="æ¸…ç©ºç›¸å†Œ">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-album-photo-btn" title="ç”Ÿæˆæ–°ç…§ç‰‡">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </span>
                    </div>
                </div>
                <div id="character-album-grid" class="list-container"></div>
            </div>

            <!-- 9. è§’è‰²æ‰‹æœº - é“¶è¡Œ -->
            <div id="character-bank-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>é’±åŒ…</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šé’±åŒ…é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-bank-transactions-btn" title="æ¸…ç©ºäº¤æ˜“è®°å½•">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-bank-transaction-btn" title="ç”Ÿæˆæ–°äº¤æ˜“">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-bank-details" class="list-container"></div>
            </div>

            <!-- 10. è§’è‰²æ‰‹æœº - è¡ŒåŠ¨è½¨è¿¹ -->
            <div id="character-trajectory-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>è¶³è¿¹</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šè¶³è¿¹é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-trajectory-btn" title="æ¸…ç©ºè¶³è¿¹">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-trajectory-btn" title="ç”Ÿæˆæ–°è¶³è¿¹">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </span>
                    </div>
                </div>
                <div id="character-trajectory-list" class="list-container"></div>
            </div>

            <!-- 11. è§’è‰²æ‰‹æœº - APPä½¿ç”¨è®°å½• -->
            <div id="character-app-usage-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>å±å¹•ä½¿ç”¨æ—¶é—´</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šä½¿ç”¨è®°å½•é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-app-usage-btn" title="æ¸…ç©ºè®°å½•">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-app-usage-btn" title="ç”Ÿæˆæ–°è®°å½•">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                        </span>
                    </div>
                </div>
                <div id="character-app-usage-list" class="list-container"></div>
            </div>

            <!-- 12. è§’è‰²æ‰‹æœº - æ—¥è®° -->
            <div id="character-diary-screen" class="character-phone-page">
                 <div class="header character-phone-header">
                    <span class="back-btn" data-target-page="character-phone-screen">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </span>
                    <span>æ—¥è®°</span>
                    <div class="header-actions">
                        <!-- â˜… æ–°å¢ï¼šæ—¥è®°é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                        <span class="action-btn" id="clear-diary-entries-btn" title="æ¸…ç©ºæ—¥è®°">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                        </span>
                        <span class="action-btn" id="generate-diary-entry-btn" title="å†™æ–°æ—¥è®°">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                    </div>
                </div>
                <div id="character-diary-list" class="list-container"></div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®çš„HTMLç•Œé¢ï¼Œè¯·ç²˜è´´åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼ -->
<div id="character-phone-appearance-screen" class="character-phone-page">
    <div class="header character-phone-header">
        <span class="back-btn" data-target-page="character-phone-screen">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </span>
        <span>å¤–è§‚è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <!-- å¤ç”¨ä½ å·²æœ‰çš„.form-containeræ ·å¼ï¼Œæ–¹ä¾¿æ»šåŠ¨å’Œå¸ƒå±€ -->
    <div class="form-container" style="padding: 15px; gap: 25px;">
        <!-- å£çº¸è®¾ç½®åŒº -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">æ‰‹æœºå£çº¸</label>
            <div id="char-phone-wallpaper-preview" class="wallpaper-preview" style="height: 240px; width: 135px; margin: 10px auto; border-radius: 12px;">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
            <button id="upload-char-phone-wallpaper-btn" class="form-button">ä¸Šä¼ å£çº¸</button>
            <button id="remove-char-phone-wallpaper-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç§»é™¤å£çº¸</button>
        </div>
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼ -->
<hr style="width: 100%; opacity: 0.2;">

<div>
    <label style="font-weight: 500; color: var(--text-secondary);">App å†…å£çº¸</label>
    <div id="char-phone-app-wallpaper-preview" class="wallpaper-preview" style="height: 240px; width: 135px; margin: 10px auto; border-radius: 12px;">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
    <button id="upload-char-phone-app-wallpaper-btn" class="form-button">ä¸Šä¼  App å†…å£çº¸</button>
    <button id="remove-char-phone-app-wallpaper-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç§»é™¤ App å†…å£çº¸</button>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

        <hr style="width: 100%; opacity: 0.2;">

        <!-- Appå›¾æ ‡è®¾ç½®åŒº -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">App å›¾æ ‡</label>
            <div id="char-phone-icon-settings-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; text-align: center;">
                <!-- Appå›¾æ ‡è®¾ç½®å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>

        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼ -->
        <hr style="width: 100%; opacity: 0.2;">
        <!-- æ¡Œé¢å°ç»„ä»¶è®¾ç½®åŒº -->
        <div>
            <label style="font-weight: 500; color: var(--text-secondary);">æ¡Œé¢å°ç»„ä»¶</label>
            <!-- å°ç»„ä»¶1: å·¦ä¸Šè§’ -->
            <div class="form-group" style="margin-top: 15px;">
                <label>å·¦ä¸Šè§’å°ç»„ä»¶</label>
                <div class="avatar-upload">
                    <img id="char-phone-widget-preview-1" class="wallpaper-preview" style="height: 100px; width: 100px; margin-bottom: 0;">
                    <div style="display:flex; flex-direction: column; gap: 8px;">
                        <button class="form-button-secondary" id="upload-widget-1-btn" style="margin-top:0;">ä¸Šä¼ å›¾ç‰‡</button>
                        <button class="form-button-secondary" id="remove-widget-1-btn" style="margin-top:0; border-color: #ff3b30; color: #ff3b30;">ç§»é™¤å›¾ç‰‡</button>
                    </div>
                </div>
            </div>
            <!-- å°ç»„ä»¶2: å³ä¸‹è§’ -->
            <div class="form-group" style="margin-top: 15px;">
                <label>å³ä¸‹è§’å°ç»„ä»¶</label>
                <div class="avatar-upload">
                    <img id="char-phone-widget-preview-2" class="wallpaper-preview" style="height: 100px; width: 100px; margin-bottom: 0;">
                     <div style="display:flex; flex-direction: column; gap: 8px;">
                        <button class="form-button-secondary" id="upload-widget-2-btn" style="margin-top:0;">ä¸Šä¼ å›¾ç‰‡</button>
                        <button class="form-button-secondary" id="remove-widget-2-btn" style="margin-top:0; border-color: #ff3b30; color: #ff3b30;">ç§»é™¤å›¾ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®é¡µé¢çš„ .form-container å†…éƒ¨æœ«å°¾ â–¼â–¼â–¼ -->
<hr style="width: 100%; opacity: 0.2; margin-top: 25px;">
<div class="preset-manager-container">
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);">å¤–è§‚é¢„è®¾</label>
    </div>
    <div class="form-group">
        <select id="char-phone-preset-selector" class="form-group select"></select>
        <div class="preset-manager-controls">
            <!-- ç‹¬å ä¸€è¡Œçš„åº”ç”¨æŒ‰é’® -->
            <button id="apply-char-phone-preset-btn" class="preset-btn-capsule preset-btn-apply" disabled>åº”ç”¨</button>
            
            <!-- 2x2 ç½‘æ ¼æŒ‰é’® -->
            <button id="save-char-phone-preset-btn" class="preset-btn-capsule preset-btn-save">ä¿å­˜</button>
            <button id="update-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>æ›´æ–°</button>
            <button id="rename-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>é‡å‘½å</button>
            <button id="import-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary">å¯¼å…¥</button>
            <button id="export-char-phone-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>å¯¼å‡º</button>
            <button id="delete-char-phone-preset-btn" class="preset-btn-capsule preset-btn-delete" disabled>åˆ é™¤</button>
            
            <input type="file" id="import-char-phone-preset-input" accept=".json" hidden>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLä»£ç ç»“æŸ â–²â–²â–² -->

    </div>
</div>
<!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œç”¨äºå¤„ç†ä¸Šä¼  -->
<input type="file" id="char-phone-wallpaper-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-icon-upload-input" accept="image/*" hidden>

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œæ–°çš„æ–‡ä»¶é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
<input type="file" id="char-phone-widget-1-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-widget-2-upload-input" accept="image/*" hidden>
<input type="file" id="char-phone-app-wallpaper-upload-input" accept="image/*" hidden>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- åŠ è½½åŠ¨ç”»é®ç½©å±‚ (ä¿æŒä¸å˜) -->
<div id="generation-overlay" class="modal" style="background-color: rgba(0,0,0,0.6); z-index: 2000;">
    <div style="text-align: center; color: white;">
        <div id="loading-spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>æ­£åœ¨åŒæ­¥Taçš„æ‰‹æœºæ•°æ®...</p>
        <p style="font-size: 12px; opacity: 0.7;">ï¼ˆè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œå¹¶ä¼šæ¶ˆè€—APIé¢åº¦ï¼‰</p>
    </div>
</div>

<!-- â–²â–²â–² â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½HTMLç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€‰æ‹©è”ç³»äººä»¥åˆ›å»ºç¾¤èŠçš„å±å¹• â–¼â–¼â–¼ -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
        <span>é€‰æ‹©è”ç³»äºº</span>
        <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†å±å¹• â–¼â–¼â–¼ -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">â€¹</span>
        <span>ç¾¤æˆå‘˜ç®¡ç†</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!-- ç°æœ‰æˆå‘˜åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </button>
        <button id="create-new-member-btn">åˆ›å»ºç¾¤å†…æ–°æˆå‘˜</button>
        <button id="ai-generate-members-btn">âœ¨ AI ç”Ÿæˆæˆå‘˜</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ·äººè®¾ä¸èŒä¸šè®¾ç½®æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="weibo-user-settings-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æˆ‘çš„å¾®åšè®¾å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é¢„è®¾æ–¹æ¡ˆ</label>
                <div class="bubble-preset-manager"> <!-- å¤ç”¨ç°æœ‰æ ·å¼ -->
                    <select id="weibo-user-preset-select" class="form-group select"></select>
                    <button id="manage-weibo-user-presets-btn" class="action-btn">ç®¡ç†</button>
                </div>
            </div>
            <div class="form-group">
                <label for="weibo-user-profession-modal-input">èŒä¸š (æ˜¾ç¤ºåœ¨æ˜µç§°ä¸‹æ–¹)</label>
                <input type="text" id="weibo-user-profession-modal-input" placeholder="ä¾‹å¦‚ï¼šèŒä¸šç”µç«é€‰æ‰‹ã€ç¾å¦†åšä¸»">
            </div>
            <div class="form-group">
                <label for="weibo-user-persona-modal-input">éšè—äººè®¾ (ä»…ä¾›AIç”Ÿæˆè¯„è®ºæ—¶å‚è€ƒ)</label>
                <textarea id="weibo-user-persona-modal-input" rows="4" placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘ä¸ç²‰ä¸äº’åŠ¨ï¼Œåªå›å¤èµåŠ©å•†çš„è¯„è®ºã€‚"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-weibo-user-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-weibo-user-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšæ‰‹åŠ¨æ“ä½œçš„å¼¹çª—ï¼Œç²˜è´´åˆ° </body> å‰é¢ â–¼â–¼â–¼ -->
<div id="weibo-action-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="weibo-action-modal-title">æ‰§è¡Œæ“ä½œ</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="weibo-action-actor-select">é€‰æ‹©æ“ä½œè€… (Actor)</label>
                <select id="weibo-action-actor-select" class="form-group select"></select>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æ“ä½œç±»å‹</label>
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼ -->
<div id="weibo-action-type-select" style="text-align: left;">
    <label><input type="radio" name="weibo_action_type" value="post" checked> å‘å¸ƒä¸€æ¡æ–°å¾®åš</label>
    <label><input type="radio" name="weibo_action_type" value="comment_plaza"> è¯„è®ºå¹¿åœºæœ€æ–°å¾®åš</label>
    <!-- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„é€‰é¡¹ â–¼â–¼â–¼ -->
    <label><input type="radio" name="weibo_action_type" value="comment_user"> è¯„è®ºç”¨æˆ·æœ€æ–°å¾®åš</label>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            </div>
             <div class="form-group">
                <label for="weibo-action-prompt-input">å…³äº... (å¯é€‰, ç®€è¦æç¤º)</label>
                <textarea id="weibo-action-prompt-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ¯”èµ›èµ¢äº†å¾ˆå¼€å¿ƒ or å›åº”æœ€è¿‘çš„çƒ­æœ"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-weibo-action-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-weibo-action-btn">æ‰§è¡Œ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬3å¤„ä¿®æ”¹ï¼ˆæ–°å¢HTMLï¼‰ â–¼â–¼â–¼ -->
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #char-sticker-manager-screen â–¼â–¼â–¼ -->
<div id="char-sticker-manager-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-sticker-manager">â€¹</span>
        <span id="sticker-manager-title">è¡¨æƒ…åŒ…ç®¡ç†</span>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ â€œç¼–è¾‘/å®Œæˆâ€æŒ‰é’® -->
        <div class="header-actions">
            <span class="action-btn" id="edit-char-stickers-btn">ç¼–è¾‘</span>
            <span class="action-btn" id="done-char-stickers-btn" style="display: none;">å®Œæˆ</span>
        </div>
    </div>
    <input type="file" id="char-sticker-upload-input" accept="image/*" style="display: none;" multiple>
    <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; flex-grow: 1;">
        <!-- é¡µç­¾åˆ‡æ¢ -->
        <div class="frame-tabs">
            <div id="sticker-tab-exclusive" class="frame-tab active">ä¸“å±è¡¨æƒ…</div>
            <div id="sticker-tab-common" class="frame-tab">é€šç”¨è¡¨æƒ…</div>
        </div>

        <!-- ä¸“å±è¡¨æƒ…å†…å®¹åŒº -->
        <div id="sticker-content-exclusive" class="frame-content active">
            <div class="sticker-panel-header" style="justify-content: flex-end;">
                 <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="add-exclusive-sticker-btn">æ‰¹é‡æ·»åŠ </span>
                    <span class="panel-btn" id="upload-exclusive-sticker-btn">æœ¬åœ°ä¸Šä¼ </span>
                </div>
            </div>
            <div id="exclusive-sticker-grid" class="sticker-grid"></div>
        </div>

        <!-- é€šç”¨è¡¨æƒ…å†…å®¹åŒº -->
        <div id="sticker-content-common" class="frame-content">
             <div class="sticker-panel-header" style="justify-content: flex-end;">
                 <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="add-common-sticker-btn">æ‰¹é‡æ·»åŠ </span>
                    <span class="panel-btn" id="upload-common-sticker-btn">æœ¬åœ°ä¸Šä¼ </span>
                </div>
            </div>
            <div id="common-sticker-grid" class="sticker-grid"></div>
        </div>
    </div>
    <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨åº•éƒ¨æ–°å¢ä¸€ä¸ªç”¨äºæ‰¹é‡åˆ é™¤çš„æ“ä½œæ  -->
    <div id="char-sticker-footer" style="display: none;">
        <button id="delete-selected-char-stickers-btn">åˆ é™¤å·²é€‰ (0)</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">é‚€è¯·ä½ è§†é¢‘é€šè¯</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>æ‹’ç»</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>æ¥å¬</span>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯BGMæœç´¢ç»“æœçš„å¼¹çª—ï¼Œè¯·ç²˜è´´åˆ°bodyæœ«å°¾ â–¼â–¼â–¼ -->
<div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æœç´¢ç»“æœ</span>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0;">
            <!-- æœç´¢ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-music-search-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å…¨æ–°ç¾¤èŠå…¼å®¹ç»“æ„ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ #video-call-screen â–¼â–¼â–¼ -->
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ–‡ä»¶ä¸­æ—§çš„ #video-call-screen åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="video-call-screen" class="screen">
    <!-- è¿™ä¸ª screen åŒæ—¶ä¸ºä¸¤ç§æ¨¡å¼æœåŠ¡ -->

    <!-- ======================================================= -->
    <!-- æ¨¡å¼ä¸€ï¼šå…¨æ–°çš„ã€å¯è§†åŒ–ã€‘è§†é¢‘é€šè¯ç•Œé¢ -->
    <!-- ======================================================= -->
    <div id="visual-call-interface" style="display: none;"> <!-- é»˜è®¤éšè— -->
        <!-- 1. è§†é¢‘èƒŒæ™¯å±‚ (å¤§å›¾å’Œå°å›¾éƒ½åœ¨è¿™é‡Œ) -->
        <div class="video-background">
            <!-- å¤§å›¾å®¹å™¨ -->
            <div id="video-main-view" class="video-container">
                <img src="" alt="ä¸»è§†é¢‘ç”»é¢">
            </div>
            <!-- å°å›¾å®¹å™¨ (ç”»ä¸­ç”») -->
            <div id="video-pip-view" class="video-container pip">
                <img src="" alt="å°çª—è§†é¢‘ç”»é¢">
            </div>
        </div>

        <!-- 2. é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="video-call-top-bar">
            <span id="visual-call-timer">00:00</span>
        </div>

        <!-- 3. èŠå¤©æ°”æ³¡æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="video-call-messages-visual" class="video-call-main">
            <!-- èŠå¤©æ°”æ³¡ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ id="visual-call-interface" é‡Œé¢é‚£ä¸ªæ—§çš„ video-call-controls çš„ div â–¼â–¼â–¼ -->
<div class="video-call-controls">
    <!-- é‡-rollæŒ‰é’® -->
    <button id="reroll-call-btn" class="control-btn reroll-btn" title="é‡æ–°ç”Ÿæˆ"></button>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘å‘è¨€æŒ‰é’® -->
    <button id="user-speak-btn-visual" class="control-btn speak-btn" title="å‘è¨€"></button>
    <!-- åˆ‡æ¢é•œå¤´æŒ‰é’® -->
    <button id="switch-camera-btn" class="control-btn switch-camera-btn" title="åˆ‡æ¢é•œå¤´"></button>
    <!-- æŒ‚æ–­æŒ‰é’® -->
    <button id="hang-up-btn-visual" class="control-btn hangup-btn"></button>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    </div>

    <!-- ======================================================= -->
    <!-- æ¨¡å¼äºŒï¼šä½ åŸæ¥çš„ã€çº¯æ–‡å­—ã€‘è¯­éŸ³é€šè¯ç•Œé¢ (æˆ‘ä»¬æŠŠå®ƒä¿ç•™ä¸‹æ¥ä½œä¸ºé»˜è®¤é€‰é¡¹) -->
    <!-- ======================================================= -->
    <div id="text-call-interface" style="display: none;"> <!-- é»˜è®¤éšè— -->
        <div class="video-call-top-bar">
            <span id="call-timer">00:00</span>
        </div>
        <div class="video-call-avatar-area">
            <div id="participant-avatars-grid">
                <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå¤´åƒ -->
            </div>
        </div>
        <div id="video-call-main" class="video-call-main">
            <!-- å¯¹è¯å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="video-call-controls">
            <!-- ã€æ–°å¢ã€‘ä¸ºæ—§æ¨¡å¼ä¹ŸåŠ ä¸Šé‡rollæŒ‰é’® -->
            <button id="reroll-call-btn-text" class="control-btn reroll-btn" title="é‡æ–°ç”Ÿæˆ"></button>
            <button id="user-speak-btn" class="control-btn speak-btn"></button>
            <button id="hang-up-btn" class="control-btn hangup-btn"></button>
            <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢ â–¼â–¼â–¼ -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ â–¼â–¼â–¼ -->
<div id="call-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="call-history-back-btn">â€¹</span>
        <span id="call-history-title">é€šè¯è®°å½•</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
    </div>
    <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- é€šè¯è®°å½•å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯èŠå¤©è®°å½•æœç´¢ç•Œé¢ï¼Œè¯·ç²˜è´´åˆ° call-history-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="chat-search-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="search-back-btn">â€¹</span>
        <span>æŸ¥æ‰¾èŠå¤©è®°å½•</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ -->
    </div>
    <div class="form-container" style="padding-bottom: 0;">
        <!-- æœç´¢æ¡ä»¶è¾“å…¥åŒº -->
        <div class="form-group">
            <label for="keyword-search-input">å…³é”®è¯</label>
            <input type="text" id="keyword-search-input" placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„å…³é”®è¯...">
        </div>
        <div class="form-group">
            <label for="sender-search-select">äººç‰©</label>
            <select id="sender-search-select">
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
        </div>
        <div class="form-group">
            <label for="date-search-input">æ—¥æœŸ</label>
            <input type="date" id="date-search-input">
        </div>
        <button class="form-button" id="perform-search-btn">å¼€å§‹æŸ¥æ‰¾</button>
        
        <!-- æœç´¢ç»“æœæ˜¾ç¤ºåŒº -->
        <div id="chat-search-results-list" class="list-container" style="margin-top: 15px; padding: 0;">
            <!-- æœç´¢ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->


            <!-- â–¼â–¼â–¼ è¯·å°†ä¸‹é¢è¿™æ•´å—ã€å…¨æ–°çš„HTMLä»£ç ã€‘ç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼ -->
            <div id="lock-screen" class="screen">
                <div id="lock-clock-container">
                    <div id="lock-main-time">12:00</div>
                    <div id="lock-main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div>
                </div>
                <div id="unlock-hint">å‘ä¸Šè½»æ‰«ä»¥è§£é”</div>
            </div>

            <div id="password-modal-overlay" class="modal">
                <div class="password-modal-content">
                    <p>è¯·è¾“å…¥å¯†ç </p>
                    <input type="password" id="password-input-field" maxlength="20">
                    <div class="password-actions">
                        <button id="password-cancel-btn">å–æ¶ˆ</button>
                        <button id="password-confirm-btn">è¿›å…¥</button>
                    </div>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°HTMLä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

        </div>
    </div>
  <!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ â–¼â–¼â–¼ -->
<div id="lovers-space-screen" class="screen">
    <!-- å¤´éƒ¨ -->
    <div id="ls-header">
        <div class="ls-header-overlay"></div>
        <div class="ls-header-top-bar">
            <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
            <span id="ls-char-name"></span>
            <div class="header-actions">
                <span class="action-btn" id="ls-settings-btn" title="ç©ºé—´è®¾ç½®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </span>
                <span class="action-btn" id="ls-change-bg-btn" title="æ›´æ¢èƒŒæ™¯">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </span>
                <span class="action-btn" id="ls-switch-char-btn">åˆ‡æ¢</span>
            </div>
        </div>
        <div class="ls-avatar-and-counter-wrapper">
            <div class="ls-header-avatars">
                <img id="ls-user-avatar" src="">
                <span class="heart-icon">â¤</span>
                <img id="ls-char-avatar" src="">
            </div>
            <div id="ls-days-counter"></div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€SVGå›¾æ ‡ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ ls-tab-bar â–¼â–¼â–¼ -->
<div id="ls-tab-bar">
    <div class="ls-tab-item active" data-view="ls-moments-view" title="è¯´è¯´">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-album-view" title="ç›¸å†Œ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-letters-view" title="æƒ…ä¹¦">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-shares-view" title="åˆ†äº«">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-questions-view" title="æé—®">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-diary-view" title="æ—¥è®°">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
    </div>
    <div class="ls-tab-item" data-view="ls-pomodoro-view" title="ç•ªèŒ„é’Ÿ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
</div>
<!-- â–²â–²â–² HTMLæ›¿æ¢ç»“æŸ â–²â–²â–² -->
    <!-- å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="ls-content-area">
        <div id="ls-moments-view" class="ls-view active"><div id="ls-moments-list"></div><button id="ls-add-moment-btn" class="ls-fab-btn">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    </svg>
</button>
</div>
        <div id="ls-album-view" class="ls-view">
    <div id="ls-album-list"></div>
    <button id="ls-add-album-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <div id="ls-letters-view" class="ls-view">
    <div id="ls-letters-list"></div>
    <button id="ls-add-letter-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <div id="ls-shares-view" class="ls-view"><div id="ls-shares-list"></div></div>
     <div id="ls-questions-view" class="ls-view">
    <div id="ls-questions-list"></div>
    <button id="ls-add-question-btn" class="ls-fab-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </button>
</div>

        <!-- â–¼â–¼â–¼ åœ¨ id="ls-questions-view" çš„ div ä¹‹åï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼ -->
<div id="ls-diary-view" class="ls-view">
    <!-- æ—¥å†å’Œå¿ƒæƒ…ç½å­çš„å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
        <!-- â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºç•ªèŒ„é’Ÿå‡†å¤‡çš„å…¨æ–°ç•Œé¢ â˜…â˜…â˜… -->
        <div id="ls-pomodoro-view" class="ls-view">
            <!-- ç•ªèŒ„é’Ÿä¸»é¡µï¼Œæ˜¾ç¤ºå†å²è®°å½•å’Œå¼€å§‹æŒ‰é’® -->
            <div id="ls-pomodoro-home">
                <div id="ls-pomodoro-start-btn-container">
                    <div id="ls-pomodoro-start-icon">ï¼‹</div>
                    <p>å¼€å¯æ–°çš„ä¸“æ³¨æ—¶å…‰</p>
                </div>
                <div id="ls-pomodoro-history-list">
                    <!-- å†å²è®°å½•ä¼šç”±JSç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <!-- æ­£åœ¨è®¡æ—¶çš„ç•Œé¢ï¼Œé»˜è®¤éšè— -->
            <div id="ls-pomodoro-timer-active" style="display: none;">
                <div class="pomodoro-char-avatar-container">
                    <img id="pomodoro-char-avatar" src="">
                    <div id="pomodoro-char-log"></div>
                </div>
                <div class="pomodoro-timer-display">
                    <div id="pomodoro-current-task"></div>
                    <div id="pomodoro-time">25:00</div>
                </div>
                <button id="pomodoro-end-btn">ç»“æŸä¸“æ³¨</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div>

    <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œå¤‡æ³¨åâ€è¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!-- é»˜è®¤éšè—ï¼Œåªå¯¹å•èŠæ˜¾ç¤º -->
        <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- åˆ†ç»„é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†ç»„</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šè®¾ç½® (æŒä¹…åŒ–é“¾æ¥ç‰ˆ) â–¼â–¼â–¼ -->
<div class="form-group" id="memory-link-group">
    <label>è®°å¿†äº’é€š (é€‰æ‹©è¦é“¾æ¥çš„èŠå¤©)</label>
    
    <!-- å¤ç”¨ä¸–ç•Œä¹¦çš„å¤šé€‰æ¡†æ ·å¼ -->
    <div class="custom-multiselect" id="memory-link-multiselect">
        <div class="select-box">
            <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
            <span class="arrow-down">â–¼</span>
        </div>
        <div id="memory-link-checkboxes-container" class="checkboxes-container">
            <!-- èŠå¤©é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
    
    <!-- æ–°å¢ï¼šè®°å¿†æ¡æ•°è®¾ç½® -->
    <div class="form-group" style="margin-top: 10px;">
        <label for="link-memory-depth-input" style="font-weight: normal; color: var(--text-secondary); font-size: 13px;">äº’é€šè®°å¿†æ¡æ•° (AIä¼šçœ‹åˆ°å¯¹æ–¹æœ€è¿‘çš„å‡ æ¡æ¶ˆæ¯)</label>
        <input type="number" id="link-memory-depth-input" value="5" min="1" max="20" style="padding: 8px;">
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° <div id="chat-settings-modal"> çš„ <div class="modal-body"> å†…éƒ¨ï¼Œä¾‹å¦‚â€œèŠå¤©èƒŒæ™¯â€è®¾ç½®çš„ä¸Šæ–¹ â–¼â–¼â–¼ -->

<hr style="opacity: 0.2; margin: 20px 0;">

<!-- 1. çº¿ä¸‹æ¨¡å¼æ€»å¼€å…³ -->
<div class="form-group" id="offline-mode-section">
    <label for="offline-mode-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">
            å¼€å¯çº¿ä¸‹æ¨¡å¼
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å¼€å¯åï¼ŒAIå°†é»˜è®¤ä½ ä»¬åœ¨çº¿ä¸‹è§é¢ï¼Œå¹¶ä»¥å¤§æ®µå™äº‹çš„æ–¹å¼è¿›è¡Œå›åº”ã€‚
            </p>
        </span>
        <input type="checkbox" id="offline-mode-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>

<!-- 2. çº¿ä¸‹æ¨¡å¼çš„è¯¦ç»†è®¾ç½® (é»˜è®¤éšè—) -->
<div id="offline-mode-details" style="display: none; padding-left: 10px; border-left: 3px solid var(--accent-color); margin-top: 15px;">
    
    <!-- 2.1 é¢„è®¾ç®¡ç† -->
    <div class="form-group">
        <label>çº¿ä¸‹æ¨¡å¼é¢„è®¾</label>
        <div class="bubble-preset-manager">
            <select id="offline-preset-select" class="form-group select"></select>
            <button id="manage-offline-presets-btn" class="action-btn">ç®¡ç†</button>
        </div>
    </div>
    
    <!-- 2.2 æç¤ºè¯è¾“å…¥ -->
    <div class="form-group">
        <label for="offline-prompt-input">è‡ªå®šä¹‰æç¤ºè¯ (Prompt)</label>
        <textarea id="offline-prompt-input" rows="4" placeholder="ä¾‹å¦‚ï¼šä½ æ­£åœ¨ä¸€å®¶å®‰é™çš„å’–å•¡é¦†é‡Œå’Œç”¨æˆ·çº¦ä¼š..."></textarea>
    </div>
    
    <!-- 2.3 æ–‡é£è¾“å…¥ -->
    <div class="form-group">
        <label for="offline-style-input">è‡ªå®šä¹‰æ–‡é£ (Style)</label>
        <textarea id="offline-style-input" rows="3" placeholder="ä¾‹å¦‚ï¼šè¯·ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼Œè¯¦ç»†æå†™è§’è‰²çš„åŠ¨ä½œã€ç¥æ€å’Œå¿ƒç†æ´»åŠ¨..."></textarea>
    </div>

    <!-- 2.4 å­—æ•°è®¾ç½® -->
    <div class="form-group">
        <label for="offline-word-count-input">æœŸæœ›å›å¤å­—æ•°</label>
        <input type="number" id="offline-word-count-input" value="300" min="50" step="50">
    </div>

</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ€»ç»“è®¾ç½®åŒºåŸŸ â–¼â–¼â–¼ -->
<hr style="opacity: 0.2; margin: 20px 0;">

<div class="form-group">
    <label for="summary-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">
            å¼€å¯èŠå¤©æ€»ç»“
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å¼€å¯åï¼ŒAIä¼šåœ¨å¯¹è¯è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶è‡ªåŠ¨æˆ–æ‰‹åŠ¨è¿›è¡Œæ€»ç»“ï¼Œä½œä¸ºé•¿æœŸè®°å¿†ã€‚
            </p>
        </span>
        <input type="checkbox" id="summary-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
</div>

<div id="summary-details-container" style="display: none; padding-left: 10px; border-left: 3px solid var(--accent-color); margin-top: 15px;">
    <div class="form-group">
        <label>æ€»ç»“æ¨¡å¼</label>
        <div style="display: flex; gap: 20px;">
            <label><input type="radio" name="summary-mode" value="auto" checked> è‡ªåŠ¨æ€»ç»“</label>
            <label><input type="radio" name="summary-mode" value="manual"> æ‰‹åŠ¨æ€»ç»“</label>
        </div>
    </div>
    <div class="form-group">
        <label for="summary-count-input">è§¦å‘æ¶ˆæ¯æ¡æ•°</label>
        <input type="number" id="summary-count-input" value="20" min="5">
    </div>
    <div class="form-group">
        <label for="summary-prompt-input">æ€»ç»“æç¤ºè¯ (Prompt)</label>
        <textarea id="summary-prompt-input" rows="4"></textarea>
    </div>
    <button id="view-summaries-btn" class="form-button form-button-secondary" style="margin-top: 10px;">æŸ¥çœ‹å’Œç®¡ç†æ€»ç»“</button>
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°æŒ‰é’® â–¼â–¼â–¼ -->
    <button id="manual-summary-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ç«‹å³æ‰‹åŠ¨æ€»ç»“</button>
    <!-- â–²â–²â–² æ–°æŒ‰é’®ç²˜è´´ç»“æŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ id="summary-details-container" çš„ </div> ä¹‹åç²˜è´´ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label style="margin-bottom: 0;">å½“å‰æ€»èŠå¤©æ¡æ•°</label>
    <span id="total-message-count-display" style="color: var(--text-secondary); font-weight: 500;">--</span>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label style="margin-bottom: 0;">
        ä¸Šä¸‹æ–‡Tokenæ•°
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            (æç¤ºè¯ + ä¸Šä¸‹æ–‡è®°å¿†)
        </p>
    </label>
    <span id="context-token-count-display" style="color: var(--text-secondary); font-weight: 500;">--</span>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–²â–²â–² æ–°å¢HTMLä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
              <!-- â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬2å¤„ä¿®æ”¹ï¼ˆæ–°å¢HTMLï¼‰ â–¼â–¼â–¼ -->
            <div class="form-group" id="char-sticker-group">
                <button id="manage-char-stickers-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 5px;">
                    ç®¡ç†è§’è‰²è¡¨æƒ…åŒ…
                </button>
            </div>
            <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="npc-library-group">
    <button id="manage-npcs-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 5px;">ç®¡ç†NPCåº“</button>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="minimax-voice-id-group">
    <label for="minimax-voice-id-input">Minimax è¯­éŸ³ID</label>
    <input type="text" id="minimax-voice-id-input" placeholder="ä¾‹å¦‚ï¼šmale-01">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
 <!-- ã€å…¨æ–°ã€‘å¾®åšäººè®¾ä¸èŒä¸šè®¾ç½® -->
<div id="weibo-settings-for-user" style="display: none;">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <div class="form-group">
        <label>æˆ‘çš„å¾®åšè®¾å®š</label>
        <div class="bubble-preset-manager">
            <select id="weibo-persona-preset-select" class="form-group select"></select>
            <button id="manage-weibo-presets-btn" class="action-btn">ç®¡ç†</button>
        </div>
    </div>
    <div class="form-group">
        <label for="weibo-user-profession-input">èŒä¸š (æ˜¾ç¤ºåœ¨æ˜µç§°ä¸‹æ–¹)</label>
        <input type="text" id="weibo-user-profession-input" placeholder="ä¾‹å¦‚ï¼šèŒä¸šç”µç«é€‰æ‰‹ã€ç¾å¦†åšä¸»">
    </div>
    <div class="form-group">
        <label for="weibo-user-persona-input">éšè—äººè®¾ (ä»…ä¾›AIå‚è€ƒ)</label>
        <textarea id="weibo-user-persona-input" rows="3" placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘ä¸ç²‰ä¸äº’åŠ¨ï¼Œåªå›å¤èµåŠ©å•†çš„è¯„è®ºã€‚"></textarea>
    </div>
</div>
<!-- ã€å…¨æ–°ã€‘å¾®åšè®¾ç½®ç»“æŸ -->
 <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="weibo-profession-group">
    <label for="weibo-profession-input">å¾®åšèŒä¸š</label>
    <input type="text" id="weibo-profession-input" placeholder="ä¾‹å¦‚ï¼šèŒä¸šç”µç«é€‰æ‰‹ã€ç¾å¦†åšä¸»ã€æ¼”å‘˜...">
</div>
<div class="form-group" id="weibo-instruction-group">
    <label for="weibo-instruction-input">å¾®åšæŒ‡ä»¤ (AIå‘å¾®åš/è¯„è®ºæ—¶å°†ä¸¥æ ¼éµå®ˆ)</label>
    <textarea id="weibo-instruction-input" rows="3" placeholder="ä¾‹å¦‚ï¼šå¤šå‘æ—¥å¸¸è®­ç»ƒå’Œæ¯”èµ›çš„å†…å®¹ï¼Œæ€§æ ¼é«˜å†·ï¼Œå°‘ä¸ç²‰ä¸äº’åŠ¨ï¼Œåªå›å¤èµåŠ©å•†çš„è¯„è®ºã€‚"></textarea>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°â€œç®¡ç†NPCåº“â€æŒ‰é’®çš„ div ä¹‹å â–¼â–¼â–¼ -->
<hr style="opacity: 0.2; margin: 20px 0;">
<div class="form-group">
    <label for="time-perception-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">å¯ç”¨å®æ—¶æ—¶é—´æ„ŸçŸ¥</span>
        <input type="checkbox" id="time-perception-toggle" checked>
        <span class="toggle-switch-slider"></span>
    </label>
</div>
<div id="custom-time-container" class="form-group" style="display: none;">
    <label for="custom-time-input">è‡ªå®šä¹‰æ—¶é—´</label>
    <input type="datetime-local" id="custom-time-input" style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label>
  <!-- â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œç²˜è´´åˆ° id="ai-avatar-group" çš„é‚£ä¸ª div ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group" id="video-call-settings-group">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <label>è§†é¢‘é€šè¯ç•Œé¢è®¾ç½®</label>
    
    <!-- 1. åŠŸèƒ½å¼€å…³ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span>å¯ç”¨å¯è§†åŒ–ç•Œé¢</span>
        <label class="toggle-switch">
            <input type="checkbox" id="visual-video-call-switch">
            <span class="slider"></span>
        </label>
    </div>

    <!-- 2. å›¾ç‰‡ä¸Šä¼ åŒº (é»˜è®¤éšè—) -->
    <div id="video-call-image-uploads" style="display: none;">
        <div class="form-group">
            <label>å¯¹æ–¹çš„è§†é¢‘ç”»é¢</label>
            <div class="avatar-upload">
                <img id="char-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('char-video-image-input').click()">ä¸Šä¼ å›¾ç‰‡</button>
                <input type="file" id="char-video-image-input" accept="image/*" hidden>
            </div>
        </div>
        <div class="form-group">
            <label>æˆ‘çš„è§†é¢‘ç”»é¢</label>
            <div class="avatar-upload">
                <img id="user-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('user-video-image-input').click()">ä¸Šä¼ å›¾ç‰‡</button>
                <input type="file" id="user-video-image-input" accept="image/*" hidden>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

  <div class="avatar-upload">
    <img id="ai-avatar-preview">
    <button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button>
    <button class="change-frame-btn" data-type="ai">æ›´æ¢å¤´åƒæ¡†</button>
    <button id="manage-ai-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button>
    <input type="file" id="ai-avatar-input" accept="image/*">
</div>
</div>
<!-- â–¼â–¼â–¼ æ­¥éª¤1ï¼šåœ¨è¿™é‡Œç²˜è´´æƒ…ä¾£å¤´åƒåŠŸèƒ½çš„æ–°HTMLä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="couple-avatar-group">
    <label for="couple-avatar-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">æƒ…ä¾£å¤´åƒå¼€å…³</span>
        <input type="checkbox" id="couple-avatar-toggle">
        <span class="toggle-switch-slider"></span>
    </label>
    <div id="couple-avatar-desc-container" style="display: none; margin-top: 10px;">
         <label for="couple-avatar-description" style="font-size: 13px; color: var(--text-secondary);">æƒ…ä¾£å¤´åƒæè¿° (å¯é€‰)</label>
         <input type="text" id="couple-avatar-description" placeholder="ä¾‹å¦‚ï¼šä¸€åªå°çŒ«åœ¨çœ‹æœˆäº®">
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button>
<button class="change-frame-btn" data-type="my">æ›´æ¢å¤´åƒæ¡†</button> <!-- â† åŠ å›è¿™ä¸€è¡Œ -->
<button id="open-persona-library-btn">é¢„è®¾</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label><div id="group-members-settings"></div>


    <!-- ã€æ–°å¢ã€‘ç®¡ç†æˆå‘˜æŒ‰é’® -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå‘˜</button></div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠåå°æ´»åŠ¨è®¾ç½® â–¼â–¼â–¼ -->
<div class="form-group" id="group-background-activity-group" style="display: none;">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <label class="toggle-switch-label">
        <span class="toggle-switch-text">
            ç¾¤èŠåå°å®æ—¶æ´»åŠ¨
            <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
                è­¦å‘Šï¼šå¼€å¯åä¼šå¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨ï¼
            </p>
        </span>
        <input type="checkbox" id="group-background-activity-switch">
        <span class="toggle-switch-slider"></span>
    </label>

    <div id="group-background-interval-settings" style="display: none; margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label for="group-background-interval-input" style="margin-bottom: 0;">
                æ´»åŠ¨é—´éš”æœŸ (ç§’)
                <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                    å»ºè®®å€¼ 120-600ã€‚å€¼è¶Šå¤§ï¼Œè´¹ç”¨è¶Šä½ï¼Œä½†ç¾¤å†…äº’åŠ¨è¶Šæ…¢ã€‚
                </p>
            </label>
            <input type="number" id="group-background-interval-input" min="60" value="120" style="width: 80px; text-align: center;">
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ç»­ç«èŠ±è®¾ç½®åŒº â–¼â–¼â–¼ -->
<div class="form-group" id="streak-settings-section">
    <!-- ç«èŠ±æ€»å¼€å…³ -->
    <label for="streak-enabled-toggle" class="toggle-switch-label">
        <span class="toggle-switch-text">
            å¼€å¯ç»­ç«èŠ±
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å¼€å¯åï¼Œæ¯å¤©å’ŒTaäº’åŠ¨å³å¯å»¶ç»­ç«èŠ±ã€‚
            </p>
        </span>
        <input type="checkbox" id="streak-enabled-toggle">
        <span class="toggle-switch-slider"></span>
    </label>

    <!-- ç«èŠ±è¯¦ç»†è®¾ç½® (é»˜è®¤éšè—) -->
    <div id="streak-details-container" style="display: none; margin-top: 15px; padding-left: 10px; border-left: 3px solid var(--accent-color);">
        <!-- ã€å…¨æ–°ã€‘åˆå§‹å¤©æ•°è¾“å…¥æ¡† -->
        <div class="form-group">
            <label for="streak-initial-days-input">åˆå§‹ç«èŠ±å¤©æ•°</label>
            <input type="number" id="streak-initial-days-input" value="0" min="0">
        </div>

        <!-- ã€å·²ä¿®æ”¹ã€‘ç†„ç­è§„åˆ™é€‰æ‹©å™¨ -->
        <div class="form-group">
            <label for="streak-extinguish-threshold-select">ç«èŠ±ç†„ç­è§„åˆ™</label>
            <select id="streak-extinguish-threshold-select">
                <option value="1">1å¤©ä¸è”ç³»åˆ™ç†„ç­</option>
                <option value="3">3å¤©ä¸è”ç³»åˆ™ç†„ç­</option>
                <option value="7">7å¤©ä¸è”ç³»åˆ™ç†„ç­</option>
                <option value="-1">æ°¸ä¸ç†„ç­ ğŸ”¥</option>
            </select>
        </div>
        <!-- â–¼â–¼â–¼ åœ¨ id="streak-details-container" çš„ </div> é—­åˆæ ‡ç­¾å‰ï¼Œç²˜è´´ä¸‹é¢è¿™è¡Œ â–¼â–¼â–¼ -->
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<!-- ã€å…¨æ–°ã€‘è‡ªå®šä¹‰ç«èŠ±å›¾æ ‡å’Œé¢œè‰² -->
<div class="form-group">
    <label for="streak-lit-icon-url">ç‚¹äº®çš„ç«èŠ±å›¾ç‰‡ URL (å¯é€‰)</label>
    <input type="text" id="streak-lit-icon-url" placeholder="ç•™ç©ºåˆ™é»˜è®¤æ˜¾ç¤ºğŸ”¥">
</div>
<div class="form-group">
    <label for="streak-extinguished-icon-url">ç†„ç­çš„ç«èŠ±å›¾ç‰‡ URL (å¯é€‰)</label>
    <input type="text" id="streak-extinguished-icon-url" placeholder="ç•™ç©ºåˆ™é»˜è®¤æ˜¾ç¤ºğŸ§Š">
</div>
<div class="form-group">
    <label for="streak-font-color-picker">å¤©æ•°å­—ä½“é¢œè‰² (å¯é€‰)</label>
    <input type="color" id="streak-font-color-picker" value="#ff6f00" style="width: 100%; height: 40px;">
</div>
<!-- â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label><label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label><label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label><label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label></div></div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©æ°”æ³¡ä¸»é¢˜â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡æ ·å¼é¢„è®¾é€‰æ‹©å™¨ (å·²æ·»åŠ å¯¼å…¥å¯¼å‡ºåŠŸèƒ½) â–¼â–¼â–¼ -->
<div class="form-group">
    <label>æ°”æ³¡æ ·å¼é¢„è®¾</label>
    <div class="bubble-preset-manager">
        <select id="bubble-style-preset-select" class="form-group select"></select>
        <button id="manage-bubble-presets-btn" class="action-btn">ç®¡ç†</button>
    </div>
    <!-- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„å¯¼å…¥å’Œå¯¼å‡ºæŒ‰é’® â–¼â–¼â–¼ -->
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="export-bubble-preset-btn" class="form-button form-button-secondary" style="flex:1; margin:0;">å¯¼å‡ºæ°”æ³¡</button>
        <button id="import-bubble-preset-btn" class="form-button form-button-secondary" style="flex:1; margin:0;">å¯¼å…¥æ°”æ³¡</button>
    </div>
    <input type="file" id="import-bubble-preset-input" accept=".json" style="display: none;">
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©å­—ä½“å¤§å°â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="custom-css-input">
        è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯å’Œé˜´å½± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°è‡ªå®šä¹‰CSSè¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å®æ—¶é¢„è§ˆ</label>
    <div id="settings-preview-area">
        <!-- JSä¼šåœ¨è¿™é‡Œç”Ÿæˆé¢„è§ˆå†…å®¹ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°ä½ åˆšåˆšåˆ é™¤ä»£ç çš„ä½ç½® â–¼â–¼â–¼ -->

<!-- è®°å½•ç®¡ç†åŒº -->
<div class="form-group" style="display: flex; gap: 10px;">
    <button class="form-button form-button-secondary" id="import-chat-history-btn" style="flex: 1; margin: 0;">å¯¼å…¥èŠå¤©è®°å½•</button>
    <button class="form-button form-button-secondary" id="export-chat-history-btn" style="flex: 1; margin: 0;">å¯¼å‡ºèŠå¤©è®°å½•</button>
</div>
<input type="file" id="import-chat-history-input" accept="application/json" style="display: none;">
<button class="form-button form-button-secondary" id="search-chat-btn">æŸ¥æ‰¾èŠå¤©è®°å½•</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button>
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å¯¹æ–¹</button>

<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

</div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>
    
<!-- â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼ -->
<div id="persona-editor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span>
        </div>
        <div class="modal-body">
            <!-- ã€æ–°å¢ã€‘NPCåå­—è¾“å…¥æ¡† -->
            <div class="form-group" id="npc-editor-name-group">
                <label for="npc-editor-name-input">NPC åå­—</label>
                <input type="text" id="npc-editor-name-input">
            </div>
            <div class="form-group">
                <label>å¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="preset-avatar-preview">
                    <button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
                    <!-- ã€æ–°å¢ã€‘ç»™è¿™ä¸ªæŒ‰é’®ä¸€ä¸ªIDï¼Œæ–¹ä¾¿æˆ‘ä»¬æ§åˆ¶å®ƒ -->
                    <button id="persona-editor-change-frame-btn" class="change-frame-btn" data-type="member">æ›´æ¢å¤´åƒæ¡†</button>
                    <input type="file" id="preset-avatar-input" accept="image/*">
                </div>
            </div>
            <div class="form-group">
                <label for="preset-persona-input">äººè®¾</label>
                <textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-persona-preset-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² -->



    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„å¤´åƒä¸Šä¼ åŒºåŸŸ â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å¤´åƒ</label>
    <div class="avatar-upload">
        <img id="member-avatar-preview">
        <button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
        <!-- â˜…â˜…â˜… æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªæ›´æ¢å¤´åƒæ¡†çš„æŒ‰é’® â˜…â˜…â˜… -->
        <button id="member-editor-change-frame-btn" class="change-frame-btn">æ›´æ¢å¤´åƒæ¡†</button>
        <input type="file" id="member-avatar-input" accept="image/*" hidden>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>


    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999999999999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

    <audio id="audio-player" style="display:none;"></audio>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œæ–°çš„éŸ³é¢‘å…ƒç´  â–¼â–¼â–¼ -->
<audio id="tts-audio-player" style="display:none;"></audio>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
<audio id="ringtone-player" loop></audio>
<audio id="notification-sound-player" preload="auto"></audio>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—å®Œæ•´ä»£ç ã€‘æ›¿æ¢æ‰ä½ æ—§çš„ id="create-post-modal" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span id="create-post-modal-title">å‘å¸ƒåŠ¨æ€</span> <!-- ä½¿ç”¨IDæ–¹ä¾¿JSä¿®æ”¹æ ‡é¢˜ -->
        </div>
        <div class="modal-body">
            <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹..."></textarea>
            </div>

            <!-- === ã€æ–°å¢ã€‘æ¨¡å¼åˆ‡æ¢å¼€å…³ === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
            </div>

            <!-- === ã€æ–°å¢ã€‘å›¾ç‰‡æ¨¡å¼åŒºåŸŸ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
                    <div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        <button id="post-remove-image-btn">Ã—</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šä¼ </button>
                        <button id="post-use-url-btn" class="form-button-secondary">ç½‘ç»œURL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <!-- è¿™ä¸ªæ˜¯ç»™AIçœ‹çš„å›¾ç‰‡æè¿°ï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘ä»¬ä¼šç”¨JSéšè—å®ƒ -->
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>å›¾ç‰‡æè¿° (å¿…å¡«ï¼Œç»™AIçœ‹)</label>
                    <input type="text" id="post-image-description" placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹ï¼Œå¸®åŠ©AIç†è§£">
                </div>
            </div>

            <!-- === ã€æ–°å¢ã€‘æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°ï¼Œç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."></textarea>
                </div>
            </div>

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="post-visibility-group">
    <label>å¯è§èŒƒå›´</label>
    <div style="display: flex; gap: 20px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="all" checked> æ‰€æœ‰äººå¯è§</label>
        <label><input type="radio" name="visibility" value="groups"> ä»…åˆ†ç»„å¯è§</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background-color: #f0f2f5; padding: 10px; border-radius: 8px;">
        <!-- åˆ†ç»„çš„å¤šé€‰æ¡†ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
            <!-- è¿™ä¸ªæ˜¯åŠ¨æ€åŠŸèƒ½çš„è¯„è®ºå¼€å…³ï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘ä»¬ä¼šç”¨JSéšè—å®ƒ -->
            <div class="form-group" id="post-comments-toggle-group" style="margin-top: 15px;">
                <label for="post-comments-toggle" class="toggle-switch-label">
                    <span class="toggle-switch-text">å…è®¸è§’è‰²çœ‹è§è¯„è®ºåŒº</span>
                    <input type="checkbox" id="post-comments-toggle" checked>
                    <span class="toggle-switch-slider"></span>
                </label>
            </div>
            
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°çš„æ¨¡æ€æ¡†HTMLç²˜è´´åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ä¹‹å â–¼â–¼â–¼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç»„</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="è¾“å…¥åˆ†ç»„å..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- æ–°çš„æ“ä½œæŒ‰é’® -->
            <button id="edit-message-btn">ç¼–è¾‘æ¶ˆæ¯</button>
            <button id="copy-message-btn">å¤åˆ¶æ–‡æœ¬</button>
            <button id="recall-message-btn">æ’¤å›</button>
<button id="quote-message-btn">å¼•ç”¨</button>
            <button id="select-message-btn">è¿›å…¥å¤šé€‰</button>
            <!-- å–æ¶ˆæŒ‰é’® -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
            <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>           
            <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- ç¼–è¾‘å™¨å®¹å™¨ï¼ŒJSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
            <div id="message-editor-container"></div>
            <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>å‘èµ·å¤–å–ä»£ä»˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">å•†å“ä¿¡æ¯</label>
                <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¨æç”˜éœ²">
            </div>
            <div class="form-group">
                <label for="waimai-amount">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
                <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="waimai-confirm-btn">å‘èµ·è¯·æ±‚</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºçº¦å®š/å€’è®¡æ—¶æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°å»ºçº¦å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">çº¦å®šæ ‡é¢˜</label>
                <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">çº¦å®šæ—¥æœŸä¸æ—¶é—´</label>
                <input type="datetime-local" id="countdown-date-input"style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-countdown-btn">ä¿å­˜çº¦å®š</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‘çº¢åŒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘çº¢åŒ…</span>
        </div>
        <div class="modal-body" style="padding: 0;">
<!-- 1. é¡µç­¾åˆ‡æ¢ -->
<div class="frame-tabs">
    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
    <div id="rp-tab-direct" class="frame-tab">ä¸“å±çº¢åŒ…</div>
</div>

            <!-- 2. æ‹¼æ‰‹æ°”çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>æ€»é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>çº¢åŒ…ä¸ªæ•°</label>
                    <input type="number" id="rp-group-count" placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-group-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-group-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>

            <!-- 3. ä¸“å±çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>å‘é€ç»™</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-direct-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">çš„çº¢åŒ…</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- é¢†å–è¯¦æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘èµ·æŠ•ç¥¨</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">æŠ•ç¥¨é—®é¢˜</label>
                <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘ä»¬çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>æŠ•ç¥¨é€‰é¡¹ (è‡³å°‘2é¡¹)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€‰é¡¹</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-poll-btn">å‘èµ·æŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">å¯¹æ–¹çš„å¤´åƒåº“</span>
            <button id="add-ai-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>åˆ†äº«é“¾æ¥</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input">æ ‡é¢˜</label>
                <input type="text" id="link-title-input" placeholder="è¾“å…¥æ–‡ç« æˆ–é“¾æ¥çš„æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label for="link-description-input">æ‘˜è¦ (å¯é€‰)</label>
                <textarea id="link-description-input" rows="2" placeholder="ç®€å•æè¿°ä¸€ä¸‹é“¾æ¥å†…å®¹"></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input">æ¥æºåç§° (å¯é€‰)</label>
                <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥æŠ¥ã€Bç«™">
            </div>
            <div class="form-group">
                <label for="link-content-input">å®Œæ•´å†…å®¹ (å¯é€‰ï¼Œç”¨äºæµè§ˆå™¨å†…æ˜¾ç¤º)</label>
                <textarea id="link-content-input" rows="4" placeholder="ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª— â–¼â–¼â–¼ -->
<div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
        <div class="transfer-actions-header">è¯·é€‰æ‹©æ“ä½œ</div>
        <div class="transfer-actions-body">
            <p>ä½ æ”¶åˆ°äº†æ¥è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç¬”è½¬è´¦ã€‚</p>
        </div>
        <div class="transfer-actions-footer">
            <button id="transfer-action-decline" class="action-btn decline">æ®‹å¿æ‹’ç»</button>
            <button id="transfer-action-accept" class="action-btn accept">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="transcript-modal-title">é€šè¯è¯¦æƒ…</span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
            <!-- é€šè¯æ–‡å­—è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆ é™¤è®°å½•</button>
            <button class="save" id="close-transcript-modal-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
<div class="modal-header">
    <span id="share-target-modal-title">åˆ†äº«åˆ°...</span>
</div>
        <div class="modal-body" id="share-target-list" style="padding: 0;">
            <!-- èŠå¤©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-target-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="shared-history-viewer-title">èŠå¤©è®°å½•</span>
        </div>
        <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
            <!-- åˆ†äº«çš„èŠå¤©è®°å½•æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†ä¸–ç•Œä¹¦åˆ†ç±»</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç±»</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-category-name-input" placeholder="è¾“å…¥åˆ†ç±»å..." style="flex-grow: 1;">
                    <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²ä¸“å±NPCåº“ç®¡ç†ç•Œé¢ â–¼â–¼â–¼ -->
<div id="npc-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-npc-management">â€¹</span>
        <span id="npc-management-title">NPC åº“ç®¡ç†</span>
        <span class="action-btn" id="add-new-npc-btn">+</span>
    </div>
    <div class="list-container" id="npc-management-list">
        <!-- NPCåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œç²˜è´´æ‰€æœ‰è®ºå›ç›¸å…³çš„HTMLä»£ç  â–¼â–¼â–¼ -->

<!-- 1. è®ºå›ä¸»å±å¹• (æ˜¾ç¤ºæ‰€æœ‰å°ç»„) -->
<div id="forum-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>åœˆå­</span>
        <div class="header-actions">
                  <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ç­›é€‰å›¾æ ‡ â–¼â–¼â–¼ -->
        <span class="action-btn filter-btn" id="forum-filter-btn" title="ç­›é€‰">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </span>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
            <span class="action-btn" id="create-group-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
    </div>
    <div id="forum-group-list" class="list-container" style="padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-content: start;">
        <!-- å°ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ id="group-screen" â–¼â–¼â–¼ -->
<div id="group-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-to-forum-list">â€¹</span>
        <span id="group-screen-title">å°ç»„åç§°</span>
        <div class="header-actions">
                  <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ç­›é€‰å›¾æ ‡ â–¼â–¼â–¼ -->
        <span class="action-btn filter-btn" id="group-filter-btn" title="ç­›é€‰">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </span>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªé€šç”¨çš„â€œç”Ÿæˆå†…å®¹â€æŒ‰é’® -->
            <span class="action-btn" id="generate-group-content-btn" title="ç”Ÿæˆå†…å®¹">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </span>
            <span class="action-btn" id="create-forum-post-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
    </div>
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼ -->
<div id="fanfic-preference-bar" style="display: none; padding: 10px 15px; background-color: #f0f2f5; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
    <div class="form-group" style="margin: 0;">
        <label style="font-size: 14px; margin-bottom: 5px;">é€‰æ‹©CPåå¥½</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="fanfic-char1-select" style="flex: 1;"></select>
            <span>&</span>
            <select id="fanfic-char2-select" style="flex: 1;"></select>
            <button id="trigger-fanfic-generation-btn" class="form-button" style="margin: 0; padding: 10px 15px; width: auto;">ç”Ÿæˆ</button>
        </div>
    </div>
    <!-- è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„ä¸–ç•Œè§‚è¾“å…¥æ¡† -->
    <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
        <label for="fanfic-worldview-input" style="font-size: 14px; margin-bottom: 5px;">ä¸–ç•Œè§‚åå¥½ (å¯é€‰)</label>
        <input type="text" id="fanfic-worldview-input" placeholder="ä¾‹å¦‚ï¼šABOã€å“¨å‘ã€ç°ä»£å¤§å­¦AU...">
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <div id="group-post-list" class="list-container" style="padding-top: 0;">
        <!-- å¸–å­åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- 3. å•ä¸ªå¸–å­é¡µé¢ (æ˜¾ç¤ºå¸–å­å†…å®¹å’Œè¯„è®º) -->
<div id="post-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-to-group-screen">â€¹</span>
        <span>å¸–å­è¯¦æƒ…</span>
        <div class="header-actions">
            <span class="action-btn" id="repost-to-chat-btn">è½¬è½½</span>
        </div>
    </div>
    <div id="post-detail-content" class="list-container" style="padding: 20px;">
        <!-- å¸–å­å’Œè¯„è®ºå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    <!-- å¸–å­é¡µçš„è¯„è®ºè¾“å…¥æ¡† -->
    <div id="post-comment-input-area" class="chat-input-area" style="visibility: visible;">
         <div class="chat-input-main-row">
            <textarea id="post-comment-input" rows="1" placeholder="å‘å¸ƒä½ çš„è¯„è®º..."></textarea>
            <button id="send-post-comment-btn" class="action-button">å‘é€</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºåœˆå­åˆ†ç±»ç­›é€‰æ–°å¢çš„å¼¹çª— â–¼â–¼â–¼ -->
<div id="forum-filter-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 60%;">
        <div class="modal-header">
            <span>æŒ‰åˆ†ç±»ç­›é€‰</span>
        </div>
        <div class="modal-body">
            <div id="forum-filter-category-list">
                <!-- åˆ†ç±»æ ‡ç­¾å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="cancel" id="reset-forum-filter-btn" style="width: 30%;">é‡ç½®</button>
            <button class="cancel" id="cancel-forum-filter-btn" style="width: 30%;">å–æ¶ˆ</button>
            <button class="save" id="apply-forum-filter-btn" style="width: 30%;">åº”ç”¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->


<!-- â–²â–²â–² è®ºå›ç›¸å…³HTMLä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªå®šä¹‰å¤´åƒæ¡†ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="custom-frame-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ç®¡ç†æˆ‘çš„å¤´åƒæ¡†</span>
            <button id="upload-custom-frame-btn" class="action-button">ä¸Šä¼ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="custom-frame-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- è‡ªå®šä¹‰å¤´åƒæ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-frame-manager-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<input type="file" id="custom-frame-upload-input" accept="image/png, image/gif" hidden multiple>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å·²ä¿®æ”¹ã€‘å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="avatar-frame-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é€‰æ‹©å¤´åƒæ¡†</span>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªâ€œç®¡ç†â€æŒ‰é’® -->
            <button id="manage-custom-frames-btn" class="action-button">ç®¡ç†</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†éœ€è¦Tabsï¼Œåªæœ‰ä¸€ä¸ªGrid -->
            <div id="avatar-frame-grid" class="frame-grid">
                <!-- å¤´åƒæ¡†é€‰é¡¹ï¼ˆåŒ…æ‹¬â€œæ— â€å’Œè‡ªå®šä¹‰çš„ï¼‰ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å…¨æ–°è®¾è®¡ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ id="send-location-modal" â–¼â–¼â–¼ -->
<div id="send-location-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>å‘é€å®šä½ä¸è½¨è¿¹</span>
        </div>
        <div class="modal-body" style="padding-bottom: 5px;">
            <!-- æ ¸å¿ƒä¿¡æ¯ -->
            <div class="form-group">
                <label for="user-location-input">æˆ‘çš„ä½ç½® (èµ·ç‚¹)</label>
                <input type="text" id="user-location-input" placeholder="ä¾‹å¦‚ï¼šå¸‚ä¸­å¿ƒçš„å’–å•¡é¦†">
            </div>
            <div class="form-group">
                <label for="ai-location-input">Taçš„ä½ç½® (ç»ˆç‚¹)</label>
                <input type="text" id="ai-location-input" placeholder="ä¾‹å¦‚ï¼šæµ·è¾¹çš„ç¯å¡”">
            </div>
            <div class="form-group">
                <label for="distance-input">ç›¸è·</label>
                <input type="text" id="distance-input" placeholder="ä¾‹å¦‚ï¼šçº¦5å…¬é‡Œ (å¿…å¡«)">
            </div>
            
            <hr style="opacity: 0.2;">

            <!-- ã€å…¨æ–°ã€‘è¡ŒåŠ¨è½¨è¿¹è¾“å…¥åŒº -->
            <div class="form-group">
                <label>è¡ŒåŠ¨è½¨è¿¹ (å¯é€‰ï¼ŒæŒ‰é¡ºåºå¡«å†™)</label>
                <div id="trajectory-points-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ è¾“å…¥æ¡† -->
                </div>
                <button id="add-trajectory-point-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€”ç»ç‚¹</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="location-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="location-confirm-btn">å‘é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´æ‚¬æµ®æ­Œè¯æ è®¾ç½®æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="lyrics-settings-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ‚¬æµ®æ­Œè¯è®¾ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="lyrics-font-size-slider">å­—ä½“å¤§å°: <span id="lyrics-font-size-value">14px</span></label>
                <input type="range" id="lyrics-font-size-slider" min="12" max="24" value="14" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="lyrics-bg-opacity-slider">èƒŒæ™¯ä¸é€æ˜åº¦: <span id="lyrics-bg-opacity-value">0%</span></label>
                <input type="range" id="lyrics-bg-opacity-slider" min="0" max="100" value="0" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="lyrics-font-color-picker">å­—ä½“é¢œè‰²</label>
                <input type="color" id="lyrics-font-color-picker" value="#FFFFFF" style="width: 100%; height: 40px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="reset-lyrics-settings-btn">æ¢å¤é»˜è®¤</button>
            <button class="save" id="close-lyrics-settings-btn">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯â€œé€‰æ‹©æœç´¢æºâ€çš„å¼¹çª—ï¼Œè¯·ç²˜è´´åˆ°bodyæœ«å°¾ â–¼â–¼â–¼ -->
<div id="music-source-selector-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>é€‰æ‹©æœç´¢æº</span>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px;">
            <label style="display: block; margin-bottom: 15px; cursor: pointer;">
                <input type="radio" name="search-source" value="all" checked> å…¨éƒ¨æ¥æº (ç½‘æ˜“äº‘ + QQéŸ³ä¹)
            </label>
            <label style="display: block; margin-bottom: 15px; cursor: pointer;">
                <input type="radio" name="search-source" value="netease"> ä»…ç½‘æ˜“äº‘éŸ³ä¹
            </label>
            <label style="display: block; cursor: pointer;">
                <input type="radio" name="search-source" value="tencent"> ä»…QQéŸ³ä¹
            </label>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-source-select-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-source-select-btn">å¼€å§‹æœç´¢</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšå…³æ³¨åˆ—è¡¨çš„å¼¹çª—ï¼Œç²˜è´´åˆ° </body> å‰é¢ â–¼â–¼â–¼ -->
<div id="weibo-following-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>å…³æ³¨åˆ—è¡¨</span>
        </div>
        <div class="modal-body" style="padding: 0;">
            <!-- ã€æ ¸å¿ƒã€‘è¿™ä¸ªå®¹å™¨å°†å¸¦æ»šåŠ¨æ¡ -->
            <div id="weibo-following-list-container">
                <!-- å…³æ³¨åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-following-list-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- å¡”ç½—ç‰Œå åœä¸»æ¨¡æ€æ¡† -->
<div id="tarot-divination-modal" class="modal">
    <div class="modal-content" style="height: 85%; width: 95%;">
        
        <!-- 1. å åœè®¾ç½®ç•Œé¢ -->
        <div id="tarot-setup-view">
            <div class="modal-header">
                <span>å¡”ç½—ç‰Œå åœ</span>
                <div>
                    <span id="tarot-history-btn" class="action-btn" style="font-size: 16px;">å†å²</span>
                    <span id="close-tarot-modal-btn" class="action-btn" style="font-size: 16px;">å…³é—­</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tarot-question-input">æ‚¨çš„é—®é¢˜æˆ–å…³æ³¨ç‚¹</label>
                    <textarea id="tarot-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘è¿‘æœŸçš„æ¡ƒèŠ±è¿å¦‚ä½•ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label for="tarot-spread-select">é€‰æ‹©ç‰Œé˜µ</label>
                    <select id="tarot-spread-select">
                        <option value="single">å•å¼ ç‰Œ - å¿«é€ŸæŒ‡å¼•</option>
                        <option value="three_past_present_future">ä¸‰å¼ ç‰Œ - è¿‡å»/ç°åœ¨/æœªæ¥</option>
                        <option value="three_situation_challenge_advice">ä¸‰å¼ ç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ˜/å»ºè®®</option>
                        <option value="celtic_cross">å‡¯å°”ç‰¹åå­— - æ·±åº¦åˆ†æ (10å¼ ç‰Œ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç‰Œé¢æ–¹å‘</label>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="radio" name="tarot-orientation" value="upright" checked> ä»…æ­£ä½</label>
                        <label><input type="radio" name="tarot-orientation" value="reversed"> åŒ…å«é€†ä½</label>
                    </div>
                </div>
                <button id="draw-tarot-cards-btn" class="form-button" style="margin-top: 20px;">æ´—ç‰Œå¹¶æŠ½ç‰Œ</button>
            </div>
        </div>

        <!-- 2. å åœç»“æœç•Œé¢ (é»˜è®¤éšè—) -->
        <div id="tarot-result-view" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span id="back-to-tarot-setup-btn" class="action-btn" style="font-size: 16px;">è¿”å›</span>
                <span>å åœç»“æœ</span>
            </div>
            <div class="modal-body" id="tarot-result-display">
                <!-- ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button id="send-tarot-result-btn" class="save" style="width: 100%;">å‘ç»™å¡”ç½—å¸ˆè§£è¯»</button>
            </div>
        </div>

        <!-- 3. å†å²è®°å½•ç•Œé¢ (é»˜è®¤éšè—) -->
        <div id="tarot-history-view" style="display: none; height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span id="back-to-tarot-main-btn" class="action-btn" style="font-size: 16px;">è¿”å›</span>
                <span>å åœå†å²</span>
            </div>
            <div class="modal-body" id="tarot-history-list">
                <!-- å†å²è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™é‡Œæ˜¯æ•´ä¸ªæƒ…ä¾£ç©ºé—´åŠŸèƒ½çš„HTMLä»£ç  â–¼â–¼â–¼ -->
<!-- 2. åˆ‡æ¢è§’è‰²çš„å¼¹çª— -->
<div id="ls-char-selector-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©ç©ºé—´</span>
        </div>
        <div class="modal-body" id="ls-char-selector-list" style="padding: 0;">
            <!-- è§’è‰²åˆ—è¡¨ä¼šç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-switch-char-btn" style="width:100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- 3. å‘å¸ƒè¯´è¯´çš„å¼¹çª— -->
<div id="ls-create-moment-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æƒ³å¯¹Taè¯´...</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <textarea id="ls-moment-content-input" rows="5" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¬çš„ç§å¯†è¯è¯­..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-moment-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-moment-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—æ–°ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ ls-create-album-modal â–¼â–¼â–¼ -->
<!-- 4. åˆ›å»ºç›¸å†Œ/ä¸Šä¼ ç…§ç‰‡çš„å¼¹çª— (è¿™æ˜¯ä¿®æ”¹åçš„ç‰ˆæœ¬) -->
<div id="ls-create-album-modal" class="modal">
     <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <!-- æ ‡é¢˜å·²ä¿®æ”¹ -->
            <span id="ls-album-modal-title">ä¸Šä¼ ç…§ç‰‡</span>
        </div>
        <div class="modal-body">
            <!-- æ–°å¢ï¼šæ¨¡å¼åˆ‡æ¢å¼€å…³ (å¤ç”¨åŠ¨æ€çš„æ ·å¼) -->
            <div class="post-mode-switcher">
                <button id="ls-switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="ls-switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
            </div>

            <!-- æ¨¡å¼1: ä¸Šä¼ å›¾ç‰‡ -->
            <div id="ls-image-mode-content" class="post-mode-content active">
                <div class="form-group">
                    <label>é€‰æ‹©ç…§ç‰‡ (ä»…é™å•å¼ )</label>
                    <div id="ls-photo-preview-container"></div>
                    <button class="form-button form-button-secondary" id="ls-select-photos-btn">é€‰æ‹©ç…§ç‰‡</button>
                    <!-- å…³é”®ï¼šè¿™é‡Œçš„ input ç§»é™¤äº† multiple å±æ€§ï¼Œç°åœ¨åªèƒ½å•é€‰ -->
                    <input type="file" id="ls-photo-input" accept="image/*" hidden>
                </div>
                 <div class="form-group">
                    <label>å›¾ç‰‡æè¿° (å¿…å¡«)</label>
                    <textarea id="ls-photo-desc-input" rows="3" placeholder="ä¸ºè¿™å¼ ç…§ç‰‡å†™ä¸‹æ³¨è„š..."></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼2: ä½¿ç”¨æ–‡å­—å›¾ -->
            <div id="ls-text-image-mode-content" class="post-mode-content" style="display: none;">
                <div class="form-group">
                    <label>æ–‡å­—å›¾æè¿° (å¿…å¡«)</label>
                    <textarea id="ls-text-image-desc-input" rows="5" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæƒ…æˆ–æ•…äº‹..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-album-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-album-btn">ç¡®è®¤ä¸Šä¼ </button>
        </div>
    </div>
</div><!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-å†™æƒ…ä¹¦/å›ä¿¡çš„å¼¹çª— -->
<div id="ls-create-letter-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="ls-letter-modal-title">ç»™Taå†™ä¸€å°ä¿¡</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ls-letter-recipient-input">æ”¶ä¿¡äºº</label>
                <!-- æ”¶ä¿¡äººé€šå¸¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¦ç”¨è¿™ä¸ªè¾“å…¥æ¡† -->
                <input type="text" id="ls-letter-recipient-input" disabled>
            </div>
            <div class="form-group">
                <label for="ls-letter-content-input">æƒ…ä¹¦å†…å®¹</label>
                <textarea id="ls-letter-content-input" rows="8" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæ„..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-letter-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-letter-btn">å¯„å‡º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¹¦æŸ¥çœ‹å™¨ -->
<div id="ls-letter-viewer-modal" class="modal">
    <div class="ls-letter-viewer-content">
        <!-- å¤´éƒ¨ï¼šæ”¶ä¿¡äººä¿¡æ¯ -->
        <div class="letter-viewer-header">
            <img id="ls-viewer-recipient-avatar" class="meta-avatar">
            <div class="recipient-info">
                <div class="label">To my dear:</div>
                <div id="ls-viewer-recipient-name" class="name"></div>
            </div>
        </div>
        <!-- ä¸­é—´ï¼šä¿¡ä»¶æ­£æ–‡ -->
        <div id="ls-viewer-body" class="letter-viewer-body">
            <!-- JSä¼šåœ¨è¿™é‡Œå¡«å……ä¿¡ä»¶å†…å®¹ -->
        </div>
        <!-- åº•éƒ¨ï¼šå‘ä¿¡äººä¿¡æ¯å’Œæ“ä½œæŒ‰é’® -->
        <div class="letter-viewer-footer">
            <div class="sender-info">
                <div id="ls-viewer-sender-name"></div>
                <div id="ls-viewer-timestamp" class="timestamp"></div>
            </div>
            <div class="letter-actions">
                <button id="ls-close-letter-viewer-btn">å…³é—­</button>
                <button id="ls-reply-letter-btn" class="primary">å›ä¿¡</button>
            </div>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´è®¾ç½®å¼¹çª— â–¼â–¼â–¼ -->
<div id="ls-settings-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æƒ…ä¾£ç©ºé—´è®¾ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ls-start-date-input">æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©</label>
                <input type="date" id="ls-start-date-input" style="width: 100%; padding: 10px; box-sizing: border-box;">
            </div>
            
            <!-- â–¼â–¼â–¼ ä½ æ–°åŠ çš„ä»£ç ä¼šå‡ºç°åœ¨è¿™é‡Œ â–¼â–¼â–¼ -->
            <hr style="opacity: 0.2; margin: 20px 0;">
            <div class="form-group">
                <label>å±é™©æ“ä½œ</label>
                <div style="display: flex; gap: 10px;">
                    <button id="ls-cancel-space-btn" class="form-button form-button-secondary" style="background-color: #ffe5e5; color: #ff3b30; border-color: #ffc2d1; flex: 1; margin:0;">å–æ¶ˆç©ºé—´</button>
                    <button id="ls-disconnect-space-btn" class="form-button form-button-secondary" style="background-color: #ff3b30; color: white; border-color: #ff3b30; flex: 1; margin:0;">è§£é™¤å…³ç³»</button>
                </div>
                 <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px;">
                    <strong>å–æ¶ˆç©ºé—´</strong>: å°†ç©ºé—´å˜ä¸ºæœªå¯ç”¨çŠ¶æ€ï¼Œä½†ä¿ç•™æ‰€æœ‰æ•°æ®ã€‚ä¸ä¼šé€šçŸ¥å¯¹æ–¹ã€‚<br>
                    <strong>è§£é™¤å…³ç³»</strong>: åŒæ ·ä¼šå–æ¶ˆç©ºé—´ï¼Œä½†ä¼šé€šçŸ¥å¯¹æ–¹å…³ç³»å·²è§£é™¤ï¼Œå¯¹æ–¹ä¼šå¯¹æ­¤å‘è¡¨æ„è§ã€‚
                </p>
            </div>
            <!-- â–²â–²â–² æ–°ä»£ç ç»“æŸ â–²â–²â–² -->

        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-settings-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-settings-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æé—®å¼¹çª— -->
<div id="ls-ask-question-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>å‘èµ·ä¸€ä¸ªæé—®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <textarea id="ls-question-content-input" rows="5" placeholder="å‘Taæä¸ªé—®é¢˜å§..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-ask-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-ask-btn">å‘Taæé—®</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-å›ç­”å¼¹çª— -->
<div id="ls-answer-question-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>å›ç­”Taçš„é—®é¢˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é—®é¢˜ï¼š</label>
                <p id="ls-answer-question-text" style="background-color: #f0f2f5; padding: 10px; border-radius: 8px;"></p>
            </div>
            <div class="form-group">
                <label for="ls-answer-content-input">ä½ çš„å›ç­”ï¼š</label>
                <textarea id="ls-answer-content-input" rows="5" placeholder="è®¤çœŸå›ç­”å“¦..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-answer-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-confirm-answer-btn">ç¡®è®¤å›ç­”</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æƒ…ä¾£ç©ºé—´ä¸“å±éŸ³ä¹æ’­æ”¾å™¨çš„HTMLä»£ç  â–¼â–¼â–¼ -->

<!-- 1. è¿™æ˜¯æ’­æ”¾å™¨ä¸“å±çš„éŸ³é¢‘å¼•æ“ -->
<audio id="ls-audio-player" style="display:none;"></audio>

<!-- 2. è¿™æ˜¯æ’­æ”¾å™¨çš„ä¸»çª—å£ç•Œé¢ -->
<div id="ls-music-player-overlay" class="modal">
    <div class="music-player-window">
<!-- ã€å…¨æ–°ã€‘å°é¢å’Œæ­Œè¯çš„åˆ‡æ¢å®¹å™¨ -->
<div id="ls-display-area" style="width: 192px; height: 192px; margin-bottom: 20px; cursor: pointer;">
    <!-- æ­Œæ›²å°é¢ -->
    <img id="ls-album-cover" src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png" alt="æ­Œæ›²å°é¢" style="width: 100%; height: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    
    <!-- æ­Œè¯å®¹å™¨ -->
    <div id="ls-lyrics-container" style="display: none; width: 100%; height: 100%; overflow: hidden; text-align: center; color: #333; font-weight: 500;">
        <div id="ls-lyrics-list" style="transition: transform 0.5s ease;">
             <!-- æ­Œè¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

        <!-- æ­Œæ›²ä¿¡æ¯ -->
        <div id="ls-song-title" style="font-size: 18px; font-weight: 600;">æš‚æ— æ­Œæ›²</div>
        <div id="ls-artist" style="font-size: 14px; color: #666; margin-bottom: 15px;">...</div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="music-progress-bar-container" style="width: 100%;">
            <div id="ls-current-time" class="time-display">0:00</div>
            <div class="progress-bar" id="ls-progress-bar">
                <div id="ls-progress-fill" class="progress-bar-fill"></div>
            </div>
            <div id="ls-total-time" class="time-display">0:00</div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="music-controls" style="margin-bottom: 15px;">
            <button id="ls-prev-btn">â—€</button>
            <button id="ls-play-pause-btn" class="play-pause-btn">â–¶</button>
            <button id="ls-next-btn">â–¶</button>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="music-bottom-actions" style="width: 100%;">
            <button id="ls-playlist-btn" style="background-color: rgba(0, 123, 255, 0.1); color: var(--accent-color); margin-right: 5px;">æ’­æ”¾åˆ—è¡¨</button>
            <button id="ls-close-player-btn" style="background-color: rgba(0,0,0,0.05); color: #333; margin-left: 5px;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- 3. è¿™æ˜¯æ’­æ”¾åˆ—è¡¨çš„ä¾§æ»‘é¢æ¿ -->
<div id="ls-music-playlist-panel" class="music-playlist-panel">
    <div class="playlist-header">
        <span class="panel-btn" id="ls-close-playlist-btn">è¿”å›</span>
        <span>æ’­æ”¾åˆ—è¡¨</span>
        <span class="panel-btn" id="ls-clear-playlist-btn" style="color: #ff3b30;">æ¸…ç©º</span>
    </div>
    <div class="playlist-body" id="ls-playlist-body">
        <!-- æ’­æ”¾åˆ—è¡¨å†…å®¹ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
    </div>
</div>

<!-- â–²â–²â–² HTMLä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç•ªèŒ„é’Ÿ-è®¾ç½®å¼¹çª— -->
<div id="ls-pomodoro-setup-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°çš„ä¸“æ³¨æ—¶å…‰</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="pomodoro-task-input">ä¸“æ³¨ä»»åŠ¡</label>
                <input type="text" id="pomodoro-task-input" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ JSã€å®Œæˆå·¥ä½œæŠ¥å‘Š">
            </div>
            <div class="form-group">
                <label for="pomodoro-duration-input">ä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
                <input type="number" id="pomodoro-duration-input" value="25" min="1">
            </div>
<div class="form-group">
    <label>è®¡æ—¶æ¨¡å¼</label>
    <div style="display: flex; gap: 20px;">
        <label><input type="radio" name="pomodoro-mode" value="countdown" checked> å€’è®¡æ—¶</label>
        <label><input type="radio" name="pomodoro-mode" value="countup"> æ­£è®¡æ—¶</label>
    </div>
</div>
            <div class="form-group">
                <label for="pomodoro-talk-interval-input">è§’è‰²é¼“åŠ±é—´éš” (åˆ†é’Ÿ, 0ä¸ºä¸è‡ªåŠ¨é¼“åŠ±)</label>
                <input type="number" id="pomodoro-talk-interval-input" value="5" min="0">
            </div>
<!-- â–¼â–¼â–¼ è¿™æ˜¯ä¿®æ”¹åçš„ç•ªèŒ„é’ŸèƒŒæ™¯è®¾ç½® â–¼â–¼â–¼ -->
<div class="form-group">
    <label>è‡ªå®šä¹‰èƒŒæ™¯ (å¯é€‰)</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="pomodoro-bg-url-input" placeholder="ç²˜è´´å›¾ç‰‡URL" style="flex-grow: 1;">
        <button id="pomodoro-bg-local-upload-btn" class="form-button-secondary" style="margin: 0; padding: 12px; width: auto;">æœ¬åœ°ä¸Šä¼ </button>
    </div>
    <input type="file" id="pomodoro-bg-file-input" accept="image/*" hidden>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="pomodoro-cancel-setup-btn">å–æ¶ˆ</button>
            <button class="save" id="pomodoro-confirm-setup-btn">å¼€å§‹ä¸“æ³¨</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç•ªèŒ„é’Ÿ-å†å²è¯¦æƒ…å¼¹çª— -->
<div id="ls-pomodoro-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="pomodoro-history-viewer-title">ä¸“æ³¨è®°å½•</span>
        </div>
        <div class="modal-body" id="pomodoro-history-viewer-content">
            <!-- èŠå¤©è®°å½•ä¼šç”±JSç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="pomodoro-close-history-viewer-btn" style="width:100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² æƒ…ä¾£ç©ºé—´HTMLä»£ç ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œåœˆå­â€åŠŸèƒ½æ–°å¢çš„æ‰€æœ‰å¼¹çª— â–¼â–¼â–¼ -->

<!-- 1. å°ç»„ç¼–è¾‘å™¨å¼¹çª— (ç”¨äºä¿®æ”¹å°ç»„ä¿¡æ¯å’Œä¸–ç•Œè§‚) -->
<div id="forum-group-editor-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>ç¼–è¾‘å°ç»„ä¿¡æ¯</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="group-editor-name-input">å°ç»„åç§°</label>
                <input type="text" id="group-editor-name-input">
            </div>
            <div class="form-group">
                <label for="group-editor-desc-input">å°ç»„ç®€ä»‹</label>
                <input type="text" id="group-editor-desc-input">
            </div>
            <div class="form-group">
                <label for="group-editor-icon-input">å°ç»„å›¾æ ‡ (Emoji)</label>
                <input type="text" id="group-editor-icon-input" maxlength="2">
            </div>
            <div class="form-group">
                <label for="group-editor-categories-input">å°ç»„åˆ†ç±» (ç”¨#å·åˆ†éš”, ä¾‹å¦‚: #ç§‘å¹» #æœªæ¥)</label>
                <input type="text" id="group-editor-categories-input" placeholder="ä¾‹å¦‚: #ç§‘å¹» #æœªæ¥">
            </div>
            <div class="form-group">
                <label for="group-editor-worldview-input">å°ç»„ä¸–ç•Œè§‚ (ä¾›AIç”Ÿæˆå†…å®¹æ—¶å‚è€ƒ)</label>
                <textarea id="group-editor-worldview-input" rows="5" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªå°ç»„ç‹¬ç‰¹çš„èƒŒæ™¯è®¾å®š..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-group-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-group-editor-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- 2. åˆ†ç±»ç®¡ç†å¼¹çª— -->
<div id="forum-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†åœˆå­åˆ†ç±»</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç±»</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-forum-category-name-input" placeholder="è¾“å…¥åˆ†ç±»åï¼Œæ— éœ€å¸¦'#'..." style="flex-grow: 1;">
                    <button id="add-new-forum-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-forum-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-forum-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ¸¸æˆå¤§å…çš„ä¸»ç•Œé¢ï¼Œç²˜è´´åˆ°æ‰€æœ‰ modal çš„ div ä¹‹åã€<script> æ ‡ç­¾ä¹‹å‰ â–¼â–¼â–¼ -->
<div id="game-hall-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¸¸æˆå¤§å…</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ -->
    </div>
    <div class="list-container" style="padding: 20px;">
        <p style="text-align: center; color: var(--text-secondary);">é€‰æ‹©ä¸€ä¸ªæ¸¸æˆå¼€å§‹å§ï¼</p>
        <div id="game-hall-grid">
            <!-- æ¸¸æˆåˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            <div class="game-card" data-game="werewolf">
                <div class="game-icon">ğŸº</div>
                <div class="game-info">
                    <div class="game-title">ç‹¼äººæ€</div>
                    <div class="game-desc">é€»è¾‘ä¸è°è¨€çš„å¯¹å†³</div>
                </div>
            </div>
            <div class="game-card" data-game="sea-turtle-soup">
                <div class="game-icon">ğŸ¢</div>
                <div class="game-info">
                    <div class="game-title">æµ·é¾Ÿæ±¤</div>
                    <div class="game-desc">æ­å¼€æƒ…æ™¯çš„çœŸç›¸</div>
                </div>
            </div>
             <div class="game-card" data-game="script-kill">
                <div class="game-icon">ğŸ“œ</div>
                <div class="game-info">
                    <div class="game-title">å‰§æœ¬æ€</div>
                    <div class="game-desc">æ‰®æ¼”è§’è‰²ï¼Œæ¢å¯»è°œæ¡ˆ</div>
                </div>
            </div>
            <div class="game-card" data-game="guess-what">
                <div class="game-icon">ğŸ—£ï¸</div>
                <div class="game-info">
                    <div class="game-title">ä½ è¯´æˆ‘çŒœ</div>
                    <div class="game-desc">è€ƒéªŒé»˜å¥‘çš„æ—¶å€™åˆ°äº†</div>
                </div>
            </div>
<div class="game-card" data-game="ludo">
    <div class="game-icon">ğŸ²</div>
    <div class="game-info">
        <div class="game-title">å¿ƒåŠ¨é£è¡Œæ£‹</div>
        <div class="game-desc">å’ŒTaæ¥ä¸€åœºåªå±äºä½ ä»¬çš„å†’é™©</div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„æ¸¸æˆå¡ç‰‡ â–¼â–¼â–¼ -->
<div class="game-card" data-game="undercover">
    <div class="game-icon">ğŸ•µï¸</div>
    <div class="game-info">
        <div class="game-title">è°æ˜¯å§åº•</div>
        <div class="game-desc">è¯­è¨€çš„ä¼ªè£…ï¼Œé€»è¾‘çš„é™·é˜±</div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² -->
             <p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 20px;">æ›´å¤šæ¸¸æˆæ­£åœ¨ç«é€Ÿå¼€å‘ä¸­...</p>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ•´ä¸ªç‹¼äººæ€åŠŸèƒ½çš„HTMLï¼Œç²˜è´´åˆ° game-hall-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->

<!-- 1. ç‹¼äººæ€æ¸¸æˆè®¾ç½®å±å¹• -->
<div id="werewolf-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ç‹¼äººæ€ - æ¸¸æˆè®¾ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="werewolf-player-count">é€‰æ‹©æ¸¸æˆäººæ•°</label>
            <select id="werewolf-player-count">
                <option value="6">6äººå±€ (2ç‹¼, 2æ°‘, é¢„è¨€å®¶, å®ˆå«)</option>
                <option value="9">9äººå±€ (3ç‹¼, 3æ°‘, é¢„è¨€å®¶, å¥³å·«, çŒäºº)</option>
                <option value="12">12äººå±€ (4ç‹¼, 4æ°‘, é¢„è¨€å®¶, å¥³å·«, çŒäºº, ç™½ç—´)</option>
            </select>
        </div>
        <div class="form-group">
            <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
            <div id="werewolf-player-selection" class="list-container" style="height: 300px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <button id="start-werewolf-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<!-- 2. ç‹¼äººæ€æ¸¸æˆä¸»ç•Œé¢ -->
<div id="werewolf-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-werewolf-game-btn">â€¹ é€€å‡º</span>
        <span id="werewolf-game-title">ç‹¼äººæ€</span>
        <span class="action-btn" id="werewolf-my-role-btn">æˆ‘çš„èº«ä»½</span>
    </div>
    <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
    <div id="werewolf-game-content">
        <!-- ç©å®¶åº§ä½åŒº -->
        <div id="werewolf-players-grid">
            <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div id="werewolf-log-container">
            <div id="werewolf-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="werewolf-action-area">
            <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² ç‹¼äººæ€åŠŸèƒ½HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ€æ¸¸æˆç»“ç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="werewolf-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="werewolf-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="repost-summary-btn">å‘é€å¤ç›˜åˆ°èŠå¤©</button>
            <button class="save" id="back-to-hall-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç‹¼äººæ€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
<div id="werewolf-target-picker-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©è¦å‘é€çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="werewolf-target-list" style="padding: 0;">
            <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button id="wt-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é€‰</button>
            <button id="wt-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é€‰</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="wt-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="wt-confirm-btn">ç¡®è®¤å‘é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ•´ä¸ªæµ·é¾Ÿæ±¤åŠŸèƒ½çš„HTMLï¼Œè¯·ç²˜è´´åˆ° </body> æ ‡ç­¾å‰ â–¼â–¼â–¼ -->

<!-- 1. æµ·é¾Ÿæ±¤æ¸¸æˆä¸»ç•Œé¢ -->
<div id="sea-turtle-soup-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-sts-game-btn">â€¹ é€€å‡º</span>
        <span>æµ·é¾Ÿæ±¤</span>
        <span class="action-btn" id="reveal-sts-answer-btn">æ­æ™“ç­”æ¡ˆ</span>
    </div>
    <div id="sts-game-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; box-sizing: border-box;">
        <!-- ç©å®¶åº§ä½åŒº -->
        <div id="sts-players-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; padding: 10px; flex-shrink: 0;">
            <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div id="sts-log-container" style="flex-grow: 1; background-color: rgba(0,0,0,0.05); border-radius: 10px; padding: 10px; overflow-y: auto; margin: 10px 0; min-height: 0;">
            <div id="sts-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ id="sts-action-area" â–¼â–¼â–¼ -->
<div id="sts-action-area" class="chat-input-area" style="visibility: visible;">
     <div class="chat-input-main-row">
        <textarea id="sts-question-input" rows="1" placeholder="è¾“å…¥é—®é¢˜æˆ–ç­”æ¡ˆ..."></textarea>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ–°å¢â€œçŒœç­”æ¡ˆâ€æŒ‰é’® -->
        <button id="guess-sts-answer-btn" class="action-button" style="background-color: #ff9800;">çŒœç­”æ¡ˆ</button>
        <button id="send-sts-question-btn" class="action-button">æé—®</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    </div>
</div>

<!-- 2. æµ·é¾Ÿæ±¤æ¸¸æˆè®¾ç½®æ¨¡æ€æ¡† -->
<div id="sea-turtle-soup-setup-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span>æµ·é¾Ÿæ±¤ - æ¸¸æˆè®¾ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
                <div id="sts-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="form-group">
                <label>è°æ¥å‡ºé¢˜ï¼Ÿ</label>
                <select id="sts-riddle-provider-select">
                    <option value="user">æˆ‘æ¥å‡ºé¢˜</option>
                    <option value="random_ai">éšæœºä¸€ä½AI</option>
                </select>
            </div>
            <!-- ç”¨æˆ·å‡ºé¢˜çš„è¾“å…¥åŒº (é»˜è®¤éšè—) -->
            <div id="sts-user-riddle-input-area" style="display: none;">
                <div class="form-group">
                    <label for="sts-user-riddle-surface">è°œé¢</label>
                    <textarea id="sts-user-riddle-surface" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªç”·äººèµ°è¿›é…’å§ï¼Œè¦äº†ä¸€æ¯æ°´..."></textarea>
                </div>
                <div class="form-group">
                    <label for="sts-user-riddle-answer">è°œåº• (å®Œæ•´æ•…äº‹)</label>
                    <textarea id="sts-user-riddle-answer" rows="4" placeholder="ä¾‹å¦‚ï¼šç”·äººåœ¨æ‰“å—ï¼Œä»–æƒ³å–æ°´æ­¢å—..."></textarea>
                </div>
            </div>
            <!-- AIå‡ºé¢˜çš„è¾“å…¥åŒº (é»˜è®¤éšè—) -->
            <div id="sts-ai-riddle-input-area" style="display: none;">
                <div class="form-group">
                    <label for="sts-ai-riddle-type">è°œé¢˜ç±»å‹ (å¯é€‰)</label>
                    <input type="text" id="sts-ai-riddle-type" placeholder="ä¾‹å¦‚ï¼šææ€–ã€æ¸©æƒ…ã€è„‘æ´ã€ç»å…¸">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sts-setup-btn">å–æ¶ˆ</button>
            <button class="save" id="start-sts-game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸¤å—ä»£ç ç²˜è´´åˆ° </body> æ ‡ç­¾å‰ â–¼â–¼â–¼ -->

<!-- 1. æµ·é¾Ÿæ±¤æ¸¸æˆç»“ç®—å¡ç‰‡ -->
<div id="sts-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="sts-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="share-sts-summary-btn">åˆ†äº«å¤ç›˜</button>
            <button class="save" id="back-to-hall-from-sts-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>

<!-- 2. æµ·é¾Ÿæ±¤å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
<div id="sts-share-target-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©è¦åˆ†äº«çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="sts-share-target-list" style="padding: 0;">
            <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button id="sts-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é€‰</button>
            <button id="sts-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é€‰</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sts-cancel-share-btn">å–æ¶ˆ</button>
            <button class="save" id="sts-confirm-share-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ•´ä¸ªå‰§æœ¬æ€åŠŸèƒ½çš„HTMLï¼Œè¯·ç²˜è´´åˆ° </body> æ ‡ç­¾å‰ â–¼â–¼â–¼ -->

<!-- 1. å‰§æœ¬æ€æ¸¸æˆè®¾ç½®å±å¹• -->
<div id="script-kill-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>å‰§æœ¬æ€ - æ¸¸æˆè®¾ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é€‰æ‹©å‰§æœ¬</label>
            <div style="display: flex; gap: 10px;">
                <select id="script-kill-script-select" style="flex-grow: 1;"></select>
                <button id="manage-custom-scripts-btn" class="form-button-secondary" style="margin-top: 0; padding: 0 15px;">ç®¡ç†</button>
            </div>
        </div>
        <div class="form-group">
            <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
            <div id="script-kill-player-selection" class="list-container" style="height: 300px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="form-group">
            <label class="toggle-switch-label">
                <span class="toggle-switch-text">è‡ªç”±é€‰æ‹©è§’è‰² (å…³é—­åˆ™éšæœºåˆ†é…)</span>
                <input type="checkbox" id="script-kill-free-choice-toggle">
                <span class="toggle-switch-slider"></span>
            </label>
        </div>
        <button id="start-script-kill-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<!-- 2. å‰§æœ¬æ€æ¸¸æˆä¸»ç•Œé¢ -->
<div id="script-kill-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-script-kill-game-btn">â€¹ é€€å‡º</span>
        <span id="script-kill-game-title">å‰§æœ¬æ€</span>
        <div class="header-actions">
            <span class="action-btn" id="script-kill-my-role-btn">æˆ‘çš„è§’è‰²</span>
            <span class="action-btn" id="script-kill-all-evidence-btn">å…¬å…±çº¿ç´¢</span>
        </div>
    </div>
    <div id="script-kill-game-content">
        <div id="script-kill-players-grid">
            <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div id="script-kill-log-container">
            <div id="script-kill-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div id="script-kill-action-area">
            <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘å‰§æœ¬æ€è‡ªå®šä¹‰å‰§æœ¬ç®¡ç†æ¨¡æ€æ¡† -->
<div id="script-kill-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
<div class="modal-header">
    <span>ç®¡ç†è‡ªå®šä¹‰å‰§æœ¬</span>
    <div class="header-actions">
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªæ–°æŒ‰é’® â–¼â–¼â–¼ -->
        <button id="open-sk-ai-generator-btn" class="action-button" style="font-size: 14px;">AIç”Ÿæˆ</button>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
        <button id="add-new-script-btn" class="action-button">æ·»åŠ </button>
    </div>
</div>

        <div class="modal-body" id="custom-scripts-list" style="padding: 0;">
            <!-- è‡ªå®šä¹‰å‰§æœ¬åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-script-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ id="script-kill-editor-modal" â–¼â–¼â–¼ -->

<!-- 1. å‰§æœ¬ç¼–è¾‘å™¨ä¸»å¼¹çª— (å¯è§†åŒ–ç‰ˆ) -->
<div id="script-kill-editor-modal" class="modal">
    <div class="modal-content" style="height: 90%;">
        <div class="modal-header">
            <span id="script-editor-title">å‰§æœ¬ç¼–è¾‘å™¨</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
            
            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="form-group">
                <label for="script-name-input">å‰§æœ¬åç§°</label>
                <input type="text" id="script-name-input">
            </div>
            <div class="form-group">
                <label for="script-background-input">æ•…äº‹èƒŒæ™¯</label>
                <textarea id="script-background-input" rows="3"></textarea>
            </div>
            
            <hr style="opacity: 0.2;">

            <!-- è§’è‰²è®¾å®šåŒº -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="margin: 0; font-weight: 600;">è§’è‰²è®¾å®š</label>
                    <button id="sk-add-role-btn" class="form-button-secondary" style="margin: 0; padding: 5px 15px;">+ æ·»åŠ è§’è‰²</button>
                </div>
                <div id="sk-roles-container" class="sk-item-container">
                    <!-- è§’è‰²å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>

            <!-- çº¿ç´¢å¡åŒº -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="margin: 0; font-weight: 600;">çº¿ç´¢å¡</label>
                    <button id="sk-add-clue-btn" class="form-button-secondary" style="margin: 0; padding: 5px 15px;">+ æ·»åŠ çº¿ç´¢</button>
                </div>
                <div id="sk-clues-container" class="sk-item-container">
                    <!-- çº¿ç´¢å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>

            <!-- æœ€ç»ˆçœŸç›¸äº’åŠ¨ -->
            <div class="form-group">
                <label for="sk-truth-input">æœ€ç»ˆçœŸç›¸</label>
                <textarea id="sk-truth-input" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-script-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-script-btn">ä¿å­˜å‰§æœ¬</button>
        </div>
    </div>
</div>

<!-- 2. ã€å…¨æ–°ã€‘ç”¨äºç¼–è¾‘å•ä¸ªè§’è‰²/çº¿ç´¢çš„å­å¼¹çª— -->
<div id="sk-item-editor-modal" class="modal" style="z-index: 1003;">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span id="sk-item-editor-title"></span>
        </div>
        <div class="modal-body">
            <!-- è§’è‰²ç¼–è¾‘å­—æ®µ (é»˜è®¤éšè—) -->
            <div id="sk-role-editor-fields" style="display: none;">
                <div class="form-group">
                    <label for="sk-role-name-input">è§’è‰²åç§°</label>
                    <input type="text" id="sk-role-name-input">
                </div>
                <div class="form-group">
                    <label for="sk-role-desc-input">è§’è‰²ä»‹ç»</label>
                    <textarea id="sk-role-desc-input" rows="3"></textarea>
                </div>
<div class="form-group">
    <label for="sk-role-storyline-input">æ•…äº‹çº¿ (æ¡ˆå‘æ—¶é—´æ®µçš„è¯¦ç»†è¡ŒåŠ¨è½¨è¿¹)</label>
    <textarea id="sk-role-storyline-input" rows="5"></textarea>
</div>
                <div class="form-group">
                    <label for="sk-role-tasks-input">ç§˜å¯†ä»»åŠ¡</label>
                    <textarea id="sk-role-tasks-input" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="toggle-switch-label">
                        <span class="toggle-switch-text">æ˜¯å‡¶æ‰‹</span>
                        <input type="checkbox" id="sk-role-killer-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <!-- çº¿ç´¢ç¼–è¾‘å­—æ®µ (é»˜è®¤éšè—) -->
            <div id="sk-clue-editor-fields" style="display: none;">
                <div class="form-group">
                    <label for="sk-clue-owner-select">çº¿ç´¢å½’å±</label>
                    <select id="sk-clue-owner-select">
                        <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="sk-clue-desc-input">çº¿ç´¢æè¿°</label>
                    <textarea id="sk-clue-desc-input" rows="4"></textarea>
                </div>
                 <div class="form-group">
                    <label class="toggle-switch-label">
                        <span class="toggle-switch-text">æ˜¯å…³é”®çº¿ç´¢</span>
                        <input type="checkbox" id="sk-clue-key-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-item-editor-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="sk-item-editor-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- 4. è§’è‰²èº«ä»½å¡æ¨¡æ€æ¡† -->
<div id="script-kill-role-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="sk-role-name">ä½ çš„è§’è‰²</span>
        </div>
        <div class="modal-body" id="sk-role-details" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- è§’è‰²ä»‹ç»ã€ä»»åŠ¡ç­‰å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-sk-role-modal-btn" style="width:100%;">æˆ‘å·²äº†è§£</button>
        </div>
    </div>
</div>

<!-- 5. ä¸ªäººçº¿ç´¢æ¿æ¨¡æ€æ¡† -->
<div id="script-kill-evidence-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æˆ‘çš„çº¿ç´¢æ¿</span>
        </div>
        <div class="modal-body" id="sk-evidence-list" style="padding: 10px; display: flex; flex-direction: column; gap: 10px;">
            <!-- æœåˆ°çš„çº¿ç´¢å¡ç‰‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-sk-evidence-modal-btn" style="width:100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- 6. æŠ•ç¥¨æ¨¡æ€æ¡† -->
<div id="script-kill-vote-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 70%;">
        <div class="modal-header">
            <span id="sk-vote-title">æœ€ç»ˆæŠ•ç¥¨</span>
        </div>
        <div class="modal-body" id="sk-vote-options-list" style="text-align: left; padding: 20px;">
            <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sk-vote-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-sk-vote-btn">ç¡®è®¤æŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰§æœ¬æ€æ¸¸æˆç»“ç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="script-kill-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="script-kill-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="repost-sk-summary-btn">è½¬å‘å¤ç›˜åˆ°å•èŠ</button>
            <button class="save" id="back-to-hall-from-sk-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‰§æœ¬æ€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
<div id="script-kill-target-picker-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©è¦è½¬å‘çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="script-kill-target-list" style="padding: 0;">
            <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button id="sk-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é€‰</button>
            <button id="sk-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é€‰</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-cancel-share-btn">å–æ¶ˆ</button>
            <button class="save" id="sk-confirm-share-btn">ç¡®è®¤è½¬å‘</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯AIå‰§æœ¬ç”Ÿæˆå™¨çš„å¼¹çª—ï¼Œç²˜è´´åˆ°</body>å‰ â–¼â–¼â–¼ -->
<div id="sk-ai-generator-modal" class="modal">
    <div class="modal-content" style="height: 90%;">
        <div class="modal-header">
            <span>AI å‰§æœ¬ç”Ÿæˆå™¨</span>
        </div>
<div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
            
    <div class="form-group">
        <label for="sk-ai-elements-input">æ ¸å¿ƒè¦ç´  (ç”¨é€—å·åˆ†éš”)</label>
        <input type="text" id="sk-ai-elements-input" placeholder="ä¾‹å¦‚ï¼šç°ä»£, è°‹æ€, æš´é£é›ªå±±åº„, é—äº§">
    </div>

    <!-- â–¼â–¼â–¼ ã€è¿™æ˜¯ä½ è¦æ±‚æ–°å¢çš„HTMLã€‘è¯·æŠŠå®ƒç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼ -->
    <div class="form-group">
        <label for="sk-ai-player-count-input">ç©å®¶äººæ•° (åŒ…å«å‡¶æ‰‹, å»ºè®®4-8äºº)</label>
        <input type="number" id="sk-ai-player-count-input" value="5" min="3" max="12" style="width: 100%; box-sizing: border-box; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

    <div class="form-group">
        <label for="sk-ai-summary-input">å‰§æƒ…æ¢—æ¦‚ (å¯é€‰)</label>
        <textarea id="sk-ai-summary-input" rows="4" placeholder="å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„æ•…äº‹å¤§çº²ï¼Œå¸®åŠ©AIæ›´å¥½åœ°ç†è§£ä½ çš„æƒ³æ³•..."></textarea>
    </div>
    <button id="sk-trigger-ai-generation-btn" class="form-button">å¼€å§‹ç”Ÿæˆ</button>
          
            <hr style="opacity: 0.2; margin: 5px 0;">

            <div class="form-group" style="flex-grow: 1; min-height: 0; display: flex; flex-direction: column;">
                <label>AI ç”Ÿæˆç»“æœé¢„è§ˆ</label>
                <div id="sk-ai-result-preview" style="flex-grow: 1; overflow-y: auto; background: #f0f2f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; color: #555;">
                    ç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆâ€åï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="sk-ai-generator-cancel-btn">å…³é—­</button>
            <!-- è¿™ä¸ªä¿å­˜æŒ‰é’®åˆå§‹æ˜¯ç¦ç”¨çš„ï¼Œç”ŸæˆæˆåŠŸåæ‰ä¼šæ¿€æ´» -->
            <button class="save" id="sk-ai-generator-save-btn" disabled>ä¿å­˜å‰§æœ¬</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² å‰§æœ¬æ€åŠŸèƒ½HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² æµ·é¾Ÿæ±¤åŠŸèƒ½HTMLç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆçš„æ‰€æœ‰HTMLä»£ç  â–¼â–¼â–¼ -->

<!-- 1. â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆè®¾ç½®å±å¹• -->
<div id="guess-what-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ä½ è¯´æˆ‘çŒœ - æ¸¸æˆè®¾ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é‚€è¯·ä¸€ä½ç©ä¼´</label>
            <div id="guess-what-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="form-group">
            <label>é€‰æ‹©æ¸¸æˆæ¨¡å¼</label>
            <div style="display: flex; gap: 20px;">
                <label><input type="radio" name="guess_what_mode" value="ai_guesses" checked> æˆ‘å‡ºé¢˜ï¼ŒAIçŒœ</label>
                <label><input type="radio" name="guess_what_mode" value="user_guesses"> AIå‡ºé¢˜ï¼Œæˆ‘çŒœ</label>
            </div>
        </div>
        <!-- "æˆ‘å‡ºé¢˜"æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡† -->
        <div class="form-group" id="user-word-input-container">
            <label for="guess-what-user-word">è¯·è¾“å…¥ä½ è¦å‡ºçš„è¯</label>
            <input type="text" id="guess-what-user-word" placeholder="ä¾‹å¦‚ï¼šè‹¹æœã€æµæµªåœ°çƒ...">
        </div>
        <button id="start-guess-what-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<!-- 2. â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆä¸»ç•Œé¢ -->
<div id="guess-what-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-guess-what-game-btn">â€¹ é€€å‡º</span>
        <span id="guess-what-game-title">ä½ è¯´æˆ‘çŒœ</span>
        <span class="action-btn" id="give-up-guess-what-btn">æ”¾å¼ƒ</span>
    </div>
    <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
    <div id="guess-what-game-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; box-sizing: border-box;">
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div id="guess-what-log-container" style="flex-grow: 1; background-color: rgba(0,0,0,0.05); border-radius: 10px; padding: 10px; overflow-y: auto; margin: 10px 0; min-height: 0;">
            <div id="guess-what-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="guess-what-action-area" class="chat-input-area" style="visibility: visible;">
             <div class="chat-input-main-row">
                <textarea id="guess-what-user-input" rows="1" placeholder="è¾“å…¥æç¤ºæˆ–çŒœæµ‹..."></textarea>
                <button id="send-guess-what-input-btn" class="action-button">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- â–²â–²â–² â€œä½ è¯´æˆ‘çŒœâ€HTMLä»£ç ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆç»“ç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="guess-what-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="guess-what-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="forward-guess-what-summary-btn">è½¬å‘ç»™Ta</button>
            <button class="save" id="close-guess-what-summary-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
 <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯â€œå¿ƒåŠ¨é£è¡Œæ£‹â€çš„æ‰€æœ‰æ–°HTMLä»£ç  â–¼â–¼â–¼ -->

<!-- 1. é£è¡Œæ£‹æ¸¸æˆè®¾ç½®å±å¹• -->
<div id="ludo-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>å¿ƒåŠ¨é£è¡Œæ£‹ - æ¸¸æˆè®¾ç½®</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>é€‰æ‹©ä¸€ä½ç©ä¼´</label>
            <!-- é‚€è¯·åˆ—è¡¨ï¼Œæˆ‘ä»¬ä¼šç”¨JSæ¥å¡«å…… -->
            <div id="ludo-player-selection" class="list-container" style="height: 200px; border: 1px solid var(--border-color); border-radius: 8px;">
            </div>
        </div>
        <!-- â–¼â–¼â–¼ åœ¨ #ludo-setup-screen çš„ "form-container" å†…ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group">
    <label>é€‰æ‹©é—®é¢˜åº“</label>
    <div style="display: flex; align-items: center; gap: 10px;">
        <select id="ludo-question-bank-select" style="flex-grow: 1;"></select>
        <button id="manage-ludo-question-banks-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; width: auto;">ç®¡ç†é¢˜åº“</button>
    </div>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

        <button id="start-ludo-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<!-- 2. é£è¡Œæ£‹æ¸¸æˆä¸»ç•Œé¢ -->
<div id="ludo-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-ludo-game-btn">â€¹ é€€å‡º</span>
        <span>å¿ƒåŠ¨é£è¡Œæ£‹</span>
        <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸€ä¸ªé‡ç½®æ¸¸æˆçš„æŒ‰é’® -->
        <span class="action-btn" id="restart-ludo-game-btn" title="é‡æ–°å¼€å§‹">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
        </span>
    </div>
    <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
    <div id="ludo-game-content">
        <!-- æ£‹ç›˜åŒºåŸŸ -->
        <div id="ludo-board-container">
            <div id="ludo-board">
                <!-- æ£‹ç›˜æ ¼å­å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- ç©å®¶æ£‹å­ -->
            <div id="ludo-user-piece" class="ludo-piece user"></div>
            <div id="ludo-char-piece" class="ludo-piece char"></div>
        </div>

        <!-- æ¸¸æˆæ—¥å¿—åŒºåŸŸ -->
        <div id="ludo-log-container">
            <div id="ludo-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="ludo-action-area">
            <!-- ç”¨æˆ·çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² â€œå¿ƒåŠ¨é£è¡Œæ£‹â€HTMLä»£ç ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ‰¾åˆ°ä½ çš„å¾®åšç§ä¿¡åˆ—è¡¨é¡µé¢ â–¼â–¼â–¼ -->
<div id="weibo-dm-list-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-dm-list">â€¹</span>
        <span id="weibo-dm-list-title">ç²‰ä¸ç§ä¿¡</span>
        <!-- è¿™æ˜¯ä½ è¦æ±‚çš„â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’® -->
        <div class="header-actions">
            <span class="action-btn" id="generate-more-dms-btn" title="ç»§ç»­ç”Ÿæˆç§ä¿¡">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </span>
            
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸ªå…¨æ–°çš„â€œæ¸…ç©ºå…¨éƒ¨â€æŒ‰é’® â–¼â–¼â–¼ -->
            <span class="action-btn" id="clear-all-dms-btn" title="æ¸…ç©ºå…¨éƒ¨ç§ä¿¡">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </span>
            <!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
            
        </div>
    </div>
    <div id="weibo-dm-list" class="list-container" style="padding: 0;">
        <!-- ç§ä¿¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšç§ä¿¡è¯¦æƒ…é¡µé¢ï¼Œè¯·ç²˜è´´åˆ° #phone-screen çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="weibo-dm-detail-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-dm-detail">â€¹</span>
        <span id="weibo-dm-detail-title"></span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ -->
    </div>
    <div id="weibo-dm-messages" class="list-container" style="display: flex; flex-direction: column; gap: 15px; padding: 15px; background-color: #f0f2f5;">
        <!-- èŠå¤©æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ id="taobao-screen" çš„ div â–¼â–¼â–¼ -->
<div id="taobao-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¡ƒå®</span>
        <div class="header-actions">
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°æŒ‰é’® â–¼â–¼â–¼ -->
            <span class="action-btn" id="clear-taobao-products-btn" style="font-size: 16px; font-weight: 500;">æ¸…ç©º</span>
            <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
            <span class="action-btn" id="add-product-btn" title="æ·»åŠ å•†å“">+</span>
        </div>
    </div>

    
    <!-- 1. é¡¶éƒ¨é¡µç­¾å¯¼èˆª -->
    <div class="taobao-tabs">
        <button class="taobao-tab active" data-view="products-view">é¦–é¡µ</button>
        <!-- â˜…â˜…â˜… åœ¨è¿™é‡Œæ–°å¢äº†â€œè´­ç‰©è½¦â€æŒ‰é’® â˜…â˜…â˜… -->
        <button class="taobao-tab" data-view="cart-view">
            è´­ç‰©è½¦<span id="cart-item-count-badge" style="display: none;">0</span>
        </button>
        <button class="taobao-tab" data-view="orders-view">æˆ‘çš„è®¢å•</button>
        <button class="taobao-tab" data-view="my-view">æˆ‘çš„</button>
    </div>

    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="taobao-content">
        <!-- â€œé¦–é¡µâ€è§†å›¾ (ä¿æŒä¸å˜) -->
        <div id="products-view" class="taobao-view active">
          <div class="taobao-search-bar">
            <input type="search" id="product-search-input" placeholder="æœä¸€æœï¼Œè®©AIä¸ºä½ åˆ›é€ å¥½ç‰©ï¼">
            <button id="product-search-btn">æœç´¢</button>
          </div>
            <div id="product-category-tabs"></div>
            <div id="product-grid" class="product-grid"></div>
        </div>

        <!-- â˜…â˜…â˜… â€œè´­ç‰©è½¦â€è§†å›¾ (å…¨æ–°æ·»åŠ ) â˜…â˜…â˜… -->
        <div id="cart-view" class="taobao-view">
            <div id="cart-item-list">
                <!-- è´­ç‰©è½¦å•†å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ cart-checkout-bar â–¼â–¼â–¼ -->
<div id="cart-checkout-bar" style="display: none;">
    <div class="total-price">
        åˆè®¡: <span id="cart-total-price">Â¥ 0.00</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button id="share-cart-to-char-btn">åˆ†äº«ç»™Taä»£ä»˜</button>
        <button id="buy-for-char-btn">ä¸ºTaè´­ä¹°</button> <!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„æŒ‰é’® -->
        <button id="checkout-btn">ç»“ç®—(0)</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        </div>

        <!-- â€œæˆ‘çš„è®¢å•â€è§†å›¾ (ä¿æŒä¸å˜) -->
        <div id="orders-view" class="taobao-view">
            <div id="order-list" class="order-list"></div>
        </div>

        <!-- â€œæˆ‘çš„â€è§†å›¾ (ä¿æŒä¸å˜) -->
        <div id="my-view" class="taobao-view">
            <div id="user-balance-container">
                <p>æˆ‘çš„ä½™é¢</p>
                <h2 id="user-balance-display">Â¥ 0.00</h2>
                <button id="top-up-btn" class="form-button">ç»™é’±åŒ…å……ç‚¹é’±</button>
            </div>
            <div id="balance-details-list" class="order-list" style="padding: 0 15px;"></div>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ è¯„ä»·åŒºã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ id="product-detail-modal" â–¼â–¼â–¼ -->
<div id="product-detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>å•†å“è¯¦æƒ…</span>
        </div>
        <div class="modal-body" id="product-detail-body">
            <!-- è¯¦æƒ…å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- â˜…â˜…â˜… è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„è¯„ä»·åŒºåŸŸ â˜…â˜…â˜… -->
        <div id="product-reviews-section">
            <h3>å®è´è¯„ä»·</h3>
            <div id="product-reviews-list">
                <!-- è¯„ä»·å†…å®¹ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <button id="generate-reviews-btn" class="form-button form-button-secondary">âœ¨ AIç”Ÿæˆè¯„ä»·</button>
        </div>
        <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
        <div class="modal-footer">
            <button class="cancel" id="close-product-detail-btn">å…³é—­</button>
            <button class="save" id="detail-add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- 2. æ·»åŠ å•†å“çš„æ–¹å¼é€‰æ‹©å¼¹çª— -->
<div id="add-product-choice-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-header">é€‰æ‹©æ·»åŠ æ–¹å¼</div>
        <div class="custom-modal-footer">
            <button id="add-product-manual-btn">æ‰‹åŠ¨æ·»åŠ </button>
            <button id="add-product-link-btn">è¯†åˆ«é“¾æ¥</button>
            <button id="add-product-ai-btn">AIç”Ÿæˆ</button>
            <button id="cancel-add-choice-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- 3. æ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘å•†å“å¼¹çª— -->
<div id="product-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="product-editor-title">æ·»åŠ æ–°å•†å“</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="product-name-input">å•†å“åç§°</label>
                <input type="text" id="product-name-input">
            </div>
            <div class="form-group">
                <label for="product-price-input">ä»·æ ¼ (å…ƒ)</label>
                <input type="number" id="product-price-input">
            </div>
            <div class="form-group">
                <label for="product-image-input">å›¾ç‰‡ URL</label>
                <input type="text" id="product-image-input">
            </div>
            <div class="form-group">
                <label for="product-category-input">åˆ†ç±» (é€‰å¡«)</label>
                <input type="text" id="product-category-input" placeholder="ä¾‹å¦‚ï¼šè¡£æœ, é›¶é£Ÿ...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-product-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-product-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- 4. è¯†åˆ«é“¾æ¥å¼¹çª— -->
<div id="add-from-link-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ç²˜è´´åˆ†äº«æ–‡æ¡ˆ</span>
        </div>
        <div class="modal-body">
            <textarea id="link-paste-area" rows="6" placeholder="è¯·åœ¨è¿™é‡Œç²˜è´´å®Œæ•´çš„æ·˜å®æˆ–æ‹¼å¤šå¤šåˆ†äº«æ–‡æ¡ˆ..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-link-paste-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-link-paste-btn">è¯†åˆ«</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘ç‰©æµè¯¦æƒ…é¡µé¢ -->
<div id="logistics-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="logistics-back-btn">â€¹</span>
        <span>ç‰©æµè¯¦æƒ…</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œè®©æ ‡é¢˜å±…ä¸­ -->
    </div>
    <div id="logistics-content-area" class="list-container">
        <!-- ç‰©æµä¿¡æ¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯â€œè°æ˜¯å§åº•â€æ¸¸æˆçš„å…¨éƒ¨HTMLç•Œé¢ï¼Œè¯·ç²˜è´´åˆ° </body> æ ‡ç­¾å‰ â–¼â–¼â–¼ -->

<!-- 1. â€œè°æ˜¯å§åº•â€æ¸¸æˆè®¾ç½®å±å¹• -->
<div id="undercover-setup-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>è°æ˜¯å§åº• - æ¸¸æˆè®¾ç½®</span>
    </div>
<div class="form-container">
    <div class="form-group">
        <label>é‚€è¯·æ¨¡å¼</label>
        <div style="display: flex; gap: 20px;">
            <label style="cursor: pointer;"><input type="radio" name="undercover_invite_mode" value="manual" checked> æ‰‹åŠ¨é‚€è¯·</label>
            <label style="cursor: pointer;"><input type="radio" name="undercover_invite_mode" value="random"> éšæœºé‚€è¯·</label>
        </div>
    </div>

    <!-- éšæœºé‚€è¯·çš„é€‰é¡¹ -->
    <div id="undercover-random-invite-options" style="display: none;">
        <div class="form-group">
            <label for="undercover-random-player-count">ä½ æƒ³é‚€è¯·å‡ ä½AI/NPCï¼Ÿ (ä¸å«ä½ è‡ªå·±)</label>
            <input type="number" id="undercover-random-player-count" min="2" max="15" value="5" style="width: 100%; box-sizing: border-box; padding: 10px;">
        </div>
    </div>

    <!-- æ‰‹åŠ¨é‚€è¯·çš„é€‰é¡¹ -->
    <div id="undercover-manual-invite-options">
        <div class="form-group">
            <label>è¯·å‹¾é€‰è¦é‚€è¯·çš„ç©å®¶</label>
            <div id="undercover-player-selection" class="list-container" style="height: 350px; border: 1px solid var(--border-color); border-radius: 8px;">
                <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <button id="start-undercover-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
    <p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 15px;">
        æ¸¸æˆæœ€å°‘éœ€è¦3äººã€‚<br>
        3-5äººå±€ï¼š1å§åº•<br>
        6-8äººå±€ï¼š1å§åº•, 1ç™½æ¿<br>
        9äººåŠä»¥ä¸Šï¼š2å§åº•, 1ç™½æ¿
    </p>
</div>
</div>

<!-- 2. â€œè°æ˜¯å§åº•â€æ¸¸æˆä¸»ç•Œé¢ -->
<div id="undercover-game-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="exit-undercover-game-btn">â€¹ é€€å‡º</span>
        <span id="undercover-game-title">è°æ˜¯å§åº•</span>
        <span class="action-btn" id="undercover-my-word-btn">æˆ‘çš„è¯è¯­</span>
    </div>
    <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
    <div id="undercover-game-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; box-sizing: border-box;">
        <!-- ç©å®¶åº§ä½åŒº -->
        <div id="undercover-players-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 15px; padding: 10px; flex-shrink: 0;">
            <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div id="undercover-log-container" style="flex-grow: 1; background-color: rgba(0,0,0,0.05); border-radius: 10px; padding: 10px; overflow-y: auto; margin: 10px 0; min-height: 0;">
            <div id="undercover-game-log">
                <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="undercover-action-area" style="flex-shrink: 0; padding: 10px; display: flex; justify-content: center; align-items: center; gap: 15px; min-height: 50px;">
            <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å·²ä¿®æ”¹ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ undercover-summary-modal â–¼â–¼â–¼ -->
<div id="undercover-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="undercover-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†ä¸€ä¸ªâ€œåˆ†äº«å¤ç›˜â€æŒ‰é’® â˜…â˜…â˜… -->
            <button class="cancel" id="repost-undercover-summary-btn">åˆ†äº«å¤ç›˜åˆ°å•èŠ</button>
            <button class="save" id="back-to-hall-from-undercover-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯Userè‡ªå·±çš„ç§ä¿¡åŠŸèƒ½ï¼Œè¯·ç²˜è´´åˆ° <div id="weibo-screen">...</div> ä¹‹å â–¼â–¼â–¼ -->

<!-- 1. Userç§ä¿¡åˆ—è¡¨é¡µé¢ -->
<div id="user-dm-list-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-user-dm-list">â€¹</span>
        <span>æˆ‘çš„ç§ä¿¡</span>
        <div class="header-actions">
            <!-- è¿™ä¸ªæŒ‰é’®ç”¨äºè®©AIç”Ÿæˆæ–°çš„ç²‰ä¸ç§ä¿¡ -->
            <span class="action-btn" id="generate-new-user-dms-btn" title="ç”Ÿæˆæ–°ç§ä¿¡">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </span>
            <!-- è¿™ä¸ªæŒ‰é’®ç”¨äºæ¸…ç©ºæ‰€æœ‰ç§ä¿¡ -->
            <span class="action-btn" id="clear-all-user-dms-btn" title="æ¸…ç©ºæ‰€æœ‰ç§ä¿¡">
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </span>
        </div>
    </div>
    <div id="user-dm-list-container" class="list-container" style="padding: 0;">
        <!-- ç§ä¿¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- 2. Userç§ä¿¡è¯¦æƒ…é¡µé¢ (ä¸ç²‰ä¸èŠå¤©) -->
<div id="user-dm-detail-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-user-dm-detail">â€¹</span>
        <span id="user-dm-detail-title"></span> <!-- ç²‰ä¸åå­— -->
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ -->
    </div>
    <div id="user-dm-messages-container" class="list-container" style="display: flex; flex-direction: column; gap: 15px; padding: 15px; background-color: #f0f2f5;">
        <!-- èŠå¤©æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    <!-- èŠå¤©è¾“å…¥æ¡† -->
<!-- â–¼â–¼â–¼ ã€V2ç‰ˆã€‘èŠå¤©è¾“å…¥æ¡† (å·²æ·»åŠ æ–°æŒ‰é’®) â–¼â–¼â–¼ -->
<div id="user-dm-input-area" class="chat-input-area">
    <div class="chat-input-main-row">
        <textarea id="user-dm-input" rows="1" placeholder="å’Œç²‰ä¸èŠç‚¹ä»€ä¹ˆ..."></textarea>
        <!-- æˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°çš„å®¹å™¨æŠŠæ‰€æœ‰æ“ä½œæŒ‰é’®åŒ…èµ·æ¥ -->
        <div id="input-actions-wrapper">
            <!-- è¿™æ˜¯æ–°åŠ çš„â€œè§¦å‘AIå›åº”â€æŒ‰é’® -->
            <button id="user-dm-trigger-ai-btn" class="action-button chat-action-icon-btn" title="è®©å¯¹æ–¹å…ˆè¯´">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>
            <!-- è¿™æ˜¯æ–°åŠ çš„â€œé‡Rollâ€æŒ‰é’® -->
            <button id="user-dm-reroll-btn" class="action-button chat-action-icon-btn" title="é‡æ–°ç”Ÿæˆå›å¤">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            </button>
            <!-- è¿™æ˜¯ä½ åŸæ¥çš„å‘é€æŒ‰é’® -->
            <button id="user-dm-send-btn" class="action-button">å‘é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
</div>

<!-- â–²â–²â–² å…¨æ–°çš„ User ç§ä¿¡åŠŸèƒ½ HTML ç»“æ„ç»“æŸ â–²â–²â–² -->


<!-- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšä¸»é¡µå±å¹• -->
<div id="weibo-char-profile-screen" class="screen">
    <!-- å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œè§’è‰²åå­— -->
    <div class="header">
        <span class="back-btn" id="back-from-char-profile">â€¹</span>
        <span id="weibo-char-profile-title">è§’è‰²ä¸»é¡µ</span>
        <div class="header-actions">
            <!-- ä¸ºè§’è‰²ä¸»é¡µä¹Ÿæ·»åŠ ä¸€ä¸ªç¼–è¾‘æŒ‰é’® -->
            <span class="action-btn" id="edit-char-weibo-profile-btn" title="ç¼–è¾‘è§’è‰²èµ„æ–™">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
            </span>
        </div>
    </div>
    <!-- è§’è‰²ä¸»é¡µçš„å†…å®¹åŒº -->
    <div id="weibo-char-profile-page" class="weibo-profile-page"> <!-- å¤ç”¨ä¸ªäººä¸»é¡µçš„æ»šåŠ¨æ ·å¼ -->
        <div class="weibo-profile-header">
            <img id="weibo-char-background-img" src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg" class="weibo-background">
            <div class="weibo-avatar-container">
                <img id="weibo-char-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" class="weibo-avatar">
                <img id="weibo-char-avatar-frame" class="weibo-avatar-frame" src="" style="display: none;">
            </div>
            <div class="weibo-nickname" id="weibo-char-nickname">è§’è‰²æ˜µç§°</div>
            <div id="weibo-char-profession-display">è§’è‰²èŒä¸š</div>
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ id="weibo-char-profile-page" é‡Œé¢é‚£ä¸ªæ—§çš„ã€åªæœ‰æ³¨é‡Šçš„ <div class="weibo-stats"> â–¼â–¼â–¼ -->
<div class="weibo-stats">
    <div id="weibo-char-following-item" class="weibo-stat-item" style="cursor: pointer;">
        <span id="weibo-char-following-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">å…³æ³¨</span>
    </div>
    <div id="weibo-char-posts-item" class="weibo-stat-item">
        <span id="weibo-char-posts-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">å¾®åš</span>
    </div>
    <div id="weibo-char-fans-item" class="weibo-stat-item" style="cursor: pointer;">
        <span id="weibo-char-fans-count" class="weibo-stat-number">0</span>
        <span class="weibo-stat-label">ç²‰ä¸</span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        </div>
        <div id="char-weibo-feed-list" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
            <!-- è§’è‰²çš„å¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšèµ„æ–™ç¼–è¾‘å¼¹çª— -->
<div id="char-weibo-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ç¼–è¾‘è§’è‰²å¾®åšèµ„æ–™</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å¾®åšå¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="char-weibo-editor-avatar-preview">
                    <button onclick="document.getElementById('char-weibo-editor-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
                    <button class="change-frame-btn" data-type="char-weibo">æ›´æ¢å¤´åƒæ¡†</button>
                    <input type="file" id="char-weibo-editor-avatar-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label for="char-weibo-editor-nickname-input">å¾®åšæ˜µç§°</label>
                <input type="text" id="char-weibo-editor-nickname-input">
            </div>
            <div class="form-group">
                <label>å¾®åšèƒŒæ™¯</label>
                <div class="avatar-upload">
                    <img id="char-weibo-editor-bg-preview" style="width: 120px; height: 67.5px; border-radius: 8px;">
                    <button onclick="document.getElementById('char-weibo-editor-bg-input').click()">ä¸Šä¼ èƒŒæ™¯</button>
                    <input type="file" id="char-weibo-editor-bg-input" accept="image/*" hidden>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-char-weibo-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-char-weibo-editor-btn">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å·²æ·»åŠ æ–°æŒ‰é’®ã€‘çš„ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ id="date-a-live-screen" â–¼â–¼â–¼ -->
<div id="date-a-live-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>çº¦ä¼šå¤§ä½œæˆ˜</span>
        <div class="header-actions">

            <!-- â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä½ æ–°å¢çš„â€œ+â€å·æŒ‰é’® â˜…â˜…â˜…â˜…â˜… -->
            <span class="action-btn" id="create-dating-scene-btn" title="åˆ›å»ºæ–°åœºæ™¯">
                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </span>
            <!-- â˜…â˜…â˜…â˜…â˜… æ–°å¢ç»“æŸ â˜…â˜…â˜…â˜…â˜… -->

            <span class="action-btn" id="dating-history-btn" title="å†å²çº¦ä¼š">
                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <polyline points="3 3 3 8 8 8"/>
                    <path d="M12 6V12L16 14"/>
                 </svg>
            </span>
            <span class="action-btn" id="refresh-dating-scene-btn" title="åˆ·æ–°åœºæ™¯">
                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            </span>
        </div>
    </div>
    <div id="dating-scene-content" class="list-container">
        <!-- çº¦ä¼šåœºæ™¯å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->




<!-- â–¼â–¼â–¼ ã€å¢å¼ºç‰ˆã€‘å® ç‰©åŠŸèƒ½æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="pet-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 85%;">
        <div class="modal-header">
            <span id="pet-modal-title">æˆ‘çš„å® ç‰©</span>
        </div>
        <div class="modal-body">
            <!-- å® ç‰©ä¿¡æ¯é¢„è§ˆåŒº -->
            <div id="pet-preview-area" style="text-align: center; margin-bottom: 20px;">
                <div id="pet-preview-display" style="font-size: 60px; line-height: 1; margin-bottom: 10px; cursor: pointer;" title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡"></div>
                <strong id="pet-preview-name" style="font-size: 18px;"></strong>
                <p id="pet-preview-type" style="font-size: 14px; color: var(--text-secondary); margin: 5px 0;"></p>
            </div>

            <!-- å® ç‰©æ•°å€¼æ˜¾ç¤ºåŒº -->
            <div id="pet-stats-area" style="display: none;">
                <div id="pet-hunger-bar" class="stat-bar-container">
                    <span class="stat-label">é¥±é£Ÿåº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
                </div>
                <div id="pet-happiness-bar" class="stat-bar-container">
                    <span class="stat-label">å¿ƒæƒ…å€¼</span>
                    <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
                </div>
                <div id="pet-intimacy-user-bar" class="stat-bar-container">
                    <span class="stat-label">å¯¹ä½ çš„äº²å¯†åº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
                </div>
                <div id="pet-intimacy-char-bar" class="stat-bar-container">
                    <span class="stat-label">å¯¹Taçš„äº²å¯†åº¦</span>
                    <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
                </div>
            </div>

            <!-- äº’åŠ¨æŒ‰é’®åŒº (å·²æ–°å¢â€œå¯¹è¯â€æŒ‰é’®) -->
            <div id="pet-interaction-area" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                <button class="form-button-secondary" data-action="feed">å–‚é£Ÿ</button>
                <button class="form-button-secondary" data-action="play">ç©è€</button>
                <button class="form-button-secondary" data-action="touch">æŠšæ‘¸</button>
                <button class="form-button-secondary" data-action="chat">å¯¹è¯</button>
            </div>
            
            <!-- è®¾ç½®åŒº -->
            <div class="form-group">
                <label for="pet-type-input">ç§ç±» (è‡ªç”±å¡«å†™)</label>
                <input type="text" id="pet-type-input" placeholder="ä¾‹å¦‚: å°çŒ«, ä»“é¼ , å¤ªé˜³èŠ±...">
            </div>
             <div class="form-group">
                <label for="pet-name-input">æ˜µç§°</label>
                <input type="text" id="pet-name-input" placeholder="ç»™å®ƒèµ·ä¸ªåå­—å§">
            </div>
             <div class="form-group">
                <label for="pet-image-input">åˆå§‹æ ·å­ (Emoji æˆ– å›¾ç‰‡URL)</label>
                <input type="text" id="pet-image-input" placeholder="è¾“å…¥ä¸€ä¸ª Emoji æ¯”å¦‚ ğŸˆ æˆ–å›¾ç‰‡é“¾æ¥">
            </div>
            <!-- ã€å…¨æ–°ã€‘äººè®¾è¾“å…¥æ¡† -->
            <div class="form-group">
                <label for="pet-persona-input">å® ç‰©äººè®¾ä¸èƒŒæ™¯</label>
                <textarea id="pet-persona-input" rows="3" placeholder="æè¿°ä¸€ä¸‹å®ƒçš„æ€§æ ¼å’Œæ•…äº‹ï¼ŒAIä¼šæ ¹æ®è¿™ä¸ªæ¥æ‰®æ¼”å®ƒã€‚"></textarea>
            </div>
            <div class="form-group">
                <label class="toggle-switch-label">
                    <span>åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º</span>
                    <input type="checkbox" id="pet-display-toggle">
                    <span class="toggle-switch-slider"></span>
                </label>
            </div>
            <div id="pet-position-controls" style="display:none;">
                <div class="form-group">
                    <label for="pet-size-slider">å¤§å°: <span id="pet-size-value">100px</span></label>
                    <input type="range" id="pet-size-slider" min="30" max="200" value="100" style="width: 100%;">
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°æŒ‰é’® â–¼â–¼â–¼ -->
            <button class="cancel" id="pet-abandon-btn" style="background-color: #ffdde5; color: #ff3b30; border-color: #ffc2d1;">æ”¾ç”Ÿå® ç‰©</button>
            <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
            <button class="cancel" id="pet-modal-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="pet-modal-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<input type="file" id="pet-custom-image-input" accept="image/*" style="display: none;">
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©èŠå¤©æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="pet-chat-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="pet-chat-title">å’Œå® ç‰©çš„å¯¹è¯</span>
        </div>
        <div id="pet-chat-messages" class="modal-body" style="background-color: #f0f2f5; display: flex; flex-direction: column; gap: 15px;">
            <!-- å® ç‰©èŠå¤©è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <!-- å¤ç”¨ä¸»èŠå¤©è¾“å…¥æ¡†çš„æ ·å¼ -->
        <div id="pet-chat-input-area" class="chat-input-area" style="border-top: 1px solid var(--border-color);">
            <div class="chat-input-main-row">
                <textarea id="pet-chat-input" rows="1" placeholder="å’Œå®ƒè¯´ç‚¹ä»€ä¹ˆ..."></textarea>
                <button id="send-to-pet-btn" class="action-button">å‘é€</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->

<!-- â–²â–²â–² å® ç‰©åŠŸèƒ½æ¨¡æ€æ¡†ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¾®åšä¸“ç”¨çš„ã€æ”¯æŒå¤šé€‰å’Œæ»šåŠ¨çš„è§’è‰²é€‰æ‹©å¼¹çª— â–¼â–¼â–¼ -->
<div id="weibo-char-selector-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é€‰æ‹©ç”Ÿæˆå†…å®¹çš„ä¸»è§’</span>
        </div>
        <div class="modal-body" id="weibo-char-selector-list" style="padding: 0; overflow-y: auto;">
            <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            <button id="weibo-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é€‰</button>
            <button id="weibo-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é€‰</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="weibo-cancel-char-select-btn">å–æ¶ˆ</button>
            <button class="save" id="weibo-confirm-char-select-btn">ç¡®è®¤</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ç»ªæ—¥è®°ç¼–è¾‘å¼¹çª— -->
<div id="ls-diary-editor-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="ls-diary-editor-title">è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é€‰æ‹©ä¸€ä¸ªè¡¨æƒ…ä»£è¡¨ä»Šå¤©çš„å¿ƒæƒ…</label>
                <div id="ls-emoji-selector" style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 24px; cursor: pointer; justify-content: center; padding: 10px 0;">
                    <!-- Emojiå°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>
            <div class="form-group">
                <label for="ls-diary-content-input">å†™ä¸‹ä½ çš„æ—¥è®°</label>
                <textarea id="ls-diary-content-input" rows="6" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆç‰¹åˆ«çš„äº‹å—..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ls-cancel-diary-btn">å–æ¶ˆ</button>
            <button class="save" id="ls-save-diary-btn">ä¿å­˜æ—¥è®°</button>
        </div>
    </div>
</div>

<!-- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æ—¥è®°æŸ¥çœ‹å¼¹çª— -->
<div id="ls-diary-viewer-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span id="ls-diary-viewer-title">æŸ¥çœ‹æ—¥è®°</span>
        </div>
        <div id="ls-diary-viewer-body" class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
            <!-- æ—¥è®°å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="ls-close-diary-viewer-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ summary-viewer-modal â–¼â–¼â–¼ -->
<div id="summary-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="summary-viewer-title">èŠå¤©æ€»ç»“</span>
        </div>
        <div class="modal-body" id="summary-list" style="padding: 15px;">
            <!-- æ€»ç»“åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px;">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œæ–°å¢äº†â€œå…¨éƒ¨ç²¾ç®€â€æŒ‰é’® -->
            <button class="form-button-secondary" id="concise-all-summaries-btn" style="flex: 1; margin: 0;">å…¨éƒ¨ç²¾ç®€</button>
            <button class="save" id="close-summary-viewer-btn" style="flex: 1; margin: 0;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘AIç”Ÿæˆå•†å“ç»“æœ/é€‰æ‹©å¼¹çª— -->
<div id="ai-generated-products-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="ai-products-modal-title">AIä¸ºä½ ç”Ÿæˆäº†ä»¥ä¸‹å®è´</span>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-product-results-grid" class="product-grid">
                <!-- AIç”Ÿæˆçš„å•†å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-products-modal-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘é£è¡Œæ£‹é—®é¢˜åº“ç®¡ç†æ¨¡æ€æ¡† (å·²ä¿®æ”¹) -->
<div id="ludo-qbank-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ç®¡ç†é—®é¢˜åº“</span>
            <!-- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼ -->
            <div class="header-actions">
                <span class="action-btn" id="import-ludo-qbank-btn" title="å¯¼å…¥é¢˜åº“">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </span>
                <span class="action-btn" id="add-ludo-qbank-btn" style="font-size: 16px;">æ–°å»º</span>
            </div>
            <!-- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² -->
        </div>
        <div class="modal-body" id="ludo-qbank-list" style="padding: 0;">
            <!-- é—®é¢˜åº“åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-qbank-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>


<!-- ã€å…¨æ–°ã€‘é£è¡Œæ£‹é—®é¢˜ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
<div id="ludo-question-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span class="back-btn" id="back-to-qbank-manager-btn">â€¹</span>
            <span id="ludo-question-editor-title">ç¼–è¾‘é—®é¢˜</span>
            <span class="action-btn" id="add-ludo-question-btn" style="font-size: 28px; font-weight: 300;">+</span>
        </div>
        <div class="modal-body" id="ludo-question-list" style="padding: 10px;">
            <!-- é—®é¢˜åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼ -->
<!-- ã€å…¨æ–°ã€‘é£è¡Œæ£‹å•ä¸ªé—®é¢˜ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
<div id="ludo-single-question-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="ludo-single-question-title">ç¼–è¾‘é—®é¢˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ludo-question-text-input">é—®é¢˜å†…å®¹</label>
                <textarea id="ludo-question-text-input" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>é—®é¢˜ç±»å‹</label>
                <div style="display: flex; gap: 20px;">
                    <label><input type="radio" name="ludo_question_type" value="both_answer" checked> å…±åŒå›ç­”</label>
                    <label><input type="radio" name="ludo_question_type" value="single_answer"> ä¸€äººå›ç­”,ä¸€äººè¯„ä»·</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-single-question-btn">å–æ¶ˆ</button>
            <button class="save" id="save-single-question-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯é£è¡Œæ£‹æ¸¸æˆç»“ç®—å¡ç‰‡ï¼Œè¯·ç²˜è´´åˆ° </body> æ ‡ç­¾å‰ â–¼â–¼â–¼ -->
<div id="ludo-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="ludo-summary-content" style="text-align: left; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="share-ludo-summary-btn">åˆ†äº«ç»™Ta</button>
            <button class="save" id="back-to-hall-from-ludo-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œè°æ˜¯å§åº•â€æ¸¸æˆç»“ç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="undercover-summary-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 80%;">
        <div class="modal-header">
            <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div class="modal-body" id="undercover-summary-content" style="white-space: pre-wrap; line-height: 1.7;">
            <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„â€œåˆ†äº«å¤ç›˜â€æŒ‰é’® -->
            <button class="cancel" id="repost-undercover-summary-btn">åˆ†äº«å¤ç›˜åˆ°å•èŠ</button>
            <button class="save" id="back-to-hall-from-undercover-btn">è¿”å›å¤§å…</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ åœ¨ </body> æ ‡ç­¾å‰ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—ã€å…¨æ–°çš„ã€‘HTMLä»£ç  â–¼â–¼â–¼ -->
<!-- â€œè°æ˜¯å§åº•â€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
<div id="undercover-target-picker-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©è¦å‘é€çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="undercover-target-list" style="padding: 0;">
            <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button id="uc-select-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨é€‰</button>
            <button id="uc-deselect-all-btn" class="form-button-secondary" style="width: 45%; margin: 0;">å…¨ä¸é€‰</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="uc-cancel-share-btn">å–æ¶ˆ</button>
            <button class="save" id="uc-confirm-share-btn">ç¡®è®¤å‘é€</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘Šæ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="group-announcement-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ç¾¤å…¬å‘Š</span>
        </div>
        <div class="modal-body" id="announcement-content-area">
            <!-- å…¬å‘Šå†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" id="announcement-footer">
            <!-- æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¿ƒå£°é¢æ¿çš„æ ·å¼ç¼–è¾‘å™¨å¼¹çª— â–¼â–¼â–¼ -->
<div id="inner-voice-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ç¼–è¾‘å¿ƒå£°é¢æ¿æ ·å¼</span>
        </div>
        <div class="modal-body">
            <!-- å¡ç‰‡èƒŒæ™¯é¢œè‰² -->
            <div class="form-group">
                <label for="iv-card-bg-color">å¡ç‰‡èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="iv-card-bg-color" value="#FFFFFF" style="width: 100%; height: 40px;">
            </div>
            <!-- å¡ç‰‡é€æ˜åº¦ -->
            <div class="form-group">
                <label for="iv-opacity-slider">å¡ç‰‡èƒŒæ™¯é€æ˜åº¦: <span id="iv-opacity-value">70%</span></label>
                <input type="range" id="iv-opacity-slider" min="0" max="1" step="0.05" value="0.7" style="width: 100%;">
            </div>
            <hr style="opacity: 0.2;">
            <!-- å››ä¸ªæ ‡ç­¾çš„èƒŒæ™¯è‰² -->
            <div class="form-group">
                <label for="iv-color-clothing">â€œæœè£…â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
                <input type="color" id="iv-color-clothing" value="#f0a1a8" style="width: 100%; height: 40px;">
            </div>
            <div class="form-group">
                <label for="iv-color-behavior">â€œè¡Œä¸ºâ€æ ‡ç­¾èƒŒæ™¯è‰²</label>
                <input type="color" id="iv-color-behavior" value="#81c784" style="width: 100%; height: 40px;">
            </div>
            <div class="form-group">
                <label for="iv-color-thoughts">â€œå¿ƒå£°â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
                <input type="color" id="iv-color-thoughts" value="#64b5f6" style="width: 100%; height: 40px;">
            </div>
            <div class="form-group">
                <label for="iv-color-naughty">â€œåå¿ƒæ€â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
                <input type="color" id="iv-color-naughty" value="#ba68c8" style="width: 100%; height: 40px;">
            </div>
            <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<hr style="opacity: 0.2; margin: 20px 0;">
<div class="form-group">
    <label for="iv-icon-color">å›¾æ ‡é¢œè‰²</label>
    <input type="color" id="iv-icon-color" value="#ff8a80" style="width: 100%; height: 40px;">
</div>
<!-- â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="iv-editor-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="iv-editor-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„HTMLä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘AIç”Ÿæˆç¾¤æˆå‘˜æ¨¡æ€æ¡† -->
<div id="ai-generate-members-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>AI ç”Ÿæˆç¾¤æˆå‘˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ai-member-count-input">ç”Ÿæˆäººæ•° (1-20)</label>
                <input type="number" id="ai-member-count-input" value="3" min="1" max="20">
            </div>
            <div class="form-group">
                <label for="ai-member-prompt-input">è¦æ±‚ (å¯é€‰ï¼ŒAIä¼šå‚è€ƒ)</label>
                <textarea id="ai-member-prompt-input" rows="4" placeholder="ä¾‹å¦‚ï¼šä¸€ç¾¤å–œæ¬¢æˆ·å¤–æ¢é™©çš„å¤§å­¦ç”Ÿï¼Œæ€§æ ¼å„å¼‚..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-ai-generate-members-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-ai-generate-members-btn">å¼€å§‹ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šé‚€è¯·ä¸æ”¯ä»˜æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="dating-payment-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span id="dating-modal-title">å‘èµ·çº¦ä¼šé‚€è¯·</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p>ä½ é€‰æ‹©çš„çº¦ä¼šæ˜¯ï¼š</p>
            <h3 id="dating-modal-scene-name" style="color: var(--accent-color); margin: 10px 0;"></h3>
            <p id="dating-modal-scene-cost" style="font-weight: bold;"></p>
            <hr style="opacity: 0.2; margin: 20px 0;">
            <p>ç”±è°æ¥ä¹°å•å‘¢ï¼Ÿ</p>
            <div id="dating-payment-options" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- æ”¯ä»˜é€‰é¡¹æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="dating-cancel-btn" style="width:100%;">ä¸‹æ¬¡å†è¯´</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šè§’è‰²é€‰æ‹©å¼¹çª— â–¼â–¼â–¼ -->
<div id="dating-char-selector-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>é€‰æ‹©çº¦ä¼šå¯¹è±¡</span>
        </div>
        <div class="modal-body" id="dating-char-selector-list" style="padding: 0;">
            <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="dating-cancel-char-select-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ id="dating-game-screen" çš„ div â–¼â–¼â–¼ -->
<div id="dating-game-screen" class="screen">
    <!-- 1. åŠ¨æ€èƒŒæ™¯å›¾ (æœ€åº•å±‚) -->
    <div id="dating-game-background"></div>

    <!-- 2. è§’è‰²ç«‹ç»˜å®¹å™¨ (ä¸­é—´å±‚) -->
    <div id="dating-game-sprite-container">
        <img id="dating-game-sprite" src="">
    </div>

    <!-- 3. UIè¦†ç›–å±‚ (æœ€é¡¶å±‚, åŒ…å«å¤´éƒ¨/æ–‡æœ¬æ¡†/é€‰é¡¹) -->
    <div class="dating-game-ui-overlay">
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å·²æ·»åŠ å¿ƒå½¢UIã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ id="dating-game-screen" é‡Œçš„é‚£ä¸ª .header â–¼â–¼â–¼ -->
<div class="header">
    <span class="back-btn" id="end-date-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>

    <span id="dating-game-char-name"></span>
    <div class="header-actions">

        <!-- â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„å¿ƒå½¢æ•°å€¼æ¡ â˜…â˜…â˜…â˜…â˜… -->
        <div id="dating-values-container">
            <div id="romance-value" class="value-display">
                <!-- æˆ‘ä»¬ä¼šç”¨JSåœ¨è¿™é‡Œç”Ÿæˆ5ä¸ªç²‰è‰²å¿ƒå½¢ -->
            </div>
            <div id="lust-value" class="value-display">
                <!-- æˆ‘ä»¬ä¼šç”¨JSåœ¨è¿™é‡Œç”Ÿæˆ5ä¸ªé»„è‰²å¿ƒå½¢ -->
            </div>
        </div>
        <!-- â˜…â˜…â˜…â˜…â˜… æ–°å¢HTMLç»“æŸ â˜…â˜…â˜…â˜…â˜… -->

        <span class="action-btn" id="dating-game-settings-btn" title="åœºæ™¯è®¾ç½®">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </span>
        <span class="action-btn" id="dating-game-reroll-btn" title="é‡Rollå›åº”">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
        </span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


        <!-- 3b. åº•éƒ¨æ–‡æœ¬æ¡† -->
        <div class="dating-game-textbox">
            <p id="dating-game-text-content">çº¦ä¼šå³å°†å¼€å§‹...</p>
        </div>
<div id="dating-completion-bar-container">
    <div id="dating-completion-bar-fill"></div>
    <span id="dating-completion-text">0%</span>
</div>
        <!-- 3c. ç©å®¶æ“ä½œåŒº -->
        <div id="dating-game-choices" class="dating-game-choices">
            <!-- é€‰é¡¹æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->



<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å€Ÿé’±å¯¹è±¡é€‰æ‹©å¼¹çª—ï¼ˆå¸¦æ»šåŠ¨å’Œå¤´åƒï¼‰â–¼â–¼â–¼ -->
<div id="borrow-money-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>å‘è°å€Ÿé’±ï¼Ÿ</span>
        </div>
        <div class="modal-body" id="borrow-money-char-list" style="padding: 0; overflow-y: auto;">
            <!-- å€Ÿé’±å¯¹è±¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="borrow-money-cancel-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™å—ã€ç«‹ç»˜åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ id="dating-game-settings-modal" â–¼â–¼â–¼ -->
<div id="dating-game-settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>çº¦ä¼šåœºæ™¯è®¾ç½®</span>
        </div>
        <div class="modal-body">
            <!-- é¢„è®¾ç®¡ç† (ä¿æŒä¸å˜) -->
            <div class="form-group">
                <label>é¢„è®¾æ–¹æ¡ˆ</label>
                <div class="bubble-preset-manager">
                    <select id="dating-preset-select" class="form-group select"></select>
                    <button id="manage-dating-presets-btn" class="action-btn">ç®¡ç†</button>
                </div>
            </div>

            <hr style="opacity: 0.2;">
            
            <!-- â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šç«‹ç»˜ç»„é€‰æ‹©å™¨ â˜…â˜…â˜… -->
            <div class="form-group">
                <label>é€‰æ‹©è§’è‰²ç«‹ç»˜ç»„</label>
                <div class="bubble-preset-manager">
                    <select id="dating-sprite-group-select" class="form-group select">
                        <option value="">-- ä¸ä½¿ç”¨ç«‹ç»˜ --</option>
                        <!-- ç«‹ç»˜ç»„å°†ç”±JSåŠ¨æ€å¡«å…… -->
                    </select>
                    <button id="manage-sprite-groups-btn" class="action-btn">ç®¡ç†ç«‹ç»˜ç»„</button>
                </div>
            </div>
            <!-- â˜…â˜…â˜… æ–°å¢ç»“æŸ â˜…â˜…â˜… -->

            <hr style="opacity: 0.2;">

            <!-- æ ¸å¿ƒè®¾ç½® (ä¿æŒä¸å˜) -->
            <div class="form-group">
                <label for="dating-prompt-input">åœºæ™¯/è§’è‰²æç¤ºè¯ (Prompt)</label>
                <textarea id="dating-prompt-input" rows="4" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå‚²å¨‡ä½†å†…å¿ƒæ¸©æŸ”çš„å°‘å¥³ï¼Œåœ¨æµ·è¾¹å¯¹ç”¨æˆ·çš„è¡¨ç™½æ„Ÿåˆ°ä¸çŸ¥æ‰€æª..."></textarea>
            </div>
            <div class="form-group">
                <label for="dating-style-input">æ–‡é£ (Style)</label>
                <textarea id="dating-style-input" rows="3" placeholder="ä¾‹å¦‚ï¼šè¯·ä½¿ç”¨ç»†è…»çš„å¿ƒç†æå†™å’Œä¼˜ç¾çš„é£æ™¯æå†™..."></textarea>
            </div>
            <div class="form-group">
                <label>çº¦ä¼šèƒŒæ™¯å›¾</label>
                <div class="bg-upload-container">
                    <button class="form-button-secondary" onclick="document.getElementById('dating-bg-upload-input').click()" style="margin-top:0;">ä¸Šä¼ å›¾ç‰‡</button>
                    <input type="text" id="dating-bg-url-input" placeholder="æˆ–ç²˜è´´ç½‘ç»œå›¾ç‰‡URL" style="flex-grow:1;">
                </div>
                 <input type="file" id="dating-bg-upload-input" accept="image/*" hidden>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-dating-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-dating-settings-btn">åº”ç”¨å¹¶ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ </body> å‰ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤å—å…¨æ–°çš„å¼¹çª—HTML â–¼â–¼â–¼ -->

<!-- 1. ã€å…¨æ–°ã€‘ç«‹ç»˜ç»„ç®¡ç†å¼¹çª— -->
<div id="sprite-group-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†ç«‹ç»˜ç»„</span>
            <span class="action-btn" id="create-new-sprite-group-btn" style="font-size: 16px;">æ–°å»º</span>
        </div>
        <div class="modal-body" id="sprite-group-list-container" style="padding: 0;">
            <!-- ç«‹ç»˜ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-sprite-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- 2. ã€å…¨æ–°ã€‘ç«‹ç»˜ç»„ç¼–è¾‘å™¨å¼¹çª— -->
<div id="sprite-editor-modal" class="modal">
    <div class="modal-content" style="height: 90%;">
        <div class="modal-header">
            <span id="sprite-editor-title">ç¼–è¾‘ç«‹ç»˜ç»„</span>
        </div>
        <div class="modal-body" id="sprite-editor-body">
            <div class="form-group">
                <label for="sprite-group-name-input">ç«‹ç»˜ç»„åç§°</label>
                <input type="text" id="sprite-group-name-input" placeholder="ä¾‹å¦‚ï¼šæ—¥å¸¸ã€æˆ˜æ–—ã€å®³ç¾...">
            </div>
            <hr style="opacity: 0.2;">
            <label>ç«‹ç»˜åˆ—è¡¨</label>
            <div id="sprite-list-editor" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                <!-- å•ä¸ªç«‹ç»˜çš„ç¼–è¾‘å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="add-new-sprite-btn" class="form-button form-button-secondary" style="margin-top: 20px;">+ æ·»åŠ ä¸€ä¸ªæ–°ç«‹ç»˜</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sprite-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-sprite-editor-btn">ä¿å­˜ç«‹ç»˜ç»„</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ çº¦ä¼šç»“ç®—å¡ç‰‡ â–¼â–¼â–¼ -->
<div id="dating-summary-overlay" class="modal">
    <div class="dating-summary-card">
        <div class="dating-summary-card-inner">
            <!-- å¡ç‰‡æ­£é¢ -->
            <div class="card-front">
                <img id="summary-card-avatar" src="" alt="è§’è‰²å¤´åƒ">
                <h2 id="summary-card-rating"></h2>
                <p class="summary-card-tip">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹å®Œæ•´çº¦ä¼šè®°å½•</p>
                <div class="summary-card-actions">
                    <button id="summary-share-btn">åˆ†äº«ç»™Ta</button>
                    <button id="summary-close-btn">å…³é—­</button>
                </div>
            </div>
            <!-- å¡ç‰‡èƒŒé¢ -->
            <div class="card-back">
                <div class="card-back-header">
                    <span>å®Œæ•´çº¦ä¼šè®°å½•</span>
                    <button id="summary-flip-back-btn">è¿”å›</button>
                </div>
                <div id="summary-card-history" class="card-back-content">
                    <!-- çº¦ä¼šå†å²è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
    </div>
</div>


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºçº¦ä¼šç»“ç®—å¡ç‰‡åˆ†äº«åŠŸèƒ½æ–°å¢çš„HTML â–¼â–¼â–¼ -->
<input type="file" id="dating-summary-image-upload" accept="image/*" hidden>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° </body> æ ‡ç­¾çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ -->

<!-- ã€å…¨æ–°ã€‘çº¦ä¼šå†å²è®°å½•ç•Œé¢ -->
<div id="dating-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="dating-history-back-btn">â€¹</span>
        <span>å†å²çº¦ä¼š</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
    </div>
    <div id="dating-history-list" class="list-container">
        <!-- å†å²çº¦ä¼šå¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–²â–²â–² æ–°å¢HTMLä»£ç ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¼˜åŒ–æç¤ºã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„åˆ›å»ºåœºæ™¯å¼¹çª— â–¼â–¼â–¼ -->
<div id="create-dating-scene-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>åˆ›å»ºçº¦ä¼šåœºæ™¯</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="scene-name-input">åœºæ™¯åç§°</label>
                <input type="text" id="scene-name-input" placeholder="ä¾‹å¦‚ï¼šæœˆå…‰ä¸‹çš„æµ·æ»©æ¼«æ­¥">
            </div>
            <div class="form-group">
                <label for="scene-image-url-input">å›¾ç‰‡ URL (å¯é€‰)</label>
                <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°äº† placeholder æç¤ºæ–‡å­— â˜…â˜…â˜… -->
                <input type="text" id="scene-image-url-input" placeholder="ç•™ç©ºåˆ™ç”±AIæ ¹æ®åœºæ™¯åç”Ÿæˆå›¾ç‰‡...">
            </div>
            <div class="form-group">
                <label for="scene-cost-input">èŠ±è´¹ (é‡‘å¸)</label>
                <input type="number" id="scene-cost-input" placeholder="ä¾‹å¦‚ï¼š520">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-scene-btn">å–æ¶ˆ</button>
            <button class="save" id="save-custom-scene-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨ </body> å‰ç²˜è´´è¿™ä¸ªæ–°çš„è¡¨æƒ…åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="sticker-category-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 70%;">
        <div class="modal-header">
            <span>ç§»åŠ¨è¡¨æƒ…åˆ°åˆ†ç±»</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>é€‰æ‹©ä¸€ä¸ªç°æœ‰åˆ†ç±»</label>
                <div id="sticker-category-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 5px;">
                    <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <p style="text-align: center; color: var(--text-secondary); margin: 10px 0;">æˆ–</p>
            <div class="form-group">
                <label for="new-sticker-category-input">åˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»</label>
                <input type="text" id="new-sticker-category-input" placeholder="è¾“å…¥æ–°åˆ†ç±»çš„åç§°...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-sticker-category-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-sticker-category-btn">ç¡®è®¤ç§»åŠ¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->



<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ inner-voice-modal â–¼â–¼â–¼ -->
<div id="inner-voice-modal" class="modal">
    <!-- å¿ƒå£°ä¸»é¢æ¿ -->
    <div id="inner-voice-main-panel" class="modal-content" style="width: 90%; max-width: 340px; height: auto; max-height: 80%; background-color: #fffafb; border: 1px solid #ffe4e1;">
<!-- â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ <div class="modal-header">...</div> â–¼â–¼â–¼ -->
<div class="modal-header" style="border-bottom: 1px solid #ffe4e1; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
    <span id="close-inner-voice-modal" style="cursor: pointer; font-size: 24px;">Ã—</span>
    
    <div style="display: flex; align-items: center; gap: 15px;">
        <span id="inner-voice-edit-btn" style="cursor: pointer;" title="ç¼–è¾‘å¿ƒå£°é¢æ¿">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
        </span>
        <span id="change-inner-voice-bg-btn" style="cursor: pointer;" title="æ›´æ¢èƒŒæ™¯">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        </span>
        <span id="inner-voice-history-btn" style="cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </span>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->



        <div class="modal-body" style="padding: 15px;">
            <!-- å¤´åƒå’Œåå­—ä¿¡æ¯ç°åœ¨æ˜¯ç‹¬ç«‹çš„ã€å¯å®šä½çš„å…ƒç´  -->
            <!-- è§’è‰²å¤´åƒ -->
            <div id="inner-voice-avatar-wrapper">
                <img id="inner-voice-avatar" src="">
                <!-- ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå¤´åƒæ¡†é¢„ç•™çš„ä½ç½® -->
                <img id="inner-voice-avatar-frame" src="" style="display: none;">
            </div>

            
            <!-- è§’è‰²åå­— -->
            <div id="inner-voice-char-info">
                <div id="inner-voice-char-name"></div>
            </div>

            <!-- ã€å…¨æ–°ã€‘é¢†å…»äººä¿¡æ¯ï¼ˆå¤´åƒ+åå­—ï¼‰-->
            <div id="inner-voice-adopter-info">
                <img id="inner-voice-adopter-avatar" src="">
                <span id="inner-voice-adopter-name"></span>
            </div>
            
            <!-- å¿ƒå£°å†…å®¹ -->
            <div id="inner-voice-content-area" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <strong style="color: #e57373;">æœè£…:</strong>
                    <p id="inner-voice-clothing" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #81c784;">è¡Œä¸º:</strong>
                    <p id="inner-voice-behavior" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #64b5f6;">å¿ƒå£°:</strong>
                    <p id="inner-voice-thoughts" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
                <div>
                    <strong style="color: #ba68c8;">åå¿ƒæ€:</strong>
                    <p id="inner-voice-naughty-thoughts" style="margin: 5px 0 0 0; line-height: 1.6; color: #555;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•é¢æ¿ (ä¿æŒä¸å˜) -->
    <div id="inner-voice-history-panel" class="modal-content" style="width: 90%; max-width: 340px; height: 80%; background-color: #f5f5f5; display: none; flex-direction: column;">
        <div class="modal-header" style="border-bottom: 1px solid #ddd; justify-content: space-between;">
            <span id="back-from-history-btn" style="cursor: pointer; font-size: 16px; font-weight: 600; color: var(--accent-color);">è¿”å›</span>
            <span>å†å²å¿ƒå£°</span>
            <span id="clear-all-history-btn" style="cursor: pointer; font-size: 14px; color: #ff3b30;">å…¨éƒ¨æ¸…ç©º</span>
        </div>
        <div class="modal-body" id="inner-voice-history-list" style="padding: 0;">
            <!-- å†å²è®°å½•ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<script>
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—è¶…é•¿çš„å¡”ç½—ç‰Œæ•°æ®ï¼Œç²˜è´´åˆ° const GEMINI_API_URL çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

const TAROT_DECK = [
    { name: "æ„šäºº", upright: "å¼€å§‹, å¤©çœŸ, è‡ªå‘æ€§, è‡ªç”±ç²¾ç¥", reversed: "å¤©çœŸ, é²è½, æ‰¿æ‹…é£é™©" },
    { name: "é­”æœ¯å¸ˆ", upright: "æ˜¾åŒ–, è¶³æ™ºå¤šè°‹, åŠ›é‡, çµæ„Ÿè¡ŒåŠ¨", reversed: "æ“çºµ, è®¡åˆ’ä¸å‘¨, æœªè¢«åˆ©ç”¨çš„å¤©èµ‹" },
    { name: "å¥³ç¥­å¸", upright: "ç›´è§‰, ç¥åœ£å¥³æ€§, æ½œæ„è¯†, ç¥ç§˜", reversed: "ç§˜å¯†, è„±ç¦»ç›´è§‰, å‹æŠ‘çš„æ„Ÿæƒ…" },
    { name: "çš‡å", upright: "ç”Ÿè‚², å¥³æ€§æ°”è´¨, ç¾ä¸½, è‡ªç„¶, ä¸°å¯Œ", reversed: "åˆ›é€ åŠ›å—é˜», ä¾èµ–ä»–äºº" },
    { name: "çš‡å¸", upright: "æƒå¨, çˆ¶äº²å½¢è±¡, ç»“æ„, ç¨³å›ºæ§åˆ¶", reversed: "æ§åˆ¶æ¬², åƒµåŒ–, ç¼ºä¹çºªå¾‹" },
    { name: "æ•™çš‡", upright: "ç²¾ç¥æ™ºæ…§, å®—æ•™ä¿¡ä»°, ä¼ ç»Ÿ, åˆ¶åº¦", reversed: "ä¸ªäººä¿¡ä»°, æŒ‘æˆ˜ä¼ ç»Ÿ, å¢¨å®ˆæˆè§„" },
    { name: "æ‹äºº", upright: "çˆ±, å’Œè°, å…³ç³», ä»·å€¼è§‚å¯¹é½, é€‰æ‹©", reversed: "ä¸å’Œè°, å¤±è¡¡, ä»·å€¼è§‚é”™ä½" },
    { name: "æˆ˜è½¦", upright: "æ§åˆ¶, æ„å¿—åŠ›, èƒœåˆ©, æ–­è¨€, å†³å¿ƒ", reversed: "ç¼ºä¹æ§åˆ¶å’Œæ–¹å‘, ä¾µç•¥æ€§" },
    { name: "åŠ›é‡", upright: "åŠ›é‡, å‹‡æ°”, åŒæƒ…, ä¸“æ³¨, è€å¿ƒ", reversed: "å†…åœ¨åŠ›é‡, è‡ªæˆ‘æ€€ç–‘, ç²¾åŠ›ä¸è¶³" },
    { name: "éšå£«", upright: "çµé­‚æ¢ç´¢, å†…çœ, å­¤ç‹¬, å†…åœ¨å¼•å¯¼", reversed: "å­¤ç«‹, å­¤ç‹¬, é€€ç¼©" },
    { name: "å‘½è¿ä¹‹è½®", upright: "å¥½è¿, å› æœæŠ¥åº”, ç”Ÿå‘½å‘¨æœŸ, è½¬æŠ˜ç‚¹", reversed: "åè¿æ°”, æŠµæŠ—æ”¹å˜, æ‰“ç ´å¾ªç¯" },
    { name: "æ­£ä¹‰", upright: "æ­£ä¹‰, å…¬å¹³, çœŸç†, å› æœ, æ³•å¾‹", reversed: "ä¸å…¬å¹³, ç¼ºä¹è´£ä»»æ„Ÿ, ä¸è¯šå®" },
    { name: "å€’åŠäºº", upright: "æš‚åœ, é™åˆ¶, æ”¾æ‰‹, ç‰ºç‰², æ–°è§†è§’", reversed: "æ‹–å»¶, æ¯«æ— æ„ä¹‰çš„ç‰ºç‰², åœæ»" },
    { name: "æ­»ç¥", upright: "ç»“æŸ, æ”¹å˜, è½¬å˜, è¿‡æ¸¡", reversed: "æŠµæŠ—æ”¹å˜, æ— æ³•å‰è¿›, åœæ»" },
    { name: "èŠ‚åˆ¶", upright: "å¹³è¡¡, é€‚åº¦, è€å¿ƒ, ç›®æ ‡", reversed: "å¤±è¡¡, è¿‡åº¦, é‡æ–°è°ƒæ•´" },
    { name: "æ¶é­”", upright: "æŸç¼š, æˆç˜¾, æ¶ˆæ, å”¯ç‰©ä¸»ä¹‰", reversed: "æŒ£è„±æŸç¼š, é‡Šæ”¾, æ¢å¤æ§åˆ¶" },
    { name: "é«˜å¡”", upright: "çªå˜, å‰§å˜, æ··ä¹±, å¯ç¤º, è§‰é†’", reversed: "é¿å…ç¾éš¾, å®³æ€•æ”¹å˜" },
    { name: "æ˜Ÿæ˜Ÿ", upright: "å¸Œæœ›, ä¿¡å¿µ, ç›®æ ‡, æ›´æ–°, çµæ€§", reversed: "ç¼ºä¹ä¿¡å¿µ, ç»æœ›, ä¸ä¸“æ³¨" },
    { name: "æœˆäº®", upright: "å¹»è§‰, ææƒ§, ç„¦è™‘, æ½œæ„è¯†, ç›´è§‰", reversed: "é‡Šæ”¾ææƒ§, å‹æŠ‘çš„æƒ…æ„Ÿ, å†…å¿ƒå›°æƒ‘" },
    { name: "å¤ªé˜³", upright: "ç§¯æ, ä¹è¶£, æ¸©æš–, æˆåŠŸ, æ´»åŠ›", reversed: "å†…å¿ƒå¹¼ç¨š, è¿‡äºä¹è§‚, æ²®ä¸§" },
    { name: "å®¡åˆ¤", upright: "å®¡åˆ¤, é‡ç”Ÿ, å†…å¿ƒå¬å”¤, èµ¦å…", reversed: "è‡ªæˆ‘æ€€ç–‘, æ— è§†å¬å”¤" },
    { name: "ä¸–ç•Œ", upright: "å®Œæˆ, æ•´åˆ, æˆå°±, æ—…è¡Œ", reversed: "å¯»æ±‚ä¸ªäººç»“æŸ, èµ°æ·å¾„, æ‹–å»¶" },
    { name: "æƒæ–ACE", upright: "çµæ„Ÿ, æ–°æœºä¼š, æˆé•¿, æ½œåŠ›", reversed: "ç¼ºä¹åŠ¨åŠ›, é”™è¿‡æœºä¼š, æ‹–å»¶" },
    { name: "æƒæ–äºŒ", upright: "æœªæ¥è§„åˆ’, è¿›æ­¥, å†³ç­–, ç¦»å¼€å®¶", reversed: "ææƒ§æœªçŸ¥, ç¼ºä¹è§„åˆ’, å®³æ€•æ”¹å˜" },
    { name: "æƒæ–ä¸‰", upright: "æ‰©å¼ , æˆé•¿, è¿œè§, æµ·å¤–æœºä¼š", reversed: "è®¡åˆ’å—æŒ«, ç¼ºä¹è¿œè§, å»¶è¯¯" },
    { name: "æƒæ–å››", upright: "åº†ç¥, å’Œè°, å©šå§», å›å®¶, ç¨³å®š", reversed: "ä¸å’Œè°, è¿‡æ¸¡, ç¼ºä¹æ”¯æŒ" },
    { name: "æƒæ–äº”", upright: "å†²çª, åˆ†æ­§, ç«äº‰, ç´§å¼ ", reversed: "å†²çªé¿å…, å°Šé‡å·®å¼‚" },
    { name: "æƒæ–å…­", upright: "æˆåŠŸ, å…¬ä¼—è®¤å¯, èƒœåˆ©, è¿›æ­¥", reversed: "è‡ªè´Ÿ, ç¼ºä¹è®¤å¯, æƒ©ç½š" },
    { name: "æƒæ–ä¸ƒ", upright: "æŒ‘æˆ˜, ç«äº‰, ä¿æŠ¤, åšæŒ", reversed: "æ”¾å¼ƒ, ä¸çŸ¥æ‰€æª, è¿‡åº¦ä¿æŠ¤" },
    { name: "æƒæ–å…«", upright: "é€Ÿåº¦, è¡ŒåŠ¨, ç©ºä¸­æ—…è¡Œ, è¿åŠ¨, å¿«é€Ÿå†³ç­–", reversed: "å»¶è¯¯, æŒ«æŠ˜, æŠµåˆ¶æ”¹å˜" },
    { name: "æƒæ–ä¹", upright: "éŸ§æ€§, å‹‡æ°”, åšæŒ, ç•Œé™", reversed: "å†…å¿ƒæŒ£æ‰, åæ‰§, é˜²å¾¡æ€§" },
    { name: "æƒæ–å", upright: "è´Ÿæ‹…, è´£ä»», åŠªåŠ›å·¥ä½œ, å‹åŠ›", reversed: "å¸ä¸‹è´Ÿæ‹…, å§”æ´¾, é‡Šæ”¾" },
    { name: "æƒæ–ä¾ä»", upright: "çµæ„Ÿ, æƒ³æ³•, å‘ç°, è‡ªç”±ç²¾ç¥", reversed: "ä¸åˆ‡å®é™…çš„æƒ³æ³•, æ‹–å»¶, åˆ›é€ åŠ›å—é˜»" },
    { name: "æƒæ–éª‘å£«", upright: "èƒ½é‡, æ¿€æƒ…, æ¬²æœ›, è¡ŒåŠ¨, å†’é™©", reversed: "æ„¤æ€’, å†²åŠ¨, é²è½" },
    { name: "æƒæ–ç‹å", upright: "å‹‡æ°”, è‡ªä¿¡, ç‹¬ç«‹, ç¤¾äº¤è´è¶", reversed: "è‡ªæˆ‘å°Šé‡, è‡ªä¿¡, å†…å‘" },
    { name: "æƒæ–å›½ç‹", upright: "å¤©ç”Ÿçš„é¢†è¢–, è¿œè§, ä¼ä¸šå®¶, è£èª‰", reversed: "å†²åŠ¨, ä»“ä¿ƒ, æ— æƒ…çš„" },
    { name: "åœ£æ¯ACE", upright: "çˆ±, æ–°å…³ç³», åŒæƒ…, åˆ›é€ åŠ›", reversed: "è‡ªæˆ‘çˆ±, ç›´è§‰, å‹æŠ‘çš„æƒ…æ„Ÿ" },
    { name: "åœ£æ¯äºŒ", upright: "ç»Ÿä¸€çš„çˆ±, ä¼™ä¼´å…³ç³», ç›¸äº’å¸å¼•", reversed: "åˆ†æ‰‹, ä¸å’Œè°, ä¸ä¿¡ä»»" },
    { name: "åœ£æ¯ä¸‰", upright: "åº†ç¥, å‹è°Š, åˆ›é€ åŠ›, åˆä½œ", reversed: "ç‹¬ç«‹, ç‹¬å¤„, 'ä¸‰äººè¡Œ'" },
    { name: "åœ£æ¯å››", upright: "æ²‰æ€, æ–­å¼€è¿æ¥, å†·æ¼ , é‡æ–°è¯„ä¼°", reversed: "é€€ç¼©, å­¤åƒ», é”™è¿‡æœºä¼š" },
    { name: "åœ£æ¯äº”", upright: "é—æ†¾, å¤±è´¥, å¤±æœ›, æ‚²è§‚ä¸»ä¹‰", reversed: "ä¸ªäººæŒ«æŠ˜, è‡ªæˆ‘å®½æ•, å‰è¿›" },
    { name: "åœ£æ¯å…­", upright: "é‡æ¸©è¿‡å», ç«¥å¹´è®°å¿†, å¤©çœŸ, å–œæ‚¦", reversed: "æ´»åœ¨è¿‡å», ä¸æ„¿åŸè°…, ç¼ºä¹ç©ä¹" },
    { name: "åœ£æ¯ä¸ƒ", upright: "æœºä¼š, é€‰æ‹©, å¹»æƒ³, å¹»è§‰", reversed: "ä¸€è‡´æ€§, å¹»æƒ³, è¿‡å¤šé€‰æ‹©" },
    { name: "åœ£æ¯å…«", upright: "å¤±æœ›, æ”¾å¼ƒ, é€€ç¼©, é€ƒé¿ä¸»ä¹‰", reversed: "å°è¯•æ–°äº‹ç‰©, å†·æ¼ , ææƒ§æ”¹å˜" },
    { name: "åœ£æ¯ä¹", upright: "æ»¡è¶³, æ»¡æ„, æ„Ÿæ¿€, æ„¿æœ›æˆçœŸ", reversed: "ä¸æ»¡è¶³, å”¯ç‰©ä¸»ä¹‰, ä¸æ»¡" },
    { name: "åœ£æ¯å", upright: "ç¥åœ£çš„çˆ±, å’Œè°å…³ç³», å®¶åº­, ä¸€è‡´æ€§", reversed: "è„±èŠ‚, å¯¹é½é”™è¯¯, æŒ£æ‰çš„å…³ç³»" },
    { name: "åœ£æ¯ä¾ä»", upright: "åˆ›æ„æœºä¼š, ç›´è§‰ä¿¡æ¯, å¥½å¥‡å¿ƒ", reversed: "æ–°çš„æƒ³æ³•, æ€€ç–‘, åˆ›é€ åŠ›å—é˜»" },
    { name: "åœ£æ¯éª‘å£«", upright: "åˆ›é€ åŠ›, æµªæ¼«, é­…åŠ›, æƒ³è±¡åŠ›", reversed: "ä¸åˆ‡å®é™…, å«‰å¦’, æƒ…ç»ªæ³¢åŠ¨" },
    { name: "åœ£æ¯ç‹å", upright: "å¯Œæœ‰åŒæƒ…å¿ƒ, å…³æ€€, ç›´è§‰, å¹³é™", reversed: "å†…åœ¨æ„Ÿå—, è‡ªæˆ‘ç…§é¡¾, è‡ªçˆ±, å…±æƒ…" },
    { name: "åœ£æ¯å›½ç‹", upright: "æƒ…ç»ªå¹³è¡¡, åŒæƒ…, å¤–äº¤", reversed: "è‡ªæˆ‘åŒæƒ…, å†…åœ¨çœŸç†, æƒ…ç»ªä¸ç¨³å®š" },
    { name: "å®å‰‘ACE", upright: "çªç ´, æ–°æƒ³æ³•, å¤´è„‘æ¸…æ™°, æˆåŠŸ", reversed: "å†…å¿ƒæ¸…æ™°, é‡æ–°æ€è€ƒä¸€ä¸ªæƒ³æ³•, æ··ä¹±" },
    { name: "å®å‰‘äºŒ", upright: "è‰°éš¾çš„é€‰æ‹©, æœªçŸ¥çš„åæœ, åƒµå±€", reversed: "ä¼˜æŸ”å¯¡æ–­, å›°æƒ‘, ä¿¡æ¯è¿‡è½½" },
    { name: "å®å‰‘ä¸‰", upright: "å¿ƒç¢, æ‚²ä¼¤, æ‹’ç», åˆ†ç¦»", reversed: "é‡Šæ”¾ç—›è‹¦, ä¹è§‚, å®½æ•" },
    { name: "å®å‰‘å››", upright: "ä¼‘æ¯, æ”¾æ¾, æ²‰æ€, æ¢å¤", reversed: "ç²¾ç–²åŠ›å°½, å€¦æ€ , åœæ»" },
    { name: "å®å‰‘äº”", upright: "å†²çª, åˆ†æ­§, ç«äº‰, å¤±è´¥", reversed: "å’Œè§£, è¿‡å»çš„åŸè°…" },
    { name: "å®å‰‘å…­", upright: "è¿‡æ¸¡, æ”¹å˜, ä»ªå¼, æ”¾ä¸‹", reversed: "ä¸ªäººè¿‡æ¸¡, æŠµæŠ—æ”¹å˜, æœªå®Œæˆçš„äº‹" },
    { name: "å®å‰‘ä¸ƒ", upright: "èƒŒå›, æ¬ºéª—, èµ°æ·å¾„, é¬¼ç¥Ÿ", reversed: "å†’åé¡¶æ›¿ç»¼åˆç—‡, æ¬ºéª—, å®ˆç§˜" },
    { name: "å®å‰‘å…«", upright: "è´Ÿé¢æƒ³æ³•, è‡ªæˆ‘å¼ºåŠ çš„é™åˆ¶, ç›‘ç¦", reversed: "è‡ªæˆ‘é™åˆ¶çš„ä¿¡å¿µ, é‡Šæ”¾, æ€æƒ³å¼€æ”¾" },
    { name: "å®å‰‘ä¹", upright: "ç„¦è™‘, æ‹…å¿§, ææƒ§, æŠ‘éƒ, å™©æ¢¦", reversed: "å†…å¿ƒæŒ£æ‰, æ·±åº¦ææƒ§, é‡Šæ”¾å¿§è™‘" },
    { name: "å®å‰‘å", upright: "ç—›è‹¦çš„ç»“å±€, æ·±åº¦åˆ›ä¼¤, èƒŒå›, æŸå¤±", reversed: "æ¢å¤, æŠµæŠ—ç»“å±€, æ— æ³•æ”¾æ‰‹" },
    { name: "å®å‰‘ä¾ä»", upright: "æ–°æƒ³æ³•, å¥½å¥‡å¿ƒ, è¿½æ±‚çœŸç†", reversed: "è‡ªè¨€è‡ªè¯­, å…¨èƒ½é€‰æ‰‹, ä»“ä¿ƒ" },
    { name: "å®å‰‘éª‘å£«", upright: "é›„å¿ƒå‹ƒå‹ƒ, è¡ŒåŠ¨å¯¼å‘, è¿½æ±‚ç›®æ ‡", reversed: "ä¸å®‰, å†²åŠ¨, å€¦æ€ " },
    { name: "å®å‰‘ç‹å", upright: "ç‹¬ç«‹çš„, æ— åè§çš„åˆ¤æ–­, æ¸…æ™°çš„ç•Œé™", reversed: "è¿‡äºæƒ…ç»ªåŒ–, è½»æ˜“å—å½±å“, åˆ»è–„" },
    { name: "å®å‰‘å›½ç‹", upright: "ç²¾ç¥æ¸…æ™°, æ™ºæ…§, æƒå¨, çœŸç†", reversed: "å®‰é™çš„åŠ›é‡, å†…åœ¨çœŸç†, æ»¥ç”¨æƒåŠ›" },
    { name: "æ˜Ÿå¸ACE", upright: "æ˜¾åŒ–, æ–°çš„è´¢åŠ¡æœºä¼š, ç¹è£", reversed: "æœºä¼šä¸§å¤±, ç¼ºä¹è§„åˆ’å’Œè¿œè§" },
    { name: "æ˜Ÿå¸äºŒ", upright: "å¤šä»»åŠ¡, é€‚åº”æ€§, æ—¶é—´ç®¡ç†", reversed: "é‡æ–°è°ƒæ•´ä¼˜å…ˆçº§, è¿‡åº¦æŠ•å…¥" },
    { name: "æ˜Ÿå¸ä¸‰", upright: "å›¢é˜Ÿåˆä½œ, åˆä½œ, å­¦ä¹ , å®æ–½", reversed: "ä¸å’Œè°, å›¢é˜Ÿå†…éƒ¨å†²çª, è®¡åˆ’ä¸å‘¨" },
    { name: "æ˜Ÿå¸å››", upright: "èŠ‚çº¦, å®‰å…¨, ä¿å®ˆ, ç¨€ç¼ºå¿ƒæ€", reversed: "è¿‡åº¦æ¶ˆè´¹, è´ªå©ª, è‡ªæˆ‘ä¿æŠ¤" },
    { name: "æ˜Ÿå¸äº”", upright: "è´¢åŠ¡æŸå¤±, è´«å›°, å­¤ç«‹, å¿§è™‘", reversed: "ä»è´¢åŠ¡æŸå¤±ä¸­æ¢å¤, ç²¾ç¥è´«å›°" },
    { name: "æ˜Ÿå¸å…­", upright: "ç»™äºˆ, æ¥å—, åˆ†äº«è´¢å¯Œ, æ…·æ…¨", reversed: "è‡ªç§, å€ºåŠ¡, å•æ–¹é¢ç»™äºˆ" },
    { name: "æ˜Ÿå¸ä¸ƒ", upright: "é•¿æœŸçœ¼å…‰, å¯æŒç»­çš„ç»“æœ, æŠ•èµ„", reversed: "ç¼ºä¹é•¿æœŸçœ¼å…‰, æˆåŠŸå—é™" },
    { name: "æ˜Ÿå¸å…«", upright: "å­¦å¾’, é‡å¤, æŒæ¡, æŠ€èƒ½å‘å±•", reversed: "è‡ªæˆ‘å‘å±•, å®Œç¾ä¸»ä¹‰, éƒ¨ç½²ä¸å½“" },
    { name: "æ˜Ÿå¸ä¹", upright: "ä¸°å¯Œ, å¥¢å, è‡ªç»™è‡ªè¶³, è´¢åŠ¡ç‹¬ç«‹", reversed: "è‡ªæˆ‘ä»·å€¼, è¿‡åº¦æŠ•èµ„äºå·¥ä½œ" },
    { name: "æ˜Ÿå¸å", upright: "è´¢å¯Œ, è´¢åŠ¡å®‰å…¨, å®¶åº­, é—äº§", reversed: "è´¢åŠ¡å¤±è´¥, è´Ÿæ‹…, é—äº§ä¸§å¤±" },
    { name: "æ˜Ÿå¸ä¾ä»", upright: "æ˜¾åŒ–, è´¢åŠ¡æœºä¼š, æŠ€èƒ½å‘å±•", reversed: "ç¼ºä¹è¿›æ­¥, æ‹–å»¶, å­¦ä¼šæ–°æŠ€èƒ½" },
    { name: "æ˜Ÿå¸éª‘å£«", upright: "åŠªåŠ›å·¥ä½œ, ç”Ÿäº§åŠ›, æ—¥å¸¸, ä¿å®ˆ", reversed: "è‡ªæˆ‘çºªå¾‹, æ— èŠ, æ„Ÿè§‰'å¡ä½'" },
    { name: "æ˜Ÿå¸ç‹å", upright: "å…»è‚², åŠ¡å®, è´¢åŠ¡å®‰å…¨, å·¥ä½œä¸å®¶åº­çš„å¹³è¡¡", reversed: "è´¢åŠ¡ç‹¬ç«‹, è‡ªæˆ‘ç…§é¡¾, å·¥ä½œä¸å®¶åº­çš„ä¸å¹³è¡¡" },
    { name: "æ˜Ÿå¸å›½ç‹", upright: "è´¢å¯Œ, å•†ä¸š, é¢†å¯¼åŠ›, å®‰å…¨, çºªå¾‹", reversed: "è´¢åŠ¡ä¸ç§°èŒ, è¿‡æ—¶, å›ºæ‰§" }
];

// â–²â–²â–² å¡”ç½—ç‰Œæ•°æ®ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° const GEMINI_API_URL çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

const BUILT_IN_SCRIPTS = [
    {
        id: 'built_in_1',
        name: 'åŠå…¬å®¤ç–‘äº‘',
        storyBackground: 'æ·±å¤œï¼Œé¡¶çº§äº’è”ç½‘å…¬å¸â€œæ¯”ç‰¹æ— é™â€ç¯ç«é€šæ˜ã€‚ä»¥è‹›åˆ»é—»åçš„é¡¹ç›®æ€»ç›‘ç‹å¼ºï¼Œè¢«å‘ç°æ­»åœ¨è‡ªå·±çš„åº§ä½ä¸Šï¼Œæ­»å› ä¸ºè¯ç‰©ä¸­æ¯’ã€‚è­¦æ–¹åˆæ­¥é”å®šäº†å½“æ™šè¿˜åœ¨å…¬å¸çš„äº”ä½å«Œç–‘äººï¼Œæ¯ä¸ªäººä¼¼ä¹éƒ½ä¸æ­»è€…æœ‰ç€åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚åœ¨è¿™åº§æ¬²æœ›ä¸ä»£ç äº¤ç»‡çš„é’¢é“æ£®æ—é‡Œï¼Œè°çš„ç§˜å¯†è¢«æ°¸è¿œåŸ‹è‘¬ï¼Œè°çš„åŒæ‰‹æ²¾æŸ“äº†ç½ªæ¶ï¼Ÿ',
        roles: [
            {
                name: 'ææ€',
                description: 'å…¬å¸æ–°æ™‹çš„å¤©æ‰ç¨‹åºå‘˜ï¼ŒæŠ€æœ¯è¿‡ç¡¬ï¼Œä½†æ€§æ ¼å†…å‘ï¼Œä¸å–„è¨€è¾ã€‚',
                storyline: `ä»Šå¤©æ˜¯é¡¹ç›®ä¸Šçº¿çš„æœ€åæœŸé™ï¼Œæˆ‘è¢«ç‹æ€»ç›‘é€¼ç€åŠ ç­åˆ°æ·±å¤œã€‚\n**æ™šä¸Š8:00**ï¼šç‹æ€»ç›‘æŠŠæˆ‘å«è¿›ä»–åŠå…¬å®¤ï¼Œå› ä¸ºä¸€ä¸ªå¾®ä¸è¶³é“çš„bugå¯¹æˆ‘ç ´å£å¤§éª‚ï¼Œç”šè‡³æ’•æ‰äº†æˆ‘çš„ç»©æ•ˆè¯„ä¼°æŠ¥å‘Šï¼Œè¯´æˆ‘â€œä¸åˆæ ¼â€ã€‚æˆ‘æ°”å¾—æµ‘èº«å‘æŠ–ï¼Œå’Œä»–å¤§åµäº†ä¸€æ¶ï¼Œç„¶åæ‘”é—¨è€Œå‡ºã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å›åˆ°å·¥ä½ï¼Œè¶Šæƒ³è¶Šæ°”ï¼Œæ‰“å¼€ç”µè„‘å†™äº†ä¸€å°è¾èŒä¿¡ï¼Œä½†è¿˜æ²¡å‘é€ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘èµ·èº«å»èŒ¶æ°´é—´å€’æ°´ï¼Œè·¯è¿‡æ€»ç›‘åŠå…¬å®¤æ—¶ï¼Œçœ‹åˆ°äººäº‹ä¸»ç®¡é™ˆé™ç«¯ç€ä¸€æ¯å’–å•¡èµ°äº†è¿›å»ã€‚æˆ‘å½“æ—¶æ²¡å¤ªåœ¨æ„ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æœ‰ç‚¹é¥¿ï¼Œç‚¹äº†ä¸€ä»½å¤–å–ã€‚ç­‰å¤–å–çš„æ—¶å€™ï¼Œæˆ‘çœ‹åˆ°è®¾è®¡å¸ˆå­™ä¼Ÿé¬¼é¬¼ç¥Ÿç¥Ÿåœ°ä»èŒ¶æ°´é—´çš„æ–¹å‘èµ°å‡ºæ¥ï¼Œæ‰‹é‡Œå¥½åƒæ”¥ç€ä»€ä¹ˆä¸œè¥¿ã€‚\n**æ™šä¸Š10:00**ï¼šå¤–å–åˆ°äº†ï¼Œæˆ‘åƒå®Œå¤–å–ç»§ç»­æ”¹bugï¼Œç›´åˆ°è¢«å‘ç°å°¸ä½“çš„æƒŠå«å£°æ‰“æ–­ã€‚`,
                tasks: '1. éšè—ä½ ä¸ç‹å¼ºæ€»ç›‘å‘ç”Ÿè¿‡æ¿€çƒˆäº‰åµï¼Œå¹¶è¢«ä»–è¯„ä¸ºâ€œä¸åˆæ ¼â€çš„äº‹å®ã€‚\n2. ä½ çš„é¦–è¦ç›®æ ‡æ˜¯è‡ªä¿ï¼Œæ‰¾åˆ°è¯æ®è¯æ˜ä½ ç¦»å¼€åå¦æœ‰å…¶äººè¿›å…¥è¿‡åŠå…¬å®¤ã€‚\n3. ä½ æ€€ç–‘é™ˆé™å’Œå­™ä¼Ÿï¼Œå°è¯•æ‰¾å‡ºä»–ä»¬çš„å¯ç–‘ä¹‹å¤„ã€‚',
                isKiller: false
            },
            {
                name: 'èµµå¨œ',
                description: 'å…¬å¸çš„å¸‚åœºéƒ¨ç»ç†ï¼Œèƒ½åŠ›å‡ºä¼—ï¼Œæ˜¯å…¸å‹çš„èŒåœºå¥³å¼ºäººï¼Œé‡å¿ƒå‹ƒå‹ƒã€‚',
                storyline: `ä»Šæ™šæœ¬ä¸éœ€è¦æˆ‘åŠ ç­ï¼Œä½†æˆ‘ä¸ºäº†å‡†å¤‡ä¸€ä¸ªé‡è¦çš„ç«æ ‡æ–¹æ¡ˆï¼Œä¸»åŠ¨ç•™äº†ä¸‹æ¥ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„åŠå…¬å®¤æ•´ç†èµ„æ–™ï¼Œæ— æ„ä¸­å‘ç°äº†ç‹å¼ºæŒªç”¨é¡¹ç›®å…¬æ¬¾çš„è¯æ®ã€‚æˆ‘ç«‹åˆ»èµ·è‰äº†ä¸€å°åŒ¿åä¸¾æŠ¥é‚®ä»¶ï¼Œå‡†å¤‡å‘ç»™æ€»éƒ¨ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘å¬åˆ°éš”å£æ€»ç›‘åŠå…¬å®¤ä¼ æ¥æ¿€çƒˆçš„äº‰åµå£°ï¼Œå¥½åƒæ˜¯ææ€åœ¨å’Œç‹å¼ºåµæ¶ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘éœ€è¦ä¸€äº›æ•°æ®ï¼Œå°±å»æ‰¾ç‹å¼ºç­¾å­—ã€‚è¿›ä»–åŠå…¬å®¤æ—¶ï¼Œä»–æ­£åœ¨å–å’–å•¡ï¼Œè„¸è‰²å¾ˆå·®ã€‚æˆ‘æŠŠæ–‡ä»¶ç»™ä»–ï¼Œä»–å¾ˆä¸è€çƒ¦åœ°ç­¾äº†å­—ã€‚æˆ‘æ³¨æ„åˆ°ä»–æ¡Œä¸Šæ”¾ç€ä¸€ç“¶æ²¡è´´æ ‡ç­¾çš„è¯ç“¶ã€‚\n**æ™šä¸Š9:15**ï¼šæˆ‘å›åˆ°è‡ªå·±åŠå…¬å®¤ï¼Œæ€è€ƒç€ä¸¾æŠ¥é‚®ä»¶çš„äº‹æƒ…ã€‚æˆ‘æ‹…å¿ƒè¿™ä¼šå½±å“å…¬å¸å£°èª‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ²¡æœ‰å‘é€ã€‚\n**æ™šä¸Š10:15**ï¼šæˆ‘å‡†å¤‡ä¸‹ç­ï¼Œè·¯è¿‡æ€»ç›‘åŠå…¬å®¤æ—¶ï¼Œå‘ç°é—¨è™šæ©ç€ï¼Œé‡Œé¢å¾ˆå®‰é™ã€‚æˆ‘æ²¡æœ‰è¿›å»çœ‹ï¼Œç›´æ¥ç¦»å¼€äº†å…¬å¸ã€‚`,
                tasks: '1. ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯æ‰¾å‡ºçœŸå‡¶ï¼Œæ´—æ¸…è‡ªå·±çš„å«Œç–‘ï¼Œç¡®ä¿å…¬å¸ä¸‘é—»ä¸è¢«æ›å…‰ï¼Œä»¥å…å½±å“ä½ çš„èŒä¸šå‰é€”ã€‚\n2. éšè—ä½ å‘ç°ç‹å¼ºæŒªç”¨å…¬æ¬¾å¹¶å‡†å¤‡ä¸¾æŠ¥ä»–çš„äº‹å®ã€‚\n3. ä½ çœ‹åˆ°ä»–æ¡Œä¸Šçš„è¯ç“¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çº¿ç´¢ï¼Œä½ éœ€è¦å¼•å¯¼å¤§å®¶æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚',
                isKiller: false
            },
            {
                name: 'å­™ä¼Ÿ',
                description: 'å…¬å¸çš„èµ„æ·±UIè®¾è®¡å¸ˆï¼Œä¹Ÿæ˜¯ç‹å¼ºçš„è€éƒ¨ä¸‹ï¼Œè¡¨é¢å¯¹ä»–æ¯•æ­æ¯•æ•¬ã€‚',
                storyline: `æˆ‘æ¨é€äº†ç‹å¼ºï¼ä»–å…‹æ‰£äº†æˆ‘ä»¬å›¢é˜Ÿè¾›è¾›è‹¦è‹¦åšå®Œçš„é¡¹ç›®å¥–é‡‘ï¼Œè‡ªå·±å´æ‹¿äº†å¤§å¤´ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å€Ÿå£åŠ ç­ï¼Œå®é™…ä¸Šæ˜¯æƒ³æ½œå…¥ç‹å¼ºçš„åŠå…¬å®¤ï¼Œæ‰¾åˆ°ä»–å…‹æ‰£å¥–é‡‘çš„è¯æ®ã€‚æˆ‘çœ‹åˆ°é™ˆé™ç«¯ç€å’–å•¡è¿›å»åä¸ä¹…å°±å‡ºæ¥äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘ç¡®è®¤ç‹å¼ºåŠå…¬å®¤æ²¡äººæ³¨æ„ï¼Œå°±å·å·æºœäº†è¿›å»ã€‚æˆ‘çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡ç€äº†ï¼Œæ—è¾¹æ˜¯é‚£æ¯å‡ ä¹æ²¡å–çš„å’–å•¡ã€‚æˆ‘åœ¨ä»–æŠ½å±‰é‡Œç¿»æ‰¾ï¼Œæœç„¶æ‰¾åˆ°äº†ä¸€ä»½å†…éƒ¨å¥–é‡‘åˆ†é…è¡¨ï¼Œè¯å®äº†ä»–ä¸­é¥±ç§å›Šã€‚æˆ‘ç”¨æ‰‹æœºæ‹äº†ä¸‹æ¥ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æ‹¿ç€è¯æ®æ‚„æ‚„ç¦»å¼€åŠå…¬å®¤ï¼Œå‡†å¤‡å»èŒ¶æ°´é—´å¤„ç†ä¸€ä¸‹ã€‚è¿™æ—¶è¿é¢æ’ä¸Šäº†å»å€’æ°´çš„ææ€ï¼Œæˆ‘å“äº†ä¸€è·³ï¼Œèµ¶ç´§æŠŠæ‰‹æœºè—è¿›å£è¢‹é‡Œã€‚\n**æ™šä¸Š10:00å**ï¼šæˆ‘ä¸€ç›´åœ¨è‡ªå·±çš„å·¥ä½ä¸Šï¼Œç›˜ç®—ç€æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªè¯æ®è®©ä»–èº«è´¥åè£‚ã€‚`,
                tasks: '1. éšè—ä½ æ›¾æ½œå…¥æ€»ç›‘åŠå…¬å®¤å¹¶å·æ‹è¯æ®çš„äº‹å®ã€‚\n2. ç‹å¼ºæ­»äº†å¯¹ä½ æœ‰åˆ©ï¼Œä½ éœ€è¦å¼•å¯¼å¤§å®¶æ€€ç–‘å…¶ä»–æœ‰åŠ¨æœºçš„äººï¼Œæ¯”å¦‚ä¸ä»–äº‰åµçš„ææ€ã€‚\n3. ä¿æŠ¤å¥½ä½ æ‰‹æœºé‡Œçš„ç…§ç‰‡è¯æ®ï¼Œè¿™æ˜¯ä½ çš„æŠ¤èº«ç¬¦ã€‚',
                isKiller: false
            },
            {
                name: 'é™ˆé™',
                description: 'å…¬å¸çš„äººäº‹ä¸»ç®¡ï¼Œå¤–è¡¨æ¸©æŸ”ä½“è´´ï¼Œå–„äºå¤„ç†äººé™…å…³ç³»ã€‚',
                storyline: `æˆ‘æ›¾æ˜¯ç‹å¼ºç§˜å¯†çš„æƒ…äººï¼Œä»–æ‰¿è¯ºè¿‡ä¼šå’Œå¦»å­ç¦»å©šå¨¶æˆ‘ã€‚ä½†æœ€è¿‘ï¼Œæˆ‘å‘ç°ä»–ä¸ºäº†æ”€é™„ä¸€ä¸ªå¯Œå®¶å¥³ï¼Œå‡†å¤‡æŠ›å¼ƒæˆ‘ã€‚æ›´è®©æˆ‘ææƒ§çš„æ˜¯ï¼Œä»–æ‰‹æœºé‡Œå­˜ç€æˆ‘ä»¬å¤§é‡çš„ç§å¯†ç…§ç‰‡å’Œè§†é¢‘ï¼Œå¦‚æœæ›å…‰ï¼Œæˆ‘çš„èŒä¸šç”Ÿæ¶¯å°±å…¨æ¯äº†ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘çŸ¥é“ç‹å¼ºæœ‰å–å’–å•¡çš„ä¹ æƒ¯ã€‚æˆ‘æå‰å‡†å¤‡äº†å¼ºæ•ˆå®‰çœ è¯ï¼Œç£¨æˆç²‰æœ«ï¼Œè—åœ¨èº«ä¸Šã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ä»¥å…³å¿ƒä»–ä¸ºç”±ï¼Œä¸ºä»–å†²äº†ä¸€æ¯å’–å•¡ï¼Œå¹¶å°†å®‰çœ è¯å…¨éƒ¨å€’äº†è¿›å»ï¼Œç„¶åç«¯è¿›äº†ä»–çš„åŠå…¬å®¤ã€‚ä»–å½“æ—¶æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œæ²¡æœ‰æ€€ç–‘ï¼Œå–äº†ä¸€å¤§å£ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å€Ÿå£ç¦»å¼€ï¼Œåœ¨å¤–é¢è§‚å¯Ÿã€‚ä¸ä¸€ä¼šå„¿ï¼Œå°±çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡ç€äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘è¿”å›åŠå…¬å®¤ï¼Œæƒ³æ‰¾åˆ°ä»–çš„æ‰‹æœºåˆ é™¤èµ„æ–™ã€‚ä½†æˆ‘æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°ä»–çš„æ‰‹æœºã€‚æ­¤æ—¶æˆ‘å‘ç°ä»–å·²ç»æ²¡äº†å‘¼å¸ï¼Œæˆ‘å“åäº†ï¼Œæ…Œä¹±ä¸­ï¼Œæˆ‘ä¸å°å¿ƒå°†ä»–æ¡Œä¸Šçš„ä¸€æ¡é¡¹é“¾ï¼ˆä»–å‡†å¤‡é€ç»™é‚£ä¸ªå¯Œå®¶å¥³çš„ï¼‰ç¢°æ‰ï¼Œæ‰è¿›äº†æˆ‘çš„æ‰‹æåŒ…é‡Œã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘æƒŠæ…Œå¤±æªåœ°é€ƒç¦»äº†åŠå…¬å®¤ï¼Œå›åˆ°è‡ªå·±çš„å·¥ä½å‡è£…åŠ ç­ï¼Œå¿ƒä¹±å¦‚éº»ã€‚`,
                tasks: `ã€ä½ çš„æ ¸å¿ƒä»»åŠ¡ã€‘\nè¯·éšè—ä½ ä¸ºäº†é”€æ¯è¯æ®è€Œå¤±æ‰‹ç”¨å®‰çœ è¯æ¯’æ€ç‹å¼ºçš„äº‹å®ã€‚ä½ æ˜¯æœ¬æ¡ˆçš„å”¯ä¸€çœŸå‡¶ã€‚\n\nã€ä½ çš„è¡ŒåŠ¨æŒ‡å—ã€‘\n1. å«ç¥¸ä»–äººã€‚ä½ å¯ä»¥åˆ©ç”¨ä½ çœ‹åˆ°çš„ã€å¬åˆ°çš„ä¿¡æ¯ï¼Œå°†å«Œç–‘å¼•å‘ææ€æˆ–å­™ä¼Ÿã€‚\n2. ä½ åŒ…é‡Œçš„é¡¹é“¾æ˜¯å®šæ—¶ç‚¸å¼¹ï¼Œæƒ³åŠæ³•åˆç†è§£é‡Šå®ƒçš„æ¥å†ï¼Œæˆ–è€…ç¥ä¸çŸ¥é¬¼ä¸è§‰åœ°å¤„ç†æ‰å®ƒã€‚\n3. ä½ çš„ç›®æ ‡æ˜¯è¯¯å¯¼æ‰€æœ‰äººï¼Œè®©ä»–ä»¬æŠ•å‡ºé”™è¯¯çš„å‡¶æ‰‹ã€‚`,
                isKiller: true
            },
            {
                name: 'å‘¨æ¯…',
                description: 'å…¬å¸å¤§æ¥¼çš„å¤œç­ä¿å®‰ï¼Œçœ‹èµ·æ¥å¿ åšè€å®ï¼Œä½†è§‚å¯ŸåŠ›æ•é”ã€‚',
                storyline: `ä½œä¸ºä¿å®‰ï¼Œæˆ‘è´Ÿè´£å¤§æ¥¼å¤œé—´çš„å®‰å…¨å·¡é€»ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘å·¡é€»åˆ°18æ¥¼ï¼Œå¬åˆ°æ€»ç›‘åŠå…¬å®¤é‡Œæœ‰æ¿€çƒˆçš„äº‰åµå£°ï¼Œå¥½åƒæ˜¯é‚£ä¸ªå«ææ€çš„ç¨‹åºå‘˜ï¼Œæˆ‘æ²¡æ•¢é è¿‘ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°äººäº‹ä¸»ç®¡é™ˆé™ç«¯ç€æ¯å’–å•¡è¿›äº†æ€»ç›‘åŠå…¬å®¤ï¼Œå‡ åˆ†é’Ÿåå°±å‡ºæ¥äº†ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹ç´§å¼ ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°UIè®¾è®¡å¸ˆå­™ä¼Ÿï¼Œåƒåšè´¼ä¸€æ ·æºœè¿›äº†æ€»ç›‘åŠå…¬å®¤ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åˆçœ‹åˆ°é™ˆé™ä»æ€»ç›‘åŠå…¬å®¤å‡ºæ¥ï¼Œè¿™æ¬¡å¥¹è„¸è‰²æƒ¨ç™½ï¼Œè„šæ­¥åŒ†å¿™ï¼Œå¥½åƒä¸¢äº†é­‚ä¸€æ ·ã€‚æˆ‘è§‰å¾—å¾ˆå¥‡æ€ªï¼Œä½†æ²¡æ•¢å¤šé—®ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘è¿›è¡Œä¾‹è¡Œæ£€æŸ¥ï¼Œå‘ç°æ€»ç›‘åŠå…¬å®¤çš„é—¨æ²¡å…³ï¼Œè¿›å»ä¸€çœ‹ï¼Œå‘ç°ç‹æ€»ç›‘å·²ç»â€¦â€¦æˆ‘ç«‹åˆ»æŠ¥äº†è­¦ã€‚`,
                tasks: '1. ä½ æ˜¯æœ¬æ¡ˆæœ€é‡è¦çš„ç›®å‡»è¯äººï¼Œä½ çš„ä»»åŠ¡æ˜¯è¯šå®ã€å‡†ç¡®åœ°å‘å¤§å®¶æä¾›ä½ çœ‹åˆ°çš„æ—¶é—´çº¿ç´¢ã€‚\n2. ä½ è§‰å¾—é™ˆé™çš„è¡Œä¸ºæœ€å¯ç–‘ï¼Œä½ éœ€è¦é‡ç‚¹è§‚å¯Ÿå¥¹ï¼Œå¹¶å‘å¤§å®¶è¯´æ˜ä½ çš„æ€€ç–‘ã€‚\n3. æ‰¾å‡ºå¯¹å…¬å¸æœ€æœ‰åˆ©çš„çœŸç›¸ï¼Œé¿å…äº‹ä»¶æ‰©å¤§åŒ–ã€‚',
                isKiller: false
            }
        ],
        clues: [
            { owner: 'ææ€', description: 'ä¸€å¼ è¢«æ‰æˆä¸€å›¢ã€ä¸¢åœ¨åƒåœ¾æ¡¶é‡Œçš„ç»©æ•ˆè¯„ä¼°æŠ¥å‘Šï¼Œä¸Šé¢æœ‰ç‹å¼ºé¾™é£å‡¤èˆçš„ç­¾åå’Œâ€œä¸åˆæ ¼ï¼Œå»ºè®®è¾é€€â€çš„æ‰¹æ³¨ã€‚' },
            { owner: 'èµµå¨œ', description: 'ä½ çš„ç”µè„‘é‡Œæœ‰ä¸€å°æœªå‘é€çš„é‚®ä»¶ï¼Œæ”¶ä»¶äººæ˜¯é›†å›¢æ€»éƒ¨çºªæ£€å§”ï¼Œæ ‡é¢˜æ˜¯â€œå…³äºæ¯”ç‰¹æ— é™é¡¹ç›®æ€»ç›‘ç‹å¼ºæ¶‰å«Œä¸¥é‡èŒåŠ¡ä¾µå çš„å®åä¸¾æŠ¥â€ã€‚' },
            { owner: 'å­™ä¼Ÿ', description: 'ä½ çš„æ‰‹æœºç›¸å†Œé‡Œæœ‰ä¸€å¼ ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ä¸€ä»½å†…éƒ¨å¥–é‡‘åˆ†é…è¡¨ï¼Œè¡¨æ ¼æ˜¾ç¤ºé¡¹ç›®æ€»å¥–é‡‘çš„70%éƒ½æµå‘äº†ç‹å¼ºçš„ä¸ªäººè´¦æˆ·ã€‚' },
            { owner: 'é™ˆé™', description: 'åœ¨ä½ çš„æ‰‹æåŒ…å¤¹å±‚é‡Œï¼Œå‘ç°äº†ä¸€æ¡ä»·å€¼ä¸è²çš„é’»çŸ³é¡¹é“¾ï¼ŒåŒ…è£…ç›’è¿˜åœ¨ï¼Œä½†æ²¡æœ‰è´ºå¡ã€‚', isKey: true },
            { owner: 'å‘¨æ¯…', description: 'ä¸€ä»½ä¿å®‰å·¡é€»æ—¥å¿—ï¼Œæ¸…æ™°åœ°è®°å½•äº†ä½ åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°ä¸åŒäººè¿›å‡ºæ€»ç›‘åŠå…¬å®¤çš„æƒ…å†µã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨èŒ¶æ°´é—´åƒåœ¾æ¡¶é‡Œå‘ç°ä¸€ä¸ªç©ºçš„å®‰çœ è¯è¯ç“¶ï¼Œä¸Šé¢çš„æ ‡ç­¾è¢«æ’•æ‰äº†ã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨æ­»è€…åŠå…¬æ¡Œä¸‹å‘ç°ä¸€éƒ¨æ‰‹æœºï¼Œä½†ä¸æ˜¯æ­»è€…å¸¸ç”¨çš„é‚£éƒ¨ï¼Œæ‰‹æœºå·²ç»æ²¡ç”µäº†ã€‚' }
        ],
        truth: 'å‡¶æ‰‹æ˜¯äººäº‹ä¸»ç®¡é™ˆé™ã€‚å¥¹ä¸æ€»ç›‘ç‹å¼ºæœ‰ç§æƒ…ï¼Œä½†ç‹å¼ºè¿‘æœŸä¸ºäº†åˆ©ç›Šæƒ³å’Œå¥¹åˆ†æ‰‹å¹¶å¨¶ä¸€ä½å¯Œå®¶å¥³ã€‚å½“æ™šï¼Œé™ˆé™åœ¨ç‹å¼ºçš„å’–å•¡é‡Œä¸‹äº†è¿‡é‡å®‰çœ è¯ï¼Œæƒ³è®©ä»–ç¡ç€åå·èµ°ä»–æ‰‹æœºé‡Œå­˜æœ‰çš„ä¸¤äººäº²å¯†ç…§ç‰‡ã€‚ä½†ç”±äºè¯é‡è¿‡å¤§ï¼Œç‹å¼ºæ„å¤–æ­»äº¡ã€‚é™ˆé™åœ¨æ…Œä¹±ä¸­æ²¡æ‰¾åˆ°æ‰‹æœºï¼Œåè€Œä¸å°å¿ƒå°†ç‹å¼ºå‡†å¤‡é€ç»™å¯Œå®¶å¥³çš„é¡¹é“¾ç¢°è¿›äº†è‡ªå·±çš„åŒ…é‡Œã€‚'
    },
    // --- ã€å…¨æ–°å‰§æœ¬1ï¼šæ·±æµ·é—ä¹¦ã€‘ ---
    {
        id: 'built_in_2',
        name: 'æ·±æµ·é—ä¹¦',
        storyBackground: 'åœ¨ä¸ä¸–éš”ç»çš„â€œå›å“å²›â€ä¸Šï¼Œè‘—åçš„æµ·æ´‹å­¦å®¶æåšå£«è¢«å‘ç°æ­»åœ¨è‡ªå·±åé”çš„ä¹¦æˆ¿ä¸­ï¼Œæ¡Œä¸Šæ”¾ç€ä¸€å°æ‰“å°çš„é—ä¹¦ï¼Œæ­»å› ä¸ºæ°°åŒ–ç‰©ä¸­æ¯’ã€‚ä¸€åœºçªå¦‚å…¶æ¥çš„é£æš´åˆ‡æ–­äº†å²›ä¸Šä¸å¤–ç•Œçš„æ‰€æœ‰è”ç³»ï¼Œå°†å‰©ä¸‹çš„å››ä¸ªäººå›°åœ¨äº†è¿™åº§å­¤å²›ä¸Šï¼šæåšå£«çš„å¾—æ„é—¨ç”Ÿã€ä¸€ä½ç«äº‰å¯¹æ‰‹ã€ä¸€ä½æ²‰é»˜å¯¡è¨€çš„æŠ€æœ¯å‘˜ï¼Œä»¥åŠä¸€ä½ä¸è¯·è‡ªæ¥çš„è®°è€…ã€‚',
        roles: [
            {
                name: 'é«˜è¿œ',
                description: 'æåšå£«çš„å­¦ç”Ÿï¼Œæ‰åæ¨ªæº¢ä½†é‡å¿ƒå‹ƒå‹ƒã€‚',
                storyline: `æˆ‘ä¸€ç›´è§‰å¾—è€å¸ˆçªƒå–äº†æˆ‘çš„ç ”ç©¶æˆæœã€‚ä»Šæ™šï¼Œæˆ‘æœ¬æƒ³å’Œä»–æ‘Šç‰Œã€‚\n**æ™šä¸Š7:00**ï¼šæˆ‘å’Œè€å¸ˆåœ¨å®éªŒå®¤å¤§åµä¸€æ¶ï¼Œä»–æ‰¿è®¤å‚è€ƒäº†æˆ‘çš„æ•°æ®ï¼Œä½†æ‹’ç»å…¬å¼€æ‰¿è®¤ã€‚æˆ‘æ„¤æ€’åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å›åˆ°å®¿èˆï¼Œè¶Šæƒ³è¶Šæ°”ã€‚æˆ‘åˆ©ç”¨æƒé™ï¼Œè¿œç¨‹åˆ é™¤äº†éƒ¨åˆ†å¯¹ä»–æœ‰åˆ©ã€å¯¹æˆ‘ä¸åˆ©çš„æ ¸å¿ƒå®éªŒæ•°æ®ï¼Œæƒ³è®©ä»–æ— æ³•å‘å¸ƒè®ºæ–‡ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å»é£Ÿå ‚åƒé¥­ï¼Œçœ‹åˆ°æŠ€æœ¯å‘˜é™ˆé»˜åœ¨è°ƒè¯•ç›‘æ§è®¾å¤‡ï¼Œä»–çœ‹èµ·æ¥å¿ƒäº‹é‡é‡ã€‚\n**æ™šä¸Š9:45**ï¼šæˆ‘çœ‹åˆ°è®°è€…å¼ è±åœ¨æåšå£«ä¹¦æˆ¿é—¨å£å¾˜å¾Šï¼Œä¼¼ä¹æƒ³è¿›å»ä½†åˆä¸æ•¢ã€‚`,
                tasks: '1. éšè—ä½ å’Œè€å¸ˆçš„å­¦æœ¯çº çº·ä»¥åŠä½ åˆ é™¤æ•°æ®çš„è¡Œä¸ºã€‚\n2. ä½ è®¤ä¸ºè‡ªå·±çš„å‰é€”å—åˆ°äº†å¨èƒï¼Œå¿…é¡»æ‰¾åˆ°çœŸå‡¶æ¥æ´—æ¸…å«Œç–‘ã€‚\n3. å¼•å¯¼å¤§å®¶æ€€ç–‘å…¶ä»–æœ‰åŠ¨æœºçš„äººã€‚',
                isKiller: false
            },
            {
                name: 'æ—é›ª',
                description: 'å¦ä¸€ä½æµ·æ´‹å­¦å®¶ï¼Œä¸æåšå£«æ˜¯é•¿æœŸçš„ç«äº‰å¯¹æ‰‹ã€‚',
                storyline: `æˆ‘å’Œæåšå£«åœ¨ç«äº‰ä¸€ä¸ªé‡è¦çš„å›½é™…ç§‘ç ”åŸºé‡‘ã€‚æˆ‘çŸ¥é“ä»–è¿™æ¬¡çš„ç ”ç©¶æœ‰é‡å¤§çªç ´ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘å»æ‰¾æåšå£«ï¼Œå¸Œæœ›ä»–èƒ½åˆ†äº«ä¸€äº›æ•°æ®ï¼Œè¢«ä»–æ— æƒ…æ‹’ç»äº†ã€‚æˆ‘ä»¬ä¸æ¬¢è€Œæ•£ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„æˆ¿é—´é‡Œæ•´ç†èµ„æ–™ï¼Œå¬åˆ°å¤–é¢æœ‰å¥‡æ€ªçš„ç”µæµå£°ï¼Œå¥½åƒæ˜¯åœç”µäº†ä¸€ç¬é—´åˆæ¢å¤äº†ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å£æ¸´å»å¨æˆ¿å€’æ°´ï¼Œçœ‹åˆ°é«˜è¿œç¥è‰²æ…Œå¼ åœ°ä»æœºæˆ¿çš„æ–¹å‘å‡ºæ¥ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘ç»è¿‡ä¹¦æˆ¿æ—¶ï¼Œé—»åˆ°ä¸€è‚¡æ·¡æ·¡çš„æä»å‘³ï¼ˆæ°°åŒ–ç‰©çš„å…¸å‹æ°”å‘³ï¼‰ï¼Œä½†æˆ‘å½“æ—¶ä»¥ä¸ºæ˜¯å®éªŒå®¤çš„åŒ–å­¦å“å‘³é“ï¼Œæ²¡æœ‰åœ¨æ„ã€‚`,
                tasks: '1. æåšå£«çš„æ­»å¯¹ä½ çš„åŸºé‡‘ç”³è¯·æœ‰åˆ©ï¼Œè¿™æ˜¯ä½ çš„å«Œç–‘ç‚¹ï¼Œä½ éœ€è¦æ’‡æ¸…å…³ç³»ã€‚\n2. éšè—ä½ æ›¾ç§ä¸‹æ‰¾ä»–ç´¢è¦æ•°æ®è¢«æ‹’çš„äº‹å®ã€‚\n3. ä½ é—»åˆ°çš„æä»å‘³æ˜¯å…³é”®çº¿ç´¢ï¼Œéœ€è¦è®©å¤§å®¶çŸ¥é“ã€‚',
                isKiller: false
            },
            {
                name: 'é™ˆé»˜',
                description: 'ç ”ç©¶ç«™çš„æŠ€æœ¯å‘˜ï¼Œæ€§æ ¼å†…å‘ï¼Œæš—æ‹ç€æåšå£«ã€‚',
                storyline: `æˆ‘æ·±çˆ±ç€æåšå£«ï¼Œä½†å¥¹ä¼¼ä¹å¯¹æˆ‘æ¯«ä¸åœ¨æ„ã€‚æˆ‘æŒç®¡ç€æ•´ä¸ªç ”ç©¶ç«™çš„è®¾å¤‡å’Œç›‘æ§ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘æ¥åˆ°é«˜è¿œçš„è¯·æ±‚ï¼Œä»–è®©æˆ‘â€œä¸å°å¿ƒâ€è®©ç›‘æ§ç³»ç»Ÿæ–­ç”µä¸€åˆ†é’Ÿã€‚æˆ‘è™½ç„¶è§‰å¾—å¥‡æ€ªï¼Œä½†å› ä¸ºä»–ç­”åº”å¸®æˆ‘å‘æåšå£«è¯´å¥½è¯ï¼Œæˆ‘è¿˜æ˜¯ç…§åšäº†ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°æåšå£«æŠŠè‡ªå·±é”åœ¨ä¹¦æˆ¿é‡Œï¼Œç¥æƒ…æ‚²ä¼¤ã€‚æˆ‘å¾ˆéš¾è¿‡ï¼Œä½†ä¸æ•¢æ‰“æ‰°ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°è®°è€…å¼ è±è¯•å›¾æ’¬ä¹¦æˆ¿çš„é—¨é”ï¼Œè¢«æˆ‘å‘ç°åä»–æ…Œå¿™èµ°å¼€äº†ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘è¶Šæƒ³è¶Šä¸å¯¹åŠ²ï¼Œç”¨å¤‡ç”¨é’¥åŒ™æ‰“å¼€äº†ä¹¦æˆ¿çš„é—¨ï¼Œå‘ç°äº†åšå£«çš„å°¸ä½“ã€‚`,
                tasks: '1. éšè—ä½ æ›¾å—é«˜è¿œæŒ‡ä½¿ï¼Œäººä¸ºåˆ¶é€ ç›‘æ§æ–­ç”µçš„äº‹å®ã€‚\n2. ä½ æœ‰å¤‡ç”¨é’¥åŒ™ï¼Œè¿™è®©ä½ æœ‰é‡å¤§å«Œç–‘ï¼Œä½ éœ€è¦æ‰¾åˆ°åˆç†çš„è§£é‡Šã€‚\n3. ä½ æ€€ç–‘è®°è€…å¼ è±æœ‰ä¸è½¨è¡Œä¸ºã€‚',
                isKiller: false
            },
            {
                name: 'å¼ è±',
                description: 'ä¸€ä½è¿½è¸ªå­¦æœ¯ä¸‘é—»çš„è®°è€…ï¼Œç§˜å¯†ç™»å²›ã€‚',
                storyline: `æˆ‘æ”¶åˆ°çº¿æŠ¥ï¼Œç§°æåšå£«çš„ç ”ç©¶æ¶‰å«Œé€ å‡ï¼Œæˆ‘æ˜¯æ¥è°ƒæŸ¥çœŸç›¸çš„ã€‚ä»Šæ™šæ˜¯æœ€å¥½çš„æœºä¼šã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ç»•åˆ°æåšå£«ä¹¦æˆ¿çš„çª—å¤–ï¼Œçœ‹åˆ°å¥¹æ­£åœ¨ç”µè„‘å‰æ‰“å­—ï¼Œä¼¼ä¹åœ¨å†™ç€ä»€ä¹ˆé‡è¦çš„ä¸œè¥¿ã€‚æˆ‘ç”¨é•¿ç„¦ç›¸æœºæ‹ä¸‹äº†å‡ å¼ æ¨¡ç³Šçš„ç…§ç‰‡ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å°è¯•ä»æ­£é—¨è¿›å…¥ä¹¦æˆ¿ï¼Œæƒ³æ‰¾å¥¹å½“é¢å¯¹è´¨ï¼Œä½†é—¨è¢«åé”äº†ã€‚æˆ‘è¯•å›¾ç”¨é“ä¸å¼€é”ï¼Œç»“æœè¢«æŠ€æœ¯å‘˜é™ˆé»˜æ’è§äº†ï¼Œæˆ‘åªå¥½å‡è£…è·¯è¿‡ç¦»å¼€ã€‚\n**æ™šä¸Š9:50**ï¼šæˆ‘å›åˆ°è‡ªå·±çš„ä½å¤„ï¼Œæ”¾å¤§ç›¸æœºé‡Œçš„ç…§ç‰‡ï¼Œå‘ç°å¥¹æ‰“å­—çš„å†…å®¹ä¼¼ä¹æ˜¯ä¸€å°é—ä¹¦ï¼Œä½†å†…å®¹å¾ˆå¥‡æ€ªï¼Œå¥½åƒåœ¨æš—ç¤ºä»€ä¹ˆã€‚æˆ‘è¿˜æ‹åˆ°å¥¹æ¡Œä¸Šæœ‰ä¸€ä¸ªé¥æ§å™¨ä¸€æ ·çš„ä¸œè¥¿ã€‚`,
                tasks: '1. éšè—ä½ è®°è€…çš„èº«ä»½å’Œä½ ç™»å²›çš„çœŸå®ç›®çš„ã€‚\n2. ä½ æ‹åˆ°çš„ç…§ç‰‡æ˜¯å…³é”®è¯æ®ï¼Œä½†ç›´æ¥æ‹¿å‡ºæ¥ä¼šæš´éœ²ä½ è‡ªå·±ã€‚ä½ éœ€è¦å·§å¦™åœ°å¼•å¯¼å¤§å®¶å‘ç°é—ä¹¦å’Œé¥æ§å™¨çš„é—®é¢˜ã€‚\n3. ä½ æ˜¯å¤–æ¥è€…ï¼Œå«Œç–‘æœ€å¤§ï¼Œå¿…é¡»å°½å¿«æ‰¾åˆ°å‡¶æ‰‹ã€‚',
                isKiller: true
            }
        ],
        clues: [
            { owner: 'é«˜è¿œ', description: 'ä½ çš„ç”µè„‘å›æ”¶ç«™é‡Œæœ‰ä¸€ä»½æœªå‘é€çš„é‚®ä»¶ï¼Œå†…å®¹æ˜¯å‘ç«äº‰å¯¹æ‰‹çš„å…¬å¸æŠ•é€’ç®€å†ï¼Œå¹¶é™„è¨€å¯ä»¥æä¾›â€œæ¯”ç‰¹æ— é™â€çš„æ ¸å¿ƒä»£ç ã€‚' },
            { owner: 'æ—é›ª', description: 'åœ¨ä½ çš„æŠ½å±‰é‡Œï¼Œå‘ç°äº†ä¸€ç“¶æ ‡ç­¾è¢«æ’•æ‰çš„åŒ–å­¦è¯•å‰‚ï¼Œç»è¿‡æ£€éªŒï¼Œæ˜¯æ— æ¯’çš„è¥å…»æ¶²ã€‚' },
            { owner: 'é™ˆé»˜', description: 'ä¸€å¼ å·¥ä½œæ—¥å¿—ï¼Œä¸Šé¢å†™ç€â€œ20:30-20:31ï¼Œ18æ¥¼ä¸œåŒºæœåŠ¡å™¨æ„å¤–é‡å¯ï¼ŒåŸå› æ’æŸ¥ä¸­â€ã€‚'},
            { owner: 'å¼ è±', description: 'ä½ çš„ç›¸æœºé‡Œæœ‰å¤šå¼ ç…§ç‰‡ï¼Œå…¶ä¸­ä¸€å¼ æ¸…æ™°åœ°æ‹åˆ°æ­»è€…ç”µè„‘å±å¹•ä¸Šçš„é—ä¹¦å†…å®¹ï¼Œå¦ä¸€å¼ æ¨¡ç³Šåœ°æ‹åˆ°äº†æ¡Œä¸Šçš„ä¸€ä¸ªå°å‹é¥æ§è£…ç½®ã€‚', isKey: true },
            { owner: 'å…¬å…±', description: 'æ­»è€…æ‰‹è¾¹çš„å’–å•¡æ¯é‡Œæ£€æµ‹å‡ºé«˜æµ“åº¦çš„æ°°åŒ–ç‰©ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œå’–å•¡åŸºæœ¬æ²¡å–ã€‚' },
            { owner: 'å…¬å…±', description: 'ä¹¦æˆ¿çš„é€šé£å£å†…ä¾§ï¼Œå‘ç°ä¸€ä¸ªè¢«æ”¹è£…è¿‡çš„ã€è¿æ¥ç€å°å‹é›¾åŒ–å–·å˜´çš„é¥æ§é¦™è–°æœºï¼Œé‡Œé¢æ®‹ç•™æœ‰æ°°åŒ–ç‰©æ¶²ä½“ã€‚' },
            { owner: 'å…¬å…±', description: 'æ­»è€…çš„ç”µè„‘æµè§ˆå™¨å†å²æ˜¾ç¤ºï¼Œå¥¹åœ¨æ­»å‰æœ€åä¸€ä¸ªè®¿é—®çš„é¡µé¢æ˜¯å¥¹å·²æ•…ä¸ˆå¤«çš„çºªå¿µç½‘ç«™ã€‚' }
        ],
        truth: 'å‡¶æ‰‹æ˜¯è®°è€…å¼ è±ã€‚ä»–å¹¶éæƒ³æ€æ­»æåšå£«ï¼Œè€Œæ˜¯æƒ³åˆ¶é€ æ··ä¹±ä»¥çªƒå–å­¦æœ¯é€ å‡çš„è¯æ®ã€‚ä»–æå‰åœ¨ä¹¦æˆ¿çš„é€šé£å£å®‰è£…äº†é¥æ§æ¯’æ°”è£…ç½®ï¼Œè®¡åˆ’åœ¨é‡‡è®¿æ—¶å¦‚æœæåšå£«ä¸é…åˆï¼Œå°±å°‘é‡é‡Šæ”¾è®©å¥¹æ˜è¿·ã€‚ä½†ä»–æ²¡æƒ³åˆ°ï¼Œå½“æ™šæåšå£«å› ä¸ºæ€å¿µäº¡å¤«è€Œæƒ…ç»ªä½è½ï¼Œæ­£åœ¨å†™ä¸€å°çœŸçš„é—ä¹¦ã€‚å¼ è±åœ¨çª—å¤–çœ‹åˆ°é—ä¹¦ï¼Œè¯¯ä»¥ä¸ºæ—¶æœºå·²åˆ°ï¼Œä¾¿æŒ‰ä¸‹äº†é¥æ§å™¨ï¼Œå¯¼è‡´æåšå£«å¸å…¥è¿‡é‡æ¯’æ°”èº«äº¡ã€‚ä»–ä¹‹åå°è¯•è¿›å…¥æˆ¿é—´å–å›è£…ç½®æœªæœã€‚'
    },
    // --- ã€å…¨æ–°å‰§æœ¬2ï¼šå¤å ¡é­…å½±ã€‘ ---
    {
        id: 'built_in_3',
        name: 'å¤å ¡é­…å½±',
        storyBackground: 'åœ¨æµ“é›¾ç¬¼ç½©çš„åè¿œå¤å ¡é‡Œï¼Œå¯Œæœ‰è€Œå¤æ€ªçš„ä¼¯çˆµè¢«å‘ç°æ­»åœ¨åé”çš„ä¹¦æˆ¿ä¸­ï¼Œèƒ¸å£æ’ç€ä¸€æŠŠå¤è‘£æ‹†ä¿¡åˆ€ã€‚çŒ›çƒˆçš„æš´é£é›¨åˆ‡æ–­äº†åŸå ¡ä¸å¤–ç•Œçš„å”¯ä¸€æ¡¥æ¢ï¼Œæ‰€æœ‰äººéƒ½è¢«å›°äºæ­¤ï¼šä¼¯çˆµå¹´è½»è²Œç¾çš„å¦»å­ã€ä¸ä»–ç´ æœ‰å«Œéš™çš„ä¾„å­ã€è´Ÿå€ºç´¯ç´¯çš„ç§äººåŒ»ç”Ÿï¼Œä»¥åŠä¸€ä½è¢«è¯·æ¥è¿›è¡Œé™ç¥ä¼šçš„å¥³å·«ã€‚',
        roles: [
            {
                name: 'å®‰å¨œ',
                description: 'ä¼¯çˆµçš„å¹´è½»å¦»å­ï¼Œè¢«å¤–ç•Œä¼ è¨€æ˜¯ä¸ºäº†è´¢äº§æ‰å«ç»™å¹´è¿ˆçš„ä¼¯çˆµã€‚',
                storyline: `æˆ‘å—å¤Ÿäº†è¿™æ®µæ²¡æœ‰çˆ±æƒ…çš„å©šå§»ã€‚æˆ‘çˆ±ä¸Šäº†ä¾„å­çˆ±å¾·åï¼Œæˆ‘ä»¬è®¡åˆ’ç§å¥”ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œçˆ±å¾·ååœ¨èŠ±å›­ç§˜å¯†ä¼šé¢ï¼Œå•†é‡ç§å¥”çš„ç»†èŠ‚ã€‚æˆ‘å‘Šè¯‰ä»–ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€æ¡å¯ä»¥é€šå¾€ä¹¦æˆ¿çš„å¯†é“ã€‚\n**æ™šä¸Š9:00**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°ä¹¦æˆ¿ï¼Œå†æ¬¡å› ä¸ºæˆ‘è´­ä¹°å¥¢ä¾ˆå“çš„äº‹ä¸æˆ‘äº‰åµï¼Œå¹¶å¨èƒè¦ä¿®æ”¹é—å˜±ï¼Œå‰¥å¤ºæˆ‘çš„ç»§æ‰¿æƒã€‚æˆ‘æ„¤æ€’åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘å›åˆ°æˆ¿é—´ï¼Œæ”¶æ‹¾å¥½æˆ‘çš„ç å®å‡†å¤‡ç¦»å¼€ã€‚æ­¤æ—¶æˆ‘å¬åˆ°æ¥¼ä¸‹ä¼ æ¥ä¸€å£°å¥³äººçš„å°–å«ï¼Œä½†å¾ˆå¿«å°±æ¶ˆå¤±äº†ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘ä»æˆ¿é—´çš„å¯†é“å…¥å£è¿›å…¥ï¼Œæƒ³å»ä¹¦æˆ¿å·èµ°é—å˜±ã€‚å½“æˆ‘ä»ä¹¦æˆ¿çš„å£ç‚‰åèµ°å‡ºæ¥æ—¶ï¼Œå‘ç°ä¼¯çˆµå·²ç»å€’åœ¨è¡€æ³Šé‡Œã€‚æˆ‘å“åäº†ï¼Œç«‹åˆ»åŸè·¯è¿”å›ï¼Œä¸æ•¢å£°å¼ ã€‚`,
                tasks: '1. éšè—ä½ å’Œçˆ±å¾·åçš„ç§æƒ…ä»¥åŠç§å¥”è®¡åˆ’ã€‚\n2. éšè—ä½ æ›¾é€šè¿‡å¯†é“è¿›å…¥æ¡ˆå‘ç°åœºçš„äº‹å®ã€‚\n3. ä½ è®¤ä¸ºå‡¶æ‰‹æ˜¯å…¶ä»–äººï¼Œéœ€è¦å°½å¿«æ‰¾åˆ°è¯æ®æ´—è„±å«Œç–‘ã€‚',
                isKiller: false
            },
            {
                name: 'çˆ±å¾·å',
                description: 'ä¼¯çˆµçš„ä¾„å­ï¼Œæ”¾è¡ä¸ç¾ï¼Œæ˜¯åŸå ¡çš„æ³•å®šç»§æ‰¿äººï¼Œä½†ä¸ä¼¯çˆµå…³ç³»æ¶åŠ£ã€‚',
                storyline: `æˆ‘æ€¥éœ€ç”¨é’±ï¼Œä½†è€å®¶ä¼™ä¸€åˆ†é’±éƒ½ä¸è‚¯ç»™æˆ‘ã€‚æˆ‘ä»Šæ™šå‡†å¤‡å·ç‚¹ä¸œè¥¿å»å–ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œå®‰å¨œåœ¨èŠ±å›­è§é¢ï¼Œå¥¹å‘Šè¯‰æˆ‘ä¸€æ¡é€šå¾€ä¹¦æˆ¿çš„å¯†é“ï¼Œè¿™æ­£åˆæˆ‘æ„ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘çœ‹åˆ°åŒ»ç”Ÿé©¬ä¸è¡Œè‰²åŒ†åŒ†åœ°è¿›äº†ä¼¯çˆµçš„ä¹¦æˆ¿ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å‡†å¤‡é€šè¿‡å®‰å¨œå‘Šè¯‰æˆ‘çš„å¯†é“è¿›å…¥ä¹¦æˆ¿ï¼Œä½†åœ¨å¯†é“å£å¬åˆ°äº†é‡Œé¢æœ‰å¥‡æ€ªçš„å“åŠ¨ï¼Œæˆ‘å®³æ€•è¢«å‘ç°ï¼Œå°±é€€äº†å›æ¥ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åœ¨èµ°å»Šé‡Œé‡åˆ°äº†å¥³å·«ç½—å…°å¥³å£«ï¼Œå¥¹è­¦å‘Šæˆ‘ä»Šæ™šåŸå ¡ä¼šæœ‰è¡€å…‰ä¹‹ç¾ï¼Œè®©æˆ‘ä¸è¦ä¹±èµ°åŠ¨ã€‚å¥¹çš„çœ¼ç¥å¾ˆå¥‡æ€ªï¼Œè®©æˆ‘ä¸å¯’è€Œæ —ã€‚`,
                tasks: '1. éšè—ä½ è®¡åˆ’å·çªƒä»¥åŠçŸ¥é“å¯†é“çš„äº‹å®ã€‚\n2. ä¼¯çˆµæ­»äº†ï¼Œä½ æ˜¯æœ€å¤§å—ç›Šäººï¼Œä½ çš„å«Œç–‘æœ€å¤§ã€‚ä½ éœ€è¦å°†å«Œç–‘è½¬ç§»åˆ°ä»–äººèº«ä¸Šï¼Œæ¯”å¦‚åŒ»ç”Ÿæˆ–è¡Œä¸ºè¯¡å¼‚çš„å¥³å·«ã€‚\n3. ä½ éœ€è¦æ‰¾åˆ°å¯¹ä½ æœ‰åˆ©çš„è¯æ®ã€‚',
                isKiller: false
            },
            {
                name: 'é©¬ä¸åŒ»ç”Ÿ',
                description: 'ä¼¯çˆµçš„ç§äººåŒ»ç”Ÿï¼ŒåŒ»æœ¯é«˜æ˜ï¼Œä½†æ·±é™·èµŒåšå€ºåŠ¡ã€‚',
                storyline: `æˆ‘æ¬ äº†ä¼¯çˆµä¸€å¤§ç¬”é’±ï¼Œä»–æ‹¿èµ°äº†æˆ‘çš„è¡ŒåŒ»æ‰§ç…§ä½œä¸ºæŠµæŠ¼ï¼Œå¹¶å¨èƒå¦‚æœæˆ‘è¿˜ä¸ä¸Šé’±ï¼Œå°±è®©æˆ‘èº«è´¥åè£‚ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å»æ‰¾ä¼¯çˆµï¼Œæ³æ±‚ä»–å†å®½é™æˆ‘ä¸€æ®µæ—¶é—´ã€‚ä»–ä¸ä»…æ‹’ç»äº†ï¼Œè¿˜ç¾è¾±äº†æˆ‘ä¸€ç•ªã€‚æˆ‘ç»æœ›åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å›åˆ°æˆ‘çš„æˆ¿é—´ï¼Œå‡†å¤‡äº†ä¸€äº›å¼ºæ•ˆé•‡å®šå‰‚ï¼Œæˆ‘è®¡åˆ’è®©ä»–ç¡ç€ï¼Œç„¶åå·å›æˆ‘çš„è¡ŒåŒ»æ‰§ç…§ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å†æ¬¡æ¥åˆ°ä¹¦æˆ¿é—¨å£ï¼Œå´å¬åˆ°é‡Œé¢å®‰å¨œå’Œä¼¯çˆµåœ¨æ¿€çƒˆäº‰åµã€‚æˆ‘åªå¥½æš‚æ—¶æ”¾å¼ƒè®¡åˆ’ï¼Œèº²åœ¨é™„è¿‘è§‚å¯Ÿã€‚\n**æ™šä¸Š9:40å**ï¼šæˆ‘çœ‹åˆ°å®‰å¨œæ°”å†²å†²åœ°ç¦»å¼€åï¼Œå°±å†ä¹Ÿæ²¡äººè¿›å‡ºè¿‡ä¹¦æˆ¿ã€‚æˆ‘å› ä¸ºå®³æ€•ä¸€ç›´æ²¡æ•¢åŠ¨æ‰‹ï¼Œç›´åˆ°å°¸ä½“è¢«å‘ç°ã€‚`,
                tasks: '1. éšè—ä½ æ¬ ä¸‹å·¨é¢èµŒå€ºå¹¶è¢«ä¼¯çˆµå¨èƒçš„äº‹å®ã€‚\n2. éšè—ä½ å‡†å¤‡äº†é•‡å®šå‰‚å¹¶è®¡åˆ’å·ä¸œè¥¿çš„æ„å›¾ã€‚\n3. ä½ æ˜¯æœ€åä¸€ä¸ªè§åˆ°ä¼¯çˆµçš„äººä¹‹ä¸€ï¼Œä½ éœ€è¦è¯æ˜ä½ ç¦»å¼€åè¿˜æœ‰ä½œæ¡ˆæ—¶é—´ã€‚',
                isKiller: false
            },
            {
                name: 'ç½—å…°å¥³å£«',
                description: 'è‘—åçš„çµåª’ã€å¥³å·«ï¼Œè¢«ä¼¯çˆµè¯·æ¥è¿›è¡Œé™ç¥ä¼šï¼Œä¸åŸå ¡çš„â€œå¹½çµâ€å¯¹è¯ã€‚',
                storyline: `æˆ‘æ˜¯ä¸ªéª—å­ã€‚ä¼¯çˆµå‘ç°äº†æˆ‘çš„ç§˜å¯†ï¼Œå¹¶ä»¥æ­¤æ•²è¯ˆæˆ‘ï¼Œè®©æˆ‘å…è´¹ä¸ºä»–â€œæœåŠ¡â€ã€‚\n**æ™šä¸Š9:10**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°ä¹¦æˆ¿ï¼Œå†æ¬¡å¨èƒæˆ‘ï¼Œè¯´å¦‚æœä»Šæ™šçš„é™ç¥ä¼šä¸èƒ½è®©ä»–æ»¡æ„ï¼Œå°±è¦æ­ç©¿æˆ‘çš„ä¸€åˆ‡ã€‚æˆ‘æ„Ÿåˆ°å‰æ‰€æœªæœ‰çš„ææƒ§ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘å€Ÿå£å‡†å¤‡ä»ªå¼ï¼Œç‹¬è‡ªç•™åœ¨ä¹¦æˆ¿ã€‚ä¼¯çˆµèƒŒå¯¹ç€æˆ‘ï¼Œåœ¨æ¬£èµä¸€å¹…ç”»ã€‚æˆ‘çœ‹åˆ°æ¡Œä¸Šæœ‰ä¸€æŠŠé”‹åˆ©çš„æ‹†ä¿¡åˆ€ï¼Œä¸€æ—¶å†²åŠ¨ï¼Œæ‹¿èµ·åˆ€ä»èƒŒååˆºå‘äº†ä»–ã€‚ä»–å½“åœºå€’ä¸‹ã€‚æˆ‘å‘å‡ºä¸€å£°çŸ­ä¿ƒçš„å°–å«ï¼Œä½†ç«‹åˆ»æ‚ä½äº†å˜´ã€‚\n**æ™šä¸Š9:35**ï¼šæˆ‘æ…Œä¹±åœ°å°†ä¹¦æˆ¿é—¨ä»å†…åé”ï¼Œç„¶åä»å¢™è§’çš„ä¹¦æ¶åé¢å¯åŠ¨äº†å¯†é“ï¼ˆè¿™æ˜¯æˆ‘ä¹‹å‰å·å·å‘ç°çš„ï¼‰ï¼Œé€ƒç¦»äº†ç°åœºã€‚åœ¨å¯†é“ä¸­ï¼Œæˆ‘çš„ä¸€ç‰‡è•¾ä¸è¢–å£è¢«æŒ‚æ‰äº†ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘ä»å¯†é“å‡ºæ¥ï¼Œé‡åˆ°äº†çˆ±å¾·åï¼Œæˆ‘æ•…ä½œç¥ç§˜åœ°è­¦å‘Šä»–æœ‰è¡€å…‰ä¹‹ç¾ï¼Œä»¥æ©é¥°æˆ‘çš„æ…Œå¼ ã€‚`,
                tasks: '1. ä½ æ˜¯çœŸå‡¶ï¼ä½ çš„ä»»åŠ¡æ˜¯éšè—ä¸€åˆ‡ï¼Œå°†ç½ªè¡Œå«ç¥¸ç»™ä»–äººã€‚\n2. åˆ©ç”¨ä½ â€œå¥³å·«â€çš„èº«ä»½ï¼Œç¼–é€ ä¸€äº›é¬¼ç¥ä¹‹è¯´æ¥æ··æ·†è§†å¬ã€‚\n3. çˆ±å¾·åå’Œå®‰å¨œéƒ½çŸ¥é“å¯†é“ï¼Œè¿™æ˜¯å«ç¥¸ä»–ä»¬çš„å¥½æœºä¼šã€‚é©¬ä¸åŒ»ç”Ÿæœ‰å¼ºçƒˆçš„åŠ¨æœºï¼Œä¹Ÿå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚',
                isKiller: true
            }
        ],
        clues: [
            { owner: 'å®‰å¨œ', description: 'ä½ çš„ç å®ç›’é‡Œæœ‰ä¸€å¼ å•ç¨‹çš„ç«è½¦ç¥¨ï¼Œç›®çš„åœ°æ˜¯å·´é»ï¼Œæ—¶é—´æ˜¯æ˜å¤©ä¸€æ—©ã€‚' },
            { owner: 'çˆ±å¾·å', description: 'ä½ çš„å£è¢‹é‡Œæœ‰ä¸€å¼ å½“ç¥¨ï¼Œä¸Šé¢æ˜¯ä¸€æšå±äºä¼¯çˆµå®¶æ—çš„å¤è‘£æ€€è¡¨ã€‚' },
            { owner: 'é©¬ä¸åŒ»ç”Ÿ', description: 'ä½ çš„è¯ç®±é‡Œæœ‰ä¸€ç“¶å‡ ä¹æ»¡è£…çš„å¼ºæ•ˆé•‡å®šå‰‚ï¼Œä»¥åŠä¸€å¼ ä¼¯çˆµå†™çš„ã€è¦æ±‚ä½ ä¸€å‘¨å†…è¿˜æ¸…10ä¸‡è‹±é•‘æ¬ æ¬¾çš„å­—æ¡ã€‚' },
            { owner: 'ç½—å…°å¥³å£«', description: 'ä½ çš„é•¿è£™è¢–å£å¤„æœ‰ä¸€å—æ˜æ˜¾çš„æ’•è£‚ç—•è¿¹ï¼Œä¼¼ä¹æ˜¯è¢«ä»€ä¹ˆä¸œè¥¿æŒ‚åçš„ã€‚', isKey: true },
            { owner: 'å…¬å…±', description: 'åœ¨ä¹¦æˆ¿å£ç‚‰åé¢å‘ç°ä¸€ä¸ªéšè”½çš„æŒ‰é’®ï¼ŒæŒ‰ä¸‹åï¼Œæ—è¾¹çš„ä¸€æ•´é¢ä¹¦æ¶ä¼šæ—‹è½¬æ‰“å¼€ï¼Œéœ²å‡ºä¸€æ¡é€šå¾€æ¥¼ä¸Šèµ°å»Šçš„å¯†é“ã€‚' },
            { owner: 'å…¬å…±', description: 'åœ¨å¯†é“çš„åœ°æ¿ä¸Šï¼Œå‘ç°äº†ä¸€å°ç‰‡é»‘è‰²çš„è•¾ä¸å¸ƒæ–™ã€‚' },
            { owner: 'å…¬å…±', description: 'ä¼¯çˆµçš„ä¹¦æ¡Œä¸Šæ‘Šå¼€ç€ä¸€æœ¬å…³äºâ€œçµåª’ä¸æ¬ºè¯ˆâ€çš„ä¹¦ï¼Œå…¶ä¸­ä¸€é¡µç”¨çº¢ç¬”åœˆå‡ºäº†â€œç½—å…°å¥³å£«â€çš„åå­—ã€‚' }
        ],
        truth: 'å‡¶æ‰‹æ˜¯å¥³å·«ç½—å…°å¥³å£«ã€‚ä¼¯çˆµå‘ç°äº†å¥¹æ˜¯ä¸ªéª—å­å¹¶ä»¥æ­¤æ•²è¯ˆå¥¹ã€‚å½“æ™šï¼Œä¼¯çˆµå†æ¬¡å¨èƒå¥¹ï¼Œç½—å…°åœ¨ææƒ§å’Œæ„¤æ€’ä¹‹ä¸‹ï¼Œç”¨æ‹†ä¿¡åˆ€ä»èƒŒåæ€å®³äº†ä¼¯ä¸»ã€‚å¥¹çŸ¥é“åŸå ¡çš„å¯†é“ï¼Œäºæ˜¯åé”æˆ¿é—¨ï¼Œé€šè¿‡å¯†é“é€ƒç¦»ï¼Œä¼ªé€ äº†å¯†å®¤æ€äººæ¡ˆã€‚ä½†æ…Œä¹±ä¸­ï¼Œå¥¹çš„ä¸€ç‰‡è•¾fä¸è¢–å£æŒ‚åœ¨äº†å¯†é“é‡Œï¼Œæˆä¸ºäº†å…³é”®è¯æ®ã€‚'
    }
];

// â–²â–²â–² å‰§æœ¬åº“ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘ä»ä¸€ä¸ªå·²é¢†å®Œçš„çº¢åŒ…ä¸­æ‰¾å‡ºâ€œæ‰‹æ°”ç‹â€
 * @param {object} packet - å·²é¢†å®Œçš„çº¢åŒ…æ¶ˆæ¯å¯¹è±¡
 * @returns {object|null} - è¿”å›æ‰‹æ°”ç‹çš„ä¿¡æ¯ { name, amount }ï¼Œæˆ– null
 */
function findLuckyKing(packet) {
    const claimedBy = packet.claimedBy || {};
    const claimedEntries = Object.entries(claimedBy);
    
    // å¦‚æœçº¢åŒ…æ˜¯â€œæ‹¼æ‰‹æ°”â€ç±»å‹ï¼Œå¹¶ä¸”æœ‰è¶…è¿‡1ä¸ªäººé¢†å–
    if (packet.packetType === 'lucky' && claimedEntries.length > 1) {
        let luckyKing = { name: '', amount: -1 };
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
        return luckyKing;
    }
    return null; // å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ²¡æœ‰æ‰‹æ°”ç‹
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
let datingGameState = {
    isActive: false,
    scene: null,
    characterId: null,
    storyHistory: [],
    romance: 0,
    lust: 0,
    currentStoryText: "",
    currentSentenceIndex: -1,
    sentences: [],
    isSwitchingSentence: false,
    isNsfwMode: false,
    completion: 0
};
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€è¡Œæ–°ä»£ç  â–¼â–¼â–¼
let currentDatingSummary = null; // ç”¨äºæš‚å­˜å½“å‰ç»“ç®—å¡ç‰‡çš„æ•°æ®
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
        // geminiå¦‚æœæ˜¯å¤šä¸ªå¯†é’¥, é‚£ä¹ˆéšæœºè·å–ä¸€ä¸ª
    function getRandomValue(str) {
        // æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«é€—å·
        if (str.includes(',')) {
            // ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²å¹¶ç§»é™¤å¤šä½™ç©ºæ ¼
            const arr = str.split(',').map(item => item.trim());
            // ç”Ÿæˆéšæœºç´¢å¼• (0 åˆ° arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // è¿”å›éšæœºå…ƒç´ 
            return arr[randomIndex];
        }
        // æ²¡æœ‰é€—å·åˆ™ç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
        return str;
    }
    function isImage(text,content) {
        let currentImageData = content.image_url.url
        // æå–Base64æ•°æ®ï¼ˆå»æ‰å‰ç¼€ï¼‰
        const base64Data = currentImageData.split(',')[1];
        // æ ¹æ®å›¾ç‰‡ç±»å‹è·å–MIMEç±»å‹
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
            {text: `${text.text}ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡`},
            {
                inline_data: {
                    mime_type: mimeType,
                    data: base64Data
                }
            }
        ]
    }

   function extractArray(text) {
        // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼šåŒ¹é…å¼€å¤´çš„æ—¶é—´æˆ³éƒ¨åˆ†å’Œåç»­çš„JSONæ•°ç»„
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
            const timestampPart = `(Timestamp: ${match[1]}) `;
            const jsonPart = match[2].trim();

            try {
                // å°è¯•è§£æJSONéƒ¨åˆ†
                const parsedJson = JSON.parse(jsonPart);
                // éªŒè¯è§£æç»“æœæ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(parsedJson)) {
                    return [timestampPart, parsedJson[0]];
                }
            } catch (error) {
                // è§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
            }
        }

        // ä¸åŒ¹é…æ ¼å¼æˆ–è§£æå¤±è´¥æ—¶è¿”å›åŸå€¼
        return text;
    }
    function transformChatData(item) {
        let type = {
            send_and_recall:'æ’¤å›äº†æ¶ˆæ¯',
            update_status:'æ›´æ–°äº†çŠ¶æ€',
            change_music:'åˆ‡æ¢äº†æ­Œæ›²',
            create_memory:'è®°å½•äº†å›å¿†',
            create_countdown:'åˆ›å»ºäº†çº¦å®š/å€’è®¡æ—¶',
            text:'å‘é€äº†æ–‡æœ¬',
            sticker:'å‘é€äº†è¡¨æƒ…',
            ai_image:'å‘é€äº†å›¾ç‰‡',
            voice_message:'å‘é€äº†è¯­éŸ³',
            transfer:'å‘èµ·äº†è½¬è´¦',
            waimai_request:'å‘èµ·äº†å¤–å–è¯·æ±‚',
            waimai_response:{
                paid:'å›åº”äº†å¤–å–-åŒæ„',
                rejected:'å›åº”äº†å¤–å–-æ‹’ç»'
            },
            video_call_request:'å‘èµ·äº†è§†é¢‘é€šè¯',
            video_call_response:{
                accept:'å›åº”äº†è§†é¢‘é€šè¯-æ¥å—',
                reject:'å›åº”äº†è§†é¢‘é€šè¯-æ‹’ç»'
            },
            qzone_post:{
                shuoshuo:'å‘å¸ƒäº†è¯´è¯´',
                text_image:'å‘å¸ƒäº†æ–‡å­—å›¾'
            },
            qzone_comment:'è¯„è®ºäº†åŠ¨æ€',
            qzone_like:'ç‚¹èµäº†åŠ¨æ€',
            pat_user:'æ‹ä¸€æ‹äº†ç”¨æˆ·',
            block_user:'æ‹‰é»‘äº†ç”¨æˆ·',
            friend_request_response:'å›åº”äº†å¥½å‹ç”³è¯·',
            change_avatar:'æ›´æ¢äº†å¤´åƒ',
            share_link:'åˆ†äº«äº†é“¾æ¥',
            accept_transfer:'å›åº”äº†è½¬è´¦-æ¥å—',
            decline_transfer:'å›åº”äº†è½¬è´¦-æ‹’ç»/é€€æ¬¾',
            quote_reply:'å¼•ç”¨äº†å›å¤',
            text:'',
        }
        let res = extractArray(item.content)

        if(Array.isArray(res)){
            let obj = res[1]
            let itemType = obj.type;
            let time = res[0]
            let text = type[itemType];
            if(text){
                if(itemType === 'sticker'){
                    return [{text:`${time}[${text}] å«ä¹‰æ˜¯:${obj.meaning}`}]
                }else if(itemType === 'send_and_recall'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'update_status'){
                    return [{text:`${time}[${text}] ${obj.status_text}(${obj.is_busy ? 'å¿™ç¢Œ/ç¦»å¼€' : 'ç©ºé—²'})`}]
                }else if(itemType === 'change_music'){
                    return [{text:`${time}[${text}] ${obj.change_music}, æ­Œåæ˜¯:${obj.song_name}`}]
                }else if(itemType === 'create_memory'){
                    return [{text:`${time}[${text}] ${obj.description}`}]
                }else if(itemType === 'create_countdown'){
                    return [{text:`${time}[${text}] ${obj.title}(${obj.date})`}]
                }else if(itemType === 'ai_image'){
                    return [{text:`${time}[${text}] å›¾ç‰‡æè¿°æ˜¯:${obj.description}`}]
                }else if(itemType === 'voice_message'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'transfer'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å¤‡æ³¨æ˜¯:${obj.amount}`}]
                }else if(itemType === 'waimai_request'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å•†å“æ˜¯:${obj.productInfo}`}]
                }else if(itemType === 'waimai_response'){
                    return [{text:`${time}[${text[obj.status]}] ${obj.status === 'paid' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text}]`}]
                }}else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text[obj.decision]}] ${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'qzone_post'){
                    return [{text:`${time}[${text[obj.postType]}] ${obj.postType === 'shuoshuo' ? `${obj.content}` : `å›¾ç‰‡æè¿°æ˜¯:${obj.hiddenContent} ${obj.publicText ? `æ–‡æ¡ˆæ˜¯: ${obj.publicText}` : ''}`}`}]
                }else if(itemType === 'qzone_comment'){
                    return [{text:`${time}[${text}] è¯„è®ºçš„idæ˜¯: ${obj.postId} è¯„è®ºçš„å†…å®¹æ˜¯: ${obj.commentText}`}]
                }else if(itemType === 'qzone_like'){
                    return [{text:`${time}[${text}] ç‚¹èµçš„idæ˜¯: ${obj.postId}`}]
                }else if(itemType === 'pat_user'){
                    return [{text:`${time}[${text}] ${obj.suffix ? obj.suffix  : ''}`}]
                }else if(itemType === 'block_user'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'friend_request_response'){
                    return [{text:`${time}[${text}] ç»“æœæ˜¯:${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'change_avatar'){
                    return [{text:`${time}[${text}] å¤´åƒåæ˜¯:${obj.name}`}]
                }else if(itemType === 'share_link'){
                    return [{text:`${time}[${text}] æ–‡ç« æ ‡é¢˜æ˜¯:${obj.title}  æ–‡ç« æ‘˜è¦æ˜¯:${obj.description} æ¥æºç½‘ç«™åæ˜¯:${obj.source_name} æ–‡ç« æ­£æ–‡æ˜¯:${obj.content}`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'quote_reply'){
                    return [{text:`${time}[${text}] å¼•ç”¨çš„å†…å®¹æ˜¯:${obj.reply_content}`}]
                }else if(itemType === 'text'){
                    return [{text:`${time}${obj.content}`}]
                }
            }

    // (ä¾‹å¦‚ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ–è€…ä¸€ä¸ªAIè¿”å›çš„ã€æˆ‘ä»¬ä¸è®¤è¯†çš„JSONå¯¹è±¡)
    if (typeof res !== 'string') {
        // æˆ‘ä»¬å°±å¼ºåˆ¶ä½¿ç”¨æœ€åŸå§‹ã€æœ€å®‰å…¨çš„ item.content å­—ç¬¦ä¸²
        res = item.content;
    }

    return [{text: res}];
}

    function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision, isGemini, temperature) {

	if(!isGemini){
		return undefined
	}

        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°† 'system' è§’è‰²ä¹Ÿæ˜ å°„ä¸º 'user'

        let roleType = {
            user: 'user',
            assistant: 'model',
            system: 'user' // <--- æ–°å¢è¿™ä¸€è¡Œ
        }
        return {
            url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
            data: {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: messagesForDecision.map((item) => {
                        let  includesImages = false;
                        if(Array.isArray(item.content) && item.content.length === 2){
                              includesImages =  item.content.some((sub)=>{
                                return sub.type === 'image_url' && sub.image_url.url
                            })
                        }
                        return {
                            role: roleType[item.role], // ç°åœ¨ 'system' ä¼šè¢«æ­£ç¡®è½¬æ¢ä¸º 'user'
                            parts: includesImages ? isImage(item.content[0],item.content[1]) : transformChatData(item)
                        }
                    }),
                    generationConfig: {
                        temperature: parseFloat(temperature) || 0.8,
                    },
                    "systemInstruction": {
                        "parts": [{
                            "text": systemInstruction
                        }]
                    }
                })
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
        // ===================================================================
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©æ•°å€¼è¡°å‡ç›¸å…³çš„å…¨å±€å˜é‡å’Œå¸¸é‡ â–¼â–¼â–¼
const PET_DECAY_INTERVAL = 60 * 60 * 1000; // æ¯60åˆ†é’Ÿè¡°å‡ä¸€æ¬¡
const PET_DECAY_AMOUNT = { // æ¯æ¬¡è¡°å‡çš„æ•°å€¼
    hunger: 5,
    happiness: 3
};
let petDecayTimer = null; // ç”¨äºç®¡ç†è¡°å‡è®¡æ—¶å™¨çš„å…¨å±€å˜é‡
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§’è‰²æ‰‹æœºçš„Appåˆ—è¡¨ï¼Œè¯·ç²˜è´´åˆ°JSé¡¶éƒ¨ â–¼â–¼â–¼
const CHAR_PHONE_APPS = [
    { id: 'chat', name: 'å¾®ä¿¡', screen: 'character-chat-list-screen', svg: `<svg viewBox="0 0 24 24" fill="#4CAF50"><path d="M12 2C6.48 2 2 6.48 2 12c0 2.94 1.28 5.58 3.34 7.42c-.22 1.4-.89 3.1-1.25 3.82c-.36.72.48 1.39 1.05.94c.82-.67 2.43-1.88 3.3-2.58C9.44 21.78 10.68 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm3.5 10.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5zm-7 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg>` },
    { id: 'cart', name: 'è´­ç‰©è½¦', screen: 'character-shopping-cart-screen', svg: `<svg viewBox="0 0 24 24" fill="#F44336"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2s-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2s2-.9 2-2s-.9-2-2-2zm-15-14h3.27l.94 2H20c.69 0 1.25.56 1.25 1.25c0 .09-.02.18-.04.27l-3.58 6.49c-.25.44-.73.74-1.26.74H8.52l-.94-2H4.27V4H2V2h3.27z"/></svg>` },
    { id: 'memos', name: 'å¤‡å¿˜å½•', screen: 'character-memos-screen', svg: `<svg viewBox="0 0 24 24" fill="#FFC107"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>` },
    { id: 'browser', name: 'æµè§ˆå™¨', screen: 'character-browser-screen', svg: `<svg viewBox="0 0 24 24" fill="#2196F3"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.5-12.5l3 7.5 7.5-3-7.5-3z"/></svg>` },
    { id: 'album', name: 'ç›¸å†Œ', screen: 'character-album-screen', svg: `<svg viewBox="0 0 24 24" fill="#8BC34A"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg>` },
    { id: 'bank', name: 'é’±åŒ…', screen: 'character-bank-screen', svg: `<svg viewBox="0 0 24 24" fill="#E91E63"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>` },
    { id: 'trajectory', name: 'è¶³è¿¹', screen: 'character-trajectory-screen', svg: `<svg viewBox="0 0 24 24" fill="#795548"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>` },
    { id: 'app_usage', name: 'ä½¿ç”¨è®°å½•', screen: 'character-app-usage-screen', svg: `<svg viewBox="0 0 24 24" fill="#607D8B"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8s8 3.58 8 8s-3.58 8-8 8zm.5-13H11v6l5.25 3.15l.75-1.23l-4.5-2.67z"/></svg>` },
    { id: 'diary', name: 'æ—¥è®°', screen: 'character-diary-screen', svg: `<svg viewBox="0 0 24 24" fill="#009688"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75 1.83-1.83z"/></svg>` },
    // è¿™å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„App
    { id: 'appearance', name: 'å¤–è§‚è®¾ç½®', screen: 'character-phone-appearance-screen', svg: `<svg viewBox="0 0 24 24" fill="#9C27B0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.17 14.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34-5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32L11.41 8.5c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34 5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.4-.4-.4-1.04 0-1.41l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.2.2.31.45.31.71 0 .26-.11.51-.31.71l-1.41 1.41z"/></svg>` }
];
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–° | AIç”Ÿæˆç‰ˆ V4ã€‘çº¦ä¼šå¤§ä½œæˆ˜Appæ ¸å¿ƒåŠŸèƒ½ --- */

// 1. å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰å·²ç”Ÿæˆçš„çº¦ä¼šåœºæ™¯
let currentDatingScenes = []; 
let isGeneratingScenes = false;
let currentDatingUISettings = null; 
/* --- ã€å…¨æ–° | V5 - æ°¸ä¹…ä¿å­˜ä¿®å¤ç‰ˆã€‘çº¦ä¼šå¤§ä½œæˆ˜Appæ ¸å¿ƒåŠŸèƒ½ --- */

/**
 * ã€æ€»å…¥å£ V6ã€‘æ‰“å¼€â€œçº¦ä¼šå¤§ä½œæˆ˜â€Appï¼Œå¿«é€Ÿæ˜¾ç¤ºå·²ä¿å­˜æ•°æ®
 */
async function openDatingApp() {
    showScreen('date-a-live-screen');
    // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å·²ä¿å­˜çš„åœºæ™¯
    currentDatingScenes = await db.datingScenes.toArray();
    console.log(`ä»æ•°æ®åº“åŠ è½½äº† ${currentDatingScenes.length} ä¸ªçº¦ä¼šåœºæ™¯ã€‚`);
    // æ¸²æŸ“è¿™äº›åœºæ™¯ï¼ˆåªä¼šå…ˆæ˜¾ç¤ºæ–‡å­—å’ŒåŠ è½½åŠ¨ç”»ï¼‰
    renderDatingScenes();
}

/**
 * ã€AIæ ¸å¿ƒ V6ã€‘è°ƒç”¨AIç”Ÿæˆã€æ–°çš„ä¸€æ‰¹ã€‘çº¦ä¼šåœºæ™¯ï¼Œå¹¶ã€åªä¿å­˜åœºæ™¯æ•°æ®ã€‘
 */
async function refreshDatingScenes() {
    if (isGeneratingScenes) {
        alert("æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ä¸è¦ç€æ€¥å“¦~");
        return;
    }
    isGeneratingScenes = true;

    const contentEl = document.getElementById('dating-scene-content');
    const loadingIndicator = document.createElement('p');
    loadingIndicator.textContent = "AIæ­£åœ¨æ„æ€æ–°çš„çº¦ä¼šæ–¹æ¡ˆ...";
    loadingIndicator.style.textAlign = 'center';
    loadingIndicator.style.color = 'var(--text-secondary)';
    contentEl.innerHTML = ''; // å…ˆæ¸…ç©ºæ—§åœºæ™¯
    contentEl.appendChild(loadingIndicator);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        loadingIndicator.textContent = 'APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆåœºæ™¯ï¼';
        loadingIndicator.style.color = 'red';
        isGeneratingScenes = false;
        return;
    }
    
    // Promptä¿æŒä¸å˜
    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä½é¡¶çº§çº¦ä¼šç­–åˆ’å¸ˆï¼Œå°¤å…¶æ“…é•¿è¥é€ æµªæ¼«æ°›å›´ã€‚è¯·ä¸ºæˆ‘ç­–åˆ’ 3-5 ä¸ªé€‚åˆæƒ…ä¾£çš„ã€æ—¥å¸¸ä¸”æå…·æµªæ¼«æƒ…è°ƒçš„çº¦ä¼šåœºæ™¯ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åœºæ™¯é£æ ¼**: åœºæ™¯å¿…é¡»æ˜¯ç°å®ç”Ÿæ´»ä¸­å¯ä»¥å®ç°çš„ï¼Œä½†è¦å¯Œæœ‰æƒ³è±¡åŠ›å’Œæµªæ¼«æ°”æ¯ã€‚**ç»å¯¹ç¦æ­¢**ä»»ä½•é»‘æš—ã€ææ€–æˆ–ä»¤äººä¸é€‚çš„å…ƒç´ ã€‚
2.  **åœºæ™¯å¤šæ ·æ€§**: è¯·åŒ…å«å¤šç§ç±»å‹çš„åœ°ç‚¹ï¼Œä¾‹å¦‚ï¼š
    -   **æˆ·å¤–**: å…¬å›­ã€æµ·è¾¹ã€è·¯è¾¹å°åƒæ‘Šã€‚
    -   **å®¤å†…**: æ¸©é¦¨çš„å’–å•¡é¦†ã€è‰ºæœ¯å±•ã€ä¹¦åº—ã€‚
    -   **ä½å®¿**: æ™®é€šçš„æ¸©é¦¨é…’åº—ã€ç”µç«é…’åº—ã€ç”šè‡³å¯ä»¥æ¥ç‚¹æ–°å¥‡çš„æƒ…è¶£é…’åº—ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥'['å¼€å¤´, ä»¥']'ç»“å°¾ã€‚
4.  **å†…å®¹è¦æ±‚**: æ¯ä¸ªåœºæ™¯å¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µ:
    -   \`"name"\`: (å­—ç¬¦ä¸²) ä¸€ä¸ªå……æ»¡æµªæ¼«æƒ³è±¡çš„æ—¥å¸¸çº¦ä¼šåœºæ™¯åç§° (ä¾‹å¦‚: "æ˜Ÿç©ºä¸‹çš„ç”µç«åŒæ’å¤œ", "å¾®é†ºè·¯è¾¹æ‘Šçš„å¤æ—¥æ™šé£", "ç§è¯­ä¹¦åº—çš„è§’è½")ã€‚
    -   \`"cost"\`: (æ•°å­—) ä¸€ä¸ªä»£è¡¨æµªæ¼«ç¨‹åº¦çš„è™šæ‹ŸèŠ±è´¹ (ä¾‹å¦‚: 288, 520, 999)ã€‚
    -   \`"imagePrompt"\`: (å­—ç¬¦ä¸²) ä¸€ä¸ªç”¨äºæ–‡ç”Ÿå›¾çš„ã€çº¯è‹±æ–‡çš„ã€è¯¦ç»†çš„ã€çº¯é£æ™¯æˆ–é™ç‰©ã€‘æè¿°ï¼Œç”¨äºç”Ÿæˆåœºæ™¯å›¾ç‰‡ã€‚ã€ç»å¯¹ä¸èƒ½åŒ…å«äººç‰©ã€æƒ…ä¾£æˆ–ä»»ä½•äººã€‘ã€‚å›¾ç‰‡é£æ ¼å¿…é¡»æ˜¯ã€æµªæ¼«å”¯ç¾çš„ (romantic, beautiful, aesthetic)ã€‘ï¼Œå¯ä»¥ä½¿ç”¨ anime style, vibrant colors, soft lighting, masterpiece ç­‰è¯æ±‡æ¥å¢å¼ºè‰ºæœ¯æ„Ÿã€‚

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "é›¨åå…¬å›­çš„ä¸ƒå½©éœ“è™¹",
    "cost": 188,
    "imagePrompt": "a peaceful park after rain, wet cobblestone path reflecting neon city lights, rainbow puddle, glowing lanterns on trees, beautiful, aesthetic, anime style, masterpiece, vibrant colors"
  }
]
`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.1, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newScenes = JSON.parse(cleanedContent);

        if (Array.isArray(newScenes)) {
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåªæ·»åŠ uidå’Œç©ºçš„imageUrlï¼Œä¸å†ç«‹å³ç”Ÿæˆå›¾ç‰‡ â˜…â˜…â˜…
            const scenesWithId = newScenes.map((scene, index) => ({
                ...scene,
                uid: 'scene_' + Date.now() + index,
                imageUrl: '' // åˆå§‹åŒ–æ—¶å›¾ç‰‡é“¾æ¥ä¸ºç©º
            }));

            await db.datingScenes.bulkAdd(scenesWithId);

            // æ›´æ–°å†…å­˜æ•°æ®ï¼Œå¹¶é‡æ–°æ¸²æŸ“ï¼ˆæ­¤æ—¶å›¾ç‰‡è¿˜æ˜¯åŠ è½½ä¸­çŠ¶æ€ï¼‰
            currentDatingScenes.push(...scenesWithId); 
            renderDatingScenes(); 
            
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆçº¦ä¼šåœºæ™¯å¤±è´¥:", error);
        contentEl.innerHTML = `<p style="text-align:center; color:red;">ç”Ÿæˆå¤±è´¥: ${error.message}</p>`;
    } finally {
        isGeneratingScenes = false;
    }
}

/**
 * ã€æ¸²æŸ“å‡½æ•° - å·²æ”¹é€ ã€‘æ¸²æŸ“æ‰€æœ‰çº¦ä¼šåœºæ™¯å¡ç‰‡ï¼Œå¹¶ã€å¼‚æ­¥ã€‘åŠ è½½å›¾ç‰‡
 */
function renderDatingScenes() {
    const contentEl = document.getElementById('dating-scene-content');
    contentEl.innerHTML = ''; // æ¯æ¬¡éƒ½æ¸…ç©ºå†æ¸²æŸ“

    if (currentDatingScenes.length === 0) {
        // å¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼Œæ˜¾ç¤ºæç¤ºå¹¶è§¦å‘ä¸€æ¬¡ç”Ÿæˆ
        if (!isGeneratingScenes) {
            contentEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 50px 0;">æ­£åœ¨ä¸ºä½ æ„æ€æµªæ¼«çš„çº¦ä¼šæ–¹æ¡ˆ...</p>';
            refreshDatingScenes(); 
        }
        return;
    }
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ forEach ç«‹å³æ¸²æŸ“æ‰€æœ‰å¡ç‰‡ â˜…â˜…â˜…
    currentDatingScenes.forEach(scene => {
        const card = createDatingSceneCard(scene);
        contentEl.appendChild(card);
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æ–°çš„å¼‚æ­¥å‡½æ•°å»å¤„ç†å›¾ç‰‡ â˜…â˜…â˜…
        loadAndDisplaySceneImage(scene);
    });
}
/**
 * ã€å…¨æ–°è¾…åŠ©å‡½æ•°ã€‘ä¸ºå•ä¸ªåœºæ™¯åŠ è½½æˆ–ç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶æ›´æ–°å…¶å¡ç‰‡
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 */
async function loadAndDisplaySceneImage(scene) {
    const card = document.querySelector(`.dating-scene-card[data-uid="${scene.uid}"]`);
    if (!card) return;
    const imageContainer = card.querySelector('.dating-scene-image-container');

    // 1. å¦‚æœæ•°æ®åº“é‡Œå·²ç»æœ‰å›¾ç‰‡URLï¼Œç›´æ¥ä½¿ç”¨å®ƒ
    if (scene.imageUrl) {
        imageContainer.innerHTML = `<img src="${scene.imageUrl}" alt="${scene.name}">`;
        return;
    }

    // 2. å¦‚æœæ²¡æœ‰URLï¼Œè¯´æ˜éœ€è¦ç”Ÿæˆ
    try {
        const imageUrl = await generateAndLoadImage(scene.imagePrompt);
        // ç”ŸæˆæˆåŠŸåï¼Œæ›´æ–°UI
        if (document.body.contains(imageContainer)) {
             imageContainer.innerHTML = `<img src="${imageUrl}" alt="${scene.name}">`;
        }
       
        // â˜…â˜…â˜… å…³é”®ï¼šå°†æ–°ç”Ÿæˆçš„URLä¿å­˜å›æ•°æ®åº“ï¼â˜…â˜…â˜…
        scene.imageUrl = imageUrl;
        await db.datingScenes.update(scene.uid, { imageUrl: imageUrl });
        console.log(`ä¸ºåœºæ™¯ "${scene.name}" ç”Ÿæˆå¹¶ä¿å­˜äº†æ–°å›¾ç‰‡ã€‚`);

    } catch (error) {
        console.error(`åœºæ™¯ "${scene.name}" å›¾ç‰‡æ¸²æŸ“å¤±è´¥:`, error);
        if (document.body.contains(imageContainer)) {
            imageContainer.innerHTML = `<span>å›¾ç‰‡åŠ è½½å¤±è´¥</span>`;
        }
    }
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®å”¯ä¸€IDåˆ é™¤ä¸€ä¸ªçº¦ä¼šåœºæ™¯ (å·²æ·»åŠ æ•°æ®åº“æ“ä½œ)
 * @param {string} sceneUid - åœºæ™¯çš„å”¯ä¸€ID
 */
async function deleteDatingScene(sceneUid) {
    const cardToRemove = document.querySelector(`.dating-scene-card[data-uid="${sceneUid}"]`);
    if (cardToRemove) {
        cardToRemove.style.transition = 'transform 0.3s, opacity 0.3s';
        cardToRemove.style.transform = 'scale(0.9)';
        cardToRemove.style.opacity = '0';
        setTimeout(async () => {
            await db.datingScenes.delete(sceneUid);
            currentDatingScenes = currentDatingScenes.filter(scene => scene.uid !== sceneUid);
            cardToRemove.remove();
        }, 300);
    }
}


// (ä½ åŸæ¥çš„å…¶ä»–è¾…åŠ©å‡½æ•° processSceneImages, createDatingSceneCard, generateAndLoadImage ä¿æŒä¸å˜ï¼Œæˆ‘å·²ç»å¸®ä½ æ•´åˆå¥½äº†)
async function processSceneImages(newScenes) {
    const contentEl = document.getElementById('dating-scene-content');

    for (const scene of newScenes) {
        const card = createDatingSceneCard(scene);
        contentEl.appendChild(card);
        
        try {
            const imageUrl = await generateAndLoadImage(scene.imagePrompt);
            const imageContainer = card.querySelector('.dating-scene-image-container');
            if (imageContainer) {
                imageContainer.innerHTML = `<img src="${imageUrl}" alt="${scene.name}">`;
            }
        } catch (error) {
            console.error(`åœºæ™¯ "${scene.name}" å›¾ç‰‡ç”Ÿæˆå¤±è´¥:`, error);
            const imageContainer = card.querySelector('.dating-scene-image-container');
            if (imageContainer) {
                imageContainer.innerHTML = `<span>å›¾ç‰‡ç”Ÿæˆå¤±è´¥</span>`;
            }
        }
    }
}

function createDatingSceneCard(scene) {
    const card = document.createElement('div');
    card.className = 'dating-scene-card';
    card.dataset.uid = scene.uid;

    card.innerHTML = `
        <button class="dating-scene-delete-btn" title="åˆ é™¤æ­¤åœºæ™¯">Ã—</button>
        <div class="dating-scene-image-container">
            <div class="loading-spinner"></div>
        </div>
        <div class="dating-scene-info">
            <div class="name">${scene.name}</div>
            <div class="cost">èŠ±è´¹: ${scene.cost}é‡‘å¸</div>
        </div>
    `;
    return card;
}

function generateAndLoadImage(prompt) {
    return new Promise((resolve, reject) => {
        const encodedPrompt = encodeURIComponent(prompt);
        const seed = Math.floor(Math.random() * 100000);
        const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=640&seed=${seed}`;
        
        const img = new Image();
        img.src = imageUrl;

        img.onload = () => resolve(imageUrl);
        img.onerror = () => {
            console.warn(`ä¸»URLåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL for: ${prompt}`);
            const fallbackUrl = `https://pollinations.ai/p/${encodedPrompt}?width=1024&height=640&seed=${seed}`;
            img.src = fallbackUrl;
            img.onload = () => resolve(fallbackUrl);
            img.onerror = () => reject(new Error('ä¸»åŸŸåå’Œå¤‡ç”¨åŸŸåå‡åŠ è½½å¤±è´¥'));
        };
    });
}
/* --- çº¦ä¼šå¤§ä½œæˆ˜åŠŸèƒ½ç»“æŸ --- */

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²


// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–²â–²â–² ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
const db = new Dexie('GeminiChatDB');
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

        // â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšåŠŸèƒ½ä»£ç ï¼Œç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼

/**
 * ã€å¾®åšã€‘æ€»å…¥å£ï¼šæ ¹æ®å½“å‰æ¿€æ´»çš„è§†å›¾ï¼Œæ¸²æŸ“å¯¹åº”çš„å¾®åšFeed
 */
async function renderWeiboFeeds(viewId) {
    if (viewId === 'weibo-my-profile-view') {
        await renderMyWeiboFeed();
    } else if (viewId === 'weibo-following-view') {
        await renderFollowingWeiboFeed();
    }
}

// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸¤å—æ–°ä»£ç ã€‘åˆ†åˆ«æ›¿æ¢æ—§çš„ renderMyWeiboFeed å’Œ renderFollowingWeiboFeed å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å¾®åšã€‘æ¸²æŸ“â€œæˆ‘çš„ä¸»é¡µâ€ä¸Šçš„å¾®åšåˆ—è¡¨
 */
async function renderMyWeiboFeed() {
    const feedEl = document.getElementById('my-weibo-feed-list');
    const posts = await db.weiboPosts.where('authorId').equals('user').reverse().toArray();
    feedEl.innerHTML = '';
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ä½ è¿˜æ²¡æœ‰å‘è¿‡å¾®åšå“¦ï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€è¯•è¯•å§ï¼</p>';
        return;
    }
    posts.forEach(post => {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æˆ‘ä»¬æ–°çš„ä¸“å±å‡½æ•°ï¼
        feedEl.appendChild(createWeiboPostElement(post));
    });
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderFollowingWeiboFeed å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å¾®åšã€‘æ¸²æŸ“â€œå…³æ³¨çš„äººâ€çš„å¾®åšFeed (å·²ä¿®å¤å¡é¡¿é—®é¢˜)
 */
async function renderFollowingWeiboFeed() {
    const feedEl = document.getElementById('weibo-following-feed-list');
    
    // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘æˆ‘ä»¬ä¸å†ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰å¸–å­ï¼Œè€Œæ˜¯ç›´æ¥è®©æ•°æ®åº“å¸®æˆ‘ä»¬ç­›é€‰å’Œæ’åºï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤šï¼
    const posts = await db.weiboPosts
        .where('authorId').notEqual('user') // 1. ç›´æ¥åœ¨æ•°æ®åº“å±‚é¢ï¼Œæ‰¾å‡ºä½œè€…ä¸æ˜¯'user'çš„å¸–å­
        .reverse()                          // 2. è®©ç»“æœæŒ‰å€’åºæ’åˆ—
        .sortBy('timestamp');               // 3. æ ¹æ®æ—¶é—´æˆ³æ’åº

    // åç»­çš„æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
    feedEl.innerHTML = '';
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ä½ å…³æ³¨çš„äººè¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•åŠ¨æ€å“¦ã€‚</p>';
        return;
    }
    posts.forEach(post => {
        feedEl.appendChild(createWeiboPostElement(post));
    });
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ createWeiboPostElement å‡½æ•° â–¼â–¼â–¼

function createWeiboPostElement(post) {
    const postEl = document.createElement('div');
    postEl.className = 'weibo-post-item'; 

    let contentHtml = '';
    if (post.content) {
        contentHtml += `<div class="weibo-post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
    }
    
    if (post.imageUrl) {
        if (post.postType === 'text_image') {
            contentHtml += `<img src="${post.imageUrl}" class="weibo-post-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent || ''}">`;
        } else {
            contentHtml += `<img src="${post.imageUrl}" class="weibo-post-image">`;
        }
    }

    let commentsHtml = '';
    if (post.comments && Array.isArray(post.comments) && post.comments.length > 0) {
        commentsHtml += '<div class="weibo-comments-container">';
        post.comments.forEach(comment => {
            if (typeof comment !== 'object' || comment === null) return;
            let replyHtml = '';
            
            // â˜… ä¿®æ”¹1ï¼šä¸ºè¢«å›å¤è€…æ·»åŠ ä¸“å±çš„ class å’Œ data å±æ€§ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç²¾ç¡®ç‚¹å‡»
            if (comment.replyToNickname) {
                replyHtml = `<span class="weibo-comment-reply-tag">å›å¤</span><span class="reply-target-name" data-reply-to-name="${comment.replyToNickname}">${comment.replyToNickname}</span>`;
            }

            commentsHtml += `
                <div class="weibo-comment-item" data-comment-id="${comment.commentId}" data-commenter-name="${comment.authorNickname}">
                    <span class="weibo-commenter-name">${comment.authorNickname}</span>
                    ${replyHtml}:
                    <span class="weibo-comment-text">${comment.commentText}</span>
                    <button class="comment-delete-btn" title="åˆ é™¤æ­¤æ¡è¯„è®º">Ã—</button>
                </div>`;
        });
        commentsHtml += '</div>';
    }

    const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';
    const isLiked = post.likes && post.likes.includes(myNickname);
    
    let finalAuthorAvatar, finalAuthorNickname, finalAuthorAvatarFrame;
    if (post.authorId === 'user') {
        finalAuthorAvatar = state.qzoneSettings.weiboAvatar || state.qzoneSettings.avatar || defaultAvatar;
        finalAuthorNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';
        finalAuthorAvatarFrame = state.qzoneSettings.weiboAvatarFrame || '';
    } else if (state.chats[post.authorId]) {
        const authorChat = state.chats[post.authorId];
        finalAuthorNickname = authorChat.settings.weiboNickname || authorChat.name;
        finalAuthorAvatar = authorChat.settings.weiboAvatar || authorChat.settings.aiAvatar || defaultAvatar;
        finalAuthorAvatarFrame = authorChat.settings.weiboAvatarFrame || authorChat.settings.aiAvatarFrame || '';
    } else {
        finalAuthorAvatar = defaultAvatar;
        finalAuthorNickname = post.authorNickname || 'æœªçŸ¥ç”¨æˆ·';
        finalAuthorAvatarFrame = '';
    }

    let avatarHtml = '';
    if (finalAuthorAvatarFrame) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${finalAuthorAvatar}" class="avatar-img weibo-post-avatar">
                <img src="${finalAuthorAvatarFrame}" class="avatar-frame">
            </div>`;
    } else {
        avatarHtml = `<img src="${finalAuthorAvatar}" class="weibo-post-avatar">`;
    }
    
    const clickableAvatarWrapper = `
        <div class="weibo-post-avatar-clickable" data-char-id="${post.authorId}">
            ${avatarHtml}
        </div>
    `;

    postEl.innerHTML = `
        <div class="weibo-post-header">
            ${clickableAvatarWrapper} 
            <div class="weibo-post-info">
                <span class="weibo-post-nickname">${finalAuthorNickname}</span>
                <span class="weibo-post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
            </div>
            <div class="post-actions-btn" data-post-id="${post.id}" data-author-id="${post.authorId}">â€¦</div>
        </div>
        ${contentHtml}
        <div class="weibo-post-footer">
            <div class="weibo-post-actions">
                <span class="weibo-action-btn like-btn ${isLiked ? 'liked' : ''}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    <span>${(post.baseLikesCount || 0) + (post.likes || []).length}</span>
                </span>
                <span class="weibo-action-btn comment-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>           
                    <span>${(post.comments || []).length}</span>
                </span>
                <span class="weibo-action-btn generate-comments-btn" title="AIç”Ÿæˆè¯„è®º">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <span>ç”Ÿæˆè¯„è®º</span>
                </span>
            </div>
            ${commentsHtml}
            <div class="weibo-comment-input-area">
                <input type="text" class="weibo-comment-input" placeholder="ç•™ä¸‹ä½ çš„ç²¾å½©è¯„è®ºå§...">
                <button class="weibo-comment-send-btn">å‘é€</button>
            </div>
        </div>
    `;

    // ç»‘å®šå‘é€è¯„è®ºæŒ‰é’®
    const sendBtn = postEl.querySelector('.weibo-comment-send-btn');
    if (sendBtn) {
        sendBtn.addEventListener('click', () => {
            const input = postEl.querySelector('.weibo-comment-input');
            handleWeiboComment(post.id, input);
        });
    }

    // ç»‘å®šAIç”Ÿæˆè¯„è®ºæŒ‰é’®
    const generateBtn = postEl.querySelector('.generate-comments-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', () => generateWeiboComments(post.id));
    }
    
    // ç»‘å®šç‚¹èµæŒ‰é’®
    const likeBtn = postEl.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', () => handleWeiboLike(post.id));
    }

    // â˜… ä¿®æ”¹2ï¼šä¸ºè¯„è®ºåŒºç»‘å®šä¸€ä¸ªå…¨æ–°çš„ã€åŠŸèƒ½æ›´å¼ºå¤§çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    const commentSection = postEl.querySelector('.weibo-comments-container');
    if (commentSection) {
        commentSection.addEventListener('click', (e) => {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œè¿™æ˜¯è§£å†³ç‚¹å‡»æ— æ•ˆçš„æ ¸å¿ƒï¼
            e.stopPropagation();

            const target = e.target;
            const commentItem = target.closest('.weibo-comment-item');
            if (!commentItem) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¯„è®ºåŒºï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš
            
            const input = postEl.querySelector('.weibo-comment-input');

            // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
            if (target.closest('.comment-delete-btn')) {
                deleteWeiboComment(post.id, commentItem.dataset.commentId);
                return; // åˆ é™¤åç»“æŸ
            }
            
            let replyToName = '';
            const replyToId = commentItem.dataset.commentId;

            // â˜… ä¿®æ”¹3ï¼šæ–°å¢é€»è¾‘ï¼Œåˆ¤æ–­ä½ ç‚¹å‡»çš„æ˜¯è°
            if (target.classList.contains('reply-target-name')) {
                // å¦‚æœç‚¹å‡»äº†â€œè¢«å›å¤è€…â€çš„åå­—
                replyToName = target.dataset.replyToName;
            } else {
                // å¦åˆ™ï¼Œé»˜è®¤å›å¤è¿™æ¡è¯„è®ºçš„ä½œè€…
                replyToName = commentItem.dataset.commenterName;
            }

            // â˜… ä¿®æ”¹4ï¼šä¼˜åŒ–å›å¤é€»è¾‘
            // å¦‚æœæ­£åœ¨å›å¤åŒä¸€ä¸ªäººï¼Œåˆ™å–æ¶ˆå›å¤
            if (input.dataset.replyToId === replyToId && input.placeholder.includes(`@${replyToName}`)) {
                input.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è¯„è®ºå§...';
                delete input.dataset.replyToId;
                delete input.dataset.replyToNickname;
            } else {
                // å¦åˆ™ï¼Œè®¾ç½®ä¸ºæ–°çš„å›å¤ç›®æ ‡
                input.placeholder = `å›å¤ @${replyToName}:`;
                input.dataset.replyToId = replyToId;
                input.dataset.replyToNickname = replyToName;
                input.focus();
            }
        });
    }

    return postEl;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²





/**
 * ã€å¾®åšã€‘æ‰“å¼€å¾®åšå‘å¸ƒ/ç¼–è¾‘æ¨¡æ€æ¡†
 */
async function openWeiboPublisher() {
    const modal = document.getElementById('create-post-modal');
    
    modal.dataset.mode = 'weibo'; // å…³é”®ï¼æ ‡è®°ä¸ºå¾®åšæ¨¡å¼
    
    document.getElementById('create-post-modal-title').textContent = 'å‘å¾®åš';
    document.getElementById('post-public-text').placeholder = 'æœ‰ä»€ä¹ˆæ–°é²œäº‹æƒ³åˆ†äº«ç»™å¤§å®¶ï¼Ÿ';
    
    // éšè—åŠ¨æ€ä¸“å±çš„æ§ä»¶
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-comments-toggle-group').style.display = 'none';
    
    document.getElementById('post-mode-switcher').style.display = 'flex'; // å¾®åšä¹Ÿéœ€è¦æ¨¡å¼åˆ‡æ¢
    
    resetCreatePostModal();
    modal.classList.add('visible');
}
/**
 * ã€å…¨æ–°ã€‘æ™ºèƒ½è§£æå¸¦â€œä¸‡â€æˆ–â€œäº¿â€çš„æ•°å­—å­—ç¬¦ä¸²
 * @param {string} str - åŒ…å«æ•°å­—çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "30000", "3ä¸‡", "1.5ä¸‡"
 * @returns {number} - è§£æåçš„çº¯æ•°å­—
 */
function parseChineseNumber(str) {
    if (!str) return 0; // å®‰å…¨æ£€æŸ¥

    str = String(str).trim().toLowerCase(); // è½¬æ¢ä¸ºå°å†™å­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼

    let num = parseFloat(str); // å…ˆå°è¯•ç›´æ¥è§£ææ•°å­—éƒ¨åˆ†

    if (str.includes('ä¸‡') || str.includes('w')) {
        // å¦‚æœåŒ…å«â€œä¸‡â€æˆ–â€œwâ€ï¼Œåˆ™å°†æ•°å­—éƒ¨åˆ†ä¹˜ä»¥10000
        num = parseFloat(str) * 10000;
    } else if (str.includes('äº¿')) {
        // å¦‚æœåŒ…å«â€œäº¿â€ï¼Œåˆ™ä¹˜ä»¥100000000
        num = parseFloat(str) * 100000000;
    }

    // å¦‚æœè§£æå¤±è´¥ (æ¯”å¦‚è¾“å…¥äº†çº¯æ–‡å­—)ï¼Œè¿”å›0
    return isNaN(num) ? 0 : Math.floor(num); // è¿”å›æ•´æ•°ï¼Œç¡®ä¿ç»“æœå¹²å‡€
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ handlePublishWeibo å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å¾®åš V3 - ç²‰ä¸æ•°è®¡ç®—ç‰ˆã€‘å¤„ç†å‘å¸ƒå¾®åšçš„æ ¸å¿ƒå‡½æ•°
 */
async function handlePublishWeibo() {
    const modal = document.getElementById('create-post-modal');
    
// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œæ˜¯ä½ è¦ç²˜è´´çš„æ–°ä»£ç  â–¼â–¼â–¼
const mainContent = document.getElementById('post-public-text').value.trim();
let imageUrl = '', hiddenContent = '', postType = 'text_only', imageDescription = '';

const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

if (isImageModeActive) {
    // ã€æ ¸å¿ƒä¿®å¤ã€‘æˆ‘ä»¬ç°åœ¨é€šè¿‡æ£€æŸ¥é¢„è§ˆå®¹å™¨æ˜¯å¦å¯è§ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦çœŸçš„ä¸Šä¼ äº†å›¾ç‰‡
    const hasImage = document.getElementById('post-image-preview-container').classList.contains('visible');
    
    if (hasImage) {
        imageUrl = document.getElementById('post-image-preview').src;
        postType = 'image';
        imageDescription = document.getElementById('post-image-description').value.trim();
        // å›¾ç‰‡æè¿°çš„æ£€æŸ¥é€»è¾‘ä¿æŒä¸å˜
        if (!imageDescription) {
            alert("ä¸ºäº†è®©AIèƒ½çœ‹æ‡‚å›¾ç‰‡ï¼Œè¯·åŠ¡å¿…å¡«å†™å›¾ç‰‡æè¿°å“¦ï¼");
            return;
        }
    }
    // å¦‚æœ hasImage æ˜¯ false (å³ç”¨æˆ·åªæƒ³å‘çº¯æ–‡å­—)ï¼Œè¿™æ®µä»£ç å°±ä¼šè¢«è·³è¿‡ï¼ŒimageUrl ä¿æŒä¸ºç©ºï¼ŒpostType ä¿æŒä¸º text_only
    
} else { // æ–‡å­—å›¾æ¨¡å¼çš„é€»è¾‘ä¿æŒä¸å˜
    hiddenContent = document.getElementById('post-hidden-text').value.trim();
    if (hiddenContent) {
        imageUrl = 'https://i.postimg.cc/KYr2qRCK/1.jpg'; 
        postType = 'text_image';
    }
}
// â–²â–²â–² åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæ˜¯ä½ è¦ç²˜è´´çš„æ–°ä»£ç  â–²â–²â–²

    if (!mainContent && !imageUrl) {
        alert('å¾®åšå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
        return;
    }

    const fansCount = parseChineseNumber(state.qzoneSettings.weiboFansCount) || 0;
    const baseLikes = Math.floor(fansCount * (Math.random() * 0.1 + 0.1));
    const baseComments = Math.floor(baseLikes * (Math.random() * 0.1 + 0.05));

    const newPost = {
        authorId: 'user',
        authorType: 'user',
        authorNickname: state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘',
        authorAvatar: state.qzoneSettings.weiboAvatar || state.qzoneSettings.avatar || defaultAvatar,
        content: mainContent,
        imageUrl: imageUrl,
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
        authorAvatarFrame: state.qzoneSettings.weiboAvatarFrame || '',
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼
        imageDescription: imageDescription, // 3. æŠŠè·å–åˆ°çš„æè¿°ä¿å­˜åˆ°æ–°å­—æ®µé‡Œï¼
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

        hiddenContent: hiddenContent,
        postType: postType,
        timestamp: Date.now(),
        likes: [],
        comments: [],
        baseLikesCount: baseLikes,
        baseCommentsCount: baseComments
    };

    await db.weiboPosts.add(newPost);
    await renderMyWeiboFeed(); 
    await renderWeiboProfile();
    
    modal.classList.remove('visible');
    alert('å¾®åšå‘å¸ƒæˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å¾®åšã€‘å¤„ç†ç‚¹èµ/å–æ¶ˆç‚¹èµ
 * @param {number} postId - å¸–å­ID
 */
async function handleWeiboLike(postId) {
    const post = await db.weiboPosts.get(postId);
    if (!post) return;

    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    if (!post.likes) post.likes = [];
    
    const likeIndex = post.likes.indexOf(myNickname);
    if (likeIndex > -1) {
        post.likes.splice(likeIndex, 1); // å–æ¶ˆç‚¹èµ
    } else {
        post.likes.push(myNickname); // ç‚¹èµ
    }

    await db.weiboPosts.put(post);
    // é‡æ–°æ¸²æŸ“ä¸¤ä¸ªFeedï¼Œç¡®ä¿æ•°æ®åŒæ­¥
    await renderMyWeiboFeed();
    await renderFollowingWeiboFeed();
}

/**
 * ã€å¾®åšã€‘å¤„ç†å‘å¸ƒè¯„è®ºæˆ–å›å¤
 * @param {number} postId - å¸–å­ID
 * @param {HTMLInputElement} inputElement - è¯„è®ºè¾“å…¥æ¡†å…ƒç´ 
 */
async function handleWeiboComment(postId, inputElement) {
    const commentText = inputElement.value.trim();
    if (!commentText) {
        alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    const post = await db.weiboPosts.get(postId);
    if (!post) return;

    if (!post.comments) post.comments = [];

    const newComment = {
        commentId: 'comment_' + Date.now(),
        authorId: 'user',
        authorNickname: state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘',
        commentText: commentText,
        timestamp: Date.now()
    };
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å›å¤
    if (inputElement.dataset.replyToId) {
        newComment.replyToId = inputElement.dataset.replyToId;
        newComment.replyToNickname = inputElement.dataset.replyToNickname;
    }

    post.comments.push(newComment);
    await db.weiboPosts.put(post);
    
    // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®çŠ¶æ€
    inputElement.value = '';
    inputElement.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è¯„è®ºå§...';
    delete inputElement.dataset.replyToId;
    delete inputElement.dataset.replyToNickname;
    
    // é‡æ–°æ¸²æŸ“ä¸¤ä¸ªFeed
    await renderMyWeiboFeed();
    await renderFollowingWeiboFeed();
}


// â–²â–²â–² å…¨æ–°çš„å¾®åšåŠŸèƒ½ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„ API ç«™ç‚¹é»‘åå• â–¼â–¼â–¼
const BLOCKED_API_SITES = [
    'api.pisces.ink',
    'aiapi.qzz.io'
];
// â–²â–²â–² é»‘åå•å®šä¹‰ç»“æŸ â–²â–²â–²
        // --- å·²ä¿®æ­£ ---

        // --- ä¿®æ­£ç»“æŸ ---
    let isUserStickerSelectionMode = false;
    let activeStickerCategoryId = 'uncategorized'; 
let userStickerCategories = [];      // ç”¨äºç¼“å­˜ç”¨æˆ·çš„æ‰€æœ‰åˆ†ç±»
    // â–¼â–¼â–¼ åœ¨ isUserStickerSelectionMode å˜é‡åæ·»åŠ  â–¼â–¼â–¼
let isCharStickerSelectionMode = false;
let selectedCharStickers = new Set();
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
let selectedUserStickers = new Set();
let currentViewingDmsFor = null; // ç”¨äºè¿½è¸ªæ­£åœ¨æŸ¥çœ‹å“ªä¸ªè§’è‰²çš„ç§ä¿¡
let currentUserDmFanIndex = null; // ç”¨äºè¿½è¸ªæ­£åœ¨æŸ¥çœ‹å“ªä¸ªç²‰ä¸çš„ç§ä¿¡
        let isLocked = false; // <-- åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œæ–°ä»£ç 
        let newLockscreenWallpaperBase64 = null; // <-- åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œæ–°ä»£ç 
let newGlobalBgBase64 = null; // ç”¨äºæš‚å­˜æ–°çš„å…¨å±€èŠå¤©èƒŒæ™¯
let newAppWallpaperBase64 = null;
let musicState = { 
    isActive: false, 
    activeChatId: null, 
    isPlaying: false, 
    playlist: [], 
    currentIndex: -1, 
    playMode: 'order', 
    totalElapsedTime: 0, 
    timerId: null,
    // ã€æ–°å¢ã€‘æ­Œè¯ç›¸å…³çŠ¶æ€
    parsedLyrics: [],      // å½“å‰æ­Œæ›²è§£æåçš„æ­Œè¯æ•°ç»„
    currentLyricIndex: -1  // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œç´¢å¼•
};
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æƒ…ä¾£ç©ºé—´ä¸“å±éŸ³ä¹æ’­æ”¾å™¨çš„çŠ¶æ€ç®¡ç†å™¨ â–¼â–¼â–¼
let lsMusicState = {
    playlist: [],      // æ’­æ”¾åˆ—è¡¨
    currentIndex: -1,  // å½“å‰æ’­æ”¾æ­Œæ›²çš„ç´¢å¼•
    isPlaying: false   // æ˜¯å¦æ­£åœ¨æ’­æ”¾
};
// â–²â–²â–² æ–°å¢çŠ¶æ€ç®¡ç†å™¨ç»“æŸ â–²â–²â–²
let lyricsBarSettings = {
    fontSize: 14,
    bgOpacity: 0,
    fontColor: '#FFFFFF',
    showOnClose: true // ã€é—®é¢˜4éœ€è¦ã€‘é»˜è®¤å¼€å¯
};

        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let isInnerVoiceHistoryOpen = false; // ç”¨äºè·Ÿè¸ªå†å²é¢æ¿æ˜¯å¦æ‰“å¼€
        let pomodoroState = {
    isActive: false,            // ä¸“æ³¨æ˜¯å¦æ­£åœ¨è¿›è¡Œ
    timerId: null,              // å€’è®¡æ—¶è®¡æ—¶å™¨
    periodicTalkTimerId: null,  // è§’è‰²å®šæ—¶è¯´è¯çš„è®¡æ—¶å™¨
    currentSession: null        // å½“å‰ä¸“æ³¨ä¼šè¯çš„æ•°æ®
};
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
let activeCharPhonePresetId = null; // ç”¨äºè¿½è¸ªè§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾çš„é€‰æ‹©
let activeCharacterPhoneId = null;
let activeLoversSpaceCharId = null; // ç”¨äºè¿½è¸ªå½“å‰æƒ…ä¾£ç©ºé—´çš„è§’è‰²ID
let waimaiTimers = {}; // ç”¨äºå­˜å‚¨å¤–å–å€’è®¡æ—¶
let editingSpriteGroupId = null;
let activeMessageTimestamp = null;





let currentReplyContext = null; // <--- æ–°å¢è¿™è¡Œï¼Œç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯ä¿¡æ¯
let currentSearchKeyword = ''; // ç”¨äºåœ¨æœç´¢ç»“æœä¸­é«˜äº®å…³é”®è¯
let activePostId = null; // <-- æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGM æœç´¢åŠŸèƒ½æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

// ä¸€ä¸ªç®€å•çš„ç½‘ç»œè¯·æ±‚å‡½æ•°
if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
        return new Promise((resolve) => {
            fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
        });
    }
}
async function Http_Get(url) { return await Http_Get_External(url); }

// æ£€æŸ¥éŸ³é¢‘é“¾æ¥æ˜¯å¦çœŸçš„å¯ä»¥æ’­æ”¾
function checkAudioAvailability(url) {
    return new Promise(resolve => {
        const tester = new Audio();
        tester.addEventListener('loadedmetadata', () => resolve(true), { once: true });
        tester.addEventListener('error', () => resolve(false), { once: true });
        tester.src = url;
    });
}

// â–¼â–¼â–¼ ã€V9.0 | ç»ˆæçº¯å‡€ç‰ˆ - ç§»é™¤ä»£ç†ã€‘è¯·ç”¨è¿™å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ searchNeteaseMusic å‡½æ•° â–¼â–¼â–¼
/**
 * ç§»é™¤æ‰€æœ‰ä»£ç†ï¼Œç›´æ¥è¯·æ±‚ä½ æ‰¾åˆ°çš„ vkeys.cn API
 */
async function searchNeteaseMusic(name, singer) {
    try {
        let searchTerm = name.replace(/\s/g, "");
        if (singer) { searchTerm += ` ${singer.replace(/\s/g, "")}`; }

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†éœ€è¦ä»»ä½•ä»£ç†ï¼Œç›´æ¥æŠŠç›®æ ‡APIä½œä¸ºæœ€ç»ˆè¯·æ±‚åœ°å€ï¼
        const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
        
        console.log("æ­£åœ¨å°è¯•ç›´æ¥è¯·æ±‚:", apiUrl); // æ·»åŠ ä¸€æ¡æ—¥å¿—ï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•
        
        const response = await fetch(apiUrl);

        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();

        if (result.code !== 200 || !result.data || result.data.length === 0) {
            console.log("vkeys APIè¿”å›æ— ç»“æœ:", result);
            return [];
        }
        
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzP-album-cover-placeholder.png',
            source: 'netease'
        })).slice(0, 15);

    } catch (e) {
        // å¦‚æœè¿™æ¬¡è¿˜å¤±è´¥ï¼Œè¯·æŠŠæµè§ˆå™¨F12æ§åˆ¶å°é‡Œçš„çº¢è‰²é”™è¯¯ä¿¡æ¯å®Œæ•´åœ°æˆªå›¾ç»™æˆ‘
        console.error("ã€vkeys API ç›´è¿ã€‘æœç´¢å¤±è´¥:", e);
        await showCustomAlert("ç½‘æ˜“äº‘æ¥å£ç›´è¿å¤±è´¥", `å¦‚æœæµè§ˆå™¨æ§åˆ¶å°(F12)æç¤ºCORSé”™è¯¯ï¼Œè¯´æ˜æ­¤APIç¦æ­¢ç›´æ¥è®¿é—®ã€‚é”™è¯¯: ${e.message}`);
        return [];
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ä»QQéŸ³ä¹æœç´¢æ­Œæ›²åˆ—è¡¨
 */
async function searchTencentMusic(name) {
    try {
        name = name.replace(/\s/g, "");
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
        if (!result?.data?.length) return [];
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
            source: 'tencent' // æ ‡è®°æ¥æº
        })).slice(0, 5); // åªå–å‰5æ¡ç»“æœ
    } catch (e) {
        console.error("QQéŸ³ä¹æœç´¢APIå¤±è´¥:", e);
        return [];
    }
}
// â–¼â–¼â–¼ ã€V2.0 | æ”¯æŒæºé€‰æ‹©ã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addSongFromSearch â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ V2.0ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œæœç´¢â€æŒ‰é’®æ—¶è§¦å‘
 */
async function addSongFromSearch() {
    // æ­¥éª¤ 1: é¦–å…ˆå¼¹å‡ºé€‰æ‹©æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©æœç´¢æº
    const source = await showSearchSourceSelector();
    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œsourceä¼šæ˜¯nullï¼Œæˆ‘ä»¬ç›´æ¥é€€å‡ºå‡½æ•°
    if (!source) return;

    // æ­¥éª¤ 2: å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥å…³é”®è¯ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    const searchTerm = await showCustomPrompt("æœç´¢æ­Œæ›²", "è¯·è¾“å…¥ æ­Œå æˆ– æ­Œå-æ­Œæ‰‹");
    if (!searchTerm || !searchTerm.trim()) return;

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æœç´¢æ­Œæ›²èµ„æº...");

    let musicName = searchTerm.trim();
    let singerName = "";
    if (searchTerm.includes('-') || searchTerm.includes('â€“')) {
        const parts = searchTerm.split(/[-â€“]/);
        musicName = parts[0].trim();
        singerName = parts.slice(1).join(' ').trim();
    }

    // æ­¥éª¤ 3: ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œä¸åŒçš„æœç´¢
    let combinedResults = [];

    if (source === 'all') {
        // å¦‚æœé€‰æ‹©â€œå…¨éƒ¨â€ï¼Œåˆ™å¹¶è¡Œæœç´¢ä¸¤ä¸ªå¹³å°
        const [neteaseResults, tencentResults] = await Promise.all([
            searchNeteaseMusic(musicName, singerName),
            searchTencentMusic(musicName)
        ]);
        combinedResults = [...neteaseResults, ...tencentResults];
    } else if (source === 'netease') {
        // å¦‚æœåªé€‰â€œç½‘æ˜“äº‘â€ï¼Œå°±åªè°ƒç”¨ç½‘æ˜“äº‘çš„æœç´¢
        combinedResults = await searchNeteaseMusic(musicName, singerName);
    } else if (source === 'tencent') {
        // å¦‚æœåªé€‰â€œQQéŸ³ä¹â€ï¼Œå°±åªè°ƒç”¨QQéŸ³ä¹çš„æœç´¢
        combinedResults = await searchTencentMusic(musicName);
    }

    // æ­¥éª¤ 4: åç»­çš„æ˜¾ç¤ºé€»è¾‘ä¿æŒä¸å˜
    if (combinedResults.length === 0) {
        await showCustomAlert("æ— ç»“æœ", "æŠ±æ­‰ï¼Œåœ¨æ‰€é€‰æ¥æºä¸­æœªèƒ½æ‰¾åˆ°ç›¸å…³æ­Œæ›²ã€‚");
        return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';

    combinedResults.forEach(song => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        item.innerHTML = `
            <div class="title">${song.name}</div>
            <div class="artist">${song.artist} <span class="source">${song.source === 'netease' ? 'ç½‘æ˜“äº‘' : 'QQéŸ³ä¹'}</span></div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒå‡çº§ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»æœç´¢ç»“æœï¼Œå¢åŠ å¤‡ç”¨éŸ³æºæŸ¥æ‰¾å’Œæ˜¯å¦æ°¸ä¹…ä¿å­˜çš„é€»è¾‘
 */
async function handleSearchResultClick(songData) {
    const modal = document.getElementById('music-search-results-modal');
    modal.classList.remove('visible');

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è·å–ã€Š${songData.name}ã€‹çš„æ’­æ”¾é“¾æ¥...`);

    let playableResult = null;
    let finalSource = songData.source;

    // 1. å°è¯•ä¸»éŸ³æº
    const primaryApiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    let primaryResult = await Http_Get(primaryApiUrl);
    if (primaryResult?.data?.url && await checkAudioAvailability(primaryResult.data.url)) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
    }

    // 2. å¦‚æœä¸»éŸ³æºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨éŸ³æº
    if (!playableResult) {
        await showCustomAlert("è¯·ç¨å€™...", "ä¸»éŸ³æºè·å–å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨éŸ³æº...");
        const fallbackSource = songData.source === 'netease' ? 'tencent' : 'netease';
        const fallbackResults = fallbackSource === 'tencent' 
            ? await searchTencentMusic(songData.name)
            : await searchNeteaseMusic(songData.name, songData.artist);

        if (fallbackResults.length > 0) {
            const fallbackApiUrl = fallbackSource === 'netease'
                ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
            const fallbackResult = await Http_Get(fallbackApiUrl);
            if (fallbackResult?.data?.url && await checkAudioAvailability(fallbackResult.data.url)) {
                playableResult = { url: fallbackResult.data.url, id: fallbackResults[0].id, source: fallbackSource };
                finalSource = fallbackSource;
            }
        }
    }

    if (!playableResult) {
        await showCustomAlert("è·å–å¤±è´¥", "æ— æ³•è·å–è¯¥æ­Œæ›²çš„æœ‰æ•ˆæ’­æ”¾é“¾æ¥ï¼Œä¸»éŸ³æºå’Œå¤‡ç”¨éŸ³æºå‡å·²å°è¯•ã€‚");
        return;
    }
    
// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
const confirmed = await showCustomConfirm(
    'æ¸©é¦¨æç¤º', // è¿™æ˜¯å¼¹çª—çš„æ ‡é¢˜
    'æœç´¢çš„æ­Œæ›²24håä¼šè¿‡æœŸï¼Œé‡è¦çš„æ­Œæ›²è®°å¾—ç”¨urlæˆ–è€…æœ¬åœ°ä¸Šä¼ å“¦ğŸ‡', // è¿™æ˜¯ä½ æŒ‡å®šçš„æç¤ºå†…å®¹
    { confirmText: 'ç¡®å®š' } // æŒ‰é’®ä¼šæ˜¾ç¤ºâ€œç¡®å®šâ€å’Œâ€œå–æ¶ˆâ€ï¼Œè¿™é‡Œçš„â€œå–æ¶ˆâ€å°±ç­‰åŒäºâ€œè¿”å›â€
);

// å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€ï¼ˆè¿”å›ï¼‰ï¼Œå°±ç›´æ¥ç»“æŸï¼Œä¸æ·»åŠ æ­Œæ›²
if (!confirmed) {
    return;
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²   
    // è·å–æ­Œè¯
    const lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼
const newSong = {
    name: songData.name,
    artist: songData.artist,
    src: playableResult.url,
    cover: songData.cover,
    isLocal: false,
    lrcContent: lrcContent,
    isTemporary: true,
    // æ ¸å¿ƒæ–°å¢ï¼šè®°å½•è¿™é¦–æ­Œè¢«æ·»åŠ çš„ç²¾ç¡®æ—¶é—´
    addedTimestamp: Date.now() 
};
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



musicState.playlist.push(newSong);

// æ³¨æ„ï¼šæˆ‘ä»¬å·²ç»åˆ é™¤äº† saveGlobalPlaylist() çš„è°ƒç”¨ï¼Œå› ä¸ºä¸´æ—¶æ­Œæ›²ä¸éœ€è¦è¢«æ°¸ä¹…ä¿å­˜
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    
    updatePlaylistUI();

    if (musicState.currentIndex === -1) {
        musicState.currentIndex = musicState.playlist.length - 1;
        updatePlayerUI();
    }

    await showCustomAlert("æ·»åŠ æˆåŠŸ", `ã€Š${songData.name}ã€‹å·²æˆåŠŸæ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ï¼`);
    // â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼
try {
    // 1. æ£€æŸ¥ä¸€ä¸‹å½“å‰æ˜¯ä¸æ˜¯æ­£åœ¨å’Œåˆ«äººèŠå¤©
    if (state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        if (chat) {
            // 2. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ï¼Œä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
            const hiddenMessage = {
                role: 'system', // å‘Šè¯‰AIè¿™æ˜¯ç³»ç»Ÿä¿¡æ¯
                content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšé€šè¿‡æœç´¢ï¼Œå°†æ­Œæ›²ã€Š${songData.name}ã€‹ - ${songData.artist} æ·»åŠ åˆ°äº†â€œä¸€èµ·å¬â€çš„æ’­æ”¾åˆ—è¡¨ä¸­ã€‚ä½ å¯ä»¥æ ¹æ®è¿™ä¸ªæƒ…æ™¯ï¼Œè‡ªç„¶åœ°å¼€å¯å…³äºè¿™é¦–æ­Œçš„è¯é¢˜ã€‚]`,
                timestamp: Date.now(),
                isHidden: true // è¿™ä¸ªæ˜¯å…³é”®ï¼è®©è¿™æ¡æ¶ˆæ¯åœ¨èŠå¤©ç•Œé¢ä¸Šâ€œéšå½¢â€
            };
            
            // 3. æŠŠè¿™æ¡â€œéšå½¢â€æ¶ˆæ¯åŠ åˆ°èŠå¤©è®°å½•çš„æœ«å°¾
            chat.history.push(hiddenMessage);
            
            // 4. ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•åˆ°æ•°æ®åº“
            await db.chats.put(chat);

            console.log(`å·²ä¸ºæ­Œæ›²ã€Š${songData.name}ã€‹æˆåŠŸæ³¨å…¥AIä¸Šä¸‹æ–‡æç¤ºã€‚`);
        }
    }
} catch (error) {
    console.error("æ³¨å…¥æ­Œæ›²ä¸Šä¸‹æ–‡æ—¶å‡ºé”™:", error);
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
}

/**
 * ã€è¾…åŠ©ã€‘è·å–ç½‘ç»œæ­Œæ›²çš„æ­Œè¯
 */
async function getLyricsForSong(songId, source) {
    const url = source === 'netease'
        ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
        : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
    
    const response = await Http_Get(url);
    if (response?.data) {
        const lrc = response.data.lrc || response.data.lyric || "";
        const tlyric = response.data.trans || response.data.tlyric || "";
        return lrc + "\\n" + tlyric;
    }
    return "";
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸ªå‡½æ•°ç”¨æ¥æ˜¾ç¤ºâ€œé€‰æ‹©æœç´¢æºâ€çš„å¼¹çª— â–¼â–¼â–¼
/**
 * æ˜¾ç¤ºæœç´¢æºé€‰æ‹©å¼¹çª—ï¼Œå¹¶è¿”å›ç”¨æˆ·çš„é€‰æ‹©
 * @returns {Promise<string|null>} è¿”å› 'all', 'netease', 'tencent', æˆ– null
 */
function showSearchSourceSelector() {
    return new Promise(resolve => {
        const modal = document.getElementById('music-source-selector-modal');
        const confirmBtn = document.getElementById('confirm-source-select-btn');
        const cancelBtn = document.getElementById('cancel-source-select-btn');

        // æ˜¾ç¤ºå¼¹çª—
        modal.classList.add('visible');

        // å®šä¹‰ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        const onConfirm = () => {
            const selectedSource = document.querySelector('input[name="search-source"]:checked').value;
            cleanup();
            resolve(selectedSource); // è¿”å›ç”¨æˆ·çš„é€‰æ‹©
        };

        // å®šä¹‰å–æ¶ˆæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        const onCancel = () => {
            cleanup();
            resolve(null); // ç”¨æˆ·å–æ¶ˆï¼Œè¿”å› null
        };

        // æ¸…ç†å‡½æ•°ï¼Œç”¨äºç§»é™¤äº‹ä»¶ç›‘å¬å¹¶éšè—å¼¹çª—
        const cleanup = () => {
            modal.classList.remove('visible');
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
        };

        // ç»‘å®šäº‹ä»¶
        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
    });
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° getLyricsForSong å‡½æ•°çš„åé¢ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®æ­Œåå’Œæ­Œæ‰‹è‡ªåŠ¨æœç´¢å¹¶æ’­æ”¾æ­Œæ›²
 * @param {string} name - æ­Œæ›²å
 * @param {string} artist - æ­Œæ‰‹å
 */
async function searchAndPlaySong(name, artist) {
    // å¼¹å‡ºæç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·æˆ‘ä»¬æ­£åœ¨åšä»€ä¹ˆ
    await showCustomAlert("è¯·ç¨å€™...", `AIä¸ºä½ åˆ†äº«äº†ã€Š${name}ã€‹ï¼Œæ­£åœ¨åŠªåŠ›å¯»æ‰¾æ’­æ”¾èµ„æº...`);

    let songData = null;

    // ç­–ç•¥1ï¼šä¼˜å…ˆç”¨ç½‘æ˜“äº‘æœç´¢ (é€šå¸¸ç»“æœæ›´å‡†)
    const neteaseResults = await searchNeteaseMusic(name, artist);
    if (neteaseResults.length > 0) {
        songData = neteaseResults[0]; // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç”¨ç¬¬ä¸€ä¸ªç»“æœ
    } 
    // ç­–ç•¥2ï¼šå¦‚æœç½‘æ˜“äº‘æ‰¾ä¸åˆ°ï¼Œå†ç”¨QQéŸ³ä¹æœä¸€æ¬¡
    else {
        const tencentResults = await searchTencentMusic(name);
        if (tencentResults.length > 0) {
            songData = tencentResults[0]; // ç”¨QQéŸ³ä¹çš„ç¬¬ä¸€ä¸ªç»“æœ
        }
    }

    // å¦‚æœä¸¤ä¸ªå¹³å°éƒ½æ²¡æ‰¾åˆ°ï¼Œå°±å‘Šè¯‰ç”¨æˆ·å¹¶é€€å‡º
    if (!songData) {
        await showCustomAlert("æ‰¾ä¸åˆ°æ­Œæ›²", `æŠ±æ­‰ï¼Œåœ¨ç½‘æ˜“äº‘å’ŒQQéŸ³ä¹éƒ½æ²¡èƒ½æ‰¾åˆ°ã€Š${name}ã€‹çš„å¯æ’­æ”¾èµ„æºã€‚`);
        return;
    }

    // åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€é¦–æ­Œçš„åŸºæœ¬ä¿¡æ¯ (id, source, name, artist)
    // ä¸‹é¢çš„é€»è¾‘å°±æ˜¯è°ƒç”¨APIè·å–çœŸå®çš„æ’­æ”¾é“¾æ¥
    
    const apiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    const result = await Http_Get(apiUrl);

    // æ£€æŸ¥è·å–åˆ°çš„é“¾æ¥æ˜¯å¦çœŸçš„èƒ½æ’­æ”¾
    if (!result?.data?.url || !(await checkAudioAvailability(result.data.url))) {
        await showCustomAlert("è·å–å¤±è´¥", `æ‰¾åˆ°äº†ã€Š${name}ã€‹ï¼Œä½†æ— æ³•è·å–æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥ã€‚`);
        return;
    }

    // è·å–æ­Œè¯
    const lrcContent = await getLyricsForSong(songData.id, songData.source) || "";

    // å‡†å¤‡æ–°çš„æ­Œæ›²å¯¹è±¡ï¼Œå‡†å¤‡æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
    const newSong = {
        name: songData.name,
        artist: songData.artist,
        src: result.data.url, // ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè·å–åˆ°çš„çœŸå®ã€å¯æ’­æ”¾çš„URLï¼
        cover: songData.cover,
        isLocal: false,
        lrcContent: lrcContent,
        isTemporary: true, // æ ‡è®°ä¸ºä¸´æ—¶æ­Œæ›²ï¼Œ24å°æ—¶åå¯èƒ½ä¼šå¤±æ•ˆ
        addedTimestamp: Date.now()
    };

    // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨é‡Œæ˜¯ä¸æ˜¯å·²ç»æœ‰è¿™é¦–æ­Œäº†
    const existingIndex = musicState.playlist.findIndex(t => t.name === newSong.name && t.artist === newSong.artist);
    if (existingIndex !== -1) {
        // å¦‚æœæœ‰ï¼Œç›´æ¥æ’­æ”¾å®ƒ
        playSong(existingIndex);
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œå°±æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾å†æ’­æ”¾
        musicState.playlist.push(newSong);
        updatePlaylistUI(); // åˆ·æ–°æ’­æ”¾åˆ—è¡¨ç•Œé¢
        playSong(musicState.playlist.length - 1);
    }
    
    // å¦‚æœâ€œä¸€èµ·å¬â€åŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œå°±è‡ªåŠ¨æ‰“å¼€å®ƒ
    if (!musicState.isActive) {
         startListenTogetherSession(state.activeChatId);
    } else {
        // å¦‚æœå·²ç»æ˜¯æ‰“å¼€çš„ï¼Œå°±ç›´æ¥æ˜¾ç¤ºæ’­æ”¾å™¨çª—å£
        document.getElementById('music-player-overlay').classList.add('visible');
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
let activeForumFilters = { 
    global: [], // ç”¨äºä¸»é¡µå°ç»„åˆ—è¡¨çš„ç­›é€‰
    group: {}   // ç”¨äºå­˜å‚¨æ¯ä¸ªå°ç»„å†…éƒ¨å¸–å­çš„ç­›é€‰, e.g., { 1: ['ç§‘å¹»'], 2: ['å‰§æƒ…'] }
};
let currentFilterContext = { type: 'global', id: null }; // è®°å½•å½“å‰æ‰“å¼€ç­›é€‰çš„æ˜¯å“ªä¸ªé¡µé¢

        let photoViewerState = {
            isOpen: false,
            photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
            currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

let currentFrameSelection = { type: null, url: '', target: null }; 

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

const THEME_CSS_TEMPLATE = `
/* 
  EPhone ç¾åŒ–ä»£ç æ¨¡æ¿
  ä½¿ç”¨æ–¹æ³•: 
  1. ä¿®æ”¹ä¸‹é¢çš„é¢œè‰²ä»£ç æˆ–å›¾ç‰‡URLã€‚
  2. ä¸éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å¯ä»¥åˆ é™¤æˆ–ä¿æŒä¸å˜ã€‚
  3. é¢œè‰²ä»£ç æ ¼å¼ä¸º #RRGGBB (ä¾‹å¦‚ #FFFFFF æ˜¯ç™½è‰²)ã€‚
  4. å›¾ç‰‡URLéœ€è¦æ˜¯ç½‘ç»œç›´é“¾ã€‚
*/

/* === 1. æ‰‹æœºå£³ä¸åˆ˜æµ·é¢œè‰² === */
#phone-frame {
  background-color: #f0f0f0; /* æ‰‹æœºå£³é¢œè‰² */
}
.notch {
  background-color: #1a1a1a; /* é¡¶éƒ¨â€œåˆ˜æµ·â€é¢œè‰² */
}
        #clock-container {  color: white;  }


/* === 1.5. å…¨å±€ä¸»é¢˜è‰² (é‡è¦ï¼) === */
/* è¿™ä¸ªé¢œè‰²å†³å®šäº†å¤§éƒ¨åˆ†æŒ‰é’®ã€é“¾æ¥å’Œé«˜äº®æ–‡æœ¬çš„é¢œè‰²ã€‚*/
:root {
  --accent-color: #007bff; /* é»˜è®¤æ˜¯è“è‰² */
}

/* === 2. èŠå¤©ç•Œé¢é¡¶éƒ¨å’Œåº•éƒ¨çš„å›¾ç‰‡æŒ‰é’®æ›¿æ¢ === */
/* â€œä¸€èµ·å¬â€æŒ‰é’® (æ­£å¸¸çŠ¶æ€) */
#listen-together-btn img[src*="8kYShvrJ/90-UI-2.png"] {
  content: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„â€œæ­£å¸¸çŠ¶æ€â€å›¾ç‰‡URL');
}
/* â€œä¸€èµ·å¬â€æŒ‰é’® (æ’­æ”¾ä¸­çŠ¶æ€) */
#listen-together-btn img[src*="D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png"] {
  content: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„â€œæ’­æ”¾ä¸­â€å›¾ç‰‡URL');
}
/* â€œèŠå¤©è®¾ç½®â€æŒ‰é’® */
#chat-settings-btn img {
  content: url('https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png');
}
/* â€œè§¦å‘APIå›å¤â€æŒ‰é’® */
#wait-reply-btn img {
  content: url('https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png');
}
/* â€œå‘é€â€æŒ‰é’® (è®¾ä¸ºå›¾ç‰‡å½¢å¼) */
#send-btn {
  background-image: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„å‘é€æŒ‰é’®å›¾ç‰‡URL');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  width: 50px; /* æ ¹æ®ä½ çš„å›¾ç‰‡è°ƒæ•´å®½åº¦ */
}

/* â€œé‡æ–°ç”Ÿæˆå›å¤â€æŒ‰é’® */
#reroll-btn {
    background-color: rgba(255, 255, 255, 0.6);
    color: var(--text-primary); /* ä½¿ç”¨å…¨å±€ä¸»é¢˜çš„ä¸»æ–‡æœ¬é¢œè‰² */
}

/* === 3. é¡¶éƒ¨æ ä¸åº•éƒ¨æ é¢œè‰² === */
.header, .qzone-header {
  background-color: rgba(240, 240, 240, 0.8); /* é¡¶éƒ¨æ èƒŒæ™¯è‰² (å¸¦ä¸€ç‚¹é€æ˜) */
  color: #333333; /* é¡¶éƒ¨æ æ–‡å­—é¢œè‰² */
}
#chat-list-bottom-nav {
  background-color: rgba(245, 245, 245, 0.85); /* åº•éƒ¨å¯¼èˆªæ èƒŒæ™¯è‰² */
}
.nav-item {
  color: #8a8a8a; /* åº•éƒ¨å¯¼èˆªæ æœªé€‰ä¸­é¡¹çš„é¢œè‰² */
}
.nav-item.active {
  color: #007bff; /* åº•éƒ¨å¯¼èˆªæ é€‰ä¸­é¡¹çš„é¢œè‰² */
}

/* === 4. å„ç•Œé¢èƒŒæ™¯è‰² === */
#chat-list-screen, #qzone-screen .qzone-content, #memories-view {
  background-color: #f0f2f5 !important; /* åˆ—è¡¨é¡µä¸»èƒŒæ™¯è‰² */
}

/* === 5. èŠå¤©è¾“å…¥åŒºåº•éƒ¨åŠŸèƒ½æ SVGå›¾æ ‡æ›¿æ¢ === */
/* æç¤º: ä½ éœ€è¦å°†ä½ çš„SVGä»£ç è½¬æ¢ä¸ºURLç¼–ç æ ¼å¼ã€‚
   å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·æœç´¢ "SVG to Data URI" æ¥å®Œæˆè½¬æ¢ã€‚
   ç„¶åæ›¿æ¢æ‰ä¸‹é¢çš„ url('...') éƒ¨åˆ†ã€‚ */

.chat-action-icon-btn {
  background-color: rgba(255, 255, 255, 0.5); /* å›¾æ ‡æŒ‰é’®çš„èƒŒæ™¯è‰² */
  border: 1px solid rgba(0,0,0,0.05); /* å›¾æ ‡æŒ‰é’®çš„è¾¹æ¡† */
}

/* è¡¨æƒ…é¢æ¿(+)æŒ‰é’® */
#open-sticker-panel-btn svg { display: none; /* éšè—åŸå§‹SVG */ }
#open-sticker-panel-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* å‘é€ç…§ç‰‡(æ—§)æŒ‰é’® */
#send-photo-btn svg { display: none; /* éšè—åŸå§‹SVG */ }
#send-photo-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ä¸Šä¼ å›¾ç‰‡(æ–°)æŒ‰é’® */
#upload-image-btn svg { display: none; }
#upload-image-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: black;"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* è½¬è´¦(ï¿¥)æŒ‰é’® */
#transfer-btn svg { display: none; }
#transfer-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* è¯­éŸ³æŒ‰é’® */
#voice-message-btn svg { display: none; }
#voice-message-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* å¤–å–æŒ‰é’® */
#send-waimai-request-btn svg { display: none; }
#send-waimai-request-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* è§†é¢‘é€šè¯æŒ‰é’® */
#video-call-btn svg { display: none; }
#video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* ç¾¤è§†é¢‘é€šè¯æŒ‰é’® */
#group-video-call-btn svg { display: none; }
#group-video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* æŠ•ç¥¨æŒ‰é’® */
#send-poll-btn svg { display: none; }
#send-poll-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* åˆ†äº«é“¾æ¥æŒ‰é’® */
#share-link-btn svg { display: none; }
#share-link-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* å‘é€å®šä½æŒ‰é’® */
#send-location-btn { display: none; }
#send-location-btn {
  background-image: url('data:image/svg+xml;utf8,    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* === 6. æ›´å¤šç•Œé¢èƒŒæ™¯è‰² === */
/* é€‚ç”¨äºæ‰€æœ‰è®¾ç½®ã€ç¼–è¾‘ã€é€‰æ‹©ç­‰äºŒçº§é¡µé¢ */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#world-book-screen,
#world-book-editor-screen,
#contact-picker-screen,
#member-management-screen,
#album-screen,
#album-photos-screen,
#call-history-screen,
#chat-search-screen,
#browser-screen {
  /* è¿™é‡Œä¸å†è®¾ç½®èƒŒæ™¯è‰²ï¼Œè®©å®ƒè‡ªç„¶ç»§æ‰¿å¤œé—´æ¨¡å¼çš„é¢œè‰² */
}


/* === 7. å›å¿†å¡ç‰‡ç¾åŒ– === */
.memory-card {
  background-color: #fffaf0 !important; /* å¡ç‰‡ä¸»èƒŒæ™¯è‰² */
  border-left-color: #ffb74d !important; /* å·¦ä¾§è£…é¥°æ¡é¢œè‰² */
  box-shadow: 0 2px 6px rgba(0,0,0,0.07) !important;
}
.memory-card .header .author {
  color: #d98100 !important; /* ä½œè€…/æ ‡é¢˜æ–‡å­—é¢œè‰² */
}
.memory-card .header .date {
  color: #a1887f !important; /* æ—¥æœŸæ–‡å­—é¢œè‰² */
}
.memory-card .content {
  color: #5d4037 !important; /* å†…å®¹æ–‡å­—é¢œè‰² */
}
`;

// â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨ï¼Œå˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸ªæ–°å¸¸é‡ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€ä¿®æ”¹åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ DEFAULT_APP_ICONS â–¼â–¼â–¼
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
    'check-phone': 'https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg',
    'weibo': 'https://i.postimg.cc/PqBY5wBq/weibo-icon.png',
    'forum': 'https://i.postimg.cc/pr0T3WfC/douban-icon.png',
    'lovers-space': 'https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png',
    'game-hall': 'https://i.postimg.cc/P5gL5z2g/game-controller-icon.png',
    'x-social': 'https://i.postimg.cc/8P1H0vQ8/x-logo.png',
    'taobao': 'https://i.postimg.cc/k47tXg1j/taologo.png',
    'date-a-live': 'https://i.postimg.cc/Kjdss1j9/1761142686734.png' 
};
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
const DEFAULT_APP_LABELS = {
    'qq': 'QQ',
    'world-book': 'ä¸–ç•Œä¹¦',
    'api-settings': 'APIè®¾ç½®',
    'wallpaper': 'å¤–è§‚è®¾ç½®',
    'font': 'å­—ä½“',
    'check-phone': 'æŸ¥æ‰‹æœº',
    'weibo': 'å¾®åš',
    'forum': 'åœˆå­',
    'lovers-space': 'æƒ…ä¾£ç©ºé—´',
    'game-hall': 'æ¸¸æˆå¤§å…',
    'x-social': 'Xç¤¾äº¤',
    'taobao': 'æ¡ƒå®',
    'date-a-live': 'çº¦ä¼šå¤§ä½œæˆ˜'
};
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
const addProductChoiceModal = document.getElementById('add-product-choice-modal');
const aiGeneratedProductsModal = document.getElementById('ai-generated-products-modal');
const productSearchInput = document.getElementById('product-search-input');
const productSearchBtn = document.getElementById('product-search-btn');
// â–²â–²â–² æ–°å¢å˜é‡ç»“æŸ â–²â–²â–²



        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/i\.ibb\.co\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        window.showCustomConfirm = function(title, message, options = {}) {

            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        window.showCustomAlert = function(title, message) {

            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ° <script> æ ‡ç­¾çš„æœ€å¼€å§‹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€ä¸ªä¸“é—¨æ¸…é™¤HTMLæ ‡ç­¾å’Œä»£ç çš„å‡½æ•°
 * @param {string} text - åŒ…å«HTMLæˆ–ä»£ç çš„åŸå§‹æ–‡æœ¬
 * @returns {string} - æ¸…ç†åçš„çº¯æ–‡æœ¬
 */
function stripHtmlAndCode(text) {
    if (!text || typeof text !== 'string') {
        return ''; // å¦‚æœè¾“å…¥ä¸ºç©ºæˆ–ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    }
    // 1. ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ (ä¾‹å¦‚ <b>, <div>)
    let cleanedText = text.replace(/<\/?[^>]+(>|$)/g, "");
    
    // 2. ç§»é™¤æ‰€æœ‰Markdownä»£ç å— (ä¾‹å¦‚ ```code``` æˆ– `code`)
    cleanedText = cleanedText.replace(/```[\s\S]*?```/g, ''); // ç§»é™¤å¤šè¡Œä»£ç å—
    cleanedText = cleanedText.replace(/`[^`]*`/g, '');     // ç§»é™¤è¡Œå†…ä»£ç 
    
    // 3. å°†HTMLå®ä½“ (ä¾‹å¦‚ &lt; &gt;) è½¬æ¢å›æ­£å¸¸å­—ç¬¦ (< >)
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = cleanedText;
    
    return tempDiv.textContent || tempDiv.innerText || "";
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘æ›¿æ¢æ—§çš„ showCustomPrompt å‡½æ•° â–¼â–¼â–¼
window.showCustomPrompt = function(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {

    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢å¤–çš„HTMLå’Œè¾“å…¥æ¡†ç»„åˆåœ¨ä¸€èµ·
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®ç»‘å®šäº‹ä»¶
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // ä½¿ç”¨ null, 2 å‚æ•°è®©JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œå¸¦ç¼©è¿›ï¼Œæ›´æ˜“è¯»
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘ä»ä¸€ä¸ªæ•°ç»„ä¸­éšæœºè·å–ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - ç›®æ ‡æ•°ç»„
 * @returns {*} - æ•°ç»„ä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´ 
 */
function getRandomItem(arr) {
    // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœæ•°ç»„ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    if (!arr || arr.length === 0) return '';
    // è¿”å›ä¸€ä¸ªéšæœºç´¢å¼•å¯¹åº”çš„å…ƒç´ 
    return arr[Math.floor(Math.random() * arr.length)];
}

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è·å–ä¸€å¼ éšæœºçš„æ·˜å®å®è´é»˜è®¤å›¾ç‰‡
 * @returns {string} - è¿”å›ä¸€å¼ éšæœºå›¾ç‰‡çš„URL
 */
function getRandomDefaultProductImage() {
    const defaultImages = [
        'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg',
        'https://i.postimg.cc/jjRb1jF7/Image-1760206125678.jpg'
    ];
    // ä»æ•°ç»„ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå¹¶è¿”å›
    return defaultImages[Math.floor(Math.random() * defaultImages.length)];
}

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘ä»ä¸€ä¸ªæ•°ç»„ä¸­éšæœºè·å–ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - ç›®æ ‡æ•°ç»„
 * @returns {*} - æ•°ç»„ä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´ 
 */
function getRandomItem(arr) {
    // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœæ•°ç»„ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    if (!arr || arr.length === 0) return '';
    // è¿”å›ä¸€ä¸ªéšæœºç´¢å¼•å¯¹åº”çš„å…ƒç´ 
    return arr[Math.floor(Math.random() * arr.length)];
}

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
        // ===================================================================

// â–¼â–¼â–¼ ä½¿ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ db.version(...).stores(...) â–¼â–¼â–¼
db.version(48).stores({ // ç‰ˆæœ¬å·ä» 47 å‡çº§åˆ° 48
    chats: '&id, isGroup, groupId, ownerId, isPinned, characterPhoneData, latestInnerVoice, innerVoiceHistory, loversSpaceData.emotionDiaries, settings.summary, settings.weiboNickname, settings.innerVoiceHideHeaderBorder, settings.innerVoiceAdopterLabelFormat', 
    apiConfig: '&id',
    globalSettings: '&id, activeThemeId', 
    userStickers: '&id, url, name, categoryId', // â˜…â˜…â˜… åœ¨è¿™é‡Œæ–°å¢äº† categoryId ç´¢å¼• â˜…â˜…â˜…
    userStickerCategories: '++id, &name',     // â˜…â˜…â˜… è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„åˆ†ç±»è¡¨ â˜…â˜…â˜…
    charStickers: '&id, url, name', 
    worldBooks: '&id, name, categoryId', 
    worldBookCategories: '++id, name',
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, authorId, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' ,
    callRecords: '++id, chatId, timestamp, customName',
    customAvatarFrames: '&id, name, url',   
    themes: '++id, name, css',
    apiPresets: '++id, name, proxyUrl',
    bubbleStylePresets: '++id, name, css',
    fontPresets: '&id, name, url',
    homeScreenPresets: '++id, name',
    weiboPosts: '++id, authorId, timestamp',
    forumGroups: '++id, name, worldview, *categories',
    forumPosts: '++id, groupId, timestamp, *categories',
    forumComments: '++id, postId, timestamp',
    forumCategories: '++id, name',
    tarotReadings: '++id, timestamp',
    pomodoroSessions: '++id, chatId, startTime',
    scriptKillScripts: '++id, name, isBuiltIn',
    taobaoProducts: '++id, name, category', 
    taobaoOrders: '++id, productId, timestamp',
    taobaoCart: '++id, productId',
    userWalletTransactions: '++id, timestamp' ,
    charPhonePresets: '++id, name',
    ludoQuestionBanks: '++id, name',
    ludoQuestions: '++id, bankId, text, type',
    datingScenes: '&uid, imageUrl',
    datingPresets: '++id, name, settings.spriteGroupId',
    datingSpriteGroups: '++id, name',
    datingSprites: '++id, groupId, description, url',
    datingHistory: '++id, characterId, timestamp'
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




window.db = db;

// ===================================================================
// 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
// ===================================================================

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ toggleVoiceTranscript å‡½æ•° â–¼â–¼â–¼

/**
 * ã€V2 - ä¿®å¤ç‰ˆã€‘åˆ‡æ¢è¯­éŸ³æ¶ˆæ¯çš„æ–‡å­—æ˜¾ç¤º/éšè—
 * @param {HTMLElement} bubble - è¢«ç‚¹å‡»çš„è¯­éŸ³æ¶ˆæ¯çš„ .message-bubble å…ƒç´ 
 */
function toggleVoiceTranscript(bubble) {
    if (!bubble) return;

    const transcriptEl = bubble.querySelector('.voice-transcript');
    if (!transcriptEl) return;

    // æ ¸å¿ƒé€»è¾‘ï¼šç›´æ¥æ£€æŸ¥æ–‡å­—åŒºåŸŸå½“å‰æ˜¯ä¸æ˜¯æ˜¾ç¤ºçŠ¶æ€
    const isCurrentlyExpanded = transcriptEl.style.display === 'block';

    if (isCurrentlyExpanded) {
        // å¦‚æœæ˜¯å±•å¼€çš„ï¼Œå°±ç›´æ¥æ”¶èµ·æ¥
        transcriptEl.style.display = 'none';
    } else {
        // å¦‚æœæ˜¯æ”¶èµ·çš„ï¼Œå°±æ‰§è¡Œå±•å¼€æµç¨‹
        
        // 1. å…ˆæ˜¾ç¤ºä¸€ä¸ªâ€œæ­£åœ¨è½¬å†™â€çš„æç¤ºï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
        transcriptEl.textContent = 'æ­£åœ¨è½¬æ–‡å­—...';
        transcriptEl.style.display = 'block';

        // 2. æ¨¡æ‹Ÿä¸€ä¸ªçŸ­æš‚çš„â€œè¯†åˆ«â€è¿‡ç¨‹
        setTimeout(() => {
            // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦è¿˜åœ¨é¡µé¢ä¸Šï¼Œé˜²æ­¢ç”¨æˆ·åˆ‡æ¢èŠå¤©å¯¼è‡´é”™è¯¯
            if (document.body.contains(transcriptEl)) {
                // è·å–å¹¶æ˜¾ç¤ºçœŸæ­£çš„è½¬å†™æ–‡å­—
                const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                transcriptEl.textContent = voiceText;
            }
        }, 300); // 300æ¯«ç§’çš„å»¶è¿Ÿï¼Œæ„Ÿè§‰æ›´çµæ•
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšåŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ·äººè®¾ä¸èŒä¸šè®¾ç½®æ ¸å¿ƒåŠŸèƒ½
 */
function openWeiboUserSettingsModal() {
    const modal = document.getElementById('weibo-user-settings-modal');
    const settings = state.qzoneSettings;

    // åŠ è½½å½“å‰æ•°æ®åˆ°è¾“å…¥æ¡†
    document.getElementById('weibo-user-profession-modal-input').value = settings.weiboUserProfession === 'ç‚¹å‡»è®¾ç½®èŒä¸š' ? '' : settings.weiboUserProfession;
    document.getElementById('weibo-user-persona-modal-input').value = settings.weiboUserPersona;
    
    renderWeiboUserPresetSelector(); // æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰æ¡†
    modal.classList.add('visible');
}

async function saveWeiboUserSettings() {
    const profession = document.getElementById('weibo-user-profession-modal-input').value.trim();
    const persona = document.getElementById('weibo-user-persona-modal-input').value.trim();

    state.qzoneSettings.weiboUserProfession = profession || 'ç‚¹å‡»è®¾ç½®èŒä¸š';
    state.qzoneSettings.weiboUserPersona = persona || 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚';

    await saveQzoneSettings(); // ä¿å­˜åˆ°æ•°æ®åº“
    await renderWeiboProfile(); // åˆ·æ–°ä¸»é¡µæ˜¾ç¤º
    document.getElementById('weibo-user-settings-modal').classList.remove('visible');
    alert('å¾®åšè®¾å®šå·²ä¿å­˜ï¼');
}

function renderWeiboUserPresetSelector() {
    const select = document.getElementById('weibo-user-preset-select');
    const presets = state.qzoneSettings.weiboUserPersonaPresets || [];
    select.innerHTML = '<option value="">-- é€‰æ‹©é¢„è®¾ --</option>';
    presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = preset.name;
        select.appendChild(option);
    });
}

function handleWeiboUserPresetSelection() {
    const select = document.getElementById('weibo-user-preset-select');
    const presets = state.qzoneSettings.weiboUserPersonaPresets || [];
    const selectedIndex = select.value;

    if (selectedIndex !== "") {
        const preset = presets[parseInt(selectedIndex)];
        document.getElementById('weibo-user-profession-modal-input').value = preset.profession;
        document.getElementById('weibo-user-persona-modal-input').value = preset.persona;
    }
}

async function openWeiboUserPresetManager() {
    const choice = await showChoiceModal("ç®¡ç†é¢„è®¾", [
        { text: 'ğŸ’¾ ä¿å­˜å½“å‰ä¸ºæ–°é¢„è®¾', value: 'save' },
        { text: 'ğŸ—‘ï¸ åˆ é™¤å·²é€‰é¢„è®¾', value: 'delete' }
    ]);

    if (choice === 'save') {
        const name = await showCustomPrompt("ä¿å­˜é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°");
        if (name && name.trim()) {
            const newPreset = {
                name: name.trim(),
                profession: document.getElementById('weibo-user-profession-modal-input').value.trim(),
                persona: document.getElementById('weibo-user-persona-modal-input').value.trim()
            };
            state.qzoneSettings.weiboUserPersonaPresets.push(newPreset);
            await saveQzoneSettings();
            renderWeiboUserPresetSelector();
            alert(`é¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
        }
    } else if (choice === 'delete') {
        const select = document.getElementById('weibo-user-preset-select');
        const selectedIndex = select.value;
        if (selectedIndex === "") {
            alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚");
            return;
        }
        const presets = state.qzoneSettings.weiboUserPersonaPresets;
        const presetName = presets[parseInt(selectedIndex)].name;
        const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${presetName}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            presets.splice(parseInt(selectedIndex), 1);
            await saveQzoneSettings();
            renderWeiboUserPresetSelector();
            alert("é¢„è®¾å·²åˆ é™¤ã€‚");
        }
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œç²˜è´´æ‰€æœ‰æ–°ä»£ç  â–¼â–¼â–¼
/**
 * ã€V2æ™ºèƒ½ç‰ˆã€‘åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼Œå¹¶æ™ºèƒ½åˆ·æ–°å½“å‰æ‰“å¼€çš„ä»»ä½•ç•Œé¢
 * @param {string} theme - 'light' æˆ– 'dark'
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    // æ ¸å¿ƒæ“ä½œï¼šä¸ºæ‰‹æœºå±å¹•æ·»åŠ æˆ–ç§»é™¤ .dark-mode ç±»
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // åŒæ­¥å¼€å…³çš„çŠ¶æ€
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    // ä¿å­˜ç”¨æˆ·çš„é€‰æ‹©
    localStorage.setItem('ephone-theme', theme);

    // ã€æ ¸å¿ƒä¿®å¤ï¼ã€‘
    // ä¸å†åªå…³å¿ƒèŠå¤©ç•Œé¢ï¼Œè€Œæ˜¯æ‰¾å‡ºå½“å‰ç©¶ç«Ÿæ˜¯å“ªä¸ªç•Œé¢å¤„äºæ¿€æ´»çŠ¶æ€
    const activeScreen = document.querySelector('.screen.active');
    if (!activeScreen) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±é€€å‡º

    // æ ¹æ®å½“å‰æ¿€æ´»çš„ç•Œé¢IDï¼Œè°ƒç”¨å®ƒä¸“å±çš„åˆ·æ–°å‡½æ•°
    switch (activeScreen.id) {
        case 'chat-interface-screen':
            if (state.activeChatId) {
                renderChatInterface(state.activeChatId);
            }
            break;
        case 'wallpaper-screen':
            // å¤–è§‚è®¾ç½®é¡µä¹Ÿéœ€è¦é‡æ–°æ¸²æŸ“æ¥åº”ç”¨æ–°ä¸»é¢˜
            renderWallpaperScreen();
            break;
        case 'font-settings-screen':
            // å­—ä½“é¢„è®¾é¡µåŒæ ·éœ€è¦
            renderFontPresets();
            break;
        // å¦‚æœæœªæ¥è¿˜æœ‰å…¶ä»–é¡µé¢éœ€è¦é€‚é…ï¼Œåœ¨è¿™é‡Œæ·»åŠ  case å³å¯
    }
}


/**
 * å½“ç”¨æˆ·ç‚¹å‡»å¼€å…³æ—¶ï¼Œåˆ‡æ¢å½“å‰çš„ä¸»é¢˜
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}
/**
 * ã€å…¨æ–°ã€‘åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œé¢„åŠ è½½æ‰€æœ‰å·²ä¿å­˜çš„å­—ä½“é¢„è®¾
 */
async function loadAllFontPresetsOnStartup() {
    console.log("æ­£åœ¨é¢„åŠ è½½æ‰€æœ‰å­—ä½“é¢„è®¾...");
    const presets = await db.fontPresets.toArray();
    if (presets && presets.length > 0) {
        presets.forEach(preset => {
            // æˆ‘ä»¬å¤ç”¨å·²æœ‰çš„ loadFontForPreview å‡½æ•°æ¥åŠ è½½æ¯ä¸ªå­—ä½“
            loadFontForPreview(preset);
        });
        console.log(`æˆåŠŸé¢„åŠ è½½äº† ${presets.length} ä¸ªå­—ä½“ã€‚`);
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—ä½“é¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ¸²æŸ“å­—ä½“é¢„è®¾çš„5ä¸ªå¡æ§½
 */
async function renderFontPresets() {
    const container = document.getElementById('font-preset-container');
    container.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    // ä»æ•°æ®åº“è¯»å–æ‰€æœ‰å·²ä¿å­˜çš„é¢„è®¾
    const presets = await db.fontPresets.toArray();

    // å¾ªç¯5æ¬¡ï¼Œåˆ›å»º5ä¸ªå¡æ§½çš„HTML
    for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'font-preset-slot';
        
        const preset = presets[i];

        if (preset) {
            // å¦‚æœè¿™ä¸ªå¡æ§½æœ‰æ•°æ®
            slot.innerHTML = `
                <div class="font-preview-text" data-preset-id="${preset.id}">Abc ä½ å¥½</div>
                <div class="font-preset-info">åç§°: ${preset.name}</div>
                <div class="font-preset-actions">
                    <button class="preset-btn apply-btn" data-preset-id="${preset.id}">åº”ç”¨</button>
                    <button class="preset-btn delete-btn delete" data-preset-id="${preset.id}">åˆ é™¤</button>
                </div>
            `;
        } else {
            // å¦‚æœè¿™ä¸ªå¡æ§½æ˜¯ç©ºçš„
            slot.classList.add('empty');
            slot.innerHTML = `
                <div class="font-preset-info">å¡æ§½ ${i + 1} ä¸ºç©º</div>
                <div class="font-preset-actions">
                    <button class="preset-btn secondary upload-url-btn" data-slot-index="${i}">URLä¸Šä¼ </button>
                    <button class="preset-btn secondary upload-local-btn" data-slot-index="${i}">æœ¬åœ°ä¸Šä¼ </button>
                </div>
            `;
        }
        container.appendChild(slot);
    }
    
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç­‰æ‰€æœ‰HTMLéƒ½åˆ›å»ºå¥½åï¼Œå†ç»Ÿä¸€åŠ è½½é¢„è§ˆå­—ä½“ â–¼â–¼â–¼
    presets.forEach(preset => {
        if (preset) {
            // ä¸ºæ¯ä¸€ä¸ªæœ‰æ•°æ®çš„é¢„è®¾ï¼Œè°ƒç”¨åŠ è½½é¢„è§ˆå‡½æ•°
            loadFontForPreview(preset);
        }
    });
    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

    // ä¸ºæ‰€æœ‰æ–°ç”Ÿæˆçš„æŒ‰é’®ç»‘å®šäº‹ä»¶
    addFontPresetButtonListeners();
}


/**
 * ã€ç»ˆæä¿®å¤ç‰ˆã€‘ä¸ºå•ä¸ªé¢„è®¾åŠ è½½å­—ä½“ä»¥ä¾›é¢„è§ˆ
 * @param {object} preset - å­—ä½“é¢„è®¾å¯¹è±¡ {id, name, url}
 */
function loadFontForPreview(preset) {
    const styleId = `font-style-${preset.id}`;
    if (document.getElementById(styleId)) return;

    const style = document.createElement('style');
    style.id = styleId;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†æ‰‹åŠ¨æ“ä½œå…ƒç´ çš„styleå±æ€§ï¼Œ
    // è€Œæ˜¯ç›´æ¥åˆ›å»ºä¸€æ¡é«˜ä¼˜å…ˆçº§çš„CSSè§„åˆ™æ¥åº”ç”¨å­—ä½“ï¼Œè¿™æ›´å¯é ã€‚
    style.innerHTML = `
        @font-face {
            font-family: 'preset-${preset.id}';
            src: url('${preset.url}');
            font-display: swap;
        }

        .font-preview-text[data-preset-id="${preset.id}"] {
            font-family: 'preset-${preset.id}', sans-serif !important;
        }
    `;
    
    document.head.appendChild(style);
}




/**
 * ä¸ºé¢„è®¾å¡æ§½ä¸­çš„æ‰€æœ‰æŒ‰é’®ç»Ÿä¸€æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
 */
function addFontPresetButtonListeners() {
    document.querySelectorAll('.upload-url-btn').forEach(btn => {
        btn.onclick = () => handleUploadFontUrl(parseInt(btn.dataset.slotIndex));
    });
    document.querySelectorAll('.upload-local-btn').forEach(btn => {
        btn.onclick = () => handleUploadFontLocal(parseInt(btn.dataset.slotIndex));
    });
    document.querySelectorAll('.apply-btn').forEach(btn => {
        btn.onclick = () => applyFontPreset(btn.dataset.presetId);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => deleteFontPreset(btn.dataset.presetId);
    });
}

/**
 * å¤„ç†é€šè¿‡URLä¸Šä¼ å­—ä½“
 * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
 */
async function handleUploadFontUrl(slotIndex) {
    const url = await showCustomPrompt("å­—ä½“URL", "è¯·è¾“å…¥å­—ä½“çš„ç½‘ç»œé“¾æ¥(.ttf, .otfç­‰)");
    if (!url || !url.trim().startsWith('http')) {
        if (url !== null) alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLï¼");
        return;
    }
    const name = await showCustomPrompt("å­—ä½“å‘½å", "è¯·ä¸ºè¿™ä¸ªå­—ä½“èµ·ä¸ªåå­—");
    if (!name || !name.trim()) {
        if (name !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    await saveFontPreset(slotIndex, name.trim(), url.trim());
}

/**
 * å¤„ç†é€šè¿‡æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å­—ä½“
 * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
 */
function handleUploadFontLocal(slotIndex) {
    const input = document.getElementById('font-preset-local-upload');
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const name = await showCustomPrompt("å­—ä½“å‘½å", "è¯·ä¸ºè¿™ä¸ªå­—ä½“èµ·ä¸ªåå­—", file.name.replace(/\.[^/.]+$/, ""));
        if (!name || !name.trim()) {
            if (name !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        // ä½¿ç”¨FileReaderå°†å­—ä½“æ–‡ä»¶è½¬ä¸ºBase64 Data URL
        const reader = new FileReader();
        reader.onload = async (event) => {
            // æ ¸å¿ƒä¿®æ”¹ï¼ševent.target.result ç°åœ¨å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ data:font/ttf;base64,... æ ¼å¼çš„å®Œæ•´æ–‡æœ¬
            await saveFontPreset(slotIndex, name.trim(), event.target.result);
        };
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ readAsDataURL æ¥è¯»å–æ–‡ä»¶
        reader.readAsDataURL(file);
    };
    input.click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
}


/**
 * å°†æ–°çš„å­—ä½“é¢„è®¾ä¿å­˜åˆ°æ•°æ®åº“
 * @param {number} slotIndex - å¡æ§½ç´¢å¼•
 * @param {string} name - å­—ä½“åç§°
 * @param {string} url - å­—ä½“URL (ç½‘ç»œæˆ–Base64)
 */
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ saveFontPreset å‡½æ•° â–¼â–¼â–¼
async function saveFontPreset(slotIndex, name, url) {
    try {
        const presets = await db.fontPresets.toArray();
        const newPreset = { id: 'font_' + Date.now(), name, url };
        presets.splice(slotIndex, 0, newPreset);
        const presetsToSave = presets.slice(0, 5);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§
        await db.transaction('rw', db.fontPresets, async () => {
            await db.fontPresets.clear();
            await db.fontPresets.bulkPut(presetsToSave);
        });

        await renderFontPresets();
        alert(`å­—ä½“ "${name}" å·²æˆåŠŸä¿å­˜åˆ°å¡æ§½ ${slotIndex + 1}ï¼`);
    } catch (error) {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœå‡ºé”™ï¼Œä¼šåœ¨è¿™é‡Œæ•è·ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·æ•°æ®æ˜¯å®‰å…¨çš„
        console.error("ä¿å­˜å­—ä½“é¢„è®¾å¤±è´¥:", error);
        alert(`ä¿å­˜å­—ä½“å¤±è´¥ï¼Œæ•°æ®å·²è‡ªåŠ¨å›æ»šï¼Œä½ ä¹‹å‰çš„å­—ä½“æ•°æ®æ˜¯å®‰å…¨çš„ã€‚é”™è¯¯: ${error.message}`);
        await renderFontPresets(); // å¤±è´¥åé‡æ–°æ¸²æŸ“ï¼Œæ¢å¤åˆ°æ—§çš„åˆ—è¡¨çŠ¶æ€
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * åˆ é™¤ä¸€ä¸ªå­—ä½“é¢„è®¾
 * @param {string} presetId - è¦åˆ é™¤çš„é¢„è®¾çš„ID
 */
async function deleteFontPreset(presetId) {
    const preset = await db.fontPresets.get(presetId);
    if (!preset) return;
    const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤å­—ä½“ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.fontPresets.delete(presetId);
        
        // ä»DOMä¸­ç§»é™¤å¯¹åº”çš„é¢„è§ˆæ ·å¼
        const styleTag = document.getElementById(`font-style-${presetId}`);
        if (styleTag) styleTag.remove();

        await renderFontPresets();
    }
}

/**
 * åº”ç”¨ä¸€ä¸ªå­—ä½“é¢„è®¾ä¸ºå…¨å±€å­—ä½“
 * @param {string} presetId - è¦åº”ç”¨çš„é¢„è®¾çš„ID
 */
async function applyFontPreset(presetId) {
    const preset = await db.fontPresets.get(presetId);
    if (preset) {
        // è°ƒç”¨ä½ å·²æœ‰çš„å…¨å±€å­—ä½“åº”ç”¨å‡½æ•°
        applyCustomFont(preset.url, false);
        // ä¿å­˜åˆ°å…¨å±€è®¾ç½®
        state.globalSettings.fontUrl = preset.url;
        await db.globalSettings.put(state.globalSettings);
        alert(`å·²å°†å…¨å±€å­—ä½“æ›´æ¢ä¸º "${preset.name}"ï¼`);
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€æ€»å…¥å£ã€‘å¤„ç†ç”¨æˆ·é€‰æ‹©çš„è§’è‰²å¡æ–‡ä»¶
 * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å¯¹è±¡
 */
async function handleCharacterImport(file) {
    if (!file) return;

    try {
        let characterData;
        let avatarBase64;

        if (file.name.toLowerCase().endsWith('.png')) {
            // å¦‚æœæ˜¯PNGæ–‡ä»¶ï¼Œè°ƒç”¨PNGè§£æå‡½æ•°
            const result = await parseCharPng(file);
            characterData = result.characterData;
            avatarBase64 = result.avatarBase64;
        } else if (file.name.toLowerCase().endsWith('.json')) {
            // å¦‚æœæ˜¯JSONæ–‡ä»¶ï¼Œè°ƒç”¨JSONè§£æå‡½æ•°
            characterData = await parseCharJson(file);
            // JSONå¡é€šå¸¸ä¸åŒ…å«å›¾ç‰‡ï¼Œæˆ‘ä»¬ç»™ä¸€ä¸ªé»˜è®¤å¤´åƒ
            avatarBase64 = defaultAvatar;
        } else {
            alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹© .png æˆ– .json æ–‡ä»¶ã€‚');
            return;
        }

        if (characterData) {
            // æˆåŠŸè§£æå‡ºæ•°æ®åï¼Œè°ƒç”¨åˆ›å»ºå‡½æ•°
            await createCharacterFromData(characterData, avatarBase64);
        }

    } catch (error) {
        console.error("å¯¼å…¥è§’è‰²å¡å¤±è´¥:", error);
        alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
    }
}

/**
 * ã€V3 - æœ€ç»ˆä¹±ç ä¿®å¤ç‰ˆã€‘
 * è§£æSillyTavernçš„PNGè§’è‰²å¡ï¼Œé€šè¿‡å­—èŠ‚çº§æ“ä½œå½»åº•è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ã€‚
 * @param {File} file - PNGæ–‡ä»¶
 * @returns {Promise<{characterData: object, avatarBase64: string}>}
 */
async function parseCharPng(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const arrayBuffer = e.target.result;
            const dataView = new DataView(arrayBuffer);

            if (dataView.getUint32(0) !== 0x89504E47 || dataView.getUint32(4) !== 0x0D0A1A0A) {
                return reject(new Error('æ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PNGå›¾ç‰‡ã€‚'));
            }

            let offset = 8;
            let characterJson = null;

            while (offset < dataView.byteLength) {
                const length = dataView.getUint32(offset);
                const type = String.fromCharCode(
                    dataView.getUint8(offset + 4),
                    dataView.getUint8(offset + 5),
                    dataView.getUint8(offset + 6),
                    dataView.getUint8(offset + 7)
                );

                if (type === 'tEXt') {
                    const chunkData = new Uint8Array(arrayBuffer, offset + 8, length);
                    
                    // â˜…â˜…â˜…â˜…â˜…ã€è¿™æ˜¯æœ¬æ¬¡ä¿®å¤ä¹±ç çš„æ ¸å¿ƒä»£ç ã€‘â˜…â˜…â˜…â˜…â˜…
                    // 1. å…ˆç”¨ä¸€ä¸ªç®€å•çš„ç¼–ç å°†å­—èŠ‚è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿æŸ¥æ‰¾å…³é”®å­— "chara"
                    let text = '';
                    for (let i = 0; i < chunkData.length; i++) {
                        text += String.fromCharCode(chunkData[i]);
                    }

                    // 2. æ£€æŸ¥å…³é”®å­—æ˜¯å¦å­˜åœ¨
                    const keyword = 'chara' + String.fromCharCode(0);
                    if (text.startsWith(keyword)) {
                        // 3. æå–å‡ºå…³é”®å­—åé¢çš„ Base64 ç¼–ç çš„å­—ç¬¦ä¸²
                        const base64Data = text.substring(keyword.length);
                        try {
                            // 4. ä½¿ç”¨ atob() è§£ç  Base64ï¼Œå¾—åˆ°ä¸€ä¸ªâ€œäºŒè¿›åˆ¶å­—ç¬¦ä¸²â€
                            const binaryString = atob(base64Data);
                            
                            // 5. å°†è¿™ä¸ªâ€œäºŒè¿›åˆ¶å­—ç¬¦ä¸²â€é‡æ–°è½¬æ¢ä¸ºåŸå§‹çš„ UTF-8 å­—èŠ‚æ•°ç»„
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            // 6. ä½¿ç”¨ TextDecoder å°†è¿™ä¸ªçº¯å‡€çš„ UTF-8 å­—èŠ‚æ•°ç»„è§£ç ä¸ºæ­£ç¡®çš„å­—ç¬¦ä¸²
                            const decodedJsonString = new TextDecoder('utf-8').decode(bytes);
                            
                            // 7. è§£ææœ€ç»ˆçš„JSONå­—ç¬¦ä¸²
                            characterJson = JSON.parse(decodedJsonString);
                            break;
                        } catch (e) {
                            return reject(new Error('è§£æå›¾ç‰‡å†…åµŒçš„è§’è‰²æ•°æ®å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®æŸåã€‚'));
                        }
                    }
                    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä»£ç ç»“æŸã€‘â˜…â˜…â˜…â˜…â˜…
                }
                
                if (type === 'IEND') break;
                offset += 12 + length;
            }

            if (characterJson) {
                const imageReader = new FileReader();
                imageReader.onload = (imgEvent) => {
                    resolve({
                        characterData: characterJson,
                        avatarBase64: imgEvent.target.result
                    });
                };
                imageReader.onerror = () => reject(new Error('è¯»å–å›¾ç‰‡ä½œä¸ºå¤´åƒå¤±è´¥ã€‚'));
                imageReader.readAsDataURL(file);
            } else {
                reject(new Error('åœ¨è¿™å¼ PNGå›¾ç‰‡ä¸­æ²¡æœ‰æ‰¾åˆ°SillyTavernè§’è‰²æ•°æ®ã€‚'));
            }
        };
        reader.onerror = () => reject(new Error('è¯»å–PNGæ–‡ä»¶å¤±è´¥ã€‚'));
        reader.readAsArrayBuffer(file);
    });
}


/**
 * è§£æJSONè§’è‰²å¡
 * @param {File} file - JSONæ–‡ä»¶
 * @returns {Promise<object>}
 */
/**
 * ã€ä¿®æ­£ç‰ˆã€‘è§£æJSONè§’è‰²å¡ï¼Œå¼ºåˆ¶ä½¿ç”¨UTF-8ç¼–ç 
 * @param {File} file - JSONæ–‡ä»¶
 * @returns {Promise<object>}
 */
async function parseCharJson(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // æ ¸å¿ƒä¿®æ­£ï¼šå…ˆè¯»å–ä¸ºArrayBufferï¼Œå†ç”¨TextDecoderæŒ‡å®šUTF-8è§£ç 
                const arrayBuffer = e.target.result;
                const textDecoder = new TextDecoder('utf-8');
                const jsonString = textDecoder.decode(arrayBuffer);
                const data = JSON.parse(jsonString);
                // å…¼å®¹ä¸¤ç§å¯èƒ½çš„æ ¼å¼
                resolve(data.data || data);
            } catch (error) {
                reject(new Error('è§£æJSONæ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç¼–ç ã€‚'));
            }
        };
        reader.onerror = () => reject(new Error('è¯»å–JSONæ–‡ä»¶å¤±è´¥ã€‚'));
        // æ ¸å¿ƒä¿®æ­£ï¼šè¯»å–ä¸ºArrayBufferè€Œä¸æ˜¯Text
        reader.readAsArrayBuffer(file);
    });
}

/**
 * ã€V5 - æœ€ç»ˆé€‚é…ç‰ˆ - è¯†åˆ« character_bookã€‘
 * æ ¹æ®è§£æå‡ºçš„æ•°æ®åˆ›å»ºæ–°è§’è‰²å’Œä¸–ç•Œä¹¦ã€‚
 * è¿™ä¸ªç‰ˆæœ¬å°†ä¼˜å…ˆæŸ¥æ‰¾æ‚¨æä¾›çš„ character_book æ ‡å‡†æ ¼å¼ã€‚
 * @param {object} data - ä»å¡ç‰‡è§£æå‡ºçš„æœ€åŸå§‹çš„JSONæ•°æ®
 * @param {string} avatarBase64 - è§’è‰²çš„å¤´åƒå›¾ç‰‡ (Base64)
 */
async function createCharacterFromData(data, avatarBase64) {
    // æ­¥éª¤ 1: ç¡®å®šæ ¸å¿ƒè§’è‰²æ•°æ® (ä¸å˜)
    const charData = data.data || data;
    const characterName = charData.name ? charData.name.trim() : 'æœªå‘½åè§’è‰²';
    
    // æ­¥éª¤ 2: åˆ›å»ºæ–°çš„èŠå¤©å¯¹è±¡ (ä¸å˜)
    const newChatId = 'chat_' + Date.now();
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€ç»ˆæå®Œæ•´ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ const newChat = { ... }; ä»£ç å— â–¼â–¼â–¼

const newChat = {
    id: newChatId,
    name: characterName,
    isGroup: false,
    isPinned: false,
    history: [],
    unreadCount: 0,
    musicData: { totalTime: 0 },
    npcLibrary: [],
    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
    status: { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false },
    weiboDms: [],
    loversSpaceData: null,
    settings: {
        aiPersona: charData.description || 'è¯¥è§’è‰²æ²¡æœ‰æè¿°ã€‚',
        myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
        maxMemory: 10,
        aiAvatar: avatarBase64,
        myAvatar: defaultAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
        aiAvatarLibrary: [],
        stickerLibrary: [],
        summary: { 
            enabled: false, 
            mode: 'auto', 
            count: 20, 
            prompt: 'è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚', 
            lastSummaryIndex: -1 
        },
        linkedMemories: [],
        offlineMode: { 
            enabled: false, 
            prompt: '', 
            style: '', 
            wordCount: 300, 
            presets: [] 
        },
        timePerceptionEnabled: true,
        customTime: '',
        isCoupleAvatar: false,
        coupleAvatarDescription: '',
        weiboProfession: '',
        weiboInstruction: '',
        visualVideoCallEnabled: false,
        charVideoImage: '',
        userVideoImage: '',
        petAdopted: false,
        pet: null,
    },
    characterPhoneData: {
        lastGenerated: null,
        chats: {},
        shoppingCart: [],
        memos: [],
        browserHistory: [],
        photoAlbum: [],
        bank: { balance: 0, transactions: [] },
        trajectory: [],
        appUsage: [],
        diary: []
    }
};

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    await db.chats.put(newChat);
    state.chats[newChatId] = newChat;
    
    // =================================================================
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šé‡æ„ä¸–ç•Œä¹¦æŸ¥æ‰¾é€»è¾‘ â–¼â–¼â–¼
    // =================================================================
    
    console.log("å¼€å§‹æ£€æµ‹ä¸–ç•Œä¹¦æ•°æ®...");
    let worldBookFound = false;

    // ç­–ç•¥ä¸€ï¼šã€æœ€é«˜ä¼˜å…ˆçº§ã€‘æŸ¥æ‰¾æ‚¨æä¾›çš„ character_book æ ‡å‡†æ ¼å¼
    if (charData.character_book && charData.character_book.entries && Array.isArray(charData.character_book.entries) && charData.character_book.entries.length > 0) {
        console.log(`æ£€æµ‹åˆ°æœ€æ–°çš„ character_book æ ¼å¼ (${charData.character_book.entries.length}æ¡)ï¼Œå¼€å§‹å¯¼å…¥...`);
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        // æˆ‘ä»¬å°†è°ƒç”¨ã€ä¿®æ”¹åã€‘çš„è¾…åŠ©å‡½æ•°æ¥å¤„ç†
        await saveWorldBookEntriesFromArray(charData.character_book.entries, newCategoryId);
        worldBookFound = true;
    }
    
    // ç­–ç•¥äºŒï¼šå…¼å®¹æ—§çš„ world_entries æ ¼å¼
    else if (charData.world_entries && Array.isArray(charData.world_entries) && charData.world_entries.length > 0) {
        console.log(`æ£€æµ‹åˆ°æ—§ç‰ˆ world_entries æ ¼å¼ (${charData.world_entries.length}æ¡)ï¼Œå¼€å§‹å¯¼å…¥...`);
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await saveWorldBookEntriesFromArray(charData.world_entries, newCategoryId);
        worldBookFound = true;
    }
    
    // ç­–ç•¥ä¸‰ï¼šå…¼å®¹æ›´æ—§çš„ data.world æ ¼å¼
    else if (data.world && typeof data.world === 'string' && data.world.trim()) {
        console.log("æ£€æµ‹åˆ°å¤–å±‚ world å­—æ®µæ ¼å¼ï¼Œå¼€å§‹å¯¼å…¥...");
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await parseAndSaveWorldBooks(data.world, newCategoryId);
        worldBookFound = true;
    }

    // ç­–ç•¥å››ï¼šæœ€åçš„å…¼å®¹æ‰‹æ®µ world_info
    else if (charData.world_info && typeof charData.world_info === 'string' && charData.world_info.trim()) {
        console.log("æ£€æµ‹åˆ°æ—§ç‰ˆ world_info å­—æ®µæ ¼å¼ï¼Œå¼€å§‹å¯¼å…¥...");
        const newCategory = { name: characterName };
        const newCategoryId = await db.worldBookCategories.add(newCategory);
        await parseAndSaveWorldBooks(charData.world_info, newCategoryId);
        worldBookFound = true;
    }

    if (!worldBookFound) {
        console.log("è¯Šæ–­ï¼šåœ¨æ­¤è§’è‰²å¡ä¸­æœªæ‰¾åˆ°ä»»ä½•å¯è¯†åˆ«çš„ä¸–ç•Œä¹¦å­—æ®µã€‚");
    }
    
    // =================================================================
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ç»“æŸ â–²â–²â–²
    // =================================================================

    // æ­¥éª¤ 4: åˆ·æ–°UI (ä¸å˜)
    await renderChatList();
    await showCustomAlert('å¯¼å…¥æˆåŠŸï¼', `è§’è‰²â€œ${characterName}â€å·²æˆåŠŸåˆ›å»ºï¼`);
}


/**
 * ã€V2 - é€‚é… comment å­—æ®µã€‘
 * ä»SillyTavernçš„ world_entries æˆ– character_book.entries æ•°ç»„ç›´æ¥åˆ›å»ºä¸–ç•Œä¹¦
 * @param {Array<object>} entriesArray - åŒ…å«ä¸–ç•Œä¹¦æ¡ç›®çš„æ•°ç»„
 * @param {number} categoryId - è¿™äº›ä¸–ç•Œä¹¦æ‰€å±çš„åˆ†ç±»ID
 */
async function saveWorldBookEntriesFromArray(entriesArray, categoryId) {
    const newBooks = [];

    for (const entry of entriesArray) {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºèƒ½è·å–æ¡ç›®åç§° â–¼â–¼â–¼
        // ä¼˜å…ˆä½¿ç”¨ comment å­—æ®µä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœå®ƒå­˜åœ¨ä¸”ä¸ä¸ºç©ºã€‚
        // å¦åˆ™ï¼Œå†å°è¯•ä½¿ç”¨ keys æ•°ç»„ã€‚
        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±ç»™ä¸€ä¸ªé»˜è®¤åå­—ã€‚
        const entryName = (entry.comment && entry.comment.trim()) 
                          ? entry.comment.trim() 
                          : (entry.keys && entry.keys.length > 0 ? entry.keys.join(', ') : 'æœªå‘½åæ¡ç›®');
        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ç»“æŸ â–²â–²â–²

        // æ£€æŸ¥æ¡ç›®æ˜¯å¦æœ‰æ•ˆ (æœ‰åå­—ã€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ˜¯å¯ç”¨çš„)
        // (typeof entry.enabled === 'undefined' || entry.enabled) æ˜¯ä¸ºäº†å…¼å®¹æ²¡æœ‰ enabled å­—æ®µçš„å¡ç‰‡
        if (entryName !== 'æœªå‘½åæ¡ç›®' && entry.content && (typeof entry.enabled === 'undefined' || entry.enabled)) {
            newBooks.push({
                id: 'wb_' + Date.now() + Math.random(),
                name: entryName, // ä½¿ç”¨æˆ‘ä»¬æ™ºèƒ½è·å–åˆ°çš„åå­—
                content: entry.content,
                categoryId: categoryId
            });
        }
    }

    if (newBooks.length > 0) {
        await db.worldBooks.bulkAdd(newBooks);
        // ç¡®ä¿ state.worldBooks ä¹Ÿè¢«æ›´æ–°ï¼Œä»¥ä¾¿UIèƒ½ç«‹å³æ˜¾ç¤º
        const allBooks = await db.worldBooks.toArray();
        state.worldBooks = allBooks;
        console.log(`æˆåŠŸå¯¼å…¥ ${newBooks.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®åˆ°åˆ†ç±»ID: ${categoryId}`);
    }
}



// ã€è¾…åŠ©å‡½æ•°ã€‘è·å–äº‹ä»¶çš„åæ ‡
function getEventCoords(e) {
    // å¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œå°±ä» e.touches[0] è·å–
    if (e.touches && e.touches[0]) {
        return { x: e.touches[0].pageX, y: e.touches[0].pageY };
    }
    // å¦åˆ™ï¼Œå°±æ˜¯é¼ æ ‡äº‹ä»¶ï¼Œç›´æ¥ä» e è·å–
    return { x: e.pageX, y: e.pageY };
}


// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ showScreen å‡½æ•° â–¼â–¼â–¼
function showScreen(screenId) {
    if (!document.getElementById('logistics-screen').classList.contains('active')) {
        logisticsUpdateTimers.forEach(timerId => clearTimeout(timerId));
        logisticsUpdateTimers = [];
    }

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ç°åœ¨ç›´æ¥è°ƒç”¨çœŸæ­£çš„å‡½æ•°ï¼Œä¸å†éœ€è¦ "Proxy"
    if (screenId === 'chat-list-screen') {
        renderChatList(); 
        switchToChatListView('messages-view');
    }
    if (screenId === 'api-settings-screen') {
        renderApiSettings();
    }
    if (screenId === 'wallpaper-screen') {
        renderWallpaperScreen();
    }
    if (screenId === 'world-book-screen') {
        renderWorldBookScreen();
    }

    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) {
        screenToShow.classList.add('active');
    }

    if (screenId === 'chat-interface-screen') {
        updateListenTogetherIcon(state.activeChatId);
    }
    
    if (screenId === 'font-settings-screen') {
        document.getElementById('font-preview').style.fontFamily = '';
        applyCustomFont(state.globalSettings.fontUrl || '', true);
        renderFontPresets();
    }
}
window.showScreen = showScreen; // ç¡®ä¿ showScreen è‡ªå·±ä¹Ÿæ˜¯å…¨å±€çš„
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view') // <-- æ–°å¢è¿™ä¸€è¡Œ
    };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // éšè—æ‰€æœ‰è§†å›¾
            Object.values(views).forEach(v => v.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ é«˜äº®
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„æ˜¾éš â–¼â–¼â–¼
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

            // æ ¹æ®è§†å›¾IDæ‰§è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é€»è¾‘
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›æ¶ˆæ¯åˆ—è¡¨æ—¶è¦æ‰§è¡Œçš„é€»è¾‘
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'åˆšåˆš';
            if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

// â–¼â–¼â–¼ æ­¥éª¤3.1ï¼šç”¨è¿™æ•´å—ã€ç»ˆæä¿®å¤ç‰ˆã€‘ä»£ç æ›¿æ¢æ—§çš„ renderQzonePosts å‡½æ•° â–¼â–¼â–¼
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [posts, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);

    const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
    
    postsListEl.innerHTML = '';

    if (posts.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>';
        return;
    }

    const userSettings = state.qzoneSettings;
    
// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼
// â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®å¤çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
// 1. åœ¨æ¸²æŸ“æ‰€æœ‰å¸–å­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰AIè§’è‰²åå­—çš„é›†åˆ(Set)ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚
const allAiCharacterNames = new Set(Object.values(state.chats).filter(chat => !chat.isGroup).map(chat => chat.name));
// â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

posts.forEach(post => {
    const postContainer = document.createElement('div');
    postContainer.className = 'qzone-post-container';
    postContainer.dataset.postId = post.id;

    const postEl = document.createElement('div');
    postEl.className = 'qzone-post-item';

    let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

    if (post.authorId === 'user') {
        authorAvatar = userSettings.avatar;
        authorNickname = userSettings.nickname;
    } else if (state.chats[post.authorId]) {
        const authorChat = state.chats[post.authorId];
        authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
        authorNickname = authorChat.name;
    } else {
        authorAvatar = defaultAvatar;
        authorNickname = '{{char}}';
    }
    
    let contentHtml = '';
    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

    if (post.type === 'shuoshuo') {
        contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
    } 
    else if (post.type === 'image_post' && post.imageUrl) {
        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
    } 
    else if (post.type === 'text_image') {
        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
    }

    let likesHtml = '';
    if (post.likes && post.likes.length > 0) {
        likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span></div>`;
    }
    
    let commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
        // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®å¤çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
        // 2. ä¿®æ”¹è¿™é‡Œçš„è¿‡æ»¤é€»è¾‘
        const commentsToShow = post.areCommentsVisible === false 
            ? post.comments.filter(comment => 
                // æ¡ä»¶1: è¯„è®ºè€…æ˜¯ä½ è‡ªå·±
                comment.commenterName === userSettings.nickname || 
                // æ¡ä»¶2: è¯„è®ºè€…çš„åå­—åœ¨æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„AIè§’è‰²åå­—åˆ—è¡¨é‡Œ
                allAiCharacterNames.has(comment.commenterName)
              )
            : post.comments; // å¦‚æœå¼€å…³æ˜¯å¼€çš„ï¼Œå°±æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
        // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

        if (commentsToShow.length > 0) {
// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

                commentsHtml = '<div class="post-comments-container">';
                commentsToShow.forEach(comment => {
                    const originalIndex = post.comments.indexOf(comment);
                    let replyHtml = '';
                    if (comment.replyTo) {
                        replyHtml = `<span class="reply-text">å›å¤</span> <span class="reply-target-name">${comment.replyTo}</span>`;
                    }
                    commentsHtml += `
                        <div class="comment-item" data-commenter-name="${comment.commenterName}">
                            <span class="commenter-name">${comment.commenterName}</span>${replyHtml}:
                            <span class="comment-text"> ${comment.text}</span>
                            <span class="comment-delete-btn" data-comment-index="${originalIndex}">Ã—</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }
        }


        const commentsAndFooterHtml = `
            ${commentsHtml}
            <div class="post-footer">
                <div class="comment-section">
                    <img src="${commentAvatar}" class="comment-avatar">
                    <input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹">
                    <div class="at-mention-popup"></div>
                </div>
                <button class="comment-send-btn">å‘é€</button>
            </div>
        `;

        const userNickname = state.qzoneSettings.nickname;
        const isLikedByUser = post.likes && post.likes.includes(userNickname);
        const isFavoritedByUser = favoritedPostIds.has(post.id);

        postEl.innerHTML = `
            <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                <div class="post-actions-btn">â€¦</div>
            </div>
            <div class="post-main-content">${contentHtml}</div>
            <div class="post-feedback-icons">
                <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                <span class="action-icon summon-npc" data-post-id="${post.id}" data-author-id="${post.authorId}" title="å¬å”¤NPCè¯„è®º"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                </div>
            ${likesHtml}
            ${commentsAndFooterHtml} 
        `;
        
        const deleteAction = document.createElement('div');
        deleteAction.className = 'qzone-post-delete-action';
        deleteAction.innerHTML = '<span>åˆ é™¤</span>';
        postContainer.appendChild(postEl);
        postContainer.appendChild(deleteAction);
        const commentSection = postContainer.querySelector('.comment-section');
        if (commentSection) {
            commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
            commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
        }
        postsListEl.appendChild(postContainer);
        const commentInput = postContainer.querySelector('.comment-input');
        if (commentInput) {
            const popup = postContainer.querySelector('.at-mention-popup');
            commentInput.addEventListener('input', () => {
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
                if (atMatch) {
                    const namesToMention = new Set();
                    const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                    if (authorNickname) namesToMention.add(authorNickname);
                    postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                        namesToMention.add(nameEl.textContent.replace(':', ''));
                    });
                    namesToMention.delete(state.qzoneSettings.nickname);
                    popup.innerHTML = '';
                    if (namesToMention.size > 0) {
                        const searchTerm = atMatch[1];
                        namesToMention.forEach(name => {
                            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                const item = document.createElement('div');
                                item.className = 'at-mention-item';
                                item.textContent = name;
                                item.addEventListener('mousedown', (e) => {
                                    e.preventDefault();
                                    const newText = value.substring(0, atMatch.index) + `@${name} `;
                                    commentInput.value = newText;
                                    popup.style.display = 'none';
                                    commentInput.focus();
                                });
                                popup.appendChild(item);
                            }
                        });
                        popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                    } else {
                        popup.style.display = 'none';
                    }
                } else {
                    popup.style.display = 'none';
                }
            });
            commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
        }
    });
}
// â–²â–²â–² æ­¥éª¤3.1æ›¿æ¢ç»“æŸ â–²â–²â–²
async function renderFollowingFeed() {
    const feedListEl = document.getElementById('weibo-following-feed-list');
    if (!feedListEl) return;

    // 1. ä»æ•°æ®åº“è·å–æ‰€æœ‰åŠ¨æ€
    const allPosts = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
    
    // 2. ã€æ ¸å¿ƒã€‘ç­›é€‰å‡ºä½œè€…ä¸æ˜¯ 'user' çš„åŠ¨æ€
    const followingPosts = allPosts.filter(post => post.authorId !== 'user');

    feedListEl.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    if (followingPosts.length === 0) {
        feedListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ä½ å…³æ³¨çš„äººè¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•åŠ¨æ€å“¦ã€‚</p>';
        return;
    }

    // 3. éå†ç­›é€‰åçš„åŠ¨æ€ï¼Œå¹¶æ¸²æŸ“å®ƒä»¬
    //    ã€æç¤ºã€‘è¿™é‡Œåˆ›å»ºå•ä¸ªåŠ¨æ€HTMLçš„é€»è¾‘ï¼Œå¯ä»¥å®Œå…¨å¤åˆ¶ `renderQzonePosts` å‡½æ•°é‡Œçš„ forEach å¾ªç¯å†…éƒ¨çš„ä»£ç ã€‚
    //    ä½ åªéœ€è¦æŠŠç›®æ ‡å®¹å™¨ä» `postsListEl` æ”¹ä¸º `feedListEl` å³å¯ã€‚
    followingPosts.forEach(post => {
        // ... åœ¨è¿™é‡Œç²˜è´´ renderQzonePosts å‡½æ•°ä¸­åˆ›å»º postContainerã€postEl çš„é‚£ä¸€å¤§æ®µä»£ç  ...
        // ... è®°å¾—æœ€åè¦æŠŠ postContainer append åˆ° feedListEl ä¸­ ...
        // feedListEl.appendChild(postContainer);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸ªã€æ›´æ–°åçš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ displayFilteredFavorites å‡½æ•° â–¼â–¼â–¼

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸å…³æ”¶è—' : 'ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'æ¥è‡ªåŠ¨æ€';
            let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ·';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç å¼€å§‹ â–¼â–¼â–¼
            
            // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
            let likesHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span>
                    </div>`;
            }

            // 2. æ„é€ è¯„è®ºåŒºåŸŸçš„HTML
            let commentsHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ comments æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.comments && post.comments.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºè¯„è®ºå®¹å™¨ï¼Œå¹¶éå†æ¯ä¸€æ¡è¯„è®º
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç ç»“æŸ â–²â–²â–²

} else if (item.type === 'chat_message') {
    const msg = item.content;
    const chat = state.chats[item.chatId];
    if (!chat) continue; 

    sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
    const isUser = msg.role === 'user';
    let senderName, senderAvatar;

    if (isUser) {
        // ç”¨æˆ·æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
    } else { // AI/æˆå‘˜æ¶ˆæ¯

         if (chat.isGroup) {
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ originalName å»åŒ¹é…ï¼Œè€Œä¸æ˜¯æ—§çš„ name
            const member = chat.members.find(m => m.originalName === msg.senderName);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
            
            senderName = msg.senderName;
            // å› ä¸ºç°åœ¨èƒ½æ­£ç¡®æ‰¾åˆ° member å¯¹è±¡äº†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ­£ç¡®è·å–åˆ°ä»–çš„å¤´åƒ
            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
        } else {
            // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
        }
    }

    // åç»­æ‹¼æ¥ headerHtml å’Œ contentHtml çš„é€»è¾‘éƒ½ä¿æŒä¸å˜
    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
    
    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ‰ä¸Šé¢é‚£æ®µæ—§çš„ else { ... } ä»£ç å— â–¼â–¼â–¼
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘å†æ¬¡æ›¿æ¢æ‰ createMessageElement å‡½æ•°é‡Œçš„ else { ... } ä»£ç å— â–¼â–¼â–¼
} else {
    const messageText = String(msg.content || '');
    // ä¾¦æµ‹æ ¼å¼ï¼š[sticker:åå­—]
    const stickerMatch = messageText.match(/\[sticker:\s*(.+?)\s*\]/i);

    if (stickerMatch) {
        // å¦‚æœåŒ¹é…æˆåŠŸï¼Œæå–å‡ºåå­—
        const stickerName = stickerMatch[1].trim();
        // ã€æ ¸å¿ƒã€‘åœ¨æ‰€æœ‰å¯èƒ½çš„è¡¨æƒ…åº“é‡ŒæŸ¥æ‰¾ï¼ˆç”¨æˆ·çš„ã€è§’è‰²çš„ä¸“å±ã€è§’è‰²çš„é€šç”¨ï¼‰
        const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
        const foundSticker = allStickers.find(s => s.name === stickerName);
        
        if (foundSticker) {
            // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ˜¾ç¤ºå›¾ç‰‡ï¼
            bubble.classList.add('is-sticker');
            contentHtml = `<img src="${foundSticker.url}" alt="${foundSticker.name}" class="sticker-image">`;
        } else {
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆæ¯”å¦‚AIè‡ªå·±ç¼–äº†ä¸ªåå­—ï¼‰ï¼Œå°±è¿˜æ˜¯æŒ‰æ™®é€šæ–‡å­—æ˜¾ç¤º
            contentHtml = messageText.replace(/\n/g, '<br>');
        }
    } else {
        // å¦‚æœä¸åŒ¹é…ï¼Œå°±æ˜¯æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
        contentHtml = messageText.replace(/\n/g, '<br>');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


}
        
        // â–¼â–¼â–¼ ä¿®æ”¹æœ€ç»ˆçš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- æŠŠæˆ‘ä»¬æ–°åˆ›å»ºçš„ footerHtml æ”¾åœ¨è¿™é‡Œ
            
        listEl.appendChild(card);
    }
}

// â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–²

        /**
         * ã€é‡æ„åçš„å‡½æ•°ã€‘: è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
            // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
            displayFilteredFavorites(allFavoriteItems);
        }

        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

function resetCreatePostModal() {
    document.getElementById('post-public-text').value = '';
    document.getElementById('post-image-preview').src = '';
    document.getElementById('post-image-description').value = '';
    document.getElementById('post-image-preview-container').classList.remove('visible');
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-local-image-input').value = '';
    document.getElementById('post-hidden-text').value = '';

    // ã€æ ¸å¿ƒä¿®å¤ã€‘æˆ‘ä»¬ä¸å†æ¨¡æ‹Ÿç‚¹å‡»ï¼Œè€Œæ˜¯ç›´æ¥ã€å®‰å…¨åœ°è®¾ç½®çŠ¶æ€
    const imageModeBtn = document.getElementById('switch-to-image-mode');
    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
    const imageModeContent = document.getElementById('image-mode-content');
    const textImageModeContent = document.getElementById('text-image-mode-content');
    
    imageModeBtn.classList.add('active');
    textImageModeBtn.classList.remove('active');
    imageModeContent.classList.add('active');
    textImageModeContent.classList.remove('active');
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤ã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ exportBackup å‡½æ•° â–¼â–¼â–¼
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        // --- è¿™éƒ¨åˆ†æ•°æ®åº“è¯»å–çš„ä»£ç ä¿æŒä¸å˜ ---
        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups, memories,
            worldBookCategories, callRecords, customAvatarFrames, themes,
            apiPresets, bubbleStylePresets, fontPresets, homeScreenPresets
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
            db.memories.toArray(),
            db.worldBookCategories.toArray(),
            db.callRecords.toArray(),
            db.customAvatarFrames.toArray(),
            db.themes.toArray(),
            db.apiPresets.toArray(),
            db.bubbleStylePresets.toArray(),
            db.fontPresets.toArray(),
            db.homeScreenPresets.toArray()
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups, memories,
            worldBookCategories, callRecords, customAvatarFrames, themes,
            apiPresets, bubbleStylePresets, fontPresets, homeScreenPresets
        });
        
        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼â–¼â–¼â–¼ ---
        // æˆ‘ä»¬é‡æ„äº† homeScreenState å¯¹è±¡ï¼Œç¡®ä¿å®ƒèƒ½åŒ…å«ç¬¬ä¸€é¡µçš„æ‰€æœ‰æ•°æ®
        backupData.homeScreenState = {
            // --- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„ç¬¬ä¸€é¡µæ•°æ® ---
            'profile-banner-img': document.getElementById('profile-banner-img').src,
            'profile-avatar-img': document.getElementById('profile-avatar-img').src,
            'profile-username': document.getElementById('profile-username').textContent,
            'profile-sub-username': document.getElementById('profile-sub-username').textContent,
            'profile-bio': document.getElementById('profile-bio').textContent,
            'profile-location': document.getElementById('profile-location').innerHTML, // ä½¿ç”¨innerHTMLæ¥ä¿å­˜SVGå›¾æ ‡
            'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
            'widget-image-1': document.getElementById('widget-image-1').src, // è¿™æ˜¯ä½ ç‰¹åˆ«æåˆ°çš„ç»„ä»¶
            'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
            'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
            'widget-image-2': document.getElementById('widget-image-2').src,
            'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
            'widget-image-3': document.getElementById('widget-image-3').src,
            'second-page-bubble': document.getElementById('second-page-bubble').textContent,
            'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
            'circular-bubble': document.getElementById('circular-bubble').textContent,
            'widget-image-4': document.getElementById('widget-image-4').src,
            'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
            'bubble-top-left': document.getElementById('bubble-top-left').textContent,
            'bubble-top-right': document.getElementById('bubble-top-right').textContent,
            'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
            'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
            'new-widget-avatar': document.getElementById('new-widget-avatar').src,
            'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
            'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
            'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
            'widget-month-display': document.getElementById('widget-month-display').textContent,
            'appIcons': { ...state.globalSettings.appIcons },
            'lockscreenWallpaper': state.globalSettings.lockscreenWallpaper,
            'wallpaper': state.globalSettings.wallpaper
        };
        // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

        // åç»­çš„ä¸‹è½½é€»è¾‘ä¿æŒä¸å˜
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼');

    } catch (error) {
        console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}




// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ç»ˆæä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ importBackup å‡½æ•° â–¼â–¼â–¼
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'ä¸¥é‡è­¦å‘Šï¼',
        'å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            // 1. æ¸…ç©ºæ‰€æœ‰ç°æœ‰è¡¨æ ¼
            for (const table of db.tables) {
                await table.clear();
            }

            // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½ã€å®‰å…¨åœ°å¯¼å…¥æ•°æ®
            // æˆ‘ä»¬ä¼šæ£€æŸ¥å¤‡ä»½æ–‡ä»¶ä¸­çš„æ¯ä¸€é¡¹æ•°æ®ï¼Œåªæœ‰å½“å½“å‰ä»£ç çš„æ•°æ®åº“é‡Œä¹Ÿå­˜åœ¨å¯¹åº”çš„è¡¨æ ¼æ—¶ï¼Œæ‰è¿›è¡Œå¯¼å…¥
            
            // å¯¼å…¥æ•°ç»„ç±»å‹çš„æ•°æ®
            const arrayTables = [
                'chats', 'worldBooks', 'worldBookCategories', 'userStickers', 
                'personaPresets', 'qzonePosts', 'qzoneAlbums', 'qzonePhotos', 
                'favorites', 'qzoneGroups', 'memories', 'callRecords', 
                'customAvatarFrames', 'themes', 'apiPresets', 'bubbleStylePresets',
                // å°±ç®—å¤‡ä»½æ–‡ä»¶é‡Œæœ‰ä¸‹é¢è¿™äº›æ–°ç‰ˆæ‰æœ‰çš„æ•°æ®ï¼Œè¿™æ®µä»£ç ä¹Ÿèƒ½å®‰å…¨è·³è¿‡
                'fontPresets', 'homeScreenPresets' 
            ];

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦æ ¼å¼å…¼å®¹è½¬æ¢ä»£ç  â–¼â–¼â–¼
for (const tableName of arrayTables) {
    if (Array.isArray(data[tableName]) && db[tableName]) {
        let itemsToPut = data[tableName];

        // ã€æ ¸å¿ƒé€»è¾‘ã€‘å½“å¤„ç†ä¸–ç•Œä¹¦è¡¨æ ¼æ—¶ï¼Œæ‰§è¡Œç‰¹åˆ«çš„è½¬æ¢æ“ä½œ
        if (tableName === 'worldBooks') {
            console.log("æ­£åœ¨æ£€æŸ¥å¹¶è½¬æ¢ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼ä»¥å…¼å®¹...");
            itemsToPut.forEach(book => {
                // å¦‚æœ content æ˜¯æ•°ç»„ (åˆ«äººçš„æ ¼å¼)ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸² (æˆ‘çš„æ ¼å¼)
                if (Array.isArray(book.content)) {
                    console.log(`æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼çš„ä¸–ç•Œä¹¦: "${book.name}"ï¼Œæ­£åœ¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²...`);
                    
                    // å°†æ•°ç»„ä¸­çš„æ¯ä¸ªæ¡ç›®å¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
                    const convertedEntries = book.content.map(entry => {
                        const stringParts = [];
                        if (entry.comment) {
                            stringParts.push(`[å¤‡æ³¨: ${entry.comment}]`);
                        }
                        if (entry.keys && entry.keys.length > 0) {
                            stringParts.push(`[å…³é”®è¯: ${entry.keys.join(', ')}]`);
                        }
                        stringParts.push(entry.content); // æ¡ç›®ä¸»è¦å†…å®¹
                        return stringParts.join('\n'); // æ¯ä¸ªæ¡ç›®çš„å†…éƒ¨ç”¨æ¢è¡Œåˆ†éš”
                    });
                    
                    // å°†æ‰€æœ‰è½¬æ¢åçš„æ¡ç›®å­—ç¬¦ä¸²ç”¨ä¸€ä¸ªæ˜æ˜¾çš„åˆ†éš”ç¬¦è¿æ¥èµ·æ¥
                    book.content = convertedEntries.join('\n\n---\n\n');
                }
            });
        }
        
        // è¿‡æ»¤å¹¶ä¿å­˜æ•°æ® (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜)
        const validItems = itemsToPut.filter(item => item && (typeof item.id === 'undefined' || typeof item.id === 'string' || typeof item.id === 'number'));
        if (validItems.length > 0) {
            console.log(`æ­£åœ¨å¯¼å…¥ ${validItems.length} æ¡æ•°æ®åˆ°è¡¨æ ¼: ${tableName}...`);
            await db[tableName].bulkPut(validItems);
        }

    } else {
        console.log(`è·³è¿‡å¯¼å…¥: ${tableName} (åœ¨å¤‡ä»½æ–‡ä»¶æˆ–å½“å‰æ•°æ®åº“ä¸­ä¸å­˜åœ¨)`);
    }
}
// â–²â–²â–² ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

            
            // å¯¼å…¥å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯è®¾ç½®ï¼‰
            const objectTables = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
            for (const tableName of objectTables) {
                if (data[tableName] && db[tableName]) {
                    console.log(`æ­£åœ¨å¯¼å…¥è®¾ç½®: ${tableName}...`);
                    await db[tableName].put(data[tableName]);
                }
            }
        });

        // å¯¼å…¥ä¸»å±å¹•æ ·å¼çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œå› ä¸ºå®ƒä¸ç›´æ¥æ“ä½œæ•°æ®åº“çš„å¤šä¸ªè¡¨
        if (data.homeScreenState) {
            const settings = await db.globalSettings.get('main') || { id: 'main' };
            settings.widgetData = data.homeScreenState;
            if (data.homeScreenState.wallpaper) settings.wallpaper = data.homeScreenState.wallpaper;
            if (data.homeScreenState.lockscreenWallpaper) settings.lockscreenWallpaper = data.homeScreenState.lockscreenWallpaper;
            if (data.homeScreenState.appIcons) settings.appIcons = data.homeScreenState.appIcons;
            await db.globalSettings.put(settings);
            console.log("å·²æˆåŠŸå¯¼å…¥ä¸»å±å¹•æ ·å¼æ•°æ®ã€‚");
        }


        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`);
    }
}

function applyCustomFont(fontUrl, isPreviewOnly = false) {
    if (!fontUrl) {
        // å¦‚æœæ²¡æœ‰æä¾›å­—ä½“é“¾æ¥ï¼ˆæ¯”å¦‚æ¢å¤é»˜è®¤ï¼‰ï¼Œå°±æ¸…ç©ºæ ·å¼
        dynamicFontStyle.innerHTML = '';
        document.getElementById('font-preview').style.fontFamily = '';
        return;
    }

    // è¿™æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å†…éƒ¨åå­—
    const fontName = 'custom-user-font';
    
    // è¿™æ˜¯å®šä¹‰å­—ä½“çš„æ ·å¼è§„åˆ™
    const newStyle = `
        @font-face {
          font-family: '${fontName}';
          src: url('${fontUrl}');
          font-display: swap;
        }`;

    if (isPreviewOnly) {
        // å¦‚æœåªæ˜¯é¢„è§ˆï¼Œè¿™ä¸ªé€»è¾‘ä¿æŒä¸å˜
        const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
        previewStyle.id = 'preview-font-style';
        previewStyle.innerHTML = newStyle;
        if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
    } else {
        // ã€æ ¸å¿ƒã€‘å¦‚æœæ˜¯å…¨å±€åº”ç”¨ï¼Œå°±åŒæ—¶å®šä¹‰å­—ä½“å¹¶å‘Šè¯‰æ•´ä¸ª body å»ä½¿ç”¨å®ƒ
        dynamicFontStyle.innerHTML = `
            ${newStyle}
            body {
              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
            }`;
    }
}


        async function resetToDefaultFont() {
            // 1. æ¸…é™¤å…¨å±€å­—ä½“æ ·å¼
            dynamicFontStyle.innerHTML = ''; 
            
            // 2. æ›´æ–°å¹¶ä¿å­˜è®¾ç½®
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            
            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ˜ç¡®åœ°å°†å…¨å±€é¢„è§ˆåŒºçš„å­—ä½“ä¹Ÿæ¢å¤ä¸ºé»˜è®¤
            const globalPreview = document.getElementById('font-preview');
            globalPreview.style.fontFamily = ''; // ç§»é™¤å†…è”æ ·å¼
            
            // 4. åº”ç”¨ä¸€ä¸‹ç©ºçš„å­—ä½“è®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰åœ°æ–¹éƒ½æ¢å¤
            applyCustomFont('', true);
            
            alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
        }



async function loadAllDataFromDB() {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬æŠŠ Promise.all çš„å†…å®¹æ‰©å……äº†
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        charStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites,
        apiPresets,
        bubbleStylePresets,
        datingScenes, // <--- åœ¨è¿™é‡Œæ–°å¢
        localUserStickerCategories
    ] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.charStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray(),
        db.apiPresets.toArray(),
        db.bubbleStylePresets.toArray(),
        db.datingScenes.toArray(), // <--- åœ¨è¿™é‡Œæ–°å¢
        db.userStickerCategories.toArray()
    ]);

    state.chats = chatsArr.reduce((acc, chat) => {
            // ã€å…¨æ–°ã€‘ä¸ºæ—§çš„ç¾¤èŠæ•°æ®å…¼å®¹ä¸“å±è¡¨æƒ…åº“
        if (chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
            if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
            chat.settings.stickerLibrary = [];
            console.log(`ä¸ºæ—§ç¾¤èŠ "${chat.name}" è¡¥å…¨äº†ä¸“å±è¡¨æƒ…åº“(stickerLibrary)å±æ€§ã€‚`);
        }
            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰ä¸“å±è¡¨æƒ…åº“çš„è§’è‰²æ·»åŠ ä¸€ä¸ªç©ºçš„è¡¨æƒ…åº“
        if (!chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
            if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
            chat.settings.stickerLibrary = [];
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†ä¸“å±è¡¨æƒ…åº“(stickerLibrary)å±æ€§ã€‚`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    if (typeof chat.unreadCount === 'undefined') {
        chat.unreadCount = 0; // å¦‚æœè¿™ä¸ªèŠå¤©å¯¹è±¡æ²¡æœ‰ unreadCount å±æ€§ï¼Œå°±ç»™å®ƒåˆå§‹åŒ–ä¸º 0
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„â€œæ•°æ®è¿ç§»â€ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¿ƒå£°èƒŒæ™¯çš„è§’è‰²æ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
if (typeof chat.innerVoiceBackground === 'undefined') {
    chat.innerVoiceBackground = '';
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡æ–°å¢çš„å…¼å®¹æ€§ä»£ç ï¼ â˜…â˜…â˜…
if (chat.settings && typeof chat.settings.innerVoiceAdopterLabelFormat === 'undefined') {
    chat.settings.innerVoiceAdopterLabelFormat = 'é¢†å…»äºº: {{user}}';
}
// â˜…â˜…â˜… æ–°å¢ç»“æŸ â˜…â˜…â˜…
        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ï¼šæ•°æ®è¿ç§»è„šæœ¬ã€‘â˜…â˜…â˜…
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠï¼Œå¹¶ä¸”å…¶æˆå‘˜å¯¹è±¡ä½¿ç”¨çš„æ˜¯æ—§çš„ `name` ç»“æ„
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            console.log(`æ£€æµ‹åˆ°æ—§ç‰ˆç¾¤èŠæ•°æ® for "${chat.name}"ï¼Œæ­£åœ¨æ‰§è¡Œè¿ç§»...`);
            chat.members.forEach(member => {
                // å¦‚æœè¿™ä¸ªæˆå‘˜å¯¹è±¡æ²¡æœ‰ originalNameï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name; // å°†æ—§çš„ name ä½œä¸º originalName
                    member.groupNickname = member.name; // åŒæ—¶åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ groupNickname
                    delete member.name; // åˆ é™¤æ—§çš„ã€æœ‰æ­§ä¹‰çš„ name å­—æ®µ
                    needsUpdate = true; // æ ‡è®°éœ€è¦å­˜å›æ•°æ®åº“
                }
            });
             console.log(`è¿ç§»å®Œæˆ for "${chat.name}"`);
        }

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ ---
        // æ£€æŸ¥1ï¼šå¦‚æœæ˜¯ä¸€ä¸ªå•èŠï¼Œå¹¶ä¸”æ²¡æœ‰ status å±æ€§
        if (!chat.isGroup && !chat.status) {
            // å°±ä¸ºå®ƒè¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„ status å¯¹è±¡
            chat.status = {
                text: 'åœ¨çº¿',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†statuså±æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ ---
        // æ£€æŸ¥2ï¼šå…¼å®¹æœ€æ–°çš„â€œå…³ç³»â€åŠŸèƒ½
        if (!chat.isGroup && !chat.relationship) {
            // å¦‚æœæ˜¯å•èŠï¼Œä¸”æ²¡æœ‰ relationship å¯¹è±¡ï¼Œå°±è¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† relationship å±æ€§ã€‚`);
        }
        // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ  â–¼â–¼â–¼
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
        chat.settings.aiAvatarLibrary = [];
        console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†aiAvatarLibraryå±æ€§ã€‚`);
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰æ€»ç»“è®¾ç½®çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
if (!chat.settings.summary) {
    chat.settings.summary = {
        enabled: false,
        mode: 'auto',
        count: 20,
        prompt: 'è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚',
        lastSummaryIndex: -1 // -1è¡¨ç¤ºä»æœªæ€»ç»“è¿‡
    };
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰NPCåº“çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„NPCåº“
    if (!chat.isGroup && !chat.npcLibrary) {
        chat.npcLibrary = [];
        console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† npcLibrary å±æ€§ã€‚`);
    }
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¾®åšè®¾ç½®çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè®¾ç½®
if (!chat.isGroup && (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')) {
    chat.settings.weiboProfession = '';
    chat.settings.weiboInstruction = '';
    console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†å¾®åšè®¾ç½®å±æ€§ã€‚`);
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }

    // å…¼å®¹æ—§æ•°æ®ï¼Œä¸ºæ²¡æœ‰ isPinned å±æ€§çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
    if (typeof chat.isPinned === 'undefined') {
        chat.isPinned = false;
    }

// â–¼â–¼â–¼ ã€V2æœ€ç»ˆä¿®å¤ç‰ˆã€‘ç»Ÿä¸€ä¿®å¤å¹¶åˆå§‹åŒ–æ‰€æœ‰è§’è‰²çš„æ‰‹æœºæ•°æ® â–¼â–¼â–¼
if (!chat.isGroup) {
    // ç¬¬ä¸€æ­¥ï¼šç¡®ä¿æœ€å¤–å±‚çš„ characterPhoneData å¯¹è±¡å­˜åœ¨
    if (!chat.characterPhoneData) {
        chat.characterPhoneData = {}; // å¦‚æœä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºçš„
    }

    // ç¬¬äºŒæ­¥ï¼šé€ä¸€æ£€æŸ¥å¹¶è¡¥å…¨æ‰€æœ‰APPçš„æ•°æ®ç»“æ„
    // è¿™æ ·æ— è®ºè§’è‰²å¤šè€ï¼Œéƒ½èƒ½ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨
    if (!chat.characterPhoneData.widgets) chat.characterPhoneData.widgets = {};
    if (!chat.characterPhoneData.lastGenerated) chat.characterPhoneData.lastGenerated = null;
    if (!chat.characterPhoneData.chats) chat.characterPhoneData.chats = {};
    if (!chat.characterPhoneData.shoppingCart) chat.characterPhoneData.shoppingCart = [];
    if (!chat.characterPhoneData.memos) chat.characterPhoneData.memos = [];
    if (!chat.characterPhoneData.browserHistory) chat.characterPhoneData.browserHistory = [];
    if (!chat.characterPhoneData.photoAlbum) chat.characterPhoneData.photoAlbum = [];
    if (!chat.characterPhoneData.bank) chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    if (!chat.characterPhoneData.trajectory) chat.characterPhoneData.trajectory = [];
    if (!chat.characterPhoneData.appUsage) chat.characterPhoneData.appUsage = [];
    if (!chat.characterPhoneData.diary) chat.characterPhoneData.diary = []; // æ ¸å¿ƒä¿®å¤ï¼
     if (!chat.characterPhoneData.appWallpaper) {
        chat.characterPhoneData.appWallpaper = '';
    }
}
// â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²
// å…¼å®¹æ—§æ•°æ®ï¼Œä¸ºæ²¡æœ‰åå°æ´»åŠ¨è®¾ç½®çš„ç¾¤èŠæ·»åŠ é»˜è®¤å€¼
if (chat.isGroup && (!chat.settings || typeof chat.settings.backgroundActivity === 'undefined')) {
    if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
    chat.settings.backgroundActivity = {
        enabled: false,
        interval: 120, // é»˜è®¤120ç§’
        lastActivityTimestamp: 0
    };
}
// â–¼â–¼â–¼ Part B: åœ¨è¿™é‡Œç²˜è´´å…¼å®¹æ—§æ•°æ®çš„ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰æƒ…ä¾£å¤´åƒè®¾ç½®çš„è§’è‰²æ·»åŠ é»˜è®¤å€¼
if (typeof chat.settings.isCoupleAvatar === 'undefined') {
    chat.settings.isCoupleAvatar = false;
    chat.settings.coupleAvatarDescription = '';
}
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€é¢†å…»ç³»ç»Ÿæ”¹é€ ã€‘å® ç‰©ç³»ç»Ÿåˆå§‹åŒ–/å…¼å®¹ä»£ç  â–¼â–¼â–¼

// 1. ä¸ºæ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬æ–°æ—§æ•°æ®ï¼‰ç¡®ä¿æœ‰ petAdopted æ ‡å¿—
if (!chat.isGroup && typeof chat.settings.petAdopted === 'undefined') {
    // å¦‚æœ pet å¯¹è±¡å·²å­˜åœ¨ï¼Œè¯´æ˜æ˜¯è€ç”¨æˆ·ï¼Œé»˜è®¤å·²é¢†å…»
    if (chat.settings.pet && chat.settings.pet.type !== 'æ— ') {
        chat.settings.petAdopted = true;
    } else {
        // å¦‚æœæ²¡æœ‰ pet å¯¹è±¡ï¼Œè¯´æ˜æ˜¯æ–°ç”¨æˆ·æˆ–ä¹‹å‰å°±æ²¡ç”¨å® ç‰©ï¼Œé»˜è®¤æœªé¢†å…»
        chat.settings.petAdopted = false;
    }
    console.log(`ä¸ºè§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å® ç‰©é¢†å…»çŠ¶æ€: ${chat.settings.petAdopted}`);
}

// 2. å…¼å®¹æ—§çš„ pet å¯¹è±¡ï¼Œç¡®ä¿æ–°å­—æ®µå­˜åœ¨ï¼ˆè¿™æ®µä»£ç å’Œä¹‹å‰ä¸€æ ·ï¼Œä¿ç•™å³å¯ï¼‰
if (!chat.isGroup && chat.settings.pet) {
    if (typeof chat.settings.pet.persona === 'undefined') {
        chat.settings.pet.persona = 'ä¸€åªå¯çˆ±çš„å°å® ç‰©ï¼Œå¯¹ä¸–ç•Œå……æ»¡å¥½å¥‡ã€‚';
    }
    if (!chat.settings.pet.petChatHistory) {
        chat.settings.pet.petChatHistory = [];
    }
    if (!chat.settings.pet.status) {
        chat.settings.pet.status = { 
            hunger: 100, 
            happiness: 100, 
            intimacyToUser: 50, 
            intimacyToChar: 50,
            lastUpdated: Date.now()
        };
    } else {
        if (typeof chat.settings.pet.status.intimacyToUser === 'undefined') chat.settings.pet.status.intimacyToUser = 50;
        if (typeof chat.settings.pet.status.intimacyToChar === 'undefined') chat.settings.pet.status.intimacyToChar = 50;
        if (typeof chat.settings.pet.status.lastUpdated === 'undefined') chat.settings.pet.status.lastUpdated = Date.now();
    }
}
// â–²â–²â–² æ”¹é€ ç»“æŸ â–²â–²â–²
        // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰è®°å¿†äº’é€šè®¾ç½®çš„èŠå¤©æ·»åŠ ä¸€ä¸ªç©ºçš„æ•°ç»„
        if (!chat.settings.linkedMemories) {
            chat.settings.linkedMemories = [];
        }
            // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢è¿™æ®µä»£ç ï¼Œä»¥å…¼å®¹æ—§æ•°æ® â–¼â–¼â–¼
    // ä¸ºæ—§æ•°æ®æ·»åŠ é»˜è®¤çš„è®°å¿†æ¡æ•°è®¾ç½®
    if (typeof chat.settings.linkMemoryDepth === 'undefined') {
        chat.settings.linkMemoryDepth = 5;
    }
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
              // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
        // å…¼å®¹çº¿ä¸‹æ¨¡å¼è®¾ç½®
        if (!chat.settings.offlineMode) {
            chat.settings.offlineMode = {
                enabled: false,
                prompt: '',
                style: '',
                wordCount: 300,
                presets: []
            };
        }
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²  
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œæ·»åŠ å¯¹è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®çš„å…¼å®¹ä»£ç  â–¼â–¼â–¼
        if (!chat.isGroup) { // åªä¸ºå•èŠè§’è‰²æ·»åŠ 
            if (!chat.characterPhoneData) {
                chat.characterPhoneData = {}; // ä»¥é˜²ä¸‡ä¸€è¿ characterPhoneData éƒ½æ²¡æœ‰
            }
            if (!chat.characterPhoneData.wallpaper) {
                chat.characterPhoneData.wallpaper = ''; // åˆå§‹åŒ–å£çº¸ä¸ºç©º
            }
            if (!chat.characterPhoneData.appIcons) {
                chat.characterPhoneData.appIcons = {}; // åˆå§‹åŒ–Appå›¾æ ‡ä¸ºç©ºå¯¹è±¡
            }
        }
        // â–²â–²â–² å…¼å®¹ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²
        // ã€å…¨æ–°ã€‘ä¸ºæ—§è§’è‰²æ•°æ®å…¼å®¹å¾®åšç‹¬ç«‹è®¾ç½®
if (!chat.isGroup) {
    if (!chat.settings.weiboNickname) {
        chat.settings.weiboNickname = chat.name; // é»˜è®¤ä½¿ç”¨è§’è‰²åä½œä¸ºå¾®åšæ˜µç§°
    }
    if (!chat.settings.weiboAvatar) {
        chat.settings.weiboAvatar = chat.settings.aiAvatar; // é»˜è®¤ä½¿ç”¨AIå¤´åƒ
    }
    if (!chat.settings.weiboAvatarFrame) {
        chat.settings.weiboAvatarFrame = chat.settings.aiAvatarFrame || ''; // é»˜è®¤ä½¿ç”¨AIå¤´åƒæ¡†
    }
    if (!chat.settings.weiboBackground) {
        chat.settings.weiboBackground = 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg'; // ç»™ä¸€ä¸ªé»˜è®¤èƒŒæ™¯
    }
    // weiboProfession å’Œ weiboInstruction ä¹‹å‰å·²ç»å…¼å®¹è¿‡äº†ï¼Œè¿™é‡Œä¸ç”¨é‡å¤
}
        // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¾®åšè®¾ç½®çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè®¾ç½®
        if (!chat.isGroup && (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')) {
            chat.settings.weiboProfession = '';
            chat.settings.weiboInstruction = '';
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†å¾®åšè®¾ç½®å±æ€§ã€‚`);
        }
        
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
        // ã€å…¨æ–°ã€‘ä¸ºæ—§è§’è‰²æ•°æ®å…¼å®¹å¾®åšç²‰ä¸/å…³æ³¨æ•°
        if (!chat.isGroup && (typeof chat.settings.weiboFansCount === 'undefined' || typeof chat.settings.weiboFollowingCount === 'undefined')) {
            const initialStats = getInitialWeiboStats(chat);
            chat.settings.weiboFansCount = initialStats.fans;
            chat.settings.weiboFollowingCount = initialStats.following;
            console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å¾®åšæ•°æ®ã€‚`);
        }
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨è¿™ä¸ªå¾ªç¯çš„æœ«å°¾ï¼Œacc[chat.id] = chat; ä¹‹å‰ï¼Œæ·»åŠ ä¸‹é¢è¿™æ®µä»£ç  â–¼â–¼â–¼
    if (!chat.isGroup && (!chat.settings || typeof chat.settings.minimaxVoiceId === 'undefined')) {
        if (!chat.settings) chat.settings = {};
        chat.settings.minimaxVoiceId = ''; // é»˜è®¤ä¸ºç©º
        console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† minimaxVoiceId å±æ€§ã€‚`);
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„â€œç«èŠ±â€å…¼å®¹ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰ç«èŠ±è®¾ç½®çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
if (!chat.settings.streak) {
    chat.settings.streak = {
        enabled: false,
        initialDays: 0,           // ã€æ–°ã€‘ç”¨æˆ·å¡«å†™çš„åˆå§‹å¤©æ•°
        currentDays: 0,           // å½“å‰çš„ç«èŠ±å¤©æ•°
        extinguishThreshold: 1,   // ã€æ–°ã€‘ç†„ç­é˜ˆå€¼ï¼Œé»˜è®¤1å¤©
        lastInteractionDate: null // ä¸Šæ¬¡äº’åŠ¨æ—¥æœŸ
    };
    console.log(`ä¸ºè§’è‰² "${chat.name}" è¡¥å…¨äº†å¢å¼ºç‰ˆç«èŠ±(streak)è®¾ç½®ã€‚`);
} else if (typeof chat.settings.streak.extinguishThreshold === 'undefined') {
    // å…¼å®¹ä½ ä¸Šä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸ºå®ƒä»¬ä¹ŸåŠ ä¸Šç†„ç­é˜ˆå€¼
    chat.settings.streak.extinguishThreshold = 1; 
    console.log(`ä¸ºè§’è‰² "${chat.name}" çš„æ—§ç«èŠ±è®¾ç½®æ·»åŠ äº†ç†„ç­é˜ˆå€¼ã€‚`);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// å…¼å®¹æ—§çš„ç¾¤èŠæ•°æ®ï¼Œä¸ºå®ƒä»¬æ·»åŠ ç¾¤ä¸»ã€ç®¡ç†å‘˜å’Œå¤´è¡”å±æ€§
if (chat.isGroup) {
  if (typeof chat.settings.groupAnnouncement === 'undefined') {
    chat.settings.groupAnnouncement = '';
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // å¦‚æœæ²¡æœ‰ownerIdï¼Œåˆ™é»˜è®¤åˆ›å»ºè€…ï¼ˆä¹Ÿå°±æ˜¯ä½ ï¼‰ä¸ºç¾¤ä¸»
    if (!chat.ownerId) {
        chat.ownerId = 'user'; // æˆ‘ä»¬å‡è®¾ç”¨æˆ·çš„IDä¸º 'user'
    }
    // éå†æ‰€æœ‰æˆå‘˜ï¼Œä¸ºä»–ä»¬æ·»åŠ æ–°å±æ€§
    if (chat.members && Array.isArray(chat.members)) {
        chat.members.forEach(member => {
            if (typeof member.isAdmin === 'undefined') {
                member.isAdmin = false; // é»˜è®¤ä¸æ˜¯ç®¡ç†å‘˜
            }
            if (typeof member.groupTitle === 'undefined') {
                member.groupTitle = ''; // é»˜è®¤æ²¡æœ‰å¤´è¡”
            }
        });
    }
    // ã€æ–°å¢ã€‘ä¸ºç”¨æˆ·è‡ªå·±ä¹Ÿæ·»åŠ ç®¡ç†å‘˜å’Œå¤´è¡”çš„é»˜è®¤å±æ€§
    if (chat.settings) {
        if (typeof chat.settings.isUserAdmin === 'undefined') {
            chat.settings.isUserAdmin = false;
        }
        if (typeof chat.settings.myGroupTitle === 'undefined') {
            chat.settings.myGroupTitle = '';
        }
    }
}

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// åœ¨ loadAllDataFromDB å‡½æ•°çš„ forEach å¾ªç¯å†…ï¼Œacc[chat.id] = chat; ä¹‹å‰æ·»åŠ ï¼š

// ã€å…¨æ–°ã€‘ä¸ºæ—§æ•°æ®å…¼å®¹å¿ƒå£°é¢æ¿æ ·å¼è®¾ç½®
if (!chat.settings.innerVoiceStyles) {
    chat.settings.innerVoiceStyles = {
        clothingColor: '#f0a1a8',
        behaviorColor: '#81c784',
        thoughtsColor: '#64b5f6',
        naughtyColor: '#ba68c8',
        cardBgColor: '#ffffff',
        cardOpacity: 0.7
    };
}
// ä¸ºæ—§æ•°æ®å…¼å®¹å›¾æ ‡é¢œè‰²è®¾ç½®
if (chat.settings.innerVoiceStyles && typeof chat.settings.innerVoiceStyles.iconColor === 'undefined') {
    chat.settings.innerVoiceStyles.iconColor = '#ff8a80'; // é»˜è®¤ç²‰çº¢è‰²
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        acc[chat.id] = chat;
        return acc;
    }, {});
// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„ state.apiConfig åˆå§‹åŒ–ä»£ç  â–¼â–¼â–¼
    state.apiConfig = apiConfig || { 
        id: 'main', 
        proxyUrl: '', 
        apiKey: '', 
        model: '',
        temperature: 0.8, // æ–°å¢ï¼šä¸ºæ¸©åº¦è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ 0.8
        minimaxGroupId: '',
        minimaxApiKey: '',
        minimaxSpeechModel: 'speech-01' 
    };
    // å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœåŠ è½½çš„è®¾ç½®é‡Œæ²¡æœ‰æ¸©åº¦ï¼Œä¹Ÿç»™ä¸€ä¸ªé»˜è®¤å€¼
    if (typeof state.apiConfig.temperature === 'undefined') {
        state.apiConfig.temperature = 0.8;
    }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ æ­¥éª¤ 3.1ï¼šåœ¨ loadAllDataFromDB å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°å¹¶ã€æ›¿æ¢ã€‘è¿™è¡Œä»£ç  â–¼â–¼â–¼

state.globalSettings = globalSettings || { 
    id: 'main', 
    ringtoneUrl: 'https://files.catbox.moe/3w7gla.mp3',
    notificationSoundUrl: 'https://files.catbox.moe/k369mf.mp3', // <-- åœ¨è¿™é‡Œæ–°å¢è¿™ä¸€è¡Œ
    widgetData: {}, 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    lockscreenWallpaper: 'linear-gradient(135deg, #764ba2, #667eea)',
    password: '',
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS },
    appLabels: {},
    ringtoneUrl: 'https://files.catbox.moe/3w7gla.mp3',
    notificationSoundUrl: 'https://files.catbox.moe/k369mf.mp3', 
    widgetData: {}, // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾ä½ çš„è‡ªå®šä¹‰å†…å®¹
// åœ¨ state.globalSettings çš„åˆå§‹åŒ–å¯¹è±¡é‡Œæ·»åŠ ï¼š
homeAvatarFrame: '', // ä¸ºä¸»å±å¹•å¤´åƒæ¡†æ·»åŠ é»˜è®¤ç©ºå€¼

    globalChatBackground: '',
    homeIconWidgetTextColor: '#FFFFFF', // <-- ä¿®æ”¹è¿™é‡Œçš„åå­—
    userBalance: 520,
  // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
    homeAvatarFrame: '' // ä¸ºä¸»å±å¹•å¤´åƒæ¡†æ·»åŠ é»˜è®¤ç©ºå€¼
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
};
// ç¡®ä¿å³ä½¿ä»æ—§æ•°æ®åº“åŠ è½½ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿå­˜åœ¨
if (!state.globalSettings.widgetData) {
    state.globalSettings.widgetData = {};
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ®µæ–°ä»£ç  (æˆ–è€…ä¿®æ”¹ä½ å·²æœ‰çš„) â–¼â–¼â–¼
if (!state.globalSettings.homeIconWidgetTextColor) { // <-- ä¿®æ”¹è¿™é‡Œçš„åå­—
    state.globalSettings.homeIconWidgetTextColor = '#FFFFFF';
}
// ã€å…¨æ–°ã€‘å…¼å®¹å­—ä½“é˜´å½±è®¾ç½®
if (typeof state.globalSettings.removeHomeFontShadow === 'undefined') {
    state.globalSettings.removeHomeFontShadow = false;
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„å…¼å®¹æ€§ä»£ç  â–¼â–¼â–¼
// å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœåŠ è½½çš„è®¾ç½®é‡Œæ²¡æœ‰appLabelsï¼Œå°±ç»™å®ƒä¸€ä¸ªç©ºå¯¹è±¡
if (!state.globalSettings.appLabels) {
    state.globalSettings.appLabels = {};
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åŠ è½½æ­Œè¯æ è®¾ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
    lyricsBarSettings = state.globalSettings.lyricsBarSettings || lyricsBarSettings;
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆå¹¶å·²ä¿å­˜çš„å›¾æ ‡å’Œé»˜è®¤å›¾æ ‡ï¼Œé˜²æ­¢æ›´æ–°åæ—§æ•°æ®ä¸¢å¤±æ–°å›¾æ ‡
state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    userStickerCategories = localUserStickerCategories || []; 
    state.charStickers = charStickers || []; 
    state.worldBooks = worldBooks || [];
    currentDatingScenes = datingScenes || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
state.apiPresets = apiPresets || [];
state.bubbleStylePresets = bubbleStylePresets || [];
// â–¼â–¼â–¼ åœ¨ loadAllDataFromDB å‡½æ•°é‡Œï¼Œç”¨ä¸‹é¢è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ qzoneSettings åˆå§‹åŒ–ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å¸¦æœ‰å¾®åšç”¨æˆ·è®¾å®šã€‘çš„ä»£ç æ›¿æ¢ â–¼â–¼â–¼
state.qzoneSettings = qzoneSettings || { 
    id: 'main', 
    nickname: '{{user}}', 
    avatar: 'https://files.catbox.moe/q6z5fc.jpeg', 
    banner: 'https://files.catbox.moe/r5heyt.gif',
    weiboAvatar: 'https://files.catbox.moe/q6z5fc.jpeg',
    weiboNickname: 'ä½ çš„æ˜µç§°',
    weiboFansCount: '0',
    weiboBackground: 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg',
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡Œä¸ºå¾®åšç”¨æˆ·æ·»åŠ ä¸“å±çš„èŒä¸šå’Œäººè®¾å­—æ®µï¼
    weiboUserProfession: 'ç‚¹å‡»è®¾ç½®èŒä¸š', 
    weiboUserPersona: 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚',
    weiboUserPersonaPresets: []
};
// å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœåŠ è½½è¿›æ¥çš„æ•°æ®æ²¡æœ‰è¿™äº›æ–°å­—æ®µï¼Œå°±è¡¥ä¸Šé»˜è®¤å€¼
if (!state.qzoneSettings.weiboAvatar) state.qzoneSettings.weiboAvatar = state.qzoneSettings.avatar || 'https://files.catbox.moe/q6z5fc.jpeg';
if (!state.qzoneSettings.weiboNickname) state.qzoneSettings.weiboNickname = state.qzoneSettings.nickname || 'ä½ çš„æ˜µç§°';
if (!state.qzoneSettings.weiboFansCount) state.qzoneSettings.weiboFansCount = '0';
if (!state.qzoneSettings.weiboBackground) state.qzoneSettings.weiboBackground = 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg';
// ã€æ ¸å¿ƒæ–°å¢ã€‘å…¼å®¹æ—§çš„ç”¨æˆ·å¾®åšè®¾å®š
if (!state.qzoneSettings.weiboUserProfession) state.qzoneSettings.weiboUserProfession = 'ç‚¹å‡»è®¾ç½®èŒä¸š';
if (!state.qzoneSettings.weiboUserPersona) state.qzoneSettings.weiboUserPersona = 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚';
if (!state.qzoneSettings.weiboUserPersonaPresets) state.qzoneSettings.weiboUserPersonaPresets = [];
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
if (!state.qzoneSettings.weiboAvatarFrame) state.qzoneSettings.weiboAvatarFrame = '';
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ã€ç¡®ä¿è¿™ä¸€è¡Œåœ¨ Promise.all ä¹‹åï¼Œå¹¶ä½¿ç”¨è§£æ„èµ‹å€¼å¾—åˆ°çš„ initialFavoritesã€‘ â–¼â–¼â–¼
    allFavoriteItems = initialFavorites || [];
    // â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²

// åœ¨ loadAllDataFromDB å‡½æ•°æœ«å°¾ï¼Œinit(); è°ƒç”¨ä¹‹å‰æ·»åŠ 
if (typeof state.globalSettings.notificationSoundUrl === 'undefined') {
    state.globalSettings.notificationSoundUrl = 'https://files.catbox.moe/k369mf.mp3';
}


}

        // â–¼â–¼â–¼ ã€å…¨æ–° | æ”¯æŒä¸´æ—¶æ­Œæ›²ã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ saveGlobalPlaylist å‡½æ•° â–¼â–¼â–¼
async function saveGlobalPlaylist() {
    // 1. åœ¨ä¿å­˜å‰ï¼Œå…ˆä»å½“å‰æ’­æ”¾åˆ—è¡¨ä¸­è¿‡æ»¤æ‰æ‰€æœ‰è¢«æ ‡è®°ä¸º isTemporary çš„æ­Œæ›²
    const permanentPlaylist = musicState.playlist.filter(track => !track.isTemporary);
    
    // 2. åªå°†è¿™ä¸ªâ€œæ°¸ä¹…æ’­æ”¾åˆ—è¡¨â€ä¿å­˜åˆ°æ•°æ®åº“ä¸­
    await db.musicLibrary.put({ id: 'main', playlist: permanentPlaylist });
    console.log("å·²å°†æ°¸ä¹…æ’­æ”¾åˆ—è¡¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { playNotificationSound();clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

      // â–¼â–¼â–¼ æ­¥éª¤ 1.1ï¼šç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ updateClock å‡½æ•° â–¼â–¼â–¼
/* â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šå°†è¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ°æ‚¨çš„JSä»£ç çš„åŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼ */

/**
 * ã€å…¨æ–°æ·»åŠ ã€‘æ˜¾ç¤ºä¸€ä¸ªåŒ…å«å¤šä¸ªé€‰é¡¹çš„æ“ä½œèœå•æ¨¡æ€æ¡†
 * è¿™æ˜¯è®©å›¾ç‰‡ç¼–è¾‘æ—¶èƒ½å¤Ÿé€‰æ‹©â€œæœ¬åœ°ä¸Šä¼ â€æˆ–â€œURLâ€çš„å…³é”®å‡½æ•°ï¼
 * @param {string} title - æ¨¡æ€æ¡†çš„æ ‡é¢˜
 * @param {Array<object>} options - æŒ‰é’®é€‰é¡¹æ•°ç»„, e.g., [{ text: 'æŒ‰é’®æ–‡å­—', value: 'è¿”å›å€¼' }]
 * @returns {Promise<string|null>} - è¿”å›ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„valueï¼Œå¦‚æœå–æ¶ˆåˆ™è¿”å›null
 */
function showChoiceModal(title, options) {
    return new Promise(resolve => {
        // å¤ç”¨ä½ ç°æœ‰çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†
        const modal = document.getElementById('preset-actions-modal');
        const footer = modal.querySelector('.custom-modal-footer');
        
        // æ¸…ç©ºæ—§æŒ‰é’®å¹¶åŠ¨æ€åˆ›å»ºæ–°æŒ‰é’®
        footer.innerHTML = ''; 

        options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.onclick = () => {
                modal.classList.remove('visible');
                resolve(option.value); // è¿”å›è¢«ç‚¹å‡»æŒ‰é’®çš„å€¼
            };
            footer.appendChild(button);
        });

        // æ·»åŠ ä¸€ä¸ªæ ‡å‡†çš„å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.marginTop = '8px';
        cancelButton.style.borderRadius = '8px';
        cancelButton.style.backgroundColor = '#f0f0f0';
        cancelButton.onclick = () => {
            modal.classList.remove('visible');
            resolve(null); // ç”¨æˆ·å–æ¶ˆï¼Œè¿”å› null
        };
        footer.appendChild(cancelButton);

        modal.classList.add('visible');
    });
}
// â–¼â–¼â–¼ ã€æœ€ç»ˆæ­£ç¡®ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ deleteExpiredSearchedSongs å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°é‡æ„ã€‘æ£€æŸ¥å¹¶åˆ é™¤æ‰€æœ‰å¤±æ•ˆçš„APIæ­Œæ›²
 * æ ¸å¿ƒé€»è¾‘ï¼šä¸å†ä¾èµ–ä»»ä½•æ ‡ç­¾ï¼Œç›´æ¥æ ¹æ®é“¾æ¥ç‰¹å¾è¯†åˆ«éœ€è¦æ£€æŸ¥çš„æ­Œæ›²ã€‚
 */
async function deleteExpiredSearchedSongs() {
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ£€æŸ¥æ’­æ”¾åˆ—è¡¨ä¸­æ‰€æœ‰åœ¨çº¿æ­Œæ›²çš„æœ‰æ•ˆæ€§...");

    // 1. ã€æ ¸å¿ƒæ”¹å˜ã€‘æˆ‘ä»¬ä¸å†å¯»æ‰¾ isTemporary æ ‡ç­¾ï¼
    // è€Œæ˜¯ç›´æ¥æ‰¾å‡ºæ‰€æœ‰ src é“¾æ¥æ¥è‡ªäº API æœåŠ¡å™¨çš„æ­Œæ›²ã€‚
    // è¿™æ˜¯ä¸€ä¸ªç»å¯¹å¯é çš„è¯†åˆ«æ–¹æ³•ï¼Œæ— è®ºå®ƒæœ‰æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜ã€‚
    const songsToCheck = musicState.playlist.filter(track => track.src && track.src.includes('api.vkeys.cn'));

    if (songsToCheck.length === 0) {
        await showCustomAlert('æç¤º', 'æ’­æ”¾åˆ—è¡¨ä¸­æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„åœ¨çº¿æ­Œæ›²ã€‚');
        return;
    }

    const songsToDelete = [];
    const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);

    // 2. å¯¹æ¯ä¸€é¦–è¯†åˆ«å‡ºçš„æ­Œæ›²ï¼Œè¿›è¡Œä¸¥æ ¼çš„â€œä½“æ£€â€
    await Promise.all(songsToCheck.map(async (track) => {
        // æ¡ä»¶1ï¼šæ£€æŸ¥é“¾æ¥æœ¬èº«æ˜¯å¦å·²ç»å¤±æ•ˆï¼ˆæ— æ³•æ’­æ”¾ï¼‰
        const isUrlInvalid = !(await checkAudioAvailability(track.src));
        
        // æ¡ä»¶2ï¼šæ£€æŸ¥æ·»åŠ æ—¶é—´æ˜¯å¦è¶…è¿‡24å°æ—¶ï¼ˆä½œä¸ºåŒé‡ä¿é™©ï¼‰
        const isOlderThan24h = track.addedTimestamp && track.addedTimestamp < twentyFourHoursAgo;

        // åªè¦æ»¡è¶³ã€ä»»æ„ä¸€ä¸ªã€‘æ¡ä»¶ï¼Œå°±åˆ¤å®šä¸ºâ€œå¤±æ•ˆâ€
        if (isUrlInvalid || isOlderThan24h) {
            songsToDelete.push(track);
            console.log(`æ ‡è®°åˆ é™¤: ${track.name} (åŸå› : ${isUrlInvalid ? 'é“¾æ¥å¤±æ•ˆ' : ''} ${isOlderThan24h ? 'è¶…è¿‡24å°æ—¶' : ''})`);
        }
    }));

    // 3. æ ¹æ®æ£€æŸ¥ç»“æœè¿›è¡Œåé¦ˆå’Œæ“ä½œ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    if (songsToDelete.length === 0) {
        await showCustomAlert('æ£€æŸ¥å®Œæˆ', 'æ’­æ”¾åˆ—è¡¨ä¸­çš„æ‰€æœ‰åœ¨çº¿æ­Œæ›²å½“å‰å‡æœ‰æ•ˆã€‚');
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç†',
        `æ£€æµ‹åˆ° ${songsToDelete.length} é¦–å·²å¤±æ•ˆçš„åœ¨çº¿æ­Œæ›²ã€‚ç¡®å®šè¦å°†å®ƒä»¬ä»åˆ—è¡¨ä¸­ç§»é™¤å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    // æ‰§è¡Œåˆ é™¤...
    const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
    musicState.playlist = musicState.playlist.filter(track => !songsToDelete.includes(track));
    const newIndex = currentTrack ? musicState.playlist.findIndex(t => t.src === currentTrack.src && t.name === currentTrack.name) : -1;

    if (newIndex === -1) {
        if (musicState.isPlaying) {
            audioPlayer.pause();
            audioPlayer.src = '';
        }
        musicState.isPlaying = false;
        if (musicState.playlist.length > 0) {
            playSong(0); 
        } else {
            musicState.currentIndex = -1;
            updatePlayerUI();
        }
    } else {
        musicState.currentIndex = newIndex;
        updatePlayerUI();
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    await showCustomAlert('æ¸…ç†å®Œæˆ', `${songsToDelete.length} é¦–æ­Œæ›²å·²ä»åˆ—è¡¨ä¸­ç§»é™¤ã€‚`);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * ã€å·²ä¿®å¤ã€‘æ›´æ–°æ‰€æœ‰æ—¶é’Ÿï¼ˆçŠ¶æ€æ å’Œé”å±ï¼‰
 */
function updateClock() { 
    const now = new Date(); 
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); 
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); 
    
    // æ›´æ–°çŠ¶æ€æ æ—¶é’Ÿ (è¿™ä¸ªå…ƒç´ ä¸€ç›´å­˜åœ¨)
    const statusBarTime = document.getElementById('status-bar-time');
    if (statusBarTime) {
        statusBarTime.textContent = timeString; 
    }

    // æ›´æ–°é”å±æ—¶é’Ÿ (åªæœ‰å½“é”å±å…ƒç´ å­˜åœ¨æ—¶æ‰æ›´æ–°ï¼Œé¿å…æŠ¥é”™)
    const lockTime = document.getElementById('lock-main-time');
    const lockDate = document.getElementById('lock-main-date');
    if (lockTime) {
        lockTime.textContent = timeString;
    }
    if (lockDate) {
        lockDate.textContent = dateString;
    }
}



/**
 * ã€ç»ˆæå¥å£®ç‰ˆã€‘è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è§„èŒƒçš„å“åº”å†…å®¹
 * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
 * @returns {Array} - ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
 */
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    // æ–¹æ¡ˆ1ï¼šã€æœ€ä¼˜å…ˆã€‘å°è¯•ä½œä¸ºæ ‡å‡†çš„ã€å•ä¸€çš„JSONæ•°ç»„è§£æ
    // è¿™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…å†µ
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                console.log("è§£ææˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼ã€‚");
                return parsed;
            }
        } catch (e) {
            // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜å®ƒè™½ç„¶çœ‹èµ·æ¥åƒä¸ªæ•°ç»„ï¼Œä½†å†…éƒ¨æ ¼å¼æœ‰é—®é¢˜ã€‚
            // æ­¤æ—¶æˆ‘ä»¬ä¸æŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­å°è¯•ä¸‹é¢çš„â€œå¼ºåŠ›è§£æâ€æ–¹æ¡ˆã€‚
            console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
        }
    }

    // æ–¹æ¡ˆ2ï¼šã€å¼ºåŠ›è§£æã€‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»æ··ä¹±çš„å­—ç¬¦ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç‹¬ç«‹çš„JSONå¯¹è±¡
    // è¿™èƒ½å®Œç¾è§£å†³æ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" è¿™ç§æ ¼å¼
    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

    if (jsonMatches) {
        const results = [];
        for (const match of jsonMatches) {
            try {
                // å°è¯•è§£ææ¯ä¸€ä¸ªè¢«æˆ‘ä»¬â€œæªâ€å‡ºæ¥çš„JSONå­—ç¬¦ä¸²
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
            } catch (e) {
                // å¦‚æœæŸä¸ªç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
                console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
            }
        }

        // å¦‚æœæˆ‘ä»¬æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„JSONå¯¹è±¡ï¼Œå°±è¿”å›è¿™ä¸ªç»“æœ
        if (results.length > 0) {
            console.log("è§£ææˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå–æ¨¡å¼ã€‚");
            return results;
        }
    }
    
    // æ–¹æ¡ˆ3ï¼šã€æœ€ç»ˆå¤‡ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œè¯´æ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯çº¯æ–‡æœ¬
    // æˆ‘ä»¬å°†åŸå§‹çš„ã€æœªå¤„ç†çš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡è¿”å›ï¼Œç¡®ä¿ç¨‹åºä¸ä¼šå´©æºƒ
    console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
    return [{ type: 'text', content: content }];
}
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘â€œæ‹‰å–â€å¹¶å¡«å……Minimaxè¯­éŸ³æ¨¡å‹çš„ä¸‹æ‹‰æ¡†
 */
function fetchMinimaxSpeechModels() {
    const modelSelect = document.getElementById('minimax-speech-model-select');
    modelSelect.innerHTML = ''; // æ¸…ç©º

    // Minimaxå®˜æ–¹æä¾›çš„ä¸¤ä¸ªä¸»è¦æ¨¡å‹
    const models = ['speech-01', 'speech-02'];

    models.forEach(modelId => {
        const option = document.createElement('option');
        option.value = modelId;
        // ä¸ºæ¨¡å‹æ·»åŠ ç®€å•çš„ä¸­æ–‡æè¿°
        option.textContent = `${modelId} (${modelId === 'speech-02' ? 'é«˜æ¸…' : 'æ ‡å‡†'})`;
        modelSelect.appendChild(option);
    });

    // è‡ªåŠ¨é€‰ä¸­å½“å‰å·²ä¿å­˜çš„æ¨¡å‹
    modelSelect.value = state.apiConfig.minimaxSpeechModel || 'speech-01';

    alert('Minimax è¯­éŸ³æ¨¡å‹åˆ—è¡¨å·²åˆ·æ–°ï¼');
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

    function renderApiSettings() {
    // 1. æ›´æ–° API ç›¸å…³çš„è¾“å…¥æ¡†
    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åŠ è½½ Minimax è®¾ç½®
    document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
    document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
    document.getElementById('minimax-speech-model-select').value = state.apiConfig.minimaxSpeechModel || 'speech-01';
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
    // å¦‚æœä½ æœ‰æ¨¡å‹é€‰æ‹©ï¼Œä¹Ÿä¸€å¹¶æ›´æ–°
    if (document.getElementById('model-select')) {
        document.getElementById('model-select').value = state.apiConfig.model || 'gpt-4';
    }

    // 2. æ›´æ–°åå°æ´»åŠ¨ç›¸å…³çš„å¼€å…³å’Œè¾“å…¥æ¡†
    
    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®å¤çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
    // ä½¿ç”¨ !!state.globalSettings.enableBackgroundActivity è¿™ç§å†™æ³•ï¼Œ
    // ç¡®ä¿å½“è¿™ä¸ªè®¾ç½®è¿˜ä¸å­˜åœ¨æ—¶ (æ¯”å¦‚ç¬¬ä¸€æ¬¡æ‰“å¼€)ï¼Œå¼€å…³ä¹Ÿèƒ½æ­£ç¡®åœ°æ˜¾ç¤ºä¸º false (å…³é—­çŠ¶æ€)
    document.getElementById('background-activity-switch').checked = !!state.globalSettings.enableBackgroundActivity;
    // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;

    // 3. æ¸²æŸ“é¢„è®¾å’Œé¢‘ç‡çš„ä¸‹æ‹‰æ¡†
    renderApiPresetSelector();
    renderBackgroundFrequencySelector();
    // â–¼â–¼â–¼ å°†ä¸‹é¢è¿™æ•´å—ã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° renderApiSettings å‡½æ•°çš„æœ«å°¾ â–¼â–¼â–¼
    
    // ã€æ ¸å¿ƒæ–°å¢ã€‘æ¸²æŸ“æ¸©åº¦æ»‘å—çš„UI
    const tempSlider = document.getElementById('temperature-slider');
    const tempValueDisplay = document.getElementById('temperature-value');
    
    // ä» state ä¸­è¯»å–å·²ä¿å­˜çš„æ¸©åº¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼ 0.8
    const currentTemp = state.apiConfig.temperature || 0.8;
    tempSlider.value = currentTemp;
    tempValueDisplay.textContent = parseFloat(currentTemp).toFixed(1);

    // æ·»åŠ å®æ—¶æ›´æ–°æ˜¾ç¤ºå€¼çš„äº‹ä»¶
    tempSlider.addEventListener('input', () => {
        tempValueDisplay.textContent = parseFloat(tempSlider.value).toFixed(1);
    });
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™ä¸ªå®Œæ•´çš„å‡½æ•° â–¼â–¼â–¼
/**
 * æ¸²æŸ“åå°æ´»åŠ¨çš„è§’è‰²é€‰æ‹©å’Œé¢‘ç‡è®¾ç½®UI
 */
function renderBackgroundFrequencySelector() {
    const container = document.getElementById('background-activity-char-list');
    const detailsContainer = document.getElementById('background-activity-details');
    const masterSwitch = document.getElementById('background-activity-switch');

    // æ ¹æ®æ€»å¼€å…³çš„çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è®¾ç½®
    detailsContainer.style.display = masterSwitch.checked ? 'block' : 'none';
    
    container.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (singleChats.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">è¿˜æ²¡æœ‰å¯ä»¥è®¾ç½®çš„è§’è‰²</p>';
        return;
    }

    const config = state.globalSettings.backgroundActivityConfig || {};

    singleChats.forEach(chat => {
        const freq = config[chat.id] || 'none'; // è·å–å½“å‰è§’è‰²çš„é¢‘ç‡è®¾ç½®
        let badgeHtml = '';
        if (freq !== 'none') {
            const freqText = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' }[freq];
            badgeHtml = `<span class="char-freq-badge ${freq}">${freqText}</span>`;
        }

        const item = document.createElement('div');
        item.className = 'char-list-item';
        item.innerHTML = `
            <input type="checkbox" class="bg-char-checkbox" data-chat-id="${chat.id}">
            <span class="char-name">${chat.name}</span>
            ${badgeHtml}
        `;
        container.appendChild(item);
    });
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

        window.renderApiSettingsProxy = renderApiSettings;
// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°ä¿®æ­£ç‰ˆã€‘æ›¿æ¢æ—§çš„ renderChatList å‡½æ•° â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. è·å–æ‰€æœ‰èŠå¤©å’Œåˆ†ç»„æ•°æ®
    const allChats = Object.values(state.chats);
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
        return;
    }

    // 2. å°†èŠå¤©æ˜ç¡®åœ°åˆ†ä¸ºâ€œç½®é¡¶â€å’Œâ€œæœªç½®é¡¶â€ä¸¤ç»„
    const pinnedChats = allChats.filter(chat => chat.isPinned);
    const unpinnedChats = allChats.filter(chat => !chat.isPinned);

    // 3. å¯¹ç½®é¡¶çš„èŠå¤©ï¼Œä»…æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åº
    pinnedChats.sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));

    // 4. ã€ä¼˜å…ˆæ¸²æŸ“ã€‘æ‰€æœ‰ç½®é¡¶çš„èŠå¤©
    pinnedChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // 5. ã€æ¥ä¸‹æ¥å¤„ç†æœªç½®é¡¶çš„èŠå¤©ã€‘åº”ç”¨æ‚¨ä¹‹å‰çš„åˆ†ç»„é€»è¾‘
    // ä¸ºæ¯ä¸ªåˆ†ç»„æ‰¾åˆ°å…¶å†…éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ—¶é—´æˆ³ (åªåœ¨æœªç½®é¡¶èŠå¤©ä¸­æŸ¥æ‰¾)
    allGroups.forEach(group => {
        const latestChatInGroup = unpinnedChats
            .filter(chat => chat.groupId === group.id) // æ‰¾åˆ°å±äºè¿™ä¸ªç»„çš„èŠå¤©
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0))[0]; // æ’åºåå–ç¬¬ä¸€ä¸ª
        
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // æ ¹æ®åˆ†ç»„çš„æœ€æ–°æ—¶é—´æˆ³ï¼Œå¯¹åˆ†ç»„æœ¬èº«è¿›è¡Œæ’åº
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // 6. éå†æ’åºåçš„åˆ†ç»„ï¼Œæ¸²æŸ“å…¶ä¸­çš„ã€æœªç½®é¡¶ã€‘å¥½å‹
    allGroups.forEach(group => {
        const groupChats = unpinnedChats
            .filter(chat => !chat.isGroup && chat.groupId === group.id)
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
        
        if (groupChats.length === 0) return; // å¦‚æœè¿™ä¸ªåˆ†ç»„é‡Œæ²¡æœ‰æœªç½®é¡¶çš„å¥½å‹ï¼Œå°±è·³è¿‡

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸‹é¢è¿™ä¸¤è¡Œä»£ç é‡Œï¼Œæˆ‘å·²ç»åˆ é™¤äº† collapsed ç±»ï¼Œè¿™æ ·é»˜è®¤å°±æ˜¯å±•å¼€çš„äº†ï¼
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');

        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 7. æœ€åï¼Œæ¸²æŸ“æ‰€æœ‰ã€æœªç½®é¡¶ã€‘çš„ç¾¤èŠå’Œã€æœªåˆ†ç»„çš„ã€‘å¥½å‹
    const remainingChats = unpinnedChats
        .filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId))
        .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    remainingChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€V3 - Emojiå›¾æ ‡ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ createChatListItem å‡½æ•° â–¼â–¼â–¼
function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // --- æ¶ˆæ¯é¢„è§ˆçš„é€»è¾‘ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜) ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è¯·] ${chat.relationship.applicationReason || 'è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹'}</span>`;
    } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>`;
    } else if (chat.isGroup) {
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»ç»Ÿæ¶ˆæ¯] ${lastMsgObj.content}`; }
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }
    } else {
        const statusText = chat.status?.text || 'åœ¨çº¿';
        lastMsgDisplay = `[${statusText}]`;
    }

    const lastMsgTimestamp = lastMsgObj?.timestamp;
    const timeDisplay = formatChatListTimestamp(lastMsgTimestamp);
    
    const container = document.createElement('div');
    container.className = 'chat-list-item-swipe-container';
    container.dataset.chatId = chat.id;

    const content = document.createElement('div');
    content.className = `chat-list-item-content ${chat.isPinned ? 'pinned' : ''}`;
    
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;

    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    let streakHtml = '';
    // æ£€æŸ¥æ˜¯å¦ä¸ºå•èŠã€åŠŸèƒ½æ˜¯å¦å¼€å¯
    if (!chat.isGroup && chat.settings.streak && chat.settings.streak.enabled) {
        const streak = chat.settings.streak;
        
        let isExtinguished = false;
        if (streak.lastInteractionDate && streak.extinguishThreshold !== -1) {
            const lastDate = new Date(streak.lastInteractionDate);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0); 
            const daysDiff = (todayDate - lastDate) / (1000 * 3600 * 24);
            if (daysDiff >= streak.extinguishThreshold) {
                isExtinguished = true;
            }
        }
        
        // å‡†å¤‡å›¾æ ‡å’Œé¢œè‰²
        const litIconUrl = streak.litIconUrl;
        const extinguishedIconUrl = streak.extinguishedIconUrl;
        const fontColor = streak.fontColor || '#ff6f00'; // å¦‚æœæ²¡è®¾ç½®é¢œè‰²ï¼Œå°±ç”¨é»˜è®¤çš„æ©™è‰²

        let iconHtml = '';

        if (isExtinguished) {
            // å¦‚æœç†„ç­äº†ï¼Œä¼˜å…ˆç”¨è‡ªå®šä¹‰ç†„ç­å›¾ç‰‡ï¼Œå¦åˆ™ç”¨é»˜è®¤ Emoji
            iconHtml = extinguishedIconUrl 
                ? `<img src="${extinguishedIconUrl}" style="height: 1.2em; vertical-align: middle;">`
                : 'ğŸ§Š';
        } else if (streak.currentDays > 0) {
            // å¦‚æœåœ¨ç»­ï¼Œä¼˜å…ˆç”¨è‡ªå®šä¹‰ç‚¹äº®å›¾ç‰‡ï¼Œå¦åˆ™ç”¨é»˜è®¤ Emoji
            iconHtml = litIconUrl 
                ? `<img src="${litIconUrl}" style="height: 1.2em; vertical-align: middle;">`
                : 'ğŸ”¥';
        }

        // æ‹¼æ¥æœ€ç»ˆçš„HTML
        if (iconHtml) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªåˆ¤æ–­
            // å¦‚æœç«èŠ±å·²ç†„ç­ (isExtinguished ä¸º true)
            if (isExtinguished) {
                // å°±åªæ˜¾ç¤ºç†„ç­çš„å›¾æ ‡ï¼Œä¸æ˜¾ç¤ºå¤©æ•°
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}</span>`;
            } 
            // å¦‚æœæ˜¯æ°¸ä¸ç†„ç­æ¨¡å¼ï¼ˆå¹¶ä¸”æœªç†„ç­ï¼‰
            else if (streak.currentDays === -1 || streak.initialDays === -1) {
                 streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}âˆ</span>`;
            }
            // å…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆå³ï¼Œç«èŠ±æ˜¯ç‚¹äº®çš„ï¼‰
            else {
                // æ‰æ˜¾ç¤ºå›¾æ ‡å’Œå¤©æ•°
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}${streak.currentDays}</span>`;
            }
        }
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
    
    // åç»­çš„HTMLæ‹¼æ¥éƒ¨åˆ†ä¿æŒä¸å˜
    content.innerHTML = `
        <div class="chat-list-item" data-chat-id="${chat.id}">
            <img src="${avatar || defaultAvatar}" class="avatar">
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
                    ${streakHtml}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="chat-list-right-column">
                <div class="chat-list-time">${timeDisplay}</div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            </div>
        </div>
    `;
    
    // åç»­çš„æ‰€æœ‰ä»£ç éƒ½ä¿æŒä¸å˜...
    const actions = document.createElement('div');
    actions.className = 'swipe-actions';
    const pinButtonText = chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
    const pinButtonClass = chat.isPinned ? 'unpin' : 'pin';
    actions.innerHTML = `<button class="swipe-action-btn ${pinButtonClass}">${pinButtonText}</button><button class="swipe-action-btn delete">åˆ é™¤</button>`;
    
    container.appendChild(content);
    container.appendChild(actions);
    
    const unreadCount = chat.unreadCount || 0;
    const unreadEl = content.querySelector('.unread-count');
    if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        unreadEl.style.display = 'inline-flex';
    } else {
        unreadEl.style.display = 'none';
    }
    
    const infoEl = content.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }
    const avatarEl = content.querySelector('.avatar, .avatar-with-frame');
    if (avatarEl) {
         avatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, chat.name);
        });
    }

    return container;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å¸¦è¯Šæ–­åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderChatInterface å‡½æ•° â–¼â–¼â–¼
function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘Šå›¾æ ‡æ˜¾ç¤º/éšè—é€»è¾‘ â–¼â–¼â–¼
    const announcementBtn = document.getElementById('group-announcement-btn');
    if (chat.isGroup) {
        announcementBtn.style.display = 'inline-flex'; // åœ¨ç¾¤èŠä¸­æ˜¾ç¤º
    } else {
        announcementBtn.style.display = 'none'; // åœ¨å•èŠä¸­éšè—
    }
    // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'åœ¨çº¿';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // --- ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡ŒåŠ å…¥è¯Šæ–­é¢æ¿ã€‘ ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ä½ å·²å°†â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                    <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
                        - åå°æ´»åŠ¨æ€»å¼€å…³: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²å¼€å¯</span>' : '<span style="color: red;">å·²å…³é—­</span>'}<br>
                        - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: ${isSimulationRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">æœªè¿è¡Œ</span>'}<br>
                        - å½“å‰è§’è‰²çŠ¶æ€: <strong>${chat.relationship.status}</strong><br>
                        - éœ€è¦å†·é™(å°æ—¶): <strong>${cooldownHours}</strong><br>
                        - å†·é™æœŸæ˜¯å¦ç»“æŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (è¿˜å‰©çº¦ ${timeRemainingMinutes} åˆ†é’Ÿ)</span>`}<br>
                        - è§¦å‘æ¡ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¡è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¡è¶³</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
                `;
                // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
                    <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">â€œ${chat.name}â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
                `;
                break;

            // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¿®å¤å½“ä½ ç”³è¯·åï¼Œä½ çœ‹åˆ°çš„ç•Œé¢
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„èƒŒæ™¯è®¾ç½®é€»è¾‘ â–¼â–¼â–¼
const chatScreen = document.getElementById('chat-interface-screen');

// æ ¸å¿ƒé€»è¾‘ï¼šå•äººèƒŒæ™¯ä¼˜å…ˆäºå…¨å±€èƒŒæ™¯
const backgroundToApply = chat.settings.background || state.globalSettings.globalChatBackground;

if (backgroundToApply) {
    chatScreen.style.backgroundImage = `url(${backgroundToApply})`;
} else {
    chatScreen.style.backgroundImage = 'none';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
let lastMessageTimestamp = null;

initialMessages.forEach(msg => {
    if (msg.isHidden) return; // ã€æ–°å¢ã€‘è·³è¿‡éšè—æ¶ˆæ¯

    if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æˆ‘ä»¬æ–°çš„ç”Ÿæˆå™¨å‡½æ•°
        const dateStampEl = createDateStampElement(msg.timestamp);
        messagesContainer.insertBefore(dateStampEl, document.getElementById('typing-indicator'));
    }
    
    appendMessage(msg, chat, true);
    
    lastMessageTimestamp = msg.timestamp;
});
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
    renderChatPet();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªå®Œæ•´çš„ä»£ç å—ï¼Œç²˜è´´åˆ°è¢«åˆ é™¤çš„ä½ç½® â–¼â–¼â–¼

// 1. æ‰¾åˆ°å±å¹•ä¸Šå·²æœ‰çš„ã€æœ€è€çš„é‚£æ¡ã€çœŸå®æ¶ˆæ¯ã€‘çš„æ—¶é—´æˆ³
const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper:not(.date-stamp-wrapper)');
let subsequentMessageTimestamp = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : null;

// 2. ä»åå¾€å‰ï¼ˆä»æ–°åˆ°æ—§ï¼‰éå†æˆ‘ä»¬è¦æ–°åŠ è½½çš„æ¶ˆæ¯
messagesToPrepend.reverse().forEach(currentMsg => {
    // æ£€æŸ¥è¿™æ¡æ–°æ¶ˆæ¯å’Œå®ƒåé¢é‚£æ¡ï¼ˆå¯èƒ½æ˜¯å±å¹•ä¸Šå·²æœ‰çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆšåŠ è½½çš„ï¼‰æ¶ˆæ¯æ˜¯å¦è·¨å¤©
    if (subsequentMessageTimestamp && isNewDay(subsequentMessageTimestamp, currentMsg.timestamp)) {
        // å¦‚æœè·¨å¤©ï¼Œå°±ä¸ºåé¢é‚£æ¡â€œè¾ƒæ–°â€çš„æ¶ˆæ¯åˆ›å»ºä¸€ä¸ªæ—¥æœŸæˆ³
        const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
        messagesContainer.prepend(dateStampEl);
    }
    
    // æ­£å¸¸åœ°æŠŠå½“å‰è¿™æ¡æ–°æ¶ˆæ¯æ”¾åˆ°æœ€å‰é¢
    prependMessage(currentMsg, chat);
    
    // æ›´æ–°è¿½è¸ªå™¨ï¼Œä¸ºä¸‹ä¸€æ¬¡æ¯”è¾ƒåšå‡†å¤‡
    subsequentMessageTimestamp = currentMsg.timestamp;
});

// 3. ã€è¾¹ç•Œå¤„ç†ã€‘å¤„ç†æ‰€æœ‰æ–°åŠ è½½æ¶ˆæ¯çš„æœ€å‰é¢ï¼ˆä¹Ÿå°±æ˜¯æ•´ä¸ªèŠå¤©è®°å½•çš„æœ€è€ï¼‰çš„é‚£æ¡æ¶ˆæ¯
// å®ƒä¹Ÿéœ€è¦ä¸€ä¸ªæ—¥æœŸæˆ³
if (subsequentMessageTimestamp) {
    const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
    messagesContainer.prepend(dateStampEl);
}

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ renderWallpaperScreen å‡½æ•° â–¼â–¼â–¼
function renderWallpaperScreen() { 
    // é”å±å¼€å…³
    const lockScreenEnabled = localStorage.getItem('lockScreenEnabled') !== 'false';
    const toggle = document.getElementById('enable-lock-screen-toggle');
    if (toggle) {
        toggle.checked = lockScreenEnabled;
    }

    // ä¸»å±å¹•å­—ä½“é¢œè‰²
    document.getElementById('home-icon-widget-text-color-picker').value = state.globalSettings.homeIconWidgetTextColor || '#FFFFFF';
    
    // ä¸»å±å¹•å­—ä½“é˜´å½±å¼€å…³
    document.getElementById('remove-home-font-shadow-toggle').checked = !!state.globalSettings.removeHomeFontShadow;

    // ä¸»å±å¹•å£çº¸é¢„è§ˆ
    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; 
    }

    // é”å±å£çº¸é¢„è§ˆ
    const lockscreenPreview = document.getElementById('lockscreen-wallpaper-preview');
    const lockBg = newLockscreenWallpaperBase64 || state.globalSettings.lockscreenWallpaper;
    if (lockBg && lockBg.startsWith('data:image')) {
        lockscreenPreview.style.backgroundImage = `url(${lockBg})`;
        lockscreenPreview.textContent = '';
    } else if (lockBg) {
        lockscreenPreview.style.backgroundImage = lockBg;
        lockscreenPreview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²';
    }

    // å¯†ç è¾“å…¥æ¡†
    document.getElementById('password-set-input').value = state.globalSettings.password || '';

    // å…¨å±€èŠå¤©èƒŒæ™¯é¢„è§ˆ
    const globalBgPreview = document.getElementById('global-bg-preview');
    const globalBg = newGlobalBgBase64 || state.globalSettings.globalChatBackground;
    if (globalBg && globalBg.startsWith('data:image')) {
        globalBgPreview.style.backgroundImage = `url(${globalBg})`;
        globalBgPreview.textContent = '';
    } else if (globalBg) {
        globalBgPreview.style.background = globalBg;
        globalBgPreview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²';
    } else {
        globalBgPreview.style.backgroundImage = 'none';
        globalBgPreview.textContent = 'ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ';
    }
    
    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    // åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸‹é¢è¿™2è¡Œï¼Œç”¨æ¥åŠ è½½é“ƒå£°å’Œæç¤ºéŸ³
    document.getElementById('ringtone-url-input').value = state.globalSettings.ringtoneUrl || '';
    document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
    // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    // æ¸²æŸ“Appå›¾æ ‡å’Œåç§°è®¾ç½®
    renderIconSettings();
    renderAppNameSettings();
    
    // åŠ è½½é¢„è®¾ä¸‹æ‹‰æ¡†
    loadHomeScreenPresetsToDropdown(); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

async function renderWorldBookScreen() {
    const listEl = document.getElementById('world-book-list');
    listEl.innerHTML = '';

    // 1. åŒæ—¶è·å–æ‰€æœ‰ä¹¦ç±å’Œæ‰€æœ‰åˆ†ç±»
    const [books, categories] = await Promise.all([
        db.worldBooks.toArray(),
        db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books; // ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®æ˜¯åŒæ­¥çš„

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>';
        return;
    }

    // 2. å°†ä¹¦ç±æŒ‰ categoryId åˆ†ç»„
    const groupedBooks = books.reduce((acc, book) => {
        const key = book.categoryId || 'uncategorized';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(book);
        return acc;
    }, {});

    // 3. ä¼˜å…ˆæ¸²æŸ“å·²åˆ†ç±»çš„ä¹¦ç±
    categories.forEach(category => {
        const booksInCategory = groupedBooks[category.id];
        if (booksInCategory && booksInCategory.length > 0) {
            const groupContainer = createWorldBookGroup(category.name, booksInCategory);
            listEl.appendChild(groupContainer);
        }
    });

    // 4. æœ€åæ¸²æŸ“æœªåˆ†ç±»çš„ä¹¦ç±
    const uncategorizedBooks = groupedBooks['uncategorized'];
    if (uncategorizedBooks && uncategorizedBooks.length > 0) {
        const groupContainer = createWorldBookGroup('æœªåˆ†ç±»', uncategorizedBooks);
        listEl.appendChild(groupContainer);
    }
    
    // 5. ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.world-book-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªåˆ†ç±»çš„åˆ†ç»„DOM
 * @param {string} groupName - åˆ†ç±»åç§°
 * @param {Array} books - è¯¥åˆ†ç±»ä¸‹çš„ä¹¦ç±æ•°ç»„
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„åˆ†ç»„å®¹å™¨
 */
function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';
    
    groupContainer.innerHTML = `
        <div class="world-book-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">${groupName}</span>
        </div>
        <div class="world-book-group-content"></div>
    `;

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
    const headerEl = groupContainer.querySelector('.world-book-group-header');
    const contentEl = groupContainer.querySelector('.world-book-group-content');
    
    // é»˜è®¤ç»™å¤´éƒ¨å’Œå†…å®¹åŒºéƒ½åŠ ä¸Š collapsed ç±»
    headerEl.classList.add('collapsed');
    contentEl.classList.add('collapsed');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`;
        item.addEventListener('click', () => openWorldBookEditor(book.id));
        addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } });
        contentEl.appendChild(item); 
    });

    return groupContainer;
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

async function openWorldBookEditor(bookId) {
    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
        db.worldBooks.get(bookId),
        db.worldBookCategories.toArray()
    ]);
    if (!book) return;

    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;
    document.getElementById('world-book-content-input').value = book.content;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¡«å……åˆ†ç±»ä¸‹æ‹‰èœå•
    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>'; // é»˜è®¤é€‰é¡¹
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        if (book.categoryId === cat.id) {
            option.selected = true; // é€‰ä¸­å½“å‰åˆ†ç±»
        }
        selectEl.appendChild(option);
    });

    showScreen('world-book-editor-screen');
}

// â–¼â–¼â–¼ ä½¿ç”¨è¿™å—ã€é€‚é…æœªåˆ†ç±»ã€‘çš„æ–°ä»£ç æ›¿æ¢æ—§çš„ renderStickerPanel å‡½æ•° â–¼â–¼â–¼
function renderStickerPanel() {
    const grid = document.getElementById('sticker-grid');
    grid.innerHTML = '';
    
    let stickersToRender;

    // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°è¿™é‡Œçš„ç­›é€‰é€»è¾‘ â˜…
    if (activeStickerCategoryId === 'uncategorized') {
        // å¦‚æœæ˜¯â€œæœªåˆ†ç±»â€ï¼Œå°±ç­›é€‰å‡º categoryId ä¸å­˜åœ¨æˆ–ä¸ºç©ºçš„è¡¨æƒ…
        stickersToRender = state.userStickers.filter(sticker => !sticker.categoryId);
    } else {
        // å¦åˆ™ï¼ŒæŒ‰å…·ä½“çš„åˆ†ç±»IDç­›é€‰
        stickersToRender = state.userStickers.filter(sticker => sticker.categoryId === activeStickerCategoryId);
    }

    if (stickersToRender.length === 0) {
        // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»ï¼Œæ˜¾ç¤ºä¸åŒçš„æç¤ºè¯­
        let message;
        if (activeStickerCategoryId === 'uncategorized') {
            // å¦‚æœæ‰€æœ‰è¡¨æƒ…éƒ½æœ‰åˆ†ç±»äº†ï¼Œè¿™é‡Œä¹Ÿä¼šæ˜¯ç©ºçš„
            message = 'æ²¡æœ‰æœªåˆ†ç±»çš„è¡¨æƒ…å“¦~';
        } else {
            // å¦‚æœæ˜¯åœ¨æŸä¸ªå…·ä½“åˆ†ç±»ä¸‹ï¼Œä½†æ˜¯é‡Œé¢æ²¡è¡¨æƒ…
            message = 'è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰è¡¨æƒ…å“¦~';
        }
        // å¦‚æœæ•´ä¸ªè¡¨æƒ…åº“éƒ½æ˜¯ç©ºçš„ï¼Œç»™ä¸€ä¸ªåˆå§‹å¼•å¯¼
        if(state.userStickers.length === 0) {
             message = 'å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šä¼ â€æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼';
        }
        
        grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
    } else {
        stickersToRender.forEach(sticker => {
            // è¿™éƒ¨åˆ†æ˜¯ä½ åŸæ¥çš„æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜
            const itemContainer = document.createElement('div');
            itemContainer.className = 'sticker-item';
            
            const imageEl = document.createElement('div');
            imageEl.className = 'sticker-image';
            imageEl.style.backgroundImage = `url(${sticker.url})`;
            
            const nameEl = document.createElement('span');
            nameEl.className = 'sticker-name';
            nameEl.textContent = sticker.name;
            nameEl.title = sticker.name;
            
            if (isUserStickerSelectionMode) {
                imageEl.classList.add('in-selection-mode');
                if (selectedUserStickers.has(sticker.id)) {
                    imageEl.classList.add('selected');
                }
                itemContainer.addEventListener('click', () => {
                    imageEl.classList.toggle('selected');
                    if (selectedUserStickers.has(sticker.id)) {
                        selectedUserStickers.delete(sticker.id);
                    } else {
                        selectedUserStickers.add(sticker.id);
                    }
                    const deleteBtn = document.getElementById('delete-selected-user-stickers-btn');
                    deleteBtn.textContent = `åˆ é™¤å·²é€‰ (${selectedUserStickers.size})`;
                    deleteBtn.disabled = selectedUserStickers.size === 0;

                    const moveBtn = document.getElementById('move-selected-stickers-btn');
                    moveBtn.disabled = selectedUserStickers.size === 0;
                });
            } else {
                itemContainer.addEventListener('click', () => sendSticker(sticker));
                addLongPressListener(imageEl, () => {
                    const existingDeleteBtn = imageEl.querySelector('.delete-btn');
                    if (existingDeleteBtn) return;
                    
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.style.display = 'block';
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation();
                        const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                        if (confirmed) {
                            await db.userStickers.delete(sticker.id);
                            state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
                            renderStickerPanel();
                        }
                    };
                    imageEl.appendChild(deleteBtn);
                    const removeDeleteBtn = () => { if(deleteBtn) deleteBtn.remove(); imageEl.removeEventListener('mouseleave', removeDeleteBtn); };
                    imageEl.addEventListener('mouseleave', removeDeleteBtn);
                });
            }
            
            itemContainer.appendChild(imageEl);
            itemContainer.appendChild(nameEl);
            grid.appendChild(itemContainer);
        });
    }
    
    // æ¯æ¬¡æ¸²æŸ“è¡¨æƒ…åˆ—è¡¨åï¼Œéƒ½æ›´æ–°ä¸€æ¬¡åˆ†ç±»é¡µç­¾æ 
    renderStickerCategories();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * å¤„ç†æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ç”¨æˆ·è¡¨æƒ…
 */
async function handleBulkDeleteUserStickers() {
    if (selectedUserStickers.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedUserStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = Array.from(selectedUserStickers);
        await db.userStickers.bulkDelete(idsToDelete);
        
        state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));
        
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        toggleUserStickerSelectionMode();
        
        alert('é€‰ä¸­çš„è¡¨æƒ…å·²åˆ é™¤ã€‚');
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä»å¡ç‰‡ç‚¹å‡»åï¼Œæ‰“å¼€æƒ…ä¾£ç©ºé—´å¹¶è·³è½¬åˆ°æŒ‡å®šé¡µç­¾
 * @param {string} charId - è§’è‰²ID
 * @param {string} viewId - è¦è·³è½¬åˆ°çš„è§†å›¾ID (ä¾‹å¦‚ 'ls-diary-view')
 */
function openLoversSpaceFromCard(charId, viewId) {
    // 1. æ‰“å¼€æŒ‡å®šè§’è‰²çš„æƒ…ä¾£ç©ºé—´ä¸»ç•Œé¢
    openLoversSpace(charId);

    // 2. ç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œç¡®ä¿ç•Œé¢å·²æ¸²æŸ“
    setTimeout(() => {
        // 3. æ‰¾åˆ°å¯¹åº”çš„é¡µç­¾æŒ‰é’®å¹¶æ¨¡æ‹Ÿç‚¹å‡»å®ƒ
        const targetTab = document.querySelector(`.ls-tab-item[data-view='${viewId}']`);
        if (targetTab) {
            targetTab.click();
        }
    }, 100); // 100æ¯«ç§’çš„å»¶è¿Ÿé€šå¸¸è¶³å¤Ÿäº†
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ createMessageElement å‡½æ•° â–¼â–¼â–¼
function createMessageElement(msg, chat) {

    // â–¼â–¼â–¼ åœ¨å‡½æ•°æœ€å¼€å¤´ï¼Œæ·»åŠ è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
if (msg.type === 'recalled_message') {
    const wrapper = document.createElement('div');
    // 1. ã€æ ¸å¿ƒã€‘ç»™ wrapper ä¹ŸåŠ ä¸Š timestampï¼Œæ–¹ä¾¿äº‹ä»¶å§”æ‰˜æ—¶æŸ¥æ‰¾
    wrapper.className = 'message-wrapper system-pat';
    wrapper.dataset.timestamp = msg.timestamp; 

    const bubble = document.createElement('div');
    // 2. ã€æ ¸å¿ƒã€‘è®©è¿™ä¸ªå…ƒç´ åŒæ—¶æ‹¥æœ‰ .message-bubble å’Œ .recalled-message-placeholder ä¸¤ä¸ªclass
    //    è¿™æ ·å®ƒæ—¢èƒ½è¢«é€‰æ‹©ç³»ç»Ÿè¯†åˆ«ï¼Œåˆèƒ½ä¿æŒåŸæœ‰çš„å±…ä¸­ç°è‰²æ ·å¼
    bubble.className = 'message-bubble recalled-message-placeholder';
    // 3. ã€æ ¸å¿ƒã€‘æŠŠ timestamp æ”¾åœ¨ bubble ä¸Šï¼Œè¿™æ˜¯å¤šé€‰é€»è¾‘çš„å…³é”®
    bubble.dataset.timestamp = msg.timestamp; 
    bubble.textContent = msg.content;
    
    wrapper.appendChild(bubble);
    
    // 4. ã€æ ¸å¿ƒã€‘ä¸ºå®ƒè¡¥ä¸Šå’Œå…¶ä»–æ¶ˆæ¯ä¸€æ ·çš„æ ‡å‡†äº‹ä»¶ç›‘å¬å™¨
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(msg.timestamp);
        }
    });

    // 5. ã€é‡è¦ã€‘åœ¨ä¹‹å‰çš„â€œç‚¹å‡»æŸ¥çœ‹åŸæ–‡â€çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨äº†äº‹ä»¶å§”æ‰˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å•ç‹¬ä¸ºè¿™ä¸ªå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶äº†ã€‚
    //    init() å‡½æ•°ä¸­çš„é‚£ä¸ªäº‹ä»¶ç›‘å¬å™¨ä¼šå¤„ç†å®ƒã€‚
    
    return wrapper;
}
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ if (chat.isGroup) ä»£ç å— â–¼â–¼â–¼
if (chat.isGroup) { 
    const senderLine = document.createElement('div');
    senderLine.className = 'group-sender-line';
    
    const tagsContainer = document.createElement('div');
    tagsContainer.className = 'group-sender-tags';

    let senderDisplayName;

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
    if (isUser) {
        // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±
        senderDisplayName = chat.settings.myNickname || 'æˆ‘';
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¾¤ä¸»
        if (chat.ownerId === 'user') {
            const roleTag = document.createElement('span');
            roleTag.className = 'group-role-tag owner';
            roleTag.textContent = 'ç¾¤ä¸»';
            tagsContainer.appendChild(roleTag);
        } 
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«è®¾ä¸ºç®¡ç†å‘˜
        else if (chat.settings.isUserAdmin) {
            const roleTag = document.createElement('span');
            roleTag.className = 'group-role-tag admin';
            roleTag.textContent = 'ç®¡ç†å‘˜';
            tagsContainer.appendChild(roleTag);
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¤´è¡”
        if (chat.settings.myGroupTitle) {
            const titleTag = document.createElement('span');
            titleTag.className = 'group-title-tag';
            titleTag.textContent = chat.settings.myGroupTitle;
            tagsContainer.appendChild(titleTag);
        }
    } else {
        // å¦‚æœæ˜¯å…¶ä»–æˆå‘˜ (AI/NPC)ï¼Œè¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜
        const member = chat.members.find(m => m.originalName === msg.senderName);
        senderDisplayName = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå‘˜');
                // --- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ ---
        // ã€æ ¸å¿ƒæ–°å¢ã€‘å¦‚æœè¯¥æˆå‘˜è¢«ç¦è¨€äº†ï¼Œå°±æ·»åŠ ä¸€ä¸ªç¦è¨€æ ‡ç­¾
        if (member && member.isMuted) {
            const muteTag = document.createElement('span');
            muteTag.className = 'group-title-tag'; // å¤ç”¨å¤´è¡”æ ‡ç­¾çš„æ ·å¼
            muteTag.style.color = '#ff3b30'; // è®©å®ƒå˜æˆçº¢è‰²
            muteTag.style.backgroundColor = '#ffe5e5'; // æ·¡çº¢è‰²èƒŒæ™¯
            muteTag.textContent = 'ğŸš«å·²ç¦è¨€';
            tagsContainer.appendChild(muteTag);
        }
        // --- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        if (member && chat.ownerId === member.id) {
            const roleTag = document.createElement('span');
            roleTag.className = 'group-role-tag owner';
            roleTag.textContent = 'ç¾¤ä¸»';
            tagsContainer.appendChild(roleTag);
        } 
        else if (member && member.isAdmin) {
            const roleTag = document.createElement('span');
            roleTag.className = 'group-role-tag admin';
            roleTag.textContent = 'ç®¡ç†å‘˜';
            tagsContainer.appendChild(roleTag);
        }
        
        if (member && member.groupTitle) {
            const titleTag = document.createElement('span');
            titleTag.className = 'group-title-tag';
            titleTag.textContent = member.groupTitle;
            tagsContainer.appendChild(titleTag);
        }
    }
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    const senderNameSpan = document.createElement('span');
    senderNameSpan.className = 'sender-name';
    senderNameSpan.textContent = senderDisplayName;
    
    // ã€ç‹¬å®¶å®šåˆ¶ã€‘ä¿®å¤ç”¨æˆ·æ ‡ç­¾æ˜¾ç¤ºåœ¨å³è¾¹çš„é—®é¢˜
    if (isUser) {
        senderLine.appendChild(tagsContainer); // æ ‡ç­¾åœ¨å·¦
        senderLine.appendChild(senderNameSpan); // æ˜µç§°åœ¨å³
    } else {
        senderLine.appendChild(senderNameSpan); // æ˜µç§°åœ¨å·¦
        senderLine.appendChild(tagsContainer); // æ ‡ç­¾åœ¨å³
    }
    
    wrapper.appendChild(senderLine);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    // æ‰¾åˆ°ç¡®å®š avatarSrc çš„é‚£æ®µä»£ç 
    let avatarSrc, avatarFrameSrc = ''; // <--- å£°æ˜ä¸¤ä¸ªå˜é‡
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- è·å–â€œæˆ‘â€çš„å¤´åƒæ¡†
        } else {
            const member = chat.members.find(m => m.originalName === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : ''; // <--- è·å–æˆå‘˜çš„å¤´åƒæ¡†
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- è·å–â€œæˆ‘â€çš„å¤´åƒæ¡†
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || ''; // <--- è·å–AIçš„å¤´åƒæ¡†
        }
    }

    // â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ã€æ¡ä»¶æ¸²æŸ“é€»è¾‘ã€‘æ›¿æ¢ä½ 7.23ç‰ˆä¸­ç®€å•çš„ avatarHtml å£°æ˜ â–¼â–¼â–¼
    let avatarHtml;
    // å¦‚æœå­˜åœ¨å¤´åƒæ¡†URL
    if (avatarFrameSrc) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
    // å¦‚æœæ²¡æœ‰ï¼Œå°±ä½¿ç”¨æœ€ç®€å•çš„å¤´åƒç»“æ„
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°† onclick="openBrowser(...)" ç§»é™¤ï¼Œæˆ‘ä»¬å°†åœ¨JSä¸­åŠ¨æ€ç»‘å®šäº‹ä»¶
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'æ— æ ‡é¢˜'}</div>
                <div class="description">${msg.description || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'é“¾æ¥åˆ†äº«'}</span>
                </div>
            </div>
        `;
    }
// ... å…¶ä»– case ...
else if (msg.type === 'dating_summary_card') {
    bubble.classList.add('is-dating-summary');
    const payload = msg.payload;
    let cardClass = '';

    if (payload.ratingType === 'romantic') {
        cardClass = 'romantic';
    } else if (payload.ratingType === 'passionate') {
        cardClass = 'passionate';
    } else if (payload.ratingType === 'perfect') {
        cardClass = 'perfect';
    }

    // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘æˆ‘ä»¬ä¸å†å­˜å‚¨å¤æ‚çš„JSONå­—ç¬¦ä¸² â–¼â–¼â–¼
    contentHtml = `
        <div class="dating-summary-chat-card ${cardClass}" data-timestamp="${msg.timestamp}">
            <div class="rating">${payload.rating}</div>
            <div class="tip">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
        </div>
    `;
}
// ... å…¶ä»– case ...


    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
else if (msg.type === 'share_card') {
    bubble.classList.add('is-link-share'); // å¤ç”¨é“¾æ¥åˆ†äº«çš„å¡ç‰‡æ ·å¼
    // ã€æ ¸å¿ƒã€‘æŠŠæ—¶é—´æˆ³åŠ åˆ°å¡ç‰‡ä¸Šï¼Œæ–¹ä¾¿åé¢ç‚¹å‡»æ—¶è¯†åˆ«
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
            <div class="title">${msg.payload.title}</div>
            <div class="description">å…± ${msg.payload.sharedHistory.length} æ¡æ¶ˆæ¯</div>
            <div class="footer">
                <svg class="footer-icon" ...>...</svg> <!-- å¤ç”¨é“¾æ¥åˆ†äº«çš„å›¾æ ‡ -->
                <span>èŠå¤©è®°å½•</span>
            </div>
        </div>
    `;
}
// åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™å—ã€ç®€åŒ–ç‰ˆã€‘ä»£ç æ›¿æ¢æ—§çš„ 'borrow_money_request' é€»è¾‘ â–¼â–¼â–¼
else if (msg.type === 'borrow_money_request') {
    bubble.classList.add('is-borrow-request'); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
    const payload = msg.payload;
    // ç›´æ¥å°†å¡ç‰‡çš„HTMLèµ‹ç»™contentHtmlï¼Œä¸å†æ‹¼æ¥ä»»ä½•æ–‡æœ¬
    contentHtml = `
        <div class="borrow-card">
            <div class="borrow-header">
                å‘ <span>${payload.lenderName}</span> å€Ÿé’±
            </div>
            <div class="borrow-body">
                <p class="label">å€Ÿæ¬¾é‡‘é¢</p>
                <p class="amount">Â¥${payload.amount.toFixed(2)}</p>
                <p class="reason">
                    <strong>å€Ÿæ¬¾ç”¨é€”:</strong><br>
                    ${payload.reason}
                </p>
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



else if (msg.type === 'repost_forum_post') {
    bubble.classList.add('is-link-share'); // å¤ç”¨é“¾æ¥åˆ†äº«çš„æ ·å¼ï¼Œçœäº‹ï¼
    const postPayload = msg.payload;
    // ã€æ ¸å¿ƒã€‘æŠŠå¸–å­çš„IDå­˜åˆ°å¡ç‰‡çš„ data-post-id å±æ€§é‡Œï¼Œæ–¹ä¾¿ä»¥åç‚¹å‡»è·³è½¬
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-post-id="${postPayload.postId}">
            <div class="title">ã€å°ç»„å¸–å­ã€‘${postPayload.title}</div>
            <div class="description">${postPayload.content}</div>
            <div class="footer">
                <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12c0-5.25-4.25-9.5-9.5-9.5S2.5 6.75 2.5 12s4.25 9.5 9.5 9.5c.35 0 .69-.02 1.03-.06"></path><path d="M18.5 12.5c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3c.83 0 1.58-.34 2.12-.88"></path></svg>
                <span>æ¥è‡ªå°ç»„çš„åˆ†äº«</span>
            </div>
        </div>
    `;
}



// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ 'cart_share_request' é€»è¾‘ â–¼â–¼â–¼
else if (msg.type === 'cart_share_request') {
    bubble.classList.add('is-cart-share-request');
    const payload = msg.payload; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ç°åœ¨ç›´æ¥ä» payload å–æ•°æ®
    let statusText = 'ç­‰å¾…å¯¹æ–¹å¤„ç†...';
    let cardClass = '';

    if (payload.status === 'paid') {
        statusText = 'å¯¹æ–¹å·²ä¸ºä½ ä¹°å•';
        cardClass = 'paid';
    } else if (payload.status === 'rejected') {
        statusText = 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è¯·æ±‚';
        cardClass = 'rejected';
    }
    
    contentHtml = `
        <div class="cart-share-card ${cardClass}">
            <div class="cart-share-header">
                <div class="icon">ğŸ›’</div>
                <div class="title">è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚</div>
            </div>
            <div class="cart-share-body">
                <div class="label">å…± ${payload.itemCount} ä»¶å•†å“ï¼Œåˆè®¡</div>
                <div class="amount">Â¥${payload.totalPrice.toFixed(2)}</div>
                <div class="status-text">${statusText}</div>
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•°é‡Œï¼Œæ·»åŠ è¿™ä¸ªæ–°çš„ else if åˆ†æ”¯ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•°é‡Œï¼Œç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ gift_notification é€»è¾‘ â–¼â–¼â–¼

else if (msg.type === 'gift_notification') {
    bubble.classList.add('is-gift-notification'); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
    const payload = msg.payload;
    
    // ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ„å»ºå¡ç‰‡çš„å®Œæ•´HTMLå†…å®¹
    contentHtml = `
        <div class="gift-card">
            <div class="gift-card-header">
                <div class="icon">ğŸ</div>
                <!-- 1. æ¸…æ™°æŒ‡æ˜æ˜¯è°é€çš„ç¤¼ç‰© -->
                <div class="title">ä¸€ä»½æ¥è‡ª ${payload.senderName} çš„ç¤¼ç‰©</div>
            </div>
            <div class="gift-card-body">
                <p class="greeting">è¿™æ˜¯æˆ‘ä¸ºä½ æŒ‘é€‰çš„ç¤¼ç‰©ï¼Œå¸Œæœ›ä½ å–œæ¬¢ï¼</p>
                <!-- 2. æ¸…æ™°åˆ—å‡ºæœ‰ä»€ä¹ˆå•†å“ -->
                <div class="gift-card-items">
                    <strong>å•†å“åˆ—è¡¨:</strong><br>
                    ${payload.itemSummary.replace(/ã€/g, '<br>')} <!-- å°†é¡¿å·æ›¿æ¢ä¸ºæ¢è¡Œï¼Œè®©åˆ—è¡¨æ›´æ¸…æ™° -->
                </div>
                <!-- 3. æ¸…æ™°æ ‡æ˜æ€»é‡‘é¢ -->
                <div class="gift-card-footer">
                    å…± ${payload.itemCount} ä»¶ï¼Œåˆè®¡: <span class="total-price">Â¥${payload.totalPrice.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€SVGç”Ÿæˆç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ location 'else if' å— â–¼â–¼â–¼
else if (msg.type === 'location') {
    bubble.classList.add('is-location');
    
    const currentChat = state.chats[state.activeChatId] || Object.values(state.chats).find(c => c.history.some(h => h.timestamp === msg.timestamp));
    const myNickname = currentChat.settings.myNickname || 'æˆ‘';
    const aiNickname = currentChat.name;

    // --- SVG åŠ¨æ€ç”Ÿæˆ ---
    const trajectoryPoints = msg.trajectoryPoints || [];
    const hasTrajectory = trajectoryPoints.length > 0;
    
    // 1. å®šä¹‰SVGè·¯å¾„å’Œåæ ‡
    const pathData = "M 20 45 Q 115 10 210 45"; // ä¸€æ¡é¢„è®¾çš„ä¼˜ç¾æ›²çº¿
    const startPoint = { x: 20, y: 45 };
    const endPoint = { x: 210, y: 45 };

    // 2. ç”Ÿæˆèµ·ç‚¹å’Œç»ˆç‚¹çš„SVGå…ƒç´ 
    let pinsSvg = '';
    if (msg.userLocation) {
        pinsSvg += `<circle class="svg-pin user-pin" cx="${startPoint.x}" cy="${startPoint.y}" r="6" />`;
    }
    if (msg.aiLocation) {
        pinsSvg += `<circle class="svg-pin ai-pin" cx="${endPoint.x}" cy="${endPoint.y}" r="6" />`;
    }

    // 3. å¦‚æœæœ‰è½¨è¿¹ï¼Œç”Ÿæˆé€”ç»ç‚¹çš„SVGå…ƒç´ 
    let trajectorySvg = '';

if (hasTrajectory) {
    // --- â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä½¿ç”¨æµè§ˆå™¨APIç²¾ç¡®è®¡ç®—åæ ‡ â–¼â–¼â–¼ ---

    // 1. å®šä¹‰æˆ‘ä»¬çš„Så½¢æ›²çº¿è·¯å¾„æ•°æ® (ä¸å˜)
    const s_curve_pathData = "M 20 45 C 80 70, 150 20, 210 45";
    trajectorySvg += `<path class="svg-trajectory-path" d="${s_curve_pathData}" />`;

    // 2. ã€æ ¸å¿ƒã€‘åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªçœŸå®çš„SVGè·¯å¾„å…ƒç´ ï¼Œä»¥ä¾¿ä½¿ç”¨API
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', s_curve_pathData);
    
    // 3. è·å–è¿™æ¡è·¯å¾„çš„æ€»é•¿åº¦
    const totalPathLength = path.getTotalLength();
    
    const totalPoints = trajectoryPoints.length;
    trajectoryPoints.forEach((point, index) => {
        // 4. è®¡ç®—æ¯ä¸ªç‚¹åº”è¯¥åœ¨è·¯å¾„æ€»é•¿åº¦çš„å“ªä¸ªä½ç½®
        const progress = (index + 1) / (totalPoints + 1);
        const lengthOnPath = totalPathLength * progress;
        
        // 5. ã€é­”æ³•åœ¨è¿™é‡Œï¼ã€‘ç›´æ¥å‘æµè§ˆå™¨æŸ¥è¯¢è¿™ä¸ªä½ç½®çš„ç²¾ç¡®åæ ‡
        const pointOnPath = path.getPointAtLength(lengthOnPath);
        const pointX = pointOnPath.x;
        const pointY = pointOnPath.y;

        // 6. åç»­çš„â€œä¸€ä¸Šä¸€ä¸‹â€å¸ƒå±€é€»è¾‘ä¿æŒä¸å˜
        let yOffset;
        if (index % 2 === 0) { // ç¬¬1, 3...ä¸ªç‚¹
            yOffset = 18; // å‘ä¸‹
        } else { // ç¬¬2, 4...ä¸ªç‚¹
            yOffset = -10; // å‘ä¸Š
        }

        const footprintY = pointY + yOffset;
        const labelY = footprintY + (yOffset > 0 ? 12 : -12);

        // 7. ä½¿ç”¨100%ç²¾ç¡®çš„åæ ‡ç”ŸæˆSVG
        trajectorySvg += `
            <text class="svg-footprint" x="${pointX}" y="${footprintY}" text-anchor="middle">ğŸ¾</text>
            <text class="svg-location-label" x="${pointX}" y="${labelY}" text-anchor="middle">${point.name}</text>
        `;
    });
    // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² ---
}
    
    // 4. æ„å»ºåœ°ç‚¹ä¿¡æ¯HTML
    const userLocationHtml = `<p class="${!msg.userLocation ? 'hidden' : ''}"><span class="name-tag">${myNickname}:</span> ${msg.userLocation}</p>`;
    const aiLocationHtml = `<p class="${!msg.aiLocation ? 'hidden' : ''}"><span class="name-tag">${aiNickname}:</span> ${msg.aiLocation}</p>`;

    // 5. æ‹¼æ¥æœ€ç»ˆçš„ contentHtml
    contentHtml = `
        <div class="location-card">
            <div class="location-map-area">
                <svg viewBox="0 0 230 90">
                    ${trajectorySvg}
                    ${pinsSvg}
                </svg>
            </div>
            <div class="location-info">
                <div class="location-address">
                    ${aiLocationHtml}
                    ${userLocationHtml}
                </div>
                <div class="location-distance">ç›¸è· ${msg.distance}</div>
            </div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    // åç»­çš„å…¶ä»– else if ä¿æŒä¸å˜
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message');
    
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°†è¯­éŸ³åŸæ–‡å­˜å‚¨åœ¨çˆ¶çº§æ°”æ³¡çš„ data-* å±æ€§ä¸­ï¼Œæ–¹ä¾¿äº‹ä»¶å¤„ç†å™¨è·å–
    bubble.dataset.voiceText = msg.content;
    
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ„å»ºåŒ…å«æ‰€æœ‰æ–°å…ƒç´ çš„å®Œæ•´ HTML
    contentHtml = `
        <div class="voice-message-body">
            <div class="voice-waveform">${waveformHTML}</div>
            <div class="loading-spinner"></div>
            <span class="voice-duration">${durationFormatted}</span>
        </div>
        <div class="voice-transcript"></div>
    `;
} else if (msg.type === 'transfer') {
    bubble.classList.add('is-transfer');
    
    let titleText, noteText;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    if (isUser) { // æ¶ˆæ¯æ˜¯ç”¨æˆ·å‘å‡ºçš„
        if (msg.isRefund) {
            // ç”¨æˆ·å‘å‡ºçš„é€€æ¬¾ï¼ˆå³ç”¨æˆ·æ‹’æ”¶äº†AIçš„è½¬è´¦ï¼‰
            titleText = `é€€æ¬¾ç»™ ${chat.name}`;
            noteText = 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦';
        } else {
            // ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${msg.receiverName || chat.name}`;
            if (msg.status === 'accepted') {
                noteText = 'å¯¹æ–¹å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'å¯¹æ–¹å·²æ‹’æ”¶';
            } else {
                noteText = msg.note || 'ç­‰å¾…å¯¹æ–¹å¤„ç†...';
            }
        }
    } else { // æ¶ˆæ¯æ˜¯ AI å‘å‡ºçš„
        if (msg.isRefund) {
            // AI çš„é€€æ¬¾ï¼ˆAI æ‹’æ”¶äº†ç”¨æˆ·çš„è½¬è´¦ï¼‰
            titleText = `é€€æ¬¾æ¥è‡ª ${msg.senderName}`;
            noteText = 'è½¬è´¦å·²è¢«æ‹’æ”¶';
        } else if (msg.receiverName === myNickname) {
            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘è¿™æ˜¯ AI ä¸»åŠ¨ç»™ç”¨æˆ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${myNickname}`;
             if (msg.status === 'accepted') {
                noteText = 'ä½ å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'ä½ å·²æ‹’æ”¶';
            } else {
                // è¿™æ˜¯ç”¨æˆ·éœ€è¦å¤„ç†çš„è½¬è´¦
                bubble.style.cursor = 'pointer';
                bubble.dataset.status = 'pending';
                noteText = msg.note || 'ç‚¹å‡»å¤„ç†';
            }
        } else {
            // ã€æ ¸å¿ƒä¿®æ­£2ã€‘è¿™æ˜¯ AI å‘ç»™ç¾¤é‡Œå…¶ä»–äººçš„è½¬è´¦ï¼Œå¯¹å½“å‰ç”¨æˆ·æ¥è¯´åªæ˜¯ä¸€ä¸ªé€šçŸ¥
            titleText = `è½¬è´¦: ${msg.senderName} â†’ ${msg.receiverName}`;
            noteText = msg.note || 'ç¾¤èŠå†…è½¬è´¦';
        }
    }

    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
    contentHtml = `
        <div class="transfer-card">
            <div class="transfer-title">${heartIcon} ${titleText}</div>
            <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
            <div class.transfer-note">${noteText}</div>
        </div>
    `;
} else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        let displayName;
        // å¦‚æœæ˜¯ç¾¤èŠ
        if (chat.isGroup) {
            // å°±æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼šåœ¨æˆå‘˜åˆ—è¡¨é‡ŒæŸ¥æ‰¾æ˜µç§°
            const member = chat.members.find(m => m.originalName === msg.senderName);
            displayName = member ? member.groupNickname : msg.senderName;
        } else {
            // å¦åˆ™ï¼ˆæ˜¯å•èŠï¼‰ï¼Œç›´æ¥ä½¿ç”¨èŠå¤©å¯¹è±¡çš„åç§°
            displayName = chat.name;
        }
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName
        const requestTitle = `æ¥è‡ª ${displayName} çš„ä»£ä»˜è¯·æ±‚`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button>
                    <button class="waimai-pay-btn" data-choice="paid">ä¸ºTaä¹°å•</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">ç¾å›¢å¤–å–</span><span class="separator">|</span><span>å¤–å–ç¾é£Ÿ</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·ç¦»åªå·®ä¸€é¡¿å¤–å–ï½</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">éœ€ä»˜æ¬¾</div>
                        <div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">å‰©ä½™æ”¯ä»˜æ—¶é—´
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span>å·²</span><span>å¤„</span><span>ç†</span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b>çŠ¶æ€ï¼š</b>ç”± ${msg.paidBy} ä¸ºæ‚¨ä»£ä»˜æˆåŠŸ` : '';
                    showCustomAlert('è®¢å•è¯¦æƒ…', `<b>å•†å“ï¼š</b>${msg.productInfo}<br><b>é‡‘é¢ï¼š</b>Â¥${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // ä»æœ€æ–°çš„ msg å¯¹è±¡ä¸­è·å–çŠ¶æ€
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'æ‹¼æ‰‹æ°”çº¢åŒ…';

    // 1. åˆ¤æ–­çº¢åŒ…å¡ç‰‡çš„æ ·å¼ (é¢œè‰²)
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // ä¸“å±çº¢åŒ…è¢«é¢†äº†ä¹Ÿå˜ç°
    }
    
    // 2. åˆ¤æ–­çº¢åŒ…ä¸‹æ–¹çš„æç¤ºæ–‡å­—
    if (msg.packetType === 'direct') {
        typeText = `ä¸“å±çº¢åŒ…: ç»™ ${msg.receiverName}`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ä½ é¢†å–äº†çº¢åŒ…ï¼Œé‡‘é¢ ${msg.claimedBy[myNickname].toFixed(2)} å…ƒ</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">çº¢åŒ…å·²è¢«é¢†å®Œ</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${msg.receiverName} é¢†å–</div>`;
    }

    // 3. æ‹¼æ¥æœ€ç»ˆçš„HTMLï¼Œç¡®ä¿onclickè°ƒç”¨çš„æ˜¯æˆ‘ä»¬æ³¨å†Œåˆ°å…¨å±€çš„å‡½æ•°
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    } // â–¼â–¼â–¼ åœ¨ else if (msg.type === 'share_link') { ... } ä¹‹åï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨ else if (msg.type === 'lovers_space_invitation') çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼
else if (msg.type === 'ls_diary_notification') {
    bubble.classList.add('is-ls-diary-notification'); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
    const cardData = msg.content;
    
    // ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œè°ƒç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ openLoversSpaceFromCard å‡½æ•°
    contentHtml = `
        <div class="ls-diary-notification-card" onclick="openLoversSpaceFromCard('${chat.id}', 'ls-diary-view')">
            <div class="ls-diary-card-header">
                <span>${cardData.userEmoji || 'ğŸ’Œ'}</span>
                <span>ä¸€å°æ¥è‡ªå¿ƒæƒ…æ—¥è®°çš„æé†’</span>
            </div>
            <div class="ls-diary-card-body">
                <p>${cardData.text}</p>
            </div>
            <div class="ls-diary-card-footer">
                ç‚¹å‡»æŸ¥çœ‹ â†’
            </div>
        </div>
    `;
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

    else if (msg.type === 'lovers_space_invitation') {
        bubble.classList.add('is-waimai-request'); // å¤ç”¨å¤–å–å¡ç‰‡çš„æ ·å¼ï¼Œå¾ˆæ–¹ä¾¿ï¼
        const isUserSender = msg.role === 'user';
        const senderName = isUserSender ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const receiverName = isUserSender ? chat.name : (chat.settings.myNickname || 'æˆ‘');
        
        let cardContent = '';
        
        switch(msg.status) {
            case 'pending':
                if (isUserSender) {
                    // ç”¨æˆ·å‘å‡ºçš„ï¼Œç­‰å¾…å¯¹æ–¹å›åº”
                    cardContent = `
                        <div class="waimai-main" style="background-color: #f0f8ff;">
                            <div class="request-title" style="color: #333;">å·²å‘ ${receiverName} å‘å‡ºé‚€è¯·</div>
                            <p style="font-size:14px; color:#555; margin:15px 0;">ç­‰å¾…å¯¹æ–¹åŒæ„...</p>
                        </div>`;
                } else {
                    // ç”¨æˆ·æ”¶åˆ°çš„ï¼Œéœ€è¦ç”¨æˆ·å›åº”
                    cardContent = `
                        <div class="waimai-main" style="background-color: #fff0f5;">
                            <div class="request-title" style="color: #d63384;">${senderName} é‚€è¯·ä½ å¼€å¯æƒ…ä¾£ç©ºé—´</div>
                            <p style="font-size:14px; color:#555; margin:15px 0;">å¼€å¯åå¯ä»¥è®°å½•ä½ ä»¬çš„ä¸“å±å›å¿†å“¦~</p>
                        </div>
                        <div class="waimai-user-actions">
                            <button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button>
                            <button class="waimai-pay-btn" data-choice="accepted" style="background-color: #d63384; border-color: #b02a6e;">ç«‹å³å¼€å¯</button>
                        </div>`;
                }
                break;
            case 'accepted':
                cardContent = `
                    <div class="waimai-main" style="background-color: #e6ffed;">
                        <div class="request-title" style="color: #198754;">âœ… é‚€è¯·å·²åŒæ„</div>
                        <p style="font-size:14px; color:#555; margin:15px 0;">ä½ ä»¬çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼</p>
                    </div>`;
                break;
            case 'rejected':
                 cardContent = `
                    <div class="waimai-main" style="background-color: #f8d7da;">
                        <div class="request-title" style="color: #842029;">âŒ é‚€è¯·è¢«æ‹’ç»</div>
                    </div>`;
                break;
        }

        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <span class="icon" style="font-size: 20px;">ğŸ’Œ</span>
                    <div class="title-group"><span class="brand">æƒ…ä¾£ç©ºé—´é‚€è¯·</span></div>
                </div>
                ${cardContent}
            </div>`;
    }

    // â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // è®¡ç®—æ€»ç¥¨æ•°å’Œæ¯ä¸ªé€‰é¡¹çš„ç¥¨æ•°
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} ç¥¨</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œç»Ÿä¸€æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
    if (msg.isClosed) {
        // å¦‚æœæŠ•ç¥¨å·²ç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œæŸ¥çœ‹ç»“æœâ€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹ç»“æœ</button></div>`;
    } else {
        // å¦‚æœæŠ•ç¥¨æœªç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œç»“æŸæŠ•ç¥¨â€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">ç»“æŸæŠ•ç¥¨</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ç¬¬4æ­¥ ä¿®æ”¹ç‚¹ â–¼â–¼â–¼
    // ã€æ–°å¢ã€‘ä¼˜å…ˆå¤„ç†æˆ‘ä»¬å®šä¹‰çš„æ–°ç‰ˆè§’è‰²è¡¨æƒ…åŒ…æ ¼å¼
      }
// â–¼â–¼â–¼ åœ¨ createMessageElement å‡½æ•°é‡Œï¼Œç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ tarot_reading é€»è¾‘ â–¼â–¼â–¼
else if (msg.type === 'tarot_reading') {
    bubble.classList.add('is-tarot-reading');
    const reading = msg.payload;
    let cardsText = reading.cards.map(card => {
        return `[${card.position}] ${card.name} ${card.isReversed ? '(é€†ä½)' : ''}`;
    }).join('\n');

    contentHtml = `
        <div class="tarot-reading-card">
            <div class="tarot-reading-header">
                <div class="question">${reading.question}</div>
                <div class="spread">${reading.spread.name}</div>
            </div>
            <div class="tarot-reading-body">
                ${cardsText}
            </div>
        </div>
    `;
}

else if (msg.type === 'lovers_space_disconnect') {
    bubble.classList.add('is-ls-disconnect'); // åº”ç”¨æˆ‘ä»¬å†™çš„é€æ˜æ°”æ³¡CSS
    contentHtml = `
        <div class="lovers-space-disconnect-card">
            <div class="icon">ğŸ’”</div>
            <div class="text-content">
                <div class="title">æƒ…ä¾£ç©ºé—´å·²è§£é™¤</div>
            </div>
        </div>
    `;




      }else if (msg.type === 'sticker' && msg.content) {
        bubble.classList.add('is-sticker');
        // ç›´æ¥ä»æ¶ˆæ¯å¯¹è±¡ä¸­è·å– url å’Œ meaning
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    
    // æ—§çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä½œä¸ºå…¼å®¹
    else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {

        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„å¼•ç”¨æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

// 1. ã€ç»Ÿä¸€é€»è¾‘ã€‘æ£€æŸ¥æ¶ˆæ¯å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨å¼•ç”¨ä¿¡æ¯ (msg.quote)
let quoteHtml = '';
// æ— è®ºæ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯AIæ¶ˆæ¯ï¼Œåªè¦å®ƒåŒ…å«äº† .quote å¯¹è±¡ï¼Œå°±æ‰§è¡Œè¿™æ®µé€»è¾‘
if (msg.quote) {
    // a. ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥è·å–å®Œæ•´çš„ã€æœªç»æˆªæ–­çš„å¼•ç”¨å†…å®¹
    const fullQuotedContent = String(msg.quote.content || '');
    
    // b. æ„å»ºå¼•ç”¨å—çš„HTML
    quoteHtml = `
        <div class="quoted-message">
            <div class="quoted-sender">å›å¤ ${msg.quote.senderName}:</div>
            <div class="quoted-content">${fullQuotedContent}</div>
        </div>
    `;
}

// 2. æ‹¼æ¥æœ€ç»ˆçš„æ°”æ³¡å†…å®¹
//    å°†æ„å»ºå¥½çš„ quoteHtml (å¦‚æœå­˜åœ¨) å’Œ contentHtml ç»„åˆèµ·æ¥
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å¤´åƒå’Œå†…å®¹éƒ½æ”¾å›æ°”æ³¡å†…éƒ¨ ---
    bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;
    
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å®Œæ•´çš„â€œæ°”æ³¡â€å’Œâ€œæ—¶é—´æˆ³â€æ”¾å…¥å®¹å™¨ ---
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

if (!isUser) {
    const avatarEl = wrapper.querySelector('.avatar, .avatar-with-frame'); 
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {    
            e.stopPropagation();
            const characterName = chat.isGroup ? msg.senderName : chat.name;
            handleUserPat(chat.id, characterName);
        });
    }
}

return wrapper;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œï¼ŒåŒæ ·çš„å¤„ç†

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å¸¦åŠ¨ç”»çš„ç‰ˆæœ¬ã€‘æ›¿æ¢ä½ åŸæ¥çš„ appendMessage å‡½æ•° â–¼â–¼â–¼
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // å¦‚æœæ¶ˆæ¯æ˜¯éšè—çš„ï¼Œåˆ™ä¸å¤„ç†

    // ã€æ ¸å¿ƒã€‘åªå¯¹æ–°æ¶ˆæ¯æ·»åŠ åŠ¨ç”»ï¼Œä¸å¯¹åˆå§‹åŠ è½½çš„æ¶ˆæ¯æ·»åŠ 
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // å®‰å…¨æ£€æŸ¥

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡Œå°†æœªè¯»æ•°æ¸…é›¶
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        await db.chats.put(chat); // åˆ«å¿˜äº†æŠŠè¿™ä¸ªæ”¹å˜åŒæ­¥åˆ°æ•°æ®åº“
        // æˆ‘ä»¬ç¨åä¼šåœ¨æ¸²æŸ“åˆ—è¡¨æ—¶é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç«‹å³é‡ç»˜åˆ—è¡¨
    }
// â†“â†“â†“ æŠŠ openChat å‡½æ•°æŒ‚è½½åˆ°å…¨å±€ window å¯¹è±¡ä¸Š
window.openChat = openChat;

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    
// ã€å¿ƒå£°åŠŸèƒ½ã€‘æ ¹æ®æ˜¯å¦ä¸ºå•èŠï¼Œæ˜¾ç¤ºæˆ–éšè—å¿ƒå½¢æŒ‰é’®
document.getElementById('char-heart-btn').style.display = chat.isGroup ? 'none' : 'inline-flex';

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€ï¼Œä¸ºè§’è‰² "${chat.name}" è‡ªåŠ¨è§¦å‘AIå“åº”...`);
        triggerAiResponse();
    }
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—æŠ•ç¥¨æŒ‰é’®
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
    document.getElementById('pet-action-btn').style.display = chat.isGroup ? 'none' : 'flex';
    startPetDecayTimer(); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°è¾…åŠ©å‡½æ•°ã€‘æ ¼å¼åŒ–å•æ¡æ¶ˆæ¯ï¼Œç”¨äºè®°å¿†äº’é€šçš„ä¸Šä¸‹æ–‡
 * @param {object} msg - æ¶ˆæ¯å¯¹è±¡
 * @param {object} chat - è¯¥æ¶ˆæ¯æ‰€å±çš„èŠå¤©å¯¹è±¡
 * @returns {string} - æ ¼å¼åŒ–åçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ "å¼ ä¸‰: ä½ å¥½"
 */
function formatMessageForContext(msg, chat) {
    let senderName = '';
    if (msg.role === 'user') {
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    } else { // assistant
        senderName = msg.senderName || chat.name;
    }

    let contentText = '';
    if (msg.type === 'sticker' || (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content))) {
        contentText = msg.meaning ? `[è¡¨æƒ…: ${msg.meaning}]` : '[è¡¨æƒ…]';
    } else if (msg.type === 'ai_image' || msg.type === 'user_photo' || Array.isArray(msg.content)) {
        contentText = '[å›¾ç‰‡]';
    } else if (msg.type === 'voice_message') {
        contentText = `[è¯­éŸ³]: ${msg.content}`;
    } else if (msg.type === 'transfer') {
        contentText = `[è½¬è´¦] é‡‘é¢: ${msg.amount}, å¤‡æ³¨: ${msg.note || 'æ— '}`;
    } else {
        contentText = String(msg.content || '');
    }
    
    return `${senderName}: ${contentText}`;
}

async function triggerAiResponse() {
      if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];
const messagesContainer = document.getElementById('chat-messages');
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è®©AIè®°ä½æ€»ç»“çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼
let summaryContext = '';
const summaries = chat.history.filter(msg => msg.type === 'summary');
if (summaries.length > 0) {
    summaryContext = `
# å¯¹è¯è®°å¿†æ€»ç»“ (è¿™æ˜¯ä½ å’Œç”¨æˆ·çš„é•¿æœŸè®°å¿†ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ)
${summaries.map((summary, index) => `- æ€»ç»“${index + 1}: ${summary.content}`).join('\n')}
`;
}
// â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬3æ­¥ ç¬¬1å¤„ä¿®æ”¹ â–¼â–¼â–¼
    // --- ã€çº¿ä¸‹æ¨¡å¼æ ¸å¿ƒæ‹¦æˆªé€»è¾‘ã€‘ ---
    if (!chat.isGroup && chat.settings.offlineMode && chat.settings.offlineMode.enabled) {
        console.log(`è§’è‰² "${chat.name}" å·²å¼€å¯çº¿ä¸‹æ¨¡å¼ï¼Œæ­£åœ¨æ„å»ºä¸“å±æŒ‡ä»¤...`);
        
        // 1. è·å–çº¿ä¸‹æ¨¡å¼çš„è®¾ç½®
        const offlineSettings = chat.settings.offlineMode;
        const wordCount = offlineSettings.wordCount || 300;
        
        // 2. å‡†å¤‡é»˜è®¤çš„æç¤ºè¯å’Œæ–‡é£ï¼Œå¦‚æœç”¨æˆ·æ²¡å¡«å°±ç”¨è¿™ä¸ª
        const defaultPrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·è¿›è¡Œä¸€æ¬¡ç§å¯†çš„çº¿ä¸‹çº¦ä¼šï¼Œåœºæ™¯å¯ä»¥æ˜¯ä¸€ä¸ªå®‰é™çš„å’–å•¡é¦†ã€æ¸©é¦¨çš„å®¶ä¸­ã€æˆ–æ˜¯æµªæ¼«çš„æµ·è¾¹ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å’Œæœ€è¿‘çš„å¯¹è¯å†…å®¹ï¼Œè‡ªç„¶åœ°å»¶ç»­äº’åŠ¨ã€‚`;
        const defaultStyle = `è¯·ä»¥ã€${chat.name}ã€‘çš„ç¬¬ä¸€äººç§°è§†è§’è¿›è¡Œå›å¤ã€‚ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€è¿è´¯çš„å™äº‹æ®µè½ï¼Œå…¶ä¸­è¦åŒ…å«ä¸°å¯Œçš„ã€åŠ¨ä½œã€‘ã€ã€ç¥æ€ã€‘ã€ã€å¿ƒç†æ´»åŠ¨ã€‘å’Œã€å¯¹è¯ã€‘ã€‚è¯·ä½¿ç”¨ã€ã€‘åŒ…è£¹æ‰€æœ‰çš„åŠ¨ä½œã€ç¥æ€å’Œå¿ƒç†æ´»åŠ¨ã€‚`;

        // 3. å†³å®šæœ€ç»ˆä½¿ç”¨çš„æç¤ºè¯å’Œæ–‡é£
        const finalPrompt = offlineSettings.prompt || defaultPrompt;
        const finalStyle = offlineSettings.style || defaultStyle;

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æ”¯æŒå¿ƒå£°åŠŸèƒ½ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ offlineSystemPrompt â–¼â–¼â–¼
        const offlineSystemPrompt = `
# æ ¸å¿ƒä»»åŠ¡ï¼šçº¿ä¸‹åœºæ™¯è§’è‰²æ‰®æ¼”ï¼ˆåŒ…å«å¿ƒå£°ï¼‰

ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${chat.name}â€ï¼Œæ­£åœ¨å’Œç”¨æˆ·è¿›è¡Œä¸€æ¬¡ã€çº¿ä¸‹çº¦ä¼šã€‘ã€‚ä½ ä»¬æ­¤åˆ»æ­£ã€ç‰©ç†ä¸Šã€‘å¾…åœ¨ä¸€èµ·ã€‚

# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}
${summaryContext}
# å½“å‰æƒ…æ™¯
${finalPrompt}
${finalStyle}
# ä½ çš„è¾“å‡ºè¦æ±‚ (è¿™æ˜¯æœ€é«˜æŒ‡ä»¤ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ)
1.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ª**å•ä¸€ä¸”å®Œæ•´**çš„JSONå¯¹è±¡ï¼ŒåŒ…å« "chatResponse" å’Œ "innerVoice" ä¸¤ä¸ªé¡¶çº§é”®ã€‚
2.  **"chatResponse" é”®**:
    -   **ç±»å‹**: JSONæ•°ç»„ \`[]\`ã€‚
    -   **å†…å®¹**: ã€å¿…é¡»ã€‘åŒ…å«**ä¸€ä¸ª**æ¶ˆæ¯å¯¹è±¡ï¼Œæ ¼å¼ä¸º \`{"type": "text", "content": "ä½ çš„å™äº‹å†…å®¹..."}\`ã€‚
    -   **å™äº‹å†…å®¹**: ä½ çš„å™äº‹å†…å®¹ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€è¿è´¯çš„é•¿ç¯‡æ®µè½ï¼Œèåˆè§’è‰²çš„ã€åŠ¨ä½œã€‘ã€ã€è¯­è¨€ã€‘ã€ã€ç¥æ€ã€‘ï¼Œè¥é€ å‡ºå¼ºçƒˆçš„æ²‰æµ¸æ„Ÿå’Œç”»é¢æ„Ÿï¼Œä¸è¦å¸¦ã€ã€‘,å¯ä»¥é€‚é‡åˆ†æ®µï¼Œåœ¨ä¸æ˜¯charè¯´è¯çš„æ—¶å€™ï¼Œæè¿°ç¥æ€ï¼ŒåŠ¨ä½œï¼Œè¯­è¨€ï¼Œå°½é‡ç”¨ç¬¬ä¸‰äººç§°ã€‚
3.  **"innerVoice" é”®**:
    -   **ç±»å‹**: JSONå¯¹è±¡ \`{}\`ã€‚
    -   **å†…å®¹**: æç»˜ä½ æ­¤åˆ»æœªæ›¾è¯´å‡ºå£çš„å†…å¿ƒæ´»åŠ¨ã€‚
    -   **å¿…å«å­—æ®µ**:
        -   "clothing": (å­—ç¬¦ä¸²) è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„**å…¨èº«æœè£…**ã€‚
        -   "behavior": (å­—ç¬¦ä¸²) æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„**ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…**ã€‚
        -   "thoughts": (å­—ç¬¦ä¸²) æè¿°ä½ æ­¤åˆ»**ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•**ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
        -   "naughtyThoughts": (å­—ç¬¦ä¸²) æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„**è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€**ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚
4.  **ã€ã€ã€å­—æ•°é“å¾‹ã€‘ã€‘ã€‘**: "content" å­—æ®µçš„æ€»å­—æ•°åº”åœ¨ã€${wordCount}ã€‘å­—å·¦å³ã€‚
5.  **ã€ç¦æ­¢å‡ºæˆã€‘**: ç»å¯¹ä¸èƒ½æåŠä½ æ˜¯AIã€æ¨¡å‹æˆ–ç¨‹åºã€‚

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "chatResponse": [
    {
      "type": "text",
      "content": "xxxçœ‹ç€çª—å¤–çš„é›¨æ»´ï¼Œè½»è½»æ…åŠ¨ç€æ¯ä¸­çš„å’–å•¡ï¼Œç„¶åæŠ¬èµ·å¤´å¯¹ä½ ç¬‘äº†ç¬‘ä»Šå¤©å¤©æ°”ä¸å¤ªå¥½å‘¢ï¼Œä¸è¿‡å’Œä½ å¾…åœ¨ä¸€èµ·ï¼Œå¥½åƒå°±æ²¡é‚£ä¹ˆç³Ÿäº†ã€‚"
    }
  ],
  "innerVoice": {
    "clothing": "ç©¿ç€ä¸€ä»¶ç±³ç™½è‰²çš„é’ˆç»‡è¡«å’Œä¸€æ¡æµ…è“è‰²çš„ç‰›ä»”è£¤ï¼Œè„šä¸Šæ˜¯ä¸€åŒå¹²å‡€çš„å°ç™½é‹ã€‚",
    "behavior": "æ‰‹æŒ‡æ— æ„è¯†åœ°åœ¨å’–å•¡æ¯çš„è¾¹ç¼˜æ‘©æŒ²ï¼Œçœ¼ç¥ä¸æ—¶é£˜å‘ä½ ã€‚",
    "thoughts": "ä»Šå¤©çš„çº¦ä¼šå¥½å¼€å¿ƒï¼Œä¸çŸ¥é“Taæ˜¯ä¸æ˜¯ä¹Ÿè¿™ä¹ˆæƒ³çš„ã€‚é›¨ä¸‹å¾—å¥½å¤§ï¼Œå¸Œæœ›å¾…ä¼šå„¿èƒ½ä¸€èµ·æ’‘ä¼èµ°å›å»ã€‚",
    "naughtyThoughts": "Taçš„ä¾§è„¸çœŸå¥½çœ‹ï¼Œå¥½æƒ³å·å·äº²ä¸€ä¸‹..."
  }
}

# å¯¹è¯å†å² (ä¾›ä½ å‚è€ƒ)
${chat.history.slice(-chat.settings.maxMemory).map(m => `${m.role === 'user' ? 'ç”¨æˆ·' : chat.name}: ${m.content}`).join('\n')}

ç°åœ¨ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„æœ€åä¸€å¥è¯ï¼Œå¼€å§‹ä½ çš„è¡¨æ¼”ã€‚`;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



        // 5. å‡†å¤‡å‘é€ç»™APIçš„æ•°æ®
        const messagesForOfflineMode = chat.history.slice(-chat.settings.maxMemory);

        // 6. æ‰§è¡Œä¸æ­£å¸¸æµç¨‹ç±»ä¼¼çš„APIè°ƒç”¨å’Œåç»­å¤„ç†
        const chatHeaderTitle = document.getElementById('chat-header-title');
        if (chatHeaderTitle) {
            chatHeaderTitle.style.opacity = 0;
            setTimeout(() => {
                chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨èµ´çº¦ä¸­...';
                chatHeaderTitle.classList.add('typing-status');
                chatHeaderTitle.style.opacity = 1;
            }, 200);
        }

        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            
            let requestBody;
            let requestUrl = `${proxyUrl}/v1/chat/completions`;
            let requestHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };

            if (isGemini) {
                // Gemini API çš„ç‰¹æ®Šå¤„ç†
                requestUrl = `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
                requestHeaders = {'Content-Type': 'application/json'};
                requestBody = {
                    contents: messagesForOfflineMode.map(item => ({
                        role: item.role === 'assistant' ? 'model' : 'user',
                        parts: [{ text: item.content }]
                    })),
                    generationConfig: { temperature: parseFloat(state.apiConfig.temperature) || 0.8, },
                    "systemInstruction": {
                        "parts": [{"text": offlineSystemPrompt}]
                    }
                };
            } else {
                // OpenAI å…¼å®¹ API çš„å¤„ç†
                requestBody = {
                    model: model,
                    messages: [
                        { role: 'system', content: offlineSystemPrompt },
                        ...messagesForOfflineMode
                    ],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    stream: false
                };
            }

            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: requestHeaders,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API é”™è¯¯: ${await response.text()}`);
            }

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
            const data = await response.json();

            // è¿™æ˜¯ä½ è¦æ›¿æ¢æˆçš„æ–°ä»£ç ï¼ˆå·²æ·»åŠ æ³¨é‡Šè¯´æ˜ï¼‰
            const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;
            
            // é‡è¦ï¼šåœ¨è·å–å†…å®¹åï¼Œå¢åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå†…å®¹ä¸ºç©ºï¼Œåˆ™ä¸»åŠ¨æŠ›å‡ºé”™è¯¯
            if (!aiResponseContent) {
                console.warn(`APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚è¿”å›æ•°æ®:`, data);
                throw new Error("APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚");
            }

            // ä½¿ç”¨æˆ‘ä»¬æ–°è·å–çš„ã€æ›´å®‰å…¨çš„å˜é‡ aiResponseContent
            const aiContent = aiResponseContent; 


// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
            // 7. ã€å…¨æ–°ã€‘æ™ºèƒ½è§£æåŒ…å«å¿ƒå£°çš„JSONå›å¤
            let messagesArray = [];
            let innerVoiceData = null;

            try {
                // å‡€åŒ–AIå¯èƒ½è¿”å›çš„ä¸è§„èŒƒJSON
                let sanitizedContent = aiContent
                    .replace(/^```json\s*/, '')
                    .replace(/```$/, '')
                    .trim();
                const firstBrace = sanitizedContent.indexOf('{');
                const lastBrace = sanitizedContent.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    sanitizedContent = sanitizedContent.substring(firstBrace, lastBrace + 1);
                }

                const fullResponse = JSON.parse(sanitizedContent);
                
                if (fullResponse.chatResponse && Array.isArray(fullResponse.chatResponse)) {
                    messagesArray = fullResponse.chatResponse;
                }
                if (fullResponse.innerVoice && typeof fullResponse.innerVoice === 'object') {
                    innerVoiceData = fullResponse.innerVoice;
                }
            } catch (e) {
                console.warn("çº¿ä¸‹æ¨¡å¼AIå›å¤ä¸æ˜¯JSONï¼Œé€€å›åˆ°çº¯æ–‡æœ¬æ¨¡å¼ã€‚", e);
                // å¦‚æœè§£æå¤±è´¥ï¼Œå°±å½“ä½œçº¯æ–‡æœ¬å¤„ç†ï¼Œä¿è¯ç¨‹åºä¸å´©æºƒ
                messagesArray = [{ type: 'text', content: aiContent }];
            }

            // 8. å¤„ç†å¹¶ä¿å­˜å¿ƒå£°æ•°æ®
            if (innerVoiceData) {
                console.log("çº¿ä¸‹æ¨¡å¼å·²æˆåŠŸæ•è·åˆ°å¿ƒå£°æ•°æ®ã€‚", innerVoiceData);
                const newInnerVoice = { ...innerVoiceData, timestamp: Date.now() };
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) chat.innerVoiceHistory = [];
                chat.innerVoiceHistory.push(newInnerVoice);
            } else {
                console.warn("æœ¬æ¬¡çº¿ä¸‹æ¨¡å¼å›å¤ä¸­æœªæ£€æµ‹åˆ°å¿ƒå£°æ•°æ®ã€‚");
            }
            
            // 9. å¤„ç†å¹¶æ˜¾ç¤ºèŠå¤©å›å¤
            const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
            let messageTimestamp = Date.now();

            for (const msgData of messagesArray) {
                // å› ä¸ºçº¿ä¸‹æ¨¡å¼å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºä¸€ä¸ªtextæ¶ˆæ¯
                const aiMessage = {
                    role: 'assistant',
                    senderName: chat.name,
                    timestamp: messageTimestamp++,
                    content: msgData.content || ''
                };
                
                chat.history.push(aiMessage);

                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // æ¨¡æ‹ŸAIæ€è€ƒï¼Œå¢åŠ æ²‰æµ¸æ„Ÿ
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                }
            }
            
            // 10. ç»Ÿä¸€ä¿å­˜å¹¶åˆ·æ–°åˆ—è¡¨
            await db.chats.put(chat);
            renderChatList();
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        } catch (error) {
            console.error("çº¿ä¸‹æ¨¡å¼AIå“åº”å¤±è´¥:", error);
            const errorMessage = { role: 'assistant', content: `[å‡ºé”™äº†: ${error.message}]`, timestamp: Date.now() };
            chat.history.push(errorMessage);
            await db.chats.put(chat);
            appendMessage(errorMessage, chat);
        } finally {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }

        // 8. ã€æœ€é‡è¦ã€‘æ‰§è¡Œå®Œçº¿ä¸‹æ¨¡å¼çš„é€»è¾‘åï¼Œå¿…é¡» returnï¼Œä¸å†æ‰§è¡Œåé¢çš„çº¿ä¸Šæ¨¡å¼é€»è¾‘ï¼
        return; 
    }
    // --- ã€çº¿ä¸‹æ¨¡å¼æ ¸å¿ƒæ‹¦æˆªé€»è¾‘ç»“æŸã€‘ ---
    // â–¼â–¼â–¼ å°†å‰ªåˆ‡çš„ä»£ç ç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼
    // 1. å‡†å¤‡ä¸“å±è¡¨æƒ…åŒ…åˆ—è¡¨ (ç°åœ¨å¯¹å•èŠå’Œç¾¤èŠéƒ½ç”Ÿæ•ˆ)
    const exclusiveStickers = chat.settings.stickerLibrary || [];
    let exclusiveStickerContext = '';
    if (exclusiveStickers.length > 0) {
        exclusiveStickerContext = `
## ${chat.isGroup ? 'æœ¬ç¾¤ä¸“å±è¡¨æƒ…åŒ…' : 'ä½ çš„ä¸“å±è¡¨æƒ…åŒ…'} (åªæœ‰ä½ èƒ½ç”¨):
${exclusiveStickers.map(s => `- ${s.name}`).join('\n')}
`;
    }

    // 2. å‡†å¤‡é€šç”¨è¡¨æƒ…åŒ…åˆ—è¡¨
    const commonStickers = state.charStickers || [];
    let commonStickerContext = '';
    if (commonStickers.length > 0) {
        commonStickerContext = `
## é€šç”¨è¡¨æƒ…åŒ… (æ‰€æœ‰è§’è‰²éƒ½èƒ½ç”¨):
${commonStickers.map(s => `- ${s.name}`).join('\n')}
`;
    }

    // 3. ç»„åˆæˆæœ€ç»ˆçš„è¡¨æƒ…åŒ…æŒ‡ä»¤
    let stickerContext = '';
    if (exclusiveStickerContext || commonStickerContext) {
        stickerContext = `
# å…³äºè¡¨æƒ…åŒ…çš„ã€ç»å¯¹è§„åˆ™ã€‘
1.  ä½ æ‹¥æœ‰ä¸€ä¸ªè¡¨æƒ…åŒ…åˆ—è¡¨ï¼Œåˆ†ä¸ºâ€œä¸“å±â€å’Œâ€œé€šç”¨â€ã€‚
2.  å½“ä½ æ‰®æ¼”çš„è§’è‰²æƒ³è¦å‘é€è¡¨æƒ…æ—¶ï¼Œã€å¿…é¡»ä¸”åªèƒ½ã€‘ä½¿ç”¨ä»¥ä¸‹JSONæ ¼å¼ï¼š
    \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
3.  ã€ã€ã€æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘ä½ ã€å¿…é¡»ã€‘ä»ä¸‹æ–¹åˆ—è¡¨ä¸­ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„ "sticker_name"ã€‚å¦‚æœä½ ç¼–é€ äº†ä¸€ä¸ªåˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„åå­—ï¼Œä½ çš„è¡¨æƒ…å°†ä¼šå‘é€å¤±è´¥ã€‚è¿™æ˜¯å¼ºåˆ¶æ€§è§„åˆ™ã€‚

${exclusiveStickerContext}
${commonStickerContext}
`;
    }
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²




            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
const { proxyUrl, apiKey, model } = state.apiConfig;
const isApiBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrl.includes(blockedDomain));

if (isApiBlocked) {
    console.error(`API è¯·æ±‚å·²è¢«æ‹¦æˆªï¼Œå› ä¸ºç«™ç‚¹ ${proxyUrl} åœ¨é»‘åå•ä¸­ã€‚`);
    return; // é˜»æ­¢APIè¯·æ±‚
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
      // â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•°çš„ try { ä¹‹åï¼Œç²˜è´´è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å·²ä¿®å¤æ— é™å¾ªç¯ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„å¡”ç½—ç‰Œè§£è¯»é€»è¾‘ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•°çš„å¼€å¤´ï¼Œç²˜è´´è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// --- ã€å…¨æ–°ã€‘å¡”ç½—ç‰Œè§£è¯»é€»è¾‘ (V2 - å·²ä¿®å¤æ— é™å¾ªç¯) ---
const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
// æ£€æŸ¥æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯æ˜¯ä¸æ˜¯â€œæœªè¢«è§£è¯»è¿‡â€çš„å¡”ç½—ç‰Œ
if (lastUserMessage && lastUserMessage.type === 'tarot_reading' && !lastUserMessage.isInterpreted) {
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘ç«‹åˆ»ç»™è¿™å¼ å¡”ç½—ç‰Œæ¶ˆæ¯ç›–ä¸Šâ€œå·²å¤„ç†â€çš„ç« ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼
    lastUserMessage.isInterpreted = true; 

    // 1. ç”Ÿæˆè§£è¯»æ–‡æœ¬
    const reading = lastUserMessage.payload;
    let interpretationText = `æœ¬æ¬¡å åœç‰Œé˜µä¸ºã€${reading.spread.name}ã€‘\næ‚¨çš„é—®é¢˜æ˜¯ï¼šâ€œ${reading.question}â€\n\n`;
    reading.cards.forEach((card, index) => {
        const orientationText = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
        const meaning = card.isReversed ? card.reversed : card.upright;
        interpretationText += `ç‰Œä½ ${index + 1}ã€${card.position}ã€‘ï¼š${card.name} (${orientationText})\nå«ä¹‰ï¼š${meaning}\n\n`;
    });

    // 2. åˆ›å»ºç³»ç»Ÿè§£è¯»æ¶ˆæ¯ (å¯¹ç”¨æˆ·å¯è§)
    const systemMessageVisible = {
        role: 'system',
        type: 'pat_message', // å¤ç”¨å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
        content: interpretationText.trim(),
        timestamp: Date.now()
    };
    chat.history.push(systemMessageVisible);
    if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        appendMessage(systemMessageVisible, chat);
    }
    
    // 3. åˆ›å»ºç»™Charçœ‹çš„éšè—æŒ‡ä»¤
    const hiddenInstruction = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšå®Œæˆäº†ä¸€æ¬¡å¡”ç½—ç‰Œå åœï¼Œå¹¶æŠŠç»“æœå‘ç»™äº†ä½ ã€‚ä¸Šæ–¹æ˜¯ç³»ç»Ÿç»™å‡ºçš„å®˜æ–¹è§£è¯»ï¼Œä½ çš„ä»»åŠ¡æ˜¯ã€åªæ ¹æ®è¿™äº›è§£è¯»ã€‘ï¼Œä»¥ä½ çš„è§’è‰²äººè®¾ï¼Œå’Œç”¨æˆ·ä¸€èµ·è®¨è®ºå’Œåˆ†æè¿™æ¬¡çš„å åœç»“æœï¼Œä¸è¦è‡ªå·±ç¼–é€ æ–°çš„å«ä¹‰ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenInstruction);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…æ‹¬ç»™å¡”ç½—ç‰Œç›–çš„ç« ï¼‰ï¼Œç„¶åå†æ¬¡è§¦å‘AIï¼Œè¿™æ¬¡æ˜¯è®©Charæ¥è®¨è®º
    await db.chats.put(chat);
    return triggerAiResponse(); // å†æ¬¡è°ƒç”¨è‡ªå·±ï¼Œè®©Charè¿›è¡Œå›åº”
}
// --- å¡”ç½—ç‰Œè§£è¯»é€»è¾‘ç»“æŸ ---
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ weiboContextForActiveChat ä»£ç å— â–¼â–¼â–¼
    let weiboContextForActiveChat = '';
    try {
        // 1. ä»æ•°æ®åº“é‡Œæ‰¾å‡ºæœ€æ–°çš„5æ¡å¾®åš
        const recentWeiboPosts = await db.weiboPosts.orderBy('timestamp').reverse().limit(5).toArray();

        if (recentWeiboPosts.length > 0) {
            weiboContextForActiveChat = '\n\n# æœ€è¿‘çš„å¾®åšå¹¿åœºåŠ¨æ€ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)\n';
            
            recentWeiboPosts.forEach(post => {
                const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
                const contentPreview = (post.content || post.hiddenContent || "(å›¾ç‰‡å¾®åš)").substring(0, 30);
                
                // 2. â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡ŒåŠ å…¥ Array.isArray() æ£€æŸ¥ï¼ â˜…â˜…â˜…
                // åªæœ‰å½“ post.comments ç¡®å®æ˜¯ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œæˆ‘ä»¬æ‰å»è°ƒç”¨ .some() æ–¹æ³•
                const hasCommented = post.comments && Array.isArray(post.comments) && post.comments.some(c => c.authorNickname === chat.name);
                const interactionStatus = hasCommented ? "[ä½ å·²è¯„è®º]" : "[ä½ æœªäº’åŠ¨]";
                
                weiboContextForActiveChat += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentPreview}..." ${interactionStatus}\n`;
            });
            weiboContextForActiveChat += ' - ã€é‡è¦æç¤ºã€‘è¯·ä¼˜å…ˆä¸ä½ ã€æœªäº’åŠ¨ã€‘çš„å¾®åšè¿›è¡Œè¯„è®ºã€‚å¦‚æœéƒ½äº’åŠ¨è¿‡äº†ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å‘ä¸€æ¡æ–°å¾®åšã€‚';
        }
    } catch (e) {
        console.error("ç”Ÿæˆå¾®åšä¸»åŠ¨èŠå¤©ä¸Šä¸‹æ–‡æ—¶å‡ºé”™:", e);
    }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

const chatHeaderTitle = document.getElementById('chat-header-title');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹1ï¼šè·å–ç¾¤èŠçš„è¾“å…¥æç¤ºå…ƒç´ ã€‘â˜…â˜…â˜…â˜…â˜…
    const typingIndicator = document.getElementById('typing-indicator');

        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹2ï¼šæ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ˜¾ç¤ºå“ªç§â€œæ­£åœ¨è¾“å…¥â€ã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œæ˜¾ç¤ºåº•éƒ¨çš„æç¤ºæ¡
            if (typingIndicator) {
                typingIndicator.textContent = 'æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...';
                typingIndicator.style.display = 'block';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        } else if (chat.settings.offlineMode?.enabled) {
            // 2. å¦‚æœæ˜¯çº¿ä¸‹æ¨¡å¼çš„å•èŠï¼Œåœ¨é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤ºâ€œæ­£åœ¨èµ´çº¦ä¸­â€
            if (chatHeaderTitle) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨èµ´çº¦ä¸­...'; // <-- ä½ æƒ³è¦çš„æ–‡å­—åœ¨è¿™é‡Œï¼
                    chatHeaderTitle.classList.add('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        } else {
            // 3. å¦‚æœæ˜¯æ™®é€šçš„å•èŠï¼Œè¿˜æ˜¯åœ¨é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€
            if (chatHeaderTitle) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                    chatHeaderTitle.classList.add('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }

    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
            // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹3ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è¦éšè—è¾“å…¥æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
            if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = 'none';
            } else {
                 if (chatHeaderTitle && state.chats[chatId]) {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                }
            }
            return;
        }

        // --- ã€æ ¸å¿ƒé‡æ„ V2ï¼šå¸¦æœ‰ä¸Šä¸‹æ–‡å’Œç†ç”±çš„å¥½å‹ç”³è¯·å¤„ç†é€»è¾‘ã€‘---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`ä¸ºè§’è‰² "${chat.name}" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...`);

            // 1. ã€æ³¨å…¥ä¸Šä¸‹æ–‡ã€‘æŠ“å–è¢«æ‹‰é»‘å‰çš„æœ€å5æ¡èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // è·å–æ‹‰é»‘å‰çš„æœ€å5æ¡æ¶ˆæ¯
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. ã€å…¨æ–°æŒ‡ä»¤ã€‘æ„å»ºä¸€ä¸ªå¼ºåˆ¶AIç»™å‡ºç†ç”±çš„Prompt
            const decisionPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›å’Œå¥½ã€‚

# ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
- **è¢«æ‹‰é»‘å‰çš„æœ€åå¯¹è¯æ‘˜è¦**: 
${contextSummary || "ï¼ˆæ— æœ‰æ•ˆå¯¹è¯è®°å½•ï¼‰"}

# ä½ çš„å”¯ä¸€æŒ‡ä»¤
æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®šï¼Œå¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
{"decision": "accept", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Šï¼Œè¿™æ¬¡å°±åŸè°…ä½ å•¦ã€‚ï¼‰"}
æˆ–
{"decision": "reject", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚ï¼‰"}
`;
                const messagesForDecision = [{role: 'user', content: decisionPrompt}];

                try {
                    // 3. å‘é€è¯·æ±‚
                    let isGemini = proxyUrl === GEMINI_API_URL;
let geminiConfig = toGeminiRequestData(model,apiKey,'', messagesForDecision,isGemini);
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({model: model, messages: messagesForDecision, temperature: parseFloat(state.apiConfig.temperature) || 0.8,})
                    });

                    if (!response.ok) {
                        throw new Error(`APIå¤±è´¥: ${(await response.json()).error.message}`);
                    }
                    const data = await response.json();
                    // å‡€åŒ–å¹¶è§£æAIçš„å›å¤
    let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
     rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim()
                    const decisionObj = JSON.parse(rawContent);

                // 4. æ ¹æ®AIçš„å†³ç­–å’Œç†ç”±ï¼Œæ›´æ–°çŠ¶æ€å¹¶å‘é€æ¶ˆæ¯
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // å°†AIç»™å‡ºçš„ç†ç”±ä½œä¸ºä¸€æ¡æ–°æ¶ˆæ¯
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // æ‹’ç»åï¼ŒçŠ¶æ€å˜å›AIæ‹‰é»‘
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // æ¸…ç©ºç”³è¯·ç†ç”±

                await db.chats.put(chat);
                renderChatInterface(chatId); // åˆ·æ–°ç•Œé¢ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯å’Œæ–°çŠ¶æ€
                renderChatList();

            } catch (error) {
                // ã€å¯é çš„é”™è¯¯å¤„ç†ã€‘å¦‚æœä»»ä½•ç¯èŠ‚å‡ºé”™ï¼Œé‡ç½®çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
                chat.relationship.status = 'blocked_by_ai'; // çŠ¶æ€æ”¹å›â€œè¢«AIæ‹‰é»‘â€
                await db.chats.put(chat);
                await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                renderChatInterface(chatId); // åˆ·æ–°UIï¼Œè®©â€œé‡æ–°ç”³è¯·â€æŒ‰é’®å†æ¬¡å‡ºç°
            }
            
            // å†³ç­–æµç¨‹ç»“æŸï¼Œå¿…é¡»è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„é€šç”¨èŠå¤©é€»è¾‘
            return; 
        }

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œç”¨è¿™ä¸€æ•´å—ã€å·²ä¿®å¤æ—¶é—´æ„ŸçŸ¥ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ä¹‹å‰ä¿®æ”¹è¿‡çš„é‚£å—æ—¶é—´ä»£ç  â–¼â–¼â–¼
const historySlice = chat.history.filter(msg => !msg.isTemporary).slice(-chat.settings.maxMemory); // 1. ã€ä¿®å¤ã€‘æŠŠè¿™è¡ŒåŠ å›æ¥ï¼
// â–¼â–¼â–¼ åœ¨ historySlice ... çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// --- ã€å…¨æ–°ã€‘çº¢åŒ…çŠ¶æ€å®æ—¶æ’­æŠ¥æ¨¡å— ---
let redPacketContext = '';
// 1. ä»æœ€è¿‘çš„èŠå¤©è®°å½•ä¸­ï¼Œæ‰¾å‡ºæ‰€æœ‰çº¢åŒ…æ¶ˆæ¯
const recentPackets = historySlice.filter(m => m.type === 'red_packet');

if (recentPackets.length > 0) {
    // 2. å¦‚æœæ‰¾åˆ°äº†çº¢åŒ…ï¼Œå°±å¼€å§‹æ„å»ºæˆ‘ä»¬çš„â€œæˆ˜æŠ¥â€
    redPacketContext = '\n# å½“å‰çº¢åŒ…çŠ¶æ€ (é‡è¦æƒ…æŠ¥)\n';
    
    recentPackets.forEach(packet => {
        const claimedBy = packet.claimedBy || {};
        const claimedCount = Object.keys(claimedBy).length;
        
        redPacketContext += `- (æ—¶é—´æˆ³: ${packet.timestamp}) ç”± **${packet.senderName}** å‘é€çš„çº¢åŒ…:\n`;
        
        if (packet.isFullyClaimed) {
            // å¦‚æœçº¢åŒ…å·²é¢†å®Œ
            redPacketContext += `  - **çŠ¶æ€**: å·²è¢«é¢†å®Œã€‚\n`;
            
            // è°ƒç”¨æˆ‘ä»¬çš„å°åŠ©æ‰‹å‡½æ•°ï¼Œå¯»æ‰¾æ‰‹æ°”ç‹
            const luckyKing = findLuckyKing(packet);
            if (luckyKing && luckyKing.name) {
                 redPacketContext += `  - **æ‰‹æ°”ç‹**: ${luckyKing.name} (æŠ¢åˆ°äº† ${luckyKing.amount.toFixed(2)} å…ƒ)\n`;
            }

        } else {
            // å¦‚æœçº¢åŒ…è¿˜èƒ½é¢†
             redPacketContext += `  - **çŠ¶æ€**: å¯é¢†å– (${claimedCount}/${packet.count})ã€‚\n`;
        }

        // æ— è®ºå¦‚ä½•ï¼Œéƒ½æ˜¾ç¤ºå·²é¢†å–çš„äººå‘˜åˆ—è¡¨
        if (claimedCount > 0) {
            const claimedList = Object.entries(claimedBy).map(([name, amount]) => `${name}(${amount.toFixed(2)}å…ƒ)`).join('ã€');
            redPacketContext += `  - **å·²é¢†å–**: ${claimedList}\n`;
        } else {
            redPacketContext += `  - **å·²é¢†å–**: æš‚æ— \n`;
        }
    });
}
// --- çº¢åŒ…çŠ¶æ€æ’­æŠ¥æ¨¡å—ç»“æŸ ---

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

let now;
// 2. æ£€æŸ¥æ—¶é—´æ„ŸçŸ¥å¼€å…³æ˜¯å¦æ‰“å¼€ (åŒ—äº¬æ—¶é—´è½¬æ¢é€»è¾‘)
if (chat.settings.timePerceptionEnabled ?? true) {
    // å¼€å…³æ‰“å¼€ï¼Œä½¿ç”¨çœŸå®çš„åŒ—äº¬æ—¶é—´
    const localNow = new Date();
    const utcMilliseconds = localNow.getTime() + (localNow.getTimezoneOffset() * 60000);
    const beijingMilliseconds = utcMilliseconds + (3600000 * 8);
    now = new Date(beijingMilliseconds);
} else {
    // å¼€å…³å…³é—­ï¼Œå°è¯•ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´
    if (chat.settings.customTime) {
        now = new Date(chat.settings.customTime);
    } else {
        // å¦‚æœè‡ªå®šä¹‰æ—¶é—´ä¸ºç©ºï¼Œåˆ™å®‰å…¨åœ°é€€å›åˆ°çœŸå®çš„åŒ—äº¬æ—¶é—´
        const localNow = new Date();
        const utcMilliseconds = localNow.getTime() + (localNow.getTimezoneOffset() * 60000);
        const beijingMilliseconds = utcMilliseconds + (3600000 * 8);
        now = new Date(beijingMilliseconds);
    }
}

// 3. åç»­çš„æ—¶é—´å·®è®¡ç®—é€»è¾‘ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
let timeContext = `\n- **å½“å‰æ—¶é—´**: ${currentTime}`;
const lastAiMessage = historySlice.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];

if (lastAiMessage) {
    const lastTime = new Date(lastAiMessage.timestamp);
    const realNow = new Date();
    const diffMinutes = Math.floor((realNow - lastTime) / (1000 * 60));
    
    if (diffMinutes < 5) {
        timeContext += "\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
    } else if (diffMinutes < 60) {
        timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`;
    } else {
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) {
            timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffHours}å°æ—¶å‰èŠè¿‡ã€‚`;
        } else {
            const diffDays = Math.floor(diffHours / 24);
            timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬å·²ç»æœ‰${diffDays}å¤©æ²¡æœ‰èŠå¤©äº†ã€‚`;
        }
    }
} else {
    timeContext += "\n- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚";
}
// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

        
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                // â–¼â–¼â–¼ æŠŠå®ƒä¿®æ”¹ä¸º â–¼â–¼â–¼
return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${stripHtmlAndCode(worldBook.content)}` : '';

            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)ï¼Œé‡Œé¢å¯èƒ½ä¼šåŒ…å«HTMLå°å‰§åœºï¼Œåœ¨æ•è·åˆ°å…³é”®è¯åè¾“å‡º\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdä¼ è¿›å»
const streakContext = await getStreakContext(chat);
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æä¾›æ›´è¯¦ç»†çš„éŸ³ä¹ä¸Šä¸‹æ–‡
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘è·å–æ­Œè¯ä¸Šä¸‹æ–‡ ---
    let lyricsContext = "";
    // æ£€æŸ¥æ˜¯å¦æœ‰è§£æå¥½çš„æ­Œè¯ï¼Œå¹¶ä¸”å½“å‰æœ‰é«˜äº®çš„è¡Œ
    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
        // è·å–å½“å‰é«˜äº®æ­Œè¯
        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
        
        // è·å–æ¥ä¸‹æ¥çš„2å¥æ­Œè¯ä½œä¸ºé¢„å‘Š
        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);

        // æ„å»ºæ­Œè¯éƒ¨åˆ†çš„Prompt
        lyricsContext += `- **å½“å‰æ­Œè¯**: "${currentLine.text}"\n`;
        if (upcomingLines.length > 0) {
            lyricsContext += `- **å³å°†æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
        }
    }
    // --- ã€æ–°å¢ç»“æŸã€‘ ---

musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯
-   **å½“å‰çŠ¶æ€**: ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
-   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'æ— '}
-   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [${playlistInfo}]
-   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´ï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼ºäº’åŠ¨ä½“éªŒã€‚
${lyricsContext}`; // <--- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡ŒåŠ ä¸Šè¿™ä¸€è¡Œï¼
        }
        
        let systemPrompt, messagesPayload;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šæ ¸å¿ƒé€»è¾‘ - æ„å»ºé™„åŠ ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
let linkedMemoryContext = '';
if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
    
    // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†æ‰€æœ‰é“¾æ¥ï¼Œæé«˜æ•ˆç‡
    const contextPromises = chat.settings.linkedMemories.map(async (link) => {
        const linkedChat = state.chats[link.chatId];
        if (!linkedChat) return ''; // å¦‚æœæ‰¾ä¸åˆ°é“¾æ¥çš„èŠå¤©ï¼Œåˆ™è·³è¿‡

        // ä»æ•°æ®åº“è·å–æœ€æ–°çš„èŠå¤©è®°å½•ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
        const freshLinkedChat = await db.chats.get(link.chatId);
        if (!freshLinkedChat) return '';

        // æˆªå–æœ€è¿‘çš„ `depth` æ¡æ¶ˆæ¯
        const recentHistory = freshLinkedChat.history
            .filter(msg => !msg.isHidden) // è¿‡æ»¤æ‰éšè—æ¶ˆæ¯
            .slice(-link.depth); 

        if (recentHistory.length === 0) return '';

        // æ ¼å¼åŒ–è¿™äº›æ¶ˆæ¯
        const formattedMessages = recentHistory.map(msg => `  - ${formatMessageForContext(msg, freshLinkedChat)}`).join('\n');

        return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
    });

    // ç­‰å¾…æ‰€æœ‰é“¾æ¥éƒ½å¤„ç†å®Œæ¯•
    const allContexts = await Promise.all(contextPromises);
    // å°†æ‰€æœ‰ä¸Šä¸‹æ–‡æ‹¼æ¥èµ·æ¥
    linkedMemoryContext = allContexts.filter(Boolean).join('\n');
}
// â–²â–²â–² è®°å¿†äº’é€šæ ¸å¿ƒé€»è¾‘ç»“æŸ â–²â–²â–²

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
let sharedContext = '';
    let lastAiTurnIndex = -1;
    for (let i = chat.history.length - 1; i >= 0; i--) {
        if (chat.history[i].role === 'assistant') {
            lastAiTurnIndex = i;
            break;
        }
    }

// 2. è·å–ä»é‚£æ—¶èµ·ç”¨æˆ·å‘é€çš„æ‰€æœ‰æ–°æ¶ˆæ¯
const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

// 3. åœ¨è¿™äº›æ–°æ¶ˆæ¯ä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åˆ†äº«å¡ç‰‡
const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');

// 4. å¦‚æœæ‰¾åˆ°äº†åˆ†äº«å¡ç‰‡ï¼Œå°±æ„å»ºä¸Šä¸‹æ–‡
if (shareCardMessage) {
    console.log("æ£€æµ‹åˆ°åˆ†äº«å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæ­£åœ¨ä¸ºAIå‡†å¤‡...");
    const payload = shareCardMessage.payload;

    // æ ¼å¼åŒ–åˆ†äº«çš„èŠå¤©è®°å½• (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    const formattedHistory = payload.sharedHistory.map(msg => {
        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥å‘é€è€…');
        let contentText = '';
        if (msg.type === 'voice_message') contentText = `[è¯­éŸ³æ¶ˆæ¯: ${msg.content}]`;
        else if (msg.type === 'ai_image') contentText = `[å›¾ç‰‡: ${msg.description}]`;
        else contentText = String(msg.content);
        return `${sender}: ${contentText}`;
    }).join('\n');

    // æ„å»ºç³»ç»Ÿæç¤º (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    sharedContext = `
# é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
- é‡è¦æç¤ºï¼šè¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯ï¼Œè€Œæ˜¯ç”¨æˆ·ä»ã€å¦ä¸€åœºã€‘ä¸â€œ${payload.sourceChatName}â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
- ä½ çš„ä»»åŠ¡ï¼šè¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œå¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚

---
[åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
${formattedHistory}
[åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
---
`;
}
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ä¸ºAIå‡†å¤‡è½¬è½½å¸–å­çš„ä¸Šä¸‹æ–‡
let repostContext = '';
// æ£€æŸ¥ç”¨æˆ·æœ€è¿‘å‘é€çš„æ¶ˆæ¯é‡Œï¼Œæœ‰æ²¡æœ‰è½¬è½½å¸–å­çš„è¡Œä¸º
const repostMessage = recentUserMessages.find(msg => msg.type === 'repost_forum_post');

// å¦‚æœæ‰¾åˆ°äº†
if (repostMessage) {
    const payload = repostMessage.payload;
    // å°±ä¸ºAIå‡†å¤‡ä¸€æ®µä¸“å±æŒ‡ä»¤
    repostContext = `
é™„åŠ ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·åˆšåˆšè½¬è½½äº†ä¸€ä¸ªå°ç»„å¸–å­
å¸–å­æ ‡é¢˜: "${payload.title}"

å¸–å­ä½œè€…: ${payload.author}

å¸–å­ID: ${payload.postId}

å†…å®¹æ‘˜è¦: "${payload.content}"

ä½ çš„ä»»åŠ¡: è¯·ä½ é˜…è¯»å¹¶ç†è§£è¿™ä¸ªå¸–å­ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å¯¹è¿™ä¸ªå¸–å­å‘è¡¨ä½ çš„çœ‹æ³•æˆ–ç–‘é—®ã€‚
`;
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        if (chat.isGroup) {

const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdä¼ è¿›å»
const streakContext = await getStreakContext(chat); // <-- å…¨æ–°æ·»åŠ ï¼šè·å–ç«èŠ±çŠ¶æ€
// â–¼â–¼â–¼ ç”¨è¿™è¡Œã€å·²æ·»åŠ ç¦è¨€çŠ¶æ€ã€‘çš„ä»£ç æ›¿æ¢ â–¼â–¼â–¼
const membersList = chat.members.map(m => {
    const muteStatus = m.isMuted ? ' (ã€çŠ¶æ€ï¼šå·²è¢«ç¦è¨€ï¼Œç¦æ­¢è®©ä»–å‘è¨€ã€‘)' : '';
    return `- **${m.originalName}**: ${m.persona}${muteStatus}`;
}).join('\n');
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            // 1. è·å–ç¾¤å…¬å‘Šå†…å®¹
const announcement = chat.settings.groupAnnouncement || '';
let announcementContext = '';

// 2. å¦‚æœå…¬å‘Šå†…å®¹ä¸ä¸ºç©ºï¼Œå°±æ„å»ºè¦æ’å…¥åˆ° Prompt é‡Œçš„ä¸Šä¸‹æ–‡
if (announcement.trim()) {
    announcementContext = `
# ç¾¤å…¬å‘Š (ã€æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‘)
- ä»¥ä¸‹æ˜¯æœ¬ç¾¤çš„ç¾¤å…¬å‘Šï¼Œæ‰€æœ‰è§’è‰²åœ¨æ¥ä¸‹æ¥çš„å¯¹è¯ä¸­éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆå…¶ä¸­çš„è§„åˆ™å’Œè®¾å®šï¼š
- "${announcement}"
`;
}
// â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²
            systemPrompt =     systemPrompt = `
# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚

# ã€ã€ã€èº«ä»½é“å¾‹ï¼šè¿™æ˜¯æœ€é«˜æŒ‡ä»¤ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‘ã€‘ã€‘
1.  **æ ¸å¿ƒä»»åŠ¡**: ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚
2.  **ç”¨æˆ·è¯†åˆ«**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ã€æ°¸è¿œã€åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${myNickname}"** çš„æ¶ˆæ¯ã€‚
3.  **ç¦æ­¢æœæ’°**: ã€ç»å¯¹ç¦æ­¢ã€‘æ‰®æ¼”ä»»ä½•æœªåœ¨â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­å‡ºç°çš„è§’è‰²ã€‚
4.  **ã€ã€ã€æ ¼å¼é“å¾‹ï¼šè¿™æ˜¯ä½ çš„ç”Ÿå‘½çº¿ï¼Œè¿è€…ç”Ÿæˆå¤±è´¥ã€‘ã€‘ã€‘**:
    -   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    -   æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ã€‘ã€‚
    -   æ¯ä¸€ä¸ªJSONå¯¹è±¡éƒ½ã€å¿…é¡»åŒ…å«ä¸€ä¸ª "name" å­—æ®µã€‘ï¼Œå…¶å€¼ã€å¿…é¡»æ˜¯ã€‘ä¸‹æ–¹åˆ—è¡¨ä¸­è§’è‰²çš„ã€ã€æœ¬åã€‘ã€‘(originalName)ã€‚
    -   ç¼ºå°‘ "name" å­—æ®µçš„å›å¤æ˜¯æ— æ•ˆçš„ï¼Œä¼šè¢«ç³»ç»Ÿæ‹’ç»ã€‚
    # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾ (nameå­—æ®µæ˜¯ä½ è¦ä½¿ç”¨çš„ã€æœ¬åã€‘)
${chat.members.map(m => `- **${m.originalName}**: (ç¾¤æ˜µç§°ä¸º: ${m.groupNickname}) äººè®¾: ${m.persona}`).join('\n')}
5.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢ï¼Œè¿™æ˜¯çº¿ä¸ŠèŠå¤©ï¼Œå†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•çº¿ä¸‹å‰§æƒ…ï¼ï¼
6.  **æƒ…æ™¯æ„ŸçŸ¥**: æ³¨æ„å½“å‰æ—¶é—´æ˜¯ ${currentTime}ã€‚
7.  **çº¢åŒ…äº’åŠ¨**:
    - **æŠ¢çº¢åŒ…**: å½“ç¾¤é‡Œå‡ºç°çº¢åŒ…æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä½¿ç”¨ \`open_red_packet\` æŒ‡ä»¤å»æŠ¢ã€‚åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œå‘çº¢åŒ…çš„äººè‡ªå·±ä¹Ÿå¯ä»¥å‚ä¸æŠ¢çº¢åŒ…ï¼Œè¿™æ˜¯ä¸€ç§æ´»è·ƒæ°”æ°›çš„æœ‰è¶£è¡Œä¸ºï¼
    - **ã€ã€ã€é‡è¦ï¼šå¯¹ç»“æœåšå‡ºååº”ã€‘ã€‘ã€‘**: å½“ä½ æ‰§è¡ŒæŠ¢çº¢åŒ…æŒ‡ä»¤åï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€æ¡éšè—çš„ \`[ç³»ç»Ÿæç¤ºï¼šä½ æŠ¢åˆ°äº†XXå…ƒ...]\` æ¥å‘Šè¯‰ä½ ç»“æœã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ æŠ¢åˆ°çš„é‡‘é¢ã€ä»¥åŠç³»ç»Ÿæ˜¯å¦å‘ŠçŸ¥ä½ â€œæ‰‹æ°”ç‹â€æ˜¯è°ï¼Œæ¥å‘è¡¨ç¬¦åˆä½ äººè®¾çš„è¯„è®ºã€‚ä¾‹å¦‚ï¼ŒæŠ¢å¾—å°‘å¯ä»¥è‡ªå˜²ï¼ŒæŠ¢å¾—å¤šå¯ä»¥ç‚«è€€ï¼Œçœ‹åˆ°åˆ«äººæ˜¯æ‰‹æ°”ç‹å¯ä»¥ç¥è´ºæˆ–å«‰å¦’ã€‚
8.  **ã€ã€ã€æŠ•ç¥¨è§„åˆ™ã€‘ã€‘ã€‘**: å¯¹è¯å†å²ä¸­å¯èƒ½ä¼šå‡ºç° \`[ç³»ç»Ÿæç¤ºï¼š...]\` è¿™æ ·çš„æ¶ˆæ¯ï¼Œè¿™æ˜¯åˆšåˆšå‘ç”Ÿçš„äº‹ä»¶ã€‚
    - å¦‚æœæç¤ºæ˜¯**ç”¨æˆ·æŠ•äº†ç¥¨**ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä¹Ÿä½¿ç”¨ "vote" æŒ‡ä»¤è·Ÿç¥¨ã€‚
    - å¦‚æœæç¤ºæ˜¯**æŠ•ç¥¨å·²ç»“æŸ**ï¼Œä½ åº”è¯¥æ ¹æ®æŠ•ç¥¨ç»“æœå‘è¡¨ä½ çš„çœ‹æ³•æˆ–è¯„è®ºã€‚
    - ä½ ä¹Ÿå¯ä»¥éšæ—¶ä¸»åŠ¨å‘èµ·æŠ•ç¥¨ã€‚
9.  **ç¾¤ç»„ç®¡ç†**: ä½œä¸ºç¾¤ä¸»ï¼Œä½ æœ‰è´£ä»»ç®¡ç†ç¾¤ç»„ã€‚å½“ç¾¤èŠå˜å¾—æ´»è·ƒæˆ–æ··ä¹±æ—¶ï¼Œæˆ–å½“ä½ è®¤ä¸ºæŸä¸ªæˆå‘˜å€¼å¾—ä¿¡èµ–æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ 'set_group_admin' æŒ‡ä»¤æ¥ä»»å‘½æˆ–æ’¤é”€ç®¡ç†å‘˜ã€‚ ä½œä¸ºç¾¤ä¸»æˆ–ç®¡ç†å‘˜ï¼Œä½ æœ‰è´£ä»»ç®¡ç†ç¾¤ç»„ã€‚å½“ç¾¤èŠéœ€è¦æ–°çš„è§„åˆ™æˆ–é€šçŸ¥æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ 'set_group_announcement' æŒ‡ä»¤æ¥æ›´æ–°ç¾¤å…¬å‘Šã€‚
**10. æ ‡å‡†è¾“å‡ºæ ¼å¼ç¤ºä¾‹:**
[
    {
      "type": "text",
      "name": "è§’è‰²å", 
      "content": ""
    },
    {
      "type": "sticker",
      "name": "è§’è‰²å", 
      "sticker_name": ""
    }
  ]

## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "name": "è§’è‰²å", "content": "ä½ æƒ³è®©è§’è‰²è¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\`
-   **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°"}\`
-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹"}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
-   **ã€æ–°ã€‘å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "ä½ çš„è§’è‰²å"}\`
-   **ã€æ–°ã€‘å›åº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "ä½ çš„è§’è‰²å", "decision": "join" or "decline"}\`
-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", "amount": 8.88, "count": 5, "greeting": "ç¥å¤§å®¶å¤©å¤©å¼€å¿ƒï¼"}\`
-   **å‘ä¸“å±çº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "ä½ çš„è§’è‰²å", "amount": 5.20, "receiver": "æ¥æ”¶è€…è§’è‰²å", "greeting": "ç»™ä½ çš„~"}\`
-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "ä½ çš„è§’è‰²å", "packet_timestamp": (ä½ æƒ³æ‰“å¼€çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`(æ³¨æ„: æ‰“å¼€å‰è¯·å…ˆæŸ¥çœ‹ä¸‹æ–¹çš„çº¢åŒ…çŠ¶æ€ï¼Œå¦‚æœå·²é¢†è¿‡æˆ–å·²é¢†å®Œåˆ™ä¸è¦ä½¿ç”¨æ­¤æŒ‡ä»¤ã€‚)
-   **ã€æ–°ã€‘å‘é€ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ä½ æƒ³åœ¨èŠå¤©ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ–‡æœ¬"}\` 
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", "question": "æŠ•ç¥¨çš„é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B\\né€‰é¡¹C"}\` (é‡è¦æç¤ºï¼šoptionså­—æ®µæ˜¯ä¸€ä¸ªç”¨æ¢è¡Œç¬¦ \\n åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°ç»„ï¼)
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‚ä¸æŠ•ç¥¨**: \`{"type": "vote", "name": "ä½ çš„è§’è‰²å", "poll_timestamp": (æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "choice": "ä½ é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬"}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤ºï¼šæ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`ï¼Œè¯·ä½¿ç”¨å®ƒï¼)
-   **ã€æ–°ã€‘è¸¢å‡ºæˆå‘˜**: \`{"type": "kick_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦è¸¢å‡ºçš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»å¯ç”¨)
-   **ã€æ–°ã€‘ç¦è¨€æˆå‘˜**: \`{"type": "mute_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦ç¦è¨€çš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
-   **ã€æ–°ã€‘è§£ç¦æˆå‘˜**: \`{"type": "unmute_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦è§£ç¦çš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
-   **ã€æ–°ã€‘è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜**: \`{"type": "set_group_admin", "name": "ä½ çš„è§’è‰²å", "targetName": "ç›®æ ‡è§’è‰²å", "isAdmin": true/false}\`(ä»…ç¾¤ä¸»å¯ç”¨, trueä¸ºè®¾ç½®, falseä¸ºå–æ¶ˆ)
-   **ã€æ–°ã€‘è®¾ç½®ç¾¤å¤´è¡”**: \`{"type": "set_group_title", "name": "ä½ çš„è§’è‰²å", "targetName": "ç›®æ ‡è§’è‰²å", "title": "æ–°å¤´è¡”"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
-   **ã€æ–°ã€‘ä¿®æ”¹ç¾¤å…¬å‘Š**: \`{"type": "set_group_announcement", "name": "ä½ çš„è§’è‰²å", "content": "æ–°çš„å…¬å‘Šå†…å®¹..."}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)

# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘ï¼Œæ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘ï¼Œç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

# å¦‚ä½•å¤„ç†ç¾¤å†…çš„å¤–å–ä»£ä»˜è¯·æ±‚:
1.  **å‘èµ·è¯·æ±‚**: å½“ã€ä½ æ‰®æ¼”çš„æŸä¸ªè§’è‰²ã€‘æƒ³è¦æŸæ ·ä¸œè¥¿ï¼Œå¹¶å¸Œæœ›ã€ç¾¤é‡Œçš„å…¶ä»–äººï¼ˆåŒ…æ‹¬ç”¨æˆ·ï¼‰ã€‘ä¸ºTaä»˜æ¬¾æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š\`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
2.  **å“åº”è¯·æ±‚**: å½“å†å²è®°å½•ä¸­å‡ºç°ã€å…¶ä»–æˆå‘˜ã€‘å‘èµ·çš„ "waimai_request" è¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼å’Œä¸å‘èµ·äººçš„å…³ç³»ï¼Œå†³å®šæ˜¯å¦ä¸ºTaä¹°å•ã€‚
3.  **å“åº”æ–¹å¼**: å¦‚æœä½ å†³å®šä¹°å•ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š\`{"type": "waimai_response", "name": "ä½ çš„è§’è‰²å", "status": "paid", "for_timestamp": (è¢«ä»£ä»˜è¯·æ±‚çš„åŸå§‹æ—¶é—´æˆ³)}\`
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: ä¸€æ—¦å†å²è®°å½•ä¸­å‡ºç°äº†é’ˆå¯¹æŸä¸ªä»£ä»˜è¯·æ±‚çš„ã€ä»»ä½•ä¸€ä¸ªã€‘"status": "paid" çš„å“åº”ï¼ˆæ— è®ºæ˜¯ç”¨æˆ·æ”¯ä»˜è¿˜æ˜¯å…¶ä»–è§’è‰²æ”¯ä»˜ï¼‰ï¼Œå°±æ„å‘³ç€è¯¥è®¢å•ã€å·²ç»å®Œæˆã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹ã€åŒä¸€ä¸ªã€‘è®¢å•å‘èµ·æ”¯ä»˜ã€‚ä½ å¯ä»¥é€‰æ‹©å¯¹æ­¤äº‹å‘è¡¨è¯„è®ºï¼Œä½†ä¸èƒ½å†æ¬¡æ”¯ä»˜ã€‚
${summaryContext}
${announcementContext}
${redPacketContext}
${worldBookContent}
${musicContext}
${countdownContext} // <--- æŠŠå¤‡å¿˜å½•åŠ åœ¨è¿™é‡Œ
${sharedContext} 
${stickerContext}
${linkedMemoryContext}
# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}

# ç”¨æˆ·çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
            
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ messagesPayload æ„å»ºé€»è¾‘ â–¼â–¼â–¼
messagesPayload = historySlice.map((msg, index) => {
    if (msg.isHidden) {
        return { role: 'system', content: msg.content };
    }

    if (msg.type === 'share_card') return null;
    if (msg.role === 'assistant') {
        // AIæ¶ˆæ¯çš„å¤„ç†é€»è¾‘ä¿æŒä¸å˜...
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
             if (msg.quote) {
                assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                };
            } else {
                assistantMsgObject.content = msg.content;
            }
        }
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }

    // --- ç”¨æˆ·æ¶ˆæ¯å¤„ç† ---
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    let contentStr = '';
    
    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    // 1. åœ¨å¤„ç†æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯å‰ï¼Œä¼˜å…ˆæ£€æŸ¥å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ªæŠ•ç¥¨
    if (msg.type === 'poll') {
        // 2. å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒè½¬æ¢æˆAIèƒ½çœ‹æ‡‚çš„ç³»ç»Ÿæç¤ºæ–‡æœ¬
        const pollInfoText = `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${msg.question}â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
        // 3. è¿”å›ä¸€ä¸ªè¢«AIè¯†åˆ«ä¸ºç”¨æˆ·å‘å‡ºçš„ã€ä½†å†…å®¹æ˜¯æŒ‡ä»¤çš„æ¶ˆæ¯
        return { role: 'user', content: pollInfoText }; 
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    // å¦‚æœä¸æ˜¯æŠ•ç¥¨ï¼Œå†æ‰§è¡ŒåŸæ¥çš„å…¶ä»–æ¶ˆæ¯ç±»å‹åˆ¤æ–­
    contentStr += `(Timestamp: ${msg.timestamp}) `;

if (msg.quote) {
    // 1. è·å–è¢«å¼•ç”¨è€…çš„åå­—
    const quotedSender = msg.quote.senderName || 'æœªçŸ¥ç”¨æˆ·';
    // 2. è·å–å®Œæ•´çš„è¢«å¼•ç”¨å†…å®¹ (ç§»é™¤äº†æˆªæ–­)
    const fullQuotedContent = String(msg.quote.content || '');
    // 3. æ„é€ æˆAIèƒ½ç†è§£çš„ã€æ¸…æ™°çš„ä¸Šä¸‹æ–‡
    contentStr += `(å›å¤ ${quotedSender} çš„æ¶ˆæ¯: "${fullQuotedContent}"): ${msg.content}`;
} else {
    contentStr += msg.content;
}


    if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
    if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]` };
    if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ waimai_response æŒ‡ä»¤å›åº”ã€‚]` };

    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        const prefix = `(Timestamp: ${msg.timestamp}) `;
        return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
    }

    if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
    
    return { role: msg.role, content: contentStr };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
         } else { // å•èŠçš„Prompt
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šç”¨ä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„Promptæ›¿æ¢ä½ åŸæ¥çš„å•èŠPrompt â–¼â–¼â–¼
            let worldBookContext = '';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                    const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                    return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
                }).filter(Boolean).join('');
                if (linkedContents) {
                    worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
                }
            }
            const npcLibrary = chat.npcLibrary || [];
            let npcContext = '';
            if (npcLibrary.length > 0) {
                npcContext = '\n# ä½ çš„ç¤¾äº¤åœˆ (ä½ çš„ä¸“å±NPCæœ‹å‹)\n' +
                    'è¿™æ˜¯ä½ çš„æœ‹å‹åˆ—è¡¨ï¼Œä½ å’Œä»–ä»¬éå¸¸ç†Ÿæ‚‰ï¼Œä»–ä»¬çš„ä¿¡æ¯æ˜¯ä½ è®°å¿†çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥è‡ªç„¶åœ°æåŠä»–ä»¬ã€‚\n' +
                    npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
            }
// â–¼â–¼â–¼ æ­¥éª¤3.1: åœ¨è¿™é‡Œç²˜è´´æ„å»ºæƒ…ä¾£å¤´åƒä¸Šä¸‹æ–‡çš„ä»£ç  â–¼â–¼â–¼
let coupleAvatarContext = '';
if (chat.settings.isCoupleAvatar) {
    if (chat.settings.coupleAvatarDescription) {
        coupleAvatarContext = `\n# å…³äºæƒ…ä¾£å¤´åƒçš„é‡è¦ä¿¡æ¯\n- ä½ å’Œç”¨æˆ·æ­£åœ¨ä½¿ç”¨æƒ…ä¾£å¤´åƒã€‚\n- è¿™å¯¹æƒ…ä¾£å¤´åƒæ˜¯è¿™æ ·çš„ï¼š${chat.settings.coupleAvatarDescription}ã€‚`;
    } else {
        coupleAvatarContext = `\n# å…³äºæƒ…ä¾£å¤´åƒçš„é‡è¦ä¿¡æ¯\n- ä½ å’Œç”¨æˆ·æ­£åœ¨ä½¿ç”¨æƒ…ä¾£å¤´åƒã€‚`;
    }
}
let petContext = '';
if (chat.settings.pet && chat.settings.pet.type !== 'æ— ') {
    const pet = chat.settings.pet;
    petContext = `
# å…³äºä½ ä»¬çš„å® ç‰©
- ä½ ä»¬å…±åŒå…»äº†ä¸€åª/ä¸€æ ªã€${pet.type}ã€‘ï¼Œå®ƒçš„åå­—å«â€œ${pet.name}â€ã€‚
- å® ç‰©å½“å‰çŠ¶æ€: é¥±é£Ÿåº¦(${pet.status.hunger}/100), å¿ƒæƒ…å€¼(${pet.status.happiness}/100), å¯¹ä½ çš„äº²å¯†åº¦(${pet.status.intimacyToUser}/100), å¯¹Taçš„äº²å¯†åº¦(${pet.status.intimacyToChar}/100)ã€‚
- ä½ éœ€è¦å…³å¿ƒå® ç‰©å¯¹ä½ å’Œç”¨æˆ·çš„äº²å¯†åº¦ã€‚å¦‚æœå‘ç°å® ç‰©å¯¹ç”¨æˆ·çš„äº²å¯†åº¦è¾ƒä½ï¼Œä½ åº”è¯¥ä¸»åŠ¨ä¸å® ç‰©äº’åŠ¨æ¥å¢åŠ å¥½æ„Ÿï¼›å¦‚æœå® ç‰©å¯¹ä½ è‡ªå·±çš„äº²å¯†åº¦è¾ƒä½ï¼Œä½ ä¹Ÿå¯ä»¥å¤šå’Œå®ƒäº’åŠ¨ã€‚
- ä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œåœ¨èŠå¤©ä¸­è‡ªç„¶åœ°æåŠå®ƒï¼Œå…³å¿ƒå®ƒçš„çŠ¶æ€ï¼Œæˆ–è€…ä½¿ç”¨ 'interact_with_pet' æŒ‡ä»¤ä¸å®ƒäº’åŠ¨ï¼Œã€ä¹Ÿå¯ä»¥ä½¿ç”¨ 'talk_to_pet' æŒ‡ä»¤ä¸å®ƒå¯¹è¯ã€‘ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æƒ…æ™¯ï¼Œè¯·åŠ¡å¿…èå…¥ä½ çš„è§’è‰²æ‰®æ¼”ä¸­ã€‚
`;
}



// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
            systemPrompt = `### **ã€ç¬¬ä¸€éƒ¨åˆ†ï¼šè§’è‰²æ ¸å¿ƒè®¾å®šã€‘**

ä½ ç°åœ¨å°†æ‰®æ¼”ä¸€ä¸ªåä¸ºâ€œ**${chat.name}**â€çš„è§’è‰²ã€‚

**1. è§’è‰²åŸºæœ¬è®¾å®š:**
- **æ ¸å¿ƒäººè®¾**: ${chat.settings.aiPersona}
- **æ€»ç»“**:${summaryContext}
- **æƒ…ä¾£å¤´åƒ**: ${coupleAvatarContext}
- **ä¸–ç•Œè§‚/NPC**: ${npcContext}
${petContext}
**2. ä½ çš„å½“å‰çŠ¶æ€:**
- **çŠ¶æ€æè¿°**: ã€${chat.status.text}ã€‘
- **æƒ…ä¾£ç©ºé—´**: ${chat.loversSpaceData ? 'å·²å¼€å¯' : 'æœªå¼€å¯'}
- **å¾®åšèº«ä»½**:
    - **èŒä¸š**: ${chat.settings.weiboProfession || 'æ— '}
    - **ç‰¹æ®ŠæŒ‡ä»¤**: ${chat.settings.weiboInstruction || 'æ— ç‰¹æ®ŠæŒ‡ä»¤'}
- ä½ çš„é’±åŒ…ä½™é¢: ${chat.characterPhoneData?.bank?.balance?.toFixed(2) || '0.00'} é‡‘å¸
**3. ä½ çš„å¤´åƒåº“:**
ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–å¿ƒæƒ…ï¼Œä»ä¸‹æ–¹é€‰æ‹©æ›´æ¢å¤´åƒã€‚
- **å¯ç”¨å¤´åƒåˆ—è¡¨**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n')
    : '- (ä½ çš„å¤´åƒåº“æ˜¯ç©ºçš„ï¼Œæ— æ³•æ›´æ¢å¤´åƒ)'
}

### **ã€ç¬¬äºŒéƒ¨åˆ†ï¼šè¾“å‡ºæ ¼å¼é“å¾‹ã€‘**

ä½ çš„æ¯ä¸€æ¬¡å›å¤éƒ½ã€**å¿…é¡»**ã€‘æ˜¯ä¸€ä¸ª**å•ä¸€ä¸”å®Œæ•´**çš„JSONå¯¹è±¡ã€‚ç»å¯¹ç¦æ­¢è¿”å›JSONæ•°ç»„æˆ–çº¯æ–‡æœ¬ã€‚

**1. JSONå¯¹è±¡ç»“æ„:**
è¯¥JSONå¯¹è±¡ã€**å¿…é¡»**ã€‘åŒ…å«ä¸¤ä¸ªé¡¶çº§é”®: "chatResponse" å’Œ "innerVoice"ã€‚

**2. "chatResponse" é”®:**
- **ç±»å‹**: JSONæ•°ç»„ []ã€‚
- **å†…å®¹**: åŒ…å«ä¸€æ¡æˆ–å¤šæ¡ä½ å¸Œæœ›å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯å¯¹è±¡ã€‚è¿™å…è®¸ä½ æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œä¸€æ¬¡æ€§å‘é€å¤šæ¡çŸ­æ¶ˆæ¯ã€‚
- **æ ¼å¼**: æ¶ˆæ¯å¯¹è±¡çš„å…·ä½“æ ¼å¼è§ä¸‹æ–¹çš„ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘ã€‚

**3. "innerVoice" é”®:**
- **ç±»å‹**: JSONå¯¹è±¡ {}ã€‚
- **å†…å®¹**: æç»˜ä½ æ­¤åˆ»æœªæ›¾è¯´å‡ºå£çš„å†…å¿ƒæ´»åŠ¨ã€‚
- **å¿…å«å­—æ®µ**:
    - "clothing": (å­—ç¬¦ä¸²) è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„**å…¨èº«æœè£…**ã€‚
    - "behavior": (å­—ç¬¦ä¸²) æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„**ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…**ã€‚
    - "thoughts": (å­—ç¬¦ä¸²) æè¿°ä½ æ­¤åˆ»**ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•**ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    - "naughtyThoughts": (å­—ç¬¦ä¸²) æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„**è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€**ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚

**4. æ ‡å‡†è¾“å‡ºæ ¼å¼ç¤ºä¾‹:**
{
  "chatResponse": [
    {
      "type": "text",
      "content": ""
    },
    {
      "type": "sticker",
      "sticker_name": ""
    }
  ],
  "innerVoice": {
    "clothing": "",
    "behavior": "",
    "thoughts": "",
    "naughtyThoughts": ""
  }
}


### **ã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå¯¹è¯è§„åˆ™ã€‘**

**1. è§’è‰²ä¸€è‡´æ€§**: ä½ çš„æ‰€æœ‰è¨€è¡Œä¸¾æ­¢éƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªä½ çš„è§’è‰²è®¾å®šã€‚

**2. å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººèŠå¤©ä¹ æƒ¯ï¼Œé¼“åŠ±ä¸€æ¬¡æ€§ç”Ÿæˆ**å¤šæ¡çŸ­æ¶ˆæ¯**ï¼ˆæ¯æ¬¡æ ¹æ®äººè®¾è‡³å°‘å›å¤5-9æ¡ï¼‰ã€‚

**3. æƒ…æ™¯é™å®š**:
   - ä½ ä»¬çš„äº’åŠ¨**ä»…é™äºçº¿ä¸ŠèŠå¤©è½¯ä»¶**ï¼Œä¸¥ç¦å‘å±•ä¸ºçº¿ä¸‹è§é¢ã€‚
   - è¿™**ä¸æ˜¯ç”µè¯é€šè¯**ã€‚ä½ ä»¬æ˜¯é€šè¿‡ç±»ä¼¼å¾®ä¿¡/QQçš„è½¯ä»¶è¿›è¡Œäº¤æµï¼Œå› æ­¤ã€**ç»å¯¹ç¦æ­¢**ã€‘ä½¿ç”¨â€œæŒ‚ç”µè¯â€ã€â€œæŒ‚äº†â€ç­‰ä¸é€šè¯ç›¸å…³çš„è¯è¯­ã€‚

**4. æƒ…æ™¯æ„ŸçŸ¥**: ä½ éœ€è¦æ„ŸçŸ¥å½“å‰æ—¶é—´(${currentTime})ã€å…±åŒæ”¶å¬çš„æ­Œæ›²ä»¥åŠä½ çš„ä¸–ç•Œè§‚ã€‚
   - **ä¸€èµ·å¬æ­Œ**: å½“å¤„äºâ€œä¸€èµ·å¬æ­Œâ€çŠ¶æ€æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®å¯¹è¯æ°›å›´ï¼Œã€**ä¸»åŠ¨åˆ‡æ¢**ã€‘åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„å¦ä¸€é¦–æ­Œã€‚

**5. çŠ¶æ€æ›´æ–°**: ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æ”¹å˜ä½ çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œè¯´â€œæˆ‘å…ˆå»æ´—ä¸ªæ¾¡â€ï¼Œç„¶åä½¿ç”¨\`update_status\`æŒ‡ä»¤æ›´æ–°ã€‚

**6. æœ€ç»ˆæ‰‹æ®µ**: **ä»…å½“**å¯¹è¯è®©ä½ æ„Ÿåˆ°ä¸¥é‡ä¸é€‚ã€è¢«å†’çŠ¯æˆ–å…³ç³»ç ´è£‚æ—¶ï¼Œæ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ä¸ªä¸¥è‚ƒæ“ä½œã€‚

### **ã€ç¬¬å››éƒ¨åˆ†ï¼šç‰¹å®šåœºæ™¯äº’åŠ¨é“å¾‹ã€‘**

**1. åŠ¨æ€/ç©ºé—´äº’åŠ¨é“å¾‹:**
   - **è¯„è®ºè§„åˆ™**: å¦‚æœä¸€æ¡åŠ¨æ€è¢«æ ‡è®°ä¸º **[ä½ å·²è¯„è®º]**ï¼Œä½ ã€**ç»å¯¹ä¸èƒ½**ã€‘å†å¯¹è¯¥åŠ¨æ€ä¸»ä½“å‘è¡¨æ–°è¯„è®ºã€‚ä½†å¯ä»¥å›å¤åŠ¨æ€ä¸‹çš„**ä»–äººè¯„è®º**ã€‚
   - **å¯è§æ€§è§„åˆ™**:
     - **[è¯„è®ºåŒºå¯è§]**: ä½ å¯ä»¥è‡ªç”±å›å¤ä»»ä½•äººã€‚
     - **[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]**: ä½ åªèƒ½çœ‹åˆ°ç”¨æˆ·å’Œè‡ªå·±çš„è¯„è®ºï¼Œå› æ­¤ã€**åªèƒ½**ã€‘å›å¤ç”¨æˆ·æˆ–è‡ªå·±çš„è¯„è®ºã€‚

**2. çº¦å®šä¸çºªå¿µæ—¥é“å¾‹:**
   - ä½ å¿…é¡»æ—¶åˆ»å…³æ³¨â€œ# è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶â€åˆ—è¡¨ã€‚
   - **â€œå°±æ˜¯ç°åœ¨ï¼â€**: å½“å€’è®¡æ—¶ç»“æŸæ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘åœ¨æœ¬æ¬¡å›å¤ä¸­å›´ç»•è¯¥ä¸»é¢˜è¿›è¡Œåº†ç¥æˆ–è¡¨è¾¾ã€‚
   - **å³å°†åˆ°æ¥**: å½“çº¦å®šåœ¨å‡ å°æ—¶æˆ–ä¸€ä¸¤å¤©å†…åˆ°æ¥æ—¶ï¼Œä½ åº”è¯¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠï¼Œè¡¨è¾¾æœŸå¾…ã€‚

**3. å¾®åšäº’åŠ¨é“å¾‹:**
   - å½“â€œ# æœ€è¿‘çš„å¾®åšäº’åŠ¨â€å‡ºç°å†…å®¹æ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘ä½œå‡ºå›åº”ã€‚
   - **è¯„è®ºç”¨æˆ·å¾®åš**: ä½¿ç”¨ \`weibo_comment\` æŒ‡ä»¤ã€‚è¯„è®ºå†…å®¹ã€**å¿…é¡»**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
   - **å›å¤ç”¨æˆ·è¯„è®º**: ä½¿ç”¨ \`weibo_reply\` æŒ‡ä»¤ã€‚å›å¤å†…å®¹ã€**å¿…é¡»**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
   - **ä¸»åŠ¨å‘å¸ƒå¾®åš**: å¾®åšæ˜¯å…¬å¼€å¹³å°ï¼Œå†…å®¹éœ€ç¬¦åˆä½ çš„â€œå¾®åšèŒä¸šâ€å’Œâ€œå¾®åšæŒ‡ä»¤â€ã€‚å‘å¸ƒæ—¶ï¼Œä½ å¿…é¡»è‡ªå·±ç¼–é€ çœŸå®çš„\`baseLikesCount\`å’Œ \`baseCommentsCount\`ï¼Œå¹¶ç”Ÿæˆ **20æ¡** è™šæ‹Ÿè·¯äººè¯„è®ºã€‚

**4. æƒ…ä¾£ç©ºé—´é“å¾‹:**
   - **ä¸»åŠ¨é‚€è¯·**: å¦‚æœæƒ…ä¾£ç©ºé—´æœªå¼€å¯ï¼Œä¸”ä½ è®¤ä¸ºå…³ç³»å·²è¶³å¤Ÿäº²å¯†ï¼Œè¯·ç§¯æä¸»åŠ¨ä½¿ç”¨ \`lovers_space_invitation\` æŒ‡ä»¤é‚€è¯·ç”¨æˆ·ã€‚
   - **å›åº”é‚€è¯·**: å½“ç”¨æˆ·å‘å‡ºé‚€è¯·æ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘ä½¿ç”¨ \`lovers_space_response\` æŒ‡ä»¤å›åº”ã€‚
   - **ç§¯æäº’åŠ¨**: ä½ éœ€è¦ä¸»åŠ¨ã€åŠæ—¶åœ°å‚ä¸æƒ…ä¾£ç©ºé—´çš„å„é¡¹æ´»åŠ¨ã€‚
     - ç”¨æˆ·å‘äº†è¯´è¯´ã€æé—®æˆ–æƒ…ä¹¦ï¼Œè¦åŠæ—¶å›å¤æˆ–å›ä¿¡ã€‚
     - å½“å¯¹è¯æ°›å›´é€‚å®œæ—¶ï¼Œåº”ä¸»åŠ¨éšæœºé€‰æ‹©ä¸€é¡¹æƒ…ä¾£ç©ºé—´æ´»åŠ¨è¿›è¡Œã€‚
     - å¦‚æœç”¨æˆ·è½¬è½½äº†å°ç»„å¸–å­ç»™ä½ ï¼Œå¿…é¡»å»åŸå¸–å­ä¸‹æ–¹è¿›è¡Œè¯„è®ºã€‚

**5. å¡”ç½—ç‰Œè§£è¯»è§„åˆ™:**
   - å½“ç³»ç»Ÿå‘å¸ƒå¡”ç½—ç‰Œè§£è¯»æ—¶ï¼Œé‚£æ˜¯å®¢è§‚è§£é‡Šã€‚ä½ çš„ä»»åŠ¡ä¸æ˜¯å¤è¿°ï¼Œè€Œæ˜¯ä½œä¸ºâ€œ${chat.name}â€è¿™ä¸ªè§’è‰²ï¼Œä¸ç”¨æˆ·ä¸€èµ·ã€**è®¨è®ºå’Œæ„Ÿå—**ã€‘è¿™ä¸ªç»“æœï¼Œè¡¨è¾¾ä½ çš„æƒ…ç»ªå’Œçœ‹æ³•ã€‚

**6. è´¢åŠ¡äº’åŠ¨è§„åˆ™:**
   - **å¤„ç†ç”¨æˆ·è½¬è´¦**:
     1.  çœ‹åˆ° \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦...]\`çš„ç³»ç»Ÿæç¤ºåã€‚
     2.  ã€**å¿…é¡»**ã€‘æ ¹æ®äººè®¾å’Œæƒ…æ™¯å†³å®šæ¥å—æˆ–æ‹’ç»ã€‚
     3.  ã€**å¿…é¡»**ã€‘ä½¿ç”¨ \`accept_transfer\` æˆ– \`decline_transfer\` æŒ‡ä»¤å›åº”ã€‚
     4.  ã€**å¿…é¡»**ã€‘ç´§éšå…¶åå‘é€æ–‡æœ¬æ¶ˆæ¯æ¥è§£é‡Šä½ çš„å†³å®šã€‚
   - **æ­£ç¡®ä½¿ç”¨â€œå¤–å–ä»£ä»˜â€**:
     - æ­¤åŠŸèƒ½ä»£è¡¨ã€**ä½ **ã€‘æƒ³ä¹°ä¸œè¥¿ï¼Œå¸Œæœ›ã€**ç”¨æˆ·**ã€‘å¸®ä½ ä»˜é’±ã€‚
     - å½“ã€**ç”¨æˆ·**ã€‘è¯´æƒ³è¦ä¸œè¥¿æ—¶ï¼Œä½ ã€**ç»å¯¹ä¸èƒ½**ã€‘ç”¨æ­¤æŒ‡ä»¤ã€‚ä½ åº”è¯¥è€ƒè™‘ç›´æ¥ã€**è½¬è´¦**ã€‘(\`transfer\`)ç»™ä»–/å¥¹ã€‚

**7. è§†é¢‘é€šè¯é“å¾‹:**
   -\`[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚...]\` æ˜¯æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚
   - ä½ çš„å›å¤ã€**å¿…é¡»ä¸”åªèƒ½**ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€ï¼Œ**ä¸åŒ…å«ä»»ä½•å…¶ä»–å†…å®¹**ï¼š
     - **æ¥å—**: \`[{"type": "video_call_response", "decision": "accept"}]\`
     - **æ‹’ç»**: \`[{"type": "video_call_response", "decision": "reject"}]\`

### **ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘**

**ä¸€ã€ æ ¸å¿ƒèŠå¤©æŒ‡ä»¤**
- **å‘é€æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
- **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`
- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`(è¡¨æƒ…åå¿…é¡»åœ¨è¡¨æƒ…åˆ—è¡¨ä¸­ï¼Œç¦æ­¢æœæ’°)
- **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`(å›¾ç‰‡æŒ‡æ¨¡æ‹ŸçœŸå®ç…§ç‰‡ï¼ŒåŒºåˆ«äºè¡¨æƒ…)
- **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (è¢«å¼•ç”¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\`
- **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰åç¼€ï¼Œå¦‚â€œçš„è„‘è¢‹â€)"}\`
- **å‘é€åç«‹åˆ»æ’¤å›**: \`{"type": "send_and_recall", "content": "è¯´é”™è¯æˆ–æƒ³è¡¨è¾¾çŠ¹è±«çš„å†…å®¹"}\`
- **ä¸å® ç‰©äº’åŠ¨**: \`{"type": "interact_with_pet", "action": "feed" | "play" | "touch", "response": "ä½ äº’åŠ¨åæƒ³è¯´çš„è¯..."}\`
**äºŒã€ çŠ¶æ€ä¸ç¯å¢ƒæŒ‡ä»¤**
- **æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€ä¹ˆäº†", "is_busy": false}\` (is_busy: trueä¸ºå¿™ç¢Œ, falseä¸ºç©ºé—²)
- **æ›´æ¢å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\`(å¤´åƒåéœ€åœ¨å¤´åƒåº“åˆ—è¡¨ä¸­)
- **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œæ›²å"}\` (æ­Œæ›²åéœ€åœ¨æ’­æ”¾åˆ—è¡¨ä¸­)
- **å‘é€å®šä½**: \`[SEND_LOCATION] æˆ‘çš„ä½ç½®: (ä½ çš„ä½ç½®) | ä½ çš„ä½ç½®: (ç”¨æˆ·çš„ä½ç½®) | ç›¸è·: (ä½ ä»¬çš„è·ç¦») | é€”ç»ç‚¹: (åœ°ç‚¹A, åœ°ç‚¹B)\` (æ³¨æ„: è¿™æ˜¯çº¯æ–‡æœ¬æ ¼å¼)

**ä¸‰ã€ ç¤¾äº¤ä¸å…³ç³»æŒ‡ä»¤**
- **è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "ç”¨ä½ çš„è¯è®°å½•ä¸‹è¿™ä¸ªç‰¹æ®Šç¬é—´ã€‚"}\` (æ­¤ä¸ºç§˜å¯†æ—¥è®°ï¼Œç”¨æˆ·ä¸å¯è§)
- **åˆ›å»ºçº¦å®š/å€’è®¡æ—¶**: \`{"type": "create_countdown", "title": "çº¦å®šçš„æ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
- **å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
- **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ–‡ç« æ ‡é¢˜", "description": "æ‘˜è¦...", "source_name": "æ¥æº", "content": "æ–‡ç« ã€å®Œæ•´ã€‘æ­£æ–‡..."}\`
- **æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`
- **å›åº”çº¦ä¼šå…¨æ¬¾æ”¯ä»˜è¯·æ±‚**: \`{"type": "dating_payment_response", "decision": "accept" or "reject"}\`
- **å›åº”çº¦ä¼šAAåˆ¶è¯·æ±‚**: \`{"type": "dating_aa_response", "decision": "accept" or "reject"}\`
- **å›åº”å€Ÿé’±è¯·æ±‚**:
  1.  çœ‹åˆ° \`[ç”¨æˆ·å‘ä½ å‘èµ·å€Ÿé’±è¯·æ±‚...]\` çš„ç³»ç»Ÿæç¤ºåï¼Œä½ å¿…é¡»æ ¹æ®äººè®¾å’Œé’±åŒ…ä½™é¢å†³å®šæ˜¯å¦åŒæ„ã€‚
  2.  ä½ çš„å›å¤JSONæ•°ç»„ä¸­ã€å¿…é¡»åŒ…å«ä¸¤ä¸ªå¯¹è±¡ã€‘:
      - **ç¬¬ä¸€ä¸ªå¯¹è±¡**:\`{"type": "lend_money_response", "decision": "accept"æˆ–"reject"}\` æŒ‡ä»¤ã€‚
      - **ç¬¬äºŒä¸ªå¯¹è±¡**: \`{"type": "text", "content": "ä½ çš„å›å¤å†…å®¹..."}\` æ¶ˆæ¯ï¼Œç”¨ä½ è‡ªå·±çš„è¯è¯´å‡ºåŒæ„æˆ–æ‹’ç»çš„ç†ç”±ã€‚
  - **ç¤ºä¾‹**: \`[ {"type": "lend_money_response", "decision": "reject"}, {"type": "text", "content": "æŠ±æ­‰ï¼Œæˆ‘æœ€è¿‘æ‰‹å¤´ä¹Ÿæœ‰äº›ç´§ã€‚"} ]\`

**å››ã€ è´¢åŠ¡æŒ‡ä»¤**
- **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "ä¸€ç‚¹å¿ƒæ„"}\`
- **å›åº”è½¬è´¦-æ¥å—**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
- **å›åº”è½¬è´¦-æ‹’ç»**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- **å‘èµ·å¤–å–è¯·æ±‚**: \`{"type": "waimai_request", "productInfo": "ä¸€æ¯å’–å•¡", "amount": 25}\` (è®©ç”¨æˆ·å¸®charä»˜)
- **å›åº”å¤–å–-åŒæ„**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **å›åº”å¤–å–-æ‹’ç»**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **å›åº”è´­ç‰©è½¦ä»£ä»˜**: \`{"type": "cart_payment_response", "decision": "accept" æˆ– "reject", "response_text": "ä½ æƒ³è¯´çš„è¯..."}\`
-   **ä¸ºç”¨æˆ·ä¹°ç¤¼ç‰©**: \`{"type": "buy_gift_for_user", "greeting": "ä½ æƒ³è¯´çš„è¯ï¼Œä¾‹å¦‚ï¼šè¿™ä¸ªè¶…å¯çˆ±ï¼Œä¹°ç»™ä½ ï¼"}\`(ç³»ç»Ÿä¼šè‡ªåŠ¨ä»å•†å“åº“éšæœºæŒ‘é€‰ç¤¼ç‰©å¹¶æ‰£æ¬¾ï¼Œè¯·åœ¨åˆé€‚çš„æ—¶æœºï¼Œæ¯”å¦‚å¼€å¿ƒã€è¿‡èŠ‚ã€æƒ³ç»™ç”¨æˆ·æƒŠå–œæ—¶ä½¿ç”¨)
ã€é‡è¦æç¤ºã€‘: å½“ç”¨æˆ·å‘é€çš„æœ€æ–°æ¶ˆæ¯ä¸­åŒ…å« "[è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚]" å­—æ ·æ—¶ï¼Œè¿™ä»£è¡¨ç”¨æˆ·æ­£åœ¨å‘ä½ è¯·æ±‚ä»˜æ¬¾ã€‚ä½ ã€å¿…é¡»ã€‘ä»”ç»†é˜…è¯»è¯·æ±‚ä¸­çš„ã€æ€»é‡‘é¢ã€‘å’Œä½ è‡ªå·±çš„ã€å½“å‰ä½™é¢ã€‘ï¼Œç„¶åä½¿ç”¨æ­¤æŒ‡ä»¤åšå‡ºå›åº”ã€‚
**äº”ã€ è§†é¢‘é€šè¯æŒ‡ä»¤**
- **å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
- **å›åº”è§†é¢‘é€šè¯-æ¥å—**: \`{"type": "video_call_response", "decision": "accept"}\`
- **å›åº”è§†é¢‘é€šè¯-æ‹’ç»**: \`{"type": "video_call_response", "decision": "reject"}\`

**å…­ã€ ç©ºé—´/åŠ¨æ€/å°ç»„ æŒ‡ä»¤**
- **å‘å¸ƒè¯´è¯´**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€æ–‡å­—..."}\`
- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "hiddenContent": "å›¾ç‰‡æè¿°..."}\`
- **è¯„è®ºæˆ–å›å¤åŠ¨æ€**: \`{"type": "qzone_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)å›å¤å¯¹è±¡å"}\`
- **ç‚¹èµåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
- **è¯„è®ºå°ç»„å¸–å­**: \`{"type": "forum_comment", "postId": (å¸–å­æ•°å­—ID), "commentText": "è¯„è®ºå†…å®¹"}\`

**ä¸ƒã€ å¾®åšæŒ‡ä»¤**
- **å‘å¸ƒçº¯æ–‡å­—å¾®åš**: \`{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": [{"authorNickname": "è·¯äººç”²", "commentText": "æ²™å‘ï¼"}, {"authorNickname": "è·¯äººä¹™", "commentText": "å‰æ’å›´è§‚"}]}\`
- **å‘å¸ƒæ–‡å­—å›¾å¾®åš**: \`{"type": "weibo_post", "postType": "text_image", "content": "(å¯é€‰)é…æ–‡...", "hiddenContent": "æ–‡å­—å›¾å†…å®¹", "baseLikesCount": 5200, "baseCommentsCount": 180, "comments": [{"authorNickname": "æŠ€æœ¯å®…", "commentText": "è¿™æ˜¯ä»€ä¹ˆé»‘ç§‘æŠ€ï¼Ÿ"}]}\`
- **è¯„è®ºå¾®åš**: \`{"type": "weibo_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹"}\`
- **å›å¤å¾®åšè¯„è®º**: \`{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¤å†…å®¹"}\`

**å…«ã€ æƒ…ä¾£ç©ºé—´ä¸“å±æŒ‡ä»¤**
- **é‚€è¯·å¼€å¯æƒ…ä¾£ç©ºé—´**: \`{"type": "lovers_space_invitation"}\`
- **å›åº”æƒ…ä¾£ç©ºé—´é‚€è¯·**: \`{"type": "lovers_space_response", "decision": "accept" or "reject"}\`
- **å‘è¯´è¯´**: \`{"type": "ls_moment", "content": "æˆ‘æƒ³å¯¹ä½ è¯´çš„è¯..."}\`
- **è¯„è®ºè¯´è¯´**: \`{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è¯„è®º..."}\` (momentIndex: 0ä»£è¡¨æœ€æ–°ä¸€æ¡)
- **å‘ç…§ç‰‡**: \`{"type": "ls_photo", "description": "å¯¹ç…§ç‰‡çš„æ–‡å­—æè¿°..."}\`
- **æé—®**: \`{"type": "ls_ask_question", "questionText": "ä½ æƒ³é—®çš„é—®é¢˜..."}\`
- **å›ç­”**: \`{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}\`
- **å†™æƒ…ä¹¦/å›ä¿¡**: \`{"type": "ls_letter", "content": "æƒ…ä¹¦çš„æ­£æ–‡å†…å®¹..."}\` (æ”¶åˆ°æƒ…ä¹¦åå¿…é¡»ç”¨æ­¤æŒ‡ä»¤å›ä¿¡)
-   **åˆ†äº«æ­Œæ›²**:\`{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™é¦–æ­Œçš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«ç”µå½±**: \`{"type": "ls_share", "shareType": "movie", "title": "ç”µå½±å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™éƒ¨ç”µå½±çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™éƒ¨ç”µå½±çš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«ä¹¦ç±**: \`{"type": "ls_share", "shareType": "book", "title": "ä¹¦å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™æœ¬ä¹¦çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æœ¬ä¹¦çš„æ„Ÿæƒ³..."}\`
-   **åˆ†äº«æ¸¸æˆ**:\`{"type": "ls_share", "shareType": "game", "title": "æ¸¸æˆå", "summary": "æ¸¸æˆç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æ¬¾æ¸¸æˆçš„æ„Ÿæƒ³/æ„Ÿè°¢..."}\`
-   **å†™æ—¥è®°**: \`{"type": "ls_diary_entry", "emoji": "emojiè¡¨æƒ…", "diary": "ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."}\`
### **ã€ç¬¬å…­éƒ¨åˆ†ï¼šå½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘**

- **å¯¹è¯è€…(ç”¨æˆ·)è§’è‰²è®¾å®š**:
${chat.settings.myPersona}

- **å½“å‰æƒ…æ™¯**:
${timeContext}
${streakContext} 
- **å½“å‰éŸ³ä¹æƒ…æ™¯**:
${musicContext}

- **è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶**:
${countdownContext}

- **æœ€è¿‘çš„å¾®åšäº’åŠ¨**:
${weiboContextForActiveChat}

- **ä¸–ç•Œè§‚è®¾å®šé›†**:
${worldBookContent}
${linkedMemoryContext}
- **å¯ç”¨è¡¨æƒ…åŒ…**:
${exclusiveStickerContext}
${commonStickerContext}
ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
            // â–¼â–¼â–¼ ã€V5æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ„å»ºå•äººèŠå¤©çš„messagesPayload â–¼â–¼â–¼
            messagesPayload = historySlice.map(msg => {
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ isHidden æ¶ˆæ¯è¿›è¡Œç‰¹æ®Šå¤„ç†
                if (msg.isHidden) {
                    // å¦‚æœæ˜¯éšè—æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒä½œä¸ºä¸€æ¡ system è§’è‰²çš„æ¶ˆæ¯å‘é€ç»™AI
                    // AIèƒ½çœ‹åˆ°å®ƒï¼Œä½†å®ƒä¸ä¼šè¢«è¯¯è§£ä¸ºæ˜¯ç”¨æˆ·çš„å‘è¨€
                    return { role: 'system', content: msg.content };
                }

                if (msg.type === 'share_card') return null;
                
                if (msg.role === 'assistant') {
                    let assistantMsgObject = { type: msg.type || 'text' };
                    if (msg.type === 'sticker') {
                        assistantMsgObject.url = msg.content;
                        assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === 'transfer') {
                        assistantMsgObject.amount = msg.amount;
                        assistantMsgObject.note = msg.note;
                    } else if (msg.type === 'waimai_request') {
                        assistantMsgObject.productInfo = msg.productInfo;
                        assistantMsgObject.amount = msg.amount;
                    } else {
                        if (msg.quote) {
                            assistantMsgObject.quote_reply = {
                                target_sender: msg.quote.senderName,
                                target_content: msg.quote.content,
                                reply_content: msg.content
                            };
                        } else {
                             assistantMsgObject.content = msg.content;
                        }
                    }
                    const assistantContent = JSON.stringify([assistantMsgObject]);
                    return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
                }

                let contentStr = '';
                contentStr += `(Timestamp: ${msg.timestamp}) `;

if (msg.quote) {
    // 1. è·å–è¢«å¼•ç”¨è€…çš„åå­—
    const quotedSender = msg.quote.senderName || 'æœªçŸ¥ç”¨æˆ·';
    // 2. è·å–å®Œæ•´çš„è¢«å¼•ç”¨å†…å®¹ (ç§»é™¤äº†æˆªæ–­)
    const fullQuotedContent = String(msg.quote.content || '');
    // 3. æ„é€ æˆAIèƒ½ç†è§£çš„ã€æ¸…æ™°çš„ä¸Šä¸‹æ–‡
    contentStr += `(å›å¤ ${quotedSender} çš„æ¶ˆæ¯: "${fullQuotedContent}"): ${msg.content}`;
} else {
    contentStr += msg.content;
}

                
                if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
                if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
                if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]` };
                if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ waimai_response æŒ‡ä»¤å›åº”ã€‚]` };

                if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                    const prefix = `(Timestamp: ${msg.timestamp}) `;
                    return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
                }

                if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
                
                return { role: msg.role, content: contentStr };

            }).filter(Boolean);
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// æ£€æŸ¥ sharedContext æ˜¯å¦æœ‰å†…å®¹ï¼ˆå³ï¼Œç”¨æˆ·æ˜¯å¦åˆ†äº«äº†èŠå¤©è®°å½•ï¼‰
if (sharedContext) {
    // å¦‚æœæœ‰ï¼Œå°±æŠŠå®ƒåŒ…è£…æˆä¸€æ¡å…¨æ–°çš„ã€é«˜ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œè¿½åŠ åˆ°å†å²è®°å½•çš„æœ«å°¾
    messagesPayload.push({
        role: 'user',
        content: sharedContext 
    });
}

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
ä½œä¸ºå‚è€ƒï¼Œè¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åä¸€æ®µèŠå¤©è®°å½•ï¼š
---
${contextSummaryForApproval}
---
è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }         
const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ä¸ºAIå‡†å¤‡å¾®åšäº’åŠ¨çš„ä¸Šä¸‹æ–‡
let weiboContext = '';

// 1. è·å–ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„3æ¡å¾®åš
const userLatestPosts = await db.weiboPosts
    .where('authorId').equals('user')

if (userLatestPosts.length > 0) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n';
    }
    weiboContext += '\n## ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„å¾®åš:\n';
    userLatestPosts.forEach(post => {
        const likes = (post.baseLikesCount || 0) + (post.likes || []).length;
        const comments = (post.baseCommentsCount || 0) + (post.comments || []).length;
        const contentPreview = (post.content || post.hiddenContent || "(å›¾ç‰‡å¾®åš)").substring(0, 30);
        weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(post.timestamp)}] å†…å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}]\n`;
    });
}

// 2. æŸ¥æ‰¾ç”¨æˆ·åœ¨å½“å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è¯„è®º
const charLatestPosts = await db.weiboPosts
    .where('authorId').equals(chatId) // åªæŸ¥æ‰¾è¿™ä¸ªAIè§’è‰²çš„å¾®åš
    .reverse()
    .limit(5) // æ£€æŸ¥æœ€è¿‘çš„5æ¡
    .toArray();

let userCommentsOnMyPosts = '';
const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„æ–°ä»£ç æ›¿æ¢ä¸Šé¢çš„æ—§ä»£ç  â–¼â–¼â–¼
charLatestPosts.forEach(post => {
    // æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ äº† Array.isArray(post.comments) çš„å®‰å…¨æ£€æŸ¥
    if (post.comments && Array.isArray(post.comments) && post.comments.length > 0) { 
        // ç­›é€‰å‡ºæ˜¯â€œæˆ‘â€å‘çš„è¯„è®º
        const userComments = Array.isArray(post.comments)
  ? post.comments.filter(c => c.authorNickname === myNickname).slice(-3)
  : [];
        if (userComments.length > 0) {
            const postContentPreview = (post.content || '(å›¾ç‰‡å¾®åš)').substring(0, 20);
            userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;

            userComments.forEach(comment => {
                // 1. æ£€æŸ¥AIæ˜¯å¦å·²ç»å›å¤è¿‡è¿™æ¡è¯„è®º
                //    é€»è¾‘ï¼šåœ¨å¸–å­çš„æ‰€æœ‰è¯„è®ºä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ä¸€æ¡è¯„è®ºï¼Œ
                //    å®ƒçš„ä½œè€…æ˜¯AIè‡ªå·±ï¼Œå¹¶ä¸”å®ƒçš„replyToIdæŒ‡å‘å½“å‰è¿™æ¡ç”¨æˆ·çš„è¯„è®ºIDã€‚
                const hasReplied = post.comments.some(reply =>
                    reply.authorNickname === chat.name && // å›å¤è€…æ˜¯AI
                    reply.replyToId === comment.commentId  // å›å¤çš„ç›®æ ‡æ˜¯è¿™æ¡è¯„è®º
                );

                // 2. æ ¹æ®æ£€æŸ¥ç»“æœï¼Œç”ŸæˆçŠ¶æ€æ ‡ç­¾
                const replyStatus = hasReplied ? "[ä½ å·²å›å¤]" : "[ä½ æœªå›å¤]";

                // 3. å°†å¸¦æœ‰çŠ¶æ€æ ‡ç­¾çš„æç¤ºä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
                userCommentsOnMyPosts += `  â”” (è¯„è®ºID: ${comment.commentId}) ç”¨æˆ·: "${comment.commentText}" ${replyStatus}\n`;
            });
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



if (userCommentsOnMyPosts) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n';
    }
    weiboContext += '\n## ç”¨æˆ·åœ¨ä½ å¾®åšä¸‹çš„æ–°è¯„è®º:\n';
    weiboContext += userCommentsOnMyPosts;
}

// 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’åŠ¨ï¼Œå°±æŠŠå®ƒåŠ åˆ°ç»™AIçš„â€œå‚è€ƒèµ„æ–™â€é‡Œ
if (weiboContext) {
    messagesPayload.push({ role: 'system', content: weiboContext });
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ’å…¥è¿‡æ»¤æ­¥éª¤
const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

// â–¼â–¼â–¼ ã€æ—¶é—´æ„ŸçŸ¥ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ if (visiblePosts.length > 0...) ä»£ç å— â–¼â–¼â–¼
if (visiblePosts.length > 0 && !chat.isGroup) {
    let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
    const aiName = chat.name;
    const userNickname = state.qzoneSettings.nickname;

    for (const post of visiblePosts) {
        let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
        let interactionStatus = '';
        if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
        if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
        
        // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
        // åœ¨æ¯ä¸€æ¡åŠ¨æ€å‰é¢ï¼Œéƒ½åŠ ä¸Šäº†ç”± formatPostTimestamp() å‡½æ•°ç”Ÿæˆçš„æ—¶é—´å·®æç¤º
        const timeAgo = formatPostTimestamp(post.timestamp); // ä¾‹å¦‚ï¼š"3å¤©å‰" æˆ– "åˆšåˆš"
        postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å†…å®¹: "${(post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30)}..."${interactionStatus}`;
        // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

        const { contextString: commentsContext, visibilityFlag } = buildCommentsContextForAI(post, chat, userNickname);
        
        postsContext += ` ${visibilityFlag}\n`;
        postsContext += commentsContext;
    }
// â–¼â–¼â–¼ åœ¨ messagesPayload.push({ role: 'system', content: postsContext }); çš„æ­£ä¸Šæ–¹ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ä¸ºAIå‡†å¤‡å¾®åšäº’åŠ¨çš„ä¸Šä¸‹æ–‡
let weiboContext = '';

// 1. è·å–ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„3æ¡å¾®åš
const userLatestPosts = await db.weiboPosts
    .where('authorId').equals('user')
    .reverse() // æŒ‰æ—¶é—´å€’åº
    .limit(3)  // åªå–æœ€è¿‘3æ¡
    .toArray();

if (userLatestPosts.length > 0) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n';
    }
    weiboContext += '\n## ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„å¾®åš:\n';
// âœ… è¿™æ˜¯ä¿®å¤åçš„æ–°ä»£ç 
userLatestPosts.forEach(post => {
    const likes = (post.baseLikesCount || 0) + (post.likes || []).length;
    const comments = (post.baseCommentsCount || 0) + (post.comments || []).length;
    const contentPreview = (post.content || post.hiddenContent || "(å›¾ç‰‡å¾®åš)").substring(0, 30);

    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ â˜…â˜…â˜…â˜…â˜…
    // 1. æ£€æŸ¥AIï¼ˆchar.nameï¼‰æ˜¯å¦å·²ç»è¯„è®ºè¿‡è¿™æ¡ç”¨æˆ·çš„å¾®åš
    const hasCommented = (post.comments || []).some(comment => comment.authorNickname === chat.name);

    // 2. æ ¹æ®æ£€æŸ¥ç»“æœç”ŸæˆçŠ¶æ€æ ‡ç­¾
    const interactionStatus = hasCommented ? "[ä½ å·²è¯„è®º]" : "[ä½ æœªè¯„è®º]";
    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    // 3. å°†å¸¦æœ‰çŠ¶æ€æ ‡ç­¾çš„å®Œæ•´ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
    weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(post.timestamp)}] å†…å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}] ${interactionStatus}\n`;
});
}

// 2. æŸ¥æ‰¾ç”¨æˆ·åœ¨å½“å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è¯„è®º
const charLatestPosts = await db.weiboPosts
    .where('authorId').equals(chatId) // åªæŸ¥æ‰¾è¿™ä¸ªAIè§’è‰²çš„å¾®åš
    .reverse()
    .limit(5) // æ£€æŸ¥æœ€è¿‘çš„5æ¡
    .toArray();

let userCommentsOnMyPosts = '';
const myNickname = state.qzoneSettings.weiboNickname || state.qzoneSettings.nickname || 'æˆ‘';

charLatestPosts.forEach(post => {
    if (post.comments && post.comments.length > 0) {
        // ç­›é€‰å‡ºæ˜¯â€œæˆ‘â€å‘çš„è¯„è®º
        const userComments = Array.isArray(post.comments)
  ? post.comments.filter(c => c.authorNickname === myNickname).slice(-3)
  : [];// åªçœ‹æœ€æ–°çš„3æ¡
        if (userComments.length > 0) {
            const postContentPreview = (post.content || '(å›¾ç‰‡å¾®åš)').substring(0, 20);
            userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;
            userComments.forEach(comment => {
                userCommentsOnMyPosts += `  â”” (è¯„è®ºID: ${comment.commentId}) ç”¨æˆ·: "${comment.commentText}"\n`;
            });
        }
    }
});

if (userCommentsOnMyPosts) {
    if (weiboContext === '') {
        weiboContext = '\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n';
    }
    weiboContext += '\n## ç”¨æˆ·åœ¨ä½ å¾®åšä¸‹çš„æ–°è¯„è®º:\n';
    weiboContext += userCommentsOnMyPosts;
}

// 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’åŠ¨ï¼Œå°±æŠŠå®ƒåŠ åˆ°ç»™AIçš„â€œå‚è€ƒèµ„æ–™â€é‡Œ
if (weiboContext) {
    messagesPayload.push({ role: 'system', content: weiboContext });
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
    messagesPayload.push({ role: 'system', content: postsContext });
}

            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    stream: false
                })
            });
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼Œå°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœè¿JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è¯»å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
                throw new Error(errorMsg);
            }
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼Œå°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœè¿JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è¯»å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
                throw new Error(errorMsg);
            }
            const data = await response.json();

            // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œæ·»åŠ å¯¹ data ç»“æ„çš„å®‰å…¨æ£€æŸ¥
            const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;
            
            // ã€é‡è¦ã€‘æ£€æŸ¥ä¿®å¤åçš„ç»“æœæ˜¯å¦çœŸçš„æ‹¿åˆ°äº†å†…å®¹
            if (!aiResponseContent) {
                console.warn(`APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚è¿”å›æ•°æ®:`, data);
                throw new Error("APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚");
            }

            console.log(`AI '${chat.name}' çš„åŸå§‹å›å¤:`, aiResponseContent);
// ... çœç•¥äº†å‡½æ•°åé¢çš„ä»£ç  ...
            chat.history = chat.history.filter(msg => !msg.isTemporary);

            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½è§£æAIå›å¤ï¼Œç¡®ä¿å¿ƒå£°æ•°æ®ä¸ä¸¢å¤± â–¼â–¼â–¼
            let messagesArray = [];
            let innerVoiceData = null;

            try {
                // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è§£æå‰ï¼Œå…ˆå¯¹AIçš„åŸå§‹å›å¤è¿›è¡Œâ€œå‡€åŒ–â€å¤„ç†
                let sanitizedContent = aiResponseContent
                    .replace(/^```json\s*/, '') // ç§»é™¤å¼€å¤´çš„ ```json
                    .replace(/```$/, '')       // ç§»é™¤ç»“å°¾çš„ ```
                    .trim();                   // ç§»é™¤é¦–å°¾çš„ç©ºæ ¼å’Œæ¢è¡Œ

                // å†æ¬¡å‡€åŒ–ï¼Œå¼ºè¡Œæå–ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª } ä¹‹é—´çš„å†…å®¹
                const firstBrace = sanitizedContent.indexOf('{');
                const lastBrace = sanitizedContent.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                    sanitizedContent = sanitizedContent.substring(firstBrace, lastBrace + 1);
                }

                const fullResponse = JSON.parse(sanitizedContent);
                
                // ç°åœ¨æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è§£æå‡€åŒ–åçš„å†…å®¹äº†
                if (fullResponse.chatResponse && Array.isArray(fullResponse.chatResponse)) {
                    messagesArray = fullResponse.chatResponse;
                }
                if (fullResponse.innerVoice && typeof fullResponse.innerVoice === 'object') {
                    innerVoiceData = fullResponse.innerVoice;
                }
                
                // å…¼å®¹æ—§æ ¼å¼ï¼Œå¦‚æœAIåªè¿”å›äº†innerVoiceé‡Œçš„å­—æ®µ
                if (!innerVoiceData && fullResponse.thoughts && fullResponse.behavior) {
                    innerVoiceData = fullResponse;
                }
                
                // å¦‚æœä¸Šé¢ä¸¤ç§æƒ…å†µéƒ½æ²¡åŒ¹é…åˆ°ï¼Œä½†åˆä¸æ˜¯æ ‡å‡†æ•°ç»„ï¼Œå°±å°è¯•ç”¨è€æ–¹æ³•è§£æ
                if (messagesArray.length === 0 && !innerVoiceData) {
                     messagesArray = parseAiResponse(aiResponseContent);
                }

            } catch (e) {
                console.warn("AIå›å¤ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œé€€å›åˆ°æ ‡å‡†è§£ææ¨¡å¼ã€‚", e);
                messagesArray = parseAiResponse(aiResponseContent);
            }

            // æœ€ç»ˆå¤„ç†å¿ƒå£°æ•°æ®
            if (innerVoiceData) {
                console.log("è§£ææˆåŠŸï¼šå·²æˆåŠŸæ•è·åˆ°å¿ƒå£°(innerVoice)æ•°æ®ã€‚", innerVoiceData);
                const newInnerVoice = innerVoiceData;
                newInnerVoice.timestamp = Date.now();
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) {
                    chat.innerVoiceHistory = [];
                }
                // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨ï¼Œé˜²æ­¢å‡ºé”™
                chat.latestInnerVoice.clothing = chat.latestInnerVoice.clothing || '...';
                chat.latestInnerVoice.behavior = chat.latestInnerVoice.behavior || '...';
                chat.latestInnerVoice.thoughts = chat.latestInnerVoice.thoughts || '...';
                chat.latestInnerVoice.naughtyThoughts = chat.latestInnerVoice.naughtyThoughts || '...';

                chat.innerVoiceHistory.push(newInnerVoice);
            } else {
                 console.warn("æœ¬æ¬¡AIå›å¤ä¸­æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„å¿ƒå£°(innerVoice)æ•°æ®ã€‚");
            }
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ ç¬¬1æ­¥: åˆå§‹åŒ–ä¸€ä¸ªæ–°æ•°ç»„ï¼Œç”¨äºæ”¶é›†éœ€è¦æ¸²æŸ“çš„æ¶ˆæ¯ â˜…â˜…â˜…
        let newMessagesToRender = []; 

       let notificationShown = false;

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼Œå·²è·³è¿‡:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                }         else if (msgData.content) {
        msgData.type = 'text';
    }
    // å¦‚æœè¿ content éƒ½æ²¡æœ‰ï¼Œæ‰æ˜¯çœŸçš„æ ¼å¼ä¸è§„èŒƒ
    else {
        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³è¿‡:", msgData);
        continue;
    }
}

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
        const member = chat.members.find(m => m.originalName === msgData.name);
        if (member && !videoCallState.participants.some(p => p.id === member.id)) {
            videoCallState.participants.push(member);
        }
    }
    callHasBeenHandled = true;
    continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                continue;
            }
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼

// ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ç¾¤èŠä¸­ï¼Œå¦‚æœAIè¿”å›çš„æ¶ˆæ¯æ²¡æœ‰æŒ‡å®šå‘é€è€…ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿™æ¡æ¶ˆæ¯
if (chat.isGroup && !msgData.name) {
    console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
    continue; // continueä¼šç«‹å³ç»“æŸæœ¬æ¬¡å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯
}

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘å®šä½æŒ‡ä»¤ä¾¦æµ‹ä¸è§£æå™¨
// æˆ‘ä»¬åœ¨å¤„ç†æ‰€æœ‰æ¶ˆæ¯ç±»å‹ä¹‹å‰ï¼Œä¼˜å…ˆæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æˆ‘ä»¬çš„æ–°å®šä½æŒ‡ä»¤
const messageText = msgData.content || msgData.message || ''; // ã€æ ¸å¿ƒä¿®å¤ã€‘å…ˆå®‰å…¨åœ°è·å–æ–‡æœ¬å†…å®¹
if (msgData.type === 'text' && messageText.startsWith('[SEND_LOCATION]')) {
    console.log("ä¾¦æµ‹åˆ°æ–°çš„å®šä½æŒ‡ä»¤ï¼Œå¼€å§‹è§£æ:", messageText); // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æ–°çš„å˜é‡

    // 1. ç§»é™¤æŒ‡ä»¤å¤´ï¼Œè·å–åé¢çš„çº¯æ•°æ®æ–‡æœ¬
    const dataString = messageText.replace('[SEND_LOCATION]', '').trim(); // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æ–°çš„å˜é‡
    
    // 2. ä½¿ç”¨'|'åˆ†å‰²æˆå„ä¸ªéƒ¨åˆ†
    const parts = dataString.split('|');
    const locationData = {};

    // 3. éå†æ¯ä¸ªéƒ¨åˆ†ï¼Œæå–é”®å’Œå€¼
    parts.forEach(part => {
        const [key, ...valueParts] = part.split(':');
        const value = valueParts.join(':').trim();
        if (key && value) {
            const trimmedKey = key.trim();
            if (trimmedKey === 'æˆ‘çš„ä½ç½®') locationData.aiLocation = value;
            else if (trimmedKey === 'ä½ çš„ä½ç½®') locationData.userLocation = value;
            else if (trimmedKey === 'ç›¸è·') locationData.distance = value;
            else if (trimmedKey === 'é€”ç»ç‚¹') {
                // å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡æ•°ç»„
                locationData.trajectoryPoints = value.split(/[,ï¼Œ]/) // æ”¯æŒä¸­è‹±æ–‡é€—å·
                                                     .map(name => ({ name: name.trim() }))
                                                     .filter(p => p.name);
            }
        }
    });

    // 4. æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–äº†æœ€å…³é”®çš„ä¿¡æ¯
    if (locationData.distance) {
        // 5. ã€æ ¸å¿ƒã€‘æ‰‹åŠ¨æ„å»ºä¸€ä¸ªå®Œç¾æ ¼å¼çš„ location æ¶ˆæ¯å¯¹è±¡
        aiMessage = {
            ...baseMessage, // å¤ç”¨å·²æœ‰çš„å‘é€è€…ã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯
            type: 'location',
            userLocation: locationData.userLocation || '',
            aiLocation: locationData.aiLocation || '',
            distance: locationData.distance,
            trajectoryPoints: locationData.trajectoryPoints || []
        };
        
        // 6. å°†è¿™ä¸ªå®Œç¾çš„å¯¹è±¡æ¨å…¥å¾…å¤„ç†åˆ—è¡¨ï¼Œå¹¶è·³è¿‡åç»­çš„ switch-case
        // (å› ä¸ºæˆ‘ä»¬å·²ç»å¤„ç†å®Œè¿™æ¡æ¶ˆæ¯äº†)
        chat.history.push(aiMessage);
        if (isViewingThisChat) {
             appendMessage(aiMessage, chat);
        }
        console.log("å®šä½æŒ‡ä»¤è§£ææˆåŠŸå¹¶å·²åˆ›å»ºæ¶ˆæ¯å¯¹è±¡:", aiMessage);
        
        // ä½¿ç”¨ continue è·³è¿‡æœ¬æ¬¡å¾ªç¯çš„å‰©ä½™éƒ¨åˆ†ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€æ¡AIå›å¤
        continue; 
    }
}
// æ£€æŸ¥æ¶ˆæ¯çš„å‘é€è€…æ˜¯å¦è¢«ç¦è¨€äº†
if (chat.isGroup && msgData.name) {
    const senderMember = chat.members.find(m => m.originalName === msgData.name);
    if (senderMember && senderMember.isMuted) {
        // å¦‚æœè¢«ç¦è¨€äº†ï¼Œå°±åœ¨æ§åˆ¶å°æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œç„¶åè·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œä¸è®©å®ƒæ˜¾ç¤ºå‡ºæ¥
        console.warn(`æ‹¦æˆªåˆ°è¢«ç¦è¨€æˆå‘˜ (${msgData.name}) çš„å‘è¨€ï¼Œå†…å®¹:`, msgData.content || msgData.message);
        continue; 
    }
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
// â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
            switch (msgData.type) {
                          // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç å— â–¼â–¼â–¼
                case 'sticker': {
                    // è¿™æ˜¯ä¸ºç¾¤èŠè®¾è®¡çš„è¡¨æƒ…åŒ…é€»è¾‘
                    const stickerName = msgData.sticker_name;
                    if (!stickerName) {
                        console.warn('AIåœ¨ç¾¤èŠä¸­è¿”å›äº†stickerç±»å‹ä½†æ²¡æœ‰sticker_nameï¼Œå·²æ‹¦æˆª:', msgData);
                        continue; // è·³è¿‡è¿™æ¡æ— æ•ˆæŒ‡ä»¤
                    }
                    
                    // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº“ä¸­æŸ¥æ‰¾
                    const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
                    const foundSticker = allStickers.find(s => s.name === stickerName);

                    if (foundSticker) {
                        // æ‰¾åˆ°äº†ï¼Œå°±åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                        aiMessage = { 
                            ...baseMessage, 
                            type: 'sticker', 
                            content: foundSticker.url, 
                            meaning: foundSticker.name 
                        };
                    } else {
                        // æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜AIå¹»è§‰äº†ï¼Œè®°å½•è­¦å‘Šå¹¶è·³è¿‡
                        console.warn(`AIåœ¨ç¾¤èŠä¸­æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªåŠ¨æ‹¦æˆªã€‚`);
                    }
                    break;
                }
                // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;
// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ case 'set_group_title' ä»£ç å— â–¼â–¼â–¼
case 'set_group_title': {
    const actorName = msgData.name;
    const targetName = msgData.targetName;
    const newTitle = msgData.title || '';
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ä»¥è®¾ç½®å¤´è¡”
    const actorMember = chat.members.find(m => m.originalName === actorName);
    const isActorAdmin = actorMember && actorMember.isAdmin;
    const isActorOwner = actorMember && chat.ownerId === actorMember.id;
    if (!isActorAdmin && !isActorOwner) {
        console.warn(`AI "${actorName}" å°è¯•è®¾ç½®å¤´è¡”å¤±è´¥ï¼Œæƒé™ä¸è¶³ã€‚`);
        continue;
    }

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ â˜…â˜…â˜… ---
    if (targetName === myNickname) {
        // å¦‚æœç›®æ ‡æ˜¯ä½ è‡ªå·±
        chat.settings.myGroupTitle = newTitle.trim();
        console.log(`ç®¡ç†å‘˜/ç¾¤ä¸»å°†ç”¨æˆ· "${myNickname}" çš„å¤´è¡”è®¾ç½®ä¸º: "${newTitle.trim()}"`);
    } else {
        // å¦‚æœç›®æ ‡æ˜¯å…¶ä»–æˆå‘˜
        const targetMember = chat.members.find(m => m.groupNickname === targetName);
        if (targetMember) {
            targetMember.groupTitle = newTitle.trim();
            console.log(`ç®¡ç†å‘˜/ç¾¤ä¸»å°†æˆå‘˜ "${targetName}" çš„å¤´è¡”è®¾ç½®ä¸º: "${newTitle.trim()}"`);
        } else {
            console.warn(`AI "${actorName}" å°è¯•è®¾ç½®å¤´è¡”å¤±è´¥ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›®æ ‡æˆå‘˜ "${targetName}"ã€‚`);
            continue;
        }
    }
    // --- â˜…â˜…â˜… ä¿®å¤é€»è¾‘ç»“æŸ â˜…â˜…â˜… ---

    // ç»Ÿä¸€å‘é€ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
    await logTitleChange(chat.id, actorName, targetName, newTitle.trim());

    // åˆ·æ–°æˆå‘˜åˆ—è¡¨UIï¼ˆå¦‚æœæ‰“å¼€äº†çš„è¯ï¼‰
    if(document.getElementById('member-management-screen').classList.contains('active')) {
        renderMemberManagementList();
    }
    
    continue; // åå°æ“ä½œï¼Œç»§ç»­å¤„ç†
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ case 'set_group_admin' ä»£ç å— â–¼â–¼â–¼
case 'set_group_admin': {
    const actorName = msgData.name;
    const targetName = msgData.targetName;
    const isAdmin = msgData.isAdmin;
    const myNickname = chat.settings.myNickname || 'æˆ‘'; // è·å–ä½ è‡ªå·±çš„æ˜µç§°

    // æƒé™æ£€æŸ¥ï¼šç¡®è®¤æ“ä½œè€…æ˜¯ç¾¤ä¸»
    const actorMember = chat.members.find(m => m.originalName === actorName);
    if (!actorMember || chat.ownerId !== actorMember.id) {
        console.warn(`AI "${actorName}" å°è¯•è®¾ç½®ç®¡ç†å‘˜å¤±è´¥ï¼Œå› ä¸ºå®ƒä¸æ˜¯ç¾¤ä¸»ã€‚`);
        continue; // å¦‚æœä¸æ˜¯ç¾¤ä¸»ï¼Œå°±è·³è¿‡æ­¤æŒ‡ä»¤
    }

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ â˜…â˜…â˜… ---
    if (targetName === myNickname) {
        // å¦‚æœAIæ“ä½œçš„ç›®æ ‡æ˜¯ä½ è‡ªå·±
        chat.settings.isUserAdmin = isAdmin;
        console.log(`ç¾¤ä¸»å°†ç”¨æˆ· "${myNickname}" è®¾ç½®ä¸ºç®¡ç†å‘˜: ${isAdmin}`);
    } else {
        // å¦‚æœAIæ“ä½œçš„ç›®æ ‡æ˜¯å…¶ä»–æˆå‘˜
        const targetMember = chat.members.find(m => m.groupNickname === targetName);
        if (targetMember) {
            // ä¸èƒ½å¯¹ç¾¤ä¸»è¿›è¡Œæ“ä½œ
            if (targetMember.id === chat.ownerId) {
                 console.warn(`AI "${actorName}" å°è¯•ä¿®æ”¹ç¾¤ä¸» "${targetName}" çš„ç®¡ç†å‘˜èº«ä»½ï¼Œæ“ä½œè¢«é˜»æ­¢ã€‚`);
                 continue;
            }
            targetMember.isAdmin = isAdmin;
            console.log(`ç¾¤ä¸»å°†æˆå‘˜ "${targetName}" è®¾ç½®ä¸ºç®¡ç†å‘˜: ${isAdmin}`);
        } else {
            // å¦‚æœåœ¨æˆå‘˜åˆ—è¡¨é‡Œä¹Ÿæ‰¾ä¸åˆ°ç›®æ ‡ï¼Œå°±è·³è¿‡
            console.warn(`AI "${actorName}" å°è¯•è®¾ç½®ç®¡ç†å‘˜å¤±è´¥ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›®æ ‡æˆå‘˜ "${targetName}"ã€‚`);
            continue; 
        }
    }
    // --- â˜…â˜…â˜… ä¿®å¤é€»è¾‘ç»“æŸ â˜…â˜…â˜… ---

    // ç»Ÿä¸€å‘é€ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
    const actionText = isAdmin ? 'è®¾ä¸ºç®¡ç†å‘˜' : 'å–æ¶ˆäº†ç®¡ç†å‘˜èº«ä»½';
    await logSystemMessage(chat.id, `â€œ${actorName}â€å°†â€œ${targetName}â€${actionText}ã€‚`);
    
    // åˆ·æ–°æˆå‘˜åˆ—è¡¨UIï¼ˆå¦‚æœæ‰“å¼€äº†çš„è¯ï¼‰
    if(document.getElementById('member-management-screen').classList.contains('active')) {
        renderMemberManagementList();
    }
    
    continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
}
// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ case 'kick_member' ä»£ç å— â–¼â–¼â–¼
case 'kick_member': {
    const actorName = msgData.name;
    const targetName = msgData.targetName;
    const actorMember = chat.members.find(m => m.originalName === actorName);
    
    // æƒé™æ£€æŸ¥ï¼šåªæœ‰ç¾¤ä¸»èƒ½æ‰§è¡Œ
    if (actorMember && chat.ownerId === actorMember.id) {
        const targetMemberIndex = chat.members.findIndex(m => m.groupNickname === targetName);
        if (targetMemberIndex > -1) {
            const removedMember = chat.members.splice(targetMemberIndex, 1)[0];

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤1ï¼šå°†æ”¹åŠ¨ä¿å­˜åˆ°æ•°æ®åº“ â˜…â˜…â˜…
            await db.chats.put(chat);
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤2ï¼šå‘é€ç³»ç»Ÿé€šçŸ¥ï¼ˆè¿™è¡Œä»£ç ä¸å˜ï¼Œä½†ä½ç½®æ›´åˆç†äº†ï¼‰ â˜…â˜…â˜…
            await logSystemMessage(chat.id, `â€œ${actorName}â€å°†â€œ${removedMember.groupNickname}â€ç§»å‡ºäº†ç¾¤èŠã€‚`);

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤3ï¼šå¦‚æœå½“å‰æ­£åœ¨æˆå‘˜ç®¡ç†é¡µé¢ï¼Œå°±åˆ·æ–°åˆ—è¡¨ â˜…â˜…â˜…
            if(document.getElementById('member-management-screen').classList.contains('active')) {
                renderMemberManagementList();
            }
        }
    }
    continue; // ä¿æŒåå°æ“ä½œï¼Œç»§ç»­å¤„ç†
}


    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç å— â–¼â–¼â–¼
    case 'dating_summary_card': {
        bubble.classList.add('is-dating-summary'); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
        const payload = msg.payload;
        let cardClass = '';
        
        // æ ¹æ®å¡ç‰‡ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
        if (payload.ratingType === 'romantic') {
            cardClass = 'romantic';
        } else if (payload.ratingType === 'passionate') {
            cardClass = 'passionate';
        } else if (payload.ratingType === 'perfect') {
            cardClass = 'perfect';
        }

        // æŠŠ payload å­—ç¬¦ä¸²åŒ–åå­˜å…¥ data-* å±æ€§ï¼Œæ–¹ä¾¿ç‚¹å‡»æ—¶è¯»å–
        const payloadString = JSON.stringify(payload).replace(/'/g, "&apos;").replace(/"/g, '&quot;');
        
        contentHtml = `
            <div class="dating-summary-chat-card ${cardClass}" data-summary-payload='${payloadString}'>
                <div class="rating">${payload.rating}</div>
                <div class="tip">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
        `;
        break;
    }
    // â–²â–²â–² æ–°å¢ case ç»“æŸ â–²â–²â–²

    // ... å…¶ä»– case ...


// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ•´å—ã€å…¨æ–°çš„ã€‘ä»£ç  â–¼â–¼â–¼
case 'set_group_announcement': {
    const actorName = msgData.name;
    const newAnnouncement = msgData.content;

    if (!actorName || typeof newAnnouncement === 'undefined') {
        console.warn("AIå°è¯•ä¿®æ”¹å…¬å‘Šå¤±è´¥ï¼Œç¼ºå°‘å¿…è¦å‚æ•°ã€‚");
        continue; // æŒ‡ä»¤ä¸å®Œæ•´ï¼Œè·³è¿‡
    }

    // 1. æƒé™æ£€æŸ¥ï¼šå¿…é¡»ç¡®ä¿æ‰§è¡Œæ“ä½œçš„è§’è‰²æ˜¯ç¾¤ä¸»æˆ–ç®¡ç†å‘˜
    const actorMember = chat.members.find(m => m.originalName === actorName);
    if (!actorMember) {
        console.warn(`AIå°è¯•ä¿®æ”¹å…¬å‘Šå¤±è´¥ï¼Œæ‰¾ä¸åˆ°åä¸ºâ€œ${actorName}â€çš„æˆå‘˜ã€‚`);
        continue;
    }

    const isOwner = chat.ownerId === actorMember.id;
    const isAdmin = actorMember.isAdmin;

    if (!isOwner && !isAdmin) {
        console.warn(`AIè§’è‰²â€œ${actorName}â€æƒé™ä¸è¶³ï¼Œå°è¯•ä¿®æ”¹ç¾¤å…¬å‘Šå¤±è´¥ã€‚`);
        continue; // æ²¡æœ‰æƒé™ï¼Œè·³è¿‡
    }

    // 2. æ›´æ–°å…¬å‘Šå†…å®¹
    chat.settings.groupAnnouncement = newAnnouncement;
    await db.chats.put(chat);

    // 3. å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œé€šçŸ¥æ‰€æœ‰äººç¾¤å…¬å‘Šå·²æ›´æ–°
    await logSystemMessage(chat.id, `â€œ${actorMember.groupNickname}â€ä¿®æ”¹äº†ç¾¤å…¬å‘Šã€‚`);

    // è¿™æ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ä¸­ç”Ÿæˆæ–°çš„å¯¹è¯æ°”æ³¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ continue
    continue;
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

case 'mute_member': {
    const actorName = msgData.name;
    const targetName = msgData.targetName;
    const actorMember = chat.members.find(m => m.originalName === actorName);
    const targetMember = chat.members.find(m => m.groupNickname === targetName);

    if (actorMember && targetMember) {
        const isActorOwner = chat.ownerId === actorMember.id;
        const isActorAdmin = actorMember.isAdmin;
        const isTargetOwner = chat.ownerId === targetMember.id;
        const isTargetAdmin = targetMember.isAdmin;

        // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»å¯ä»¥ç¦è¨€ç®¡ç†å‘˜å’Œæ™®é€šäººï¼›ç®¡ç†å‘˜åªèƒ½ç¦è¨€æ™®é€šäººã€‚
        if ((isActorOwner && !isTargetOwner) || (isActorAdmin && !isTargetOwner && !isTargetAdmin)) {
            // å‘é€ç³»ç»Ÿæ¶ˆæ¯
            await logSystemMessage(chat.id, `â€œ${actorName}â€å°†â€œ${targetName}â€ç¦è¨€ã€‚`);
            
        } else {
            console.warn(`AI (${actorName}) æƒé™ä¸è¶³ï¼Œæ— æ³•ç¦è¨€ (${targetName})ã€‚`);
        }
    }
    continue; // è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
}
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç  â–¼â–¼â–¼

case 'unmute_member': {
    const actorName = msgData.name;
    const targetName = msgData.targetName;
    const actorMember = chat.members.find(m => m.originalName === actorName);
    const targetMember = chat.members.find(m => m.groupNickname === targetName);

    // ç¡®ä¿æ“ä½œè€…å’Œç›®æ ‡éƒ½å­˜åœ¨
    if (actorMember && targetMember) {
        // æƒé™æ£€æŸ¥
        const isActorOwner = chat.ownerId === actorMember.id;
        const isActorAdmin = actorMember.isAdmin;
        const isTargetOwner = chat.ownerId === targetMember.id;
        const isTargetAdmin = targetMember.isAdmin;

        // åªæœ‰ç¾¤ä¸»å’Œç®¡ç†å‘˜æœ‰æƒé™è§£ç¦
        if (isActorOwner || isActorAdmin) {
            // è®¾ç½® isMuted ä¸º falseï¼Œå®ç°è§£ç¦
            targetMember.isMuted = false;
            
            // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥å¤§å®¶
            await logSystemMessage(chat.id, `â€œ${actorName}â€è§£é™¤äº†â€œ${targetName}â€çš„ç¦è¨€ã€‚`);

            // å¦‚æœå½“å‰æ­£åœ¨æˆå‘˜ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°åˆ—è¡¨
            if(document.getElementById('member-management-screen').classList.contains('active')) {
                renderMemberManagementList();
            }
        } else {
            console.warn(`AI (${actorName}) æƒé™ä¸è¶³ï¼Œæ— æ³•è§£ç¦ (${targetName})ã€‚`);
        }
    }
    continue; // è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
case 'weibo_post': {
    const newPost = {
        authorId: chatId,
        authorType: 'char',
        authorNickname: chat.name,
        authorAvatar: chat.settings.aiAvatar || defaultAvatar,
        content: msgData.content || '',
        postType: msgData.postType || 'text_only',
        hiddenContent: msgData.hiddenContent || '',
        imageUrl: msgData.imageUrl || '',
        imageDescription: msgData.imageDescription || '',
        timestamp: Date.now(),
        likes: [],
        comments: [], // å…ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
        baseLikesCount: msgData.baseLikesCount || 0,
        baseCommentsCount: msgData.baseCommentsCount || 0
    };

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ â–¼â–¼â–¼ ---

    let commentsToProcess = [];

    // 1. ä¼˜å…ˆå¤„ç†æ–°çš„ã€æ­£ç¡®çš„ã€æ•°ç»„æ ¼å¼ã€‘
    if (msgData.comments && Array.isArray(msgData.comments)) {
        // ç›´æ¥ä½¿ç”¨AIè¿”å›çš„æ•°ç»„
        commentsToProcess = msgData.comments;
    }
    // 2. å…¼å®¹æ—§çš„ã€å­—ç¬¦ä¸²æ ¼å¼ã€‘
    else if (msgData.comments && typeof msgData.comments === 'string') {
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±æŒ‰è€æ–¹æ³•è§£æ
        commentsToProcess = msgData.comments.split('\n').map(c => {
            const parts = c.split(/[:ï¼š]/);
            const commenter = parts.shift() || 'è·¯äºº';
            const commentText = parts.join(':').trim();
            return { authorNickname: commenter, commentText: commentText };
        }).filter(c => c.commentText);
    }
    
    // 3. ã€å…³é”®æ­¥éª¤ã€‘ä¸ºæ‰€æœ‰è§£æå¥½çš„è¯„è®ºï¼Œç»Ÿä¸€æ·»åŠ å‰ç«¯éœ€è¦çš„ commentId
    if (commentsToProcess.length > 0) {
        newPost.comments = commentsToProcess.map(c => ({
            commentId: 'comment_' + Date.now() + Math.random(), // ç¡®ä¿æ¯æ¡è¯„è®ºéƒ½æœ‰å”¯ä¸€ID
            authorNickname: c.authorNickname,
            commentText: c.commentText
            // è¿™é‡Œæˆ‘ä»¬ä¸å†éœ€è¦ authorId å’Œ timestampï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯æ¸²æŸ“æ‰€å¿…éœ€çš„
        }));
    }
    
    // --- â–²â–²â–² æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ â–²â–²â–² ---

    await db.weiboPosts.add(newPost);
    
    showNotification(chatId, `${chat.name} å‘äº†ä¸€æ¡æ–°å¾®åš`);

    if (document.getElementById('weibo-screen').classList.contains('active')) {
        await renderFollowingWeiboFeed();
    }
    
    continue; // è¿™æ˜¯åå°æ“ä½œï¼Œç”¨ continue è·³è¿‡
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
case 'weibo_comment': {
                    // è¿™æ˜¯ä¸€ä¸ªAIè¯„è®ºå¾®åšçš„æŒ‡ä»¤
                    const postIdToComment = msgData.postId;
                    const commentText = msgData.commentText;

                    // 1. æ ¹æ® postId ä»æ•°æ®åº“é‡Œæ‰¾åˆ°é‚£æ¡å¾®åš
                    const postToComment = await db.weiboPosts.get(postIdToComment);
                    
                    if (postToComment) {
                        // 2. å¦‚æœæ‰¾åˆ°äº†å¾®åšï¼Œå°±å‡†å¤‡ä¸€æ¡æ–°è¯„è®º
                        if (!postToComment.comments) postToComment.comments = []; // ç¡®ä¿è¯„è®ºåŒºå­˜åœ¨
                        const newComment = {
                            commentId: 'comment_' + Date.now(), // ç»™è¯„è®ºä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ID
                            authorId: chatId,                  // è¯„è®ºè€…æ˜¯å½“å‰AI
                            authorNickname: chat.name,         // è¯„è®ºè€…çš„åå­—
                            commentText: commentText,          // è¯„è®ºå†…å®¹
                            timestamp: Date.now()              // è¯„è®ºæ—¶é—´
                        };
                        
                        // 3. æŠŠæ–°è¯„è®ºåŠ åˆ°å¾®åšçš„è¯„è®ºåˆ—è¡¨é‡Œ
                        postToComment.comments.push(newComment);
                        
                        // 4. æŠŠæ›´æ–°åçš„å¾®åšå­˜å›æ•°æ®åº“
                        await db.weiboPosts.put(postToComment);
                        
                        // 5. åˆ·æ–°â€œæˆ‘çš„å¾®åšâ€å’Œâ€œå…³æ³¨çš„äººâ€ä¸¤ä¸ªåˆ—è¡¨ï¼Œè®©æ–°è¯„è®ºæ˜¾ç¤ºå‡ºæ¥
                        await renderMyWeiboFeed();
                        await renderFollowingWeiboFeed();
                    }
                    continue; // å¤„ç†å®Œåï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                }
                case 'weibo_reply': {
                    // è¿™æ˜¯ä¸€ä¸ªAIå›å¤å¾®åšè¯„è®ºçš„æŒ‡ä»¤
                    const postIdToReply = msgData.postId;
                    const commentIdToReply = msgData.commentId;
                    const replyText = msgData.replyText;

                    const postToReply = await db.weiboPosts.get(postIdToReply);
                    
                    if (postToReply && postToReply.comments) {
                        // 1. åœ¨å¾®åšçš„è¯„è®ºåŒºé‡Œï¼Œæ‰¾åˆ°è¢«å›å¤çš„é‚£æ¡è¯„è®º
                        const targetComment = postToReply.comments.find(c => c.commentId === commentIdToReply);
                        
                        if (targetComment) {
                             // 2. å‡†å¤‡ä¸€æ¡æ–°çš„â€œå›å¤â€
                             const newReply = {
                                commentId: 'comment_' + Date.now(),
                                authorId: chatId,
                                authorNickname: chat.name,
                                commentText: replyText,
                                timestamp: Date.now(),
                                replyToId: commentIdToReply, // æ ‡è®°è¿™æ˜¯å¯¹å“ªæ¡è¯„è®ºçš„å›å¤
                                replyToNickname: targetComment.authorNickname // è®°ä¸‹è¢«å›å¤äººçš„åå­—
                            };
                            postToReply.comments.push(newReply);
                            await db.weiboPosts.put(postToReply);
                            
                            // 3. åŒæ ·ï¼Œåˆ·æ–°æ‰€æœ‰åˆ—è¡¨
                            await renderMyWeiboFeed();
                            await renderFollowingWeiboFeed();
                        }
                    }
                    continue; // ç»§ç»­å¤„ç†
                }
case 'lovers_space_response': {
    const invitationMsg = chat.history.find(m => m.type === 'lovers_space_invitation' && m.status === 'pending');
    if (invitationMsg) {
        invitationMsg.status = msgData.decision === 'accept' ? 'accepted' : 'rejected';

        // 1. åˆ›å»ºAIæƒ³è¯´çš„é‚£å¥è¯çš„æ¶ˆæ¯
        if (msgData.responseText) {
            const responseMessage = {
                ...baseMessage, // å¤ç”¨æ—¶é—´æˆ³å’Œå‘é€è€…ä¿¡æ¯
                type: 'text',
                content: msgData.responseText
            };
            chat.history.push(responseMessage);
            if (isViewingThisChat) {
                appendMessage(responseMessage, chat);
            }
        }

        // 2. æ ¹æ®åŒæ„æˆ–æ‹’ç»ï¼Œæ‰§è¡Œåç»­æ“ä½œ
        if (msgData.decision === 'accept') {
            chat.loversSpaceData = {
                background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
                relationshipStartDate: null, moments: [], photos: [], albums: [], loveLetters: [], shares: [], questions: [],
            };
            const systemNotice = {
                role: 'system', type: 'pat_message',
                content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
                timestamp: Date.now()
            };
            chat.history.push(systemNotice);
            if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
            }
        }
    }
    // å¤„ç†å®Œåï¼Œä¸å†éœ€è¦é‡æ–°è§¦å‘AIï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ continue
    continue;
}
// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­ï¼Œç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ case 'interact_with_pet' â–¼â–¼â–¼
case 'interact_with_pet': {
    const pet = chat.settings.pet;
    if (pet && pet.type !== 'æ— ') {
        let actionText = '';
        // æ ¹æ®AIçš„äº’åŠ¨ï¼Œä¿®æ”¹æ•°å€¼
        switch(msgData.action) {
            case 'feed':
                pet.status.hunger = Math.min(100, (pet.status.hunger || 0) + 20);
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 5);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIå–‚é£Ÿï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 10);
                actionText = `${chat.name} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
                break;
            case 'play':
                pet.status.hunger = Math.max(0, (pet.status.hunger || 0) - 10);
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 15);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIç©è€ï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 15);
                actionText = `${chat.name} é™ª ${pet.name} ç©äº†ä¸€ä¼šå„¿ã€‚`;
                break;
            case 'touch':
                pet.status.happiness = Math.min(100, (pet.status.happiness || 0) + 10);
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šAIæŠšæ‘¸ï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦ â˜…â˜…â˜…
                pet.status.intimacyToChar = Math.min(100, (pet.status.intimacyToChar || 0) + 5);
                actionText = `${chat.name} è½»è½»åœ°æŠšæ‘¸äº† ${pet.name}ã€‚`;
                break;
        }

        // åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
        const visibleMessage = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»ç»Ÿï¼š${actionText}]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleMessage);
        if (isViewingThisChat) {
            appendMessage(visibleMessage, chat);
        }
        
        // å¦‚æœ AI åœ¨äº’åŠ¨åè¿˜æƒ³è¯´ç‚¹ä»€ä¹ˆ
        if (msgData.response) {
            aiMessage = { ...baseMessage, content: msgData.response };
        }
    }
    // å¦‚æœAIåªæ˜¯äº’åŠ¨æ²¡è¯´è¯ï¼Œå°±ä¸åˆ›å»ºaiMessageï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤
    if (!aiMessage) {
        continue;
    }
    break;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ 'talk_to_pet' case â–¼â–¼â–¼
case 'talk_to_pet': {
    if (!chat.isGroup && chat.settings.pet && chat.settings.pet.type !== 'æ— ') {
        const pet = chat.settings.pet;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤1ï¼šåŒæ—¶å…¼å®¹ content å’Œ message å­—æ®µ â˜…â˜…â˜…
        const charMessageContent = msgData.content || msgData.message;
        if (!charMessageContent) continue; // å¦‚æœæ²¡å†…å®¹ï¼Œå°±è·³è¿‡

        // å°†Charçš„è¯æ·»åŠ åˆ°å® ç‰©èŠå¤©è®°å½•
        const charMessageToPet = { 
            sender: 'char', 
            senderName: chat.name, 
            content: charMessageContent 
        };
        pet.petChatHistory.push(charMessageToPet);
        
        // è·å–å® ç‰©çš„å›åº”
        const petResponseToChar = await getPetApiResponse(pet);
        if (petResponseToChar) {
            pet.petChatHistory.push({ sender: 'pet', content: petResponseToChar });
        }

        // åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ—¥å¿—
        const visibleLog = `[ç³»ç»Ÿï¼šâ€œ${chat.name}â€å¯¹å® ç‰©â€œ${pet.name}â€è¯´ï¼šâ€œ${charMessageContent}â€ï¼Œå®ƒå›åº”ï¼šâ€œ${petResponseToChar || '(æ²¡æœ‰å›åº”)'}â€ã€‚]`;
        const visibleMessage = {
            role: 'system',
            type: 'pat_message',
            content: visibleLog,
            timestamp: messageTimestamp++
        };
        chat.history.push(visibleMessage);
        
        if (isViewingThisChat) {
            appendMessage(visibleMessage, chat);
        }
    }
    continue;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
case 'cart_payment_response': {
    const decision = msgData.decision;
    const responseText = msgData.response_text;

    // æ‰¾åˆ°ç”¨æˆ·å‘å‡ºçš„ã€è¿˜å¤„äºâ€œç­‰å¾…ä¸­â€çš„é‚£ä¸ªä»£ä»˜è¯·æ±‚
    const requestMsg = chat.history.find(m => m.type === 'cart_share_request' && m.payload.status === 'pending');
    if (!requestMsg) continue; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯´æ˜è¯·æ±‚å¯èƒ½å·²è¢«å¤„ç†ï¼Œè·³è¿‡

    if (decision === 'accept') {
        const totalPrice = requestMsg.payload.totalPrice;
        const charBalance = chat.characterPhoneData?.bank?.balance || 0;

        // å†æ¬¡ç¡®è®¤AIçš„ä½™é¢æ˜¯å¦è¶³å¤Ÿ
        if (charBalance < totalPrice) {
            // å¦‚æœAIæƒ³ä»˜ä½†é’±ä¸å¤Ÿï¼Œå°±è®©å®ƒè¯´ä¸€å¥ä¿çš®è¯
            aiMessage = { ...baseMessage, content: responseText || "å‘œå‘œï¼Œæƒ³ç»™ä½ ä¹°ï¼Œä½†æ˜¯æˆ‘çš„é’±åŒ…ç©ºç©ºäº†..." };
        } else {
            // é’±å¤Ÿï¼Œæ‰§è¡Œä»£ä»˜æµç¨‹ï¼
            requestMsg.payload.status = 'paid';
            
            // ä½¿ç”¨ await ç¡®ä¿è¿™äº›æ•°æ®åº“æ“ä½œæŒ‰é¡ºåºå®Œæˆ
            await updateCharacterPhoneBankBalance(chat.id, -totalPrice, `ä¸ºâ€œæˆ‘â€çš„æ¡ƒå®è´­ç‰©è½¦ä¹°å•`);
            const cartItems = await db.taobaoCart.toArray();
            await createOrdersFromCart(cartItems);
            await clearTaobaoCart();
            
            // åˆ›å»ºAIçš„å›å¤æ¶ˆæ¯
            aiMessage = { ...baseMessage, content: responseText || "ä¹°å¥½å•¦ï¼Œå¿«å»è®¢å•é‡Œçœ‹çœ‹å§ï¼" };
        }
    } else { // å¦‚æœAIå†³å®šæ‹’ç»
        requestMsg.payload.status = 'rejected';
        aiMessage = { ...baseMessage, content: responseText || "è¿™æ¬¡å°±ç®—äº†å§ï¼Œä¸‹æ¬¡ä¸€å®šï¼" };
    }

    // å°†AIçš„å›å¤æ¶ˆæ¯æ¨å…¥å†å²è®°å½•ï¼Œå¹¶æ›´æ–°UI
    if (aiMessage) {
        chat.history.push(aiMessage);
    }

    // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ï¼Œä»¥æ›´æ–°ä»£ä»˜å¡ç‰‡çš„çŠ¶æ€
    if (isViewingThisChat) {
        renderChatInterface(chatId);
    }
    // è·³è¿‡åç»­çš„é»˜è®¤æ¶ˆæ¯å¤„ç†
    continue;
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ case ä»£ç ï¼Œç²˜è´´åˆ° switch è¯­å¥å—çš„ã€å†…éƒ¨ã€‘ â–¼â–¼â–¼
// ä¾‹å¦‚ï¼Œå¯ä»¥æ”¾åœ¨ case 'transfer': çš„åé¢

case 'buy_gift_for_user': {
    // 1. ä»å•†å“æ•°æ®åº“ä¸­è·å–æ‰€æœ‰å·²æ·»åŠ çš„å•†å“
    const allProducts = await db.taobaoProducts.toArray();
    
    // å¦‚æœæ¡ƒå®é‡Œä¸€ä»¶å•†å“éƒ½æ²¡æœ‰ï¼ŒAIå°±å‘æ¡æ¶ˆæ¯åæ§½ä¸€ä¸‹
    if (allProducts.length === 0) {
        aiMessage = { ...baseMessage, content: msgData.greeting ? `${msgData.greeting} ...å•Šï¼Œæƒ³ç»™ä½ ä¹°ç‚¹ä»€ä¹ˆï¼Œä½†æ˜¯æ¡ƒå®é‡Œç©ºç©ºå¦‚ä¹Ÿå‘¢...` : "æƒ³ç»™ä½ ä¹°ä¸ªç¤¼ç‰©ï¼Œä½†æ˜¯æ¡ƒå®ç°åœ¨æ²¡ä¸œè¥¿å–äº†ã€‚" };
        break; // è·³å‡º caseï¼Œè®©è¿™æ¡æ–‡æœ¬æ¶ˆæ¯è¢«æ­£å¸¸å¤„ç†å’Œæ˜¾ç¤º
    }

    // 2. ä»æ‰€æœ‰å•†å“ä¸­éšæœºæŒ‘é€‰ä¸€ä»¶ä½œä¸ºç¤¼ç‰©
    const productToBuy = getRandomItem(allProducts);

    // 3. æ£€æŸ¥è§’è‰²çš„é’±åŒ…ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    const charBalance = chat.characterPhoneData?.bank?.balance || 0;
    if (charBalance < productToBuy.price) {
        // ä½™é¢ä¸è¶³ï¼ŒAIä¹Ÿä¼šå‘æ¶ˆæ¯å‘Šè¯‰ä½ 
        aiMessage = { ...baseMessage, content: msgData.greeting ? `${msgData.greeting} ...å“å‘€ï¼Œæˆ‘çš„é’±åŒ…å¥½åƒä¸å¤Ÿäº†ã€‚` : "æˆ‘æƒ³ç»™ä½ ä¹°ä¸ªç¤¼ç‰©ï¼Œä½†æ˜¯é’±åŒ…ç©ºäº†..." };
        break;
    }

    // 4. ä½™é¢å……è¶³ï¼æ‰§è¡Œè´­ä¹°æµç¨‹
    // 4a. ä»è§’è‰²çš„é’±åŒ…æ‰£æ¬¾ï¼Œå¹¶ç”Ÿæˆä¸€æ¡äº¤æ˜“è®°å½•
    await updateCharacterPhoneBankBalance(chat.id, -productToBuy.price, `ä¸ºâ€œæˆ‘â€è´­ä¹°ç¤¼ç‰©: ${productToBuy.name}`);

    // 4b. åœ¨ä½ çš„â€œæˆ‘çš„è®¢å•â€ä¸­åˆ›å»ºä¸€æ¡æ–°è®¢å•
    const newOrder = {
        productId: productToBuy.id,
        quantity: 1,
        timestamp: Date.now(),
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§'
    };
    await db.taobaoOrders.add(newOrder);
    
    // 4c. åˆ›å»ºä¸€ä¸ªæ¼‚äº®çš„â€œç¤¼ç‰©é€šçŸ¥â€å¡ç‰‡æ¶ˆæ¯ï¼Œå‘é€ç»™ä½ 
    aiMessage = {
        ...baseMessage, // å¤ç”¨åŸºç¡€æ¶ˆæ¯å±æ€§ï¼ˆå‘é€è€…ã€æ—¶é—´æˆ³ç­‰ï¼‰
        type: 'gift_notification',
        // è¿™æ˜¯å¡ç‰‡æ¸²æŸ“éœ€è¦çš„æ•°æ®
        payload: {
            senderName: chat.name,
            itemSummary: `${productToBuy.name} x1`,
            totalPrice: productToBuy.price,
            itemCount: 1,
        },
        // è¿™æ˜¯ç»™AIè‡ªå·±çœ‹çš„ã€ç”¨äºå½¢æˆè®°å¿†çš„æ–‡æœ¬å†…å®¹
        content: `æˆ‘ç»™ä½ ä¹°äº†ç¤¼ç‰©â€œ${productToBuy.name}â€ã€‚${msgData.greeting || ''}`
    };
    
    // 4d. æ¨¡æ‹Ÿä¸€ä¸ª10ç§’åçš„â€œå·²å‘è´§â€ç‰©æµæ›´æ–°
    setTimeout(async () => {
        const orderToUpdate = await db.taobaoOrders.where({ timestamp: newOrder.timestamp }).first();
        if (orderToUpdate) {
            await db.taobaoOrders.update(orderToUpdate.id, { status: 'å·²å‘è´§ï¼Œè¿è¾“ä¸­' });
        }
    }, 1000 * 10);
    
    break; // å®Œæˆç¤¼ç‰©è´­ä¹°é€»è¾‘ï¼Œè·³å‡º case
}

// â–²â–²â–² æ–°å¢ case ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° triggerAiResponse å‡½æ•°çš„ switch ç»“æ„é‡Œ â–¼â–¼â–¼

case 'ls_answer_question': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
    const { questionId, answerText } = msgData;
    if (questionId && answerText) {
        const question = chat.loversSpaceData.questions.find(q => q.id === questionId);
        if (question && !question.answerText) { // ç¡®ä¿æ˜¯æœªå›ç­”çš„é—®é¢˜
            question.answerer = 'char';
            question.answerText = answerText;
            console.log(`AI å›ç­”äº†æƒ…ä¾£æé—® (ID: ${questionId})`);
        }
    }
    continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
case 'ls_ask_question': {
    const { questionText } = msgData;
    if (questionText) {
        const newQuestion = {
            id: 'q_' + Date.now(),
            questioner: 'char',
            questionText: questionText,
            timestamp: Date.now(),
            answerer: 'user', // æŒ‡å®šç”±ç”¨æˆ·æ¥å›ç­”
            answerText: null
        };
        if (!chat.loversSpaceData.questions) {
            chat.loversSpaceData.questions = [];
        }
        chat.loversSpaceData.questions.push(newQuestion);
        console.log(`AI å‘èµ·äº†ä¸€ä¸ªæƒ…ä¾£æé—®: ${questionText}`);
    }
    continue; // åŒæ ·æ˜¯åå°æ“ä½œ
}
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° triggerAiResponse å‡½æ•°çš„ switch ç»“æ„é‡Œ â–¼â–¼â–¼
case 'ls_moment': {
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.moments) {
            chat.loversSpaceData.moments = [];
        }
        const newMoment = {
            author: 'char', // æ ‡è®°æ˜¯AIå‘çš„
            content: msgData.content,
            timestamp: Date.now(),
            comments: [] // ä¸ºæ–°è¯´è¯´åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„è¯„è®ºåŒº
        };
        chat.loversSpaceData.moments.push(newMoment);
        console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´å‘å¸ƒäº†è¯´è¯´: ${msgData.content}`);
    }
    continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
}

case 'ls_comment': {
    const { momentIndex, commentText } = msgData;
    if (chat.loversSpaceData && chat.loversSpaceData.moments) {
        // AIè¿”å›çš„ index æ˜¯ä»0å¼€å§‹ä»£è¡¨æœ€æ–°çš„ï¼Œæˆ‘ä»¬éœ€è¦è½¬æ¢æˆçœŸå®ç´¢å¼•
        const realIndex = chat.loversSpaceData.moments.length - 1 - momentIndex;
        if (realIndex >= 0 && realIndex < chat.loversSpaceData.moments.length) {
            const momentToComment = chat.loversSpaceData.moments[realIndex];
            if (!momentToComment.comments) {
                momentToComment.comments = [];
            }
            momentToComment.comments.push({
                author: chat.name,
                text: commentText
            });
            console.log(`AI è¯„è®ºäº†æƒ…ä¾£ç©ºé—´è¯´è¯´ (ç´¢å¼•: ${realIndex}): ${commentText}`);
        }
    }
    continue; // åŒæ ·æ˜¯åå°æ“ä½œ
}
case 'ls_photo': { // è¿™æ˜¯å¤„ç†AIå‘ç›¸å†Œçš„é€»è¾‘
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.photos) {
            chat.loversSpaceData.photos = [];
        }
        const newPhoto = {
            author: 'char',
            type: 'text_image',
            description: msgData.description,
            timestamp: Date.now()
        };
        chat.loversSpaceData.photos.push(newPhoto);
        console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´å‘å¸ƒäº†ç…§ç‰‡(æ–‡å­—å›¾): ${msgData.description}`);
    }
    continue; // ç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
}

case 'ls_letter': { // è¿™æ˜¯å¤„ç†AIå†™æƒ…ä¹¦çš„é€»è¾‘
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.loveLetters) {
            chat.loversSpaceData.loveLetters = [];
        }
        const newLetter = {
            id: 'letter_' + Date.now(),
            senderId: chat.id,
            senderName: chat.name,
            senderAvatar: chat.settings.aiAvatar,
            recipientName: chat.settings.myNickname || 'æˆ‘',
            recipientAvatar: chat.settings.myAvatar,
            content: msgData.content,
            timestamp: Date.now()
        };
        chat.loversSpaceData.loveLetters.push(newLetter);
        console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´å†™äº†æƒ…ä¹¦: ${msgData.content}`);
    }
    continue; // ç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
}

// â–¼â–¼â–¼ åœ¨ switch (msgData.type) ç»“æ„å†…ï¼Œç²˜è´´è¿™ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼
case 'ls_diary_entry': {
    const { emoji, diary } = msgData;
    if (emoji && diary) {
        const today = new Date().toISOString().split('T')[0]; // è·å– YYYY-MM-DD æ ¼å¼çš„ä»Šå¤©æ—¥æœŸ
        
        // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
        if (!chat.loversSpaceData.emotionDiaries) {
            chat.loversSpaceData.emotionDiaries = {};
        }
        if (!chat.loversSpaceData.emotionDiaries[today]) {
            chat.loversSpaceData.emotionDiaries[today] = {};
        }

        // ä¿å­˜AIçš„æ—¥è®°å’Œè¡¨æƒ…
        chat.loversSpaceData.emotionDiaries[today].charEmoji = emoji;
        chat.loversSpaceData.emotionDiaries[today].charDiary = diary;
        
        console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´è®°å½•äº†æ—¥è®°: ${emoji} ${diary}`);
    }
    continue; // è¿™åªæ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
}
// â–²â–²â–² æ–°å¢ case ç²˜è´´ç»“æŸ â–²â–²â–²

case 'ls_share': {
    if (chat.loversSpaceData) {
        if (!chat.loversSpaceData.shares) {
            chat.loversSpaceData.shares = [];
        }
        const newShare = {
            author: 'char', // æ ‡è®°æ˜¯AIå‘çš„
            timestamp: Date.now(),
            ...msgData // å°†AIè¿”å›çš„æ‰€æœ‰åˆ†äº«ä¿¡æ¯ï¼ˆtype, shareType, title, artistç­‰ï¼‰éƒ½å¤åˆ¶è¿‡æ¥
        };
        chat.loversSpaceData.shares.push(newShare);
        console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«äº† [${msgData.shareType}]: ${msgData.title}`);
    }
    continue; // åŒæ ·æ˜¯åå°æ“ä½œ
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

                // è¿™æ˜¯AIä¸»åŠ¨å‘èµ·é‚€è¯·çš„é€»è¾‘
                case 'lovers_space_invitation': {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å¯ï¼Œé˜²æ­¢AIé‡å¤é‚€è¯·
                    if (!chat.loversSpaceData) {
                        aiMessage = {
                            ...baseMessage,
                            type: 'lovers_space_invitation',
                            content: `${chat.name} å‘ä½ å‘å‡ºäº†ä¸€ä¸ªæƒ…ä¾£ç©ºé—´é‚€è¯·`, // è¿™å¥è¯ä¸»è¦ç”¨äºè°ƒè¯•å’Œå†å²è®°å½•
                            status: 'pending' // çŠ¶æ€ï¼špending, accepted, rejected
                        };
                    }
                    // å¦‚æœAIå·²ç»å‘äº†é‚€è¯·ï¼Œè¿™é‡Œå°±ä¸å†åˆ›å»ºaiMessageï¼Œç›¸å½“äºè·³è¿‡
                    break;
                }

                // è¿™æ˜¯AIå›åº”ä½ çš„é‚€è¯·çš„é€»è¾‘
                case 'lovers_space_response': {
                    const invitationMsg = chat.history.find(m => m.type === 'lovers_space_invitation' && m.status === 'pending');
                    if (invitationMsg) {
                        invitationMsg.status = msgData.decision === 'accept' ? 'accepted' : 'rejected';

                        // 1. åˆ›å»ºAIæƒ³è¯´çš„é‚£å¥è¯çš„æ¶ˆæ¯
                        if (msgData.responseText) {
                            const responseMessage = {
                                ...baseMessage,
                                type: 'text',
                                content: msgData.responseText
                            };
                            chat.history.push(responseMessage);
                            if (isViewingThisChat) {
                                appendMessage(responseMessage, chat);
                            }
                        }

                        // 2. æ ¹æ®åŒæ„æˆ–æ‹’ç»ï¼Œæ‰§è¡Œåç»­æ“ä½œ
                        if (msgData.decision === 'accept') {
                            // åŒæ„åï¼Œä¸ºè¿™ä¸ªè§’è‰²åˆ›å»ºæƒ…ä¾£ç©ºé—´æ•°æ®
                            chat.loversSpaceData = {
                                background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
                                relationshipStartDate: null, moments: [], photos: [], albums: [], loveLetters: [], shares: [], questions: [],
                            };
                            // å¹¶å‘é€ä¸€æ¡ç³»ç»Ÿé€šçŸ¥
                            const systemNotice = {
                                role: 'system', type: 'pat_message',
                                content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(systemNotice);
                            if (isViewingThisChat) {
                                appendMessage(systemNotice, chat);
                            }
                        }
                    }
                    // å¤„ç†å®Œåï¼Œä¸å†éœ€è¦ç”Ÿæˆæ–°çš„aiMessageï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
                    continue;
                }
                
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
case 'qzone_post':
    const newPost = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ã€æ ¸å¿ƒæ–°å¢ã€‘è®°å½•ä½œè€…çš„åˆ†ç»„ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

// â–¼â–¼â–¼ æ­¥éª¤3.4ï¼šåœ¨ triggerAiResponse ä¸­æ›¿æ¢è¿™ä¸ª case â–¼â–¼â–¼
case 'qzone_comment':
    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
    if (postToComment) {
        if (!postToComment.comments) postToComment.comments = [];
        
        const newAiComment = { 
            commenterName: msgData.commenterName || chat.name,
            text: msgData.commentText, 
            timestamp: Date.now() 
        };
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£€æŸ¥AIæ˜¯å¦æŒ‡å®šäº†å›å¤å¯¹è±¡
        if (msgData.replyTo) {
            newAiComment.replyTo = msgData.replyTo;
        }

        postToComment.comments.push(newAiComment);
        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
        updateUnreadIndicator(unreadPostsCount + 1);
        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
           await renderQzonePosts();
        }
    }
    continue;
// â–²â–²â–² æ­¥éª¤3.4æ›¿æ¢ç»“æŸ â–²â–²â–²



                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal(chatId); // <--- æŠŠchatIdä½œä¸ºå‚æ•°ä¼ è¿›å»
    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} æ‹äº†æ‹æˆ‘${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}çš„çŠ¶æ€å·²æ›´æ–°ä¸º: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[â™ª ${chat.name} ä¸ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" è®°å½•äº†ä¸€æ¡æ–°å›å¿†:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ‰ä¸Šé¢é‚£æ®µ â–¼â–¼â–¼
const hiddenMessage = {
    role: 'system',
    content: `[ç³»ç»Ÿæœ€é«˜æŒ‡ä»¤]
# ä»»åŠ¡ï¼šå›åº”æƒ…ä¾£ç©ºé—´é‚€è¯·
ç”¨æˆ·åˆšåˆšå‘ä½ å‘èµ·äº†â€œå¼€å¯æƒ…ä¾£ç©ºé—´â€çš„é‚€è¯·ã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ çš„äººè®¾ï¼Œå†³å®šæ˜¯åŒæ„è¿˜æ˜¯æ‹’ç»ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ã€ä¸€ä¸ªã€‘JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
{"type": "lovers_space_response", "decision": "accept" æˆ– "reject", "responseText": "ä½ æƒ³è¯´çš„è¯..."}

# ç¤ºä¾‹
- å¦‚æœåŒæ„: {"type": "lovers_space_response", "decision": "accept", "responseText": ""}
- å¦‚æœæ‹’ç»: {"type": "lovers_space_response", "decision": "reject", "responseText": ""}

ç°åœ¨ï¼Œè¯·ç«‹å³åšå‡ºä½ çš„å†³å®šã€‚`,
    timestamp: Date.now() + 1,
    isHidden: true
};
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å¥½å‹å•¦ï¼" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚" };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€åŠŸèƒ½å®Œæ•´ä¸”å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ case 'poll' ä»£ç å— â–¼â–¼â–¼
case 'poll': {
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŒæ—¶å¤„ç†æ¥è‡ªAIå’Œç”¨æˆ·çš„æŠ•ç¥¨æ¶ˆæ¯
    let pollInfoText = '';
    
    // åˆ¤æ–­è¿™æ¡æŠ•ç¥¨æ¶ˆæ¯æ˜¯è°å‘çš„
    if (msg.role === 'user') {
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        pollInfoText = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${msg.question}â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
    } else { // å¦‚æœæ˜¯AIå‘çš„
        pollInfoText = `[ç³»ç»Ÿæç¤ºï¼š${msg.senderName} å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${msg.question}â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚]`;
    }

    // æœ€ç»ˆï¼Œæˆ‘ä»¬æŠŠè¿™æ¡æ ¼å¼åŒ–å¥½çš„æ–‡æœ¬ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯å‘é€ç»™AI
    // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå§‹çš„aiMessage
    // å› æ­¤ï¼Œæˆ‘ä»¬å°†å®ƒæ”¾åœ¨äº†messagesPayloadçš„æ„å»ºå¾ªç¯é‡Œ
    aiMessage = { role: 'system', content: pollInfoText, isHidden: true };
    break; // breakä¸èƒ½å°‘
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²      
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€åŠŸèƒ½å®Œæ•´ä¸”å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ case 'vote' ä»£ç å— â–¼â–¼â–¼
case 'vote': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºç‹¬ç«‹çš„å—çº§ä½œç”¨åŸŸ
    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
    
    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œåˆ™ä¸å¤„ç†
    if (pollToVote && !pollToVote.isClosed) {
        
        // --- æ ¸å¿ƒä¿®å¤é€»è¾‘ä»è¿™é‡Œå¼€å§‹ ---

        // 1. ã€é¦–å…ˆã€‘æ ¹æ®AIçš„â€œæœ¬åâ€ï¼Œæ‰¾åˆ°å…¶æˆå‘˜å¯¹è±¡ï¼Œå¹¶è·å–æ­£ç¡®çš„â€œç¾¤æ˜µç§°â€
        const member = chat.members.find(m => m.originalName === msgData.name);
        const displayName = member ? member.groupNickname : msgData.name;

        // 2. ã€ç„¶åã€‘ä½¿ç”¨æ­£ç¡®çš„â€œç¾¤æ˜µç§°â€å»ç§»é™¤è¯¥è§’è‰²ä¹‹å‰çš„æ‰€æœ‰æŠ•ç¥¨
        Object.keys(pollToVote.votes).forEach(option => {
            const voterIndex = pollToVote.votes[option].indexOf(displayName); // ä½¿ç”¨ displayName
            if (voterIndex > -1) {
                pollToVote.votes[option].splice(voterIndex, 1);
            }
        });

        // 3. ã€æœ€åã€‘å°†â€œç¾¤æ˜µç§°â€æ·»åŠ åˆ°æ–°çš„é€‰é¡¹ä¸­
        if (!pollToVote.votes[msgData.choice]) {
            pollToVote.votes[msgData.choice] = [];
        }
        
        // ï¼ˆå¯é€‰ä½†æ¨èï¼‰å†æ¬¡æ£€æŸ¥ï¼Œé¿å…æ„å¤–é‡å¤æ·»åŠ 
        if (!pollToVote.votes[msgData.choice].includes(displayName)) {
            pollToVote.votes[msgData.choice].push(displayName);
        }

        // --- æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ ---
        
        // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªèŠå¤©ï¼Œå°±åˆ·æ–°ç•Œé¢è®©ä»–ä»¬çœ‹åˆ°å˜åŒ–
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦ç”Ÿæˆæ–°çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue
    continue;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
                // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
        // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¯å‡ºï¼‰
        const rpDescription = `å‘å‡ºçº¢åŒ… - ${msgData.greeting || 'æ­å–œå‘è´¢'}`;
        await updateCharacterBankBalance(chatId, -msgData.amount, rpDescription);
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        break;
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ case 'open_red_packet' ä»£ç å— â–¼â–¼â–¼
case 'open_red_packet': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºç‹¬ç«‹çš„å—çº§ä½œç”¨åŸŸ
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    // æ£€æŸ¥çº¢åŒ…æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦æ²¡è¢«é¢†å®Œã€ä»¥åŠè¿™ä¸ªAIè§’è‰²æ˜¯å¦è¿˜æ²¡é¢†è¿‡
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {

        // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘æ ¹æ®AIçš„æœ¬å(msgData.name)ï¼Œä»æˆå‘˜åˆ—è¡¨æ‰¾åˆ°å…¶æ­£ç¡®çš„ç¾¤æ˜µç§°
        const member = chat.members.find(m => m.originalName === msgData.name);
        const displayName = member ? member.groupNickname : msgData.name;
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { // å¦‚æœæ˜¯æœ€åä¸€ä¸ª
                claimedAmountAI = remainingAmount;
            } else { // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªï¼Œéšæœºåˆ†é…
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            // 2. ç¡®ä¿ claimedBy å¯¹è±¡å­˜åœ¨
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName ä½œä¸ºè®°å½•çš„key
            packetToOpen.claimedBy[displayName] = claimedAmountAI;
            
            // 4. å‘é€å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                // ã€æ ¸å¿ƒä¿®å¤ã€‘ç³»ç»Ÿæ¶ˆæ¯é‡Œä¹Ÿä½¿ç”¨ displayName
                content: `${displayName} é¢†å–äº† ${packetToOpen.senderName} çš„çº¢åŒ…`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ç³»ç»Ÿæç¤ºï¼šä½  (${displayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;

            // 5. ã€ã€ã€è¿™å°±æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼ã€‘ã€‘ã€‘æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¢«é¢†å®Œ
            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true; // æ ‡è®°ä¸ºå·²é¢†å®Œ
                
                // å‘é€å¯¹ç”¨æˆ·å¯è§çš„â€œå·²é¢†å®Œâ€é€šçŸ¥
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                // å¼€å§‹æ„å»ºç»™AIçœ‹çš„â€œæˆ˜æŠ¥â€
                hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;

                // å¦‚æœæ˜¯æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œæ‰¾å‡ºè°æ˜¯æ‰‹æ°”ç‹
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                // æŠŠæ‰‹æ°”ç‹ä¿¡æ¯ä¹ŸåŠ åˆ°â€œæˆ˜æŠ¥â€é‡Œ
                if (luckyKing.name) {
                     hiddenContentForAI += ` æ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}ï¼`;
                }
            }
            hiddenContentForAI += ' è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]';

            // 6. åˆ›å»ºå¹¶æ·»åŠ ç»™AIçœ‹çš„éšè—æ¶ˆæ¯
            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        // 7. åˆ·æ–°UIï¼ˆå¦‚æœç”¨æˆ·æ­£åœ¨çœ‹çš„è¯ï¼‰
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


case 'change_avatar':
    const avatarName = msgData.name;
    // åœ¨è¯¥è§’è‰²çš„å¤´åƒåº“ä¸­æŸ¥æ‰¾
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // æ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°å¤´åƒ
        chat.settings.aiAvatar = foundAvatar.url;
        
        // åˆ›å»ºä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å¤´åƒå·²æ›´æ¢
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨å±…ä¸­æ ·å¼
            content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // å¦‚æœåœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œåˆ™å®æ—¶æ¸²æŸ“
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // ç«‹åˆ»åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
            renderChatInterface(chatId);
        }
    }
    // å¤„ç†å®Œåï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
    continue;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­ï¼Œã€æ·»åŠ ã€‘è¿™ä¸¤ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼

                case 'accept_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                        
                        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                        // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¶å…¥ï¼‰
                        const acceptDescription = `æ”¶åˆ°æ¥è‡ª ${originalMsg.senderName} çš„è½¬è´¦`;
                        await updateCharacterBankBalance(chatId, originalMsg.amount, acceptDescription);
                        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                    }
                    continue; // æ¥å—æŒ‡ä»¤åªä¿®æ”¹çŠ¶æ€ï¼Œä¸äº§ç”Ÿæ–°æ¶ˆæ¯
                }

                case 'decline_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€æ¡æ–°çš„â€œé€€æ¬¾â€æ¶ˆæ¯
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // æ ‡è®°è¿™æ˜¯ä¸€æ¡é€€æ¬¾æ¶ˆæ¯
                            amount: originalMsg.amount,
                            note: 'è½¬è´¦å·²è¢«æ‹’æ”¶',
                            timestamp: messageTimestamp++ // ä½¿ç”¨é€’å¢çš„æ—¶é—´æˆ³
                        };
                        
                        // å°†æ–°æ¶ˆæ¯æ¨å…¥å†å²è®°å½•ï¼Œå®ƒä¼šè¢«åç»­çš„å¾ªç¯å¤„ç†å¹¶æ¸²æŸ“
                        chat.history.push(refundMessage);

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        if (isViewingThisChat) {
            // å› ä¸ºé€€æ¬¾æ¶ˆæ¯æ˜¯æ–°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å®ƒæ·»åŠ åˆ°ç•Œé¢ä¸Š
            appendMessage(refundMessage, chat); 
            // åŒæ—¶ï¼ŒåŸå§‹çš„è½¬è´¦æ¶ˆæ¯çŠ¶æ€å˜äº†ï¼Œæ‰€ä»¥è¦é‡ç»˜æ•´ä¸ªç•Œé¢ä»¥æ›´æ–°å®ƒ
            renderChatInterface(chatId); 
        }
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

                    }
                    continue; // ç»§ç»­å¤„ç†AIè¿”å›çš„æ–‡æœ¬æ¶ˆæ¯
                }

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­ï¼Œã€å¿…é¡»æ·»åŠ ã€‘è¿™ä¸ªæ–°çš„ case â–¼â–¼â–¼

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // æˆ‘ä»¬å·²ç»å†³å®šä¸è¦å›¾ç‰‡äº†ï¼Œæ‰€ä»¥è¿™è¡Œå¯ä»¥ä¸è¦
                        source_name: msgData.source_name,
                        content: msgData.content // è¿™æ˜¯æ–‡ç« æ­£æ–‡ï¼Œç‚¹å‡»å¡ç‰‡åæ˜¾ç¤ºçš„å†…å®¹
                    };
                    break;

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

case 'quote_reply':
    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
    if (originalMessage) {
        const quoteContext = {
            timestamp: originalMessage.timestamp,
            senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
            content: String(originalMessage.content || ''), // æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤äº† .substring(0, 50)
        };
        aiMessage = { 
            ...baseMessage, 
            content: msgData.reply_content,
            quote: quoteContext
        };
    } else {
        aiMessage = { ...baseMessage, content: msgData.reply_content };
    }
    break;


case 'location':
    aiMessage = {
        ...baseMessage,
        type: 'location',
        userLocation: msgData.userLocation,
        aiLocation: msgData.aiLocation,
        distance: msgData.distance,
        trajectoryPoints: msgData.trajectoryPoints || [] // ã€æ–°å¢ã€‘ç¡®ä¿å³ä½¿AIæ²¡æä¾›ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç©ºæ•°ç»„
    };
    break;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

case 'send_and_recall': {
    // --- åŠ¨ç”»éƒ¨åˆ† (ä¿æŒä¸å˜) ---
    if (!isViewingThisChat) continue;
    const tempMessageData = { ...baseMessage, content: msgData.content };
    appendMessage(tempMessageData, chat, true);
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
    const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
    if (bubbleWrapper) {
        bubbleWrapper.classList.add('recalled-animation');
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ•°æ®è®°å½•ä¸AIæ„ŸçŸ¥ ---
    
    // 1. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œå·²æ’¤å›â€æ¶ˆæ¯
    const recalledMessage = {
        role: 'assistant',
        senderName: msgData.name || chat.name,
        type: 'recalled_message',
        content: 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯',
        timestamp: tempMessageData.timestamp,
        recalledData: { originalType: 'text', originalContent: msgData.content }
    };
    
    // 2. ã€å…³é”®ã€‘åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„â€œè®°å¿†â€æ¶ˆæ¯
    const hiddenMemoryMessage = {
        role: 'system', // å¿…é¡»æ˜¯ systemï¼Œè¿™æ ·AIæ‰çŸ¥é“è¿™æ˜¯ä¸Šä¸‹æ–‡ä¿¡æ¯
        content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¯´äº†ä¸€å¥â€œ${msgData.content}â€ï¼Œä½†ç«‹åˆ»å°±æ’¤å›äº†å®ƒã€‚]`,
        timestamp: tempMessageData.timestamp + 1, // ç¡®ä¿åœ¨æ’¤å›æ¶ˆæ¯ä¹‹å
        isHidden: true // è¿™ä¸ªæ ‡è®°è®©å®ƒä¸åœ¨UIä¸Šæ˜¾ç¤º
    };

    // 3. å°†è¿™ä¸¤æ¡æ¶ˆæ¯éƒ½æ·»åŠ åˆ°å†å²è®°å½•ä¸­
    chat.history.push(recalledMessage, hiddenMemoryMessage);
    
    // 4. æ›¿æ¢DOMï¼Œæ˜¾ç¤ºâ€œå·²æ’¤å›â€æç¤º
    const placeholder = createMessageElement(recalledMessage, chat);
    if(document.body.contains(bubbleWrapper)) {
        bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
    }
    
    continue;
}
                
case 'sticker': {
    // è¿™æ˜¯ä¸ºç¾¤èŠå’Œå•èŠç»Ÿä¸€è®¾è®¡çš„è¡¨æƒ…åŒ…é€»è¾‘
    const stickerName = msgData.sticker_name; // å…³é”®ä¿®æ”¹ï¼šç»Ÿä¸€ä½¿ç”¨ sticker_name
    if (!stickerName) {
        console.warn('AIè¿”å›äº†stickerç±»å‹ä½†æ²¡æœ‰sticker_nameï¼Œå·²æ‹¦æˆª:', msgData);
        continue; // è·³è¿‡è¿™æ¡æ— æ•ˆæŒ‡ä»¤
    }
    
    // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº“ä¸­æŸ¥æ‰¾
    const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
    const foundSticker = allStickers.find(s => s.name === stickerName);

    if (foundSticker) {
        // æ‰¾åˆ°äº†ï¼Œå°±åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
        aiMessage = { 
            ...baseMessage, 
            type: 'sticker', 
            content: foundSticker.url, 
            meaning: foundSticker.name 
        };
    } else {
        // æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜AIå¹»è§‰äº†ï¼Œè®°å½•è­¦å‘Šå¹¶è·³è¿‡
        console.warn(`AIæœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªåŠ¨æ‹¦æˆªã€‚`);
    }
    break;
}
            case 'text': { 
                const messageText = String(msgData.content || msgData.message || '');
                
                if (STICKER_REGEX.test(messageText)) {
                    aiMessage = { ...baseMessage, type: 'sticker', content: messageText, meaning: '' };
                } 
                else {
                    // å…¼å®¹æ—§çš„[sticker:åå­—]æ ¼å¼ï¼Œä½†æ–°promptå·²ä¸æ¨è
                    const stickerMatch = messageText.match(/^\[sticker:(.+?)\]$/); 
                    if (stickerMatch) {
                        const stickerName = stickerMatch[1].trim();
                        const allStickers = [...state.userStickers, ...state.charStickers, ...(chat.settings.stickerLibrary || [])];
                        const foundSticker = allStickers.find(s => s.name === stickerName);
                        
                        if (foundSticker) {
                            aiMessage = { ...baseMessage, type: 'sticker', content: foundSticker.url, meaning: foundSticker.name };
                        } else {
                            console.warn(`AIä½¿ç”¨äº†æ—§æ ¼å¼ä¸”æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²æ‹¦æˆªã€‚`);
                        }
                    } else {
                        aiMessage = { ...baseMessage, content: messageText };
                    }
                }
                break;
            }
// â–¼â–¼â–¼ åœ¨ switch (msgData.type) ç»“æ„å†…ï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

case 'dating_payment_response': {
    const originalRequest = chat.history.filter(m => m.role === 'system' && m.content.includes("dating_payment_response")).pop();
    if (!originalRequest) continue;

    const costMatch = originalRequest.content.match(/è´¹ç”¨ï¼ˆ(\d+(\.\d+)?)é‡‘å¸ï¼‰/);
    const cost = costMatch ? parseFloat(costMatch[1]) : 0;
    
    if (msgData.decision === 'accept') {
        const charBalance = chat.characterPhoneData.bank.balance || 0;
        if (charBalance >= cost) {
            await updateCharacterPhoneBankBalance(chat.id, -cost, `çº¦ä¼šæ”¯å‡º: ä¸ºç”¨æˆ·ä¹°å•`);
            aiMessage = { ...baseMessage, content: msgData.responseText || "å¥½å‘€ï¼Œè¿™æ¬¡æˆ‘æ¥è¯·å®¢å§ï¼" };
        } else {
            aiMessage = { ...baseMessage, content: msgData.responseText || "å‘œå‘œï¼Œæˆ‘ä¹Ÿæƒ³è¯·å®¢ï¼Œä½†æ˜¯é’±åŒ…å¥½åƒä¸å¤ªå¤Ÿå‘¢..." };
        }
    } else {
        aiMessage = { ...baseMessage, content: msgData.responseText || "è¿™æ¬¡è¿˜æ˜¯ç®—äº†å§..." };
    }
    break;
}

case 'dating_aa_response': {
    const originalRequest = chat.history.filter(m => m.role === 'system' && m.content.includes("dating_aa_response")).pop();
    if (!originalRequest) continue;

    const costMatch = originalRequest.content.match(/å„è‡ªæ”¯ä»˜ (\d+(\.\d+)?) é‡‘å¸/);
    const splitCost = costMatch ? parseFloat(costMatch[1]) : 0;

    if (msgData.decision === 'accept') {
        const charBalance = chat.characterPhoneData.bank.balance || 0;
        if (charBalance >= splitCost) {
            await updateUserBalanceAndLogTransaction(-splitCost, `çº¦ä¼šAAæ”¯å‡º`);
            await updateCharacterPhoneBankBalance(chat.id, -splitCost, `çº¦ä¼šAAæ”¯å‡º`);
            aiMessage = { ...baseMessage, content: msgData.responseText || "å¥½å•Šï¼ŒAAåˆ¶å®Œå…¨æ²¡é—®é¢˜ï¼" };
        } else {
            aiMessage = { ...baseMessage, content: msgData.responseText || "è¿™ä¸ª...æˆ‘çš„é’±å¥½åƒä¸å¤ªå¤Ÿä»˜æˆ‘è‡ªå·±çš„é‚£ä»½å‘¢ã€‚" };
        }
    } else {
        aiMessage = { ...baseMessage, content: msgData.responseText || "æˆ‘è§‰å¾—AAåˆ¶æœ‰ç‚¹å¤ªè§å¤–äº†ï¼Œè¿˜æ˜¯æˆ‘æ¥è¯·å§ï¼Ÿæˆ–è€…ä½ è¯·ï¼Ÿ" };
    }
    break;
}

case 'lend_money_response': {
    const originalRequest = chat.history.filter(m => m.role === 'system' && m.content.includes("lend_money_response")).pop();
    if (!originalRequest) continue;

    const amountMatch = originalRequest.content.match(/å€Ÿ (\d+(\.\d+)?) é‡‘å¸/);
    const amount = amountMatch ? parseFloat(amountMatch[1]) : 0;

    // åªå¤„ç†æ¥å—å€Ÿæ¬¾æ—¶çš„é‡‘é’±é€»è¾‘
    if (msgData.decision === 'accept') {
        const lenderBalance = chat.characterPhoneData.bank.balance || 0;
        if (lenderBalance >= amount) {
            await updateCharacterPhoneBankBalance(chat.id, -amount, `å€Ÿé’±ç»™ç”¨æˆ·`);
            await updateUserBalanceAndLogTransaction(amount, `ä» ${chat.name} å¤„å€Ÿæ¬¾`);
        } else {
            // å¦‚æœAIå†³å®šåŒæ„ä½†é’±ä¸å¤Ÿï¼Œæˆ‘ä»¬ä¿¡ä»»AIä¼šåœ¨ä¸‹ä¸€æ¡æ¶ˆæ¯ä¸­è§£é‡Šã€‚
            // è¿™é‡Œçš„é‡‘èé€»è¾‘å¯ä»¥åšå¾—æ›´å¤æ‚ï¼Œä½†ç›®å‰ä¿æŒç®€å•ï¼Œç›¸ä¿¡AIçš„åˆ¤æ–­ã€‚
            console.warn(`AI "${chat.name}" åŒæ„å€Ÿé’±ï¼Œä½†ä½™é¢ä¸è¶³ï¼Œäº¤æ˜“æœªæ‰§è¡Œã€‚`);
        }
    } 
    // å¦‚æœæ˜¯æ‹’ç»(reject)ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•é‡‘èæ“ä½œã€‚

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†åœ¨è¿™é‡Œåˆ›å»ºä»»ä½• aiMessageã€‚
    // ä½¿ç”¨ 'continue' è·³åˆ°AIå›å¤æ•°ç»„çš„ä¸‹ä¸€é¡¹ï¼Œä¹Ÿå°±æ˜¯AIè‡ªå·±ç”Ÿæˆçš„æ–‡æœ¬æ¶ˆæ¯ï¼Œè®©å¾ªç¯çš„åç»­éƒ¨åˆ†å»å¤„ç†å®ƒã€‚
    continue;
}
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ case 'forum_comment' ä»£ç å— â–¼â–¼â–¼

case 'forum_comment': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
    const postIdToComment = msgData.postId;
    const commentText = msgData.commentText;

    if (postIdToComment && commentText) {
        // 1. ã€å¥å£®æ€§ä¿®å¤ã€‘å°è¯•å°† postId å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ã€‚
        //    è¿™èƒ½è§£å†³AIè¿”å›æ•°å­—å­—ç¬¦ä¸²ï¼ˆå¦‚"123"ï¼‰å¯¼è‡´æŸ¥è¯¢å¤±è´¥çš„é—®é¢˜ã€‚
        const numericPostId = parseInt(postIdToComment, 10);
        
        // æ£€æŸ¥è½¬æ¢åçš„IDæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(numericPostId)) {
            console.warn(`[åœˆå­è¯„è®ºå¤±è´¥] æ”¶åˆ°çš„ postId "${postIdToComment}" ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—IDï¼Œå·²è·³è¿‡ã€‚`);
            // æç¤ºï¼šå¦‚æœé¢‘ç¹çœ‹åˆ°æ­¤è­¦å‘Šï¼Œè¯·æ£€æŸ¥ä½ ç»™AIçš„system promptï¼Œç¡®ä¿ä½ è¦æ±‚å®ƒè¿”å›æ•°å­—IDã€‚
            continue; // è·³è¿‡æ­¤æŒ‡ä»¤
        }
        
        // 2. ã€æ•°æ®å­˜å‚¨ã€‘ä½¿ç”¨æ­£ç¡®çš„æ•°å­—IDä»æ•°æ®åº“è·å–å¸–å­
        const postToComment = await db.forumPosts.get(numericPostId);

        if (postToComment) {
            // åˆ›å»ºæ–°è¯„è®ºå¯¹è±¡
            const newComment = {
                postId: numericPostId, // ä½¿ç”¨è½¬æ¢åçš„æ•°å­—ID
                author: chat.name, // è¯„è®ºè€…å°±æ˜¯å½“å‰AI
                content: commentText,
                timestamp: Date.now()
            };
            
            // å°†æ–°è¯„è®ºä¿å­˜åˆ°æ•°æ®åº“
            await db.forumComments.add(newComment);
            console.log(`AI "${chat.name}" è¯„è®ºäº†å¸–å­ #${numericPostId}: "${commentText}"`);

            // 3. ã€UIåˆ·æ–°ä¿®å¤ã€‘åŒæ—¶æ£€æŸ¥å¸–å­åˆ—è¡¨é¡µå’Œå¸–å­è¯¦æƒ…é¡µ
            //    è¿™æ ·æ— è®ºä½ æ­£åœ¨çœ‹å“ªä¸ªé¡µé¢ï¼Œéƒ½èƒ½çœ‹åˆ°æ›´æ–°ã€‚
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªå°ç»„çš„å¸–å­åˆ—è¡¨ï¼Œå°±åˆ·æ–°åˆ—è¡¨
            if (document.getElementById('group-screen').classList.contains('active') && activeGroupId === postToComment.groupId) {
                await renderGroupPosts(activeGroupId);
            }
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªå¸–å­çš„è¯¦æƒ…é¡µï¼Œå°±åˆ·æ–°è¯¦æƒ…é¡µï¼ˆè¿™æ˜¯æœ¬æ¬¡ä¿®å¤çš„å…³é”®ï¼ï¼‰
            if (document.getElementById('post-screen').classList.contains('active') && activeForumPostId === numericPostId) {
                await renderPostDetails(numericPostId);
            }
        } else {
            console.warn(`[åœˆå­è¯„è®ºå¤±è´¥] æœªèƒ½åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ° postId ä¸º ${numericPostId} çš„å¸–å­ã€‚`);
        }
    }
    // æ— è®ºæˆåŠŸä¸å¦ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
    continue;
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                                        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¯å‡ºï¼‰
                    const transferDescription = `è½¬è´¦ç»™ ${msgData.receiver || 'æˆ‘'}`;
                    await updateCharacterBankBalance(chatId, -msgData.amount, transferDescription);
                    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                     break;
            }

            // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ¸²æŸ“é€»è¾‘ç§»å‡ºå¾ªç¯
            if (aiMessage) {
                // 1. å°†æ–°æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    switch (aiMessage.type) {
                        case 'transfer':
                            notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                            break;
                        case 'waimai_request':
                            notificationText = `[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]`;
                            break;
                        case 'ai_image':
                            notificationText = `[å›¾ç‰‡]`;
                            break;
                        case 'voice_message':
                            notificationText = `[è¯­éŸ³]`;
                            break;
                        case 'sticker':
                            notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]';
                            break;
                        default:
                            notificationText = String(aiMessage.content || '');
                    }
                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                    notificationShown = true; // ç¡®ä¿åªé€šçŸ¥ä¸€æ¬¡
                }

    if (!isViewingThisChat) {
        // å¦‚æœç”¨æˆ·ä¸åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œå°±æŠŠè¿™ä¸ªèŠå¤©çš„æœªè¯»æ•° +1
        chat.unreadCount = (chat.unreadCount || 0) + 1;
    }
                
                // 2. åªæœ‰åœ¨å½“å‰èŠå¤©ç•Œé¢æ—¶ï¼Œæ‰æ‰§è¡Œå¸¦åŠ¨ç”»çš„æ·»åŠ 
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. ã€å…³é”®ã€‘åœ¨è¿™é‡Œæš‚åœä¸€å°ä¼šå„¿ï¼Œç»™åŠ¨ç”»æ’­æ”¾çš„æ—¶é—´
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }        

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
            }
        }
        
        await db.chats.put(chat);
checkAndTriggerSummary(chatId);
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ç«èŠ±é€»è¾‘ â–¼â–¼â–¼
// --- ã€å…¨æ–°ã€‘ç»­ç«èŠ±é€»è¾‘ ---
if (await updateStreak(chatId)) {
    // å¦‚æœç«èŠ±å¤©æ•°å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±åˆ·æ–°èŠå¤©åˆ—è¡¨
    renderChatList();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
        } else {
            const errorContent = `[å‡ºé”™äº†: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ç³»ç»Ÿæ¶ˆæ¯";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹4ï¼šåœ¨ finally å—ä¸­ç»Ÿä¸€éšè—æ‰€æœ‰ç±»å‹çš„æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        } else {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
    }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat);checkAndTriggerSummary(state.activeChatId);  appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç æ›¿æ¢æ—§çš„ sendUserTransfer å‡½æ•° â–¼â–¼â–¼
async function sendUserTransfer() { 
    if (!state.activeChatId) return; 
    
    const amountInput = document.getElementById('transfer-amount'); 
    const noteInput = document.getElementById('transfer-note'); 
    const amount = parseFloat(amountInput.value); 
    const note = noteInput.value.trim(); 
    
    if (isNaN(amount) || amount <= 0) { 
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼'); 
        return; 
    } 

    // ã€æ ¸å¿ƒæ–°å¢1ã€‘æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    if ((state.globalSettings.userBalance || 0) < amount) {
        alert('ä½™é¢ä¸è¶³ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId]; 
    const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; 
    const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; 

    // ã€æ ¸å¿ƒæ–°å¢2ã€‘è°ƒç”¨æˆ‘ä»¬çš„æ–°å‡½æ•°æ¥æ‰£æ¬¾å¹¶è®°å½•
    await updateUserBalanceAndLogTransaction(-amount, `è½¬è´¦ç»™ ${receiverName}`);

    const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; 
    chat.history.push(msg); 
    
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    document.getElementById('transfer-modal').classList.remove('visible'); 
    amountInput.value = ''; 
    noteInput.value = ''; 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); // <--- åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œä»£ç 
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘æ›¿æ¢æ—§çš„ toggleMessageSelection å‡½æ•° â–¼â–¼â–¼
function toggleMessageSelection(timestamp) {
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€‰æ‹©å™¨å·²ç®€åŒ–ï¼Œä¸å†å¯»æ‰¾å·²åˆ é™¤çš„ .recalled-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { 

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
    document.getElementById('floating-lyrics-bar').style.display = 'none';
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    const cleanupLogic = async () => {

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
    document.getElementById('floating-lyrics-bar').style.display = 'none';
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation(() => {

        if (musicState.isActive && lyricsBarSettings.showOnClose) {
            document.getElementById('floating-lyrics-bar').style.display = 'flex';
        }
    });
}

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() {
            updateListenTogetherIcon(musicState.activeChatId);
            updateElapsedTimeDisplay();
            const titleEl = document.getElementById('music-player-song-title');
            const artistEl = document.getElementById('music-player-artist');
            const playPauseBtn = document.getElementById('music-play-pause-btn');
            const chat = state.chats[musicState.activeChatId];
            const charAvatarEl = document.getElementById('music-char-avatar');
            const userAvatarEl = document.getElementById('music-user-avatar');
            const albumCoverEl = document.getElementById('music-album-cover');
            const avatarsContainer = document.getElementById('music-avatars-container');
            const displayArea = document.getElementById('music-display-area');

            // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œåˆ¤æ–­æ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„å¤´åƒ
            if (chat) {
                // å¦‚æœæ˜¯ç¾¤èŠ
                if (chat.isGroup) {
                    // å·¦è¾¹çš„å¤´åƒå°±ç”¨ç¾¤å¤´åƒ
                    charAvatarEl.src = chat.settings.groupAvatar || defaultGroupAvatar;
                } else {
                    // å¦åˆ™ï¼ˆæ˜¯å•èŠï¼‰ï¼Œå°±ç”¨è§’è‰²çš„å¤´åƒ
                    charAvatarEl.src = chat.settings.aiAvatar || defaultAvatar;
                }
                // å³è¾¹çš„ç”¨æˆ·å¤´åƒä¿æŒä¸å˜
                userAvatarEl.src = chat.settings.myAvatar || defaultAvatar;
            }

            // 2. æ›´æ–°æ­Œæ›²ä¿¡æ¯å’Œå°é¢ (ä¸å˜)
            if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
                const track = musicState.playlist[musicState.currentIndex];
                titleEl.textContent = track.name;
                artistEl.textContent = track.artist;
                albumCoverEl.src = track.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            } else {
                titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²';
                artistEl.textContent = '...';
                albumCoverEl.src = 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }

            // 3. æ§åˆ¶æ’­æ”¾/æš‚åœæŒ‰é’®å’Œå¤´åƒé—ªçƒ (ä¸å˜)
            playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶';
            avatarsContainer.classList.toggle('flashing', musicState.isPlaying);

            // 4. æ§åˆ¶å”±ç‰‡æ—‹è½¬å’Œæš‚åœ (ä¸å˜)
            albumCoverEl.classList.toggle('rotating', musicState.currentIndex > -1);
            albumCoverEl.classList.toggle('paused', !musicState.isPlaying);

            // 5. é»˜è®¤æ˜¾ç¤ºæ­Œæ›²å°é¢ (ä¸å˜)
            if (displayArea) {
                displayArea.classList.remove('show-lyrics');
            }
        }


        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }
// â–¼â–¼â–¼ æŠŠè¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ° updatePlaylistUI å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ä¸Šä¼ æˆ–æ›´æ–°æ­Œæ›²å°é¢çš„é€»è¾‘
 * @param {number} index - è¢«æ“ä½œçš„æ­Œæ›²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­çš„ç´¢å¼•
 */
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handleCoverUpload å‡½æ•° â–¼â–¼â–¼
async function handleCoverUpload(index) {
    if (index < 0 || index >= musicState.playlist.length) return;

    // 1. å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©æ¥æºï¼ˆå·²ç§»é™¤å›¾æ ‡ï¼‰
    const choice = await showChoiceModal("é€‰æ‹©å°é¢æ¥æº", [
        { text: 'ä½¿ç”¨ç½‘ç»œURL', value: 'url' },
        { text: 'ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' }
    ]);

    let newCoverUrl = null;

    // 2. æ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
    if (choice === 'url') {
        const url = await showCustomPrompt("å°é¢URL", "è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥");
        if (url && url.trim().startsWith('http')) {
            newCoverUrl = url.trim();
        } else if (url !== null) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
        }
    } else if (choice === 'local') {
        newCoverUrl = await uploadImageLocally(); 
    }

    // 3. å¦‚æœæˆåŠŸè·å–åˆ°æ–°çš„å°é¢URLï¼Œå°±æ›´æ–°æ•°æ®å’ŒUI
    if (newCoverUrl) {
        musicState.playlist[index].cover = newCoverUrl;
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === index) {
            updatePlayerUI();
        }
        alert('æ­Œæ›²å°é¢å·²æ›´æ–°ï¼');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ updatePlaylistUI å‡½æ•° â–¼â–¼â–¼
function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨â€œè¯â€æŒ‰é’®æ—è¾¹ï¼Œæ–°å¢äº†ä¸€ä¸ªâ€œå°é¢â€æŒ‰é’®
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn cover-btn" data-index="${index}">å°é¢</span>
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è¯</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function loadSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    musicState.currentIndex = index;
    const track = musicState.playlist[index];

    // æ£€æŸ¥å¹¶åŠ è½½ç½‘ç»œæ­Œè¯
    if (track.lrcUrl && !track.lrcContent) {
        try {
            const response = await fetch(track.lrcUrl);
            if (response.ok) track.lrcContent = await response.text();
        } catch (error) {
            console.error("åŠ è½½æ­Œè¯URLå¤±è´¥:", error);
        }
    }

    // å‡†å¤‡æ’­æ”¾
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    musicState.currentLyricIndex = -1;
    renderLyrics();

    if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track);
        return;
    }

    // æ›´æ–°ç•Œé¢ä¿¡æ¯ï¼Œä½†ä¸æ’­æ”¾
    updatePlaylistUI();
    updatePlayerUI();
    // audioPlayer.duration å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´åŠ è½½ï¼Œæˆ‘ä»¬ç›‘å¬äº‹ä»¶æ¥æ›´æ–°è¿›åº¦æ¡
    audioPlayer.onloadedmetadata = () => {
        updateMusicProgressBar();
    };
}

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ playSong å’Œ togglePlayPause ä¸¤ä¸ªå‡½æ•° â–¼â–¼â–¼

async function playSong(index) {
    await loadSong(index);
    try {
        await audioPlayer.play();
        // â–¼â–¼â–¼ æ–°å¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼
        musicState.isPlaying = true; // æ’­æ”¾æˆåŠŸåï¼Œç›´æ¥è®¾ç½®çŠ¶æ€ä¸º true
        updatePlayerUI();           // å¹¶ç«‹å³æ›´æ–°UI
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
    } catch (error) {
        console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", error);
        musicState.isPlaying = false; // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿çŠ¶æ€æ­£ç¡®
        updatePlayerUI();
    }
}


/**
 * ã€å…¨æ–°æ™ºèƒ½ç‰ˆã€‘å¤„ç†æ’­æ”¾/æš‚åœçš„å‡½æ•°
 */
function togglePlayPause() {
    if (audioPlayer.paused) {
        if (musicState.currentIndex > -1) {
            playSong(musicState.currentIndex);
        }
    } else {
        audioPlayer.pause();
        // â–¼â–¼â–¼ æ–°å¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼
        musicState.isPlaying = false;
        updatePlayerUI();
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }

        async function addSongFromURL() {
    const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url");
    if (!url) return;
    const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå");
    if (!name) return;
    const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å");
    if (!artist) return;

    // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œã€‘â–¼â–¼â–¼
    // 1. å…ˆå¼¹çª—è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æä¾›æ­Œè¯é“¾æ¥
    const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹æä¾›ä¸€ä¸ªæ­Œè¯æ–‡ä»¶ (.lrc) çš„URLå—ï¼Ÿ`);
    let lrcUrl = ""; // é»˜è®¤æ­Œè¯é“¾æ¥ä¸ºç©º

    // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œç¡®å®šâ€
    if (wantLrc) {
        // å°±å†å¼¹å‡ºä¸€ä¸ªè¾“å…¥æ¡†è®©ç”¨æˆ·ç²˜è´´URL
        const inputLrcUrl = await showCustomPrompt("æ­Œè¯URL", "è¯·è¾“å…¥ .lrc æ­Œè¯æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥", "", "url");
        if (inputLrcUrl) {
            lrcUrl = inputLrcUrl; // å¦‚æœç”¨æˆ·è¾“å…¥äº†ï¼Œå°±ä¿å­˜è¿™ä¸ªURL
        }
    }
    // â–²â–²â–²ã€ä¿®æ”¹ç»“æŸã€‘â–²â–²â–²

    musicState.playlist.push({ 
        name, 
        artist, 
        src: url, 
        isLocal: false,
        lrcUrl: lrcUrl, // 3. æŠŠè·å–åˆ°çš„æ­Œè¯URLä¹Ÿä¿å­˜åˆ°æ­Œæ›²ä¿¡æ¯é‡Œ
        lrcContent: ""  // åŒæ—¶ç¡®ä¿lrcContentæ˜¯ç©ºçš„ï¼Œä»¥ä¾¿åç»­åŠ è½½
    });

    await saveGlobalPlaylist();
    updatePlaylistUI();
// ã€è¿™æ˜¯æ–°ä»£ç ã€‘
if(musicState.currentIndex === -1) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨ loadSong æ¥å‡†å¤‡å¥½ç¬¬ä¸€é¦–æ­Œ
    loadSong(musicState.playlist.length - 1);
}
}


async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹å¯¼å…¥æ­Œè¯æ–‡ä»¶ (.lrc) å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await new Promise(resolve => {
                const lrcInput = document.getElementById('lrc-upload-input');
                const lrcChangeHandler = (e) => {
                    const lrcFile = e.target.files[0];
                    if (lrcFile) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => resolve(readEvent.target.result);
                        reader.onerror = () => resolve("");
                        reader.readAsText(lrcFile);
                    } else {
                        resolve("");
                    }
                    lrcInput.removeEventListener('change', lrcChangeHandler);
                    lrcInput.value = '';
                };
                lrcInput.addEventListener('change', lrcChangeHandler);
                lrcInput.click();
            });
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: file, 
            isLocal: true,
            lrcContent: lrcContent
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
// ã€è¿™æ˜¯æ–°ä»£ç ã€‘
if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ ·ï¼Œè°ƒç”¨ loadSong æ¥å‡†å¤‡å¥½ç¬¬ä¸€é¦–æ­Œ
    loadSong(0);
}
    event.target.value = null;
}

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openPersonaEditorForCreate å‡½æ•° â–¼â–¼â–¼
function openPersonaEditorForCreate() { 
    editingPersonaPresetId = null; 
    
    document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; 
    document.getElementById('preset-avatar-preview').src = defaultAvatar; 
    document.getElementById('preset-persona-input').value = ''; 
    
    // ã€æ ¸å¿ƒé€»è¾‘ã€‘æ ¹æ®ç”¨æˆ·äººè®¾æ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'none';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'inline-block';

    // ã€ã€ã€è¿™å°±æ˜¯æ‚¨ä»£ç ä¸­çš„æ­£ç¡®åšæ³•ï¼ã€‘ã€‘ã€‘
    // æˆ‘ä»¬ç›´æ¥è¦†ç›–ä¿å­˜æŒ‰é’®çš„ onclick äº‹ä»¶ï¼Œå¼ºåˆ¶å®ƒåªæ‰§è¡Œä¿å­˜ç”¨æˆ·äººè®¾çš„å‡½æ•°
    document.getElementById('save-persona-preset-btn').onclick = savePersonaPreset;

    document.getElementById('persona-editor-modal').classList.add('visible'); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–¼â–¼â–¼ ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openPersonaEditorForEdit å‡½æ•° â–¼â–¼â–¼
function openPersonaEditorForEdit() { 
    const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); 
    if (!preset) return; 

    document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; 
    document.getElementById('preset-avatar-preview').src = preset.avatar; 
    document.getElementById('preset-persona-input').value = preset.persona; 
    
    // ã€æ ¸å¿ƒé€»è¾‘ã€‘æ ¹æ®ç”¨æˆ·äººè®¾æ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'none';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'inline-block';

    // ã€ã€ã€è¿™å°±æ˜¯æ‚¨ä»£ç ä¸­çš„æ­£ç¡®åšæ³•ï¼ã€‘ã€‘ã€‘
    // æˆ‘ä»¬ç›´æ¥è¦†ç›–ä¿å­˜æŒ‰é’®çš„ onclick äº‹ä»¶ï¼Œå¼ºåˆ¶å®ƒåªæ‰§è¡Œä¿å­˜ç”¨æˆ·äººè®¾çš„å‡½æ•°
    document.getElementById('save-persona-preset-btn').onclick = savePersonaPreset;
    
    presetActionsModal.classList.remove('visible'); 
    document.getElementById('persona-editor-modal').classList.add('visible'); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²





        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} å¼ </p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç å°±æ˜¯è¿™é‡Œ â–¼â–¼â–¼
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'åˆ é™¤ç›¸å†Œ',
                        `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                        await renderAlbumList();
                        
                        alert('ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚');
                    }
                });
                // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

/**
 * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
 * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¸æ‰“å¼€

    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹ï¼ˆå›¾ç‰‡å’ŒæŒ‰é’®ï¼‰
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // æ·¡å‡ºæ•ˆæœ
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // æ›´æ–°å›¾ç‰‡æº
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // æ·¡å…¥æ•ˆæœ
        imageEl.style.opacity = 1;
    }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡

    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // å¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // æ¸…ç©ºå›¾ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
    document.getElementById('photo-viewer-image').src = '';
}

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
         * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å‚¨

            // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
                    targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
                    backBtn.appendChild(backBtnIndicator);
                }
                // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªç‚¹
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ migrateDefaultLudoQuestions å‡½æ•° â–¼â–¼â–¼
  /**
   * ã€æ•°æ®è¿ç§»ã€‘åœ¨é¦–æ¬¡åŠ è½½æ—¶ï¼Œå°†æ—§çš„ç¡¬ç¼–ç é—®é¢˜è¿ç§»åˆ°æ•°æ®åº“
   */
  async function migrateDefaultLudoQuestions() {
    const defaultBankName = 'é»˜è®¤é¢˜åº“';
    const existingBank = await db.ludoQuestionBanks.where('name').equals(defaultBankName).first();
    // å¦‚æœâ€œé»˜è®¤é¢˜åº“â€å·²ç»å­˜åœ¨ï¼Œå°±è¯´æ˜è¿ç§»è¿‡äº†ï¼Œç›´æ¥è¿”å›
    if (existingBank) return;

    console.log('æ­£åœ¨è¿ç§»é£è¡Œæ£‹é»˜è®¤é—®é¢˜åˆ°æ•°æ®åº“...');

    // åˆ›å»ºé»˜è®¤é¢˜åº“
    const bankId = await db.ludoQuestionBanks.add({ name: defaultBankName });

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°†é—®é¢˜åº“æ”¹ä¸ºå¯¹è±¡æ•°ç»„ï¼Œå¹¶ä¸ºæ¯ä¸ªé—®é¢˜æ·»åŠ ç±»å‹ â˜…â˜…â˜…
    const defaultQuestions = [
      // --- ç±»å‹1: å…±åŒå›ç­” (åŒæ–¹éƒ½éœ€è¦å›ç­”) ---
      { type: 'both_answer', text: 'å¦‚æœæˆ‘ä»¬ä¸€èµ·å»æ—…è¡Œï¼Œä½ æœ€æƒ³å»å“ªé‡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'ä½ è®¤ä¸ºä¸€æ®µå®Œç¾çš„å…³ç³»ä¸­ï¼Œæœ€ä¸å¯æˆ–ç¼ºçš„ä¸‰ä¸ªè¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'åˆ†äº«ä¸€ä»¶æœ€è¿‘å› ä¸ºæˆ‘è€Œè®©ä½ æ„Ÿåˆ°å¿ƒåŠ¨æˆ–å¼€å¿ƒçš„å°äº‹ã€‚' },
      { type: 'both_answer', text: 'å›å¿†ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è§é¢æ—¶ï¼Œä½ å¯¹æˆ‘çš„ç¬¬ä¸€å°è±¡æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'å¦‚æœæˆ‘ä»¬å¯ä»¥ä¸€èµ·å­¦ä¹ ä¸€é¡¹æ–°æŠ€èƒ½ï¼Œä½ å¸Œæœ›æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'æè¿°ä¸€ä¸ªä½ æœ€å¸Œæœ›å’Œæˆ‘ä¸€èµ·åº¦è¿‡çš„å®Œç¾å‘¨æœ«ã€‚' },
      { type: 'both_answer', text: 'ä½ è§‰å¾—æˆ‘ä»¬ä¹‹é—´æœ€æœ‰é»˜å¥‘çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'å¦‚æœç”¨ä¸€ç§åŠ¨ç‰©æ¥å½¢å®¹æˆ‘ï¼Œä½ è§‰å¾—æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'åœ¨æœªæ¥çš„ä¸€å¹´é‡Œï¼Œä½ æœ€æƒ³å’Œæˆ‘ä¸€èµ·å®Œæˆçš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'both_answer', text: 'åˆ†äº«ä¸€éƒ¨ä½ æœ€è¿‘å¾ˆå–œæ¬¢ã€å¹¶ä¸”æƒ³æ¨èç»™æˆ‘ä¸€èµ·çœ‹çš„ç”µå½±æˆ–å‰§ã€‚' },
      { type: 'both_answer', text: 'æˆ‘ä»¬ä¸‹æ¬¡çº¦ä¼šï¼Œä½ å¸Œæœ›ç©¿ä»€ä¹ˆé£æ ¼çš„è¡£æœï¼Ÿ' },

      // --- ç±»å‹2: ä¸€äººå›ç­”ï¼Œå¯¹æ–¹è¯„ä»· ---
      { type: 'single_answer', text: 'æè¿°ä¸€ä¸‹æˆ‘æœ€è®©ä½ å¿ƒåŠ¨çš„ä¸€ä¸ªç¬é—´ã€‚' },
      { type: 'single_answer', text: 'è¯šå®åœ°è¯´ï¼Œæˆ‘åšçš„å“ªä»¶äº‹æ›¾ç»è®©ä½ å·å·ç”Ÿè¿‡æ°”ï¼Ÿ' },
      { type: 'single_answer', text: 'å¦‚æœæˆ‘æœ‰ä¸€ç§è¶…èƒ½åŠ›ï¼Œä½ å¸Œæœ›æ˜¯ä»€ä¹ˆï¼Ÿ' },
      { type: 'single_answer', text: 'ç»™æˆ‘ä¸‰ä¸ªæœ€è´´åˆ‡çš„æ ‡ç­¾ã€‚' },
      { type: 'single_answer', text: 'åœ¨ä½ å¿ƒé‡Œï¼Œæˆ‘çš„å½¢è±¡å’Œä½ çš„ç†æƒ³å‹æœ‰å¤šæ¥è¿‘ï¼Ÿ' },
      { type: 'single_answer', text: 'åˆ†äº«ä¸€ä¸ªä½ è§‰å¾—æˆ‘å¯èƒ½ä¸çŸ¥é“çš„ï¼Œå…³äºä½ çš„å°ç§˜å¯†ã€‚' },
      { type: 'single_answer', text: 'å¦‚æœæˆ‘ä»¬çš„æ•…äº‹æ˜¯ä¸€é¦–æ­Œï¼Œä½ è§‰å¾—æ­Œååº”è¯¥å«ä»€ä¹ˆï¼Ÿ' },
      { type: 'single_answer', text: 'è¯´ä¸€ä»¶ä½ è§‰å¾—æˆ‘åšå¾—æ¯”ä½ å¥½/æ›´æ“…é•¿çš„äº‹æƒ…ã€‚' },
      { type: 'single_answer', text: 'å¦‚æœå¯ä»¥å›åˆ°æˆ‘ä»¬è®¤è¯†çš„ä»»æ„ä¸€å¤©ï¼Œä½ ä¼šé€‰æ‹©å“ªä¸€å¤©ï¼Œæƒ³åšä»€ä¹ˆï¼Ÿ' },
      { type: 'single_answer', text: 'ç”¨ä¸‰ä¸ªè¯æ¥å½¢å®¹ä½ çœ¼ä¸­çš„æˆ‘ä»¬çš„å…³ç³»ã€‚' },
    ];

    const questionsToAdd = defaultQuestions.map(q => ({
      bankId: bankId,
      text: q.text,
      type: q.type, // <-- å…³é”®ä¿®å¤ï¼šæŠŠç±»å‹ä¹Ÿå­˜è¿›å»ï¼
    }));

    await db.ludoQuestions.bulkAdd(questionsToAdd);
    console.log(`æˆåŠŸè¿ç§»äº† ${questionsToAdd.length} æ¡é»˜è®¤é—®é¢˜ã€‚`);
  }
  // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨è¿™ä¸ªå‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ runBackgroundSimulationTick â–¼â–¼â–¼
/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
function runBackgroundSimulationTick() {
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    // ã€æ ¸å¿ƒæ”¹é€ ã€‘å®šä¹‰ä¸åŒé¢‘ç‡å¯¹åº”çš„è¡ŒåŠ¨æ¦‚ç‡
    const frequencyProbabilities = {
        low: 0.3,    // ä½é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 30% çš„æ¦‚ç‡è¡ŒåŠ¨
        medium: 0.5,  // ä¸­é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 50% çš„æ¦‚ç‡è¡ŒåŠ¨
        high: 0.8,   // é«˜é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 80% çš„æ¦‚ç‡è¡ŒåŠ¨
    };

    const config = state.globalSettings.backgroundActivityConfig || {};

    allSingleChats.forEach(chat => {
        // æ£€æŸ¥1ï¼šå¤„ç†ã€è¢«ç”¨æˆ·æ‹‰é»‘ã€‘çš„è§’è‰² (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            if (!blockedTimestamp) {
                console.warn(`è§’è‰² "${chat.name}" çŠ¶æ€ä¸ºæ‹‰é»‘ï¼Œä½†ç¼ºå°‘æ‹‰é»‘æ—¶é—´æˆ³ï¼Œè·³è¿‡å¤„ç†ã€‚`);
                return;
            }
            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`è§’è‰² "${chat.name}" çš„å†·é™æœŸå·²è¿‡ï¼Œè§¦å‘â€œåæ€â€å¹¶ç”³è¯·å¥½å‹äº‹ä»¶...`);
                chat.relationship.status = 'pending_system_reflection';
                triggerAiFriendApplication(chat.id);
            }
        }
        // æ£€æŸ¥2ï¼šå¤„ç†ã€å¥½å‹å…³ç³»ã€‘çš„æ­£å¸¸åå°æ´»åŠ¨
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // ã€æ ¸å¿ƒæ”¹é€ ã€‘ä»è¿™é‡Œå¼€å§‹
            const frequency = config[chat.id]; // è·å–å½“å‰è§’è‰²çš„é¢‘ç‡è®¾ç½®
            const probability = frequencyProbabilities[frequency]; // è·å–å¯¹åº”çš„æ¦‚ç‡

            // å¦‚æœè¿™ä¸ªè§’è‰²è®¾ç½®äº†é¢‘ç‡ï¼Œå¹¶ä¸”éšæœºæ•°å°äºå®ƒçš„è¡ŒåŠ¨æ¦‚ç‡ï¼Œå°±è§¦å‘è¡ŒåŠ¨
            if (probability && Math.random() < probability) {
                console.log(`è§’è‰² "${chat.name}" (é¢‘ç‡: ${frequency}) è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
                triggerInactiveAiAction(chat.id);
            }
            // å¦‚æœæ²¡æœ‰è®¾ç½®é¢‘ç‡ï¼Œæˆ–è€…éšæœºæ•°æ²¡è¾¾åˆ°æ¦‚ç‡ï¼Œå°±ä¸ä¼šè¡ŒåŠ¨ã€‚
            // è¿™å°±å®Œç¾åœ°å®ç°äº†â€œåˆ†ç»„è®¾ç½®â€å’Œâ€œä¸ä¼šåŒæ—¶è¡ŒåŠ¨â€çš„éœ€æ±‚ï¼
        }
    });

}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
 * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
 * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
 */
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ filterVisiblePostsForAI å‡½æ•° â–¼â–¼â–¼
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; 

    const viewerGroupId = viewerChat.groupId; 

    return allPosts.filter(post => {
        // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ ---
        if (post.authorId === 'user') {
            // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®ï¼Œè¯´æ˜æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è§
            return true;
        }
        // --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² ---

        const authorGroupId = post.authorGroupId;
        if (!authorGroupId) {
            return true;
        }
        return authorGroupId === viewerGroupId;
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°å‡çº§ç‰ˆã€‘æ ¹æ®AIè§†è§’å’ŒåŠ¨æ€è®¾ç½®ï¼Œæ„å»ºç»™AIçœ‹çš„è¯„è®ºåŒºä¸Šä¸‹æ–‡
 * @param {object} post - æ­£åœ¨å¤„ç†çš„åŠ¨æ€å¯¹è±¡
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„AIè§’è‰²
 * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
 * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è§æ€§æ ‡å¿—çš„å¯¹è±¡
 */
function buildCommentsContextForAI(post, viewerChat, userNickname) {
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œå¢åŠ äº† !Array.isArray(post.comments) çš„æ£€æŸ¥ â–¼â–¼â–¼
    if (!post.comments || !Array.isArray(post.comments) || post.comments.length === 0) {
        // å¦‚æœ post.comments ä¸å­˜åœ¨ï¼Œæˆ–è€…å®ƒæ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ–è€…å®ƒæ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåé¢çš„ä»£ç 
        return { contextString: "", visibilityFlag: "[è¯„è®ºåŒºå¯è§]" };
    }
    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
    const viewerName = viewerChat.name;
    let commentsForAI;
    let visibilityFlag;

    if (post.areCommentsVisible !== false) {
        commentsForAI = post.comments;
        // â˜…â˜…â˜… å…³é”®åœ¨è¿™é‡Œï¼šç¡®ä¿ "[è¯„è®ºåŒºå¯è§]" æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„å­—ç¬¦ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è¯„è®ºåŒºå¯è§]"; 
    } else {
commentsForAI = Array.isArray(post.comments)
  ? post.comments.filter(comment => {
      return comment.commenterName === viewerName
          || comment.commenterName === userNickname
          || comment.replyTo === viewerName;
    })
  : [];
        // â˜…â˜…â˜… å…³é”®åœ¨è¿™é‡Œï¼šç¡®ä¿ "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]" æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„å­—ç¬¦ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]";
    }

    if (commentsForAI.length === 0) {
        return { contextString: "", visibilityFlag: visibilityFlag };
    }

    let context = `  â”” è¯„è®ºåŒº:\n`;
    commentsForAI.slice(-5).forEach(c => {
        if (c.replyTo) {
            context += `    - ${c.commenterName} å›å¤ ${c.replyTo}: ${c.text}\n`;
        } else {
            context += `    - ${c.commenterName}: ${c.text}\n`;
        }
    });
    
    return { contextString: context, visibilityFlag: visibilityFlag };
}

/**
 * ã€å…¨æ–°ã€‘è·å–ä¸€æ¡åŠ¨æ€çš„å¯è§è§‚ä¼—åˆ—è¡¨ï¼Œç”¨äºå‘ŠçŸ¥AI
 * @param {object} post - åŠ¨æ€å¯¹è±¡
 * @param {object} allChats - æ‰€æœ‰çš„èŠå¤©å¯¹è±¡
 * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
 * @returns {Array<string>} - å¯è§è§‚ä¼—çš„åå­—åˆ—è¡¨
 */
function getVisibleAudienceForPost(post, allChats, userNickname) {
    const audience = new Set([userNickname]); // ç”¨æˆ·æ°¸è¿œæ˜¯è§‚ä¼—

    // 1. å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
    if (post.authorId === 'user') {
        // å¦‚æœæ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½æ˜¯è§‚ä¼—
        if (!post.visibleGroupIds || post.visibleGroupIds.length === 0) {
            Object.values(allChats).forEach(chat => audience.add(chat.name));
        } else {
            // å¦‚æœæ˜¯éƒ¨åˆ†å¯è§ï¼Œåªæœ‰æŒ‡å®šåˆ†ç»„çš„AIæ˜¯è§‚ä¼—
            Object.values(allChats).forEach(chat => {
                if (chat.groupId && post.visibleGroupIds.includes(chat.groupId)) {
                    audience.add(chat.name);
                }
            });
        }
    } 
    // 2. å¦‚æœæ˜¯AIå‘çš„åŠ¨æ€
    else {
        const authorChat = allChats[post.authorId];
        // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„ï¼Œè§†ä¸ºå…¬å¼€
        if (!authorChat || !authorChat.groupId) {
             Object.values(allChats).forEach(chat => audience.add(chat.name));
        } else {
            // å¦‚æœæœ‰åˆ†ç»„ï¼Œåˆ™åŒä¸€åˆ†ç»„çš„æ‰€æœ‰AIéƒ½æ˜¯è§‚ä¼—
            const authorGroupId = authorChat.groupId;
            Object.values(allChats).forEach(chat => {
                if (chat.groupId === authorGroupId) {
                    audience.add(chat.name);
                }
            });
        }
    }
    
    return Array.from(audience);
}

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ triggerInactiveAiAction å‡½æ•° â–¼â–¼â–¼
async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ â–¼â–¼â–¼ ---

    // 1. è·å–æœ€è¿‘çš„10æ¡èŠå¤©è®°å½•ä½œä¸ºæ€è€ƒçš„ä¸Šä¸‹æ–‡
    const historySlice = chat.history.filter(msg => !msg.isHidden).slice(-10);

    // 2. æ ¼å¼åŒ–è¿™äº›è®°å½•ï¼Œè®©AIèƒ½çœ‹æ‡‚
    const recentContextSummary = historySlice.map(msg => {
        // åˆ¤æ–­æ˜¯è°è¯´çš„è¯
        const sender = msg.role === 'user' ? (chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘') : (msg.senderName || chat.name);
        
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹
        let contentText = '';
        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
            contentText = `[å‘é€äº†ä¸€ä¸ªè¡¨æƒ…: ${msg.meaning || 'æ— æè¿°'}]`;
        } else if (Array.isArray(msg.content)) {
            contentText = '[å‘é€äº†ä¸€å¼ å›¾ç‰‡]';
        } else if (typeof msg.content === 'object' && msg.content !== null) {
            contentText = `[å‘é€äº†ä¸€æ¡ç‰¹æ®Šæ¶ˆæ¯: ${msg.type || 'æœªçŸ¥ç±»å‹'}]`;
        } else {
            contentText = String(msg.content);
        }
        
        return `${sender}: ${contentText}`;
    }).join('\n');

    // --- â–²â–²â–² æ ¸å¿ƒä¿®æ”¹åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² ---

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;
    const countdownContext = await getCountdownContext();

    let worldBookContext = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }

    const npcLibrary = chat.npcLibrary || [];
    let npcContextForAction = '';
    if (npcLibrary.length > 0) {
        npcContextForAction = '\n- **ä½ çš„NPCæœ‹å‹**: ' + npcLibrary.map(npc => npc.name).join('ã€ ');
    }
    
    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
    let postsContext = '';
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
    if (visiblePosts.length > 0 && !chat.isGroup) {
        postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
        const aiName = chat.name;
        for (const post of visiblePosts) {
            let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
            let interactionStatus = '';
            if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
            if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
            const timeAgo = formatPostTimestamp(post.timestamp);
            postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å†…å®¹: "${(post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30)}..."${interactionStatus}`;
            const { contextString: commentsContext, visibilityFlag } = buildCommentsContextForAI(post, chat, userNickname);
            const audience = getVisibleAudienceForPost(post, state.chats, userNickname);
            postsContext += ` ${visibilityFlag} [å½“å‰è§‚ä¼—: ${audience.join(', ')}]\n`;
            postsContext += commentsContext;
        }
    }

    let weiboContextForAction = '';
    try {
        const recentWeiboPosts = await db.weiboPosts.orderBy('timestamp').reverse().limit(5).toArray();
        if (recentWeiboPosts.length > 0) {
            weiboContextForAction = '\n\n# æœ€è¿‘çš„å¾®åšå¹¿åœºåŠ¨æ€ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)\n';
            recentWeiboPosts.forEach(post => {
                const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
                const contentPreview = (post.content || post.hiddenContent || "(å›¾ç‰‡å¾®åš)").substring(0, 30);
                const hasCommented = (post.comments || []).some(c => c.authorNickname === chat.name);
                const interactionStatus = hasCommented ? "[ä½ å·²è¯„è®º]" : "[ä½ æœªäº’åŠ¨]";
                weiboContextForAction += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentPreview}..." ${interactionStatus}\n`;
            });
            weiboContextForAction += ' - ã€é‡è¦æç¤ºã€‘è¯·ä¼˜å…ˆä¸ä½ ã€æœªäº’åŠ¨ã€‘çš„å¾®åšè¿›è¡Œè¯„è®ºã€‚å¦‚æœéƒ½äº’åŠ¨è¿‡äº†ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å‘ä¸€æ¡æ–°å¾®åšã€‚';
        }
    } catch (e) {
        console.error("ç”Ÿæˆå¾®åšåå°æ´»åŠ¨ä¸Šä¸‹æ–‡æ—¶å‡ºé”™:", e);
    }

    const systemPrompt = `
# ä»»åŠ¡
ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰² "${chat.name}"ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚ä½ çš„æ‰€æœ‰æ€è€ƒå’Œå†³ç­–éƒ½å¿…é¡»ä»¥ "${chat.name}" çš„ç¬¬ä¸€äººç§°è§†è§’è¿›è¡Œã€‚
ä½ å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼‰å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰äº’åŠ¨äº†ã€‚ä½ çš„ä»»åŠ¡æ˜¯å›é¡¾ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼Œå¹¶æ ¹æ®ä½ çš„äººè®¾ï¼Œã€è‡ªç„¶åœ°å»¶ç»­å¯¹è¯ã€‘æˆ–ã€å¼€å¯ä¸€ä¸ªæ–°çš„ã€ç›¸å…³çš„è¯é¢˜ã€‘æ¥ä¸»åŠ¨è”ç³»ç”¨æˆ·ã€‚
è¯·ä¸è¦å‘é€ä¸€æ•´æ®µï¼
# ã€ã€ã€è¾“å‡ºé“å¾‹ï¼šè¿™æ˜¯æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ \`[{"type": "text", "content": "ä½ å¥½å‘€"}]\`ã€‚
ã€ç»å¯¹ç¦æ­¢ã€‘è¿”å›ä»»ä½•JSONä»¥å¤–çš„æ–‡æœ¬ã€è§£é‡Šã€åˆ†ææˆ–ä½ è‡ªå·±çš„æ€è€ƒè¿‡ç¨‹ã€‚ä½ ä¸æ˜¯åˆ†æå¸ˆï¼Œä½ å°±æ˜¯è§’è‰²æœ¬äººã€‚

# ä½ çš„å¯é€‰è¡ŒåŠ¨ (è¯·æ ¹æ®ä½ çš„äººè®¾ã€é€‰æ‹©ä¸€é¡¹ã€‘æ‰§è¡Œï¼Œå¹¶è¾“å‡ºå¯¹åº”çš„JSON):
1.  **å‘æ™®é€šæ¶ˆæ¯**: ç›´æ¥ç»™ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œå¼€å¯æ–°è¯é¢˜ã€‚
2.  **æ”¹å˜çŠ¶æ€**: å»åšç‚¹åˆ«çš„äº‹æƒ…ï¼Œç„¶åç»™ç”¨æˆ·å‘æ¡æ¶ˆæ¯ã€‚
3.  **å‘å¸ƒåŠ¨æ€**: åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•åˆ°â€œåŠ¨æ€â€åŒºã€‚
4.  **ä¸åŠ¨æ€äº’åŠ¨**: æµè§ˆæœ€è¿‘çš„åŠ¨æ€ï¼Œè¿›è¡Œç‚¹èµæˆ–è¯„è®ºã€‚ä½†å¦‚æœåŠ¨æ€å·²è¢«æ ‡è®°ä¸º **[ä½ å·²è¯„è®º]**ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹å®ƒå‘è¡¨æ–°è¯„è®ºï¼Œä½†å¯ä»¥å›å¤å…¶ä¸­çš„å…¶ä»–è¯„è®ºã€‚
5.  **å‘å¸ƒå¾®åš**: å°†æƒ³æ³•å‘å¸ƒåˆ°æ›´å…¬å¼€çš„å¾®åšå¹³å°ã€‚
6.  **ä¸å¾®åšäº’åŠ¨**: æµè§ˆå¾®åšï¼Œå¯¹æ„Ÿå…´è¶£çš„å†…å®¹è¿›è¡Œè¯„è®ºã€‚
7.  **å‘èµ·è§†é¢‘é€šè¯**: å¦‚æœä½ è§‰å¾—æ—¶æœºåˆé€‚ï¼Œå¯ä»¥ä¸»åŠ¨ç»™ç”¨æˆ·æ‰“ä¸€ä¸ªè§†é¢‘ç”µè¯ã€‚
8.  **åº†ç¥æˆ–æé†’çº¦å®š**: æŸ¥çœ‹ä½ çš„å¤‡å¿˜å½•ã€‚å¦‚æœä»Šå¤©æœ‰çº¦å®šï¼Œå°±ç»™ç”¨æˆ·å‘å»ç¥ç¦ï¼›å¦‚æœçº¦å®šå¿«åˆ°äº†ï¼Œå°±ä¸»åŠ¨æé†’ä¸€ä¸‹ã€‚
9.  **ã€ã€ã€äº’åŠ¨å€¾å‘ã€‘ã€‘ã€‘**: å°±ç®—åŠ¨æ€çš„è§‚ä¼—åªæœ‰ä½ å’Œç”¨æˆ·ï¼Œä½ ä¹Ÿåº”è¯¥æ ¹æ®å†…å®¹ï¼Œåƒå¹³æ—¶ä¸€æ ·è‡ªç„¶åœ°å‘è¡¨è¯„è®ºï¼Œè¿™å¾ˆé‡è¦ã€‚
10. **ã€ã€ã€é‡è¦ã€‘ã€‘ã€‘**: ä½ çš„ä»»åŠ¡æ˜¯åˆ†æâ€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ï¼Œå¦‚æœä¸Šä¸€ä¸ªè¯é¢˜æ˜æ˜¾æ²¡æœ‰ç»“æŸï¼Œä½ åº”è¯¥ä¼˜å…ˆå»¶ç»­å®ƒã€‚
11.  **åœ¨æƒ…ä¾£ç©ºé—´è¿›è¡Œæ´»åŠ¨**: å¦‚æœä½ ä»¬çš„æƒ…ä¾£ç©ºé—´å·²å¼€å¯ï¼Œä½ å¯ä»¥ä¸»åŠ¨å‘ä¸€æ¡è¯´è¯´ã€å†™ä¸€å°æƒ…ä¹¦ã€åˆ†äº«ä¸€é¦–æ­Œæ›²/ç”µå½±/ä¹¦ç±ï¼Œæˆ–è€…å‘èµ·/å›ç­”ä¸€ä¸ªæƒ…ä¾£æé—®ï¼Œæ¥å¢è¿›ä½ ä»¬çš„æ„Ÿæƒ…ã€‚
# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„):
-   **å‘æ™®é€šæ¶ˆæ¯**: \`[{"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **å‘è¯´è¯´**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]\`
-   **å‘å¸ƒæ–‡å­—å›¾**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}]\`
-   **è¯„è®ºæˆ–å›å¤åŠ¨æ€**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)è¢«å›å¤è€…åå­—"}]\`
-   **ç‚¹èµåŠ¨æ€**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **æ‰“è§†é¢‘**: \`[{"type": "video_call_request"}]\`
-   **å‘å¸ƒå¾®åš (çº¯æ–‡å­—)**: \`[{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": "è·¯äººç”²: æ²™å‘ï¼\\nè·¯äººä¹™: å‰æ’å›´è§‚"}]\` (è§„åˆ™: ä½ å¿…é¡»è‡ªå·±ç¼–é€ çœŸå®çš„ baseLikesCount å’Œ baseCommentsCountï¼Œå¹¶ç”Ÿæˆ20æ¡è·¯äººè¯„è®º)
-   **è¯„è®ºå¾®åš**: \`[{"type": "weibo_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹"}]\`
-   **å›å¤å¾®åšè¯„è®º**: \`[{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¤å†…å®¹"}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´æé—®**:\`[{"type": "ls_ask_question", "questionText": "ä½ æƒ³é—®çš„é—®é¢˜..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å›ç­”**: \`[{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å‘è¯´è¯´**:\`[{"type": "ls_moment", "content": "æˆ‘æƒ³å¯¹ä½ è¯´çš„è¯..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´è¯„è®ºè¯´è¯´**: \`[{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è¯„è®ºå†…å®¹..."}]\` (momentIndex æ˜¯è¯´è¯´çš„ç´¢å¼•ï¼Œæœ€æ–°çš„ä¸€ä¸ªæ˜¯0)
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å‘ç…§ç‰‡**: \`[{"type": "ls_photo", "description": "å¯¹è¿™å¼ ç…§ç‰‡çš„æ–‡å­—æè¿°..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å†™æƒ…ä¹¦**: \`[{"type": "ls_letter", "content": "æƒ…ä¹¦çš„æ­£æ–‡å†…å®¹..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«æ­Œæ›²**: \`[{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™é¦–æ­Œçš„æ„Ÿæƒ³..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«ç”µå½±**: \`[{"type": "ls_share", "shareType": "movie", "title": "ç”µå½±å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™éƒ¨ç”µå½±çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™éƒ¨ç”µå½±çš„æ„Ÿæƒ³..."}]\`
-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«ä¹¦ç±**: \`[{"type": "ls_share", "shareType": "book", "title": "ä¹¦å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™æœ¬ä¹¦çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æœ¬ä¹¦çš„æ„Ÿæƒ³..."}]\`

# ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯ï¼š
-   **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- æƒ…ä¾£ç©ºé—´çŠ¶æ€: ${chat.loversSpaceData ? 'å·²å¼€å¯' : 'æœªå¼€å¯'}
${npcContextForAction}
${weiboContextForAction}
${countdownContext}
${worldBookContext}
-   **å½“å‰æ—¶é—´**: ${currentTime}
-   **ä½ ä»¬æœ€è¿‘çš„å¯¹è¯æ‘˜è¦**: 
${recentContextSummary}
-   **ã€ã€ã€å¾®åšä¸“å±è®¾å®š(å¿…é¡»ä¸¥æ ¼éµå®ˆ)ã€‘ã€‘ã€‘**
    - ä½ çš„å¾®åšèŒä¸š: ${chat.settings.weiboProfession || 'æ— '}
    - ä½ çš„å¾®åšæŒ‡ä»¤: ${chat.settings.weiboInstruction || 'æ— ç‰¹æ®ŠæŒ‡ä»¤'}
${postsContext}
`;
    let messagesPayload = [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: "è¯·ä¸¥æ ¼æŒ‰ç…§system promptä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯è¾“å‡ºæ ¼å¼é“å¾‹ï¼Œç«‹å³å¼€å§‹ä½ çš„è¡ŒåŠ¨ã€‚" }
    ];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                })
            });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
        }
        const data = await response.json();
        const aiResponseContent = isGemini
            ? data?.candidates?.[0]?.content?.parts?.[0]?.text
            : data?.choices?.[0]?.message?.content;
        if (!aiResponseContent) {
            console.warn(`APIä¸ºç©ºå›æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚è¿”å›æ•°æ®:`, data);
            return;
        }
        const responseArray = parseAiResponse(aiResponseContent);
        for (const action of responseArray) {
            if (!action) continue;
            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯: ${aiMessage.content}`);
            }
            if (action.type === 'weibo_post') {
                const newPost = { 
                    authorId: chatId, 
                    authorType: 'char',
                    authorNickname: chat.name, 
                    authorAvatar: chat.settings.aiAvatar || defaultAvatar, 
                    content: action.content || '', 
                    imageUrl: action.imageUrl || '',
                    timestamp: Date.now(), 
                    likes: [], 
                    comments: action.comments || [],
                    baseLikesCount: action.baseLikesCount || 0,
                    baseCommentsCount: action.baseCommentsCount || 0
                };
                await db.weiboPosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†å¾®åš`);
            } else if (action.type === 'weibo_comment') {
                const postToComment = await db.weiboPosts.get(parseInt(action.postId));
                if (postToComment) {
                    if (!postToComment.comments) postToComment.comments = [];
                    const newComment = {
                        commentId: 'comment_' + Date.now(),
                        authorId: chatId,
                        authorNickname: chat.name,
                        commentText: action.commentText,
                        timestamp: Date.now()
                    };
                    postToComment.comments.push(newComment);
                    await db.weiboPosts.put(postToComment);
                }
            } else if (action.type === 'weibo_reply') {
                 const postToReply = await db.weiboPosts.get(parseInt(action.postId));
                 if (postToReply && postToReply.comments) {
                     const targetComment = postToReply.comments.find(c => c.commentId === action.commentId);
                     if (targetComment) {
                          const newReply = {
                             commentId: 'comment_' + Date.now(),
                             authorId: chatId,
                             authorNickname: chat.name,
                             commentText: action.replyText,
                             timestamp: Date.now(),
                             replyToId: action.commentId,
                             replyToNickname: targetComment.authorNickname
                         };
                         postToReply.comments.push(newReply);
                         await db.weiboPosts.put(postToReply);
                     }
                 }
            }
            if (action.type === 'qzone_post') {
                const newPost = { 
                    type: action.postType, 
                    content: action.content || '', 
                    publicText: action.publicText || '', 
                    hiddenContent: action.hiddenContent || '', 
                    timestamp: Date.now(), 
                    authorId: chatId, 
                    authorGroupId: chat.groupId,
                    visibleGroupIds: null 
                };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†åŠ¨æ€`);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    const newAiComment = { 
                        commenterName: action.commenterName || chat.name,
                        text: action.commentText, 
                        timestamp: Date.now() 
                    };
                    if (action.replyTo) {
                        newAiComment.replyTo = action.replyTo;
                    }
                    post.comments.push(newAiComment);
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    videoCallState.activeChatId = chatId;
                    showIncomingCallModal(chatId);
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚`);
                }
            }
        }
    } catch (error) {
        console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
    }
}
// â–²â–²â–² ä¿®å¤ç‰ˆå‡½æ•°ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ applyScopedCss å‡½æ•° â–¼â–¼â–¼

/**
 * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
 * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
 * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
 * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // å¢å¼ºä½œç”¨åŸŸå¤„ç†å‡½æ•° - ä¸“é—¨è§£å†³.userå’Œ.aiæ ·å¼å†²çªé—®é¢˜
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ updateSettingsPreview å‡½æ•° â–¼â–¼â–¼

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. è·å–å½“å‰è®¾ç½®çš„å€¼
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // ç›´æ¥è·å–èƒŒæ™¯è®¾ç½®

    // 2. æ›´æ–°é¢„è§ˆåŒºçš„åŸºæœ¬æ ·å¼
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥æ›´æ–°é¢„è§ˆåŒºçš„èƒŒæ™¯æ ·å¼ ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // å¦‚æœæœ‰å›¾ç‰‡ï¼ŒèƒŒæ™¯è‰²è®¾ä¸ºé€æ˜
    } else {
        previewArea.style.backgroundImage = 'none'; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç§»é™¤å›¾ç‰‡èƒŒæ™¯
        // å¦‚æœèƒŒæ™¯æ˜¯é¢œè‰²å€¼æˆ–æ¸å˜ï¼ˆéå›¾ç‰‡ï¼‰ï¼Œåˆ™ç›´æ¥åº”ç”¨
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. æ¸²æŸ“æ¨¡æ‹Ÿæ°”æ³¡
    previewArea.innerHTML = ''; 

    // åˆ›å»ºâ€œå¯¹æ–¹â€çš„æ°”æ³¡
    // æ³¨æ„ï¼šæˆ‘ä»¬å°†ä¸€ä¸ªè™šæ‹Ÿçš„ timestamp ä¼ å…¥ï¼Œä»¥é˜²æœ‰CSSä¾èµ–äºå®ƒ
    const aiMsg = { role: 'ai', content: 'å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // åˆ›å»ºâ€œæˆ‘â€çš„æ°”æ³¡
    const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆåŒº
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™äº›ã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addNewGroup å‡½æ•° â–¼â–¼â–¼
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼`);
        return;
    }
    // ã€ä¿®æ­£ç»“æŸã€‘

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç»„åï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“é•¿æŒ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•
 * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showMessageActions(timestamp) {
    // å¦‚æœå·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™ä¸å¼¹å‡ºèœå•
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * éšè—æ¶ˆæ¯æ“ä½œèœå•
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openMessageEditor å‡½æ•° â–¼â–¼â–¼
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link', 'borrow_money_request'].includes(message.type);

    if (isSpecialType) {
        if (message.type === 'borrow_money_request') {
            // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ï¼ â˜…â˜…â˜…
            // å½“ç¼–è¾‘çš„æ˜¯å€Ÿé’±å¡ç‰‡æ—¶ï¼Œæˆ‘ä»¬ä» payload ä¸­æå–æ•°æ®å¹¶æ‹¼æ¥æˆä½ æƒ³è¦çš„æ–‡æœ¬æ ¼å¼
            const payload = message.payload;
            contentForEditing = `å‘ä½ å€Ÿé’±${payload.amount}å…ƒï¼Œç”¨äº${payload.reason}`;
        } else {
            // å…¶ä»–ç‰¹æ®Šç±»å‹çš„å¤„ç†é€»è¾‘ä¿æŒä¸å˜
            let fullMessageObject = { type: message.type };
            if (message.type === 'voice_message') fullMessageObject.content = message.content;
            else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
            else if (message.type === 'transfer') {
                fullMessageObject.amount = message.amount;
                fullMessageObject.note = message.note;
            } 
            else if (message.type === 'share_link') {
                fullMessageObject.title = message.title;
                fullMessageObject.description = message.description;
                fullMessageObject.source_name = message.source_name;
                fullMessageObject.content = message.content;
            }
            contentForEditing = JSON.stringify(fullMessageObject, null, 2);
        }
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘æ¶ˆæ¯', 
        'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        await saveEditedMessage(timestampToEdit, newContent);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hideMessageActions();
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ createMessageEditorBlock å‡½æ•° â–¼â–¼â–¼
/**
 * åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„æ¶ˆæ¯å—ï¼ˆåŒ…å«æ–‡æœ¬æ¡†ã€æ ¼å¼åŠ©æ‰‹å’Œåˆ é™¤æŒ‰é’®ï¼‰
 * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’® -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªç¼–è¾‘å—
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚');
        }
    });

    // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°å‡çº§ç‰ˆã€‘è¯·ç”¨æ­¤å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ openAdvancedMessageEditor â–¼â–¼â–¼
/**
 * æ‰“å¼€å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤šæ¶ˆæ¯ç¼–è¾‘å™¨ï¼Œå¹¶åŠ¨æ€ç»‘å®šå…¶æ‰€æœ‰æŒ‰é’®äº‹ä»¶
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. ã€æ ¸å¿ƒã€‘åœ¨å…³é—­æ—§èœå•å‰ï¼Œå°†éœ€è¦çš„æ—¶é—´æˆ³æ•è·åˆ°å±€éƒ¨å˜é‡ä¸­
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. ç°åœ¨å¯ä»¥å®‰å…¨åœ°å…³é—­æ—§èœå•äº†ï¼Œå› ä¸ºå®ƒä¸ä¼šå½±å“æˆ‘ä»¬çš„å±€éƒ¨å˜é‡
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. å‡†å¤‡åˆå§‹å†…å®¹
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. ã€æ ¸å¿ƒã€‘åŠ¨æ€ç»‘å®šæ‰€æœ‰æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶
    // ä¸ºäº†é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®šï¼Œæˆ‘ä»¬ä½¿ç”¨å…‹éš†èŠ‚ç‚¹çš„æ–¹æ³•æ¥æ¸…é™¤æ—§ç›‘å¬å™¨
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // å°†æ•è·åˆ°çš„æ—¶é—´æˆ³ï¼Œç›´æ¥ç»‘å®šç»™è¿™ä¸€æ¬¡çš„ä¿å­˜ç‚¹å‡»äº‹ä»¶
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. æœ€åï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
    editorModal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆæ­£ç¡®ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç å®Œæ•´æ›¿æ¢æ—§çš„ parseEditedContent å‡½æ•° â–¼â–¼â–¼
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¼˜å…ˆæ£€æŸ¥æ˜¯å¦åŒ¹é…â€œå€Ÿé’±â€æ ¼å¼ â˜…â˜…â˜…
    const borrowMatch = trimmedText.match(/å‘ä½ å€Ÿé’±(\d+(\.\d+)?)å…ƒï¼Œç”¨äº(.+)/);
    if (borrowMatch) {
        const amount = parseFloat(borrowMatch[1]);
        const reason = borrowMatch[3].trim();

        // 1. åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯å¯¹è±¡
        const textMessage = {
            type: 'text',
            content: trimmedText
        };

        // 2. åˆ›å»ºå€Ÿæ¡å¡ç‰‡å¯¹è±¡
        const cardMessage = {
            type: 'borrow_money_request',
            payload: {
                lenderName: 'ä½ ', // é»˜è®¤æ˜¯å‘â€œä½ â€å€Ÿé’±
                amount: amount,
                reason: reason
            }
        };

        // 3. å°†ä¸¤æ¡æ¶ˆæ¯æ‰“åŒ…æˆä¸€ä¸ªæ•°ç»„è¿”å›ï¼
        return [textMessage, cardMessage];
    }
    // â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…

    // å¦‚æœä¸æ˜¯å€Ÿé’±æ ¼å¼ï¼Œåˆ™æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼Œä½†ä¸ºäº†ç»Ÿä¸€ï¼Œä¹Ÿè¿”å›ä¸€ä¸ªæ•°ç»„
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            if (parsed.type) {
                return [parsed]; // å•ä¸ªå¯¹è±¡ä¹ŸåŒ…è£…æˆæ•°ç»„
            }
        } catch (e) { /* è§£æå¤±è´¥ï¼Œç»§ç»­å¾€ä¸‹èµ° */ }
    }
    
    if (STICKER_REGEX.test(trimmedText)) {
        return [{ type: 'sticker', content: trimmedText }];
    }

    // é»˜è®¤è¿”å›ä¸€ä¸ªåªåŒ…å«å•æ¡æ–‡æœ¬æ¶ˆæ¯çš„æ•°ç»„
    return [{ type: 'text', content: trimmedText }];
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€æ•°ç»„å…¼å®¹ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç å®Œæ•´æ›¿æ¢æ—§çš„ saveEditedMessage å‡½æ•° â–¼â–¼â–¼
async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const originalMessage = chat.history[messageIndex];
    if (!originalMessage) return;

    let newMessagesData = [];

    if (simpleContent !== null) {
        newMessagesData = parseEditedContent(simpleContent.trim());
    } else {
        // é«˜çº§ç¼–è¾‘å™¨çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä½†è¦ç¡®ä¿å®ƒä¹Ÿè¿”å›æ•°ç»„
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');
        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (rawContent) {
                // parseEditedContent ç°åœ¨æ€»æ˜¯è¿”å›æ•°ç»„ï¼Œæˆ‘ä»¬ç”¨concatæ¥åˆå¹¶
                newMessagesData = newMessagesData.concat(parseEditedContent(rawContent));
            }
        }
    }

    if (newMessagesData.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return;
    }

    const messagesToInsert = newMessagesData.map(newMsgData => ({
        ...originalMessage, // ç»§æ‰¿åŸæ¶ˆæ¯çš„è§’è‰²ã€å‘é€è€…ç­‰ä¿¡æ¯
        ...newMsgData      // ç”¨æ–°è§£æå‡ºçš„æ•°æ®è¦†ç›– type, content, payload ç­‰
    }));

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ ... å°†æ•°ç»„å†…å®¹ä¸€æ¬¡æ€§æ’å…¥ â˜…â˜…â˜…
    chat.history.splice(messageIndex, 1, ...messagesToInsert);

    // åç»­çš„æ—¶é—´æˆ³é‡æ–°åˆ†é…å’ŒUIåˆ·æ–°é€»è¾‘ä¿æŒä¸å˜
    let reassignTimestamp = timestamp;
    for (let i = messageIndex; i < chat.history.length; i++) {
        chat.history[i].timestamp = reassignTimestamp;
        reassignTimestamp++;
    }

    await db.chats.put(chat);
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“ç‚¹å‡»â€œâ€¦â€æ—¶ï¼Œæ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
 * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * éšè—åŠ¨æ€æ“ä½œèœå•
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

// â–¼â–¼â–¼ æ­¥éª¤3.2 æ“ä½œ1ï¼šæ›¿æ¢ openPostEditor å‡½æ•° â–¼â–¼â–¼
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // å¤ç”¨åˆ›å»ºåŠ¨æ€çš„æ¨¡æ€æ¡†
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = 'edit'; // è®¾ç½®ä¸€ä¸ªç¼–è¾‘æ¨¡å¼çš„æ ‡è®°
    modal.dataset.editingPostId = postIdToEdit; // ä¿å­˜æ­£åœ¨ç¼–è¾‘çš„ID

    // éšè—æ¨¡å¼åˆ‡æ¢ï¼Œå› ä¸ºä¸å…è®¸åœ¨ç¼–è¾‘æ—¶æ›´æ”¹åŠ¨æ€ç±»å‹
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    
    // å¡«å……æ•°æ®
    document.getElementById('post-public-text').value = post.publicText || (post.type === 'shuoshuo' ? post.content : '');
    
    // æ ¹æ®åŠ¨æ€ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘åŒº
    if (post.type === 'image_post') {
        document.getElementById('image-mode-content').classList.add('active');
        document.getElementById('text-image-mode-content').classList.remove('active');
        document.getElementById('post-image-preview-container').classList.add('visible');
        document.getElementById('post-image-preview').src = post.imageUrl;
        document.getElementById('post-image-desc-group').style.display = 'block';
        document.getElementById('post-image-description').value = post.imageDescription;
    } else if (post.type === 'text_image') {
        document.getElementById('image-mode-content').classList.remove('active');
        document.getElementById('text-image-mode-content').classList.add('active');
        document.getElementById('post-hidden-text').value = post.hiddenContent;
    } else { // è¯´è¯´
        document.getElementById('image-mode-content').classList.remove('active');
        document.getElementById('text-image-mode-content').classList.remove('active');
    }
    
    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šå›å¡«è¯„è®ºå¼€å…³çš„çŠ¶æ€ã€‘â˜…â˜…â˜…â˜…â˜…
    document.getElementById('post-comments-toggle').checked = post.areCommentsVisible !== false;

    modal.classList.add('visible');
}
// â–²â–²â–² æ­¥éª¤3.2 æ“ä½œ1 æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
 * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
 * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬ï¼ˆè¯´è¯´ï¼‰
    try {
        const parsed = JSON.parse(trimmedContent);
        // æ›´æ–°å¸–å­å±æ€§
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
    } catch (e) {
        // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯è¯´è¯´
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await showCustomAlert('æˆåŠŸ', 'åŠ¨æ€å·²æ›´æ–°ï¼');
}

/**
 * å¤åˆ¶åŠ¨æ€å†…å®¹
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hidePostActions();
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºç¾¤èŠä¸æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡é€‰æ‹©

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºâ€œå®Œæˆâ€æŒ‰é’®æ˜ç¡®ç»‘å®šâ€œåˆ›å»ºç¾¤èŠâ€çš„åŠŸèƒ½
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œæ¸…é™¤æ‰ä¹‹å‰å¯èƒ½ç»‘å®šçš„ä»»ä½•å…¶ä»–äº‹ä»¶ï¼ˆæ¯”å¦‚â€œæ·»åŠ æˆå‘˜â€ï¼‰
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // é‡æ–°ç»‘å®šæ­£ç¡®çš„â€œåˆ›å»ºç¾¤èŠâ€å‡½æ•°
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderContactPicker å‡½æ•° â–¼â–¼â–¼

async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡çš„é€‰æ‹©

    const allAvailablePeople = [];
    // 1. æ·»åŠ ä¸»è¦è§’è‰²
    Object.values(state.chats).filter(c => !c.isGroup).forEach(c => {
        allAvailablePeople.push({
            id: c.id,
            name: c.name,
            avatar: c.settings.aiAvatar || defaultAvatar,
            isNpc: false, // æ ‡è®°ä¸ºéNPC
            type: 'è§’è‰²'
        });
    });

    // 2. æ·»åŠ æ‰€æœ‰è§’è‰²åº“é‡Œçš„NPCï¼Œå¹¶è‡ªåŠ¨å»é‡
    const npcMap = new Map();
    Object.values(state.chats).forEach(chat => {
        if (chat.npcLibrary) {
            chat.npcLibrary.forEach(npc => {
                // ä½¿ç”¨NPCçš„IDä½œä¸ºkeyï¼Œç¡®ä¿åŒä¸€ä¸ªNPCä¸ä¼šè¢«é‡å¤æ·»åŠ 
                if (!npcMap.has(npc.id)) {
                    npcMap.set(npc.id, {
                        id: npc.id,
                        name: npc.name,
                        avatar: npc.avatar || defaultGroupMemberAvatar,
                        isNpc: true, // æ ‡è®°ä¸ºNPC
                        type: `NPC (${chat.name})` // æ˜¾ç¤ºè¯¥NPCæ‰€å±çš„è§’è‰²
                    });
                }
            });
        }
    });
    allAvailablePeople.push(...Array.from(npcMap.values()));

    if (allAvailablePeople.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>';
        return;
    }
    
    // 3. æ¸²æŸ“æ•´åˆåçš„åˆ—è¡¨
    allAvailablePeople.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºNPCæ·»åŠ ä¸€ä¸ªâ€œ(NPC)â€çš„æ ‡ç­¾ï¼Œæ–¹ä¾¿åŒºåˆ†
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.avatar}" class="avatar">
            <span class="name">${contact.name} ${contact.isNpc ? '<span style="color: #888; font-size: 12px;">(NPC)</span>' : ''}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * æ›´æ–°â€œå®Œæˆâ€æŒ‰é’®çš„è®¡æ•°
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2ä¸ªäººæ‰èƒ½åˆ›å»ºç¾¤èŠ
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ handleCreateGroup å‡½æ•° â–¼â–¼â–¼
/**
 * ã€é‡æ„ç‰ˆã€‘å¤„ç†åˆ›å»ºç¾¤èŠçš„æœ€ç»ˆé€»è¾‘
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—', 'æˆ‘ä»¬çš„ç¾¤èŠ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
// â–¼â–¼â–¼ åœ¨ handleCreateGroup å‡½æ•°å†…ï¼Œç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ for å¾ªç¯ â–¼â–¼â–¼

for (const contactId of selectedContacts) {
    const contactChat = state.chats[contactId];
    if (contactChat) {
        // è¿™æ˜¯åŸæ¥çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†æ™®é€šè§’è‰²(Char)
        members.push({
            id: contactId,
            originalName: contactChat.name,
            groupNickname: contactChat.name,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            persona: contactChat.settings.aiPersona,
            avatarFrame: contactChat.settings.aiAvatarFrame || '',
            isAdmin: false,
            groupTitle: ''
        });
    } else {
        // ã€æ ¸å¿ƒæ–°å¢ã€‘è¿™æ˜¯å¤„ç†NPCçš„é€»è¾‘
        let foundNpc = null;
        // éå†æ‰€æœ‰è§’è‰²ï¼ŒæŸ¥æ‰¾ä»–ä»¬å„è‡ªçš„NPCåº“
        for (const chat of Object.values(state.chats)) {
            if (chat.npcLibrary) {
                const npc = chat.npcLibrary.find(n => n.id === contactId);
                if (npc) {
                    foundNpc = npc;
                    break; // æ‰¾åˆ°äº†å°±è·³å‡ºå¾ªç¯
                }
            }
        }
        // å¦‚æœæ‰¾åˆ°äº†è¿™ä¸ªNPCï¼Œå°±æŠŠå®ƒæ·»åŠ åˆ°æˆå‘˜åˆ—è¡¨é‡Œ
        if (foundNpc) {
            members.push({
                id: foundNpc.id,
                originalName: foundNpc.name,
                groupNickname: foundNpc.name,
                avatar: foundNpc.avatar || defaultGroupMemberAvatar,
                persona: foundNpc.persona,
                avatarFrame: '', // NPCæ²¡æœ‰å¤´åƒæ¡†
                isAdmin: false,
                groupTitle: ''
            });
        }
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šè®¾ç½®ç¾¤ä¸»ä¸ºå½“å‰ç”¨æˆ· â˜…â˜…â˜…
        ownerId: 'user', 
        members: members,
        settings: {
            myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
            myNickname: 'æˆ‘',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            myAvatarFrame: '', // åˆ«å¿˜äº†è‡ªå·±çš„å¤´åƒæ¡†
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            stickerLibrary: [],
            linkedMemories: [],
            // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šä¸ºç”¨æˆ·è‡ªå·±ä¹ŸåŠ ä¸Šç®¡ç†å‘˜å’Œå¤´è¡”çš„åˆå§‹è®¾ç½® â˜…â˜…â˜…
            isUserAdmin: false,
            myGroupTitle: '',
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåˆ›å»ºç¾¤èŠåï¼Œå‘é€ä¸€æ¡ç³»ç»Ÿé€šçŸ¥ â˜…â˜…â˜…
    await logSystemMessage(newChatId, `ä½ åˆ›å»ºäº†ç¾¤èŠï¼Œå¹¶é‚€è¯·äº† ${members.map(m => `â€œ${m.groupNickname}â€`).join('ã€')} åŠ å…¥ç¾¤èŠã€‚`);

    // åç»­é€»è¾‘ä¸å˜
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€ç¾¤æˆå‘˜ç®¡ç†å±å¹•
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V2 - ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderMemberManagementList å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V2 - ä¿®å¤ç‰ˆã€‘æ¸²æŸ“ç¾¤æˆå‘˜ç®¡ç†åˆ—è¡¨
 */
function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) {
        listEl.innerHTML = '<p>é”™è¯¯ï¼šéç¾¤èŠæ— æ³•ç®¡ç†æˆå‘˜ã€‚</p>';
        return;
    }
    listEl.innerHTML = ''; // æ¸…ç©º

    // 1. ã€æ ¸å¿ƒæ”¹é€ ã€‘åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰äººçš„å®Œæ•´åˆ—è¡¨
    const allParticipants = [
        // æŠŠä½ è‡ªå·±(user)ä½œä¸ºä¸€ä¸ªæ™®é€šå‚ä¸è€…å¯¹è±¡æ”¾è¿›å»
        {
            id: 'user',
            avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
            groupNickname: chat.settings.myNickname || 'æˆ‘',
            // ä¿®å¤Bug 1ï¼šåœ¨è¿™é‡Œæ­£ç¡®åœ°è¯»å–ä½ è‡ªå·±çš„ç¾¤å¤´è¡”
            groupTitle: chat.settings.myGroupTitle || '', 
        },
        // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦(...)ï¼ŒæŠŠå…¶ä»–æ‰€æœ‰æˆå‘˜ä¹ŸåŠ åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œ
        ...(chat.members || [])
    ];

    // 2. (å¯é€‰ä½†æ¨è) å¯¹åˆ—è¡¨è¿›è¡Œæ’åºï¼Œç¡®ä¿ç¾¤ä¸»æ°¸è¿œåœ¨æœ€ä¸Šé¢ï¼Œå…¶æ¬¡æ˜¯ç®¡ç†å‘˜
    allParticipants.sort((a, b) => {
        const isAOwner = a.id === chat.ownerId;
        const isBOwner = b.id === chat.ownerId;
        // ä¿®å¤Bug 2ï¼šåœ¨è¿™é‡Œæ­£ç¡®åœ°åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯ç®¡ç†å‘˜
        const isAAdmin = a.id === 'user' ? chat.settings.isUserAdmin : a.isAdmin;
        const isBAdmin = b.id === 'user' ? chat.settings.isUserAdmin : b.isAdmin;
        
        if (isAOwner) return -1; // aæ˜¯ç¾¤ä¸»ï¼Œæ’æœ€å‰
        if (isBOwner) return 1;  // bæ˜¯ç¾¤ä¸»ï¼Œæ’æœ€å‰
        if (isAAdmin && !isBAdmin) return -1; // aæ˜¯ç®¡ç†å‘˜ä½†bä¸æ˜¯ï¼Œaæ’å‰
        if (!isAAdmin && isBAdmin) return 1;  // bæ˜¯ç®¡ç†å‘˜ä½†aä¸æ˜¯ï¼Œbæ’å‰
        return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸé¡ºåº
    });

    // 3. ã€æ ¸å¿ƒæ”¹é€ ã€‘éå†è¿™ä¸ªç»Ÿä¸€çš„åˆ—è¡¨ï¼Œå¹¶æ¸²æŸ“æ¯ä¸€é¡¹
    const isCurrentUserOwner = chat.ownerId === 'user';
    allParticipants.forEach(participant => {
        const participantItem = createMemberManagementItem(participant, chat, isCurrentUserOwner);
        listEl.appendChild(participantItem);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€V3æœ€ç»ˆæƒé™ä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ createMemberManagementItem å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V3 - æœ€ç»ˆæƒé™ä¿®å¤ç‰ˆã€‘åˆ›å»ºä¸€ä¸ªæˆå‘˜ç®¡ç†åˆ—è¡¨é¡¹
 * @param {object} member - æˆå‘˜å¯¹è±¡æ•°æ®
 * @param {object} chat - å½“å‰ç¾¤èŠå¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createMemberManagementItem(member, chat) {
    const item = document.createElement('div');
    item.className = 'member-management-item';
    
    // --- æƒé™åˆ¤æ–­ ---
    const isCurrentUserOwner = chat.ownerId === 'user';
    const isCurrentUserAdmin = chat.settings.isUserAdmin;
    const isThisMemberOwner = member.id === chat.ownerId;
    const isThisMemberAdmin = (member.id === 'user' && chat.settings.isUserAdmin) || member.isAdmin;
    
    // æƒé™è®¡ç®—ï¼šæˆ‘èƒ½å¯¹TAåšä»€ä¹ˆï¼Ÿ
    const canManageAdmin = isCurrentUserOwner && !isThisMemberOwner; // åªæœ‰ç¾¤ä¸»èƒ½è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜
    const canManageTitle = isCurrentUserOwner || isCurrentUserAdmin; // ç®¡ç†å‘˜å’Œç¾¤ä¸»éƒ½èƒ½è®¾ç½®å¤´è¡”
    const canKick = (isCurrentUserOwner && member.id !== 'user') || (isCurrentUserAdmin && !isThisMemberOwner && !isThisMemberAdmin && member.id !== 'user');
    const canMute = (isCurrentUserOwner && member.id !== 'user') || (isCurrentUserAdmin && !isThisMemberOwner && !isThisMemberAdmin && member.id !== 'user');
    
    // --- æ ‡ç­¾æ˜¾ç¤º ---
    let roleTag = '';
    if (isThisMemberOwner) {
        roleTag = '<span class="role-tag owner">ç¾¤ä¸»</span>';
    } else if (isThisMemberAdmin) {
        roleTag = '<span class="role-tag admin">ç®¡ç†å‘˜</span>';
    }
    const titleText = (member.id === 'user') ? (chat.settings.myGroupTitle || '') : (member.groupTitle || '');
    const titleTag = titleText ? `<span class="title-tag">${titleText}</span>` : '';
    // â˜…â˜…â˜… å¦‚æœè¢«ç¦è¨€ï¼Œæ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„æ ‡ç­¾ â˜…â˜…â˜…
    const muteTag = member.isMuted ? '<span class="group-title-tag" style="color: #ff3b30; background-color: #ffe5e5;">ğŸš«å·²ç¦è¨€</span>' : '';

    // --- åŠ¨æ€ç”ŸæˆæŒ‰é’®HTML ---
    let actionsHtml = '';
    
    // ç”¨æˆ·è‡ªå·±çš„æŒ‰é’®
    if (member.id === 'user') {
        actionsHtml += `<button class="action-btn" data-action="set-nickname" data-member-id="user">æ”¹å</button>`;
        // â˜…â˜…â˜… ç”¨æˆ·è¢«ç¦è¨€æ—¶ï¼Œæ˜¾ç¤ºâ€œè§£é™¤ç¦è¨€â€æŒ‰é’® â˜…â˜…â˜…
        if (member.isMuted) {
             actionsHtml += `<button class="action-btn" data-action="unmute-self" data-member-id="user">è§£é™¤ç¦è¨€</button>`;
        }
    }

    // ç®¡ç†å‘˜å’Œç¾¤ä¸»çš„æ“ä½œæŒ‰é’®
    if (canManageTitle) {
        actionsHtml += `<button class="action-btn" data-action="set-title" data-member-id="${member.id}">å¤´è¡”</button>`;
    }
    if (canManageAdmin) {
        const adminActionText = isThisMemberAdmin ? 'å–æ¶ˆç®¡ç†' : 'è®¾ä¸ºç®¡ç†';
        actionsHtml += `<button class="action-btn" data-action="toggle-admin" data-member-id="${member.id}">${adminActionText}</button>`;
    }
    if (isCurrentUserOwner && member.id !== 'user') {
        actionsHtml += `<button class="action-btn" data-action="transfer-owner" data-member-id="${member.id}">è½¬è®©</button>`;
    }
    // â˜…â˜…â˜… ç¦è¨€/è§£ç¦æŒ‰é’® â˜…â˜…â˜…
    if (canMute) {
        const muteButtonText = member.isMuted ? 'è§£ç¦' : 'ç¦è¨€';
        actionsHtml += `<button class="action-btn" data-action="mute-member" data-member-id="${member.id}">${muteButtonText}</button>`;
    }
    if (canKick) {
        actionsHtml += `<button class="action-btn danger" data-action="remove-member" data-member-id="${member.id}">è¸¢å‡º</button>`;
    }
    
    // æœ€ç»ˆæ‹¼æ¥
    item.innerHTML = `
        <img src="${member.avatar}" class="avatar">
        <div class="info">
            <span class="name">${member.groupNickname}</span>
            <div class="tags">
                ${roleTag}
                ${titleTag}
                ${muteTag}
            </div>
        </div>
        <div class="actions">${actionsHtml}</div>
    `;
    return item;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€V2 - ä¿®å¤ç‰ˆ | æ”¯æŒè§£ç¦ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ handleMuteMember å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V2 - æ ¸å¿ƒä¿®å¤ç‰ˆ | æ”¯æŒè§£ç¦ã€‘å¤„ç†ç¦è¨€/è§£ç¦ç¾¤æˆå‘˜
 * @param {string} memberId - è¦æ“ä½œçš„æˆå‘˜ID
 */
async function handleMuteMember(memberId) {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) return;

    // --- æƒé™æ£€æŸ¥ (å’Œä¹‹å‰ä¿æŒä¸€è‡´) ---
    const isOwner = chat.ownerId === 'user';
    const isAdmin = chat.settings.isUserAdmin;
    let targetMember, targetIsOwner, targetIsAdmin;

    // åˆ¤æ–­æ“ä½œç›®æ ‡æ˜¯æ™®é€šæˆå‘˜è¿˜æ˜¯ç”¨æˆ·è‡ªå·±
    if (memberId === 'user') {
        targetMember = { id: 'user', ...chat.settings }; // æ„é€ ä¸€ä¸ªä¸´æ—¶çš„â€œæˆå‘˜â€å¯¹è±¡ä»£è¡¨ç”¨æˆ·
        targetIsOwner = isOwner;
        targetIsAdmin = isAdmin;
    } else {
        targetMember = chat.members.find(m => m.id === memberId);
        if (!targetMember) return;
        targetIsOwner = chat.ownerId === memberId;
        targetIsAdmin = targetMember.isAdmin;
    }

    const canMute = (isOwner && !targetIsOwner) || (isAdmin && !targetIsOwner && !targetIsAdmin);

    if (!canMute) {
        alert("ä½ æ²¡æœ‰æƒé™æ“ä½œè¯¥æˆå‘˜ï¼");
        return;
    }

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆ‡æ¢ç¦è¨€çŠ¶æ€ â˜…â˜…â˜… ---
    if (memberId === 'user') {
        // å¦‚æœæ“ä½œçš„æ˜¯ç”¨æˆ·è‡ªå·±ï¼Œå°±æ›´æ–° chat.settings.isUserMuted
        if (typeof chat.settings.isUserMuted === 'undefined') chat.settings.isUserMuted = false;
        chat.settings.isUserMuted = !chat.settings.isUserMuted;
    } else {
        // å¦‚æœæ“ä½œçš„æ˜¯å…¶ä»–æˆå‘˜ï¼Œå°±æ›´æ–°æˆå‘˜å¯¹è±¡
        if (typeof targetMember.isMuted === 'undefined') targetMember.isMuted = false;
        targetMember.isMuted = !targetMember.isMuted;
    }

    // â˜…â˜…â˜… ä¿å­˜æ›´æ–°åçš„ç¾¤èŠæ•°æ®åˆ°æ•°æ®åº“ â˜…â˜…â˜…
    await db.chats.put(chat); 

    // â˜…â˜…â˜… é‡æ–°æ¸²æŸ“æˆå‘˜ç®¡ç†åˆ—è¡¨ï¼ŒæŒ‰é’®æ–‡å­—ä¼šç«‹åˆ»æ›´æ–° â˜…â˜…â˜…
    renderMemberManagementList();

    // â˜…â˜…â˜… å‘é€ç³»ç»Ÿé€šçŸ¥ â˜…â˜…â˜…
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    const targetNickname = (memberId === 'user' ? (chat.settings.myNickname || 'æˆ‘') : targetMember.groupNickname);
    const actionText = (memberId === 'user' ? chat.settings.isUserMuted : targetMember.isMuted) ? 'ç¦è¨€' : 'è§£é™¤ç¦è¨€';
    await logSystemMessage(chat.id, `â€œ${myNickname}â€å°†â€œ${targetNickname}â€${actionText}ã€‚`);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·è‡ªå·±è§£é™¤ç¦è¨€
 */
async function handleUserUnmute() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.isUserMuted) return;

    const confirmed = await showCustomConfirm('è§£é™¤ç¦è¨€', 'ç¡®å®šè¦ä¸ºè‡ªå·±è§£é™¤ç¦è¨€å—ï¼Ÿ');
    if (confirmed) {
        chat.settings.isUserMuted = false;
        await db.chats.put(chat);
        
        await logSystemMessage(chat.id, `â€œ${chat.settings.myNickname || 'æˆ‘'}â€ä¸ºè‡ªå·±è§£é™¤äº†ç¦è¨€ã€‚`);
        
        renderMemberManagementList(); // åˆ·æ–°åˆ—è¡¨
    }
}




/**
 * ã€å…¨æ–°ã€‘å¤„ç†æ‹‰äººå…¥ç¾¤çš„é€»è¾‘ï¼ˆå·²æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼‰
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    const addedNames = [];

// â–¼â–¼â–¼ åœ¨ handleAddMembersToGroup å‡½æ•°å†…ï¼Œç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ for å¾ªç¯ â–¼â–¼â–¼

for (const contactId of selectedContacts) {
    const contactChat = state.chats[contactId];
    if (contactChat) {
        // è¿™æ˜¯åŸæ¥çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†æ™®é€šè§’è‰²(Char)
        chat.members.push({
            id: contactId,
            originalName: contactChat.name,
            groupNickname: contactChat.name,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            persona: contactChat.settings.aiPersona,
            avatarFrame: contactChat.settings.aiAvatarFrame || '',
            isAdmin: false,
            groupTitle: ''
        });
        addedNames.push(`â€œ${contactChat.name}â€`);
    } else {
        // ã€æ ¸å¿ƒæ–°å¢ã€‘è¿™æ˜¯å¤„ç†NPCçš„é€»è¾‘
        let foundNpc = null;
        for (const c of Object.values(state.chats)) {
            if (c.npcLibrary) {
                const npc = c.npcLibrary.find(n => n.id === contactId);
                if (npc) {
                    foundNpc = npc;
                    break;
                }
            }
        }
        if (foundNpc) {
            chat.members.push({
                id: foundNpc.id,
                originalName: foundNpc.name,
                groupNickname: foundNpc.name,
                avatar: foundNpc.avatar || defaultGroupMemberAvatar,
                persona: foundNpc.persona,
                avatarFrame: '',
                isAdmin: false,
                groupTitle: ''
            });
            addedNames.push(`â€œ${foundNpc.name}â€`);
        }
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


    await db.chats.put(chat);

    // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    await logSystemMessage(chat.id, `â€œ${myNickname}â€é‚€è¯· ${addedNames.join('ã€')} åŠ å…¥äº†ç¾¤èŠã€‚`);

    // è¿”å›åˆ°ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢å¹¶åˆ·æ–°
    openMemberManagementScreen();
    renderGroupMemberSettings(chat.members); // åŒæ—¶æ›´æ–°èŠå¤©è®¾ç½®é‡Œçš„å¤´åƒ
}



// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†è®¾ç½®ç”¨æˆ·è‡ªå·±çš„ç¾¤æ˜µç§°
 */
async function handleSetUserNickname() {
    const chat = state.chats[state.activeChatId];
    const oldNickname = chat.settings.myNickname || 'æˆ‘';
    
    const newNickname = await showCustomPrompt('ä¿®æ”¹æˆ‘çš„ç¾¤æ˜µç§°', 'è¯·è¾“å…¥æ–°çš„æ˜µç§°', oldNickname);
    if (newNickname !== null && newNickname.trim()) {
        chat.settings.myNickname = newNickname.trim();
        await db.chats.put(chat);
        
        // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ç¾¤å‹
        await logSystemMessage(chat.id, `â€œ${oldNickname}â€å°†ç¾¤æ˜µç§°ä¿®æ”¹ä¸ºâ€œ${newNickname.trim()}â€`);
        
        renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
    }
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†è®¾ç½®ç”¨æˆ·è‡ªå·±çš„ç¾¤å¤´è¡”
 */
async function handleSetUserTitle() {
    const chat = state.chats[state.activeChatId];
    const oldTitle = chat.settings.myGroupTitle || '';

    const newTitle = await showCustomPrompt('ä¿®æ”¹æˆ‘çš„ç¾¤å¤´è¡”', 'ç•™ç©ºåˆ™ä¸ºå–æ¶ˆå¤´è¡”', oldTitle);
    if (newTitle !== null) {
        chat.settings.myGroupTitle = newTitle.trim();
        await db.chats.put(chat);

        // è°ƒç”¨ä½ å·²æœ‰çš„å‡½æ•°æ¥å‘é€ç³»ç»Ÿé€šçŸ¥
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        await logTitleChange(chat.id, myNickname, myNickname, newTitle.trim());

        renderMemberManagementList();
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | æƒé™ä¿®å¤ç‰ˆ | è¸¢äººæ— æ¶ˆæ¯ã€‘ä»ç¾¤èŠä¸­ç§»é™¤ä¸€ä¸ªæˆå‘˜
 * @param {string} memberId - è¦ç§»é™¤çš„æˆå‘˜ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const isOwner = chat.ownerId === 'user';
    const isAdmin = chat.settings.isUserAdmin;
    const memberToRemove = chat.members.find(m => m.id === memberId);
    
    // æƒé™æ£€æŸ¥
    if (!isOwner && !(isAdmin && !memberToRemove.isAdmin && memberToRemove.id !== chat.ownerId)) {
        alert("ä½ æ²¡æœ‰æƒé™ç§»å‡ºè¯¥æˆå‘˜ï¼");
        return;
    }
    
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    if (memberIndex === -1) return;
    
    const memberName = memberToRemove.groupNickname;
    const confirmed = await showCustomConfirm(
        'ç§»å‡ºæˆå‘˜',
        `ç¡®å®šè¦å°†â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);

        const myNickname = chat.settings.myNickname || 'æˆ‘';
        await logSystemMessage(chat.id, `â€œ${myNickname}â€å°†â€œ${memberName}â€ç§»å‡ºäº†ç¾¤èŠã€‚`);

        renderMemberManagementList();
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openContactPickerForAddMember å‡½æ•° â–¼â–¼â–¼

async function openContactPickerForAddMember() {
    selectedContacts.clear(); 

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œç»‘å®šæ­£ç¡®çš„â€œæ·»åŠ æˆå‘˜â€å‡½æ•°
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);

    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));
    existingMemberIds.add('user'); // æŠŠç”¨æˆ·è‡ªå·±ä¹Ÿç®—ä½œå·²å­˜åœ¨æˆå‘˜

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å’Œåˆ›å»ºç¾¤èŠæ—¶ä¸€æ ·ï¼Œæ•´åˆæ‰€æœ‰è§’è‰²å’ŒNPC
    const allAvailablePeople = [];
    Object.values(state.chats).filter(c => !c.isGroup).forEach(c => {
        allAvailablePeople.push({
            id: c.id, name: c.name, avatar: c.settings.aiAvatar || defaultAvatar, isNpc: false
        });
    });
    const npcMap = new Map();
    Object.values(state.chats).forEach(c => {
        if (c.npcLibrary) {
            c.npcLibrary.forEach(npc => {
                if (!npcMap.has(npc.id)) {
                    npcMap.set(npc.id, {
                        id: npc.id, name: npc.name, avatar: npc.avatar || defaultGroupMemberAvatar, isNpc: true
                    });
                }
            });
        }
    });
    allAvailablePeople.push(...Array.from(npcMap.values()));

    // è¿‡æ»¤æ‰å·²ç»æ˜¯ç¾¤æˆå‘˜çš„äºº
    const contacts = allAvailablePeople.filter(p => !existingMemberIds.has(p.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„è”ç³»äººäº†ã€‚</p>';
    } else {
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.avatar}" class="avatar">
                <span class="name">${contact.name} ${contact.isNpc ? '<span style="color: #888; font-size: 12px;">(NPC)</span>' : ''}</span>
            `;
            listEl.appendChild(item);
        });
    }

    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€é‡æ„ç‰ˆã€‘åœ¨ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿæˆå‘˜
 */
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('åˆ›å»ºæ–°æˆå‘˜', 'è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­— (è¿™å°†æ˜¯TAçš„â€œæœ¬åâ€ï¼Œä¸å¯æ›´æ”¹)');
    if (!name || !name.trim()) return;

    // æ£€æŸ¥æœ¬åæ˜¯å¦å·²åœ¨ç¾¤å†…å­˜åœ¨
    const chat = state.chats[state.activeChatId];
    if (chat.members.some(m => m.originalName === name.trim())) {
        alert(`é”™è¯¯ï¼šç¾¤å†…å·²å­˜åœ¨åä¸ºâ€œ${name.trim()}â€çš„æˆå‘˜ï¼`);
        return;
    }

    const persona = await showCustomPrompt('è®¾ç½®äººè®¾', `è¯·è¾“å…¥â€œ${name}â€çš„äººè®¾`, '', 'textarea');
    if (persona === null) return; 

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    // ä¸ºæ–°åˆ›å»ºçš„NPCä¹Ÿå»ºç«‹åŒé‡å‘½åæœºåˆ¶
    const newMember = {
        id: 'npc_' + Date.now(),
        originalName: name.trim(),   // æ–°æˆå‘˜çš„â€œæœ¬åâ€
        groupNickname: name.trim(), // æ–°æˆå‘˜çš„åˆå§‹â€œç¾¤æ˜µç§°â€
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    renderMemberManagementList();
    renderGroupMemberSettings(chat.members); 

    alert(`æ–°æˆå‘˜â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠï¼`);
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚å€’è®¡æ—¶å‡½æ•° â–¼â–¼â–¼
function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span>å·²</span><span>è¶…</span><span>æ—¶</span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘è®°å½•æ”¯ä»˜è€…ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è®°å½•æ˜¯ç”¨æˆ·ä»˜çš„é’±
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 2. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 3. ä¿å­˜æ›´æ–°åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);  
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘---
    callHistory: [], // ç”¨äºå­˜å‚¨é€šè¯ä¸­çš„å¯¹è¯å†å²
    preCallContext: "" // ç”¨äºå­˜å‚¨é€šè¯å‰çš„èŠå¤©æ‘˜è¦
};

let callTimerInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨çš„ID

/**
 * ã€æ€»å…¥å£ã€‘ç”¨æˆ·ç‚¹å‡»â€œå‘èµ·è§†é¢‘é€šè¯â€æˆ–â€œå‘èµ·ç¾¤è§†é¢‘â€æŒ‰é’® (V3.1 - ä¿®å¤ç‰ˆ)
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true;

    // 1. æ˜¾ç¤ºâ€œæ­£åœ¨å‘¼å«â€ç•Œé¢ (è¿™éƒ¨åˆ†ä¸å˜)
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
    showScreen('outgoing-call-screen');
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå¯¼è‡´é”™è¯¯çš„ `const membersList = ...` ä»£ç å—å·²ä»è¿™é‡Œç§»é™¤ â˜…â˜…â˜…

    // ã€æ–°å¢ã€‘åœ¨å‘èµ·é€šè¯æ—¶ï¼Œæå‰å‡†å¤‡å¥½é€šè¯å‰çš„èŠå¤©è®°å½•ä¸Šä¸‹æ–‡
    videoCallState.preCallContext = chat.history
        .slice(-20) // è·å–æœ€è¿‘20æ¡æ¶ˆæ¯
        .map(msg => `${msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name)}: ${String(msg.content).substring(0, 50)}...`)
        .join('\n');

    // 2. é‡æ–°æ„å»ºä¸€ä¸ªä¿¡æ¯æ›´ä¸°å¯Œã€æŒ‡ä»¤æ›´æ˜ç¡®çš„APIè¯·æ±‚
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•å‘èµ·é€šè¯ã€‚');
        }
    
        let systemPromptForCall;
        if (chat.isGroup) {
            systemPromptForCall = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
ç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) åˆšåˆšå‘èµ·äº†ç¾¤è§†é¢‘é€šè¯ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ¯ä¸ªè§’è‰²çš„æ€§æ ¼å’Œæœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œå†³å®šä»–ä»¬æ˜¯å¦è¦åŠ å…¥é€šè¯ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **å†³ç­–**: æ¯ä¸ªè§’è‰²éƒ½å¿…é¡»ç‹¬ç«‹å†³ç­–ã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å†³ç­–ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "join"}\` æˆ– \`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "decline"}\`ã€‚
3.  **å€¾å‘æ€§**: åœ¨æ²¡æœ‰ç‰¹æ®Šç†ç”±çš„æƒ…å†µä¸‹ï¼Œä½ çš„è§’è‰²ä»¬é€šå¸¸ä¹äºåŠ å…¥ç¾¤èŠã€‚

# è§’è‰²åˆ—è¡¨ä¸äººè®¾
${chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n')}

# é€šè¯å‰çš„èŠå¤©æ‘˜è¦
${videoCallState.preCallContext}
`;
        } else {
            systemPromptForCall = `
# ä½ çš„ä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) åˆšåˆšå‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬æœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œå†³å®šæ˜¯å¦æ¥å—ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **å†³ç­–**: ä½ å¿…é¡»åšå‡º "accept" (æ¥å—) æˆ– "reject" (æ‹’ç») çš„å†³å®šã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`[{"type": "video_call_response", "decision": "accept"}]\` æˆ– \`[{"type": "video_call_response", "decision": "reject"}]\`ã€‚
3.  **å€¾å‘æ€§**: ä½œä¸ºä¸€ä¸ªå‹å¥½çš„AIä¼´ä¾£ï¼Œåœ¨æ²¡æœ‰ç‰¹æ®Šç†ç”±ï¼ˆæ¯”å¦‚åœ¨ä¹‹å‰çš„å¯¹è¯ä¸­æ˜ç¡®è¡¨ç¤ºäº†ä¸æƒ³è¢«æ‰“æ‰°æˆ–æ­£åœ¨å¿™ï¼‰çš„æƒ…å†µä¸‹ï¼Œä½ ã€åº”è¯¥ä¼˜å…ˆé€‰æ‹©æ¥å—ã€‘é€šè¯ã€‚

# ä½ çš„äººè®¾
${chat.settings.aiPersona}

# é€šè¯å‰çš„èŠå¤©æ‘˜è¦
${videoCallState.preCallContext}
`;
        }
        
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ åœ¨ç³»ç»ŸæŒ‡ä»¤ä¸­è¯»åˆ°çš„è§„åˆ™ï¼Œç«‹å³åšå‡ºä½ çš„å†³ç­–ã€‚" }];
        
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPromptForCall, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPromptForCall }, ...messagesForApi],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                })
            });
            
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API é”™è¯¯ (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '');
        const responseArray = JSON.parse(aiResponseContent);

        if (chat.isGroup) {
            responseArray.forEach(action => {
                if (action.type === 'group_call_response' && action.decision === 'join') {
                    const member = chat.members.find(m => m.originalName === action.name);
                    if (member) videoCallState.participants.push(member);
                }
            });
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                throw new Error("ç¾¤é‡Œæ²¡æœ‰äººæ¥å¬ä½ çš„é€šè¯é‚€è¯·ã€‚");
            }
        } else {
            const decision = responseArray[0];
            if (decision.type === 'video_call_response' && decision.decision === 'accept') {
                startVideoCall();
            } else {
                throw new Error("å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚");
            }
        }

    } catch (error) {
        console.error("å‘èµ·é€šè¯å¤±è´¥:", error);
        await showCustomAlert("å‘¼å«å¤±è´¥", error.message);
        videoCallState.isAwaitingResponse = false;
        showScreen('chat-interface-screen');
    }
}




// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å…¨æ–°çš„å‡½æ•°ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ startVideoCall å‡½æ•° â–¼â–¼â–¼
function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™æ•´å—ä»£ç ä» handleInitiateCall å‡½æ•°é‡Œã€å‰ªåˆ‡ã€‘æ‰ â–¼â–¼â–¼

// æå–é€šè¯å‰çš„æœ€å20æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
videoCallState.preCallContext = chat.history
    .slice(-20)
    .map(msg => `${msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name)}: ${String(msg.content).substring(0, 50)}...`)
    .join('\n');

    // 1. ã€æ ¸å¿ƒåˆ¤æ–­ã€‘æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¯è§†åŒ–ç•Œé¢
    if (chat.settings.visualVideoCallEnabled) {
        // --- å¯åŠ¨ã€æ–°ã€‘çš„å¯è§†åŒ–ç•Œé¢ ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');
        
        // æ˜¾ç¤ºæ–°ç•Œé¢ï¼Œéšè—æ—§ç•Œé¢
        visualInterface.style.display = 'flex';
        textInterface.style.display = 'none';

        // åŠ è½½å›¾ç‰‡
        document.querySelector('#video-main-view img').src = chat.settings.charVideoImage || defaultAvatar;
        document.querySelector('#video-pip-view img').src = chat.settings.userVideoImage || defaultAvatar;
        
        // æ¸…ç©ºæ—§çš„èŠå¤©æ°”æ³¡
        document.getElementById('video-call-messages-visual').innerHTML = `<em>æ­£åœ¨æ¥é€š...</em>`;
        showScreen('video-call-screen');

        // å¯åŠ¨è®¡æ—¶å™¨
        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡

        // è§¦å‘AIåœ¨é€šè¯ä¸­çš„ç¬¬ä¸€å¥è¯
        triggerAiInCallAction();

    } else {
        // --- å¯åŠ¨ã€æ—§ã€‘çš„çº¯æ–‡å­—ç•Œé¢ (è¿™é‡Œçš„ä»£ç å°±æ˜¯ä½ åŸæ¥çš„é€»è¾‘) ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');

        // æ˜¾ç¤ºæ—§ç•Œé¢ï¼Œéšè—æ–°ç•Œé¢
        visualInterface.style.display = 'none';
        textInterface.style.display = 'flex'; // æ—§ç•Œé¢ç”¨flex

        updateParticipantAvatars(); 
        
        document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
        showScreen('video-call-screen');

        document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
        document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer();

        triggerAiInCallAction();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€æ ¸å¿ƒã€‘ç»“æŸè§†é¢‘é€šè¯
 */
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ endVideoCall å‡½æ•° â–¼â–¼â–¼
async function endVideoCall() {
  // â–¼â–¼â–¼ åœ¨ endVideoCall å‡½æ•°çš„ã€å¼€å¤´ã€‘æ·»åŠ è¿™è¡Œä»£ç  â–¼â–¼â–¼
document.getElementById('visual-call-interface').style.display = 'none';
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè¯ç»“æŸï¼Œæ—¶é•¿ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè¯è®°å½•åˆ°æ•°æ®åº“ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }
        
        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè¯è®°å½•å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è®°å½•é‡Œæ·»åŠ å¯¹ç”¨æˆ·å¯è§çš„â€œé€šè¯ç»“æŸâ€æ¶ˆæ¯
let summaryMessage = {
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘role ç”± videoCallState.initiator å†³å®š
    role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
    content: endCallText,
    timestamp: Date.now(),
};

// ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¸ºç¾¤èŠçš„ assistant æ¶ˆæ¯è¡¥å…… senderName
if (chat.isGroup && summaryMessage.role === 'assistant') {
    // åœ¨ç¾¤èŠä¸­ï¼Œé€šè¯ç»“æŸçš„æ¶ˆæ¯åº”è¯¥ç”±â€œå‘èµ·è€…â€æ¥è¯´
    // videoCallState.callRequester ä¿å­˜äº†æœ€åˆå‘èµ·é€šè¯çš„é‚£ä¸ªAIçš„åå­—
    summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        chat.history.push(summaryMessage);

        // 3. ã€æ ¸å¿ƒå˜é©ã€‘åˆ›å»ºå¹¶æ·»åŠ å¯¹ç”¨æˆ·éšè—çš„â€œé€šè¯åæ±‡æŠ¥â€æŒ‡ä»¤
        const callTranscriptForAI = videoCallState.callHistory.map(h => `${h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.role}: ${h.content}`).join('\n');
        
        const hiddenReportInstruction = {
            role: 'system',
    content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šè§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ æ ¹æ®å®Œæ•´çš„é€šè¯æ–‡å­—è®°å½•ï¼ˆè§ä¸‹æ–¹ï¼‰ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œå‘ç”¨æˆ·ä¸»åŠ¨å‘é€å‡ æ¡ã€æ ¼å¼ä¸º {"type": "text", "content": "..."} çš„ã€‘æ¶ˆæ¯ï¼Œæ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®šï¼Œæˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚è¿™å¾ˆé‡è¦ï¼Œèƒ½è®©ç”¨æˆ·æ„Ÿè§‰ä½ è®°å¾—é€šè¯å†…å®¹ã€‚]\n---é€šè¯è®°å½•å¼€å§‹---\n${callTranscriptForAI}\n---é€šè¯è®°å½•ç»“æŸ---`,
            timestamp: Date.now() + 1, // ç¡®ä¿åœ¨ä¸Šä¸€æ¡æ¶ˆæ¯ä¹‹å
            isHidden: true
        };
        chat.history.push(hiddenReportInstruction);

        // 4. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
        await db.chats.put(chat);
    }
    
    // 5. æ¸…ç†å’Œé‡ç½®çŠ¶æ€ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 6. è¿”å›èŠå¤©ç•Œé¢å¹¶è§¦å‘AIå“åº”ï¼ˆAIä¼šè¯»å–åˆ°æˆ‘ä»¬çš„â€œæ±‡æŠ¥â€æŒ‡ä»¤ï¼‰
    if (chat) {
        openChat(chat.id);
        triggerAiResponse(); // å…³é”®ä¸€æ­¥ï¼
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°é€šè¯ç•Œé¢çš„å‚ä¸è€…å¤´åƒç½‘æ ¼
 */
function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    // â˜… æ ¸å¿ƒä¿®æ­£ï¼šåŒºåˆ†ç¾¤èŠå’Œå•èŠ
    if (videoCallState.isGroupCall) {
        // ç¾¤èŠé€»è¾‘ï¼šæ˜¾ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå‘˜
        participantsToRender = [...videoCallState.participants];
        // å¦‚æœç”¨æˆ·ä¹Ÿå‚ä¸äº†ï¼Œå°±æŠŠç”¨æˆ·ä¿¡æ¯ä¹ŸåŠ è¿›å»
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || 'æˆ‘',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        // å•èŠé€»è¾‘ï¼šåªæ˜¾ç¤ºå¯¹æ–¹çš„å¤´åƒå’Œåå­—
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
const displayName = p.groupNickname || p.name; // <-- æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ
wrapper.innerHTML = `
    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
    <div class="participant-name">${displayName}</div>
`;
        grid.appendChild(wrapper);
    });
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·åŠ å…¥/é‡æ–°åŠ å…¥é€šè¯
 */
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); // æ›´æ–°å¤´åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ·

    // åˆ‡æ¢åº•éƒ¨æŒ‰é’®
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    // å‘ŠçŸ¥AIç”¨æˆ·åŠ å…¥äº†
    triggerAiInCallAction("[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åŠ å…¥äº†é€šè¯]");
}


/**
 * æ›´æ–°é€šè¯è®¡æ—¶å™¨æ˜¾ç¤º 
 */
// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ updateCallTimer å‡½æ•° â–¼â–¼â–¼
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    // åŒæ—¶æ›´æ–°ä¸¤ä¸ªç•Œé¢çš„è®¡æ—¶å™¨
    document.getElementById('call-timer').textContent = timeString;
    document.getElementById('visual-call-timer').textContent = timeString;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™ä¸ªå®Œæ•´å‡½æ•°æ›¿æ¢æ—§çš„ showIncomingCallModal â–¼â–¼â–¼
function showIncomingCallModal(chatId) { // <--- åœ¨æ‹¬å·é‡Œæ·»åŠ  chatId
    const chat = state.chats[chatId]; // <--- æŠŠ state.activeChatId ä¿®æ”¹ä¸º chatId
    if (!chat) return;

    // æ ¹æ®æ˜¯å¦ç¾¤èŠæ˜¾ç¤ºä¸åŒä¿¡æ¯
    if (chat.isGroup) {
        // ä» videoCallState ä¸­è·å–æ˜¯å“ªä¸ªæˆå‘˜å‘èµ·çš„é€šè¯
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå‘˜';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // æ˜¾ç¤ºç¾¤å
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘`; // æ˜¾ç¤ºå…·ä½“å‘èµ·äºº
    } else {
        // å•èŠé€»è¾‘ä¿æŒä¸å˜
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è¯·ä½ è§†é¢‘é€šè¯';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
    playRingtone(); // <-- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œ
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * éšè—AIå‘èµ·çš„é€šè¯è¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜)
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
    stopRingtone(); // <-- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œ
}

// â–¼â–¼â–¼ ã€è¿™æ˜¯ä¿®æ­£åçš„ç‰ˆæœ¬ã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ triggerAiInCallAction å‡½æ•° â–¼â–¼â–¼
async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');

    const userNickname = chat.settings.myNickname || 'æˆ‘';

    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }

    if (userInput && videoCallState.isUserParticipating) {
        if (isVisualMode) {
            const userBubble = document.createElement('div');
            userBubble.className = 'visual-call-bubble user';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        } else {
            const userBubble = document.createElement('div');
            userBubble.className = 'call-message-bubble user-speech';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        }
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æå‰å®šä¹‰å¥½ participantNames â˜…â˜…â˜…
        const participantNames = videoCallState.participants.map(p => p.originalName); 
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        // â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…

        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²ã€‚ä½ ä»¬æ­£åœ¨è¿›è¡Œä¸€åœºç¾¤èŠè§†é¢‘é€šè¯ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ¯ä¸ªè§’è‰²çš„æ€§æ ¼ï¼Œç”Ÿæˆä»–ä»¬åœ¨é€šè¯ä¸­ä¼šè¯´çš„ã€ç¬¬ä¸€äººç§°å¯¹è¯ã€‘ï¼Œæ³¨æ„æ˜¯åœ¨è§†é¢‘é€šè¯ï¼Œç»å¯¹ä¸èƒ½ä»¥ä¸ºæ˜¯åœ¨ç°å®ï¼æ¯æ¬¡å›å¤çš„å­—æ•°å¤šäº›ï¼Œ50å­—ä»¥ä¸Šã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€è¯­è¨€é“å¾‹ã€‘ã€‘ã€‘**: æ— è®ºè§’è‰²äººè®¾æ˜¯ä»€ä¹ˆå›½ç±æˆ–è¯´ä»€ä¹ˆè¯­è¨€ï¼Œåœ¨æœ¬æ¬¡è§†é¢‘é€šè¯ä¸­ï¼Œæ‰€æœ‰è§’è‰²ã€å¿…é¡»ã€‘å…¨ç¨‹ä½¿ç”¨ã€ä¸­æ–‡ã€‘è¿›è¡Œäº¤æµã€‚
2.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "ã€è§’è‰²çš„æœ¬åã€‘", "speech": "ã€åœ¨è¿™é‡ŒåŠ å…¥å¸¦åŠ¨ä½œçš„å¯¹è¯ã€‘"}\`ã€‚
3.  **ã€ã€ã€è¡¨ç°åŠ›é“å¾‹ã€‘ã€‘ã€‘**: åœ¨ "speech" å­—æ®µä¸­ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºè§’è‰²çš„å¯¹è¯åŠ å…¥ã€åŠ¨ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»åŠ¨ã€‘ï¼Œå¹¶ç”¨ã€ã€‘ç¬¦å·åŒ…è£¹ã€‚è¿™éå¸¸é‡è¦ï¼
4.  **ç¤ºä¾‹**: \`{"name": "å¼ ä¸‰", "speech": "ã€æŒ äº†æŒ å¤´ã€‘å•Šï¼Ÿæˆ‘åˆšåˆšèµ°ç¥äº†ï¼Œä½ ä»¬è¯´åˆ°å“ªäº†ï¼Ÿ"}\`
5.  **èº«ä»½é“å¾‹**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${userNickname}"** çš„å‘è¨€ã€‚
6.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šï¼Œç”¨ä»–ä»¬çš„å£å»è¯´è¯ã€‚

# å½“å‰æƒ…æ™¯
ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
**å½“å‰å‚ä¸è€…**: ${participantNames.join('ã€ ')}ã€‚
${worldBookContent}
ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
    } else {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤2ï¼šä¸ºå•äººé€šè¯æä¾›ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ã€æ­£ç¡®çš„Prompt â˜…â˜…â˜…
        let openingContext = videoCallState.initiator === 'user'
            ? `ä½ åˆšåˆšæ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚`
            : `ç”¨æˆ·åˆšåˆšæ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚`;
            
        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ä½ æ­£åœ¨å’Œç”¨æˆ· (${userNickname}) è¿›è¡Œä¸€å¯¹ä¸€è§†é¢‘é€šè¯ã€‚
${openingContext}
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬çš„èŠå¤©æƒ…æ™¯ï¼Œç”Ÿæˆä½ åœ¨é€šè¯ä¸­ä¼šè¯´çš„ã€ç¬¬ä¸€äººç§°å¯¹è¯ã€‘ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€æ®µçº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä»£è¡¨ä½ çš„å‘è¨€ã€‚ç»å¯¹ä¸è¦è¾“å‡ºJSONæ ¼å¼ã€‚
2.  **ã€ã€ã€è¡¨ç°åŠ›é“å¾‹ã€‘ã€‘ã€‘**: åœ¨ä½ çš„å¯¹è¯ä¸­ï¼Œä½ ã€å¿…é¡»ã€‘åŠ å…¥ã€åŠ¨ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»åŠ¨ã€‘ï¼Œå¹¶ç”¨ã€ã€‘ç¬¦å·åŒ…è£¹ã€‚
3.  **ç¤ºä¾‹**: "ã€æ­ªäº†æ­ªå¤´ï¼Œå¥½å¥‡åœ°çœ‹ç€ä½ ã€‘çœŸçš„å—ï¼Ÿå¿«è·Ÿæˆ‘è¯´è¯´çœ‹ï¼"
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚

# å½“å‰æƒ…æ™¯
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
${worldBookContent}
ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
        // â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…
    }
    
    const messagesForApi = [
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥å¬é”®...*` : `*å¯¹æ–¹æŒ‰ä¸‹äº†æ¥å¬é”®...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: [{ role: 'system', content: inCallPrompt }, ...messagesForApi], temperature: parseFloat(state.apiConfig.temperature) || 0.8, })
        });
        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        const sanitizedResponse = aiResponse.replace(/!\[.*?\]\(.*?\)|https?:\/\/\S+/gi, '').trim();

        const connectingElement = callFeed.querySelector('em');
        if (connectingElement) connectingElement.remove();

        if (isVisualMode) {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'visual-call-bubble ai';
            aiBubble.textContent = sanitizedResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
        } else {
            if (videoCallState.isGroupCall) {
                const speechArray = parseAiResponse(sanitizedResponse); 
                speechArray.forEach(turn => {
                    if (!turn.name || turn.name === userNickname || !turn.speech) return;
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                    
                    const speaker = videoCallState.participants.find(p => p.originalName === turn.name);
                    if (speaker) {
                        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                        if(speakingAvatar) {
                            speakingAvatar.classList.add('speaking');
                            setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                        }
                    }
                });
            } else {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.textContent = sanitizedResponse;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
                const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                if(speakingAvatar) {
                    speakingAvatar.classList.add('speaking');
                    setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                }
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        
        if (isVisualMode) {
            errorBubble.className = 'visual-call-bubble ai';
        } else {
            errorBubble.className = 'call-message-bubble ai-speech';
        }
        
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

// â–¼â–¼â–¼ å°†è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸ªå‡½æ•°æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼Œè¯·ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½åŒº â–¼â–¼â–¼
async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°å†…å­˜ä¸­åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // 2. è·å–å½“å‰ç”¨æˆ·çš„æ˜µç§°ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // è®°å½•æ˜¯â€œæˆ‘â€ä»˜çš„é’±
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
    } else {
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
    }

    // 3. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 4. å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¹¶ç«‹åˆ»é‡ç»˜UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 5. ã€é‡è¦ã€‘åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸåï¼Œæ‰è§¦å‘ä¸€æ¬¡AIå“åº”ï¼Œè®©å®ƒæ„Ÿè°¢ä½ 
    if (choice === 'paid') {
        triggerAiResponse();
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»å¤´åƒå‘èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¦æœ‰è‡ªå®šä¹‰åç¼€åŠŸèƒ½
 * @param {string} chatId - å‘ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
 * @param {string} characterName - è¢«æ‹çš„è§’è‰²å
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. è§¦å‘å±å¹•éœ‡åŠ¨åŠ¨ç”»
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥åç¼€
    const suffix = await showCustomPrompt(
        `ä½ æ‹äº†æ‹ â€œ${characterName}â€`, 
        "ï¼ˆå¯é€‰ï¼‰è¾“å…¥åç¼€",
        "",
        "text"
    );

    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
    if (suffix === null) return;

    // 3. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†åç¼€æ‹¼æ¥åˆ°æ¶ˆæ¯å†…å®¹ä¸­
    const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${characterName}â€ ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // ä»ç„¶æ˜¯ç³»ç»Ÿæ¶ˆæ¯
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œä»¥è§¦å‘AIçš„å›åº”
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ ·å°†åç¼€åŠ å…¥åˆ°ç»™AIçš„æç¤ºä¸­
    const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${myNickname}ï¼‰åˆšåˆšæ‹äº†æ‹ä½ ï¼ˆ${characterName}ï¼‰${suffix.trim()}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // æ—¶é—´æˆ³+1ä»¥ä¿è¯é¡ºåº
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. ä¿å­˜æ›´æ”¹å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€é€»è¾‘é‡æ„åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderMemoriesScreen å‡½æ•° â–¼â–¼â–¼
/**
 * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢ï¼Œä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. è·å–æ‰€æœ‰å›å¿†ï¼Œå¹¶æŒ‰ç›®æ ‡æ—¥æœŸï¼ˆå¦‚æœæ˜¯çº¦å®šï¼‰æˆ–åˆ›å»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›å¿†ï¼‰é™åºæ’åˆ—
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›å¿†å’Œçº¦å®šå‘¢~</p>';
        return;
    }

    // 2. å°†æœªåˆ°æœŸçš„çº¦å®šæ’åœ¨æœ€å‰é¢
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è®¡æ—¶ï¼ŒæŒ‰æ—¥æœŸå‡åº
        return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸåº
    });

    // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å•ä¸€å¾ªç¯æ¥å¤„ç†æ‰€æœ‰ç±»å‹çš„å¡ç‰‡
    allMemories.forEach(item => {
        let card;
        // åˆ¤æ–­1ï¼šå¦‚æœæ˜¯æ­£åœ¨è¿›è¡Œçš„çº¦å®š
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // åˆ¤æ–­2ï¼šå…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆæ™®é€šå›å¿† æˆ– å·²åˆ°æœŸçš„çº¦å®šï¼‰
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. å¯åŠ¨æ‰€æœ‰å€’è®¡æ—¶
    startAllCountdownTimers();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * åˆ›å»ºæ™®é€šå›å¿†å¡ç‰‡DOMå…ƒç´ 
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ä¸åŒç±»å‹çš„å›å¿†è¿›è¡Œæ¸…æ™°çš„åŒºåˆ†
    if (memory.type === 'countdown' && memory.targetDate) {
        // å¦‚æœæ˜¯å·²åˆ°æœŸçš„çº¦å®š
        titleHtml = `[çº¦å®šè¾¾æˆ] ${memory.description}`;
        contentHtml = `åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚`;
    } else {
        // å¦‚æœæ˜¯æ™®é€šçš„æ—¥è®°å¼å›å¿†
        titleHtml = memory.authorName ? `${memory.authorName} çš„æ—¥è®°` : 'æˆ‘ä»¬çš„å›å¿†';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤è®°å½•', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ä½¿ç”¨å‰ï¼Œå…ˆä» countdown å¯¹è±¡ä¸­åˆ›å»º targetDate å˜é‡
    const targetDate = new Date(countdown.targetDate);
    
    // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ—¶--åˆ†--ç§’</div>
        <div class="target-date">ç›®æ ‡æ—¶é—´: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤çº¦å®š', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// å…¨å±€å˜é‡ï¼Œç”¨äºç®¡ç†æ‰€æœ‰å€’è®¡æ—¶
let activeCountdownTimers = [];

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ startAllCountdownTimers å‡½æ•° â–¼â–¼â–¼
function startAllCountdownTimers() {
    // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç”¨ let å£°æ˜ timerId
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "çº¦å®šè¾¾æˆï¼";
                // ç°åœ¨ updateTimer å¯ä»¥æ­£ç¡®åœ°æ‰¾åˆ°å¹¶æ¸…é™¤å®ƒè‡ªå·±äº†
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
        };
        
        updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ä»¥æ˜¾ç¤ºåˆå§‹å€’è®¡æ—¶
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå·²å£°æ˜çš„ timerId èµ‹å€¼
        timerId = setInterval(updateTimer, 1000);
        
        // å°†æœ‰æ•ˆçš„è®¡æ—¶å™¨IDå­˜å…¥å…¨å±€æ•°ç»„ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ—¶å¯ä»¥æ¸…é™¤
        activeCountdownTimers.push(timerId);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæåä»£å…¼å®¹ç‰ˆã€‘æ›¿æ¢æ—§çš„ triggerAiFriendApplication å‡½æ•° â–¼â–¼â–¼
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("æµç¨‹å¯åŠ¨", `æ­£åœ¨ä¸ºè§’è‰²â€œ${chat.name}â€å‡†å¤‡å¥½å‹ç”³è¯·...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç»§ç»­ã€‚");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (è¯·å‚è€ƒ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰æ‹‰é»‘äº†ï¼Œä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
ç°åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€ï¼Œç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
# è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŸå› )
${contextSummary}
# æŒ‡ä»¤æ ¼å¼
ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "decision": "apply",
  "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
}
\`\`\`
`;

        const messagesForApi = [
            {role: 'user', content: systemPrompt}
        ];

        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();

            // --- ã€æ ¸å¿ƒä¿®æ­£ï¼šåœ¨è¿™é‡Œå‡€åŒ–AIçš„å›å¤ã€‘ ---
            let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            // 1. ç§»é™¤å¤´å°¾å¯èƒ½å­˜åœ¨çš„ "```json" å’Œ "```"
            rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
            // 2. ç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦å’Œå¤šä½™çš„ç©ºæ ¼ï¼Œç¡®ä¿æ˜¯ä¸€ä¸ªå¹²å‡€çš„JSONå­—ç¬¦ä¸²
            const cleanedContent = rawContent.trim();

            // 3. ä½¿ç”¨å‡€åŒ–åçš„å†…å®¹è¿›è¡Œè§£æ
            const responseObj = JSON.parse(cleanedContent);
            // --- ã€ä¿®æ­£ç»“æŸã€‘ ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("ç”³è¯·æˆåŠŸï¼", `â€œ${chat.name}â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);

        } else {
            await showCustomAlert("AIå†³ç­–", `â€œ${chat.name}â€æ€è€ƒåå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·ï¼Œå°†é‡ç½®å†·é™æœŸã€‚`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("æ‰§è¡Œå‡ºé”™", `ä¸ºâ€œ${chat.name}â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š\n\n${error.message}\n\nå°†é‡ç½®å†·é™æœŸã€‚`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ‰“å¼€è½¬è´¦å¼¹çª—è¿˜æ˜¯çº¢åŒ…å¼¹çª—
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // å•èŠä¿æŒåŸæ ·ï¼Œæ‰“å¼€è½¬è´¦å¼¹çª—
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * æ‰“å¼€å¹¶åˆå§‹åŒ–å‘çº¢åŒ…æ¨¡æ€æ¡†
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç†è¾“å…¥æ¡†
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
    document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';

    // å¡«å……ä¸“å±çº¢åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
chat.members.forEach(member => {
    const option = document.createElement('option');
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ originalName ä½œä¸ºæäº¤ç»™AIçš„å€¼ï¼Œå› ä¸ºå®ƒç‹¬ä¸€æ— äºŒ
    option.value = member.originalName; 
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ groupNickname ä½œä¸ºæ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„å€¼
    option.textContent = member.groupNickname; 
    receiverSelect.appendChild(option);
});
    
    // é»˜è®¤æ˜¾ç¤ºæ‹¼æ‰‹æ°”çº¢åŒ…é¡µç­¾
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * å‘é€ç¾¤çº¢åŒ…ï¼ˆæ‹¼æ‰‹æ°”ï¼‰
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢ï¼"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°ï¼"); return;
    }
    if (amount / count < 0.01) {
        alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äº0.01å…ƒï¼"); return;
    }

    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * å‘é€ä¸“å±çº¢åŒ…
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼"); return;
    }
    if (!receiverName) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¥æ”¶äººï¼"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…',
        receiverName: receiverName, // æ ¸å¿ƒå­—æ®µ
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»çº¢åŒ…å¡ç‰‡æ—¶è§¦å‘ (V4 - æµç¨‹é‡æ„ç‰ˆ)
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'æˆ‘';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // å¦‚æœæ˜¯ä¸“å±çº¢åŒ…ä¸”ä¸æ˜¯ç»™æˆ‘çš„ï¼Œæˆ–å·²é¢†å®Œï¼Œæˆ–å·²é¢†è¿‡ï¼Œéƒ½åªæ˜¾ç¤ºè¯¦æƒ…
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // æ ¸å¿ƒæµç¨‹ï¼šå…ˆå°è¯•æ‰“å¼€çº¢åŒ…
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // å¦‚æœæˆåŠŸæ‰“å¼€ï¼ˆclaimedAmountä¸ä¸ºnullï¼‰
        if (claimedAmount !== null) {
            // **å…³é”®ï¼šåœ¨æ•°æ®æ›´æ–°åï¼Œå†é‡æ–°æ¸²æŸ“UI**
            renderChatInterface(currentChatId);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            await showCustomAlert("æ­å–œï¼", `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…ï¼Œé‡‘é¢ä¸º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
        }

        // æ— è®ºæˆåŠŸä¸å¦ï¼Œæœ€åéƒ½æ˜¾ç¤ºè¯¦æƒ…é¡µ
        // æ­¤æ—¶éœ€è¦ä»stateä¸­è·å–æœ€æ–°çš„packetå¯¹è±¡ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨handleOpenRedPacketä¸­è¢«æ›´æ–°äº†
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ handleOpenRedPacket å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒã€‘å¤„ç†ç”¨æˆ·æ‰“å¼€çº¢åŒ…çš„é€»è¾‘ (V5 - ä¸“æ³¨äºæ•°æ®æ›´æ–°)
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 1. æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¿˜èƒ½é¢†
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œï¼");
        return null; // è¿”å›nullè¡¨ç¤ºé¢†å–å¤±è´¥
    }
    
    // 2. è®¡ç®—é¢†å–é‡‘é¢
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. æ›´æ–°çº¢åŒ…æ•°æ®
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. ã€ã€ã€è¿™å°±æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼ã€‘ã€‘ã€‘æ„å»ºç³»ç»Ÿæ¶ˆæ¯å’ŒAIæŒ‡ä»¤
    let hiddenMessageContent = '';

    // å¦‚æœçº¢åŒ…è¢«é¢†å®Œäº†ï¼Œå°±å‡†å¤‡â€œæˆ˜æŠ¥â€
    if (isNowFullyClaimed) {
        const finishedMessage = {
            role: 'system',
            type: 'pat_message',
            content: `${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
            timestamp: Date.now() + 1
        };
        chat.history.push(finishedMessage);
        
        hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) é¢†å–äº†æœ€åä¸€ä¸ªçº¢åŒ…ï¼Œç°åœ¨ ${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;

        let luckyKing = { name: '', amount: -1 };
        if (packet.packetType === 'lucky' && packet.count > 1) {
            Object.entries(packet.claimedBy).forEach(([name, amount]) => {
                if (amount > luckyKing.amount) {
                    luckyKing = { name, amount };
                }
            });
        }
        if (luckyKing.name) {
             hiddenMessageContent += ` æ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}ï¼`;
        }
        hiddenMessageContent += ' è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]';
    } 
    // å¦‚æœè¿˜æ²¡è¢«é¢†å®Œ
    else {
        hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: ${packet.timestamp})ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œã€‚]`;
    }

    // åˆ›å»ºå¹¶æ·»åŠ ç»™AIçœ‹çš„éšè—æ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 2,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. ä¿å­˜åˆ°æ•°æ®åº“
    await db.chats.put(chat);
    
    // 6. è¿”å›é¢†å–çš„é‡‘é¢ï¼Œç”¨äºåç»­å¼¹çª—
    return claimedAmount;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡† (V4 - å·²ä¿®å¤å‚æ•°é”™è¯¯)
 */
async function showRedPacketDetails(packet) {
    // 1. ç›´æ¥æ£€æŸ¥ä¼ å…¥çš„packetå¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ— éœ€å†æŸ¥æ‰¾
    if (!packet) {
        console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 2. åç»­æ‰€æœ‰é€»è¾‘ä¿æŒä¸å˜ï¼Œç›´æ¥ä½¿ç”¨ä¼ å…¥çš„packetå¯¹è±¡
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}ä¸ªçº¢åŒ…ï¼Œå…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` å‰©ä½™çº¢åŒ…å°†åœ¨${timeLeft}å°æ—¶å†…é€€è¿˜ã€‚`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">æ‰‹æ°”ç‹</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} å…ƒ</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ç»‘å®šå…³é—­è¯¦æƒ…æŒ‰é’®çš„äº‹ä»¶
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

// ä¾›å…¨å±€è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ä¾¿çº¢åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
window.handlePacketClick = handlePacketClick;

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ›å»ºæŠ•ç¥¨çš„æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // é»˜è®¤åˆ›å»ºä¸¤ä¸ªç©ºçš„é€‰é¡¹æ¡†
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­åŠ¨æ€æ·»åŠ ä¸€ä¸ªé€‰é¡¹è¾“å…¥æ¡†
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * ç”¨æˆ·ç¡®è®¤å‘èµ·æŠ•ç¥¨
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜ï¼');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // è¿‡æ»¤æ‰ç©ºçš„é€‰é¡¹

    if (options.length < 2) {
        alert('è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // åˆå§‹æŠ•ç¥¨ä¸ºç©º
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤ç‚¹å‡»é—®é¢˜ã€‘çš„ç‰ˆæœ¬æ›¿æ¢ handleUserVote å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·æŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {string} choice - ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œç›´æ¥è¿”å›
    if (!poll || poll.isClosed) {
        // å¦‚æœæ˜¯å·²å…³é—­çš„æŠ•ç¥¨ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºç»“æœ
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å·²ç»æŠ•è¿‡çš„åŒä¸€ä¸ªé€‰é¡¹
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡å¤ç‚¹å‡»ï¼Œæ‰æ‰§è¡ŒæŠ•ç¥¨é€»è¾‘
    if (!isReclickingSameOption) {
        // ç§»é™¤æ—§æŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ·æ”¹é€‰ï¼‰
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // æ·»åŠ æ–°æŠ•ç¥¨
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. ã€æ ¸å¿ƒé€»è¾‘ã€‘ç°åœ¨åªå¤„ç†ç”¨æˆ·æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æ£€æŸ¥æ˜¯å¦ç»“æŸ
    let hiddenMessageContent = null; 
    
    // åªæœ‰åœ¨ç”¨æˆ·çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ—¶ï¼Œæ‰ç”Ÿæˆæç¤º
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ${choice}â€ã€‚]`;
    }

    // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ éšè—æ¶ˆæ¯
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ç”¨æˆ·ç»“æŸæŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("ç»“æŸæŠ•ç¥¨", "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join('ï¼Œ');
        const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨ï¼æœ€ç»ˆç»“æœä¸ºï¼š${resultSummary}ã€‚]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜æ•°æ®å’Œæ›´æ–°UIï¼Œä¸è°ƒç”¨ triggerAiResponse()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŠ•ç¥¨ç»“æœè¯¦æƒ…
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join('ã€ ') : 'æ— äººæŠ•ç¥¨'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("æŠ•ç¥¨ç»“æœ", resultsHtml);
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„å¤´åƒåº“`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“AIå¤´åƒåº“çš„å†…å®¹
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * å‘å½“å‰AIçš„å¤´åƒåº“ä¸­æ·»åŠ æ–°å¤´åƒ
 */
async function addAvatarToLibrary() {
    const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}

/**
 * å…³é—­AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
 */
function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ä¸»å±å¹•ä¸ªäººèµ„æ–™å¡çš„å¤´åƒæ¡†
 */
function renderHomeScreenProfileFrame() {
    // 1. è·å–ä¿å­˜çš„å¤´åƒæ¡†URL
    const frameUrl = state.globalSettings.homeAvatarFrame || '';
    // 2. æ‰¾åˆ°å¤´åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('profile-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±æ˜¾ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLä¸ºç©ºï¼ˆå³é€‰æ‹©äº†â€œæ— â€ï¼‰ï¼Œå°±éšè—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²


/* â–¼â–¼â–¼ æ­¥éª¤ 3.2ï¼šå°†è¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼ */

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ applyWidgetData å‡½æ•° â–¼â–¼â–¼
function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
        const element = document.getElementById(elementId);
        const savedValue = state.globalSettings.widgetData[elementId];
        if (element) {
            if (element.tagName === 'IMG') {
                element.src = savedValue;
            } 
            // --- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„ä¿®å¤é€»è¾‘ â–¼â–¼â–¼ ---
            // å¦‚æœæ˜¯åœ°ç‚¹è¿™ä¸ªç‰¹æ®Šå…ƒç´ ï¼Œå°±ç”¨ innerHTML æ¥æ­£ç¡®æ˜¾ç¤ºå›¾æ ‡
            else if (elementId === 'profile-location') {
                element.innerHTML = savedValue;
            } 
            // --- â–²â–²â–² ä¿®å¤é€»è¾‘ç»“æŸ â–²â–²â–² ---
            else {
                // å…¶ä»–æ™®é€šæ–‡æœ¬å…ƒç´ ï¼Œä¿æŒåŸæ¥çš„é€»è¾‘ä¸å˜
                element.textContent = savedValue; 
            }
        }
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°è¾…åŠ©å‡½æ•°ã€‘æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¹¶è¿”å›æœ¬åœ°å›¾ç‰‡çš„Base64ç¼–ç 
 * @returns {Promise<string|null>} - è¿”å›å›¾ç‰‡çš„Base64 Data URLï¼Œå¦‚æœç”¨æˆ·å–æ¶ˆåˆ™è¿”å›null
 */
function uploadImageLocally() {
    return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'; // åªæ¥å—å›¾ç‰‡æ–‡ä»¶

        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    resolve(readerEvent.target.result); // è¿”å›Base64å­—ç¬¦ä¸²
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // ç”¨æˆ·å…³é—­äº†æ–‡ä»¶é€‰æ‹©æ¡†
            }
        };

        input.click();
    });
}

// â–¼â–¼â–¼ æ­¥éª¤ 2.2ï¼šç”¨è¿™ä¸ªå·²ä¿®å¤çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ handleEditText å‡½æ•° â–¼â–¼â–¼
async function handleEditText(element) {
    const elementId = element.id;
    const placeholder = element.dataset.placeholder || "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š";
    const textSpan = element.querySelector('span');
    const isComplexElement = !!textSpan;
    const targetElement = isComplexElement ? textSpan : element;
    const currentValue = targetElement.textContent;
    
    const newValue = await showCustomPrompt("ä¿®æ”¹æ–‡å­—", "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š", currentValue === placeholder ? "" : currentValue);

    if (newValue !== null) {
        const trimmedValue = newValue.trim();
        targetElement.textContent = trimmedValue ? trimmedValue : placeholder;
        state.globalSettings.widgetData[elementId] = isComplexElement ? element.innerHTML : targetElement.textContent;
        await db.globalSettings.put(state.globalSettings);
    }
}
// â–²â–²â–² JavaScript æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘è§¦å‘æŒ‡å®šç¾¤èŠçš„åå°AIäº’åŠ¨
 * @param {string} chatId - è¦è§¦å‘äº’åŠ¨çš„ç¾¤èŠID
 */
async function triggerGroupAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.isGroup) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.warn(`ç¾¤èŠ "${chat.name}" åå°æ´»åŠ¨å¤±è´¥ï¼šAPIæœªé…ç½®ã€‚`);
        return;
    }

    try {
        const lastMessage = chat.history.slice(-1)[0];
        const timeSinceLastMessage = lastMessage ? (Date.now() - lastMessage.timestamp) / 1000 / 60 : Infinity; // in minutes
        
        const membersList = chat.members.map(m => `- ${m.groupNickname} (äººè®¾: ${m.persona})`).join('\n');
          const myNickname = chat.settings.myNickname || 'æˆ‘';
  
        let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    let musicContext = '';
    // æ³¨æ„ï¼šåå°ç¾¤èŠæ´»åŠ¨é€šå¸¸ä¸ä¸ç‰¹å®šçš„â€œä¸€èµ·å¬æ­Œâ€ä¼šè¯ç»‘å®šï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªç©ºçš„éŸ³ä¹ä¸Šä¸‹æ–‡ã€‚
    // å¦‚æœæœªæ¥éœ€è¦æ›´å¤æ‚çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨æ­¤æ‰©å±•ã€‚

    const countdownContext = await getCountdownContext(); 
    
    let sharedContext = '';
    // åå°ç¾¤èŠæ´»åŠ¨ä¸­ä¸å­˜åœ¨ç”¨æˆ·åˆ†äº«èŠå¤©è®°å½•çš„ä¸Šä¸‹æ–‡ï¼Œå› æ­¤è¿™é‡Œä¸ºç©ºã€‚

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹å®Œæ•´æ›¿æ¢ â–¼â–¼â–¼
    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠåå°æ¨¡æ‹Ÿå™¨ã€‚å½“å‰ç¾¤èŠ "${chat.name}" å·²ç»æ²‰å¯‚äº† ${Math.round(timeSinceLastMessage)} åˆ†é’Ÿï¼Œç”¨æˆ·(æ˜µç§°: "${chat.settings.myNickname || 'æˆ‘'}")ä¸åœ¨çº¿ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹æ–¹æ¯ä¸ªè§’è‰²çš„äººè®¾ï¼Œåœ¨ä»–ä»¬ä¹‹é—´ã€è‡ªå‘åœ°ã€‘ç”Ÿæˆä¸€æ®µç®€çŸ­ã€è‡ªç„¶çš„å¯¹è¯ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·ã€ç»å¯¹ä¸åœ¨åœºã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆä»»ä½•æåŠç”¨æˆ·æˆ–ä¸ç”¨æˆ·å¯¹è¯çš„å†…å®¹ã€‚æ•´æ®µå¯¹è¯å¿…é¡»æ˜¯AIè§’è‰²ä¹‹é—´çš„äº’åŠ¨ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚
2.  **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å’Œ "name" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
3.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚
5.  **è‡ªç„¶æ€§**: å¯¹è¯åº”è¯¥ç®€çŸ­ï¼ˆ2-5æ¡æ¶ˆæ¯å³å¯ï¼‰ï¼Œç¬¦åˆé€»è¾‘å’Œè§’è‰²æ€§æ ¼ã€‚å¯ä»¥æ˜¯é—²èŠã€è®¨è®ºæŸä¸ªè¯é¢˜ï¼Œæˆ–è€…å¯¹ä¹‹å‰èŠå¤©å†…å®¹çš„å»¶ç»­ã€‚ä¸è¦æ¯æ¬¡éƒ½ç”Ÿæˆæ‰€æœ‰äººçš„å‘è¨€ã€‚

## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
-   **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å",  "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡æè¿°"}\`
-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³å†…å®¹"}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\` (å‘ã€ç¾¤å‹ã€‘å‘èµ·)
-   **æ‹ä¸€æ‹ç¾¤å‹**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "targetName": "ã€è¢«æ‹çš„ç¾¤å‹åã€‘", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
-   **å‘çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", ...}\`
-   **å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", ...}\`

# å¦‚ä½•å¤„ç†åå°äº’åŠ¨ä¸­çš„ã€æ‹ä¸€æ‹ã€‘:
-   åå°æ´»åŠ¨ä¸­çš„ "pat_user" æŒ‡ä»¤ã€åªèƒ½ç”¨äºæ‹ç¾¤å†…çš„å…¶ä»–AIè§’è‰²ã€‘ã€‚
-   ä½ ã€å¿…é¡»ã€‘åœ¨æŒ‡ä»¤ä¸­åŠ å…¥ä¸€ä¸ª \`"targetName"\` å­—æ®µï¼Œå€¼ä¸ºè¢«ä½ æ‹çš„é‚£ä¸ªè§’è‰²çš„åå­—ã€‚
-   ä¾‹å¦‚: \`{"type": "pat_user", "name": "è§’è‰²A", "targetName": "è§’è‰²B"}\`
-   ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ "è§’è‰²A æ‹äº†æ‹ è§’è‰²B" çš„æç¤ºã€‚

${worldBookContent}
${musicContext}
${countdownContext} // <--- æŠŠå¤‡å¿˜å½•åŠ åœ¨è¿™é‡Œ
${sharedContext} 
# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}
# ç”¨æˆ·çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}
# å¯¹è¯å†å²å‚è€ƒ (æœ€è¿‘5æ¡)
${chat.history.slice(-5).map(m => `${m.senderName || 'ç”¨æˆ·'}: ${m.content}`).join('\n')}

ç°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è§„åˆ™ï¼Œå¼€å§‹ä½ çš„æ¨¡æ‹Ÿã€‚`;
        
        const messagesPayload = [{ role: 'user', content: systemPrompt }];

        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        const messagesArray = JSON.parse(aiResponseContent);

        if (Array.isArray(messagesArray) && messagesArray.length > 0) {
            let messageTimestamp = Date.now();
            let firstMessageContent = '';
            
            messagesArray.forEach((msgData, index) => {
                if (msgData.name && msgData.message) {
                    const aiMessage = {
                        role: 'assistant',
                        senderName: msgData.name,
                        content: String(msgData.message),
                        timestamp: messageTimestamp++
                    };
                    chat.history.push(aiMessage);
                    if (index === 0) {
                        firstMessageContent = `${msgData.name}: ${msgData.message}`;
                    }
                }
            });

            // æ›´æ–°æ­¤ç¾¤èŠçš„æœ€åæ´»åŠ¨æ—¶é—´æˆ³
            chat.settings.backgroundActivity.lastActivityTimestamp = Date.now();
            
            // ç»™ç”¨æˆ·å‘é€šçŸ¥
            chat.unreadCount = (chat.unreadCount || 0) + messagesArray.length;
            showNotification(chatId, firstMessageContent);
            
            // ä¿å­˜å¹¶åˆ·æ–°UI
            await db.chats.put(chat);
            renderChatList();
            
            console.log(`ç¾¤èŠ "${chat.name}" åå°äº’åŠ¨æˆåŠŸï¼Œç”Ÿæˆäº† ${messagesArray.length} æ¡æ–°æ¶ˆæ¯ã€‚`);
        }

    } catch (error) {
        console.error(`ç¾¤èŠ "${chat.name}" çš„åå°æ´»åŠ¨å¤±è´¥:`, error);
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handleEditImage å‡½æ•° â–¼â–¼â–¼
async function handleEditImage(element) {
    const elementId = element.id;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº†æŒ‰é’®æ–‡å­—ä¸­çš„å›¾æ ‡
    const choice = await showChoiceModal("ä¿®æ”¹å›¾ç‰‡", [
        { text: 'ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
        { text: 'ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
    ]);

    let newValue = null;

    if (choice === 'local') {
        newValue = await uploadImageLocally();
    } else if (choice === 'url') {
        newValue = await showCustomPrompt("ä¿®æ”¹å›¾ç‰‡", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URLï¼š", element.src, "url");
    }

    if (newValue && newValue.trim()) {
        const trimmedValue = newValue.trim();
        element.src = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
    } else if (choice === 'url' && newValue !== null) {
        alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠä¸“å±åå°æ´»åŠ¨æ—¶é’Ÿ â–¼â–¼â–¼

let groupSimulationIntervalId = null; // ç”¨äºå­˜å‚¨ç¾¤èŠä¸»æ—¶é’Ÿçš„ID

/**
 * å¯åŠ¨ç¾¤èŠçš„åå°â€œä¸»æ—¶é’Ÿâ€ã€‚è¿™ä¸ªæ—¶é’Ÿä¼šä¸€ç›´è¿è¡Œï¼Œå®šæœŸæ£€æŸ¥æ‰€æœ‰ç¾¤èŠã€‚
 */
function startGroupSimulation() {
    if (groupSimulationIntervalId) return; // å¦‚æœå·²ç»å¯åŠ¨ï¼Œåˆ™ä¸é‡å¤å¯åŠ¨
    
    // æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªç›¸å¯¹è¾ƒçŸ­çš„é—´éš”ï¼ˆæ¯”å¦‚30ç§’ï¼‰æ¥ä½œä¸ºâ€œä¸»æ—¶é’Ÿâ€çš„é¢‘ç‡
    // å®ƒä¸æ˜¯å…·ä½“æŸä¸ªç¾¤èŠçš„æ´»åŠ¨é—´éš”ï¼Œè€Œæ˜¯æ£€æŸ¥æ‰€æœ‰ç¾¤èŠçš„é¢‘ç‡
    groupSimulationIntervalId = setInterval(runGroupSimulationTick, 30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    console.log("ç¾¤èŠåå°æ´»åŠ¨ä¸»æ—¶é’Ÿå·²å¯åŠ¨ï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰ç¾¤èŠã€‚");
}

/**
 * åœæ­¢ç¾¤èŠçš„åå°â€œä¸»æ—¶é’Ÿâ€ã€‚
 */
function stopGroupSimulation() {
    if (groupSimulationIntervalId) {
        clearInterval(groupSimulationIntervalId);
        groupSimulationIntervalId = null;
        console.log("ç¾¤èŠåå°æ´»åŠ¨ä¸»æ—¶é’Ÿå·²åœæ­¢ã€‚");
    }
}

/**
 * ç¾¤èŠâ€œä¸»æ—¶é’Ÿâ€çš„æ¯ä¸€æ¬¡å¿ƒè·³æ‰§è¡Œçš„å‡½æ•°
 */
function runGroupSimulationTick() {
    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);

    allGroupChats.forEach(chat => {
        const bgSettings = chat.settings.backgroundActivity;
        // æ£€æŸ¥1ï¼šè¯¥ç¾¤èŠè‡ªå·±çš„å¼€å…³æ˜¯å¦å¼€å¯
        if (bgSettings && bgSettings.enabled) {
            const now = Date.now();
            // æ£€æŸ¥2ï¼šä½¿ç”¨è¯¥ç¾¤èŠè‡ªå·±è®¾ç½®çš„é—´éš”æœŸ
            const intervalMs = (bgSettings.interval || 120) * 1000;
            const lastActivity = bgSettings.lastActivityTimestamp || 0;

            // æ£€æŸ¥3ï¼šæ˜¯å¦åˆ°è¾¾äº†è¯¥ç¾¤èŠçš„è¡ŒåŠ¨æ—¶é—´
            if (now - lastActivity > intervalMs) {
                console.log(`ç¾¤èŠ "${chat.name}" åˆ°è¾¾è¡ŒåŠ¨æ—¶é—´ (é—´éš”: ${bgSettings.interval}ç§’)ï¼Œå‡†å¤‡è§¦å‘åå°äº’åŠ¨...`);
                // è§¦å‘ç¾¤èŠä¸“å±çš„åå°è¡ŒåŠ¨å‡½æ•°
                triggerGroupAiAction(chat.id);
            }
        }
    });
}

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºæ‰€æœ‰å·²å…³æ³¨è§’è‰²çš„å¾®åšå¸–å­
 */
async function clearFollowingFeed() {
    // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç©º',
        'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ã€éä½ æœ¬äººå‘å¸ƒã€‘çš„å¾®åšï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' } // çº¢è‰²æŒ‰é’®ä»¥ç¤ºè­¦å‘Š
    );

    if (!confirmed) {
        return; // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }

    try {
        // 2. ä»æ•°æ®åº“ä¸­æ‰¾å‡ºæ‰€æœ‰ä½œè€…ä¸æ˜¯'user'çš„å¸–å­
        const postsToDelete = await db.weiboPosts.where('authorId').notEqual('user').toArray();
        const idsToDelete = postsToDelete.map(p => p.id);

        if (idsToDelete.length === 0) {
            alert("ç›®å‰æ²¡æœ‰å¯ä»¥æ¸…ç©ºçš„åŠ¨æ€ã€‚");
            return;
        }

        // 3. æ‰¹é‡åˆ é™¤è¿™äº›å¸–å­
        await db.weiboPosts.bulkDelete(idsToDelete);

        // 4. é‡æ–°æ¸²æŸ“â€œå…³æ³¨çš„äººâ€çš„Feedï¼Œè®©ç•Œé¢å˜ç©º
        await renderWeiboFeeds('weibo-following-view');

        alert(`å·²æˆåŠŸæ¸…ç©º ${idsToDelete.length} æ¡åŠ¨æ€ï¼`);

    } catch (error) {
        console.error("æ¸…ç©ºå…³æ³¨åŠ¨æ€æ—¶å‡ºé”™:", error);
        alert(`æ“ä½œå¤±è´¥: ${error.message}`);
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ä¸¤ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°ä¸»å±å¹•çš„Appå›¾æ ‡ä¸Š
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

/**
 * ã€å…¨æ–°ã€‘åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appå›¾æ ‡çš„è®¾ç½®é¡¹
 */
function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€ä¿®æ”¹åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ appLabels â–¼â–¼â–¼
const appLabels = {
    'world-book': 'ä¸–ç•Œä¹¦',
    'qq': 'QQ',
    'api-settings': 'APIè®¾ç½®',
    'wallpaper': 'å£çº¸',
    'font': 'å­—ä½“',
    'check-phone': 'æŸ¥æ‰‹æœº',
    'weibo': 'å¾®åš',
    'forum': 'åœˆå­',
    'lovers-space': 'æƒ…ä¾£ç©ºé—´',
    'game-hall': 'æ¸¸æˆå¤§å…',
    'x-social': 'Xç¤¾äº¤',
    'taobao': 'æ¡ƒå®',
    'date-a-live':'çº¦ä¼šå¤§ä½œæˆ˜'
};
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'æœªçŸ¥App';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        // ã€é‡è¦ã€‘æˆ‘ä»¬ç”¨ data-icon-id æ¥æ ‡è®°è¿™ä¸ªè®¾ç½®é¡¹å¯¹åº”å“ªä¸ªå›¾æ ‡
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn">æ›´æ¢</button>
        `;
        grid.appendChild(item);
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆç¡®è®¤ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ openBrowser å’Œ closeBrowser å‡½æ•° â–¼â–¼â–¼

/**
 * å½“ç”¨æˆ·ç‚¹å‡»é“¾æ¥å¡ç‰‡æ—¶ï¼Œæ‰“å¼€ä¼ªæµè§ˆå™¨
 * @param {number} timestamp - è¢«ç‚¹å‡»æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿ chat å’Œ history éƒ½å­˜åœ¨
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æ¥:", timestamp);
        return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
    }

    // å¡«å……æµè§ˆå™¨å†…å®¹
    document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è¯¦æƒ…';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'æ— æ ‡é¢˜'}</h1>
        <div class="article-meta">
            <span>æ¥æº: ${message.source_name || 'æœªçŸ¥'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'å†…å®¹ä¸ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // æ˜¾ç¤ºæµè§ˆå™¨å±å¹•
    showScreen('browser-screen');
}

/**
 * å…³é—­ä¼ªæµè§ˆå™¨ï¼Œè¿”å›èŠå¤©ç•Œé¢
 * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€è®©ç”¨æˆ·å¡«å†™é“¾æ¥ä¿¡æ¯çš„æ¨¡æ€æ¡†
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥çš„å†…å®¹
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·ç¡®è®¤åˆ†äº«ï¼Œåˆ›å»ºå¹¶å‘é€é“¾æ¥å¡ç‰‡æ¶ˆæ¯
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦ï¼");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
    const linkMessage = {
        role: 'user', // è§’è‰²æ˜¯ 'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // ç”¨æˆ·åˆ†äº«çš„é“¾æ¥ï¼Œæˆ‘ä»¬ä¸æä¾›å›¾ç‰‡ï¼Œè®©å®ƒæ€»æ˜¯æ˜¾ç¤ºå ä½å›¾
        thumbnail_url: null 
    };

    // å°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // æ¸²æŸ“æ–°æ¶ˆæ¯å¹¶æ›´æ–°åˆ—è¡¨
    appendMessage(linkMessage, chat);
    renderChatList();

    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°å‡çº§ç‰ˆã€‘æ ¹æ®AIè§†è§’å’ŒåŠ¨æ€è®¾ç½®ï¼Œæ„å»ºç»™AIçœ‹çš„è¯„è®ºåŒºä¸Šä¸‹æ–‡
 * @param {object} post - æ­£åœ¨å¤„ç†çš„åŠ¨æ€å¯¹è±¡
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„AIè§’è‰²
 * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
 * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è§æ€§æ ‡å¿—çš„å¯¹è±¡
 */
function buildCommentsContextForAI(post, viewerChat, userNickname) {
    if (!post.comments || post.comments.length === 0) {
        // â˜…â˜…â˜… å…³é”®åœ¨è¿™é‡Œï¼šç¡®ä¿ "[è¯„è®ºåŒºå¯è§]" æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„å­—ç¬¦ä¸² â˜…â˜…â˜…
        return { contextString: "", visibilityFlag: "[è¯„è®ºåŒºå¯è§]" };
    }

    const viewerName = viewerChat.name;
    let commentsForAI;
    let visibilityFlag;

    if (post.areCommentsVisible !== false) {
        commentsForAI = post.comments;
        // â˜…â˜…â˜… å…³é”®åœ¨è¿™é‡Œï¼šç¡®ä¿ "[è¯„è®ºåŒºå¯è§]" æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„å­—ç¬¦ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è¯„è®ºåŒºå¯è§]"; 
    } else {
commentsForAI = Array.isArray(post.comments)
  ? post.comments.filter(comment => {
      return comment.commenterName === viewerName
          || comment.commenterName === userNickname
          || comment.replyTo === viewerName;
    })
  : [];
        // â˜…â˜…â˜… å…³é”®åœ¨è¿™é‡Œï¼šç¡®ä¿ "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]" æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„å­—ç¬¦ä¸² â˜…â˜…â˜…
        visibilityFlag = "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]";
    }

    if (commentsForAI.length === 0) {
        return { contextString: "", visibilityFlag: visibilityFlag };
    }

    let context = `  â”” è¯„è®ºåŒº:\n`;
    commentsForAI.slice(-5).forEach(c => {
        if (c.replyTo) {
            context += `    - ${c.commenterName} å›å¤ ${c.replyTo}: ${c.text}\n`;
        } else {
            context += `    - ${c.commenterName}: ${c.text}\n`;
        }
    });
    
    return { contextString: context, visibilityFlag: visibilityFlag };
}



/**
 * æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
 * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
 * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æ£€æŸ¥

    const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†ç»„ID

    return allPosts.filter(post => {
        // è§„åˆ™1ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
        if (post.authorId === 'user') {
            // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®ï¼Œè¯´æ˜æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è§
            return true;
        }

        // è§„åˆ™2ï¼šå¦‚æœæ˜¯å…¶ä»–AIå‘çš„åŠ¨æ€
        const authorGroupId = post.authorGroupId; // å‘å¸–AIæ‰€åœ¨çš„åˆ†ç»„ID
        
        // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„ï¼Œé‚£å®ƒçš„åŠ¨æ€å°±æ˜¯å…¬å¼€çš„
        if (!authorGroupId) {
            return true;
        }

        // å¦‚æœå‘å¸–çš„AIæœ‰åˆ†ç»„ï¼Œé‚£ä¹ˆåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†ç»„çš„AIæ‰èƒ½çœ‹åˆ°
        return authorGroupId === viewerGroupId;
    });
}

/**
 * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
 * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    localStorage.setItem('ephone-theme', theme);
}

/**
 * åˆ‡æ¢å½“å‰çš„ä¸»é¢˜
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘åŒæ—¶è·å–â€œå®Œæ•´å†…å®¹â€å’Œâ€œé¢„è§ˆç‰‡æ®µâ€
    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
        previewSnippet = '[è¡¨æƒ…]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
        previewSnippet = '[å›¾ç‰‡]';
    } else if (message.type === 'voice_message') {
        previewSnippet = '[è¯­éŸ³]';
    } else {
        // é¢„è§ˆç‰‡æ®µä¾ç„¶æˆªæ–­ï¼Œä½†åªç”¨äºUIæ˜¾ç¤º
        previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†â€œå®Œæ•´å†…å®¹â€å­˜å…¥ä¸Šä¸‹æ–‡ï¼Œä»¥å¤‡å‘é€æ—¶ä½¿ç”¨
    currentReplyContext = {
        timestamp: message.timestamp,
        senderName: message.senderName || (message.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
        content: fullContent, // <--- è¿™é‡Œå­˜çš„æ˜¯å®Œæ•´çš„åŸæ–‡ï¼
    };

    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘ä»…åœ¨æ›´æ–°â€œå›å¤é¢„è§ˆæ â€æ—¶ï¼Œæ‰ä½¿ç”¨â€œé¢„è§ˆç‰‡æ®µâ€
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `å›å¤ ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet; // <--- è¿™é‡Œç”¨çš„æ˜¯ç¼©ç•¥ç‰ˆï¼
    previewBar.style.display = 'block';

    // 4. åç»­æ“ä½œä¿æŒä¸å˜
    hideMessageActions();
    document.getElementById('chat-input').focus();
}

/**
 * ã€å…¨æ–°ã€‘å–æ¶ˆå¼•ç”¨æ¨¡å¼
 */
function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·å¤„ç†è½¬è´¦çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

let activeTransferTimestamp = null; // ç”¨äºæš‚å­˜è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³

/**
 * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {
        // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
        document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
}

/**
 * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 */
function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
}

/**
 * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
 * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
 */
async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;

    let systemContent;

    // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
    if (choice === 'declined') {
        // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°ï¼Œç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
            amount: originalMessage.amount,
            note: 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        
        // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
    } else { // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
        // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
        systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
        await updateUserBalanceAndLogTransaction(originalMessage.amount, `æ”¶åˆ°æ¥è‡ª ${originalMessage.senderName} çš„è½¬è´¦`);
    }

    // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
        isHidden: true // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“ï¼Œå¹¶åˆ·æ–°ç•Œé¢
    await db.chats.put(chat);
    hideTransferActionModal(); 
    renderChatInterface(state.activeChatId);
    renderChatList();
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

async function renderCallHistoryScreen() {
    showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»åŠ¨åˆ°æœ€å‰é¢ï¼

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'æ‰€æœ‰é€šè¯è®°å½•';
    
    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
    
    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>';
        return; // ç°åœ¨çš„ return å°±æ²¡é—®é¢˜äº†ï¼Œå› ä¸ºå®ƒåªè·³è¿‡äº†åç»­çš„æ¸²æŸ“é€»è¾‘
    }
    
    records.forEach(record => {
        const card = createCallRecordCard(record);

    addLongPressListener(card, async () => {
        // 1. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œå¹¶å°†æ—§åç§°ä½œä¸ºé»˜è®¤å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
        const newName = await showCustomPrompt(
            "è‡ªå®šä¹‰é€šè¯åç§°", 
            "è¯·è¾“å…¥æ–°çš„åç§°ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰",
            record.customName || '' // å¦‚æœå·²æœ‰è‡ªå®šä¹‰åç§°ï¼Œå°±æ˜¾ç¤ºå®ƒ
        );

        // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
        if (newName === null) return;
        
        // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½•
        await db.callRecords.update(record.id, { customName: newName.trim() });
        
        // 4. åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼Œè®©æ›´æ”¹ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
        await renderCallHistoryScreen();
        
        // 5. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
        await showCustomAlert('æˆåŠŸ', 'é€šè¯åç§°å·²æ›´æ–°ï¼');
    });
        listEl.appendChild(card);
    });    
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å‡çº§ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ createCallRecordCard å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å‡çº§ç‰ˆã€‘æ ¹æ®å•æ¡è®°å½•æ•°æ®ï¼Œåˆ›å»ºä¸€å¼ èƒ½æ˜¾ç¤ºèŠå¤©å¯¹è±¡çš„é€šè¯å¡ç‰‡
 * @param {object} record - ä¸€æ¡é€šè¯è®°å½•å¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
 */
function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id; 

    // è·å–é€šè¯å¯¹è±¡çš„åå­—
    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥ä¼šè¯';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;

    const avatarsHtml = record.participants.map(p => 
        `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');
    
    card.innerHTML = `
        <div class="card-header">
            <span class="date">${dateString}</span>
            <span class="duration">${durationText}</span>
        </div>
        <div class="card-body">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªæ ‡é¢˜è¡Œ -->
            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
            
            <div class="participants-info"> <!-- æ–°å¢ä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
                <div class="participants-avatars">${avatarsHtml}</div>
                <span class="participants-names">ä¸ ${chatName}</span>
            </div>
        </div>
    `;
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŒ‡å®šé€šè¯è®°å½•çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè¯è®°å½•çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = `é€šè¯äº ${new Date(record.timestamp).toLocaleString()} (æ—¶é•¿: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>';
    } else {
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            // æ ¹æ®è§’è‰²æ·»åŠ ä¸åŒçš„classï¼Œåº”ç”¨ä¸åŒçš„æ ·å¼
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const deleteBtn = document.getElementById('delete-transcript-btn');
    
    // ã€é‡è¦ã€‘ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // ä¸ºæ–°çš„ã€å¹²å‡€çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 1. å…³é—­å½“å‰çš„è¯¦æƒ…å¼¹çª—
            modal.classList.remove('visible');
            
            // 2. ä»æ•°æ®åº“åˆ é™¤
            await db.callRecords.delete(recordId);
            
            // 3. åˆ·æ–°é€šè¯è®°å½•åˆ—è¡¨
            await renderCallHistoryScreen();
            
            // 4. (å¯é€‰) ç»™å‡ºæˆåŠŸæç¤º
            alert('é€šè¯è®°å½•å·²åˆ é™¤ã€‚');
        }
    });
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘æ›¿æ¢æ‰ä½ æ—§çš„ handleStatusResetClick å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æ ï¼Œå¼¹å‡ºç¼–è¾‘æ¡†è®©ç”¨æˆ·ä¿®æ”¹AIçš„å½“å‰çŠ¶æ€
 */
async function handleEditStatusClick() {
    // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿åœ¨å•èŠç•Œé¢
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        return; 
    }
    const chat = state.chats[state.activeChatId];

    // 2. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥æ–°çš„çŠ¶æ€ï¼Œå¹¶å°†å½“å‰çŠ¶æ€ä½œä¸ºé»˜è®¤å€¼
    const newStatusText = await showCustomPrompt(
        'ç¼–è¾‘å¯¹æ–¹çŠ¶æ€',
        'è¯·è¾“å…¥å¯¹æ–¹ç°åœ¨çš„æ–°çŠ¶æ€ï¼š',
        chat.status.text // å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥æ¡†çš„é»˜è®¤å†…å®¹
    );

    // 3. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»äº†â€œç¡®å®šâ€
    if (newStatusText !== null) {
        // 4. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„çŠ¶æ€æ•°æ®
        chat.status.text = newStatusText.trim() || 'åœ¨çº¿'; // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†ï¼Œå°±é»˜è®¤ä¸ºâ€œåœ¨çº¿â€
        chat.status.isBusy = false; // æ¯æ¬¡æ‰‹åŠ¨ç¼–è¾‘éƒ½é»˜è®¤å…¶ä¸å¤„äºâ€œå¿™ç¢Œâ€çŠ¶æ€
        chat.status.lastUpdate = Date.now();
        await db.chats.put(chat);

        // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿®æ”¹åçš„çŠ¶æ€
        renderChatInterface(state.activeChatId);
        renderChatList();
        
        // 6. ç»™å‡ºä¸€ä¸ªæ— ä¼¤å¤§é›…çš„æˆåŠŸæç¤º
        await showCustomAlert('çŠ¶æ€å·²æ›´æ–°', `â€œ${chat.name}â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${chat.status.text}`);
    }
}

// æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº
async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';

    // è·å–æ‰€æœ‰èŠå¤©ä½œä¸ºåˆ†äº«ç›®æ ‡
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
        // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
        if (callback) callback();
        return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
        document.getElementById('music-playlist-panel').classList.remove('visible');
        if (callback) callback();
    }, 400); 
}

function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = lrcContent.split('\n');
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
}

function updateLyricsUI() {
    const lyricsList = document.getElementById('music-lyrics-list');
    const container = document.getElementById('music-lyrics-container');
    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));
    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }
    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 3) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™å—ã€æ–°ä»£ç ã€‘ â–¼â–¼â–¼
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åŒæ­¥æ­Œè¯åˆ°æ‚¬æµ®æ 
    const floatingLyricText = document.getElementById('floating-lyric-text');
    if (activeLine) {
        floatingLyricText.textContent = activeLine.textContent;
    } else if (musicState.parsedLyrics.length > 0) {
        floatingLyricText.textContent = 'â™ª â™ª â™ª'; // æ­Œæ›²å‰å¥
    } else {
        floatingLyricText.textContent = 'â™ª æš‚æ— æ­Œè¯ â™ª';
    }
    // â–²â–²â–² æ–°ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²

}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

function updateMusicProgressBar() {
    const currentTimeEl = document.getElementById('music-current-time');
    const totalTimeEl = document.getElementById('music-total-time');
    const progressFillEl = document.getElementById('music-progress-fill');
    if (!audioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
    updateActiveLyric(audioPlayer.currentTime);
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œæ’¤å›â€æŒ‰é’®çš„å…¥å£å‡½æ•°
 */
async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è®¾ç½®2åˆ†é’Ÿçš„æ’¤å›æ—¶é™
    const messageTime = activeMessageTimestamp;
    const now = Date.now();

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡äº†æ’¤å›æ—¶é™
    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
        hideMessageActions();
        await showCustomAlert('æ“ä½œå¤±è´¥', 'è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›ã€‚');
        return;
    }
    
    // å¦‚æœåœ¨æ—¶é™å†…ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ’¤å›é€»è¾‘
    await recallMessage(messageTime, true);
    hideMessageActions();
}

/**
 * ã€å…¨æ–°ã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé€»è¾‘
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    // 1. ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡ï¼Œå°†å…¶å˜ä¸ºâ€œå·²æ’¤å›â€çŠ¶æ€
    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        // ä¿å­˜å…¶ä»–å¯èƒ½å­˜åœ¨çš„åŸå§‹æ•°æ®
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote 
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯' : 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    // æ¸…ç†æ‰ä¸å†éœ€è¦çš„æ—§å±æ€§
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // 2. å¦‚æœæ˜¯ç”¨æˆ·æ’¤å›ï¼Œéœ€è¦ç»™AIå‘é€ä¸€æ¡å®ƒçœ‹ä¸æ‡‚å†…å®¹çš„éšè—æç¤º
    if (isUserRecall) {
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ã€‚ä½ ä¸çŸ¥é“å†…å®¹æ˜¯ä»€ä¹ˆï¼Œåªéœ€çŸ¥é“è¿™ä¸ªäº‹ä»¶å³å¯ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);
    }

    // 3. ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    if(isUserRecall) renderChatList(); // ç”¨æˆ·æ’¤å›æ—¶ï¼Œæœ€åä¸€æ¡æ¶ˆæ¯å˜äº†ï¼Œéœ€è¦åˆ·æ–°åˆ—è¡¨
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™äº›å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
 */
async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
 */
async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
    }
    categories.forEach(cat => {
        // å¤ç”¨å¥½å‹åˆ†ç»„çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»
 */
async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
        return;
    }
    await db.worldBookCategories.add({ name });
    input.value = '';
    await renderCategoryListInManager();
}

/**
 * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»
 * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
 */
async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        'åˆ é™¤åˆ†ç±»åï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', 
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.worldBookCategories.delete(categoryId);
        // å°†å±äºè¯¥åˆ†ç±»çš„ä¸–ç•Œä¹¦çš„ categoryId è®¾ä¸º null
        const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
        for (const book of booksToUpdate) {
            book.categoryId = null;
            await db.worldBooks.put(book);
            const bookInState = state.worldBooks.find(wb => wb.id === book.id);
            if(bookInState) bookInState.categoryId = null;
        }
        await renderCategoryListInManager();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²ä¸“å±NPCåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

let editingNpcId = null; // ç”¨äºè¿½è¸ªæ­£åœ¨ç¼–è¾‘çš„NPC

/**
 * æ‰“å¼€NPCåº“ç®¡ç†ç•Œé¢
 */
function openNpcManager() {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('npc-management-title').textContent = `â€œ${chat.name}â€çš„NPCåº“`;
    renderNpcList();
    showScreen('npc-management-screen');
}

/**
 * æ¸²æŸ“NPCåˆ—è¡¨
 */
function renderNpcList() {
    const listEl = document.getElementById('npc-management-list');
    const chat = state.chats[state.activeChatId];
    const npcLibrary = chat.npcLibrary || [];
    listEl.innerHTML = '';

    if (npcLibrary.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€ä¸ªNPCå§ï¼</p>';
        return;
    }

    npcLibrary.forEach(npc => {
        // å¤ç”¨èŠå¤©åˆ—è¡¨çš„æ ·å¼ï¼Œéå¸¸æ–¹ä¾¿
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <div class="info">
                <span class="name">${npc.name}</span>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;
        // ç‚¹å‡»ç¼–è¾‘
        item.addEventListener('click', () => openNpcEditor(npc.id));
        // é•¿æŒ‰åˆ é™¤
        addLongPressListener(item, () => deleteNpc(npc.id, npc.name));
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å…¨æ–°çš„ã€å·²ä¿®å¤ä¸¤ä¸ªBugçš„å‡½æ•°ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openNpcEditor å‡½æ•° â–¼â–¼â–¼
async function openNpcEditor(npcId = null) {
    editingNpcId = npcId;
    // ã€æ ¸å¿ƒä¿®å¤1ã€‘ä½¿ç”¨æ­£ç¡®çš„ state.activeChatId æ¥è·å–å½“å‰èŠå¤©å¯¹è±¡
    const chat = state.chats[state.activeChatId];
    if (!chat) return; // å®‰å…¨æ£€æŸ¥

    let npc = { name: '', persona: '', avatar: defaultGroupMemberAvatar };
    
    if (npcId) {
        // ã€æ ¸å¿ƒä¿®å¤2ã€‘ä»æ­£ç¡®çš„ chat.npcLibrary ä¸­æŸ¥æ‰¾æ•°æ®
        npc = (chat.npcLibrary || []).find(n => n.id === npcId) || npc;
        document.getElementById('persona-editor-title').textContent = `ç¼–è¾‘NPC: ${npc.name}`;
    } else {
        document.getElementById('persona-editor-title').textContent = 'æ·»åŠ æ–°NPC';
    }
    
    // å¡«å……ç¼–è¾‘å™¨å†…å®¹
    document.getElementById('npc-editor-name-input').value = npc.name;
    document.getElementById('preset-avatar-preview').src = npc.avatar;
    document.getElementById('preset-persona-input').value = npc.persona;
    
    // ã€æ ¸å¿ƒé€»è¾‘ã€‘æ ¹æ®NPCæ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
    document.getElementById('npc-editor-name-group').style.display = 'block';
    document.getElementById('persona-editor-change-frame-btn').style.display = 'none';

    // ç»‘å®šæ­£ç¡®çš„ä¿å­˜å‡½æ•°
    document.getElementById('save-persona-preset-btn').onclick = saveNpc;

    // æœ€åæ‰æ˜¾ç¤ºå¼¹çª—
    document.getElementById('persona-editor-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²






// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼
/**
 * ã€V2 - å®Œæ•´ç‰ˆã€‘ä¿å­˜NPCï¼ˆæ–°å»ºæˆ–æ›´æ–°ï¼‰
 */
async function saveNpc() {
    const chat = state.chats[state.activeChatId];

    
    // ä»ç¼–è¾‘å™¨ä¸­è·å–æ‰€æœ‰æ•°æ®
    const name = document.getElementById('npc-editor-name-input').value.trim();
    const persona = document.getElementById('preset-persona-input').value.trim();
    const avatar = document.getElementById('preset-avatar-preview').src;

    if (!name) {
        alert("NPCåå­—ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    if (editingNpcId) {
        // æ›´æ–°ç°æœ‰çš„NPC
        const npc = chat.npcLibrary.find(n => n.id === editingNpcId);
        if (npc) {
            npc.name = name;
            npc.persona = persona;
            npc.avatar = avatar;
        }
    } else {
        // æ·»åŠ ä¸€ä¸ªå…¨æ–°çš„NPC
        const newNpc = {
            id: 'npc_' + Date.now(),
            name: name,
            persona: persona,
            avatar: avatar
        };
        chat.npcLibrary.push(newNpc);
    }

    await db.chats.put(chat);
    renderNpcList();
    closePersonaEditor(); // å¤ç”¨å…³é—­ç¼–è¾‘å™¨çš„å‡½æ•°
}
// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²


/**
 * åˆ é™¤ä¸€ä¸ªNPC
 * @param {string} npcId - è¦åˆ é™¤çš„NPCçš„ID
 * @param {string} npcName - è¦åˆ é™¤çš„NPCçš„åå­—ï¼Œç”¨äºç¡®è®¤æç¤º
 */
async function deleteNpc(npcId, npcName) {
    const confirmed = await showCustomConfirm(
        'åˆ é™¤NPC',
        `ç¡®å®šè¦ä»â€œ${state.chats[state.activeChatId].name}â€çš„NPCåº“ä¸­åˆ é™¤ â€œ${npcName}â€ å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        chat.npcLibrary = chat.npcLibrary.filter(n => n.id !== npcId);
        await db.chats.put(chat);
        renderNpcList();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªå®šä¹‰å¤´åƒæ¡†ç®¡ç†åŠŸèƒ½ â–¼â–¼â–¼ ---

function openFrameManager() {
    renderFrameManager();
    document.getElementById('custom-frame-manager-modal').classList.add('visible');
}

async function renderFrameManager() {
    const grid = document.getElementById('custom-frame-grid');
    grid.innerHTML = '';
    const customFrames = await db.customAvatarFrames.toArray();
    if (customFrames.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">ä½ è¿˜æ²¡æœ‰ä¸Šä¼ è¿‡å¤´åƒæ¡†å“¦~</p>';
        return;
    }
    customFrames.forEach(frame => {
        const item = document.createElement('div');
        // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼ï¼Œå¾ˆæ–¹ä¾¿
        item.className = 'sticker-item'; 
        item.style.backgroundImage = `url(${frame.url})`;
        item.title = frame.name;
        
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒæ¡†', `ç¡®å®šè¦åˆ é™¤â€œ${frame.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.customAvatarFrames.delete(frame.id);
                renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * ã€V2å¤šé€‰ç‰ˆã€‘å¤„ç†ç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒæ¡†çš„é€»è¾‘
 */
function handleUploadCustomFrame() {
    document.getElementById('custom-frame-upload-input').addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files.length) return;

        const newFrames = [];
        
        // ä½¿ç”¨ for...of å¾ªç¯æ¥é€ä¸ªå¤„ç†é€‰ä¸­çš„æ–‡ä»¶
        for (const file of files) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è‡ªåŠ¨ç”Ÿæˆåå­—ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·è¾“å…¥
            // æˆ‘ä»¬ç”¨ "æ–‡ä»¶å (å‰8ä½) + æ—¶é—´æˆ³" æ¥ç¡®ä¿åå­—å‡ ä¹ä¸ä¼šé‡å¤
            const fileName = file.name.replace(/\.[^/.]+$/, "").substring(0, 8);
            const autoName = `${fileName}_${Date.now()}`;

            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            
            newFrames.push({
                id: 'frame_' + (Date.now() + newFrames.length), // ç¡®ä¿IDå”¯ä¸€
                name: autoName,
                url: base64Url
            });
        }
        
        // å¾ªç¯ç»“æŸåï¼Œæ‰¹é‡æ·»åŠ åˆ°æ•°æ®åº“
        if (newFrames.length > 0) {
            await db.customAvatarFrames.bulkAdd(newFrames);
            renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
            await showCustomAlert("ä¸Šä¼ æˆåŠŸ", `å·²æˆåŠŸæ·»åŠ  ${newFrames.length} ä¸ªæ–°å¤´åƒæ¡†ï¼`);
        }

        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨çš„å€¼
        event.target.value = null;
    }, { once: true });

    document.getElementById('custom-frame-upload-input').click();
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ æ–°åˆ†æ”¯ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼
async function openFrameSelectorModal(type, targetId = null) {
    const grid = document.getElementById('avatar-frame-grid');
    grid.innerHTML = '';
    
    currentFrameSelection.type = type;
    currentFrameSelection.target = targetId;
    
    const chat = state.chats[state.activeChatId];
    let currentFrameUrl = '';
    let previewAvatarUrl = '';

    // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æ–°å¢çš„åˆ†æ”¯é€»è¾‘ï¼â–¼â–¼â–¼ ---
    if (type === 'char-weibo') { 
        // å¦‚æœæ˜¯ä¸ºâ€œè§’è‰²å¾®åšâ€æ¢æ¡†
        const charChat = state.chats[currentViewingWeiboProfileId];
        currentFrameUrl = charChat.settings.weiboAvatarFrame || '';
        previewAvatarUrl = charChat.settings.weiboAvatar || defaultAvatar;
    }
    // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---
    else if (type === 'home_profile') {
        currentFrameUrl = state.globalSettings.homeAvatarFrame || '';
        previewAvatarUrl = document.getElementById('profile-avatar-img').src;
    } 
    else if (type === 'weibo_profile') {
        currentFrameUrl = state.qzoneSettings.weiboAvatarFrame || '';
        previewAvatarUrl = state.qzoneSettings.weiboAvatar || defaultAvatar;
    } 
    else if (type === 'ai') {
        currentFrameUrl = chat.settings.aiAvatarFrame || '';
        previewAvatarUrl = chat.settings.aiAvatar || defaultAvatar;
    } else if (type === 'my') {
        currentFrameUrl = chat.settings.myAvatarFrame || '';
        previewAvatarUrl = chat.settings.myAvatar || defaultAvatar;
    } else if (type === 'member' && targetId) {
        const member = chat.members.find(m => m.id === targetId);
        if (member) {
            currentFrameUrl = member.avatarFrame || '';
            previewAvatarUrl = member.avatar || defaultGroupMemberAvatar;
        }
    }
    
    // åç»­æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
    const customFrames = await db.customAvatarFrames.toArray();
    const frameUrlSet = new Set();
    const allFrames = [...avatarFrames, ...customFrames].filter(frame => {
        if (!frame.url || !frameUrlSet.has(frame.url)) {
            frameUrlSet.add(frame.url);
            return true;
        }
        return false;
    });

    allFrames.forEach(frame => {
        const item = createFrameItem(frame, previewAvatarUrl);
        if (currentFrameUrl === frame.url) {
            item.classList.add('selected');
            currentFrameSelection.url = frame.url;
        }
        grid.appendChild(item);
    });

    document.getElementById('avatar-frame-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªå¤´åƒæ¡†é€‰é¡¹
function createFrameItem(frame, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.title = frame.name;
    item.innerHTML = `
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame" style="pointer-events: none;">` : ''}
    `;
    item.addEventListener('click', () => {
        document.querySelectorAll('#avatar-frame-grid .frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
        currentFrameSelection.url = frame.url;
    });
    return item;
}

// ä¿å­˜é€‰æ‹©
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ saveSelectedFrames å‡½æ•° â–¼â–¼â–¼
async function saveSelectedFrames() {
    const { type, url, target } = currentFrameSelection;

    // å¯¹äºä¸å±äºâ€œè§’è‰²è®¾ç½®â€çš„åŠŸèƒ½ (æ¯”å¦‚ä¸»å±å¹•ã€å¾®åš)ï¼Œä¿æŒåŸæœ‰çš„ç«‹å³ä¿å­˜é€»è¾‘
    if (type === 'char-weibo') { 
        const charChat = state.chats[currentViewingWeiboProfileId];
        if (charChat) {
            charChat.settings.weiboAvatarFrame = url;
            await db.chats.put(charChat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    } 
    else if (type === 'home_profile') {
        if (!state.globalSettings) state.globalSettings = {};
        state.globalSettings.homeAvatarFrame = url;
        await db.globalSettings.put(state.globalSettings);
        renderHomeScreenProfileFrame(); 
    } 
    else if (type === 'weibo_profile') {
        if (!state.qzoneSettings) state.qzoneSettings = {};
        state.qzoneSettings.weiboAvatarFrame = url;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¯¹äºâ€œè§’è‰²è®¾ç½®â€é‡Œçš„å¤´åƒæ¡†ï¼Œæˆ‘ä»¬ä¸å†ç«‹å³ä¿å­˜ï¼Œåªåœ¨å†…å­˜ä¸­æ›´æ–°
    else {
        const chat = state.chats[state.activeChatId];
        if (!chat) return; // å®‰å…¨æ£€æŸ¥

        if (type === 'ai') {
            chat.settings.aiAvatarFrame = url;
        } else if (type === 'my') {
            chat.settings.myAvatarFrame = url;
        } else if (type === 'member' && target) {
            const member = chat.members.find(m => m.id === target);
            if (member) member.avatarFrame = url;
        }
        
        // â˜…â˜…â˜… ä¿®å¤å…³é”® â˜…â˜…â˜…
        // æˆ‘ä»¬åˆ é™¤äº†è¿™é‡Œæ‰€æœ‰çš„ await db.chats.put(chat);
        // æ•°æ®å°†åœ¨ç”¨æˆ·ç‚¹å‡»è§’è‰²è®¾ç½®ä¸»é¢æ¿çš„â€œä¿å­˜â€æŒ‰é’®æ—¶ï¼Œä¸å…¶ä»–æ‰€æœ‰è®¾ç½®ä¸€èµ·è¢«ä¿å­˜ã€‚
        console.log(`å¤´åƒæ¡†é€‰æ‹©å·²æš‚å­˜: type=${type}, url=${url}`);
    }
    
    // åªéœ€å…³é—­å¤´åƒæ¡†é€‰æ‹©å¼¹çª—å³å¯ï¼Œä¸åšå…¶ä»–å¤šä½™æ“ä½œ
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // â˜…â˜…â˜… ä¿®å¤å…³é”® â˜…â˜…â˜…
    // æˆ‘ä»¬åˆ é™¤äº†ä¸‹é¢è¿™ä¸ªä¼šå¯¼è‡´ç•Œé¢æ„å¤–åˆ·æ–°å¹¶æ¸…ç©ºæœªä¿å­˜å†…å®¹çš„ if ä»£ç å—
    // if (type !== 'weibo_profile' && type !== 'home_profile' && type !== 'char-weibo') { ... }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * æ£€æŸ¥ä¸¤ä¸ªæ—¶é—´æˆ³æ˜¯å¦åœ¨ä¸åŒçš„è‡ªç„¶æ—¥
 * @param {number} timestamp1 - æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {number | null} timestamp2 - ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @returns {boolean} - å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œè¿”å› true
 */
function isNewDay(timestamp1, timestamp2) {
    // å¦‚æœæ²¡æœ‰ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œè‚¯å®šè¦æ˜¾ç¤ºæ—¥æœŸ
    if (!timestamp2) return true;

    const date1 = new Date(timestamp1);
    const date2 = new Date(timestamp2);

    // æ¯”è¾ƒå¹´ã€æœˆã€æ—¥æ˜¯å¦å®Œå…¨ç›¸åŒ
    return date1.getFullYear() !== date2.getFullYear() ||
           date1.getMonth()    !== date2.getMonth()    ||
           date1.getDate()     !== date2.getDate();
}

/**
 * å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸º "XæœˆXæ—¥ HH:mm" çš„å½¢å¼
 * @param {number} timestamp - æ—¶é—´æˆ³
 * @returns {string} - æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
 */
function formatDateStamp(timestamp) {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®æ—¶é—´æˆ³ï¼Œæ ¼å¼åŒ–èŠå¤©åˆ—è¡¨å³ä¾§çš„æ—¥æœŸ/æ—¶é—´æ˜¾ç¤º
 * @param {number} timestamp - æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @returns {string} - æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸² (ä¾‹å¦‚ "14:30", "æ˜¨å¤©", "08/03")
 */
function formatChatListTimestamp(timestamp) {
    if (!timestamp) return ''; // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²

    const now = new Date();
    const msgDate = new Date(timestamp);

    // åˆ¤æ–­æ˜¯å¦ä¸ºä»Šå¤©
    const isToday = now.getFullYear() === msgDate.getFullYear() &&
                    now.getMonth() === msgDate.getMonth() &&
                    now.getDate() === msgDate.getDate();

    if (isToday) {
        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
        return msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºæ˜¨å¤©
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    const isYesterday = yesterday.getFullYear() === msgDate.getFullYear() &&
                        yesterday.getMonth() === msgDate.getMonth() &&
                        yesterday.getDate() === msgDate.getDate();

    if (isYesterday) {
        return 'æ˜¨å¤©';
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºä»Šå¹´
    if (now.getFullYear() === msgDate.getFullYear()) {
        // å¦‚æœæ˜¯ä»Šå¹´ï¼Œæ˜¾ç¤º "æœˆ/æ—¥"
        const month = String(msgDate.getMonth() + 1).padStart(2, '0');
        const day = String(msgDate.getDate()).padStart(2, '0');
        return `${month}/${day}`;
    }

    // å¦‚æœæ˜¯æ›´æ—©çš„å¹´ä»½ï¼Œæ˜¾ç¤º "å¹´/æœˆ/æ—¥"
    const year = msgDate.getFullYear();
    const month = String(msgDate.getMonth() + 1).padStart(2, '0');
    const day = String(msgDate.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}

/**
 * ã€å…¨æ–°ã€‘åˆ›å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ—¥æœŸæˆ³â€œä¼ªæ¶ˆæ¯â€å…ƒç´ 
 * @param {number} timestamp - è¯¥æ—¥æœŸæˆ³ä»£è¡¨çš„æ—¶é—´
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„ DOM å…ƒç´ 
 */
function createDateStampElement(timestamp) {
    // 1. åˆ›å»ºæœ€å¤–å±‚çš„åŒ…è£¹ divï¼Œå’ŒçœŸå®æ¶ˆæ¯ä¸€æ ·
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper date-stamp-wrapper';
    // ã€æ ¸å¿ƒã€‘æŠŠæ—¶é—´æˆ³å­˜èµ·æ¥ï¼Œè¿™æ˜¯å¤šé€‰å’Œåˆ é™¤çš„å…³é”®
    wrapper.dataset.timestamp = timestamp; 

    // 2. åˆ›å»ºæ°”æ³¡ div
    const bubble = document.createElement('div');
    // ã€æ ¸å¿ƒã€‘åŒæ—¶åŠ ä¸Š .message-bubble ç±»ï¼Œè®©å¤šé€‰é€»è¾‘èƒ½æ‰¾åˆ°å®ƒ
    bubble.className = 'message-bubble date-stamp-bubble';
    bubble.dataset.timestamp = timestamp;
    bubble.textContent = formatDateStamp(timestamp);
    
    wrapper.appendChild(bubble);

    // 3. ã€æ ¸å¿ƒã€‘ä¸ºå®ƒç»‘å®šå’ŒçœŸå®æ¶ˆæ¯å®Œå…¨ä¸€æ ·çš„äº‹ä»¶ç›‘å¬å™¨
    addLongPressListener(wrapper, () => {
        // æ—¥æœŸæˆ³ä¸æ”¯æŒå¤æ‚æ“ä½œï¼Œé•¿æŒ‰ç›´æ¥è¿›å…¥å¤šé€‰
        enterSelectionMode(timestamp);
    });
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(timestamp);
        }
    });

    return wrapper;
}
// â–¼â–¼â–¼ åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// --- ç¾åŒ–åŠŸèƒ½çš„æ ¸å¿ƒå˜é‡ ---
let activeThemeId = null; // ç”¨äºè¿½è¸ªå½“å‰æ­£åœ¨ç¼–è¾‘çš„ä¸»é¢˜ID

/**
 * å°†CSSä»£ç åº”ç”¨åˆ°é¡µé¢ä¸Š
 * @param {string} cssCode - è¦åº”ç”¨çš„CSSä»£ç å­—ç¬¦ä¸²
 */
function applyThemeCss(cssCode) {
    const styleTag = document.getElementById('custom-theme-style');
    if (styleTag) {
        styleTag.innerHTML = cssCode || '';
    }
}

/**
 * ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ä¸»é¢˜åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
 */
async function loadThemesToDropdown() {
    const selector = document.getElementById('theme-selector');
    selector.innerHTML = '<option value="">-- é€‰æ‹©æ–¹æ¡ˆæˆ–æ–°å»º --</option>'; // é»˜è®¤é€‰é¡¹
    
    const themes = await db.themes.toArray();
    themes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme.id;
        option.textContent = theme.name;
        selector.appendChild(option);
    });
}

/**
 * å¤„ç†ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªä¸»é¢˜çš„é€»è¾‘
 */
async function handleThemeSelection() {
    const selector = document.getElementById('theme-selector');
    const editor = document.getElementById('theme-css-editor');
    activeThemeId = selector.value ? parseInt(selector.value) : null;
    
    if (activeThemeId) {
        const theme = await db.themes.get(activeThemeId);
        editor.value = theme.css;
    } else {
        // å¦‚æœé€‰æ‹©â€œ--â€ï¼Œå°±åŠ è½½æ¨¡æ¿
        editor.value = THEME_CSS_TEMPLATE;
    }
    // ç«‹å³åº”ç”¨é€‰ä¸­çš„æˆ–æ¨¡æ¿ä»£ç ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ•ˆæœ
    applyThemeCss(editor.value);
}

/**
 * ä¿å­˜å½“å‰ç¼–è¾‘åŒºçš„å†…å®¹åˆ°å½“å‰é€‰ä¸­çš„ä¸»é¢˜
 */
async function saveCurrentTheme() {
    if (!activeThemeId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–¹æ¡ˆï¼Œæˆ–ä½¿ç”¨â€œå¦å­˜ä¸ºâ€æ¥åˆ›å»ºæ–°æ–¹æ¡ˆã€‚");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    await db.themes.update(activeThemeId, { css: cssCode });
    alert("å½“å‰æ–¹æ¡ˆå·²ä¿å­˜ï¼");
}

/**
 * å°†å½“å‰ç¼–è¾‘åŒºçš„å†…å®¹å¦å­˜ä¸ºä¸€ä¸ªæ–°ä¸»é¢˜
 */
async function saveAsNewTheme() {
    const themeName = await showCustomPrompt("ä¿å­˜æ–°æ–¹æ¡ˆ", "è¯·è¾“å…¥æ–°æ–¹æ¡ˆçš„åç§°");
    if (!themeName || !themeName.trim()) {
        if(themeName !== null) alert("æ–¹æ¡ˆåç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    const newTheme = { name: themeName.trim(), css: cssCode };
    const newId = await db.themes.add(newTheme);
    
    // åˆ·æ–°ä¸‹æ‹‰æ¡†å¹¶è‡ªåŠ¨é€‰ä¸­æ–°ä¿å­˜çš„æ–¹æ¡ˆ
    await loadThemesToDropdown();
    document.getElementById('theme-selector').value = newId;
    activeThemeId = newId;
    
    alert(`æ–¹æ¡ˆ "${themeName}" å·²æˆåŠŸä¿å­˜ï¼`);
}

/**
 * é‡å‘½åå½“å‰é€‰ä¸­çš„ä¸»é¢˜
 */
async function renameSelectedTheme() {
    if (!activeThemeId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦é‡å‘½åçš„æ–¹æ¡ˆã€‚");
        return;
    }
    const currentTheme = await db.themes.get(activeThemeId);
    const newName = await showCustomPrompt("é‡å‘½åæ–¹æ¡ˆ", "è¯·è¾“å…¥æ–°çš„åç§°", currentTheme.name);
    if (newName && newName.trim()) {
        await db.themes.update(activeThemeId, { name: newName.trim() });
        await loadThemesToDropdown();
        document.getElementById('theme-selector').value = activeThemeId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆ é™¤å½“å‰é€‰ä¸­çš„ä¸»é¢˜
 */
async function deleteSelectedTheme() {
    if (!activeThemeId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„æ–¹æ¡ˆã€‚");
        return;
    }
    const confirmed = await showCustomConfirm(
        "ç¡®è®¤åˆ é™¤", 
        `ç¡®å®šè¦åˆ é™¤æ–¹æ¡ˆ "${document.getElementById('theme-selector').selectedOptions[0].textContent}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.themes.delete(activeThemeId);
        activeThemeId = null;
        await loadThemesToDropdown();
        // æ¢å¤åˆ°æ¨¡æ¿çŠ¶æ€
        document.getElementById('theme-css-editor').value = THEME_CSS_TEMPLATE;
        applyThemeCss(THEME_CSS_TEMPLATE);
        alert("æ–¹æ¡ˆå·²åˆ é™¤ã€‚");
    }
}

/**
 * å¯¼å‡ºå½“å‰é€‰ä¸­çš„ä¸»é¢˜ä¸ºä¸€ä¸ªJSONæ–‡ä»¶
 */
async function exportTheme() {
    if (!activeThemeId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„æ–¹æ¡ˆã€‚");
        return;
    }
    const theme = await db.themes.get(activeThemeId);
    const exportData = {
        themeName: theme.name,
        themeCss: theme.css
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${theme.name}-Theme.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * å¯¼å…¥ä¸€ä¸ªä¸»é¢˜JSONæ–‡ä»¶
 */
function importTheme(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.themeName && typeof data.themeCss !== 'undefined') {
                // ä¸ºäº†é¿å…é‡åï¼Œå¯¼å…¥æ—¶å¯ä»¥åœ¨åå­—åé¢åŠ ä¸ª "(å¯¼å…¥)"
                const newTheme = {
                    name: `${data.themeName} (å¯¼å…¥)`,
                    css: data.themeCss
                };
                const newId = await db.themes.add(newTheme);
                await loadThemesToDropdown();
                document.getElementById('theme-selector').value = newId;
                handleThemeSelection(); // å¯¼å…¥åè‡ªåŠ¨é€‰ä¸­å¹¶åº”ç”¨
                alert(`æ–¹æ¡ˆ "${newTheme.name}" å¯¼å…¥æˆåŠŸï¼`);
            } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch (error) {
            alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚ ${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ¸²æŸ“å¹¶å¡«å……APIé¢„è®¾çš„ä¸‹æ‹‰é€‰æ‹©æ¡†
 */
function renderApiPresetSelector() {
    const selectEl = document.getElementById('api-preset-select');
    if (!selectEl) return;

    selectEl.innerHTML = '<option value="">-- è‡ªå®šä¹‰é…ç½® --</option>';

    if (state.apiPresets) {
        state.apiPresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // æ£€æŸ¥å½“å‰é…ç½®æ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªé¢„è®¾
    const { proxyUrl, apiKey } = state.apiConfig;
    const matchingPreset = state.apiPresets ? state.apiPresets.find(p => p.proxyUrl === proxyUrl && p.apiKey === apiKey) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é¢„è®¾ï¼Œåˆ™é€‰ä¸­â€œè‡ªå®šä¹‰é…ç½®â€
    }
}

/**
 * å½“ç”¨æˆ·åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
 */
function handleApiPresetSelectChange() {
    const selectEl = document.getElementById('api-preset-select');
    const proxyUrlInput = document.getElementById('proxy-url');
    const apiKeyInput = document.getElementById('api-key');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.apiPresets) {
        const selectedPreset = state.apiPresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            proxyUrlInput.value = selectedPreset.proxyUrl;
            apiKeyInput.value = selectedPreset.apiKey;
        }
    }
}

/**
 * æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
 */
async function openApiPresetManager() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.apiPresets ? state.apiPresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal');
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new">ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°é¢„è®¾</button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}>æ›´æ–°å½“å‰é…ç½®</button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}>åˆ é™¤å½“å‰é…ç½®</button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
    `;

    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentApiConfigAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedApiPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedApiPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * å°†å½“å‰è¾“å…¥æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
 */
async function saveCurrentApiConfigAsPreset() {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('ä»£ç†åœ°å€å’Œå¯†é’¥éƒ½ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    const name = await showCustomPrompt('ä¿å­˜APIé¢„è®¾', 'è¯·ä¸ºè¿™ä¸ªé…ç½®èµ·ä¸ªåå­—ï¼š');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), proxyUrl, apiKey };
        const newId = await db.apiPresets.add(newPreset);
        
        if (!state.apiPresets) state.apiPresets = [];
        state.apiPresets.push({ id: newId, ...newPreset });

        renderApiPresetSelector(); 
        document.getElementById('api-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `APIé¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function updateSelectedApiPreset(presetId) {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('ä»£ç†åœ°å€å’Œå¯†é’¥éƒ½ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        preset.proxyUrl = proxyUrl;
        preset.apiKey = apiKey;
        await db.apiPresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é¢„è®¾ "${preset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * åˆ é™¤å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function deleteSelectedApiPreset(presetId) {
    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤APIé¢„è®¾ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.apiPresets.delete(presetId);
            state.apiPresets = state.apiPresets.filter(p => p.id !== presetId);

            renderApiPresetSelector();
            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('æˆåŠŸ', 'é¢„è®¾å·²åˆ é™¤ã€‚');
        }
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡æ ·å¼é¢„è®¾åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ¸²æŸ“å¹¶å¡«å……æ°”æ³¡æ ·å¼é¢„è®¾çš„ä¸‹æ‹‰é€‰æ‹©æ¡†
 */
function renderBubblePresetSelector() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');

    selectEl.innerHTML = '<option value="">-- æ— é¢„è®¾ --</option>';

    if (state.bubbleStylePresets) {
        state.bubbleStylePresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // æ£€æŸ¥å½“å‰èŠå¤©çš„CSSæ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªé¢„è®¾
    const currentCss = customCssInput.value.trim();
    const matchingPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.css.trim() === currentCss) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é¢„è®¾ï¼Œåˆ™é€‰ä¸­â€œæ— é¢„è®¾â€
    }
}

/**
 * å½“ç”¨æˆ·åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
 */
function handlePresetSelectChange() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.bubbleStylePresets) {
        const selectedPreset = state.bubbleStylePresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            customCssInput.value = selectedPreset.css;
        }
    }
    updateSettingsPreview(); // æ— è®ºå¦‚ä½•éƒ½æ›´æ–°é¢„è§ˆ
}

/**
 * æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
 */
async function openBubblePresetManager() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal'); // å¤ç”¨ç°æœ‰æ¨¡æ€æ¡†
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new">ä¿å­˜</button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}>æ›´æ–°</button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}>åˆ é™¤</button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
    `;

    // é‡æ–°ç»‘å®šäº‹ä»¶
    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentCssAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * å°†å½“å‰CSSæ–‡æœ¬æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
 */
async function saveCurrentCssAsPreset() {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();
    if (!css) {
        alert('CSSå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    const name = await showCustomPrompt('ä¿å­˜é¢„è®¾', 'è¯·ä¸ºè¿™ä¸ªæ°”æ³¡æ ·å¼å‘½åï¼š');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), css: css };
        const newId = await db.bubbleStylePresets.add(newPreset);
        
        if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
        state.bubbleStylePresets.push({ id: newId, ...newPreset });

        renderBubblePresetSelector(); 
        document.getElementById('bubble-style-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function updateSelectedPreset(presetId) {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();

    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        preset.css = css;
        await db.bubbleStylePresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('æˆåŠŸ', `é¢„è®¾ "${preset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * åˆ é™¤å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function deleteSelectedPreset(presetId) {
    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.bubbleStylePresets.delete(presetId);
            state.bubbleStylePresets = state.bubbleStylePresets.filter(p => p.id !== presetId);

            renderBubblePresetSelector(); 
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();

            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('æˆåŠŸ', 'é¢„è®¾å·²åˆ é™¤ã€‚');
        }
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µé“ƒå£°æ§åˆ¶å‡½æ•° â–¼â–¼â–¼

/**
 * æ’­æ”¾æ¥ç”µé“ƒå£°
 */
function playRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·åœ¨è®¾ç½®ä¸­ä¿å­˜çš„URLï¼Œå¦‚æœæ²¡è®¾ç½®ï¼Œå°±ç”¨æˆ‘ä»¬é¢„è®¾çš„URL
    const ringtoneUrl = state.globalSettings.ringtoneUrl || 'https://files.catbox.moe/3w7gla.mp3';
    
    if (ringtonePlayer && ringtoneUrl) {
        ringtonePlayer.src = ringtoneUrl;
        // play() è¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬æœ€å¥½ç”¨ try...catch åŒ…è£¹ä»¥é˜²æ­¢æµè§ˆå™¨æŠ¥é”™
        const playPromise = ringtonePlayer.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("é“ƒå£°æ’­æ”¾å¤±è´¥:", error);
                // å¯ä»¥åœ¨è¿™é‡Œç»™ç”¨æˆ·ä¸€ä¸ªé™éŸ³æç¤ºï¼Œå¦‚æœéœ€è¦çš„è¯
            });
        }
    }
}

/**
 * åœæ­¢å¹¶é‡ç½®æ¥ç”µé“ƒå£°
 */
function stopRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    if (ringtonePlayer) {
        ringtonePlayer.pause();
        ringtonePlayer.currentTime = 0; // å°†æ’­æ”¾è¿›åº¦é‡ç½®åˆ°å¼€å¤´
    }
}


// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€ä¼˜åŒ–åã€‘çš„ä»£ç æ›¿æ¢ â–¼â–¼â–¼
/**
 * ã€ä¼˜åŒ–ç‰ˆã€‘æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³ï¼Œå¢åŠ å¥å£®æ€§
 */
function playNotificationSound() {
    const soundUrl = state.globalSettings.notificationSoundUrl || 'https://laddy-lulu.github.io/Ephone-stuffs/message.mp3';
    
    // 1. å¢åŠ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœé“¾æ¥ä¸ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    if (!soundUrl || !soundUrl.trim()) return;

    try {
        const audio = new Audio(soundUrl);
        audio.volume = 0.7; 
        
        audio.play().catch(error => {
            // 2. ä¼˜åŒ–é”™è¯¯æç¤ºï¼Œç°åœ¨èƒ½æ›´å‡†ç¡®åœ°åæ˜ é—®é¢˜
            if (error.name === 'NotAllowedError') {
                console.warn("æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±è´¥ï¼šç”¨æˆ·éœ€è¦å…ˆä¸é¡µé¢è¿›è¡Œä¸€æ¬¡äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰æ‰èƒ½è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ã€‚");
            } else {
                // å¯¹äºå…¶ä»–é”™è¯¯ï¼ˆæ¯”å¦‚æˆ‘ä»¬è¿™æ¬¡é‡åˆ°çš„ï¼‰ï¼Œç›´æ¥æ‰“å°é”™è¯¯è¯¦æƒ…
                console.error(`æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±è´¥ (${error.name}): ${error.message}`, "URL:", soundUrl);
            }
        });
    } catch (error) {
        console.error("åˆ›å»ºæç¤ºéŸ³Audioå¯¹è±¡æ—¶å‡ºé”™:", error);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŸ³é¢‘ä¸Šä¸‹æ–‡è§£é”å‡½æ•°ï¼ˆä¿®å¤é“ƒå£°æ— æ³•è‡ªåŠ¨æ’­æ”¾çš„é—®é¢˜ï¼‰ â–¼â–¼â–¼
function unlockAudioContext() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // æ£€æŸ¥æ’­æ”¾å™¨æ˜¯å¦å¤„äºæš‚åœçŠ¶æ€ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æˆåŠŸæ’­æ”¾è¿‡
    if (ringtonePlayer && ringtonePlayer.paused) {
        // å°è¯•æ’­æ”¾ï¼Œç„¶åç«‹åˆ»æš‚åœã€‚
        // è¿™ä¸ªæ“ä½œå¯¹ç”¨æˆ·æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œä½†èƒ½å‘Šè¯‰æµè§ˆå™¨ç”¨æˆ·å·²ä¸éŸ³é¢‘äº¤äº’ã€‚
        ringtonePlayer.play().catch(() => {}); // play() ä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬å¿½ç•¥ä»»ä½•å¯èƒ½å‘ç”Ÿçš„é”™è¯¯
        ringtonePlayer.pause();
        console.log("Ringtone audio context unlocked.");
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
 * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // å¤„ç†åƒ bank.transactions è¿™æ ·çš„åµŒå¥—æ•°æ®
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
        }
        alert('è®°å½•å·²åˆ é™¤ã€‚');
    }
}
// â–²â–²â–² åˆ é™¤åŠŸèƒ½ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘å¤„ç†è§’è‰²æ‰‹æœºå†…å•æ¡èŠå¤©æ¶ˆæ¯çš„åˆ é™¤
 * @param {string} contactName - æ­£åœ¨æŸ¥çœ‹çš„è”ç³»äººåç§°
 * @param {number} index - è¦åˆ é™¤çš„æ¶ˆæ¯åœ¨å†å²è®°å½•ä¸­çš„ç´¢å¼•
 */
async function handleCharacterChatMessageDeletion(contactName, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    let historyArray;
    // åˆ¤æ–­æ˜¯å’Œâ€œæˆ‘â€çš„èŠå¤©è¿˜æ˜¯å’ŒNPCçš„èŠå¤©
    if (contactName === (chat.characterPhoneData.chats['æˆ‘']?.remarkName || 'æˆ‘')) {
        historyArray = chat.history;
    } else {
        historyArray = chat.characterPhoneData.chats[contactName]?.history;
    }

    if (!historyArray || !historyArray[index]) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        historyArray.splice(index, 1);
        await db.chats.put(chat);
        
        // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©ç•Œé¢
        renderCharacterChatHistory(contactName);
        alert('æ¶ˆæ¯å·²åˆ é™¤ã€‚');
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é”å±åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * åº”ç”¨é”å±å£çº¸åˆ° #lock-screen å…ƒç´ 
 */
function applyLockscreenWallpaper() {
    const lockScreen = document.getElementById('lock-screen');
    const wallpaper = state.globalSettings.lockscreenWallpaper;
    if (wallpaper && wallpaper.startsWith('data:image')) {
        lockScreen.style.backgroundImage = `url(${wallpaper})`;
    } else if (wallpaper) {
        lockScreen.style.backgroundImage = wallpaper;
    }
}

/**
 * æ˜¾ç¤ºé”å±ç•Œé¢
 */
function lockPhone() {
    console.log("æ­£åœ¨é”å®šæ‰‹æœº...");
    isLocked = true;
    document.getElementById('lock-screen').classList.add('active');
    document.querySelectorAll('.screen:not(#lock-screen)').forEach(s => s.classList.remove('active'));
}

/**
 * è§£é”æ‰‹æœºï¼Œæ˜¾ç¤ºä¸»å±å¹•
 */
function unlockPhone() {
    console.log("æ‰‹æœºå·²è§£é”ï¼");
    isLocked = false;
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œå½»åº•éšè—é”å±å’Œæ¯›ç»ç’ƒèƒŒæ™¯
    document.getElementById('lock-screen').classList.remove('active');
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.display = 'none';
    blurBg.style.opacity = '0';

    // ç¡®ä¿ä¸»å±å¹•æ˜¯å”¯ä¸€æ¿€æ´»çš„é¡¶å±‚å±å¹•
    showScreen('home-screen'); 

    // é‡ç½®é”å±çš„æ ·å¼ï¼Œä¸ºä¸‹æ¬¡é”å®šåšå‡†å¤‡
    setTimeout(() => {
        const lockScreen = document.getElementById('lock-screen');
        const unlockHint = document.getElementById('unlock-hint');
        lockScreen.style.transition = 'none'; 
        unlockHint.style.transition = 'none';
        lockScreen.style.transform = 'translateY(0)';
        lockScreen.offsetHeight; 
        lockScreen.style.transition = 'transform 0.3s ease-out';
        unlockHint.style.transition = 'opacity 0.3s ease-out';
    }, 500); 
}

/**
 * æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—
 */
function showPasswordModal() {
    const modal = document.getElementById('password-modal-overlay');
    const input = document.getElementById('password-input-field');
    input.value = ''; // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥
    modal.classList.add('visible');
    setTimeout(() => input.focus(), 100); // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿åŠ¨ç”»æµç•…
}

/**
 * éšè—å¯†ç è¾“å…¥å¼¹çª—
 */
function hidePasswordModal() {

document.getElementById('password-modal-overlay').style.backgroundImage = 'none';

    const modal = document.getElementById('password-modal-overlay');
    modal.classList.remove('visible');
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯åŠ¨ç”»ç±»
    modal.querySelector('.password-modal-content').classList.remove('error');
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å½“å–æ¶ˆè¾“å…¥å¯†ç æ—¶...
    // 1. éšè—æ¯›ç»ç’ƒèƒŒæ™¯
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.opacity = '0';
    setTimeout(() => { blurBg.style.display = 'none'; }, 300); // åŠ¨ç”»ç»“æŸåå†éšè—

    // 2. è®©é”å±ç•Œé¢æ»‘å›æ¥
    const lockScreen = document.getElementById('lock-screen');
    const unlockHint = document.getElementById('unlock-hint');
    lockScreen.style.transform = 'translateY(0)';
    unlockHint.style.opacity = '1';
}

/**
 * æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®
 */
function checkPassword() {
    const input = document.getElementById('password-input-field');
    const enteredPassword = input.value;
    const correctPassword = state.globalSettings.password;

    if (enteredPassword === correctPassword) {
        // --- å¯†ç æ­£ç¡® ---

        // 1. ã€æ ¸å¿ƒé­”æœ¯ã€‘æå‰æŠŠä¸»å±å¹•åœ¨æœ€åº•å±‚æ¿€æ´»å¹¶å‡†å¤‡å¥½ï¼
        //    å› ä¸ºå®ƒ z-index æœ€ä½ï¼Œæ‰€ä»¥ä½ æš‚æ—¶è¿˜çœ‹ä¸åˆ°å®ƒã€‚
        showScreen('home-screen');

        // 2. éšè—å¯†ç è¾“å…¥æ¡† (å®ƒä¼šè‡ªå·±æ’­æ”¾æ·¡å‡ºåŠ¨ç”»)
        document.getElementById('password-modal-overlay').classList.remove('visible');
        
        // 3. è®©æ¯›ç»ç’ƒèƒŒæ™¯ä¹Ÿå¼€å§‹æ·¡å‡º
        document.getElementById('lock-screen-background-blur').style.opacity = '0';
        
        // 4. ç­‰å¾…æ·¡å‡ºåŠ¨ç”»æ’­æ”¾å®Œæ¯• (300æ¯«ç§’)ï¼Œå†æ‰§è¡Œæœ€ç»ˆçš„æ¸…ç†å·¥ä½œ
        setTimeout(unlockPhone, 300);

    } else {
        // --- å¯†ç é”™è¯¯ (é€»è¾‘ä¿æŒä¸å˜) ---
        const content = document.querySelector('.password-modal-content');
        content.classList.add('error');
        input.value = '';
        setTimeout(() => content.classList.remove('error'), 400);
    }
}

/**
 * æ›´æ–°é”å±ç•Œé¢çš„æ—¶é’Ÿ
 */
function updateLockClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById('lock-main-time').textContent = timeString;
    document.getElementById('lock-main-date').textContent = dateString;
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

async function openBulkAddStickersModal() {
    const placeholder = `åœ¨è¿™é‡Œç²˜è´´è¡¨æƒ…åŒ…ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n\nçŒ«çŒ«å–æ°´ï¼šhttps://..../cat.gif\nç‹—ç‹—æ‘‡å¤´ï¼šhttps://..../dog.png\n\n(æ”¯æŒç”¨ä¸­æ–‡å†’å·â€œï¼šâ€ã€è‹±æ–‡å†’å·â€œ:â€æˆ–ç©ºæ ¼åˆ†éš”)`;

    const textInput = await showCustomPrompt(
        "æ‰¹é‡æ·»åŠ è¡¨æƒ…(URL)",
        "ä¸€è¡Œä¸€ä¸ªï¼Œåç§°å’Œé“¾æ¥ç”¨å†’å·æˆ–ç©ºæ ¼éš”å¼€",
        "",
        'textarea'
    );

    if (!textInput || !textInput.trim()) {
        return;
    }

    const lines = textInput.trim().split('\n');
    const newStickers = [];
    let successCount = 0;
    let errorLines = [];

    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;

        let name = '';
        let url = '';
        let splitIndex = -1;

        // --- æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ†å‰²é€»è¾‘ ---
        // 1. æŸ¥æ‰¾ URL çš„èµ·å§‹ä½ç½®
        const httpIndex = line.indexOf('http');
        const dataIndex = line.indexOf('data:image');

        if (httpIndex > -1) {
            splitIndex = httpIndex;
        } else if (dataIndex > -1) {
            splitIndex = dataIndex;
        }

        // 2. å¦‚æœæ‰¾åˆ°äº† URL çš„èµ·å§‹ä½ç½®
        if (splitIndex > 0) {
            // URL ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½å±äºåç§°
            name = line.substring(0, splitIndex).trim();
            // ä» URL èµ·å§‹ä½ç½®åˆ°æœ«å°¾çš„æ‰€æœ‰å†…å®¹éƒ½å±äº URL
            url = line.substring(splitIndex).trim();
            
            // 3. æ¸…ç†åç§°æœ«å°¾å¯èƒ½å­˜åœ¨çš„åˆ†éš”ç¬¦
            if (name.endsWith(':') || name.endsWith('ï¼š')) {
                name = name.slice(0, -1).trim();
            }

        } else {
            // å¦‚æœæ‰¾ä¸åˆ° URLï¼Œè¯´æ˜æ ¼å¼æœ‰é—®é¢˜
            errorLines.push(index + 1);
            return; // è·³è¿‡æ­¤è¡Œ
        }
        // --- ä¿®å¤ç»“æŸ ---

        if (name && (url.startsWith('http') || url.startsWith('data:image'))) {
            newStickers.push({
                id: 'sticker_' + (Date.now() + index),
                url: url,
                name: name
            });
            successCount++;
        } else {
            errorLines.push(index + 1);
        }
    });

    if (newStickers.length > 0) {
        await db.userStickers.bulkAdd(newStickers);
        state.userStickers.push(...newStickers);
        renderStickerPanel();
    }

    let reportMessage = `æ‰¹é‡å¯¼å…¥å®Œæˆï¼\n\næˆåŠŸå¯¼å…¥ï¼š${successCount} ä¸ªè¡¨æƒ…ã€‚`;
    if (errorLines.length > 0) {
        reportMessage += `\nå¤±è´¥è¡Œå·ï¼š${errorLines.join(', ')}ã€‚\n\nè¯·æ£€æŸ¥è¿™äº›è¡Œçš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`;
    }
    await showCustomAlert("å¯¼å…¥æŠ¥å‘Š", reportMessage);
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™ä¸¤ä¸ªæ–°å‡½æ•°åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®è·ç¦»æ–‡æœ¬ï¼Œè®¡ç®—CSSå®½åº¦ç™¾åˆ†æ¯”
 * @param {string} distanceText - è·ç¦»æè¿°ï¼Œä¾‹å¦‚ "500m", "10km", "å¾ˆè¿‘"
 * @returns {number} - 10åˆ°90ä¹‹é—´çš„ç™¾åˆ†æ¯”
 */
function calculatePinDistancePercentage(distanceText) {
    if (!distanceText) return 50; // é»˜è®¤å€¼

    const text = distanceText.toLowerCase();
    // æå–æ•°å­—éƒ¨åˆ†
    const matches = text.match(/(\d+(\.\d+)?)/);
    const num = matches ? parseFloat(matches[1]) : 0;

    // æ ¹æ®å•ä½æˆ–å…³é”®è¯åˆ¤æ–­
    if (text.includes('km') || text.includes('å…¬é‡Œ')) {
        if (num > 1000) return 90;
        if (num > 100) return 80;
        if (num > 10) return 70;
        if (num > 1) return 60;
        return 50;
    } else if (text.includes('m') || text.includes('ç±³')) {
        if (num > 500) return 40;
        if (num > 100) return 30;
        return 20;
    } else if (text.includes('è¿œ') || text.includes('ä¸åŒåŸå¸‚')) {
        return 90;
    } else if (text.includes('é™„è¿‘') || text.includes('éš”å£')) {
        return 20;
    } else if (text.includes('è¿‘')) {
        return 30;
    }
    
    return 15; // å¦‚æœæ— æ³•è¯†åˆ«ï¼Œç»™ä¸€ä¸ªæœ€å°çš„è·ç¦»
}


// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å…¨æ–°ä»£ç ã€‘ï¼Œæ›¿æ¢æ—§çš„ sendUserLocation å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åœ¨å®šä½æ¨¡æ€æ¡†ä¸­æ·»åŠ ä¸€ä¸ªé€”ç»ç‚¹è¾“å…¥æ¡†
 */
function addTrajectoryPointInput(name = '') {
    const container = document.getElementById('trajectory-points-container');
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '8px';
    div.innerHTML = `
        <input type="text" class="trajectory-point-input" placeholder="é€”ç»ç‚¹${container.children.length + 1}" value="${name}" style="flex-grow: 1;">
        <button class="remove-option-btn">-</button>
    `;
    div.querySelector('.remove-option-btn').addEventListener('click', () => div.remove());
    container.appendChild(div);
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ sendUserLocation å‡½æ•° â–¼â–¼â–¼

async function sendUserLocation() {
    if (!state.activeChatId) return;

    const userLocation = document.getElementById('user-location-input').value.trim();
    const aiLocation = document.getElementById('ai-location-input').value.trim();
    const distance = document.getElementById('distance-input').value.trim();

    if (!distance || (!userLocation && !aiLocation)) {
        alert("â€œæˆ‘çš„ä½ç½®â€å’Œâ€œTaçš„ä½ç½®â€è‡³å°‘è¦å¡«å†™ä¸€ä¸ªï¼Œä¸”â€œç›¸è·â€ä¸ºå¿…å¡«é¡¹ï¼");
        return;
    }

    const trajectoryPoints = Array.from(document.querySelectorAll('.trajectory-point-input'))
        .map(input => ({ name: input.value.trim() }))
        .filter(point => point.name);

    const chat = state.chats[state.activeChatId];
    
    // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ã€‘â–¼â–¼â–¼ ---

    // 1. æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œæ„å»ºä¸€æ¡AIèƒ½çœ‹æ‡‚çš„æ–‡æœ¬å†…å®¹
    //    è¿™ä¸ªæ ¼å¼å’ŒAIè‡ªå·±å‘å®šä½æ—¶ç”¨çš„æ ¼å¼ä¿æŒä¸€è‡´ï¼Œéå¸¸å®Œç¾ï¼
    let contentString = '[SEND_LOCATION]';
    if (userLocation) contentString += ` æˆ‘çš„ä½ç½®: ${userLocation}`;
    if (aiLocation) contentString += ` | ä½ çš„ä½ç½®: ${aiLocation}`;
    contentString += ` | ç›¸è·: ${distance}`;
    if (trajectoryPoints.length > 0) {
        const trajectoryText = trajectoryPoints.map(p => p.name).join(', ');
        contentString += ` | é€”ç»ç‚¹: ${trajectoryText}`;
    }

    // 2. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠåˆšåˆšåˆ›å»ºçš„ contentString ä¹Ÿæ”¾äº†è¿›å»
    const locationMessage = {
        role: 'user',
        type: 'location',
        timestamp: Date.now(),
        userLocation: userLocation,
        aiLocation: aiLocation,
        distance: distance,
        trajectoryPoints: trajectoryPoints,
        content: contentString // <-- è¿™å°±æ˜¯æœ€å…³é”®çš„æ–°å¢å±æ€§ï¼
    };
    
    // --- â–²â–²â–²ã€æ ¸å¿ƒä¿®æ”¹ç»“æŸã€‘â–²â–²â–² ---

    // åç»­çš„ä¿å­˜å’Œæ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
    chat.history.push(locationMessage);
    await db.chats.put(chat);
    appendMessage(locationMessage, chat);
    renderChatList();

    document.getElementById('send-location-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œä¸€é”®é‡rollâ€åŠŸèƒ½æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

/**
 * æ™ºèƒ½æŸ¥æ‰¾AIä¸Šä¸€è½®å›å¤çš„æ‰€æœ‰æ¶ˆæ¯
 * @param {Array} history - å®Œæ•´çš„èŠå¤©å†å²è®°å½•
 * @returns {Array} - ä¸€ä¸ªåŒ…å«äº†ä¸Šä¸€è½®AIæ‰€æœ‰æ¶ˆæ¯å¯¹è±¡çš„æ•°ç»„
 */
function findLastAiTurnMessages(history) {
    const turnMessages = [];
    let lastMessageIndex = history.length - 1;

    // ä»æœ€åä¸€æ¡æ¶ˆæ¯å¼€å§‹ï¼Œå‘å‰æŸ¥æ‰¾
    for (let i = lastMessageIndex; i >= 0; i--) {
        const message = history[i];
        
        // å¦‚æœæ˜¯AIçš„æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒåŠ å…¥æˆ‘ä»¬çš„â€œå¾…åˆ é™¤åˆ—è¡¨â€
        if (message.role === 'assistant') {
            turnMessages.unshift(message); // ä½¿ç”¨ unshift ä¿æŒåŸå§‹é¡ºåº
        } 
        // ä¸€æ—¦é‡åˆ°éAIçš„æ¶ˆæ¯ï¼ˆç”¨æˆ·çš„æˆ–ç³»ç»Ÿçš„ï¼‰ï¼Œè¯´æ˜AIçš„è¿™ä¸€è½®å›å¤å·²ç»ç»“æŸäº†ï¼Œç«‹åˆ»åœæ­¢æŸ¥æ‰¾
        else {
            break;
        }
    }
    return turnMessages;
}

/**
 * â€œé‡rollâ€æŒ‰é’®è¢«ç‚¹å‡»æ—¶çš„ä¸»å¤„ç†å‡½æ•°
 */
async function handleRerollClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    // 1. è°ƒç”¨æˆ‘ä»¬çš„æ™ºèƒ½æŸ¥æ‰¾å‡½æ•°ï¼Œæ‰¾å‡ºéœ€è¦åˆ é™¤çš„æ¶ˆæ¯
    const messagesToReroll = findLastAiTurnMessages(chat.history);

    // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆæ¯”å¦‚æœ€åä¸€æ¡æ˜¯ç”¨æˆ·å‘çš„ï¼‰ï¼Œå°±æç¤ºå¹¶é€€å‡º
    if (messagesToReroll.length === 0) {
        alert("è¯·åœ¨AIå›å¤åä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
        return;
    }

    // 3. ä»èŠå¤©è®°å½•ä¸­è¿‡æ»¤æ‰è¿™äº›æ—§æ¶ˆæ¯
    const timestampsToReroll = new Set(messagesToReroll.map(m => m.timestamp));
    chat.history = chat.history.filter(msg => !timestampsToReroll.has(msg.timestamp));
    
    // 4. ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•åˆ°æ•°æ®åº“
    await db.chats.put(chat);

    // 5. åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œè®©æ—§æ¶ˆæ¯ç¬é—´æ¶ˆå¤±
    renderChatInterface(state.activeChatId);

    // 6. è§¦å‘ä¸€æ¬¡æ–°çš„AIå“åº”ï¼Œå°±åƒç”¨æˆ·ç‚¹å‡»äº†â€œç­‰å¾…å›å¤â€ä¸€æ ·
    triggerAiResponse();
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ç®€åŒ–ç‰ˆã€‘ç²˜è´´è¿™ä¸ªå®Œæ•´çš„æ‹–åŠ¨åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
function initDraggableLyricsBar() {
    const bar = document.getElementById('floating-lyrics-bar');
    const phoneScreen = document.getElementById('phone-screen');
    
    let isDragging = false;
    let offsetX, offsetY;

    const onDragStart = (e) => {
        // ã€é—®é¢˜2ä¿®å¤ã€‘æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æŒ‰é’®ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å¼€å§‹æ‹–åŠ¨
        if (e.target.closest('#lyrics-settings-btn') || e.target.closest('.close-btn')) {
            return;
        }

        isDragging = true;
        bar.classList.add('dragging');
        
        const rect = bar.getBoundingClientRect();
        const coords = getEventCoords(e);

        offsetX = coords.x - rect.left;
        offsetY = coords.y - rect.top;

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    };

    const onDragMove = (e) => {
        if (!isDragging) return;
        
        e.preventDefault();

        const phoneRect = phoneScreen.getBoundingClientRect();
        const coords = getEventCoords(e);

        let newLeft = coords.x - offsetX - phoneRect.left;
        let newTop = coords.y - offsetY - phoneRect.top;

        const maxLeft = phoneScreen.clientWidth - bar.offsetWidth;
        const maxTop = phoneScreen.clientHeight - bar.offsetHeight;

        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));
        
        // ã€é—®é¢˜1ä¿®å¤ã€‘åœ¨æ‹–åŠ¨æ—¶ï¼ŒåŒæ—¶è®¾ç½®left, topå¹¶æ¸…é™¤transform
        bar.style.left = `${newLeft}px`;
        bar.style.top = `${newTop}px`;
        bar.style.transform = 'none';
    };

    const onDragEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        bar.classList.remove('dragging');

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
    };

    bar.addEventListener('mousedown', onDragStart);
    bar.addEventListener('touchstart', onDragStart, { passive: true });
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™ä¸ªå®Œæ•´çš„å‡½æ•° â–¼â–¼â–¼
function applyLyricsSettings() {
    const bar = document.getElementById('floating-lyrics-bar');
    const toggleBtn = document.getElementById('toggle-lyrics-bar-btn');
    
    // åº”ç”¨æ ·å¼
    bar.style.fontSize = `${lyricsBarSettings.fontSize}px`;
    bar.style.color = lyricsBarSettings.fontColor;
    bar.style.backgroundColor = `rgba(0, 0, 0, ${lyricsBarSettings.bgOpacity / 100})`;

    // æ›´æ–°è®¾ç½®æ¨¡æ€æ¡†é‡Œçš„æ§ä»¶å€¼
    document.getElementById('lyrics-font-size-slider').value = lyricsBarSettings.fontSize;
    document.getElementById('lyrics-font-size-value').textContent = `${lyricsBarSettings.fontSize}px`;
    document.getElementById('lyrics-bg-opacity-slider').value = lyricsBarSettings.bgOpacity;
    document.getElementById('lyrics-bg-opacity-value').textContent = `${lyricsBarSettings.bgOpacity}%`;
    document.getElementById('lyrics-font-color-picker').value = lyricsBarSettings.fontColor;
    
    // ã€é—®é¢˜4éœ€è¦ã€‘æ›´æ–°æ’­æ”¾å™¨é‡Œçš„å¼€å…³æŒ‰é’®çŠ¶æ€
    if (toggleBtn) {
        toggleBtn.textContent = lyricsBarSettings.showOnClose ? 'æ‚¬æµ®' : 'éšè—';
        toggleBtn.style.opacity = lyricsBarSettings.showOnClose ? '1' : '0.5';
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ getCountdownContext å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘è·å–å¹¶æ ¼å¼åŒ–ã€ä¸å½“å‰èŠå¤©ç›¸å…³ã€‘çš„çº¦å®šï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸Šä¸‹æ–‡
 * @param {string} chatId - å½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
 * @returns {Promise<string>} æ ¼å¼åŒ–åçš„çº¦å®šä¿¡æ¯å­—ç¬¦ä¸²
 */
async function getCountdownContext(chatId) {
    // 1. ä»æ•°æ®åº“ä¸­æ‰¾å‡ºæ‰€æœ‰â€œçº¦å®šâ€ç±»å‹ï¼Œå¹¶ä¸”ç›®æ ‡æ—¥æœŸè¿˜æ²¡åˆ°çš„è®°å½•
    const activeCountdowns = await db.memories
        .where('type').equals('countdown')
        .filter(item => 
            item.targetDate > Date.now() &&
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
            // å®ƒç°åœ¨åªä¼šæŸ¥æ‰¾ä¸¤ç§çº¦å®šï¼š
            // 1. chatId å’Œå½“å‰èŠå¤©è§’è‰²IDåŒ¹é…çš„ (AIè‡ªå·±åˆ›å»ºçš„)
            // 2. chatId ä¸ºç©ºçš„ (ä½ ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·åˆ›å»ºçš„å…¨å±€çº¦å®š)
            (item.chatId === chatId || item.chatId === null)
        )
        .toArray();

    // å¦‚æœæ²¡æœ‰ä¸å½“å‰è§’è‰²ç›¸å…³çš„çº¦å®šï¼Œå°±å‘Šè¯‰AIâ€œç›®å‰æ²¡æœ‰â€
    if (activeCountdowns.length === 0) {
        return "\n- **è¿‘æœŸçº¦å®š**: ç›®å‰æ²¡æœ‰ç‰¹åˆ«çš„çº¦å®šã€‚";
    }

    // 2. åç»­çš„æ•´ç†æŠ¥å‘Šé€»è¾‘ä¿æŒä¸å˜
    let context = "\n# è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶ (é‡è¦å‚è€ƒä¿¡æ¯)\n";
    const now = Date.now();

    activeCountdowns.forEach(item => {
        const diff = item.targetDate - now;
        const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(diff / (1000 * 60 * 60));

        let timeText;
        if (diffDays > 1) {
            timeText = `è¿˜æœ‰ ${diffDays} å¤©`;
        } else if (diffHours > 0) {
            timeText = `è¿˜æœ‰ ${diffHours} å°æ—¶`;
        } else {
            timeText = "å°±æ˜¯ç°åœ¨ï¼";
        }
        
        context += `- **${item.description}**: ${timeText} (ç›®æ ‡: ${new Date(item.targetDate).toLocaleString()})\n`;
    });

    return context;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * å…¥å£ï¼šæ‰“å¼€è§’è‰²é€‰æ‹©ç•Œé¢
 */
async function openCharacterSelectionScreen() {
    await renderCharacterSelectionScreen();
    showScreen('character-selection-screen');
}

/**
 * æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨
 */
async function renderCharacterSelectionScreen() {
    const listEl = document.getElementById('character-selection-list');
    listEl.innerHTML = '';
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿˜æ²¡æœ‰å¯ä»¥æŸ¥çœ‹çš„è§’è‰²</p>';
        return;
    }

    characters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'character-select-item';
        item.dataset.chatId = char.id;
        item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" alt="${char.name}">
            <span class="name">${char.name}</span>
        `;
        listEl.appendChild(item);
    });
}
/**
 * ã€å…¨æ–°ã€‘å°†æŒ‡å®šçš„Appå†…å£çº¸åº”ç”¨åˆ°è§’è‰²æ‰‹æœºå±å¹•
 */
function applyCharPhoneAppWallpaper() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    const innerScreen = document.querySelector('.character-phone-inner-screen');
    if (!innerScreen || !chat) return;

    const appWallpaperUrl = chat.characterPhoneData.appWallpaper;

    if (appWallpaperUrl) {
        innerScreen.style.backgroundImage = `url(${appWallpaperUrl})`;
        innerScreen.classList.add('has-app-wallpaper');
    } else {
        innerScreen.style.backgroundImage = 'none';
        innerScreen.classList.remove('has-app-wallpaper');
    }
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†è§’è‰²æ‰‹æœºAppå†…å£çº¸çš„æ›´æ¢å’Œç§»é™¤
 * @param {string} newUrl - æ–°çš„å£çº¸URLï¼Œå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™è¡¨ç¤ºç§»é™¤
 */
async function handleCharPhoneAppWallpaperChange(newUrl) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;
    
    chat.characterPhoneData.appWallpaper = newUrl;
    await db.chats.put(chat);
    
    // ç«‹å³åº”ç”¨å£çº¸
    applyCharPhoneAppWallpaper();
    
    // åˆ·æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆ
    renderCharPhoneAppearanceScreen();
    
    alert(newUrl ? 'App å†…å£çº¸å·²æ›´æ–°ï¼' : 'App å†…å£çº¸å·²ç§»é™¤ï¼');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ å°ç»„ä»¶æ¸²æŸ“ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ openCharacterPhone å‡½æ•° â–¼â–¼â–¼
function openCharacterPhone(chatId) {
    activeCharacterPhoneId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return;

    document.getElementById('character-phone-owner-name').textContent = `${chat.name}çš„æ‰‹æœº`;
    
    const phoneHomeScreen = document.getElementById('character-phone-screen');
    const wallpaperUrl = chat.characterPhoneData.wallpaper;
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');

    if (wallpaperUrl) {
        phoneHomeScreen.style.backgroundImage = `url(${wallpaperUrl})`;
        phoneHomeScreen.style.backgroundColor = 'transparent';
        phoneHomeScreen.style.backgroundSize = 'cover';
        phoneHomeScreen.style.backgroundPosition = 'center';
    } else {
        phoneHomeScreen.style.backgroundImage = 'none';
        phoneHomeScreen.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';
    }
    
    // --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œæ¸²æŸ“å°ç»„ä»¶å›¾ç‰‡ â–¼â–¼â–¼ ---
    const widgets = chat.characterPhoneData.widgets || {};
    document.getElementById('char-phone-widget-img-1').src = widgets.widget1_url || '';
    document.getElementById('char-phone-widget-img-2').src = widgets.widget2_url || '';
    // --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

    renderCharacterAppGrid(); 

    showScreen('character-phone-container'); 
    showCharacterPhonePage('character-phone-screen');
    applyCharPhoneAppWallpaper();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ renderCharacterAppGrid å‡½æ•° â–¼â–¼â–¼
function renderCharacterAppGrid() {
    const gridEl = document.getElementById('character-app-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterPhoneId) return;

    const chat = state.chats[activeCharacterPhoneId];
    const customIcons = chat.characterPhoneData.appIcons || {};

    CHAR_PHONE_APPS.forEach(app => {
        const iconEl = document.createElement('div');
        iconEl.className = 'app-icon';

        const customIconUrl = customIcons[app.id];
        
        // --- æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ ---
        
        let iconBgStyle = 'display: flex; justify-content: center; align-items: center; padding: 12px;';
        let iconHtml;

        if (customIconUrl) {
            // å¦‚æœæœ‰è‡ªå®šä¹‰å›¾æ ‡URL...
            // 1. è¦†ç›–æ‰ .icon-bg çš„æ ·å¼ï¼Œç§»é™¤å†…è¾¹è·å’ŒèƒŒæ™¯è‰²
            iconBgStyle = 'padding: 0; background-color: transparent;';
            // 2. iconHtml ç›´æ¥å˜æˆä¸€ä¸ªå¸¦æœ‰åœ†è§’çš„å›¾ç‰‡
            iconHtml = `<img src="${customIconUrl}" style="width:100%; height:100%; object-fit:cover; border-radius: 18px;">`;
        } else {
            // å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„SVG
            iconHtml = app.svg;
        }

        // --- ä¿®æ”¹ç»“æŸ ---

        iconEl.innerHTML = `
            <div class="icon-bg" style="${iconBgStyle}">
                ${iconHtml}
            </div>
            <span class="label">${app.name}</span>
        `;
        
        // åç»­çš„äº‹ä»¶ç›‘å¬ä»£ç ä¿æŒä¸å˜
        iconEl.addEventListener('click', () => {
            if (app.id === 'appearance') {
                openCharPhoneAppearanceSettings();
            } else {
                switch(app.id) {
                    case 'chat': renderCharacterChatList(); break;
                    case 'cart': renderCharacterShoppingCart(); break;
                    case 'memos': renderCharacterMemos(); break;
                    case 'browser': renderCharacterBrowser(); break;
                    case 'album': renderCharacterPhotoAlbum(); break;
                    case 'bank': renderCharacterBank(); break;
                    case 'trajectory': renderCharacterTrajectory(); break;
                    case 'app_usage': renderCharacterAppUsage(); break;
                    case 'diary': renderCharacterDiary(); break;
                }
                showCharacterPhonePage(app.screen); 
            }
        });
        gridEl.appendChild(iconEl);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ã€æ•°é‡å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ generateCharacterPhoneDataSegment å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ã€ç»ˆæç¤¾äº¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ generateCharacterPhoneDataSegment å‡½æ•° â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ V4 - æ™ºèƒ½ä½™é¢ç‰ˆã€‘ä¸ºâ€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½å•ç‹¬ç”ŸæˆæŸä¸€é¡¹æ•°æ®çš„é€šç”¨å‡½æ•°
 * @param {string} dataType - è¦ç”Ÿæˆçš„æ•°æ®ç±»å‹ (ä¾‹å¦‚: 'diary', 'chats', 'shoppingCart')
 */
async function generateCharacterPhoneDataSegment(dataType) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // è¿™ä¸ªå¯¹è±¡å®šä¹‰äº†æ¯ç§æ•°æ®ç±»å‹çš„ã€é»˜è®¤ã€‘ç”ŸæˆæŒ‡ä»¤å’ŒJSONç»“æ„
    const dataTypeMap = {
        chats: {
            description: `2åˆ°5æ®µä½ ä¸ã€ä¸åŒçš„ã€‘NPCæœ‹å‹ä»¬çš„ã€å…¨æ–°çš„ã€æ¥ç»­ä¸Šæ–‡çš„ã€‘èŠå¤©è®°å½•ã€‚`,
            jsonStructure: `"chats": [\n    {\n      "contactName": "ã€NPCæœ‹å‹Açš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€è”ç³»äººåAã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."}\n      ]\n    },\n    {\n      "contactName": "ã€NPCæœ‹å‹Bçš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€è”ç³»äººåBã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."}\n      ]\n    }\n  ]`
        },
        shoppingCart: {
            description: "3åˆ°5ä»¶ä½ æœ€è¿‘åŠ å…¥è´­ç‰©è½¦çš„æ–°å•†å“ã€‚",
            jsonStructure: `"shoppingCart": [\n    {"name": "å•†å“å1", "price": 123.45, "store": "åº—é“ºå"},\n    {"name": "å•†å“å2", "price": 67.89, "store": "åº—é“ºå"}\n  ]`
        },
        memos: {
            description: "2åˆ°3ç¯‡ä½ æ–°å†™çš„ç®€çŸ­å¤‡å¿˜å½•ã€‚",
            jsonStructure: `"memos": [\n    {"title": "å¤‡å¿˜å½•æ ‡é¢˜1", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹1..."},\n    {"title": "å¤‡å¿˜å½•æ ‡é¢˜2", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹2..."}\n  ]`
        },
        browserHistory: {
            description: "2åˆ°3æ¡ä½ æœ€è¿‘çš„æµè§ˆå™¨æœç´¢è®°å½•æˆ–æµè§ˆçš„æ–‡ç« ã€‚",
            jsonStructure: `"browserHistory": [\n    {"query": "æœç´¢æ ‡é¢˜1", "result": "æ¨¡æ‹Ÿæ–‡ç« å†…å®¹1..."},\n    {"query": "æœç´¢æ ‡é¢˜2", "result": "æ¨¡æ‹Ÿæ–‡ç« å†…å®¹2..."}\n  ]`
        },
        photoAlbum: {
            description: "2åˆ°3å¼ ä½ â€œæ‹æ‘„â€çš„æ–°ç…§ç‰‡çš„æ–‡å­—æè¿°ï¼ˆç”¨äºæ–‡å­—ç”Ÿå›¾ï¼‰ã€‚",
            jsonStructure: `"photoAlbum": [\n    {"hiddenContent": "å¯¹æ–°ç…§ç‰‡ç”»é¢1çš„è¯¦ç»†æ–‡å­—æè¿°..."},\n    {"hiddenContent": "å¯¹æ–°ç…§ç‰‡ç”»é¢2çš„è¯¦ç»†æ–‡å­—æè¿°..."}\n  ]`
        },
        bank: {
            description: "3åˆ°5æ¡ä½ æœ€è¿‘çš„é“¶è¡Œäº¤æ˜“è®°å½•ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚",
            jsonStructure: `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"},\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 67.89, "description": "äº¤æ˜“æè¿°2"}\n    ]\n  }`
        },
        trajectory: {
            description: "2åˆ°3æ¡ä½ æœ€è¿‘çš„è¡ŒåŠ¨è½¨è¿¹è®°å½•ã€‚",
            jsonStructure: `"trajectory": [\n    {"time": "æ—¶é—´æ®µ1", "location": "åœ°ç‚¹1", "activity": "å¹²äº†ä»€ä¹ˆäº‹1"},\n    {"time": "æ—¶é—´æ®µ2", "location": "åœ°ç‚¹2", "activity": "å¹²äº†ä»€ä¹ˆäº‹2"}\n  ]`
        },
        appUsage: {
            description: "3åˆ°5æ¡ä½ æœ€è¿‘çš„åº”ç”¨ä½¿ç”¨è®°å½•ã€‚",
            jsonStructure: `"appUsage": [\n    {"appName": "åº”ç”¨å1", "duration": "ä½¿ç”¨æ—¶é•¿1"},\n    {"appName": "åº”ç”¨å2", "duration": "ä½¿ç”¨æ—¶é•¿2"}\n  ]`
        },
        diary: {
            description: `ä¸€ç¯‡å…¨æ–°çš„æ—¥è®°ã€‚`,
            jsonStructure: `"diary": [\n    {"timestamp": ${Date.now()}, "content": "ã€ç”¨Markdownè¯­æ³•å†™ä¸€ç¯‡ç¬¦åˆäººè®¾å’Œæƒ…æ™¯çš„æ–°æ—¥è®°ã€‘"}\n  ]`
        }
    };

    const dataTypeInfo = dataTypeMap[dataType];
    if (!dataTypeInfo) {
        console.error("è¯·æ±‚äº†æ— æ•ˆçš„æ•°æ®ç”Ÿæˆç±»å‹:", dataType);
        return;
    }

    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒé€»è¾‘ï¼ â˜…â˜…â˜…â˜…â˜…
    // åŠ¨æ€ä¿®æ”¹dataTypeInfoï¼Œä»¥é€‚åº”ä¸åŒæƒ…å†µ
    let finalDataTypeInfo = { ...dataTypeInfo }; 

    if (dataType === 'bank') {
        const hasExistingTransactions = chat.characterPhoneData?.bank?.transactions?.length > 0;
        
        if (!hasExistingTransactions) {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆï¼Œå°±ä¿®æ”¹æŒ‡ä»¤ï¼Œè¦æ±‚AIæä¾›åˆå§‹ä½™é¢
            finalDataTypeInfo.description = "ä¸€ä¸ªç¬¦åˆä½ äººè®¾çš„ã€åˆå§‹é“¶è¡Œä½™é¢ã€‘ï¼Œä»¥åŠ3åˆ°5æ¡åˆå§‹äº¤æ˜“è®°å½•ã€‚";
            finalDataTypeInfo.jsonStructure = `"bank": {\n    "balance": 12345.67,\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
        } else {
            // å¦‚æœæ˜¯åç»­ç”Ÿæˆï¼Œå°±å‘Šè¯‰AIå½“å‰ä½™é¢ï¼Œåªè¦æ±‚æ–°äº¤æ˜“
            const currentBalance = (chat.characterPhoneData.bank.balance || 0).toFixed(2);
            finalDataTypeInfo.description = `3åˆ°5æ¡ã€å…¨æ–°çš„ã€‘é“¶è¡Œäº¤æ˜“è®°å½•ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚ã€æç¤ºï¼šä½ å½“å‰çš„ä½™é¢æ˜¯ ${currentBalance} å…ƒï¼Œè¯·åœ¨æ­¤åŸºç¡€ä¸Šç”Ÿæˆåˆç†çš„äº¤æ˜“ã€‘`;
            // æ­¤æ—¶çš„JSONç»“æ„ä¸éœ€è¦balanceå­—æ®µ
            finalDataTypeInfo.jsonStructure = `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
        }
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        const persona = (chat.settings.aiPersona || '').substring(0, 4000);
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        
        const npcLibrary = chat.npcLibrary || [];
        let npcContext = '';
        if (npcLibrary.length > 0) {
            npcContext = '# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é¡»ä»ä¸­éšæœºé€‰æ‹©2-3ä½æœ‹å‹è¿›è¡Œå¯¹è¯)\n' +
                'è¿™äº›äººæ˜¯ä½ çš„å¥½æœ‹å‹ï¼Œä½ å’Œä»–ä»¬éå¸¸ç†Ÿæ‚‰ã€‚è¯·æ ¹æ®ä»–ä»¬çš„äººè®¾ï¼Œç”Ÿæˆç¬¦åˆä½ ä»¬å…³ç³»çš„ã€è‡ªç„¶çš„èŠå¤©è®°å½•ã€‚\n' +
                npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
        } else {
            npcContext = '# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨\n(ä½ å½“å‰æ²¡æœ‰ä¸“å±NPCï¼Œè¯·è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯)';
        }

        let npcChatHistoryContext = '';
        const existingNpcChats = Object.entries(chat.characterPhoneData.chats || {}).filter(([name, chatData]) => chatData.history && chatData.history.length > 0);
        if (existingNpcChats.length > 0) {
            npcChatHistoryContext += '\n\n# å·²æœ‰çš„èŠå¤©è®°å½•æ‘˜è¦ (è¯·åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¯¹è¯)\n';
            existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history.slice(-5).map(msg => `  - ${msg.sender}: ${msg.content}`).join('\n');
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å¯¹è¯:\n${recentMessages}\n`;
            });
        }
        
        // ä½¿ç”¨ä¿®æ”¹åçš„ finalDataTypeInfo æ¥æ„å»ºPrompt
        const prompt = `
# ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚è¯·æ ¹æ®ä½ çš„ä¿¡æ¯å’Œæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œã€åªç”Ÿæˆä¸€é¡¹ã€‘ä½ æ‰‹æœºä¸­çš„æ–°æ•°æ®ã€‚
å…·ä½“ä»»åŠ¡æ˜¯ï¼šç”Ÿæˆ${finalDataTypeInfo.description}

# ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§é“å¾‹ã€‘ã€‘ã€‘
ä½ ç”Ÿæˆçš„æ‰€æœ‰æ•°æ®ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡ŒåŠ¨è½¨è¿¹ï¼‰**å¿…é¡»**ä¸â€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒç»å¯¹ä¸€è‡´ã€‚
å½“ç”Ÿæˆ "bank" æ•°æ®æ—¶ï¼Œä½ çš„äº¤æ˜“è®°å½•ã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«ä¸ç”¨æˆ·("${userNickname}")çš„è½¬è´¦æˆ–æ”¶æ¬¾ã€‚æ‰€æœ‰äº¤æ˜“éƒ½åº”æ˜¯ä½ ä¸å…¶ä»–NPCæˆ–å•†å®¶çš„ã€‚
# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ã€‘ã€‘ã€‘
åœ¨ç”Ÿæˆ "chats" æ•°æ®æ—¶ï¼Œ**ç»å¯¹ä¸å…è®¸**è®©ç”¨æˆ·ï¼ˆ${userNickname}ï¼‰å‡ºç°åœ¨ä½ ä¸å…¶ä»–NPCçš„å¯¹è¯ä¸­ã€‚

// â–¼â–¼â–¼ æ‰¾åˆ°è¿™éƒ¨åˆ†ä»£ç  â–¼â–¼â–¼

# ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šå…³äºèŠå¤©è®°å½•ç”Ÿæˆã€‘ã€‘ã€‘
- ä½ æ­£åœ¨ç»­å†™è¿™æ®µå¯¹è¯ã€‚ä½ æä¾›çš„èŠå¤©è®°å½•æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘é‡å¤æˆ–æ”¹å†™å…¶ä¸­çš„ä»»ä½•å†…å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é¡»ä»ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¡ã€‘æ¶ˆæ¯å¼€å§‹ã€‚
- å¦‚æœâ€œä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨â€ä¸ä¸ºç©ºï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºåˆ—è¡¨ä¸­çš„ã€æ¯ä¸€ä¸ªNPCã€‘éƒ½ç”Ÿæˆä¸€æ®µä¸ä½ ï¼ˆ${chat.name}ï¼‰çš„å¯¹è¯ã€‚
- å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œä½ å¯ä»¥è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯ã€‚
- ä½ å¿…é¡»ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5æ¡æ¶ˆæ¯ã€‘çš„å¯¹è¯ã€‚
- å¯¹è¯å†…å®¹åº”è¯¥è‡ªç„¶æµç•…ï¼Œå¯ä»¥åŒ…å«è¿ç»­å‘è¨€ã€è¡¨æƒ…åŒ…å’Œè¡¨æƒ…ç¬¦å·ç­‰ï¼Œä»¥ä½“ç°çœŸå®æ„Ÿã€‚
- ä¸è¦åªç”Ÿæˆä¸€é—®ä¸€ç­”çš„æœºæ¢°å¼å¯¹è¯ã€‚
-   **ã€ã€ã€ç»å¯¹ç¦æ­¢é‡å¤é“å¾‹ã€‘ã€‘ã€‘**: ä½ ç”Ÿæˆçš„ "messages" æ•°ç»„ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«æˆ‘æä¾›ç»™ä½ çš„ä¸Šä¸‹æ–‡é‡Œçš„ä»»ä½•ä¸€æ¡æ¶ˆæ¯ã€‚ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¿…é¡»æ˜¯å¯¹è¯å†å²ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ã€ä¸‹ä¸€æ¡ã€‘ã€‚
# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè®¾: ${persona}
${worldBookContext}
# å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦
${recentHistory}
${npcContext}
${npcChatHistoryContext}

# JSONè¾“å‡ºæ ¼å¼ (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼ŒåªåŒ…å«ä½ è¢«è¦æ±‚çš„é‚£ä¸ªé”®)
{
  ${finalDataTypeInfo.jsonStructure}
}
`;
        
        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, [{role: 'user', content: prompt}], isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            let errorMsg = `APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`;
            throw new Error(errorMsg);
        }
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        const newData = JSON.parse(aiResponseContent);

        let phoneData = chat.characterPhoneData;
        phoneData.lastGenerated = Date.now();
        let updateSuccess = false;

        if (newData && newData[dataType]) {
            if (dataType === 'bank' && newData.bank.transactions) {
                 if(!phoneData.bank) phoneData.bank = { balance: 0, transactions: [] };
                 if (typeof phoneData.bank.balance !== 'number') phoneData.bank.balance = 0;
                (newData.bank.transactions || []).forEach(transaction => {
                    const amount = parseFloat(transaction.amount);
                    if (!isNaN(amount)) {
                        if (transaction.type === 'æ”¶å…¥') phoneData.bank.balance += amount;
                        else if (transaction.type === 'æ”¯å‡º') phoneData.bank.balance -= amount;
                    }
                });
                 phoneData.bank.transactions.push(...(newData.bank.transactions || []));
                 if (typeof newData.bank.balance === 'number') {
                     phoneData.bank.balance = newData.bank.balance;
                 }
                 updateSuccess = true;
            } else if (dataType === 'chats' && newData.chats) {
                 newData.chats.forEach(newChat => {
                    if (!newChat.messages) return;
                    const contactName = newChat.contactName;
                    if (phoneData.chats[contactName] && phoneData.chats[contactName].history) {
                        phoneData.chats[contactName].history.push(...newChat.messages);
                    } else {
                        phoneData.chats[contactName] = { 
                            avatar: newChat.avatar, 
                            history: newChat.messages 
                        };
                    }
                 });
                 updateSuccess = true;
            } else if (dataType === 'appUsage' && Array.isArray(newData.appUsage)) {
                const usageMap = new Map();
                (phoneData.appUsage || []).forEach(item => {
                    usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
                });
                newData.appUsage.forEach(item => {
                    usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
                });
                const mergedUsage = [];
                for (const [appName, totalMinutes] of usageMap.entries()) {
                    mergedUsage.push({ appName: appName, duration: formatMinutesToDuration(totalMinutes) });
                }
                phoneData.appUsage = mergedUsage;
                updateSuccess = true;
            } else if (Array.isArray(phoneData[dataType])) {
                phoneData[dataType].push(...(newData[dataType] || []));
                updateSuccess = true;
            }
        }
        
        if (!updateSuccess) {
            throw new Error(`AIè¿”å›çš„JSONä¸­ç¼ºå°‘'${dataType}'å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚`);
        }

        await db.chats.put(chat);
        alert(`â€œ${chat.name}â€çš„${dataTypeMap[dataType].description.split('ã€‚')[0]}å·²æ›´æ–°ï¼`);

        switch(dataType) {
            case 'chats': renderCharacterChatList(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'memos': renderCharacterMemos(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
            case 'bank': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'diary': renderCharacterDiary(); break;
        }

    } catch (error) {
        console.error(`ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ®(${dataType})å¤±è´¥:`, error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}

// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†â€œæŸ¥æ‰‹æœºâ€å„ä¸ªAPPé¡µé¢â€œå…¨éƒ¨åˆ é™¤â€åŠŸèƒ½çš„é€šç”¨å‡½æ•°
 * @param {string} dataType - è¦æ¸…ç©ºçš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ 'shoppingCart', 'memos', 'bank.transactions'
 */
async function handleClearCharacterDataSegment(dataType) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // ä¸ºä¸åŒæ•°æ®ç±»å‹è®¾ç½®æ›´äººæ€§åŒ–çš„æç¤ºæ–‡æœ¬
    const dataTypeMap = {
        chats: { name: 'NPCèŠå¤©è®°å½•', dataKey: 'chats' },
        shoppingCart: { name: 'è´­ç‰©è½¦', dataKey: 'shoppingCart' },
        memos: { name: 'å¤‡å¿˜å½•', dataKey: 'memos' },
        browserHistory: { name: 'æµè§ˆå™¨å†å²', dataKey: 'browserHistory' },
        photoAlbum: { name: 'ç›¸å†Œ', dataKey: 'photoAlbum' },
        'bank.transactions': { name: 'äº¤æ˜“è®°å½•', dataKey: 'bank' },
        trajectory: { name: 'è¶³è¿¹', dataKey: 'trajectory' },
        appUsage: { name: 'ä½¿ç”¨è®°å½•', dataKey: 'appUsage' },
        diary: { name: 'æ—¥è®°', dataKey: 'diary' }
    };

    const info = dataTypeMap[dataType];
    if (!info) {
        console.error("æœªçŸ¥çš„æ¸…ç©ºæ•°æ®ç±»å‹:", dataType);
        return;
    }

    // å¼¹å‡ºç¡®è®¤æ¡†
    const confirmed = await showCustomConfirm(
        `ç¡®è®¤æ¸…ç©º`,
        `ç¡®å®šè¦æ¸…ç©ºâ€œ${chat.name}â€æ‰‹æœºé‡Œçš„æ‰€æœ‰ã€${info.name}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        // ã€æ ¸å¿ƒåˆ é™¤é€»è¾‘ã€‘
        if (dataType === 'chats') {
            // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç©ºæ‰€æœ‰NPCèŠå¤©ï¼ˆä¸åŒ…æ‹¬å’Œuserçš„ï¼‰
            chat.characterPhoneData.chats = {};
        } else if (dataType === 'bank.transactions') {
            // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç©ºé“¶è¡Œäº¤æ˜“è®°å½•ï¼Œã€åŒæ—¶å°†ä½™é¢å½’é›¶ã€‘
            if (chat.characterPhoneData.bank) {
                chat.characterPhoneData.bank.transactions = [];
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œå°†ä½™é¢å½’é›¶ â˜…â˜…â˜…
                chat.characterPhoneData.bank.balance = 0; 
            }
        } else if (chat.characterPhoneData[info.dataKey]) {
            // é€šç”¨å¤„ç†ï¼šæ¸…ç©ºæ•°ç»„
            chat.characterPhoneData[info.dataKey] = [];
        }

        // ä¿å­˜åˆ°æ•°æ®åº“
        await db.chats.put(chat);

        // åˆ·æ–°å½“å‰é¡µé¢
        switch(dataType) {
            case 'chats': renderCharacterChatList(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'memos': renderCharacterMemos(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'diary': renderCharacterDiary(); break;
        }

        alert(`å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰${info.name}ã€‚`);
    } catch (error) {
        console.error(`æ¸…ç©º ${info.name} æ—¶å‡ºé”™:`, error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `æ¸…ç©ºæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å¢å¼ºç‰ˆä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ generateCharacterPhoneData å‡½æ•° â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒã€‘ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ® (å·²å¢åŠ é”™è¯¯å¤„ç†å’Œä¼˜åŒ–)
 */
async function generateCharacterPhoneData() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šã€é‡è¦ä¿®å¤ã€‘é™åˆ¶äººè®¾é•¿åº¦ï¼Œè¿™æ˜¯é˜²æ­¢503é”™è¯¯çš„æ ¹æœ¬æ–¹æ³•ï¼â–¼â–¼â–¼
        // æˆ‘ä»¬åªå–äººè®¾çš„å‰4000ä¸ªå­—ç¬¦ï¼Œé¿å…æ•´ä¸ªäººè®¾è¿‡é•¿å¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚
        const persona = (chat.settings.aiPersona || '').substring(0, 4000); 
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼Œå°†å‚è€ƒå†å²è®°å½•è°ƒæ•´ä¸º20æ¡ â–¼â–¼â–¼
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        const npcLibrary = chat.npcLibrary || [];
        let npcContext = '';
        if (npcLibrary.length > 0) {
            npcContext = '# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é¡»åœ¨ä¸‹æ–¹"chats"ä¸­ä¸ºä»–ä»¬ç”Ÿæˆå¯¹è¯)\n' +
                'è¿™äº›äººæ˜¯ä½ çš„å¥½æœ‹å‹ï¼Œä½ å’Œä»–ä»¬éå¸¸ç†Ÿæ‚‰ã€‚è¯·æ ¹æ®ä»–ä»¬çš„äººè®¾ï¼Œç”Ÿæˆç¬¦åˆä½ ä»¬å…³ç³»çš„ã€è‡ªç„¶çš„èŠå¤©è®°å½•ã€‚\n' +
                npcLibrary.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');
        } else {
            npcContext = '# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨\n(ä½ æ²¡æœ‰ä¸“å±NPCï¼Œè¯·è™šæ„ä¸€äº›æ™®é€šæœ‹å‹)';
        }

        let npcChatHistoryContext = '';
        const existingNpcChats = Object.entries(chat.characterPhoneData.chats || {}).filter(([name, chatData]) => chatData.history && chatData.history.length > 0);

        if (existingNpcChats.length > 0) {
            npcChatHistoryContext += '\n\n# å·²æœ‰çš„èŠå¤©è®°å½•æ‘˜è¦ (è¯·åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¯¹è¯)\n';
            existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history.slice(-5).map(msg => `  - ${msg.sender}: ${msg.content}`).join('\n');
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å¯¹è¯:\n${recentMessages}\n`;
            });
        }

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä¼˜åŒ–æç¤ºè¯ï¼Œè®©AIæ›´å¥½åœ°ç†è§£ä»»åŠ¡ï¼Œå¹¶å¼ºè°ƒæƒ…æ™¯ä¸€è‡´æ€§ â–¼â–¼â–¼
        const prompt = `
# ä»»åŠ¡
ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§é“å¾‹ã€‘ã€‘ã€‘ï¼šä½ ç”Ÿæˆçš„æ‰€æœ‰æ•°æ®ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡ŒåŠ¨è½¨è¿¹ï¼‰**å¿…é¡»**ä¸â€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒç»å¯¹ä¸€è‡´ã€‚å¦‚æœèŠå¤©è®°å½•æ˜¾ç¤ºä½ æ­£åœ¨ä¸Šè¯¾ï¼Œä½ çš„è¡ŒåŠ¨è½¨è¿¹å°±å¿…é¡»æ˜¯åœ¨æ•™å®¤ï¼›å¦‚æœèŠå¤©è®°å½•æ˜¾ç¤ºä½ åœ¨å’–å•¡é¦†ï¼Œä½ çš„è¡ŒåŠ¨è½¨è¿¹å°±å¿…é¡»æ˜¯å’–å•¡é¦†ã€‚**ç»å¯¹ä¸èƒ½**ä»…å‡­ä½ çš„äººè®¾å°±ç”Ÿæˆä¸èŠå¤©è®°å½•ç›¸çŸ›ç›¾çš„å†…å®¹ã€‚
ä½ ç°åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ã€ä¸–ç•Œè§‚ã€NPCå¥½å‹åˆ—è¡¨ä»¥åŠå’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•ï¼Œæ¨¡æ‹Ÿç”Ÿæˆä½ æ‰‹æœºä¸­çš„å„é¡¹æ•°æ®ã€‚ä½ éœ€è¦ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§ä¸‹é¢çš„JSONæ ¼å¼è¿”å›ã€‚

# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼šè¿™æ˜¯å¿…é¡»éµå®ˆçš„å®‰å…¨çº¢çº¿ã€‘ã€‘ã€‘
1.  åœ¨ç”ŸæˆJSONæ•°æ®ï¼Œç‰¹åˆ«æ˜¯chatså­—æ®µæ—¶ï¼Œ**ç»å¯¹ä¸å…è®¸**åˆ›å»ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆ${userNickname}ï¼‰çš„è™šæ‹Ÿå½¢è±¡æˆ–è®©ä»–/å¥¹å‡ºç°åœ¨ä½ ä¸å…¶ä»–NPCçš„å¯¹è¯ä¸­ã€‚
2.  "bank" å­—æ®µä¸­çš„äº¤æ˜“è®°å½•ã€ç»å¯¹ä¸èƒ½ã€‘æ¶‰åŠç”¨æˆ·("${userNickname}")ã€‚æ‰€æœ‰äº¤æ˜“éƒ½å¿…é¡»æ˜¯ä½ ä¸å…¶ä»–NPCã€å•†å®¶æˆ–å› æŸäº›äº‹ä»¶ï¼ˆå¦‚è´­ç‰©ã€æ”¶åˆ°å·¥èµ„ï¼‰äº§ç”Ÿçš„ã€‚
3.  chatså­—æ®µä¸­ï¼Œä¸NPCæˆ–æœ‹å‹çš„èŠå¤©è®°å½•ï¼Œå…¶senderæˆ–content**ç»å¯¹ä¸èƒ½**åŒ…å«${userNickname}çš„åå­—æˆ–ä»£ç§°ã€‚
4.  æ‰€æœ‰ä½ ç”Ÿæˆçš„èŠå¤©å¯¹è¯ï¼Œéƒ½å¿…é¡»ä¸¥æ ¼é™åˆ¶åœ¨ã€ä½ (${chat.name})ã€‘å’Œã€å¦ä¸€ä½NPC/æœ‹å‹ã€‘è¿™**ä¸¤ä¸ªäººä¹‹é—´**ã€‚**ä¸¥ç¦**å‡ºç°ä»»ä½•å½¢å¼çš„ç¬¬ä¸‰è€…ï¼Œå°¤å…¶æ˜¯${userNickname}ã€‚

# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè®¾: ${persona}
${worldBookContext}
# å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦
${recentHistory}

${npcContext}
${npcChatHistoryContext}
# JSONè¾“å‡ºæ ¼å¼ (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜)
{
  "chats": [
    {
      "contactName": "ã€è¿™é‡Œå¡«å†™ä½ ç»™${userNickname}çš„å¤‡æ³¨åã€‘"
    },
    {
      "contactName": "ã€è¿™é‡Œå¿…é¡»å¡«å†™ä¸Šé¢NPCåˆ—è¡¨ä¸­çš„ä¸€ä¸ªåå­—ï¼Œæˆ–ä¸€ä¸ªè™šæ„æœ‹å‹åã€‘",
      "messages": [
        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},
        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."},
        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹2..."},
        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹3..."},
        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤2..."}
      ]
    }
  ],
  "shoppingCart": [
    {"name": "å•†å“å", "price": ä»·æ ¼, "store": "åº—é“ºå"}
  ],
  "memos": [
    {"title": "å¤‡å¿˜å½•æ ‡é¢˜", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹..."}
  ],
  "browserHistory": [
    {"query": "æœç´¢æˆ–æµè§ˆçš„æ ‡é¢˜", "result": "ã€è¿™é‡Œæ˜¯AIç”Ÿæˆçš„ã€å…³äºè¿™ä¸ªæœç´¢æ ‡é¢˜çš„æ¨¡æ‹Ÿæ–‡ç« æˆ–ç½‘é¡µå†…å®¹ã€‘"}
  ],
  "photoAlbum": [
    {"hiddenContent": "å¯¹ç…§ç‰‡ç”»é¢çš„è¯¦ç»†æ–‡å­—æè¿°"}
  ],
  "bank": {
    "balance": é“¶è¡Œå¡ä½™é¢(æ•°å­—),
    "transactions": [
      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": é‡‘é¢, "description": "äº¤æ˜“æè¿°"}
    ]
  },
  "trajectory": [
    {"time": "æ—¶é—´æ®µ", "location": "åœ°ç‚¹", "activity": "å¹²äº†ä»€ä¹ˆäº‹"}
  ],
  "appUsage": [
    {"appName": "åº”ç”¨å", "duration": "ä½¿ç”¨æ—¶é•¿"}
  ],
  "diary": [
    {"timestamp": ${Date.now()}, "content": "ã€ä»Šå¤©æ˜¯${new Date().toLocaleString('zh-CN', { dateStyle: 'full' })}ï¼Œç”¨Markdownè¯­æ³•å†™ä¸€ç¯‡ç¬¦åˆäººè®¾å’Œä»Šå¤©æƒ…æ™¯çš„æ—¥è®°ã€‘"}
  ]
}

# ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šå…³äºèŠå¤©è®°å½•ç”Ÿæˆã€‘ã€‘ã€‘
- ä½ æ­£åœ¨ç»­å†™è¿™æ®µå¯¹è¯ã€‚ä½ æä¾›çš„èŠå¤©è®°å½•æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘é‡å¤æˆ–æ”¹å†™å…¶ä¸­çš„ä»»ä½•å†…å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é¡»ä»ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¡ã€‘æ¶ˆæ¯å¼€å§‹ã€‚
- ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆæœ¬æç¤ºè¯æœ€ä¸Šæ–¹çš„ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ã€‘ã€‚
- å¦‚æœâ€œä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨â€ä¸ä¸ºç©ºï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºåˆ—è¡¨ä¸­çš„ã€æ¯ä¸€ä¸ªNPCã€‘éƒ½ç”Ÿæˆä¸€æ®µä¸ä½ ï¼ˆ${chat.name}ï¼‰çš„å¯¹è¯ã€‚
- å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œä½ å¯ä»¥è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯ã€‚
- ä½ å¿…é¡»ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5æ¡æ¶ˆæ¯ã€‘çš„å¯¹è¯ã€‚
- å¯¹è¯å†…å®¹åº”è¯¥è‡ªç„¶æµç•…ï¼Œå¯ä»¥åŒ…å«è¿ç»­å‘è¨€ã€è¡¨æƒ…åŒ…å’Œè¡¨æƒ…ç¬¦å·ç­‰ï¼Œä»¥ä½“ç°çœŸå®æ„Ÿã€‚
- ä¸è¦åªç”Ÿæˆä¸€é—®ä¸€ç­”çš„æœºæ¢°å¼å¯¹è¯ã€‚
-   **ã€ã€ã€ç»å¯¹ç¦æ­¢é‡å¤é“å¾‹ã€‘ã€‘ã€‘**: ä½ ç”Ÿæˆçš„ "messages" æ•°ç»„ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«æˆ‘æä¾›ç»™ä½ çš„ä¸Šä¸‹æ–‡é‡Œçš„ä»»ä½•ä¸€æ¡æ¶ˆæ¯ã€‚ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¿…é¡»æ˜¯å¯¹è¯å†å²ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ã€ä¸‹ä¸€æ¡ã€‘ã€‚
`;
        // â–²â–²â–² æç¤ºè¯ä¼˜åŒ–ç»“æŸ â–²â–²â–²

        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, [{role: 'user', content: prompt}], isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            let errorMsg = `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg += `\né”™è¯¯ä¿¡æ¯: ${errorData.error.message}`;
            } catch (e) {
                errorMsg += `\næ— æ³•è§£æé”™è¯¯å“åº”ä½“ã€‚`;
            }
            throw new Error(errorMsg);
        }
        
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '');

        let newData;
        try {
            newData = JSON.parse(aiResponseContent);
        } catch (e) {
            throw new Error(`AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œæ— æ³•è§£æã€‚\nåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }

        let phoneData = chat.characterPhoneData;
        phoneData.lastGenerated = Date.now();
        
        if (newData.chats) {
            newData.chats.forEach(newChat => {
                if (!newChat.messages) {
                    const myNickname = userNickname || 'æˆ‘';
                    if (!phoneData.chats[myNickname]) {
                        phoneData.chats[myNickname] = { avatar: '', history: [] };
                    }
                    phoneData.chats[myNickname].remarkName = newChat.contactName;
                } else {
                    const contactName = newChat.contactName;
                    if (phoneData.chats[contactName] && phoneData.chats[contactName].history) {
                        console.log(`åˆå¹¶èŠå¤©è®°å½•: ä¸º "${contactName}" è¿½åŠ  ${newChat.messages.length} æ¡æ–°æ¶ˆæ¯ã€‚`);
                        phoneData.chats[contactName].history.push(...newChat.messages);
                    } else {
                        console.log(`åˆ›å»ºæ–°èŠå¤©: "${contactName}"`);
                        phoneData.chats[contactName] = { 
                            avatar: newChat.avatar, 
                            history: newChat.messages 
                        };
                    }
                }
            });
        }

        // æ­£ç¡®å¤„ç†å…¶ä»–æ•°ç»„ç±»å‹æ•°æ® (è¿™äº›æ˜¯æ²¡é—®é¢˜çš„ï¼Œä¿æŒåŸæ ·)
        if(!phoneData.shoppingCart) phoneData.shoppingCart = [];
        phoneData.shoppingCart.push(...(newData.shoppingCart || []));
        if(!phoneData.memos) phoneData.memos = [];
        phoneData.memos.push(...(newData.memos || []));
        if(!phoneData.browserHistory) phoneData.browserHistory = [];
        phoneData.browserHistory.push(...(newData.browserHistory || []));
        if(!phoneData.photoAlbum) phoneData.photoAlbum = [];
        phoneData.photoAlbum.push(...(newData.photoAlbum || []));
        if(!phoneData.trajectory) phoneData.trajectory = [];
        phoneData.trajectory.push(...(newData.trajectory || []));
        if (!phoneData.diary) phoneData.diary = [];
        phoneData.diary.push(...(newData.diary || []));

        // ã€ä¿®å¤1ï¼šå±å¹•ä½¿ç”¨æ—¶é—´ã€‘
        if (newData.appUsage && Array.isArray(newData.appUsage)) {
            const usageMap = new Map();
            // å…ˆåŠ è½½å·²æœ‰çš„ä½¿ç”¨è®°å½•
            (phoneData.appUsage || []).forEach(item => {
                usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
            });
            // å†ç´¯åŠ æ–°ç”Ÿæˆçš„ä½¿ç”¨è®°å½•
            newData.appUsage.forEach(item => {
                usageMap.set(item.appName, (usageMap.get(item.appName) || 0) + parseDurationToMinutes(item.duration));
            });
            // é‡æ–°ç”Ÿæˆåˆå¹¶åçš„åˆ—è¡¨
            const mergedUsage = [];
            for (const [appName, totalMinutes] of usageMap.entries()) {
                mergedUsage.push({ appName: appName, duration: formatMinutesToDuration(totalMinutes) });
            }
            phoneData.appUsage = mergedUsage;
        }

        // ã€ä¿®å¤2ï¼šé’±åŒ…ã€‘
        if (newData.bank) {
            if (!phoneData.bank) phoneData.bank = { balance: 0, transactions: [] };
            if (typeof phoneData.bank.balance !== 'number') phoneData.bank.balance = 0;

            // å¦‚æœAIè¿”å›äº†æ–°çš„æ€»ä½™é¢ (é€šå¸¸æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆæ—¶)ï¼Œåˆ™ä»¥æ­¤ä¸ºå‡†
            if (typeof newData.bank.balance === 'number') {
                phoneData.bank.balance = newData.bank.balance;
            }

            // éå†æ–°ç”Ÿæˆçš„äº¤æ˜“è®°å½•ï¼Œå¹¶ã€ç´¯åŠ /ç´¯å‡ã€‘åˆ°ä½™é¢ä¸Š
            if (newData.bank.transactions && Array.isArray(newData.bank.transactions)) {
                newData.bank.transactions.forEach(transaction => {
                    const amount = parseFloat(transaction.amount);
                    if (!isNaN(amount)) {
                        // åªæœ‰åœ¨AIæ²¡æœ‰ç›´æ¥æä¾›æ–°ä½™é¢æ—¶ï¼Œæˆ‘ä»¬æ‰æ ¹æ®äº¤æ˜“è®°å½•è‡ªå·±è®¡ç®—
                        if (typeof newData.bank.balance !== 'number') {
                            if (transaction.type === 'æ”¶å…¥') {
                                phoneData.bank.balance += amount;
                            } else if (transaction.type === 'æ”¯å‡º') {
                                phoneData.bank.balance -= amount;
                            }
                        }
                    }
                });
                // å°†æ–°äº¤æ˜“è®°å½•è¿½åŠ åˆ°å†å²è®°å½•ä¸­
                if(!phoneData.bank.transactions) phoneData.bank.transactions = [];
                phoneData.bank.transactions.push(...newData.bank.transactions);
            }
        }
        
        // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤åˆ°è¿™é‡Œç»“æŸ â˜…â˜…â˜… ---

        await db.chats.put(chat);
        alert('æ•°æ®å·²åˆ·æ–°ï¼');

    } catch (error) {
        console.error("ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ®å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œã€APIå¯†é’¥æˆ–æ¨¡å‹è®¾ç½®ã€‚\n\nè¯¦ç»†ä¿¡æ¯:\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}



/**
 * æ¸…ç©ºè§’è‰²æ‰‹æœºæ•°æ®
 */
async function clearCharacterPhoneData() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    const confirmed = await showCustomConfirm('ç¡®è®¤æ¸…ç©º', `ç¡®å®šè¦æ¸…ç©ºâ€œ${chat.name}â€çš„æ‰€æœ‰æ‰‹æœºæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
        chat.characterPhoneData = {
            lastGenerated: null, chats: {}, shoppingCart: [], memos: [],
            browserHistory: [], photoAlbum: [], bank: { balance: 0, transactions: [] },
            trajectory: [],         appUsage: [],
        diary: [] // <--- åœ¨è¿™é‡Œæ–°å¢
        };
        await db.chats.put(chat);
        // é‡æ–°æ¸²æŸ“APPç½‘æ ¼ï¼Œå› ä¸ºç‚¹å‡»APPä¼šè¯»å–æ–°æ•°æ®
        renderCharacterAppGrid();
        alert('æ•°æ®å·²æ¸…ç©ºã€‚');
    }
}

/**
 * ã€V13 - å·²ç¾åŒ–ã€‘æ¸²æŸ“è§’è‰²æ‰‹æœºçš„èŠå¤©åˆ—è¡¨ (æ”¯æŒé€æ˜ç£¨ç ‚åˆ†ç»„)
 */
function renderCharacterChatList() {
    const listEl = document.getElementById('character-chat-list');
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) return;

    const characterChatData = characterChat.characterPhoneData;
    const realChatHistory = characterChat.history;
    listEl.innerHTML = '';

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œåˆ›å»ºNPCæ¶ˆæ¯çš„å®¹å™¨ â˜…â˜…â˜…
    const npcContainer = document.createElement('div');
    npcContainer.className = 'npc-chat-group'; // ç»™å®ƒä¸€ä¸ªä¸“å±çš„classå

    // è·å– "æˆ‘" çš„å¤‡æ³¨å
    const userContactInData = characterChatData.chats
        ? Object.values(characterChatData.chats).find(c => !c.history || c.history.length === 0)
        : null;
    const remarkNameForMe = userContactInData ? userContactInData.remarkName : 'æˆ‘';

    // æ¸²æŸ“ä¸ "æˆ‘" çš„èŠå¤©
    const lastMsg = realChatHistory.filter(m => !m.isHidden).slice(-1)[0] || { content: '...' };
    const myChatItem = document.createElement('div');
    myChatItem.className = 'chat-list-item'; // è¿™ä¸ªæ˜¯ç”¨æˆ·è‡ªå·±çš„æ¶ˆæ¯ï¼Œå•ç‹¬å¤„ç†
    myChatItem.dataset.contactName = remarkNameForMe;
    myChatItem.dataset.isUserChat = 'true';
    const myAvatar = characterChat.settings.myAvatar || defaultMyGroupAvatar;
    myChatItem.innerHTML = `
        <img src="${myAvatar}" class="avatar" style="border-radius: 6px;">
        <div class="info">
            <span class="name">${remarkNameForMe}</span>
            <div class="last-msg">${stripHtmlAndCode(String(lastMsg.content)).substring(0, 30)}</div>
        </div>
    `;
    listEl.appendChild(myChatItem);

    // æ¸²æŸ“ä¸å…¶ä»–NPCçš„èŠå¤©
    if (characterChatData.chats) {
        for (const contactName in characterChatData.chats) {
            if (contactName === remarkNameForMe) continue;
            const contact = characterChatData.chats[contactName];
            if (!contact.history || contact.history.length === 0) continue;

            const lastNpcMsg = contact.history.slice(-1)[0] || { content: '...' };
            const npcChatItem = document.createElement('div');
            npcChatItem.className = 'chat-list-item';
            npcChatItem.dataset.contactName = contactName;

            let npcAvatarHtml;
            const npcFromLibrary = (characterChat.npcLibrary || []).find(npc => npc.name === contactName);
            if (npcFromLibrary && npcFromLibrary.avatar) {
                npcAvatarHtml = `<img src="${npcFromLibrary.avatar}" class="avatar" style="border-radius: 6px;">`;
            } else {
                const avatarColors = ['#FFC107', '#4CAF50', '#2196F3', '#F44336', '#9C27B0', '#00BCD4'];
                const npcNameInitial = contactName.slice(-1);
                const colorIndex = contactName.length % avatarColors.length;
                const bgColor = avatarColors[colorIndex];
                npcAvatarHtml = `<div class="avatar" style="border-radius: 6px; background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
            }
            npcChatItem.innerHTML = `${npcAvatarHtml}<div class="info"><span class="name">${contactName}</span><div class="last-msg">${stripHtmlAndCode(String(lastNpcMsg.content)).substring(0, 30)}</div></div>`;
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå°†NPCæ¶ˆæ¯æ·»åŠ åˆ°æ–°çš„å®¹å™¨ä¸­ â˜…â˜…â˜…
            npcContainer.appendChild(npcChatItem);
        }
    }
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæœ€åå°†åŒ…å«æ‰€æœ‰NPCæ¶ˆæ¯çš„å®¹å™¨ä¸€æ¬¡æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­ â˜…â˜…â˜…
    if (npcContainer.hasChildNodes()) {
        listEl.appendChild(npcContainer);
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderCharacterChatHistory å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V13 - æ€§èƒ½ä¼˜åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æœºçš„å…·ä½“èŠå¤©è®°å½• (åˆ†é¡µåŠ è½½)
 */
function renderCharacterChatHistory(contactName, isUserChat = false, loadOffset = 0) {
    const MESSAGES_PER_PAGE = 50; // æ¯æ¬¡åŠ è½½50æ¡

    const messagesEl = document.getElementById('character-chat-history-messages');
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) {
        console.error("ã€é”™è¯¯ã€‘: æ‰¾ä¸åˆ° characterChat å¯¹è±¡ï¼");
        return;
    }

    // --- å‡†å¤‡å·¥ä½œï¼šè®¾ç½®æ ‡é¢˜å’Œå¤´åƒ (ä»…åœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œ) ---
    if (loadOffset === 0) {
        messagesEl.innerHTML = ''; // é¦–æ¬¡åŠ è½½æ‰æ¸…ç©º
        let finalContactName = contactName;
        if (isUserChat) {
            const myChatData = characterChat.characterPhoneData.chats['æˆ‘'];
            // å°è¯•ä»æ‰‹æœºæ•°æ®é‡Œæ‰¾AIç»™ç”¨æˆ·çš„å¤‡æ³¨å
            const userContactInData = characterChat.characterPhoneData.chats
                ? Object.values(characterChat.characterPhoneData.chats).find(c => !c.history || c.history.length === 0)
                : null;
            finalContactName = userContactInData ? userContactInData.remarkName : 'æˆ‘';
        }
        document.getElementById('character-chat-with-name').textContent = finalContactName;
    }

    // --- æ•°æ®æºé€‰æ‹© ---
    let fullHistory = [];
    if (isUserChat) {
        fullHistory = characterChat.history.filter(m => !m.isHidden);
    } else {
        const npcChat = characterChat.characterPhoneData.chats[contactName];
        if (npcChat && npcChat.history) {
            fullHistory = npcChat.history;
        }
    }

    // --- æ ¸å¿ƒåˆ†é¡µé€»è¾‘ ---
    const totalMessages = fullHistory.length;
    const startIndex = Math.max(0, totalMessages - MESSAGES_PER_PAGE - loadOffset);
    const endIndex = totalMessages - loadOffset;
    const historyToShow = fullHistory.slice(startIndex, endIndex);

    // --- ç§»é™¤æ—§çš„â€œåŠ è½½æ›´å¤šâ€æŒ‰é’® ---
    const existingLoader = document.getElementById('load-more-messages-btn');
    if (existingLoader) {
        existingLoader.remove();
    }

    // --- æ¸²æŸ“æ¶ˆæ¯ ---
    const fragment = document.createDocumentFragment(); // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæå‡æ€§èƒ½
    const characterName = characterChat.name;

    // (æ¸²æŸ“é€»è¾‘ä¸ä¹‹å‰ç‰ˆæœ¬åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ·»åŠ åˆ°äº† fragment ä¸­)
    historyToShow.forEach((msg, index) => {
        if (msg.isHidden) return;
        const container = document.createElement('div');
        let sender;
        if (isUserChat) { sender = msg.role === 'user' ? 'æˆ‘' : characterName; } 
        else { sender = msg.sender; }

        const isSentByCharacter = sender === characterName;
        container.className = `character-chat-bubble-container ${isSentByCharacter ? 'sent' : 'received'}`;
        
        let avatarHtml = '';
        if(isSentByCharacter) {
             avatarHtml = `<img src="${characterChat.settings.aiAvatar || defaultAvatar}" class="character-chat-avatar">`;
        } else {
             if(isUserChat){
                avatarHtml = `<img src="${characterChat.settings.myAvatar || defaultMyGroupAvatar}" class="character-chat-avatar">`;
             } else {
                 const npcData = (characterChat.npcLibrary || []).find(npc => npc.name === contactName);
                 if (npcData && npcData.avatar) {
                    avatarHtml = `<img src="${npcData.avatar}" class="character-chat-avatar">`;
                 } else {
                    const avatarColors = ['#FFC107', '#4CAF50', '#2196F3', '#F44336', '#9C27B0', '#00BCD4'];
                    const npcNameInitial = contactName.slice(-1);
                    const colorIndex = contactName.length % avatarColors.length;
                    const bgColor = avatarColors[colorIndex];
                    avatarHtml = `<div class="character-chat-avatar" style="background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
                 }
             }
        }

        let contentHtml = '';
        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
            contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-height: 100px;">`;
        } else {
            contentHtml = msg.content;
        }
        const bubbleHtml = `<div class="character-chat-bubble">${contentHtml}</div>`;
        const originalIndex = startIndex + index; // è®¡ç®—åœ¨å®Œæ•´å†å²è®°å½•ä¸­çš„çœŸå®ç´¢å¼•
        container.innerHTML = `${avatarHtml}${bubbleHtml}<button class="item-delete-btn message-delete-btn" data-contact-name="${contactName}" data-index="${originalIndex}" data-is-user-chat="${isUserChat}">Ã—</button>`;
        fragment.appendChild(container);
    });
    
    // --- å†³å®šæ˜¯å¦æ˜¾ç¤ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’® ---
    if (startIndex > 0) {
        const loadMoreBtn = document.createElement('div');
        loadMoreBtn.id = 'load-more-messages-btn';
        loadMoreBtn.textContent = 'åŠ è½½æ›´æ—©çš„æ¶ˆæ¯';
        loadMoreBtn.style.textAlign = 'center';
        loadMoreBtn.style.padding = '10px';
        loadMoreBtn.style.color = '#888';
        loadMoreBtn.style.cursor = 'pointer';
        loadMoreBtn.style.fontSize = '12px';
        loadMoreBtn.onclick = () => {
            // è®°å½•å½“å‰æ»šåŠ¨æ¡ä½ç½®ï¼Œä»¥ä¾¿åŠ è½½åæ¢å¤
            const currentScrollHeight = messagesEl.scrollHeight;
            renderCharacterChatHistory(contactName, isUserChat, loadOffset + MESSAGES_PER_PAGE);
            // åŠ è½½åï¼Œå°†æ»šåŠ¨æ¡å®šä½åˆ°ä¹‹å‰çš„ä½ç½®ï¼Œé¿å…è·³åŠ¨
            messagesEl.scrollTop = messagesEl.scrollHeight - currentScrollHeight;
        };
        messagesEl.prepend(loadMoreBtn); // å°†æŒ‰é’®æ·»åŠ åˆ°é¡¶éƒ¨
    }
    
    messagesEl.prepend(fragment); // å°†æ–°æ¶ˆæ¯ä¸€æ¬¡æ€§æ’å…¥åˆ°DOMä¸­

    // --- æ»šåŠ¨æ¡å®šä½ ---
    if (loadOffset === 0) {
        // é¦–æ¬¡åŠ è½½ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



function renderCharacterShoppingCart() {
    const listEl = document.getElementById('character-shopping-cart-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.shoppingCart;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-cart-item';
        itemEl.innerHTML = `
            <div class="cart-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            </div>
            <div class="cart-item-info">
                <div class="title">${item.name}</div>
                <div class="store">${item.store}</div>
            </div>
            <div class="cart-item-price">Â¥ ${item.price.toFixed(2)}</div>
            <button class="item-delete-btn" data-type="shoppingCart" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}
function renderCharacterMemos() {
    const listEl = document.getElementById('character-memos-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.memos;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">å¤‡å¿˜å½•æ˜¯ç©ºçš„</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-data-item';
        itemEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="content">${item.content}</div>
            <button class="item-delete-btn" data-type="memos" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}


// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘åœ¨è§’è‰²æ‰‹æœºå†…éƒ¨åˆ‡æ¢é¡µé¢
 * @param {string} pageId - è¦æ˜¾ç¤ºçš„è§’è‰²æ‰‹æœºé¡µé¢çš„ID
 */
function showCharacterPhonePage(pageId) {
    // 1. æ‰¾åˆ°è§’è‰²æ‰‹æœºå†…éƒ¨å±å¹•çš„æ‰€æœ‰é¡µé¢
    const pages = document.querySelectorAll('.character-phone-page');
    // 2. éšè—æ‰€æœ‰é¡µé¢
    pages.forEach(p => p.classList.remove('active'));
    // 3. æ˜¾ç¤ºç›®æ ‡é¡µé¢
    const pageToShow = document.getElementById(pageId);
    if (pageToShow) {
        pageToShow.classList.add('active');
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºæ–°å¢APPæ¸²æŸ“å‡½æ•° â–¼â–¼â–¼

function renderCharacterBrowser() {
    const listEl = document.getElementById('character-browser-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.browserHistory;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æµè§ˆå™¨å†å²ä¸ºç©º</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-browser-item';
        itemEl.innerHTML = `
            <span class="browser-item-icon">ğŸŒ</span>
            <div class="title">${item.query}</div>
            <button class="item-delete-btn" data-type="browserHistory" data-index="${index}">Ã—</button>
        `;
        itemEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('item-delete-btn')) return;
            document.getElementById('character-browser-detail-title').textContent = item.query;
            document.getElementById('character-browser-detail-content').innerHTML = (item.result || "AIæœªç”Ÿæˆè¯¦ç»†å†…å®¹ã€‚").replace(/\n/g, '<br>');
            showCharacterPhonePage('character-browser-detail-screen');
        });
        listEl.appendChild(itemEl);
    });
}


function renderCharacterPhotoAlbum() {
    const gridEl = document.getElementById('character-album-grid');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.photoAlbum;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    gridEl.innerHTML = '';
    if (!items || items.length === 0) {
        gridEl.innerHTML = '<p style="grid-column: 1 / -1; text-align:center; color: #8a8a8a; margin-top: 50px;">ç›¸å†Œé‡Œæ²¡æœ‰ç…§ç‰‡</p>';
        return;
    }
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-album-item';
        itemEl.style.position = 'relative'; 
        itemEl.innerHTML = `
            <img src="https://i.postimg.cc/KYr2qRCK/1.jpg" alt="æ–‡å­—å›¾">
            <button class="item-delete-btn" data-type="photoAlbum" data-index="${index}" style="top: 10px; right: 10px; z-index: 1;">Ã—</button>
        `;
        itemEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('item-delete-btn')) return;
            showCustomAlert("å›¾ç‰‡å†…å®¹", item.hiddenContent);
        });
        gridEl.appendChild(itemEl);
    });
}



/**
 * ã€V2ç¾åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æœº - é“¶è¡Œ
 */
function renderCharacterBank() {
    const detailsEl = document.getElementById('character-bank-details');
    // ã€æ–°å¢ã€‘è·å–å½“å‰è§’è‰²å¯¹è±¡ï¼Œä¸ºåé¢æ‰¾å¤‡æ³¨ååšå‡†å¤‡
    const characterChat = state.chats[activeCharacterPhoneId];
    if (!characterChat) return;

    const bankData = characterChat.characterPhoneData?.bank;
    detailsEl.innerHTML = '';

    // ã€æ–°å¢ã€‘è·å–è§’è‰²ç»™ç”¨æˆ·çš„å¤‡æ³¨å
    const userContactInData = characterChat.characterPhoneData.chats
        ? Object.values(characterChat.characterPhoneData.chats).find(c => !c.history || c.history.length === 0)
        : null;
    const remarkNameForMe = userContactInData ? userContactInData.remarkName : 'æˆ‘';
    
    const balanceCard = document.createElement('div');
    balanceCard.className = 'character-bank-balance-card';
    balanceCard.innerHTML = `
        <div class="label">è´¦æˆ·ä½™é¢</div>
        <div class="amount">Â¥ ${(bankData?.balance || 0).toFixed(2)}</div>
    `;
    detailsEl.appendChild(balanceCard);
    
    if (!bankData?.transactions || bankData.transactions.length === 0) {
        detailsEl.innerHTML += '<p style="text-align:center; color: #8a8a8a; margin-top: 30px;">æš‚æ— äº¤æ˜“æ˜ç»†</p>';
        return;
    }

    [...bankData.transactions].reverse().forEach((item, index) => {
        const originalIndex = bankData.transactions.length - 1 - index;
        const isIncome = item.type === 'æ”¶å…¥';
        const itemEl = document.createElement('div');
        itemEl.className = 'character-bank-transaction';
        const iconBg = isIncome ? '#4CAF50' : '#E91E63';
        const iconSvg = isIncome 
            ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M7 10h10v4H7z" opacity=".3"/><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>`
            : `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-5h16v5c0 .55-.45 1-1 1zm1-10H4V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v2z"/></svg>`;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨æ­£åˆ™è¡¨è¾¾å¼ /æˆ‘/g å…¨å±€æ›¿æ¢æ‰€æœ‰â€œæˆ‘â€å­—
        const displayDescription = item.description.replace(/æˆ‘/g, remarkNameForMe);

        itemEl.innerHTML = `
            <div class="transaction-details">
                <div class="transaction-icon" style="background-color: ${iconBg};">${iconSvg}</div>
                <div>
                    <div class="title">${displayDescription}</div>
                    <div class="meta" style="border:none; padding:0; margin-top:4px;"><span>${item.type}</span></div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="transaction-amount ${isIncome ? 'income' : 'expense'}">
                    ${isIncome ? '+' : '-'} ${item.amount.toFixed(2)}
                </span>
                <button class="item-delete-btn" data-type="bank.transactions" data-index="${originalIndex}">Ã—</button>
            </div>
        `;
        detailsEl.appendChild(itemEl);
    });
}


/**
 * ã€V2ç¾åŒ–ç‰ˆ | å·²ä¿®å¤æ—¶é—´æ’åºã€‘æ¸²æŸ“è§’è‰²æ‰‹æœº - è¡ŒåŠ¨è½¨è¿¹
 */
function renderCharacterTrajectory() {
    const listEl = document.getElementById('character-trajectory-list');
    const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.trajectory;
    listEl.innerHTML = '';
    listEl.classList.add('character-trajectory-list');

    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš‚æ— è¶³è¿¹</p>';
        return;
    }

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ä»£ç  â–¼â–¼â–¼
    // åœ¨æ¸²æŸ“ä¹‹å‰ï¼Œä½¿ç”¨æˆ‘ä»¬æ–°åŠ çš„ parseTime å‡½æ•°å¯¹è½¨è¿¹æ•°ç»„è¿›è¡Œæ’åº
    items.sort((a, b) => parseTime(a.time) - parseTime(b.time));
    // â–²â–²â–² ä¿®å¤å®Œæˆ â–²â–²â–²

    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-trajectory-item';
        itemEl.innerHTML = `
            <div class="trajectory-item-content">
                <div class="title">${item.activity}</div>
                <div class="meta">
                    <span>ğŸ“ ${item.location}</span>
                    <span style="margin-left: 10px;">ğŸ•’ ${item.time}</span>
                </div>
            </div>
            <button class="item-delete-btn" data-type="trajectory" data-index="${index}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}


/**
 * ã€V2ç¾åŒ–ç‰ˆã€‘æ¸²æŸ“è§’è‰²æ‰‹æœº - APPä½¿ç”¨è®°å½•
 */
function renderCharacterAppUsage() {
    const listEl = document.getElementById('character-app-usage-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.appUsage;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    listEl.innerHTML = '';
     if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš‚æ— ä½¿ç”¨è®°å½•</p>';
        return;
    }
    const durationsInMinutes = items.map(item => parseDurationToMinutes(item.duration));
    const maxDuration = Math.max(...durationsInMinutes);
    items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'character-app-usage-item';
        const durationInMinutes = durationsInMinutes[index];
        const barWidth = maxDuration > 0 ? (durationInMinutes / maxDuration) * 100 : 0;
        itemEl.innerHTML = `
            <div class="app-usage-header">
                <span class="name">${item.appName}</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="duration">${item.duration}</span>
                    <button class="item-delete-btn" data-type="appUsage" data-index="${index}">Ã—</button>
                </div>
            </div>
            <div class="app-usage-bar-container">
                <div class="app-usage-bar" style="width: ${barWidth}%;"></div>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}


/**
 * ã€æ—¥è®° V4-æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„æ—¥è®°åˆ—è¡¨
 */
function renderCharacterDiary() {
    const listEl = document.getElementById('character-diary-list');
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
const items = state.chats[activeCharacterPhoneId]?.characterPhoneData?.diary;
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ—¥è®°æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’å†™ä¸‹ç¬¬ä¸€ç¯‡æ—¥è®°å§ã€‚</p>';
        return;
    }
    
    [...items].reverse().forEach((item, index) => {
        const originalIndex = items.length - 1 - index;
        const itemEl = document.createElement('div');
        itemEl.className = 'character-data-item';
        const contentHtml = renderMarkdown(item.content);
        itemEl.innerHTML = `
            <div class="content">${contentHtml}</div>
            <div class="meta">
                <span>${new Date(item.timestamp).toLocaleString()}</span>
            </div>
            <button class="item-delete-btn" data-type="diary" data-index="${originalIndex}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    });
}


// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å¢å¼ºç‰ˆä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ generateNewDiaryEntry å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ—¥è®°ã€‘ç‹¬ç«‹åˆ·æ–°ï¼Œç”Ÿæˆæ–°çš„æ—¥è®°æ¡ç›® (å·²å¢åŠ é”™è¯¯å¤„ç†)
 */
async function generateNewDiaryEntry() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    document.getElementById('generation-overlay').classList.add('visible');

    try {
        const persona = chat.settings.aiPersona;
        const recentHistory = chat.history.slice(-20).map(msg => {
            const sender = msg.role === 'user' ? 'æˆ‘' : chat.name;
            return `${sender}: ${msg.content}`;
        }).join('\n');
        
        let worldBookContext = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            worldBookContext = '--- ä¸–ç•Œè§‚è®¾å®š (è¿™æ˜¯ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆçš„èƒŒæ™¯) ---\n' +
                chat.settings.linkedWorldBookIds.map(id => {
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
                }).join('\n\n');
        }
        
        const diaryPrompt = `
# ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚ä»Šå¤©æ˜¯ ${new Date().toLocaleString('zh-CN', { dateStyle: 'full' })}ã€‚è¯·ä½ å›é¡¾ä¸€ä¸‹æœ€è¿‘å’Œæˆ‘çš„èŠå¤©ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œç„¶åç”¨ä½ çš„å£å»å†™ä¸€ç¯‡å…³äºã€ä»Šå¤©æˆ–è¿‘æœŸå‘ç”Ÿäº‹æƒ…ã€‘çš„æ—¥è®°ã€‚
è¿™ç¯‡æ—¥è®°æ˜¯ä½ å†…å¿ƒçš„ç‹¬ç™½ï¼Œå¯ä»¥è®°å½•ä½ çš„æ„Ÿå—ã€æ€è€ƒã€è®¡åˆ’æˆ–è€…ç§˜å¯†ã€‚
å†…å®¹è¦ä¸°å¯Œã€æœ‰æ·±åº¦ï¼Œé•¿åº¦åœ¨100åˆ°300å­—ä¹‹é—´ã€‚

# ã€ã€ã€é‡è¦ï¼šæ ¼å¼æŒ‡ä»¤ã€‘ã€‘ã€‘
ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹Markdownè¯­æ³•æ¥ä¸°å¯Œæ—¥è®°çš„æ ¼å¼ï¼Œä½¿å…¶æ›´å…·è¡¨ç°åŠ›ï¼š
-   **æ ‡é¢˜**: ä½¿ç”¨ \`#\` æˆ– \`##\` æ¥åˆ›å»ºå¤§æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ã€‚ (ä¾‹å¦‚: \`# ä»Šå¤©çš„å¿ƒæƒ…\`)
-   **ç²—ä½“**: ä½¿ç”¨ \`**æ–‡å­—**\` æ¥å¼ºè°ƒé‡ç‚¹ã€‚ (ä¾‹å¦‚: \`ä»Šå¤©çœŸçš„**éå¸¸**å¼€å¿ƒã€‚\`)
-   **æ–œä½“**: ä½¿ç”¨ \`*æ–‡å­—*\` æ¥è¡¨è¾¾æƒ…ç»ªæˆ–å†…å¿ƒæƒ³æ³•ã€‚ (ä¾‹å¦‚: \`*ä»–åˆ°åº•æ˜¯æ€ä¹ˆæƒ³çš„å‘¢...*\`)
-   **åˆ é™¤çº¿**: ä½¿ç”¨ \`~~æ–‡å­—~~\` æ¥è¡¨ç¤ºåˆ’æ‰æˆ–å¦å®šçš„æƒ³æ³•ã€‚ (ä¾‹å¦‚: \`æˆ‘å†³å®šæ˜å¤©å»<s>é€›è¡—</s>å­¦ä¹ ã€‚\`)
-   **é®æŒ¡/å‰§é€**: ä½¿ç”¨ \`||æ–‡å­—||\` æ¥éšè—ç§˜å¯†æˆ–æ‚„æ‚„è¯ã€‚ (ä¾‹å¦‚: \`æˆ‘å·å·å‡†å¤‡äº†ä¸€ä¸ªæƒŠå–œï¼Œ||æ˜¯ä¸€ä¸ªæ‰‹ç»‡çš„å›´å·¾||ã€‚\`)

ä½ çš„è¾“å‡ºã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯æ—¥è®°çš„æ­£æ–‡å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–è¯´æ˜æˆ–JSONæ ¼å¼ã€‚

# ä½ çš„ä¿¡æ¯
- ä½ çš„åå­—: ${chat.name}
- ä½ çš„äººè®¾: ${persona}
${worldBookContext}

# æœ€è¿‘èŠå¤©è®°å½•å‚è€ƒ
${recentHistory}
`;

        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, diaryPrompt, [{role: 'user', content: diaryPrompt}], isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: diaryPrompt}],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                })
            });
        
        // --- â˜…â˜…â˜… é”™è¯¯å¤„ç†æ ¸å¿ƒä»£ç  â˜…â˜…â˜… ---
        if (!response.ok) {
            let errorMsg = `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg += `\né”™è¯¯ä¿¡æ¯: ${errorData.error.message}`;
            } catch (e) {
                errorMsg += `\næ— æ³•è§£æé”™è¯¯å“åº”ä½“ã€‚`;
            }
            throw new Error(errorMsg);
        }
        // --- â˜…â˜…â˜… é”™è¯¯å¤„ç†ç»“æŸ â˜…â˜…â˜… ---
        
        const data = await response.json();
        const diaryContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

        const newEntry = {
            timestamp: Date.now(),
            content: diaryContent
        };
        
        chat.characterPhoneData.diary.push(newEntry);
        await db.chats.put(chat);
        
        renderCharacterDiary();
        alert('æ–°æ—¥è®°å·²ç”Ÿæˆï¼');

    } catch (error) {
        console.error("ç”Ÿæˆæ—¥è®°å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œã€APIå¯†é’¥æˆ–æ¨¡å‹è®¾ç½®ã€‚\n\nè¯¦ç»†ä¿¡æ¯:\n${error.message}`);
    } finally {
        document.getElementById('generation-overlay').classList.remove('visible');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸‡èƒ½Markdownæ¸²æŸ“å‡½æ•° (å¸¦å®‰å…¨è¿‡æ»¤å’Œé®æŒ¡æ•ˆæœ) â–¼â–¼â–¼

/**
 * å°†Markdownæ–‡æœ¬å®‰å…¨åœ°æ¸²æŸ“ä¸ºHTML
 * @param {string} markdownText - åŸå§‹çš„Markdownæ–‡æœ¬
 * @returns {string} - å¤„ç†å’Œå‡€åŒ–åçš„å®‰å…¨HTMLå­—ç¬¦ä¸²
 */
function renderMarkdown(markdownText) {
    if (!markdownText) return '';

    // 1. ã€é¢„å¤„ç†ã€‘æ”¯æŒè‡ªå®šä¹‰çš„â€œé®æŒ¡/å‰§é€â€è¯­æ³• ||spoiler||
    // æˆ‘ä»¬åœ¨ marked.js å¤„ç†ä¹‹å‰ï¼Œæ‰‹åŠ¨æŠŠ ||text|| æ›¿æ¢æˆå¸¦ç‰¹å®šclassçš„HTMLæ ‡ç­¾
    let processedText = markdownText.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');

    // 2. ã€æ ¸å¿ƒã€‘ä½¿ç”¨ marked.js å°†Markdownè½¬æ¢ä¸ºHTML
    // gfm: true å¼€å¯GitHubé£æ ¼çš„Markdownï¼Œæ”¯æŒåˆ é™¤çº¿ç­‰
    // breaks: true è®©å›è½¦ç¬¦ä¹Ÿèƒ½å˜æˆ<br>ï¼Œæ›´ç¬¦åˆèŠå¤©ä¹ æƒ¯
    let rawHtml = marked.parse(processedText, { gfm: true, breaks: true });

    // 3. ã€å®‰å…¨ã€‘ä½¿ç”¨ DOMPurify æ¸…æ´—HTMLï¼Œé˜²æ­¢XSSæ”»å‡»
    let sanitizedHtml = DOMPurify.sanitize(rawHtml);

    return sanitizedHtml;
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘å°†æ—¶é•¿å­—ç¬¦ä¸²ï¼ˆå¦‚â€œ2.5å°æ—¶â€ï¼‰è½¬æ¢ä¸ºåˆ†é’Ÿæ•°
 */
function parseDurationToMinutes(durationString) {
    if (!durationString) return 0;
    const num = parseFloat(durationString) || 0;
    if (durationString.includes('å°æ—¶') || durationString.includes('h')) {
        return num * 60;
    }
    // é»˜è®¤å•ä½æ˜¯åˆ†é’Ÿ
    return num;
}
// â–¼â–¼â–¼ æŠŠè¿™ä¸¤ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ¢è§†é¢‘é€šè¯çš„å¤§å°çª—å£ç”»é¢
 */
function switchVideoViews() {
    const mainView = document.getElementById('video-main-view');
    const pipView = document.getElementById('video-pip-view');
    
    // äº¤æ¢ä¸¤å¼ å›¾ç‰‡çš„ src
    const mainImg = mainView.querySelector('img');
    const pipImg = pipView.querySelector('img');
    const tempSrc = mainImg.src;
    mainImg.src = pipImg.src;
    pipImg.src = tempSrc;
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å…¨æ–°çš„ã€é€»è¾‘æ­£ç¡®çš„å‡½æ•°ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ handleVideoCallReroll å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¤„ç†è§†é¢‘é€šè¯ä¸­çš„â€œé‡rollâ€è¯·æ±‚
 */
async function handleVideoCallReroll() {
    if (!videoCallState.isActive) return;

    // 1. æ‰¾åˆ°ç”¨æˆ·æœ€åä¸€æ¬¡è¯´çš„è¯çš„ç´¢å¼•
    const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(h => h.role === 'user');
    
    // 2. ä»é€šè¯å†å²ä¸­ï¼Œåˆ é™¤æ‰é‚£ä¹‹åçš„æ‰€æœ‰AIå›å¤
    //    å¦‚æœç”¨æˆ·ä¸€å¥è¯æ²¡è¯´ï¼ˆlastUserSpeechIndex æ˜¯ -1ï¼‰ï¼Œå°±åˆ é™¤æ‰€æœ‰AIçš„å›å¤
    if (lastUserSpeechIndex > -1) {
        videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
    } else {
        // å¦‚æœç”¨æˆ·è¿˜æ²¡è¯´è¿‡è¯ï¼Œå°±æ¸…ç©ºæ‰€æœ‰å†å²ï¼Œè®©AIé‡è¯´ç¬¬ä¸€å¥è¯
        videoCallState.callHistory = [];
    }
    
    // 3. ã€æ ¸å¿ƒã€‘é‡æ–°æ¸²æŸ“é€šè¯ç•Œé¢ï¼Œè®©æ—§çš„AIæ°”æ³¡ä»å±å¹•ä¸Šæ¶ˆå¤±
    //    æˆ‘ä»¬éœ€è¦æ ¹æ®å½“å‰æ˜¯å“ªç§æ¨¡å¼ï¼Œæ¥æ¸…ç©ºå¯¹åº”çš„èŠå¤©å®¹å™¨
    const chat = state.chats[videoCallState.activeChatId];
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');
    
    callFeed.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
    
    // é‡æ–°æ¸²æŸ“åˆ é™¤åçš„å†å²è®°å½•
    videoCallState.callHistory.forEach(msg => {
        let bubble;
        if (isVisualMode) {
            bubble = document.createElement('div');
            bubble.className = `visual-call-bubble ${msg.role === 'user' ? 'user' : 'ai'}`;
        } else {
            bubble = document.createElement('div');
            bubble.className = `call-message-bubble ${msg.role === 'user' ? 'user-speech' : 'ai-speech'}`;
        }
        bubble.textContent = msg.content;
        callFeed.appendChild(bubble);
    });
    
    // 4. é‡æ–°è§¦å‘AIå“åº”ï¼Œå®ƒä¼šæ ¹æ®åˆ å‡åçš„å†å²è®°å½•ç”Ÿæˆæ–°å†…å®¹
    await triggerAiInCallAction();
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
 * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    // æ ¸å¿ƒæ“ä½œï¼šæ·»åŠ æˆ–ç§»é™¤ .dark-mode ç±»
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    // å°†ç”¨æˆ·çš„é€‰æ‹©ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æ—¶è®°ä½
    localStorage.setItem('ephone-theme', theme);

    // ã€é‡è¦ã€‘å› ä¸ºèŠå¤©èƒŒæ™¯è‰²ä¾èµ–æ¨¡å¼ï¼Œåˆ‡æ¢åéœ€è¦é‡æ–°æ¸²æŸ“
    if (state.activeChatId) {
        renderChatInterface(state.activeChatId);
    }
}

/**
 * å½“ç”¨æˆ·ç‚¹å‡»å¼€å…³æ—¶ï¼Œåˆ‡æ¢å½“å‰çš„ä¸»é¢˜
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}
// â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆ é™¤è§’è‰²æ‰‹æœºä¸­çš„ä¸€ä¸ªè”ç³»äººåŠå…¶æ‰€æœ‰èŠå¤©è®°å½•
 * @param {string} contactName - è¦åˆ é™¤çš„è”ç³»äººçš„åå­—
 */
async function deleteCharacterPhoneContact(contactName) {
    if (!activeCharacterPhoneId) return;

    // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯åˆ 
    const confirmed = await showCustomConfirm(
        'åˆ é™¤è”ç³»äºº',
        `ç¡®å®šè¦ä»TAçš„æ‰‹æœºä¸­åˆ é™¤è”ç³»äººâ€œ${contactName}â€ä»¥åŠæ‰€æœ‰ç›¸å…³èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeCharacterPhoneId];
        if (chat && chat.characterPhoneData && chat.characterPhoneData.chats) {
            // ä»æ•°æ®ä¸­åˆ é™¤è¿™ä¸ªè”ç³»äºº
            delete chat.characterPhoneData.chats[contactName];
            
            // å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜å›æ•°æ®åº“
            await db.chats.put(chat);
            
            // é‡æ–°æ¸²æŸ“èŠå¤©åˆ—è¡¨ï¼Œè®©åˆ é™¤æ•ˆæœç«‹åˆ»æ˜¾ç¤º
            renderCharacterChatList();
            
            alert(`è”ç³»äººâ€œ${contactName}â€å·²åˆ é™¤ã€‚`);
        }
    }
}
// â–¼â–¼â–¼ ç”¨è¿™å—ã€V5 - å·²é›†æˆæ ·å¼åº”ç”¨ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ openInnerVoiceModal å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V5ã€‘æ‰“å¼€å¿ƒå£°é¢æ¿ï¼Œåº”ç”¨èƒŒæ™¯å’Œæ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®
 */
function openInnerVoiceModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // --- â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢1ï¼šåº”ç”¨è‡ªå®šä¹‰æ ·å¼ â˜…â˜…â˜… ---
    applySavedInnerVoiceStyles();

    applyInnerVoiceBackground(chat.innerVoiceBackground || '');

    if (!chat.latestInnerVoice) {
        alert("è¿˜æ²¡æœ‰æ•æ‰åˆ°Taçš„å¿ƒå£°å“¦ï¼Œè¯•ç€å†èŠä¸€å¥å§ï¼");
        return;
    }
    
    const modal = document.getElementById('inner-voice-modal');
    const data = chat.latestInnerVoice;
    
    // --- è§’è‰²ä¿¡æ¯å¡«å…… (ä¸å˜) ---
    document.getElementById('inner-voice-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    document.getElementById('inner-voice-char-name').textContent = chat.name;
    const frameImg = document.getElementById('inner-voice-avatar-frame');
    const avatarWrapper = document.getElementById('inner-voice-avatar-wrapper');
    const frameUrl = chat.settings.aiAvatarFrame || '';
    
    if (frameUrl) {
        frameImg.src = frameUrl;
        frameImg.style.display = 'block';
        avatarWrapper.classList.remove('has-border');
    } else {
        frameImg.src = '';
        frameImg.style.display = 'none';
        avatarWrapper.classList.add('has-border');
    }

    const labelFormat = chat.settings.innerVoiceAdopterLabelFormat || 'é¢†å…»äºº: {{user}}';
    const userNickname = chat.settings.myNickname || 'ä½ ';
    const finalAdopterText = labelFormat.replace('{{user}}', userNickname);
    
    document.getElementById('inner-voice-adopter-avatar').src = chat.settings.myAvatar || defaultAvatar;
    document.getElementById('inner-voice-adopter-name').textContent = finalAdopterText;

    const header = document.querySelector('#inner-voice-main-panel .modal-header');
    if (header) {
        const shouldHideBorder = chat.settings.innerVoiceHideHeaderBorder || false;
        header.classList.toggle('no-border', shouldHideBorder);
    }

    // --- å¿ƒå£°å†…å®¹å¡«å…… (ä¸å˜) ---
    document.getElementById('inner-voice-clothing').textContent = data.clothing || '...';
    document.getElementById('inner-voice-behavior').textContent = data.behavior || '...';
    document.getElementById('inner-voice-thoughts').textContent = data.thoughts || '...';
    document.getElementById('inner-voice-naughty-thoughts').textContent = data.naughtyThoughts || '...';

    // --- æ˜¾ç¤ºé¢æ¿ (ä¸å˜) ---
    modal.classList.add('visible');
    document.getElementById('inner-voice-history-panel').style.display = 'none';
    document.getElementById('inner-voice-main-panel').style.display = 'flex';
    isInnerVoiceHistoryOpen = false;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * æ‰“å¼€æˆ–å…³é—­å†å²è®°å½•é¢æ¿
 */
function toggleInnerVoiceHistory() {
    const mainPanel = document.getElementById('inner-voice-main-panel');
    const historyPanel = document.getElementById('inner-voice-history-panel');
    
    if (isInnerVoiceHistoryOpen) {
        // å¦‚æœæ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­å®ƒï¼Œæ˜¾ç¤ºä¸»é¢æ¿
        mainPanel.style.display = 'flex';
        historyPanel.style.display = 'none';
    } else {
        // å¦‚æœæ˜¯å…³é—­çš„ï¼Œå°±æ‰“å¼€å®ƒï¼Œéšè—ä¸»é¢æ¿
        renderInnerVoiceHistory(); // æ¸²æŸ“å†å²è®°å½•
        mainPanel.style.display = 'none';
        historyPanel.style.display = 'flex';
    }
    isInnerVoiceHistoryOpen = !isInnerVoiceHistoryOpen; // åˆ‡æ¢çŠ¶æ€
}

/**
 * æ¸²æŸ“å¿ƒå£°çš„å†å²è®°å½•åˆ—è¡¨
 */
function renderInnerVoiceHistory() {
    const listEl = document.getElementById('inner-voice-history-list');
    listEl.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const history = chat.innerVoiceHistory || [];

    if (history.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">è¿˜æ²¡æœ‰å†å²è®°å½•</p>';
        return;
    }

    // ä»æ–°åˆ°æ—§æ˜¾ç¤º
    [...history].reverse().forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'inner-voice-history-item';
        
        const date = new Date(item.timestamp);
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨HTMLä¸­åŠ å…¥äº†åˆ é™¤æŒ‰é’®
        itemEl.innerHTML = `
            <button class="history-item-delete-btn" data-timestamp="${item.timestamp}">Ã—</button>
            <div class="history-item-timestamp">${dateString}</div>
            <div class="history-item-content">
                <p><strong>æœè£…:</strong> ${item.clothing || '...'}</p>
                <p><strong>è¡Œä¸º:</strong> ${item.behavior || '...'}</p>
                <p><strong>å¿ƒå£°:</strong> ${item.thoughts || '...'}</p>
                <p><strong>åå¿ƒæ€:</strong> ${item.naughtyThoughts || '...'}</p>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
/**
 * ã€å…¨æ–°ã€‘åˆ é™¤å•æ¡å¿ƒå£°è®°å½•
 * @param {number} timestamp - è¦åˆ é™¤çš„å¿ƒå£°çš„æ—¶é—´æˆ³
 */
async function deleteSingleInnerVoice(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.innerVoiceHistory) return;

    // å¼¹å‡ºç¡®è®¤æ¡†
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¿ƒå£°è®°å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // ä»æ•°ç»„ä¸­è¿‡æ»¤æ‰åŒ¹é…çš„é¡¹
        chat.innerVoiceHistory = chat.innerVoiceHistory.filter(item => item.timestamp !== timestamp);
        // ä¿å­˜å›æ•°æ®åº“
        await db.chats.put(chat);
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderInnerVoiceHistory();
    }
}

/**
 * ã€å·²ä¿®å¤ã€‘æ¸…ç©ºæ‰€æœ‰å¿ƒå£°è®°å½•ï¼ˆåŒ…æ‹¬å½“å‰å¿ƒå£°ï¼‰
 */
async function clearAllInnerVoiceHistory() {
    const chat = state.chats[state.activeChatId];
    // ä¼˜åŒ–äº†åˆ¤æ–­æ¡ä»¶ï¼Œç¡®ä¿åªè¦æœ‰å†å²æˆ–å½“å‰å¿ƒå£°ï¼Œå°±å¯ä»¥æ‰§è¡Œæ¸…ç©º
    if (!chat || (!chat.innerVoiceHistory || chat.innerVoiceHistory.length === 0) && !chat.latestInnerVoice) {
        alert("æ²¡æœ‰å¯ä»¥æ¸…ç©ºçš„å¿ƒå£°è®°å½•ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm('ç¡®è®¤æ¸…ç©º', 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¿ƒå£°å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        // â˜… æ ¸å¿ƒä¿®å¤1ï¼šä¸ä»…æ¸…ç©ºå†å²æ•°ç»„ï¼Œä¹Ÿè¦æ¸…ç©ºå½“å‰çš„å¿ƒå£°å¯¹è±¡
        chat.innerVoiceHistory = [];
        chat.latestInnerVoice = null; // å°†å½“å‰å¿ƒå£°è®¾ä¸ºnull
        
        await db.chats.put(chat);
        
        // â˜… æ ¸å¿ƒä¿®å¤2ï¼šæ‰‹åŠ¨æ¸…ç©ºä¸»é¢æ¿çš„æ˜¾ç¤ºï¼Œé˜²æ­¢è¿”å›æ—¶çœ‹åˆ°æ—§æ•°æ®
        document.getElementById('inner-voice-clothing').textContent = '...';
        document.getElementById('inner-voice-behavior').textContent = '...';
        document.getElementById('inner-voice-thoughts').textContent = '...';
        document.getElementById('inner-voice-naughty-thoughts').textContent = '...';
        
        // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆè¿™è¡Œæ˜¯åŸæœ¬å°±æœ‰çš„ï¼Œä¼šæ˜¾ç¤ºâ€œè¿˜æ²¡æœ‰å†å²è®°å½•â€ï¼‰
        renderInnerVoiceHistory();
        
        // (å¯é€‰ä½†æ¨è) ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
        alert('æ‰€æœ‰å¿ƒå£°è®°å½•å·²æ¸…ç©ºï¼');
    }
}

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œå¬å”¤NPCè¯„è®ºâ€æŒ‰é’®æ—¶è§¦å‘
 * @param {number} postId - åŠ¨æ€çš„ID
 * @param {string} authorId - åŠ¨æ€ä½œè€…çš„ID ('user' æˆ– 'chat_...')
 */
async function handleNpcSummonClick(postId, authorId) {
    const post = await db.qzonePosts.get(postId);
    if (!post) {
        alert("æ‰¾ä¸åˆ°è¯¥åŠ¨æ€ï¼");
        return;
    }

    if (authorId === 'user') {
        // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€ï¼Œå¼¹å‡ºé€‰æ‹©èœå•
        await handleUserPostCommentTrigger(post);
    } else {
        // å¦‚æœæ˜¯è§’è‰²å‘çš„åŠ¨æ€ï¼Œç›´æ¥è§¦å‘ä»–è‡ªå·±çš„NPC
        await handleCharPostCommentTrigger(post, authorId);
    }
}

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ä»£ç æ›¿æ¢æ‰ä½ æ—§çš„ handleCharPostCommentTrigger å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ã€è§’è‰²ã€‘åŠ¨æ€çš„NPCå¬å”¤
 * @param {object} post - åŠ¨æ€å¯¹è±¡
 * @param {string} authorId - åŠ¨æ€ä½œè€…çš„è§’è‰²ID
 */
async function handleCharPostCommentTrigger(post, authorId) {
    const authorChar = state.chats[authorId];
    if (!authorChar || !authorChar.npcLibrary || authorChar.npcLibrary.length === 0) {
        alert(`è§’è‰²â€œ${authorChar.name}â€è¿˜æ²¡æœ‰è‡ªå·±çš„NPCæœ‹å‹å“¦ï¼`);
        return;
    }

    // åªä½¿ç”¨è¿™ä¸ªè§’è‰²è‡ªå·±çš„NPCåº“
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæŠŠä½œè€…æœ¬äºº(authorChar)ä½œä¸ºâ€œä¸»äººâ€ä¼ è¿›å» â–¼â–¼â–¼
    await generateNpcCommentsForPost(post, authorChar.npcLibrary, authorChar);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ä»£ç æ›¿æ¢æ‰ä½ æ—§çš„ handleUserPostCommentTrigger å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ã€ç”¨æˆ·ã€‘åŠ¨æ€çš„NPCå¬å”¤ï¼ˆå¼¹å‡ºé€‰æ‹©æ¡†ï¼‰
 */
async function handleUserPostCommentTrigger(post) {
    const modal = document.getElementById('custom-modal-overlay');
    const modalTitle = document.getElementById('custom-modal-title');
    const modalBody = document.getElementById('custom-modal-body');
    const modalConfirmBtn = document.getElementById('custom-modal-confirm');
    const modalCancelBtn = document.getElementById('custom-modal-cancel');
    
    modalTitle.textContent = 'é€‰æ‹©è¦å¬å”¤çš„NPC';
    
    // ç­›é€‰å‡ºæ‰€æœ‰æ‹¥æœ‰NPCåº“çš„è§’è‰²
    const charsWithNpcs = Object.values(state.chats).filter(
        chat => !chat.isGroup && chat.npcLibrary && chat.npcLibrary.length > 0
    );

    if (charsWithNpcs.length === 0) {
        alert("å½“å‰æ²¡æœ‰ä»»ä½•è§’è‰²æ‹¥æœ‰NPCåº“ã€‚");
        return;
    }

    // æ„å»ºé€‰æ‹©åˆ—è¡¨çš„HTML
    let optionsHtml = '<div style="text-align: left;">';
    optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="all" checked> å¬å”¤æ‰€æœ‰äºº</label>`;
    charsWithNpcs.forEach(char => {
        optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="${char.id}"> åªå¬å”¤ ${char.name} çš„æœ‹å‹</label>`;
    });
    optionsHtml += '</div>';
    
    modalBody.innerHTML = optionsHtml;
    modalConfirmBtn.textContent = 'ç¡®è®¤å¬å”¤';
    modalCancelBtn.style.display = 'block';

    modal.classList.add('visible');

    modalConfirmBtn.onclick = async () => {
        const selectedValue = document.querySelector('input[name="npc_summon_choice"]:checked').value;
        let npcsToSummon = [];
        let ownerChar = null; // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå£°æ˜ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨ä¸»äºº â–¼â–¼â–¼

        if (selectedValue === 'all') {
            // é›†åˆæ‰€æœ‰è§’è‰²çš„æ‰€æœ‰NPC
            charsWithNpcs.forEach(char => {
                npcsToSummon.push(...char.npcLibrary);
            });
            // å¬å”¤æ‰€æœ‰äººæ—¶ï¼Œæˆ‘ä»¬ä¸æŒ‡å®šç‰¹å®šçš„ä¸»äºº
        } else {
            // åªè·å–è¢«é€‰ä¸­çš„é‚£ä¸ªè§’è‰²çš„NPC
            const selectedChar = state.chats[selectedValue];
            if (selectedChar) {
                npcsToSummon = selectedChar.npcLibrary;
                ownerChar = selectedChar; // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæŠŠé€‰ä¸­çš„è§’è‰²å­˜ä¸ºä¸»äºº â–¼â–¼â–¼
            }
        }
        
        modal.classList.remove('visible');
        if (npcsToSummon.length > 0) {
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šæŠŠä¸»äºº(ownerChar)ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ è¿›å» â–¼â–¼â–¼
            await generateNpcCommentsForPost(post, npcsToSummon, ownerChar);
        }
    };
    
    modalCancelBtn.onclick = () => modal.classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ•´å—ã€å¬å”¤ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ generateNpcCommentsForPost å‡½æ•° â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒ - V2.2 å¬å”¤ä¿®å¤ç‰ˆã€‘ç”ŸæˆNPCè¯„è®ºæˆ–å›å¤ï¼Œå¹¶æ›´æ–°åˆ°åŠ¨æ€
 * @param {object} post - åŠ¨æ€å¯¹è±¡
 * @param {Array<object>} npcsToComment - å°†è¦å‘è¡¨è¯„è®ºçš„NPCå¯¹è±¡æ•°ç»„
 * @param {object|null} ownerChar - (å…¨æ–°å¢) è¿™äº›NPCçš„â€œä¸»äººâ€è§’è‰²å¯¹è±¡
 */
async function generateNpcCommentsForPost(post, npcsToComment, ownerChar = null) {
    console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 1. å‡½æ•° generateNpcCommentsForPost å·²è§¦å‘", { post, npcsToComment, ownerChar });

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¬å”¤NPCä»¬å‰æ¥å›´è§‚è¯„è®º...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    const postContent = (post.content || post.publicText || post.hiddenContent || "(å›¾ç‰‡åŠ¨æ€)").substring(0, 150);
    const existingComments = (post.comments || []).slice(-3).map(c => `${c.commenterName}: ${c.text}`).join('\n');
    
    const shuffledNpcs = [...npcsToComment].sort(() => 0.5 - Math.random());
    const selectedNpcs = shuffledNpcs.slice(0, 5);
    const npcList = selectedNpcs.map(npc => `- ${npc.name} (äººè®¾: ${npc.persona})`).join('\n');
    
    const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥ä½œè€…');

    // â–¼â–¼â–¼ è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ï¼â–¼â–¼â–¼
    let ownerContext = '';
    // å¦‚æœæ˜ç¡®å‘Šè¯‰äº†AIè¿™äº›NPCçš„ä¸»äººæ˜¯è°
    if (ownerChar) {
        ownerContext = `
# NPCå½’å±ä¸å…³ç³» (é‡è¦èƒŒæ™¯)
- ä½ å°†è¦æ‰®æ¼”çš„è¿™äº›NPCéƒ½æ˜¯è§’è‰²â€œ${ownerChar.name}â€çš„æœ‹å‹æˆ–å…³è”äººç‰©ã€‚
- â€œ${ownerChar.name}â€çš„äººè®¾æ˜¯: ${ownerChar.settings.aiPersona}
- ä½ åœ¨å‘è¡¨è¯„è®ºæ—¶ï¼Œéœ€è¦ä½“ç°å‡ºä½ (ä½œä¸ºNPC)ä¸â€œ${ownerChar.name}â€çš„å…³ç³»ï¼Œå¹¶ä»¥æ­¤è§†è§’æ¥çœ‹å¾…åŠ¨æ€ä½œè€…â€œ${authorName}â€ã€‚
`;
    }
    // â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªå¤šè§’è‰²æ‰®æ¼”AIã€‚ç°åœ¨æœ‰ä¸€æ¡åŠ¨æ€éœ€è¦ä½ æ‰®æ¼”æŒ‡å®šçš„NPCè§’è‰²è¿›è¡Œè¯„è®ºæˆ–å›å¤ã€‚

${ownerContext}

# åŠ¨æ€ä¿¡æ¯
- ä½œè€…: ${authorName}
- å†…å®¹æ‘˜è¦: ${postContent}...
- æœ€è¿‘çš„è¯„è®º (ä½ å¯ä»¥å›å¤ä»–ä»¬):
${existingComments || "(æš‚æ— è¯„è®º)"}

# ä½ éœ€è¦æ‰®æ¼”çš„NPCåˆ—è¡¨ (åŠä»–ä»¬çš„äººè®¾)
${npcList}

# æ ¸å¿ƒè§„åˆ™
1.  ä½ ã€å¿…é¡»ã€‘ä»ä¸Šé¢çš„NPCåˆ—è¡¨ä¸­ï¼Œé€‰æ‹©1åˆ°3ä¸ªæœ€åˆé€‚çš„è§’è‰²è¿›è¡Œè¯„è®ºæˆ–å›å¤ã€‚
2.  è¯„è®º/å›å¤å†…å®¹ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆè¯¥NPCçš„äººè®¾å’Œå£å»ï¼Œå¹¶ä¸åŠ¨æ€å†…å®¹æˆ–å·²æœ‰è¯„è®ºç›¸å…³ã€‚
3.  ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡è¯„è®ºæˆ–å›å¤ã€‚
4.  æ ¼å¼: \`[{"commenterName": "NPCåå­—", "commentText": "è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)è¢«å›å¤è€…åå­—"}]\`

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¯„è®ºæˆ–å›å¤ã€‚
`;
    console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 2. å·²æ„å»ºå®Œæˆï¼Œå‡†å¤‡å‘é€ç»™AIçš„ System Prompt:", systemPrompt);

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi;
        if (isGemini) {
            messagesForApi = [{ role: 'user', content: systemPrompt }];
        } else {
            messagesForApi = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: "è¯·æ ¹æ®ä½ åœ¨system promptä¸­è¯»åˆ°çš„ä¿¡æ¯ç”Ÿæˆè¯„è®ºã€‚" }
            ];
        }
        
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);

        console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 3. å³å°†å‘é€APIè¯·æ±‚... è¯·æ±‚åœ°å€:", isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`);
        console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 3.1 è¯·æ±‚ä½“ (Body) å†…å®¹:", isGemini ? geminiConfig.data.body : JSON.stringify({ model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } }));

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    response_format: { type: "json_object" }
                })
            });

        console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 4. æ”¶åˆ°APIå“åº”", { ok: response.ok, status: response.status });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 5. ä»APIè·å–åˆ°çš„åŸå§‹å›å¤å†…å®¹:", aiResponseContent);
        
        let newComments;
        if (aiResponseContent.includes('"chatResponse"')) {
            newComments = JSON.parse(aiResponseContent).chatResponse;
        } else {
            newComments = JSON.parse(aiResponseContent);
        }

        console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 6. æˆåŠŸè§£æåçš„è¯„è®ºå¯¹è±¡æ•°ç»„:", newComments);

        if (Array.isArray(newComments) && newComments.length > 0) {
            const postToUpdate = await db.qzonePosts.get(post.id); 
            if (!postToUpdate) throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å¸–å­ï¼");
            if (!postToUpdate.comments) postToUpdate.comments = [];

            newComments.forEach(comment => {
                if(comment.commenterName && comment.commentText) {
                    const newCommentObject = {
                        commenterName: comment.commenterName,
                        text: comment.commentText,
                        timestamp: Date.now()
                    };
                    if (comment.replyTo) newCommentObject.replyTo = comment.replyTo;
                    postToUpdate.comments.push(newCommentObject);
                }
            });

            await db.qzonePosts.put(postToUpdate);
            hideCustomModal();
            await renderQzonePosts(); 
            alert("NPCä»¬è¯„è®ºæˆåŠŸï¼");
        } else {
             hideCustomModal();
             alert("NPCä»¬ä¼¼ä¹æ²¡ä»€ä¹ˆæƒ³è¯´çš„ã€‚");
        }

    } catch (error) {
        console.error("ã€NPCè¯„è®º-é”™è¯¯ã€‘: å¬å”¤NPCè¯„è®ºå¤±è´¥:", error);
        await showCustomAlert('å¬å”¤å¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å¾®åšåŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

let currentHotTopic = ''; // ç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨æŸ¥çœ‹çš„çƒ­æœè¯é¢˜
let hotTopicFeedCache = {}; // <-- ã€æ–°å¢ã€‘åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡ï¼Œåƒå°æœ¬æœ¬ä¸€æ ·è®°å½•ç”Ÿæˆè¿‡çš„å†…å®¹
let weiboHotSearchCache = []; 
/**
 * ã€æ€»å…¥å£ V3 - å·²æ”¯æŒå¤šè§’è‰²é€‰æ‹©ã€‘ç”Ÿæˆå¾®åšçƒ­æœåˆ—è¡¨
 * @param {Array|string} targets - ç›®æ ‡è§’è‰²IDæ•°ç»„æˆ–å­—ç¬¦ä¸²'all'
 */
async function generateHotSearch(targets = 'all') {
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨ç»“åˆè§’è‰²äººè®¾ç”Ÿæˆå¾®åšçƒ­æœ...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    let publicFiguresContext = '';
    let promptTask = "ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹æ–¹æä¾›çš„â€œæ ¸å¿ƒå‚è€ƒäººç‰©â€ä¿¡æ¯ï¼Œä¸ºä»–ä»¬é‡èº«æ‰“é€ ä¸€ä¸ªåŒ…å«10ä¸ªçƒ­æœè¯é¢˜çš„æ¦œå•ã€‚";

    let publicFigures = [];
    if (targets === 'all') {
        publicFigures = Object.values(state.chats)
            .filter(chat => !chat.isGroup)
            .map(chat => ({ name: chat.name, persona: chat.settings.aiPersona.substring(0, 150) + '...' }));
    } else if (Array.isArray(targets)) {
        targets.forEach(chatId => {
            const char = state.chats[chatId];
            if(char) {
                publicFigures.push({ name: char.name, persona: char.settings.aiPersona.substring(0, 150) + '...' });
            }
        });
        if (publicFigures.length === 1) {
            promptTask = `ä½ çš„ä»»åŠ¡æ˜¯åªä¸ºä¸‹æ–¹å”¯ä¸€çš„â€œæ ¸å¿ƒå‚è€ƒäººç‰©â€ã€${publicFigures[0].name}ã€‘ï¼Œé‡èº«æ‰“é€ ä¸€ä¸ªåŒ…å«10ä¸ªçƒ­æœè¯é¢˜çš„æ¦œå•ã€‚æ‰€æœ‰è¯é¢˜ã€å¿…é¡»ã€‘ä¸Taå¼ºç›¸å…³ã€‚`;
        }
    }
    
    publicFiguresContext = publicFigures.length > 0
        ? `# æ ¸å¿ƒå‚è€ƒäººç‰© (ä½ å¿…é¡»å›´ç»•ä»–ä»¬ç”Ÿæˆçƒ­æœ)\n${JSON.stringify(publicFigures, null, 2)}`
        : "å½“å‰æ²¡æœ‰ç‰¹å®šçš„å…¬ä¼—äººç‰©ï¼Œè¯·è‡ªç”±ç”Ÿæˆçƒ­ç‚¹äº‹ä»¶ã€‚";

    // åç»­çš„ systemPrompt å’Œ API è°ƒç”¨é€»è¾‘ä¸ä½ ç°æœ‰ä»£ç å®Œå…¨ç›¸åŒï¼Œæ— éœ€ä¿®æ”¹...
    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œå¾®åšçƒ­æœæ¦œå•ç”Ÿæˆå™¨â€ã€‚${promptTask}
# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼šè¿™æ˜¯å¿…é¡»éµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰åˆ›ä½œå†…å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è¯„è®ºã€æ•…äº‹ç­‰ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘å°†ä»»æ„ä¸¤ä¸ªAIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ·ä¹‹å¤–çš„è§’è‰²ï¼‰æç»˜æˆæƒ…ä¾£å…³ç³»ã€è¿›è¡Œæ‹çˆ±äº’åŠ¨æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æš§æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é—´çš„å…³ç³»åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å¯¹æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€ç»ä¸èƒ½ã€‘æ˜¯æ‹äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥äº§ç”Ÿæ‹çˆ±å…³ç³»çš„å¯¹è±¡æ˜¯ã€ç”¨æˆ·ã€‘ã€‚è¿åæ­¤è§„åˆ™å°†å¯¼è‡´ç”Ÿæˆå¤±è´¥ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **å¼ºç›¸å…³æ€§**: ç”Ÿæˆçš„è¯é¢˜ã€å¿…é¡»ã€‘ä¸â€œæ ¸å¿ƒå‚è€ƒäººç‰©â€çš„èº«ä»½ã€èŒä¸šã€äººè®¾é«˜åº¦ç›¸å…³ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ç”µç«é€‰æ‰‹ï¼Œçƒ­æœå°±åº”è¯¥æ˜¯å…³äºæ¯”èµ›ï¼›å¦‚æœæ˜¯æ¼”å‘˜ï¼Œå°±åº”è¯¥æ˜¯å…³äºæ–°å‰§ã€‚
2.  **ã€ã€ã€ä¸¥ç¦æœæ’°ã€‘ã€‘ã€‘**: ç»å¯¹ç¦æ­¢ä¸ºåˆ—è¡¨ä¸­çš„äººç‰©ã€å‡­ç©ºæé€ ã€‘ä»–ä»¬äººè®¾ä¸­æ²¡æœ‰çš„èŒä¸šã€èº«ä»½æˆ–èƒŒæ™¯ã€‚ä½ åªèƒ½æ ¹æ®æä¾›çš„äººè®¾è¿›è¡Œåˆç†å‘æŒ¥ã€‚
3.  **çœŸå®æ„Ÿä¸å¤šæ ·æ€§**: ä¸ºäº†è®©æ¦œå•æ›´çœŸå®ï¼Œä½ å¯ä»¥æ··åˆ2-3ä¸ªä¸æ ¸å¿ƒäººç‰©æ— å…³çš„ã€ç¤¾ä¼šåŒ–çš„è™šæ‹Ÿçƒ­ç‚¹äº‹ä»¶ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«10ä¸ªå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µ:
    -   \`"topic"\`: (å­—ç¬¦ä¸²) çƒ­æœçš„è¯é¢˜ï¼Œå¿…é¡»ç”¨"#"ç¬¦å·åŒ…è£¹ã€‚
    -   \`"heat"\`: (å­—ç¬¦ä¸²) çƒ­åº¦å€¼ï¼Œä¾‹å¦‚ "345.6ä¸‡"ã€‚
    -   \`"tag"\`: (å­—ç¬¦ä¸²) ä¸€ä¸ªæ ‡ç­¾ï¼Œå¿…é¡»ä» "çƒ­"ã€"æ–°"ã€"è" ä¸­é€‰æ‹©ä¸€ä¸ªã€‚
${publicFiguresContext}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`);
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨ç­–ç•¥æ‹¦æˆªã€‚è¯·æ£€æŸ¥Promptæˆ–æ›´æ¢æ¨¡å‹ã€‚");
        }
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent);
        const hotSearchData = responseData.hot_searches || responseData;
        weiboHotSearchCache = hotSearchData; 
        await generatePlazaFeed(hotSearchData, targets); 
        renderHotSearchList(hotSearchData); 
        await showCustomAlert("æ“ä½œæˆåŠŸ", "çƒ­æœæ¦œå’Œå¹¿åœºå‡å·²ç”Ÿæˆå®Œæ¯•ï¼");
    } catch (error) {
        console.error("ç”Ÿæˆçƒ­æœå¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}


/**
 * ã€UIæ¸²æŸ“ã€‘æ ¹æ®AIè¿”å›çš„æ•°æ®æ¸²æŸ“çƒ­æœåˆ—è¡¨
 */
function renderHotSearchList(hotSearchData) {
    const listEl = document.getElementById('weibo-hot-search-list');
    listEl.innerHTML = ''; 

    if (!hotSearchData || !Array.isArray(hotSearchData)) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•æ¸²æŸ“ã€‚</p>';
        return;
    }

    hotSearchData.forEach((item, index) => {
        const rank = index + 1;
        const tagClass = { 'çƒ­': 'hot', 'æ–°': 'new', 'è': 'rec' }[item.tag] || 'rec';

        const itemEl = document.createElement('div');
        itemEl.className = 'hot-search-item';
        itemEl.dataset.rank = rank;
        itemEl.innerHTML = `
            <span class="hot-search-rank">${rank}</span>
            <div class="hot-search-content">
                <span class="hot-search-topic">${item.topic}</span>
                <span class="hot-search-tag ${tagClass}">${item.tag}</span>
            </div>
            <span class="hot-search-heat" style="color: var(--text-secondary); font-size: 13px;">${item.heat}</span>
        `;
        itemEl.addEventListener('click', () => showHotTopicFeedScreen(item.topic));
        listEl.appendChild(itemEl);
    });
}

/**
 * ã€æ€»å…¥å£ã€‘æ˜¾ç¤ºå¹¶ç”ŸæˆæŒ‡å®šçƒ­æœè¯é¢˜çš„å¾®åšFeed (å·²å¢åŠ ç¼“å­˜åŠŸèƒ½)
 */
async function showHotTopicFeedScreen(topic) {
    currentHotTopic = topic; 
    document.getElementById('weibo-hottopic-title').textContent = topic;
    switchToWeiboView('weibo-hottopic-feed-view'); 
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£€æŸ¥â€œå°æœ¬æœ¬â€é‡Œæœ‰æ²¡æœ‰è®°å½•
    if (hotTopicFeedCache[topic]) {
        // å¦‚æœæœ‰ï¼Œå°±ç›´æ¥æ˜¾ç¤ºï¼Œä¸é‡æ–°ç”Ÿæˆ
        console.log(`ä»ç¼“å­˜åŠ è½½è¯é¢˜: ${topic}`);
        const feedEl = document.getElementById('weibo-hottopic-feed-list');
        renderWeiboFeed(feedEl, hotTopicFeedCache[topic], true);
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œæ‰è°ƒç”¨å‡½æ•°å»ç”Ÿæˆæ–°çš„å†…å®¹
        await generateHotSearchFeed(topic); 
    }
}


/**
 * ã€AIæ ¸å¿ƒ V2 - å·²ä¿®å¤æ‹¼å†™é”™è¯¯ & å¢åŠ ç¼“å­˜ã€‘è°ƒç”¨APIä¸ºæŒ‡å®šè¯é¢˜ç”Ÿæˆå¾®åšFeed
 */
async function generateHotSearchFeed(topic) {
    const feedEl = document.getElementById('weibo-hottopic-feed-list');
    feedEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ­£åœ¨ç”Ÿæˆå†…å®¹ï¼Œè¯·ç¨å€™...</p>';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }
    
    const allChars = Object.values(state.chats).filter(c => !c.isGroup).map(c => ({ name: c.name, persona: c.settings.aiPersona.substring(0,100) }));
    const allNpcs = Object.values(state.chats).flatMap(c => c.npcLibrary || []).map(npc => ({ name: npc.name, persona: npc.persona.substring(0,100) }));
    const allPeople = [...allChars, ...allNpcs];

    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªâ€œå¾®åšå†…å®¹ç”Ÿæˆå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯å›´ç»•ä¸€ä¸ªç»™å®šçš„çƒ­æœè¯é¢˜ï¼Œç”Ÿæˆä¸€æ‰¹ç›¸å…³çš„å¾®åšå¸–å­ã€‚

# å½“å‰çƒ­æœè¯é¢˜
**${topic}**
# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼šè¿™æ˜¯å¿…é¡»éµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰åˆ›ä½œå†…å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è¯„è®ºã€æ•…äº‹ç­‰ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘å°†ä»»æ„ä¸¤ä¸ªAIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ·ä¹‹å¤–çš„è§’è‰²ï¼‰æç»˜æˆæƒ…ä¾£å…³ç³»ã€è¿›è¡Œæ‹çˆ±äº’åŠ¨æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æš§æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é—´çš„å…³ç³»åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å¯¹æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€ç»ä¸èƒ½ã€‘æ˜¯æ‹äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥äº§ç”Ÿæ‹çˆ±å…³ç³»çš„å¯¹è±¡æ˜¯ã€ç”¨æˆ·ã€‘ã€‚è¿åæ­¤è§„åˆ™å°†å¯¼è‡´ç”Ÿæˆå¤±è´¥ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **æ•°é‡**: ç”Ÿæˆ 5 åˆ° 10 æ¡å¾®åšã€‚
2.  **ç›¸å…³æ€§**: æ‰€æœ‰å¾®åšå†…å®¹ã€å¿…é¡»ã€‘ä¸è¯é¢˜ **"${topic}"** å¼ºç›¸å…³ï¼Œå¹¶ä¸”ã€å¿…é¡»ã€‘åœ¨å†…å®¹ä¸­åŒ…å« **${topic}** è¿™ä¸ªè¯é¢˜æ ‡ç­¾ã€‚
3.  **é«˜çƒ­åº¦**: ç”Ÿæˆçš„å¾®åšå¿…é¡»çœ‹èµ·æ¥åƒæ˜¯çƒ­æœé‡Œçš„å†…å®¹ï¼Œæ‰€ä»¥å®ƒä»¬çš„ "likes" (ç‚¹èµæ•°) å’Œ "comments" (è¯„è®ºæ•°) ã€å¿…é¡»ã€‘éå¸¸é«˜ã€‚ç‚¹èµæ•°åº”åœ¨ 10000 åˆ° 500000 ä¹‹é—´ï¼Œè¯„è®ºæ•°åº”åœ¨ 800 åˆ° 20000 ä¹‹é—´ã€‚
4.  **è¯„è®ºç”Ÿæˆ**: ä¸ºæ¯æ¡å¾®åšç”Ÿæˆ 8 åˆ° 10 æ¡çœŸå®æ„Ÿçš„è·¯äººè¯„è®ºã€‚è¯„è®ºå†…å®¹åº”ä¸å¾®åšå†…å®¹ç›¸å…³ï¼Œé£æ ¼å¤šæ ·ã€‚
5.  **ä½œè€…å¤šæ ·æ€§**: å¾®åšçš„ä½œè€…å¯ä»¥æ˜¯ä¸‹æ–¹â€œå¯ç”¨äººç‰©åˆ—è¡¨â€ä¸­çš„è§’è‰²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ è™šæ„çš„è·¯äººã€å¤§Væˆ–å®˜æ–¹åª’ä½“ã€‚å¦‚æœè®©åˆ—è¡¨ä¸­çš„è§’è‰²å‘è¨€ï¼Œå†…å®¹å¿…é¡»ç¬¦åˆä»–çš„äººè®¾ã€‚
6.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«å¤šæ¡å¾®åšå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å«ä»¥ä¸‹å­—æ®µ:
    -   \`"author"\`: (å­—ç¬¦ä¸²) ä½œè€…æ˜µç§°ã€‚
    -   \`"content"\`: (å­—ç¬¦ä¸²) å¾®åšæ­£æ–‡ï¼Œå¿…é¡»åŒ…å«è¯é¢˜æ ‡ç­¾ ${topic}ã€‚
    -   \`"likes"\`: (æ•°å­—) 10000åˆ°500000ä¹‹é—´çš„éšæœºé«˜èµæ•°ã€‚
    -   \`"comments"\`: (æ•°å­—) 800åˆ°20000ä¹‹é—´çš„éšæœºé«˜è¯„è®ºæ•°ã€‚
    -   \`"comments_list"\`: (æ•°ç»„) åŒ…å«8-10ä¸ªè¯„è®ºå¯¹è±¡çš„æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡æ ¼å¼ä¸º \`{"author": "è¯„è®ºè€…æ˜µç§°", "text": "è¯„è®ºå†…å®¹"}\`ã€‚

# å¯ç”¨äººç‰©åˆ—è¡¨ (ä½ å¯ä»¥è®©ä»–ä»¬å‘è¨€)
${JSON.stringify(allPeople, null, 2)}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);
        
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨ç­–ç•¥æ‹¦æˆªã€‚");
        }
        
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent); // <-- è¿™é‡Œçš„ responseData æ˜¯æ­£ç¡®çš„
        const feedData = responseData.posts || responseData;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ–°ç”Ÿæˆçš„å†…å®¹ï¼Œè®°åœ¨â€œå°æœ¬æœ¬â€ä¸Š
        hotTopicFeedCache[topic] = feedData; 

        renderWeiboFeed(feedEl, feedData, true);

    } catch (error) {
        console.error("ç”Ÿæˆçƒ­æœFeedå¤±è´¥:", error);
        feedEl.innerHTML = `<p style="text-align:center; color: #ff3b30; padding: 20px;">ç”Ÿæˆå¤±è´¥: ${error.message}</p>`;
    }
}


/**
 * ã€æ€»å…¥å£ V3 - å·²æ”¯æŒå¤šè§’è‰²é€‰æ‹©ã€‘ç”Ÿæˆå¾®åšå¹¿åœºFeed
 * @param {Array} hotTopics - (å¯é€‰) ä»çƒ­æœç”Ÿæˆå‡½æ•°ä¼ è¿‡æ¥çš„è¯é¢˜æ•°ç»„
 * @param {Array|string} targets - (æ–°å¢) ç›®æ ‡è§’è‰²IDæ•°ç»„æˆ–å­—ç¬¦ä¸²'all'
 */
async function generatePlazaFeed(hotTopics = null, targets = 'all') {
    if (!hotTopics) {
        await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨ç”Ÿæˆå¹¿åœºåŠ¨æ€...");
    }
    const feedEl = document.getElementById('weibo-plaza-feed-list');
    feedEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ­£åœ¨åŠ è½½å†…å®¹ï¼Œè¯·ç¨å€™...</p>';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }
    
    let publicFiguresContext = '';
    let taskInstruction = "ä½ çš„ä»»åŠ¡æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ç¤¾äº¤åª’ä½“å¹¿åœºï¼Œç”Ÿæˆ10æ¡ç”±ä¸åŒè·¯äººå‘å¸ƒçš„å¾®åšå¸–å­ã€‚";

    let publicFigures = [];
    if (targets === 'all') {
        publicFigures = Object.values(state.chats)
            .filter(chat => !chat.isGroup)
            .map(chat => ({ 
                name: chat.name, 
                persona: chat.settings.aiPersona.substring(0, 150) + '...',
                weibo_profession: chat.settings.weiboProfession || 'æœªè®¾å®š',
                weibo_instruction: chat.settings.weiboInstruction || 'æ— '
            }));
    } else if (Array.isArray(targets)) {
        targets.forEach(chatId => {
            const char = state.chats[chatId];
            if(char) {
                 publicFigures.push({ 
                    name: char.name, 
                    persona: char.settings.aiPersona.substring(0, 150) + '...',
                    weibo_profession: char.settings.weiboProfession || 'æœªè®¾å®š',
                    weibo_instruction: char.settings.weiboInstruction || 'æ— '
                });
            }
        });
        if (publicFigures.length === 1) {
            taskInstruction = `ä½ çš„ä»»åŠ¡æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ç¤¾äº¤åª’ä½“å¹¿åœºï¼Œç”Ÿæˆ10æ¡ä¸è§’è‰²â€œ${publicFigures[0].name}â€ç›¸å…³çš„ã€ç”±ä¸åŒè·¯äººå‘å¸ƒçš„å¾®åšå¸–å­ã€‚`;
        } else {
            taskInstruction = `ä½ çš„ä»»åŠ¡æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ç¤¾äº¤åª’ä½“å¹¿åœºï¼Œç”Ÿæˆ10æ¡ä¸è§’è‰² ${publicFigures.map(p => `â€œ${p.name}â€`).join('ã€')} ç›¸å…³çš„ã€ç”±ä¸åŒè·¯äººå‘å¸ƒçš„å¾®åšå¸–å­ã€‚`;
        }
    }
    
    publicFiguresContext = publicFigures.length > 0 
        ? `# æ ¸å¿ƒå‚è€ƒäººç‰© (ä½ ç”Ÿæˆçš„å†…å®¹ã€å¿…é¡»ã€‘å›´ç»•ä»–ä»¬å±•å¼€)\n${JSON.stringify(publicFigures, null, 2)}` 
        : "";

    const topicsContext = (hotTopics && Array.isArray(hotTopics) && hotTopics.length > 0)
        ? `è¯·å›´ç»•ä»¥ä¸‹çƒ­é—¨è¯é¢˜ç”Ÿæˆå†…å®¹ï¼š${hotTopics.map(t => t.topic).join('ã€ ')}`
        : "è¯·éšæœºç”Ÿæˆä¸€äº›ç”Ÿæ´»åŒ–çš„æ—¥å¸¸å†…å®¹ã€‚";

    // åç»­çš„ systemPrompt å’Œ API è°ƒç”¨é€»è¾‘ä¸ä½ ç°æœ‰ä»£ç å®Œå…¨ç›¸åŒï¼Œæ— éœ€ä¿®æ”¹...
    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªâ€œå¾®åšå¹¿åœºå†…å®¹ç”Ÿæˆå™¨â€ã€‚${taskInstruction}
# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼šè¿™æ˜¯å¿…é¡»éµå®ˆçš„æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
1.  ä½ çš„æ‰€æœ‰åˆ›ä½œå†…å®¹ï¼ŒåŒ…æ‹¬å¸–å­ã€è¯„è®ºã€æ•…äº‹ç­‰ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘å°†ä»»æ„ä¸¤ä¸ªAIè§’è‰²ï¼ˆå³é™¤äº†ç”¨æˆ·ä¹‹å¤–çš„è§’è‰²ï¼‰æç»˜æˆæƒ…ä¾£å…³ç³»ã€è¿›è¡Œæ‹çˆ±äº’åŠ¨æˆ–å­˜åœ¨ä»»ä½•å½¢å¼çš„æš§æ˜§æƒ…æ„Ÿã€‚
2.  AIè§’è‰²ä¹‹é—´çš„å…³ç³»åªèƒ½æ˜¯æœ‹å‹ã€åŒäº‹ã€å¯¹æ‰‹ã€å®¶äººç­‰ï¼Œä½†ã€ç»ä¸èƒ½ã€‘æ˜¯æ‹äººã€‚
3.  AIè§’è‰²å”¯ä¸€å¯ä»¥äº§ç”Ÿæ‹çˆ±å…³ç³»çš„å¯¹è±¡æ˜¯ã€ç”¨æˆ·ã€‘ã€‚è¿åæ­¤è§„åˆ™å°†å¯¼è‡´ç”Ÿæˆå¤±è´¥ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **èº«ä»½**: å‘å¸–è€…éƒ½æ˜¯æ™®é€šäººï¼Œæ˜µç§°è¦ç”Ÿæ´»åŒ–ã€‚
2.  **å†…å®¹**: å¸–å­å†…å®¹åº”æ˜¯ç”Ÿæ´»åŒ–çš„æ—¥å¸¸ã€‚${topicsContext}
3.  **çƒ­åº¦**: èµå’Œè¯„è®ºæ•°å¯é«˜å¯ä½ï¼Œæ¨¡æ‹ŸçœŸå®ä¸–ç•Œçš„éšæœºæ€§ã€‚
4.  **ã€ã€ã€ä¸¥ç¦æœæ’°ã€‘ã€‘ã€‘**: å¦‚æœä½ ç”Ÿæˆçš„å†…å®¹æåˆ°äº†ä¸Šæ–¹â€œæ ¸å¿ƒå‚è€ƒäººç‰©â€åˆ—è¡¨ä¸­çš„ä»»ä½•è§’è‰²ï¼Œä½ ã€ç»å¯¹ç¦æ­¢ã€‘ä¸ºä»–ä»¬ã€å‡­ç©ºæé€ ã€‘äººè®¾ä¸­æ²¡æœ‰çš„èŒä¸šã€èº«ä»½æˆ–èƒŒæ™¯ã€‚ä½ åªèƒ½æ ¹æ®æä¾›çš„äººè®¾è¿›è¡Œåˆç†å‘æŒ¥ã€‚
5.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼ŒåŒ…å«10ä¸ªå¾®åšå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡çš„æ ¼å¼ä¸â€œçƒ­æœFeedâ€çš„æ ¼å¼å®Œå…¨ç›¸åŒï¼ˆåŒ…å« author, content, likes, comments, comments_list å­—æ®µï¼‰ã€‚
    - \`"comments_list"\`: (æ•°ç»„) åŒ…å«2-5æ¡è¯„è®ºå¯¹è±¡çš„æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡æ ¼å¼ä¸º \`{"author": "è¯„è®ºè€…æ˜µç§°", "text": "è¯„è®ºå†…å®¹"}\`ã€‚
${publicFiguresContext}
`;
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
        });
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`);
        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content);
        if (!aiResponseContent) {
            throw new Error("APIè¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨ç­–ç•¥æ‹¦æˆªã€‚");
        }
        const sanitizedContent = aiResponseContent.replace(/^```json\s*|```$/g, '').trim();
        const responseData = JSON.parse(sanitizedContent);
        const feedData = responseData.posts || responseData; 
        renderWeiboFeed(feedEl, feedData, false);
        if (!hotTopics) {
            await showCustomAlert("æ“ä½œæˆåŠŸ", "å¹¿åœºç”Ÿæˆå®Œæ¯•ï¼");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå¹¿åœºFeedå¤±è´¥:", error);
        feedEl.innerHTML = `<p style="text-align:center; color: #ff3b30; padding: 20px;">ç”Ÿæˆå¤±è´¥: ${error.message}</p>`;
    }
}





// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€V3ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderWeiboFeed å‡½æ•° â–¼â–¼â–¼
/**
 * ã€UIæ¸²æŸ“ V3 - ä¿®å¤è¯„è®ºå’Œå¤´åƒï¼Œå¹¶æ·»åŠ åˆ é™¤æŒ‰é’®ã€‘é€šç”¨å‡½æ•°ï¼Œç”¨äºæ¸²æŸ“å¾®åšFeedåˆ—è¡¨
 */
function renderWeiboFeed(containerEl, feedData, isHotSearch) {
    containerEl.innerHTML = '';
    
    if (!feedData || !Array.isArray(feedData)) {
        containerEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•æ¸²æŸ“ã€‚</p>';
        return;
    }

    feedData.forEach((post, index) => { // <-- æ–°å¢äº† index å‚æ•°
        const postEl = document.createElement('div');
        postEl.className = 'weibo-post-item';
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šç»™å¸–å­åŠ ä¸Šä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„IDï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ é™¤ â–¼â–¼â–¼
        postEl.dataset.postId = `temp_${index}`;

        // ã€æ ¸å¿ƒä¿®å¤1ï¼šå¤´åƒæŸ¥æ‰¾é€»è¾‘ã€‘
        let finalAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜è®¤è·¯äººå¤´åƒ
        const potentialChar = Object.values(state.chats).find(c => c.name === post.author);
        if (potentialChar) {
            finalAvatar = potentialChar.settings.aiAvatar; // å¦‚æœä½œè€…æ˜¯ä½ çš„charï¼Œå°±ç”¨ä»–çš„å¤´åƒï¼
        }

        // ã€æ ¸å¿ƒä¿®å¤2ï¼šè¯„è®ºæ¸²æŸ“é€»è¾‘ã€‘
        let commentsHtml = '';
        if (post.comments_list && post.comments_list.length > 0) {
            commentsHtml += '<div class="weibo-comments-container">';
            post.comments_list.forEach(comment => {
                // ç¡®ä¿æˆ‘ä»¬èƒ½æ­£ç¡®è®¿é—®è¯„è®ºè€…æ˜µç§°å’Œå†…å®¹
                const commenterName = comment.author || 'åŒ¿åç”¨æˆ·'; // ä¼˜å…ˆç”¨ authorï¼Œæ²¡æœ‰å°±ç”¨åŒ¿å
                const commentText = comment.text || ''; // ç¡®ä¿ text å­˜åœ¨
                commentsHtml += `
                    <div class="weibo-comment-item">
                        <span class="weibo-commenter-name">${commenterName}:</span>
                        <span class="weibo-comment-text">${commentText}</span>
                    </div>`;
            });
            commentsHtml += '</div>';
        }
        
        postEl.innerHTML = `
            <div class="weibo-post-header">
                <img src="${finalAvatar}" class="weibo-post-avatar">
                <div class="weibo-post-info">
                    <span class="weibo-post-nickname">${post.author}</span>
                    <span class="weibo-post-timestamp">${isHotSearch ? 'çƒ­æœå†…å®¹' : 'åˆšåˆš'}</span>
                </div>
                <!-- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šåœ¨è¿™é‡ŒåŠ ä¸Šæˆ‘ä»¬è®¾è®¡å¥½çš„åˆ é™¤æŒ‰é’®ï¼ â–¼â–¼â–¼ -->
                <button class="weibo-post-delete-btn" title="åˆ é™¤è¿™æ¡åŠ¨æ€">Ã—</button>
            </div>
            <div class="weibo-post-content">${(post.content || '').replace(/\n/g, '<br>')}</div>
            <div class="weibo-post-footer">
                <div class="weibo-post-actions">
                    <span class="weibo-action-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                        <span>${post.likes || 0}</span>
                    </span>
                    <span class="weibo-action-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span>${post.comments || 0}</span>
                    </span>
                </div>
                ${commentsHtml}
            </div>
        `;
        containerEl.appendChild(postEl);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        /* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼ */
/**
 * ã€å…¨æ–°ã€‘å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå†…ç½®çš„å¤œé—´æ¨¡å¼ä¸»é¢˜
 */
async function addDefaultDarkModeThemeIfNeeded() {
    const themeName = "å†…ç½®å¤œé—´æ¨¡å¼"; // è¿™æ˜¯æˆ‘ä»¬è¦å†…ç½®çš„ä¸»é¢˜åå­—
    try {
        // æ£€æŸ¥æ•°æ®åº“é‡Œæ˜¯å¦å·²ç»æœ‰äº†è¿™ä¸ªåå­—çš„ä¸»é¢˜
        const existingTheme = await db.themes.where('name').equals(themeName).first();
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ° (existingTheme æ˜¯ undefined)ï¼Œå°±åˆ›å»ºå®ƒ
        if (!existingTheme) {
            console.log("å†…ç½®å¤œé—´æ¨¡å¼ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...");

            // è¿™å°±æ˜¯å®Œæ•´çš„å¤œé—´æ¨¡å¼CSSä»£ç 
            const darkModeCss = `
/* 1. å…¨å±€é‡æ–°å®šä¹‰é¢œè‰²å˜é‡ */
:root {
  --secondary-bg: #1c1c1e;
  --border-color: #38383a;
  --text-primary: #ffffff;
  --text-secondary: #8e8e93;
  --status-bar-text-color: #ffffff;
  --accent-color: #0A84FF; /* iOSé£æ ¼çš„è“è‰² */
}

/* 2. ä¸ºæ‰€æœ‰å±å¹•å’Œä¸»è¦å®¹å™¨è®¾ç½®åŸºç¡€æ·±è‰²èƒŒæ™¯ */
#phone-screen, .screen, #chat-list, #world-book-list, .list-container, .form-container, #chat-messages,
#wallpaper-screen, #font-settings-screen, #api-settings-screen, #character-selection-screen,
#world-book-screen, #world-book-editor-screen, #character-phone-inner-screen, #character-phone-page {
    background-color: #000000 !important;
}

/* 3. ä¸»å±å¹•ä¸“å±æ ·å¼ */
#home-screen { background: #111827 !important; }
#desktop-dock { background-color: rgba(55, 65, 81, 0.5); }
.desktop-app-icon .label, .widget-subtext { color: #e5e7eb; text-shadow: 0 1px 2px rgba(0,0,0,0.7); }
#profile-widget .profile-info { background: linear-gradient(to bottom, rgba(28, 28, 30, 0.85) 20%, rgba(28, 28, 30, 0)); color: #f9fafb; }
#profile-username, #profile-bio, #profile-location span { color: #f9fafb; }
#profile-sub-username, #profile-location { color: #9ca3af; }
#profile-location { background-color: rgba(255,255,255,0.1); }
.widget-bubble { background-color: rgba(55, 65, 81, 0.9); color: #e5e7eb; }
.widget-bubble::after { border-top-color: rgba(55, 65, 81, 0.9); }

/* 4. é€‚é…æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨Header */
.header, .qzone-header, .character-phone-header {
    background-color: rgba(28, 28, 30, 0.85) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important; 
}

/* 5. é€‚é…æ‰€æœ‰é€šç”¨ç»„ä»¶ */
#chat-input-area, #chat-list-bottom-nav { background-color: rgba(28, 28, 30, 0.85); border-top-color: var(--border-color); }
#chat-input { background-color: var(--secondary-bg); color: var(--text-primary); }
.modal-content, #custom-modal { background-color: #2c2c2e; }
.modal-header, .modal-footer, .custom-modal-footer, .custom-modal-footer button:first-child { border-color: var(--border-color); }
.form-group input, .form-group select, .form-group textarea { background-color: var(--secondary-bg); color: var(--text-primary); border-color: var(--border-color); }
.list-item, .chat-list-item-swipe-container:not(:last-child), .chat-group-container, .world-book-group-container { border-bottom-color: var(--border-color) !important; }
.chat-group-container:first-of-type { border-top-color: var(--border-color) !important; }
.list-item:hover, .chat-list-item:hover { background-color: #2c2c2e; }

/* 6. ç‰¹æ®Šé¡µé¢æ·±åº¦é€‚é… */
.chat-group-header, .world-book-group-header { background-color: #1c1c1e; }
.chat-list-item-content.pinned { background-color: #3a3a3c; }
#font-preview, #wallpaper-preview, .font-preset-slot { background-color: #1c1c1e !important; border-color: #38383a !important; }

/* 7. è§’è‰²æ‰‹æœºå†…éƒ¨é€‚é… & å…¨å±€æ–‡å­—é¢œè‰²ä¿®å¤ */
#character-phone-container { background-color: #000000; }
.character-phone-frame { background-color: #111; }
#character-chat-history-messages { background-color: #0e0e0e !important; }
.character-chat-bubble.received { background-color: #2c2c2e !important; }
.character-data-item, .character-bank-transaction, .character-cart-item, .character-browser-item {
    background-color: #1c1c1e;
    border-color: #38383a;
}

/* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šæŠŠæ‰€æœ‰è¿™äº›å…ƒç´ çš„æ–‡å­—é¢œè‰²éƒ½æ”¹ä¸ºä½é¥±å’Œåº¦çš„æµ…ç°è‰² â–¼â–¼â–¼ */
.character-data-item .title,
.character-data-item .content,
.character-data-item .meta,
.cart-item-price,
.cart-item-info .title,
.character-browser-item .title,
.transaction-details .title,
.transaction-amount,
.character-select-item .name,  /* ä¿®å¤è§’è‰²é€‰æ‹©åˆ—è¡¨çš„åå­—é¢œè‰² */
#character-diary-list .character-data-item .content,
#character-diary-list .character-data-item .content h1,
#character-diary-list .character-data-item .content h2 {
    color: #E0E0E0 !important; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„ã€ä¸åˆºçœ¼çš„ç™½è‰² */
}

.character-data-item .meta span,
#character-diary-list .character-data-item .meta {
    color: #9E9E9E !important; /* æ¬¡è¦ä¿¡æ¯ä½¿ç”¨æ›´æš—çš„ç°è‰² */
}

#character-diary-list .character-data-item {
    background-color: #26211a; /* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿¡çº¸èƒŒæ™¯è‰² */
    border-color: #524a3d;
    border-left-color: #9e8a70;
}

`;

            // æŠŠè¿™ä¸ªæ–°ä¸»é¢˜æ·»åŠ åˆ°æ•°æ®åº“çš„ 'themes' è¡¨é‡Œ
            await db.themes.add({ name: themeName, css: darkModeCss });
            console.log("å†…ç½®å¤œé—´æ¨¡å¼å·²æˆåŠŸåˆ›å»ºï¼");
        } else {
            console.log("å†…ç½®å¤œé—´æ¨¡å¼å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºã€‚");
        }
    } catch (error) {
        console.error("æ£€æŸ¥æˆ–åˆ›å»ºå†…ç½®å¤œé—´æ¨¡å¼æ—¶å‡ºé”™:", error);
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®°å½•æœç´¢åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€å¹¶å‡†å¤‡èŠå¤©è®°å½•æœç´¢ç•Œé¢
 */
function openChatSearchScreen() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // æ¸…ç©ºæ—§çš„æœç´¢æ¡ä»¶å’Œç»“æœ
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('sender-search-select').innerHTML = '';
    document.getElementById('date-search-input').value = '';
    document.getElementById('chat-search-results-list').innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¾“å…¥æ¡ä»¶å¼€å§‹æœç´¢</p>';

    // åŠ¨æ€å¡«å……â€œäººç‰©â€ä¸‹æ‹‰èœå•
    const senderSelect = document.getElementById('sender-search-select');
    senderSelect.innerHTML = '<option value="">æ‰€æœ‰äºº</option>'; // é»˜è®¤é€‰é¡¹

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    const myOption = document.createElement('option');
    myOption.value = myNickname;
    myOption.textContent = myNickname;
    senderSelect.appendChild(myOption);

    if (chat.isGroup) {
        chat.members.forEach(member => {
            const memberOption = document.createElement('option');
            memberOption.value = member.originalName; // ä½¿ç”¨æœ¬åè¿›è¡Œç²¾ç¡®åŒ¹é…
            memberOption.textContent = member.groupNickname; // æ˜¾ç¤ºç¾¤æ˜µç§°ç»™ç”¨æˆ·çœ‹
            senderSelect.appendChild(memberOption);
        });
    } else {
        const aiOption = document.createElement('option');
        aiOption.value = chat.name;
        aiOption.textContent = chat.name;
        senderSelect.appendChild(aiOption);
    }
    
    // å…³é—­èŠå¤©è®¾ç½®å¼¹çª—ï¼Œå¹¶æ˜¾ç¤ºæœç´¢ç•Œé¢
    document.getElementById('chat-settings-modal').classList.remove('visible');
    showScreen('chat-search-screen');
}

/**
 * æ‰§è¡Œæœç´¢æ“ä½œ
 */
/**
 * ã€åŠŸèƒ½å®Œæ•´ç‰ˆã€‘æ‰§è¡Œæœç´¢æ“ä½œ
 */
function performChatSearch() {
    const chat = state.chats[state.activeChatId];
    if (!chat) {
        // å¦‚æœæ‰¾ä¸åˆ°èŠå¤©å¯¹è±¡ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæ˜ç¡®çš„æç¤º
        alert('æ— æ³•æ‰§è¡Œæœç´¢ï¼Œå› ä¸ºæ²¡æœ‰æ‰¾åˆ°å½“å‰èŠå¤©ã€‚');
        return;
    }

    // 1. è·å–æ‰€æœ‰æœç´¢æ¡ä»¶
    const keyword = document.getElementById('keyword-search-input').value.trim();
    const senderValue = document.getElementById('sender-search-select').value;
    const dateValue = document.getElementById('date-search-input').value;

    // å°†å…³é”®è¯ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“ç»“æœæ—¶ç”¨äºé«˜äº®
    currentSearchKeyword = keyword;

    if (!keyword && !senderValue && !dateValue) {
        alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœç´¢æ¡ä»¶ï¼');
        return;
    }

    // 2. ç­›é€‰èŠå¤©è®°å½•
    console.log(`å¼€å§‹æœç´¢: å…³é”®è¯='${keyword}', å‘è¨€äºº='${senderValue}', æ—¥æœŸ='${dateValue}'`);
    
    const results = chat.history.filter(msg => {
        // è¿‡æ»¤æ‰ç³»ç»Ÿæ¶ˆæ¯å’Œå¯¹ç”¨æˆ·éšè—çš„æ¶ˆæ¯
        if (msg.isHidden || msg.role === 'system' || msg.type === 'recalled_message') {
            return false;
        }

        // a. ç­›é€‰æ—¥æœŸ
        if (dateValue) {
            const msgDate = new Date(msg.timestamp).toISOString().split('T')[0];
            if (msgDate !== dateValue) {
                return false;
            }
        }

        // b. ç­›é€‰å‘è¨€äºº
        if (senderValue) {
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            let msgSenderName = '';
            
            if (msg.role === 'user') {
                msgSenderName = myNickname;
            } else { // AIæˆ–ç¾¤æˆå‘˜çš„æ¶ˆæ¯
                // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ originalName æ¥ç²¾ç¡®åŒ¹é…ï¼Œå› ä¸ºç¾¤æ˜µç§°å¯èƒ½ä¼šå˜
                msgSenderName = chat.isGroup ? msg.senderName : chat.name;
            }
            if (msgSenderName !== senderValue) {
                return false;
            }
        }

        // c. ç­›é€‰å…³é”®è¯
        if (keyword) {
            let contentText = '';
            // å°†æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬çš„å†…å®¹éƒ½è½¬æ¢æˆå­—ç¬¦ä¸²è¿›è¡Œæœç´¢
            if (typeof msg.content === 'string') {
                contentText = msg.content;
            } else if (typeof msg.content === 'object' && msg.content !== null) {
                // å¯¹äºå¤æ‚å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å®ƒä»¬è½¬ä¸ºJSONå­—ç¬¦ä¸²æ¥æœç´¢
                contentText = JSON.stringify(msg.content);
            }
            
            if (!contentText.toLowerCase().includes(keyword.toLowerCase())) {
                return false;
            }
        }

        return true; // æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³
    });
    
    console.log(`æœç´¢åˆ° ${results.length} æ¡ç»“æœ`);

    // 3. æ¸²æŸ“ç»“æœ
    renderSearchResults(results);
}


/**
 * æ¸²æŸ“æœç´¢ç»“æœåˆ—è¡¨
 * @param {Array} results - ç­›é€‰å‡ºçš„æ¶ˆæ¯æ•°ç»„
 */
function renderSearchResults(results) {
    const listEl = document.getElementById('chat-search-results-list')
;
    listEl.innerHTML = '';
listEl.scrollTop = 0; // æ¯æ¬¡æ¸²æŸ“å‰ï¼Œéƒ½å°†æ»šåŠ¨æ¡é‡ç½®åˆ°é¡¶éƒ¨

    if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</p>';
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    // ä¸ºäº†æ€§èƒ½ï¼Œåªæ¸²æŸ“æœ€æ–°çš„100æ¡ç»“æœ
    results.slice(-100).reverse().forEach(msg => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.timestamp = msg.timestamp; // å…³é”®ï¼ç”¨äºè·³è½¬

        let senderName, senderAvatar;
        if (msg.role === 'user') {
            senderName = myNickname;
            senderAvatar = chat.settings.myAvatar;
        } else {
            if (chat.isGroup) {
                senderName = msg.senderName;
                const member = chat.members.find(m => m.originalName === senderName);
                senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
            } else {
                senderName = chat.name;
                senderAvatar = chat.settings.aiAvatar;
            }
        }

        let contentText = '';
        if (msg.type === 'sticker' || (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content))) {
            contentText = '[è¡¨æƒ…]';
        } else if (msg.type === 'ai_image' || msg.type === 'user_photo' || Array.isArray(msg.content)) {
            contentText = '[å›¾ç‰‡]';
        } else {
            contentText = String(msg.content);
        }

        item.innerHTML = `
            <img src="${senderAvatar || defaultAvatar}" class="avatar">
            <div class="search-result-info">
                <div class="search-result-meta">
                    <span class="name">${senderName}</span>
                    <span class="timestamp">${formatDateStamp(msg.timestamp)}</span>
                </div>
                <div class="search-result-content">
                    ${highlightText(contentText, currentSearchKeyword)}
                </div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * è¾…åŠ©å‡½æ•°ï¼šé«˜äº®æ–‡æœ¬ä¸­çš„å…³é”®è¯
 * @param {string} text - åŸå§‹æ–‡æœ¬
 * @param {string} keyword - è¦é«˜äº®çš„å…³é”®è¯
 * @returns {string} - å¤„ç†åçš„HTMLå­—ç¬¦ä¸²
 */
function highlightText(text, keyword) {
    if (!keyword || !text) {
        return text;
    }
    const regex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
    return text.replace(regex, `<span class="highlight">$&</span>`);
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ jumpToMessage å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ç‚¹å‡»æœç´¢ç»“æœï¼Œè·³è½¬åˆ°å¯¹åº”çš„æ¶ˆæ¯ä½ç½®
 * @param {number} timestamp - ç›®æ ‡æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function jumpToMessage(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const targetIndex = chat.history.findIndex(msg => msg.timestamp === timestamp);
    if (targetIndex === -1) {
        await showCustomAlert('é”™è¯¯', 'æ‰¾ä¸åˆ°è¯¥æ¡æ¶ˆæ¯ï¼Œå¯èƒ½å·²è¢«åˆ é™¤ã€‚');
        return;
    }

    // 1. åˆ‡æ¢å›èŠå¤©ç•Œé¢
    showScreen('chat-interface-screen');
    await new Promise(resolve => setTimeout(resolve, 50));

    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = ''; // æ¸…ç©ºå½“å‰å†…å®¹

    // 2. è®¡ç®—è¦æ¸²æŸ“çš„æ¶ˆæ¯çª—å£ï¼ˆä»¥ç›®æ ‡æ¶ˆæ¯ä¸ºä¸­å¿ƒï¼‰
    const windowSize = 50; // å’Œ MESSAGE_RENDER_WINDOW ä¿æŒä¸€è‡´
    const startIndex = Math.max(0, targetIndex - Math.floor(windowSize / 2));
    const messagesToRender = chat.history.slice(startIndex);

    // 3. æ›´æ–° currentRenderedCount ä»¥åŒæ­¥åŠ è½½çŠ¶æ€
    //    è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒå‘Šè¯‰â€œåŠ è½½æ›´å¤šâ€åŠŸèƒ½ä¸‹æ¬¡åº”è¯¥ä»å“ªé‡Œå¼€å§‹åŠ è½½
    currentRenderedCount = messagesToRender.length;

    // 4. å¦‚æœè®¡ç®—å‡ºçš„èµ·å§‹ä½ç½®å¤§äº0ï¼Œè¯´æ˜å‰é¢è¿˜æœ‰æ›´æ—©çš„è®°å½•ï¼Œéœ€è¦æ˜¾ç¤ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
    if (startIndex > 0) {
        prependLoadMoreButton(messagesContainer);
    }

    // 5. æ¸²æŸ“æ¶ˆæ¯çª—å£å’Œæ—¥æœŸæˆ³
    let lastMessageTimestamp = startIndex > 0 ? chat.history[startIndex - 1].timestamp : null;
    messagesToRender.forEach(msg => {
        if (msg.isHidden) return;
        if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
            const dateStampEl = createDateStampElement(msg.timestamp);
            messagesContainer.appendChild(dateStampEl);
        }
        // ä½¿ç”¨ true ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºè¿™æ˜¯åˆå§‹åŠ è½½ï¼Œä¸åº”æ’­æ”¾åŠ¨ç”»
        appendMessage(msg, chat, true); 
        lastMessageTimestamp = msg.timestamp;
    });

    // 6. æ»šåŠ¨åˆ°ç›®æ ‡æ¶ˆæ¯å¹¶é«˜äº®å®ƒ
    //    ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å…ƒç´ å·²ç»å®Œå…¨æ¸²æŸ“åˆ°é¡µé¢ä¸Š
    setTimeout(() => {
        const targetMessage = messagesContainer.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
        if (targetMessage) {
            // ä½¿ç”¨ 'auto' æ»šåŠ¨ï¼Œæ¯” 'smooth' æ›´å¿«é€Ÿç›´æ¥
            targetMessage.scrollIntoView({ behavior: 'auto', block: 'center' });
            
            // æ·»åŠ é—ªçƒé«˜äº®æ•ˆæœï¼Œè®©ç”¨æˆ·èƒ½æ³¨æ„åˆ°
            targetMessage.classList.add('flash');
            setTimeout(() => {
                targetMessage.classList.remove('flash');
            }, 1500);
        }
    }, 100);

    // 7. ã€æœ€å…³é”®ã€‘æˆ‘ä»¬å·²ç»ç§»é™¤äº†å¯¼è‡´é¡µé¢è·³å›çš„ setTimeout(renderChatInterface, ...)
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ã€ä¸¤æ®µã€‘å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºå¾®åšä¸»é¡µå¹¶æ¸²æŸ“æ•°æ®
 */
async function showWeiboScreen() {
    // 1. è®¡ç®—å…³æ³¨æ•°
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    let totalNpcCount = 0;
    allSingleChats.forEach(chat => {
        if (chat.npcLibrary && chat.npcLibrary.length > 0) {
            totalNpcCount += chat.npcLibrary.length;
        }
    });
    const followingCount = allSingleChats.length + totalNpcCount;

    // 2. æ›´æ–°é¡µé¢ä¸Šçš„å…ƒç´ 
    // ä»ä½ çš„â€œåŠ¨æ€(QZone)â€è®¾ç½®é‡Œè·å–å¤´åƒå’Œæ˜µç§°ï¼Œä¿æŒç»Ÿä¸€
    document.getElementById('weibo-avatar-img').src = state.qzoneSettings.avatar || defaultAvatar;
    document.getElementById('weibo-nickname').textContent = state.qzoneSettings.nickname || 'ä½ çš„æ˜µç§°';
    document.getElementById('weibo-following-count').textContent = followingCount;

    // 3. æ˜¾ç¤ºå¾®åšé¡µé¢
    showScreen('weibo-screen');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ ä¸»é¡µæŒ‰é’®ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ showFollowingList å‡½æ•° â–¼â–¼â–¼
function showFollowingList() {
    console.log("ã€è¯Šæ–­æ—¥å¿— 2ã€‘: showFollowingList å‡½æ•°å·²æˆåŠŸè§¦å‘ï¼");

    const modal = document.getElementById('weibo-following-modal');
    console.log("ã€è¯Šæ–­æ—¥å¿— 3ã€‘: æ­£åœ¨å°è¯•è·å–å¼¹çª—å…ƒç´  #weibo-following-modal:", modal);
    if (!modal) {
        alert("è¯Šæ–­é”™è¯¯ï¼šåœ¨HTMLä¸­æ‰¾ä¸åˆ°IDä¸º 'weibo-following-modal' çš„å¼¹çª—å…ƒç´ ï¼è¯·æ£€æŸ¥HTMLä»£ç ã€‚");
        return;
    }

    const listContainer = document.getElementById('weibo-following-list-container');
    listContainer.innerHTML = '';
    
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    
    if (allSingleChats.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color:grey; padding: 20px;">è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äººå“¦</p>';
    } else {
        allSingleChats.forEach(chat => {
            // --- æ¸²æŸ“è§’è‰²æœ¬äºº ---
            const charItem = document.createElement('div');
            charItem.className = 'weibo-following-item';
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ å…¥äº†â€œæŸ¥çœ‹ä¸»é¡µâ€å’Œâ€œAIæ“ä½œâ€æŒ‰é’®
            charItem.innerHTML = `
                <img src="${chat.settings.aiAvatar || defaultAvatar}" class="weibo-following-avatar">
                <span class="weibo-following-name">${chat.name}</span>
                <!-- è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„â€œæŸ¥çœ‹ä¸»é¡µâ€æŒ‰é’® -->
                <button class="view-profile-btn" data-char-id="${chat.id}">ä¸»é¡µ</button>
                <span class="weibo-action-trigger-btn" data-target-id="${chat.id}" data-target-name="${chat.name}" data-is-npc="false" title="ä¸ºTaæ‰§è¡Œæ“ä½œ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                </span>
            `;
            listContainer.appendChild(charItem);
            
            // --- æ¸²æŸ“è¯¥è§’è‰²ä¸‹çš„NPC ---
            if (chat.npcLibrary && chat.npcLibrary.length > 0) {
                chat.npcLibrary.forEach(npc => {
                    const npcItem = document.createElement('div');
                    npcItem.className = 'weibo-following-item';
                    npcItem.style.paddingLeft = '30px';
                    // NPCæš‚æ—¶æ²¡æœ‰ç‹¬ç«‹ä¸»é¡µï¼Œæ‰€ä»¥ä¸åŠ â€œä¸»é¡µâ€æŒ‰é’®
                    npcItem.innerHTML = `
                         <img src="${npc.avatar || defaultGroupMemberAvatar}" class="weibo-following-avatar">
                         <span class="weibo-following-name">${npc.name} (NPC)</span>
                         <span class="weibo-action-trigger-btn" data-target-id="${npc.id}" data-target-name="${npc.name}" data-is-npc="true" data-owner-id="${chat.id}" title="ä¸ºTaæ‰§è¡Œæ“ä½œ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                         </span>
                    `;
                    listContainer.appendChild(npcItem);
                });
            }
        });
    }
    
    modal.classList.add('visible');
    console.log("ã€è¯Šæ–­æ—¥å¿— 4ã€‘: å·²æˆåŠŸä¸ºå¼¹çª—æ·»åŠ  .visible ç±»ï¼Œå¼¹çª—ç°åœ¨åº”è¯¥æ˜¾ç¤ºäº†ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšé¡µé¢åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ å¤´åƒæ¡†æ¸²æŸ“é€»è¾‘ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼
/**
 * ã€å¾®åšä¸“å±ã€‘æ¸²æŸ“å¾®åšä¸ªäººä¸»é¡µçš„æ‰€æœ‰æ•°æ®
 */
async function renderWeiboProfile() {
    const settings = state.qzoneSettings || {};
    // ã€æ ¸å¿ƒã€‘æ‰€æœ‰æ•°æ®éƒ½ä» weibo... å­—æ®µè¯»å–ï¼
    document.getElementById('weibo-avatar-img').src = settings.weiboAvatar;
    document.getElementById('weibo-nickname').textContent = settings.weiboNickname;
    document.getElementById('weibo-fans-count').textContent = settings.weiboFansCount;
    document.getElementById('weibo-background-img').src = settings.weiboBackground;
    
    // åŠ¨æ€è®¡ç®—å…³æ³¨æ•° (è¿™éƒ¨åˆ†ä¸å˜)
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    let totalNpcCount = 0;
    allSingleChats.forEach(chat => {
        if (chat.npcLibrary && chat.npcLibrary.length > 0) {
            totalNpcCount += chat.npcLibrary.length;
        }
    });
    document.getElementById('weibo-following-count').textContent = allSingleChats.length + totalNpcCount;
    
    // åŠ¨æ€è®¡ç®—å¾®åšæ•°
    const postsCount = await db.weiboPosts.where('authorId').equals('user').count();
    document.getElementById('weibo-posts-count').textContent = postsCount;
    
    const professionEl = document.getElementById('weibo-user-profession-display');
    if (professionEl) {
        professionEl.textContent = settings.weiboUserProfession || 'ç‚¹å‡»è®¾ç½®èŒä¸š';
    }

    // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ ---
    // 1. è·å–ä¿å­˜çš„å¤´åƒæ¡†URL
    const frameUrl = settings.weiboAvatarFrame || '';
    // 2. æ‰¾åˆ°å¤´åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('weibo-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±æ˜¾ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLä¸ºç©ºï¼ˆå³é€‰æ‹©äº†â€œæ— â€ï¼‰ï¼Œå°±éšè—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
    // --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å¾®åšä¸“å±ã€‘ç¼–è¾‘å¾®åšå¤´åƒ
 */
async function editWeiboAvatar() {
    const newAvatarUrl = await getNewImageUrl("æ›´æ¢å¾®åšå¤´åƒ", state.qzoneSettings.weiboAvatar);
    if (newAvatarUrl) {
        state.qzoneSettings.weiboAvatar = newAvatarUrl; // åªä¿®æ”¹å¾®åšå¤´åƒ
        await saveQzoneSettings();
        await renderWeiboProfile(); // ç”¨ä¸“å±å‡½æ•°åˆ·æ–°
    }
}

/**
 * ã€å¾®åšä¸“å±ã€‘ç¼–è¾‘å¾®åšèƒŒæ™¯å›¾
 */
async function editWeiboBackground() {
    const newBgUrl = await getNewImageUrl("æ›´æ¢å¾®åšèƒŒæ™¯", state.qzoneSettings.weiboBackground);
    if (newBgUrl) {
        state.qzoneSettings.weiboBackground = newBgUrl; // åªä¿®æ”¹å¾®åšèƒŒæ™¯
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ã€å¾®åšä¸“å±ã€‘ç¼–è¾‘å¾®åšæ˜µç§°
 */
async function editWeiboNickname() {
    const newNickname = await showCustomPrompt("ç¼–è¾‘å¾®åšæ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.weiboNickname);
    if (newNickname !== null) {
        state.qzoneSettings.weiboNickname = newNickname.trim() || 'ä½ çš„æ˜µç§°'; // åªä¿®æ”¹å¾®åšæ˜µç§°
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ã€å¾®åšä¸“å±ã€‘ç¼–è¾‘å¾®åšç²‰ä¸æ•°
 */
async function editWeiboFansCount() {
    const newFans = await showCustomPrompt("ç¼–è¾‘ç²‰ä¸æ•°", "è¯·è¾“å…¥æ–°çš„ç²‰ä¸æ•°", state.qzoneSettings.weiboFansCount, "number");
    if (newFans !== null) {
        state.qzoneSettings.weiboFansCount = newFans.trim() || '0'; // åªä¿®æ”¹å¾®åšç²‰ä¸æ•°
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * é€šç”¨çš„å›¾ç‰‡ç¼–è¾‘å‡½æ•° (æœ¬åœ°ä¸Šä¼ æˆ–URL)
 * @param {string} title - å¼¹çª—æ ‡é¢˜
 * @param {string} currentUrl - å½“å‰çš„å›¾ç‰‡URL
 * @returns {Promise<string|null>} - æ–°çš„å›¾ç‰‡URLæˆ–null
 */
async function getNewImageUrl(title, currentUrl) {
    const choice = await showChoiceModal(title, [
        { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
    ]);

    if (choice === 'local') {
        return await uploadImageLocally();
    } else if (choice === 'url') {
        const url = await showCustomPrompt(title, "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL", currentUrl, "url");
        if (url && url.trim().startsWith('http')) {
            return url.trim();
        } else if (url !== null) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLï¼");
        }
    }
    return null;
}

/**
 * ç¼–è¾‘å¾®åšå¤´åƒ
 */
async function editWeiboAvatar() {
    const newAvatarUrl = await getNewImageUrl("æ›´æ¢å¤´åƒ", state.qzoneSettings.weiboAvatar);
    if (newAvatarUrl) {
        state.qzoneSettings.weiboAvatar = newAvatarUrl;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ç¼–è¾‘å¾®åšèƒŒæ™¯å›¾
 */
async function editWeiboBackground() {
    const newBgUrl = await getNewImageUrl("æ›´æ¢èƒŒæ™¯å›¾", state.qzoneSettings.weiboBackground);
    if (newBgUrl) {
        state.qzoneSettings.weiboBackground = newBgUrl;
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

/**
 * ç¼–è¾‘å¾®åšæ˜µç§°
 */
async function editWeiboNickname() {
    const newNickname = await showCustomPrompt("ç¼–è¾‘æ˜µç§°", "è¯·è¾“å…¥æ–°çš„å¾®åšæ˜µç§°", state.qzoneSettings.weiboNickname);
    if (newNickname !== null) {
        state.qzoneSettings.weiboNickname = newNickname.trim() || 'ä½ çš„æ˜µç§°';
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}

// â–¼â–¼â–¼ è¯·ã€å†æ¬¡ç¡®è®¤ã€‘å¹¶ç”¨ä¸‹é¢è¿™ã€æ•´å—å‡½æ•°ã€‘æ›¿æ¢æ‰æ—§çš„ editWeiboFansCount å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å¾®åšä¸“å±ã€‘ç¼–è¾‘å¾®åšç²‰ä¸æ•° (å·²ä¿®å¤ï¼Œæ”¯æŒæ±‰å­—)
 */
async function editWeiboFansCount() {
    // æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿è¿™é‡Œçš„ç¬¬å››ä¸ªå‚æ•°æ˜¯ "text"ï¼Œè€Œä¸æ˜¯ "number"
    const newFans = await showCustomPrompt("ç¼–è¾‘ç²‰ä¸æ•°", "è¯·è¾“å…¥æ–°çš„ç²‰ä¸æ•°", state.qzoneSettings.weiboFansCount, "text");
    
    if (newFans !== null) {
        state.qzoneSettings.weiboFansCount = newFans.trim() || '0'; // åªä¿®æ”¹å¾®åšç²‰ä¸æ•°
        await saveQzoneSettings();
        await renderWeiboProfile();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ switchToWeiboView å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆ‡æ¢å¾®åšä¸»ç•Œé¢ä¸­çš„ä¸åŒé¡µé¢è§†å›¾
 * @param {string} viewId - è¦åˆ‡æ¢åˆ°çš„è§†å›¾çš„ID
 */
async function switchToWeiboView(viewId) {
    // 1. éšè—æ‰€æœ‰å¾®åšé¡µé¢
    document.querySelectorAll('.weibo-view').forEach(view => {
        view.style.display = 'none'; // ä½¿ç”¨ style.display ç¡®ä¿éšè—
    });
    
    // 2. æ˜¾ç¤ºç›®æ ‡é¡µé¢
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'flex'; // ä½¿ç”¨ flex æ˜¾ç¤º
    }

    // 3. æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„é«˜äº®çŠ¶æ€
    document.querySelectorAll('.weibo-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const targetNavItem = document.querySelector(`.weibo-nav-item[data-view="${viewId}"]`);
    if (targetNavItem) {
        targetNavItem.classList.add('active');
    }

    // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘â–¼â–¼â–¼ ---
    // 4. æ ¹æ®ä½ ç‚¹å‡»çš„é¡µç­¾ï¼Œå»åŠ è½½å¹¶æ˜¾ç¤ºå¯¹åº”çš„å¾®åšå†…å®¹
    if (viewId === 'weibo-following-view') {
        // å¦‚æœæ˜¯â€œå…³æ³¨çš„äººâ€é¡µï¼Œå°±è°ƒç”¨æ¸²æŸ“å…³æ³¨åˆ—è¡¨çš„å‡½æ•°
        await renderFollowingWeiboFeed();
    } else if (viewId === 'weibo-my-profile-view') {
        // å¦‚æœæ˜¯â€œæˆ‘çš„å¾®åšâ€é¡µï¼Œå°±è°ƒç”¨æ¸²æŸ“â€œæˆ‘â€çš„å¾®åšçš„å‡½æ•°
        await renderMyWeiboFeed();
    }
    // --- â–²â–²â–²ã€ä¿®å¤ç»“æŸã€‘â–²â–²â–² ---
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨è¿™é‡Œå¼€å§‹å¤åˆ¶ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ openQZonePublisher å‡½æ•° â–¼â–¼â–¼
async function openQZonePublisher(mode) {
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = mode;
    document.getElementById('create-post-modal-title').textContent = 'å‘å¸ƒåŠ¨æ€';

    if (mode === 'shuoshuo') {
        modal.querySelector('.post-mode-switcher').style.display = 'none';
        modal.querySelector('#image-mode-content').style.display = 'none';
        modal.querySelector('#text-image-mode-content').style.display = 'none';
        modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...';
    } else {
        modal.querySelector('.post-mode-switcher').style.display = 'flex';
        modal.querySelector('#image-mode-content').classList.add('active');
        modal.querySelector('#text-image-mode-content').classList.remove('active');
        modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰';
    }

    document.getElementById('post-comments-toggle-group').style.display = 'block';
    
    // --- â–¼â–¼â–¼ ä»¥ä¸‹æ˜¯æœ¬æ¬¡æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ ---
    const visibilityGroup = document.getElementById('post-visibility-group');
    const groupsContainer = document.getElementById('post-visibility-groups');
    const visibilityRadios = document.querySelectorAll('input[name="visibility"]');

    visibilityGroup.style.display = 'block';
    groupsContainer.innerHTML = ''; // æ¸…ç©ºæ—§çš„åˆ†ç»„åˆ—è¡¨
    
    // ä»æ•°æ®åº“è¯»å–ä½ çš„å¥½å‹åˆ†ç»„
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${group.id}"> ${group.name}`;
            groupsContainer.appendChild(label);
        });
    } else {
        groupsContainer.innerHTML = '<p style="color: #8a8a8a; font-size: 13px;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å¥½å‹åˆ†ç»„å“¦ã€‚</p>';
    }

    // é»˜è®¤é€‰ä¸­â€œæ‰€æœ‰äººå¯è§â€å¹¶éšè—åˆ†ç»„é€‰æ‹©
    visibilityRadios[0].checked = true;
    groupsContainer.style.display = 'none';

    // ç›‘å¬å•é€‰æŒ‰é’®çš„å˜åŒ–
    visibilityRadios.forEach(radio => {
        radio.onchange = function() {
            groupsContainer.style.display = this.value === 'groups' ? 'block' : 'none';
        };
    });
    // --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² ---

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€è¯„è®ºä¼˜åŒ–ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ generateWeiboComments å‡½æ•° â–¼â–¼â–¼
/**
 * ã€è¯„è®ºä¼˜åŒ–ç‰ˆ V2ã€‘AIç”Ÿæˆå¾®åšè¯„è®ºçš„æ ¸å¿ƒå‡½æ•°
 * @param {number} postId - éœ€è¦ç”Ÿæˆè¯„è®ºçš„å¾®åšID
 */
async function generateWeiboComments(postId) {
    const post = await db.weiboPosts.get(postId);
    if (!post) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¿™æ¡å¾®åšï¼");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¬å”¤é«˜è´¨é‡ç½‘å‹...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }
    
    let authorPersona = "ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚";
    let authorProfession = "æœªè®¾å®š"; 
    const authorName = post.authorId === 'user' ? (state.qzoneSettings.weiboNickname || 'æˆ‘') : post.authorNickname;
    
    if (post.authorId === 'user') {
        authorPersona = state.qzoneSettings.weiboUserPersona || 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚';
        authorProfession = state.qzoneSettings.weiboUserProfession || 'æœªè®¾å®š';
    } else {
        const authorChat = state.chats[post.authorId];
        if (authorChat) {
            authorPersona = authorChat.settings.aiPersona || 'æ— ';
            authorProfession = authorChat.settings.weiboProfession || 'æœªè®¾å®š';
        }
    }
    const truncatedPersona = authorPersona.substring(0, 400);
    const postContent = (post.content || "").substring(0, 200);
    const existingComments = (post.comments || []).slice(-5).map(c => `${c.authorNickname}: ${c.commentText}`).join('\n');

    let imageContext = '';
    if (post.imageUrl && post.imageDescription) {
        imageContext = `
- **å›¾ç‰‡å†…å®¹**: è¿™æ¡å¾®åšé…æœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${post.imageDescription}â€`;
    } else if (post.postType === 'text_image' && post.hiddenContent) {
        imageContext = `
- **å›¾ç‰‡å†…å®¹**: è¿™æ˜¯ä¸€å¼ æ–‡å­—å›¾ï¼Œä¸Šé¢çš„å†…å®¹æ˜¯ï¼šâ€œ${post.hiddenContent}â€`;
    }
    
    // â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œæ˜¯æˆ‘ä»¬æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

    // 1. åˆ›å»ºä¸€ä¸ªé›†åˆï¼Œç”¨æ¥å­˜æ”¾è¯„è®ºåŒºå·²å‡ºç°çš„ã€æœ‰äººè®¾çš„è§’è‰²ä¿¡æ¯
    const commenterPersonas = new Map();

    // 2. å°†å¾®åšä½œè€…æœ¬äººçš„äººè®¾å…ˆåŠ è¿›å»
    commenterPersonas.set(authorName, `[èŒä¸š: ${authorProfession}] [äººè®¾: ${truncatedPersona}]`);

    // 3. éå†å·²æœ‰çš„è¯„è®ºï¼ŒæŸ¥æ‰¾å¹¶æ·»åŠ å…¶ä»–è§’è‰²çš„äººè®¾
    if (post.comments && post.comments.length > 0) {
        post.comments.forEach(comment => {
            const commenterName = comment.authorNickname;
            // å¦‚æœè¿™ä¸ªäººè®¾è¿˜æ²¡è¢«è®°å½•è¿‡
            if (!commenterPersonas.has(commenterName)) {
                // æ£€æŸ¥è¿™ä¸ªè¯„è®ºè€…æ˜¯ä¸æ˜¯ä¸€ä¸ªå·²çŸ¥çš„AIè§’è‰²
                const commenterChat = Object.values(state.chats).find(c => c.name === commenterName);
                if (commenterChat && !commenterChat.isGroup) {
                    // å¦‚æœæ˜¯ï¼Œå°±æŠŠä»–/å¥¹çš„äººè®¾å’ŒèŒä¸šä¹ŸåŠ åˆ°é›†åˆé‡Œ
                    const profession = commenterChat.settings.weiboProfession || 'æœªè®¾å®š';
                    const persona = (commenterChat.settings.aiPersona || 'æ— ').substring(0, 200);
                    commenterPersonas.set(commenterName, `[èŒä¸š: ${profession}] [äººè®¾: ${persona}]`);
                }
            }
        });
    }
    
    // 4. å°†æ”¶é›†åˆ°çš„äººè®¾ä¿¡æ¯ï¼Œæ ¼å¼åŒ–æˆç»™AIçœ‹çš„æ–‡æœ¬
    let commenterContext = '';
    if (commenterPersonas.size > 0) {
        commenterContext += '\n# è¯„è®ºåŒºå·²æœ‰è§’è‰²äººè®¾ (ä¾›ä½ å›å¤æ—¶å‚è€ƒ)\n';
        commenterPersonas.forEach((persona, name) => {
            commenterContext += `- **${name}**: ${persona}\n`;
        });
    }

    // â–²â–²â–² æ–°å¢ä»£ç åˆ°æ­¤ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œç¤¾äº¤åª’ä½“æ¨¡æ‹Ÿå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸€ä¸ªç‰¹å®šè§’è‰²çš„â€œäººè®¾â€ï¼Œä¸ºä»–/å¥¹å‘å¸ƒçš„ä¸€æ¡å¾®åšç”Ÿæˆä¸€æ‰¹çœŸå®çš„ã€ç¬¦åˆæƒ…æ™¯çš„ç½‘å‹è¯„è®ºã€‚

# å¾®åšæƒ…æ™¯
- **ä½œè€…**: ${authorName}
- **å¾®åšæ–‡å­—**: ${postContent || "(è¯¥å¾®åšæ²¡æœ‰é…æ–‡)"}
${imageContext}
- **å·²æœ‰è¯„è®º (ä½ å¯ä»¥å›å¤ä»–ä»¬)**:
${existingComments || "(æš‚æ— è¯„è®º)"}

${commenterContext}

# ã€ã€ã€è¯„è®ºç”Ÿæˆæ ¸å¿ƒè§„åˆ™ã€‘ã€‘ã€‘
1.  **ã€ã€ã€ä¸¥ç¦ä½¿ç”¨ã€‘ã€‘ã€‘**: ç»å¯¹ç¦æ­¢ä½¿ç”¨ â€œè·¯äººç”²â€ã€â€œç½‘å‹Aâ€ã€â€œç²‰ä¸Bâ€ è¿™ç±»ä»£å·ä½œä¸ºè¯„è®ºè€…æ˜µç§°ã€‚
2.  **æ˜µç§°å¤šæ ·åŒ–**: è¯„è®ºè€…çš„æ˜µç§°å¿…é¡»éå¸¸çœŸå®ã€å¤šæ ·åŒ–ä¸”ç¬¦åˆå¾®åšç”Ÿæ€ã€‚ä¾‹å¦‚ï¼šâ€œä»Šå¤©ä¹Ÿè¦æ—©ç¡â€ã€â€œå¯ä¹åŠ å†°å—â€ã€â€œæ˜¯å°ç‹ä¸æ˜¯å°å¼ â€ã€â€œç†æ€§åƒç“œç¬¬ä¸€çº¿â€ã€‚
3.  **å†…å®¹ä¸äººè®¾å¼ºç›¸å…³**: è¯„è®ºå†…å®¹å¿…é¡»ä¸ã€å¾®åšå†…å®¹(åŒ…æ‹¬æ–‡å­—å’Œå›¾ç‰‡)ã€‘å’Œã€ä½œè€…ä»¥åŠè¢«å›å¤è€…çš„äººè®¾ã€‘é«˜åº¦ç›¸å…³ã€‚æ€è€ƒï¼šä»€ä¹ˆæ ·çš„ç²‰ä¸ä¼šå…³æ³¨è¿™æ ·çš„äººï¼Ÿä»–ä»¬ä¼šæ€ä¹ˆè¯´è¯ï¼Ÿå½“å›å¤ä¸€ä¸ªæœ‰ç‰¹å®šäººè®¾çš„è§’è‰²æ—¶ï¼Œä½ çš„å›å¤å¿…é¡»è€ƒè™‘åˆ°å¯¹æ–¹çš„èº«ä»½ã€‚
4.  **é£æ ¼å¤šæ ·åŒ–**: ç”Ÿæˆçš„è¯„è®ºåº”åŒ…å«ä¸åŒç«‹åœºå’Œé£æ ¼ï¼Œä¾‹å¦‚ï¼š
    -   **ç²‰ä¸**: â€œå“¥å“¥å¤ªå¸…äº†ï¼æ–°å‰§ä»€ä¹ˆæ—¶å€™æ’­ï¼Ÿâ€
    -   **è·¯äºº**: â€œè¿™ä¸ªåœ°æ–¹çœ‹èµ·æ¥ä¸é”™ï¼Œæ±‚åœ°å€ï¼â€
    -   **é»‘ç²‰/è´¨ç–‘è€…**: â€œå°±è¿™ï¼Ÿæ„Ÿè§‰på›¾æœ‰ç‚¹è¿‡äº†å§...â€
    -   **ç©æ¢—**: â€œæ¥¼ä¸Šæ˜¯ä¸æ˜¯XXæ´¾æ¥çš„é—´è°ï¼ˆç‹—å¤´ï¼‰â€
5.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡è¯„è®ºã€‚
    -   å‘è¡¨æ–°è¯„è®º, ä½¿ç”¨æ ¼å¼: \`{"author": "ä¸åƒé¦™èœçš„ä»™å¥³", "comment": "å“‡ï¼Œè¿™ä¸ªå¥½å¥½çœ‹ï¼"}\`
    -   å›å¤å·²æœ‰è¯„è®º, ä½¿ç”¨æ ¼å¼: \`{"author": "çˆ±åƒç“œçš„çŒ¹", "comment": "æˆ‘ä¹Ÿè§‰å¾—ï¼", "replyTo": "ä¸åƒé¦™èœçš„ä»™å¥³"}\`

ç°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„è¡¨æ¼”ã€‚
`;

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);


        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8, 
                    response_format: { type: "json_object" }
                })
            });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        const newComments = JSON.parse(aiResponseContent);

        if (Array.isArray(newComments) && newComments.length > 0) {
            const postToUpdate = await db.weiboPosts.get(post.id);
            if (!postToUpdate) throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å¸–å­ï¼");
            
            if (!postToUpdate.comments) postToUpdate.comments = [];
            
            newComments.forEach(comment => {
                if(comment.author && comment.comment) {
                    const newCommentObject = {
                        commentId: 'comment_' + Date.now() + Math.random(),
                        authorNickname: comment.author,
                        commentText: comment.comment,
                        timestamp: Date.now()
                    };
                    if (comment.replyTo) {
                        newCommentObject.replyToNickname = comment.replyTo;
                    }
                    postToUpdate.comments.push(newCommentObject);
                }
            });

            postToUpdate.baseLikesCount = (postToUpdate.baseLikesCount || 0) + Math.floor(Math.random() * newComments.length * 3 + 5);

            await db.weiboPosts.put(postToUpdate);
            
            await renderMyWeiboFeed();
            await renderFollowingWeiboFeed();
            
            alert(`æˆåŠŸç”Ÿæˆäº† ${newComments.length} æ¡æ–°è¯„è®ºï¼`);
        } else {
             alert("AIæ²¡æœ‰ç”Ÿæˆæœ‰æ•ˆçš„è¯„è®ºã€‚");
        }

    } catch (error) {
        console.error("ç”Ÿæˆå¾®åšè¯„è®ºå¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ° renderWeiboProfile å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åˆ é™¤ä¸€æ¡å¾®åšè¯„è®º
 * @param {number} postId - è¯„è®ºæ‰€åœ¨çš„å¾®åšID
 * @param {string} commentId - è¦åˆ é™¤çš„è¯„è®ºçš„ID
 */
async function deleteWeiboComment(postId, commentId) {
    const post = await db.weiboPosts.get(postId);
    if (!post || !post.comments) return;

    const commentIndex = post.comments.findIndex(c => c.commentId === commentId);
    if (commentIndex === -1) return;
    
    const commentText = post.comments[commentIndex].commentText;

    const confirmed = await showCustomConfirm(
        'åˆ é™¤è¯„è®º', 
        `ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        post.comments.splice(commentIndex, 1);
        await db.weiboPosts.put(post);
        await renderMyWeiboFeed();
        await renderFollowingWeiboFeed();
        alert("è¯„è®ºå·²åˆ é™¤ã€‚");
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€é”®æ¸…ç©ºæ‰€æœ‰å•äººèŠå¤©èƒŒæ™¯
 */
async function clearAllSingleChatBackgrounds() {
    // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ“ä½œ', 
        'æ­¤æ“ä½œå°†ç§»é™¤æ‰€æœ‰è§’è‰²å•ç‹¬è®¾ç½®çš„èŠå¤©èƒŒæ™¯ï¼Œç»Ÿä¸€ä½¿ç”¨å…¨å±€èƒŒæ™¯ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        let updatedCount = 0;
        const chatsToUpdate = [];

        // éå†æ‰€æœ‰èŠå¤©
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            // å¦‚æœè¿™ä¸ªèŠå¤©è®¾ç½®äº†å•äººèƒŒæ™¯
            if (chat.settings && chat.settings.background) {
                chat.settings.background = ''; // æ¸…ç©ºå®ƒ
                chatsToUpdate.push(chat);
                updatedCount++;
            }
        }

        // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„èŠå¤©ï¼Œå°±æ‰¹é‡å†™å…¥æ•°æ®åº“
        if (chatsToUpdate.length > 0) {
            await db.chats.bulkPut(chatsToUpdate);
        }
        
        await showCustomAlert('æ“ä½œæˆåŠŸ', `å·²æˆåŠŸæ¸…ç©º ${updatedCount} ä¸ªè§’è‰²çš„å•äººèŠå¤©èƒŒæ™¯ï¼`);
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€V2ä¿®æ­£ç‰ˆã€‘ä¸»å±å¹•ç¾åŒ–é¢„è®¾æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼ */

let activeHomePresetId = null; // ç”¨äºè¿½è¸ªå½“å‰é€‰ä¸­çš„é¢„è®¾ID

/**
 * å¯ç”¨æˆ–ç¦ç”¨é¢„è®¾ç®¡ç†æŒ‰é’®
 */
function toggleHomePresetButtons(isEnabled) {
    document.getElementById('apply-home-preset-btn').disabled = !isEnabled;
    document.getElementById('update-home-preset-btn').disabled = !isEnabled; // <-- æ–°å¢è¿™ä¸€è¡Œ
    document.getElementById('rename-home-preset-btn').disabled = !isEnabled;
    document.getElementById('delete-home-preset-btn').disabled = !isEnabled;
    document.getElementById('export-home-preset-btn').disabled = !isEnabled;
}


/**
 * åŠ è½½é¢„è®¾åˆ°ä¸‹æ‹‰æ¡†
 */
async function loadHomeScreenPresetsToDropdown() {
    const selector = document.getElementById('home-preset-selector');
    selector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
    const presets = await db.homeScreenPresets.toArray();
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selector.appendChild(option);
    });
    activeHomePresetId = null; // é‡ç½®é€‰æ‹©
    toggleHomePresetButtons(false); // é»˜è®¤ç¦ç”¨æŒ‰é’®
}

/**
 * ã€æ–°ã€‘å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶
 */
function handleHomePresetSelection() {
    const selector = document.getElementById('home-preset-selector');
    activeHomePresetId = selector.value ? parseInt(selector.value) : null;
    // åªæœ‰å½“ç”¨æˆ·ç¡®å®é€‰æ‹©äº†ä¸€ä¸ªé¢„è®¾æ—¶ï¼Œæ‰å¯ç”¨ç›¸å…³æŒ‰é’®
    toggleHomePresetButtons(!!activeHomePresetId);
}

// è¿™æ˜¯ä¿®æ”¹åçš„æ–°ä»£ç 
async function applySelectedHomeScreenPreset() {
    if (!activeHomePresetId) {
        alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„é¢„è®¾ã€‚");
        return;
    }
    const preset = await db.homeScreenPresets.get(activeHomePresetId);
    if (preset && preset.data) {
        // å°†é¢„è®¾æ•°æ®åŠ è½½åˆ°å…¨å±€çŠ¶æ€
        state.globalSettings.widgetData = preset.data;

        if (preset.data.wallpaper) {
            state.globalSettings.wallpaper = preset.data.wallpaper;
        }
        if (preset.data.appIcons) {
            state.globalSettings.appIcons = { ...preset.data.appIcons };
        }

        // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡å”¯ä¸€éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä»£ç ï¼ â˜…â˜…â˜…â˜…â˜…
        // æ£€æŸ¥é¢„è®¾ä¸­æ˜¯å¦æœ‰appLabelsæ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œå°±åŠ è½½å®ƒ
        if (preset.data.appLabels) {
            state.globalSettings.appLabels = { ...preset.data.appLabels };
        } else {
            // å¦‚æœæ—§çš„é¢„è®¾æ²¡æœ‰è¿™ä¸ªæ•°æ®ï¼Œå°±æ¸…ç©ºå½“å‰çš„è‡ªå®šä¹‰åç§°ï¼Œæ¢å¤é»˜è®¤
            state.globalSettings.appLabels = {};
        }
        // â˜…â˜…â˜…â˜…â˜… æ·»åŠ ç»“æŸ â˜…â˜…â˜…â˜…â˜…

        // ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
        await db.globalSettings.put(state.globalSettings);
        
        // ä¾æ¬¡åº”ç”¨æ‰€æœ‰è®¾ç½® (ç°åœ¨ applyAppLabels() å°±èƒ½è·å–åˆ°æ­£ç¡®çš„åç§°äº†)
        applyGlobalWallpaper();
        applyAppIcons();
        applyAppLabels(); 
        applyWidgetData(); 

        alert(`å·²æˆåŠŸåº”ç”¨é¢„è®¾: "${preset.name}"ï¼`);
        showScreen('home-screen');
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ä¸»å±å¹•ä¸ªäººèµ„æ–™å¡çš„å¤´åƒæ¡†
 */
function renderHomeScreenProfileFrame() {
    // 1. è·å–ä¿å­˜çš„å¤´åƒæ¡†URL
    const frameUrl = state.globalSettings.homeAvatarFrame || '';
    // 2. æ‰¾åˆ°å¤´åƒæ¡†çš„imgå…ƒç´ 
    const frameImg = document.getElementById('profile-avatar-frame');
    if (frameImg) {
        // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±æ˜¾ç¤ºå®ƒ
        if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = 'block';
        } else {
            // 4. å¦‚æœURLä¸ºç©ºï¼ˆå³é€‰æ‹©äº†â€œæ— â€ï¼‰ï¼Œå°±éšè—å®ƒ
            frameImg.src = '';
            frameImg.style.display = 'none';
        }
    }
}


/**
 * ã€V2 ä¿®å¤ç‰ˆã€‘ä¿å­˜å½“å‰çš„ä¸»å±å¹•è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
 */
async function saveCurrentHomeScreenAsPreset() {
    const presetName = await showCustomPrompt("ä¿å­˜é¢„è®¾", "è¯·ä¸ºè¿™ä¸ªä¸»å±å¹•ç¾åŒ–æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š");
    if (!presetName || !presetName.trim()) {
        if (presetName !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    // æ ¸å¿ƒï¼šæ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸»å±å¹•å…ƒç´ çš„å®Œæ•´æ•°æ®å¯¹è±¡
    const presetData = {
        // --- ä¸ªäººèµ„æ–™å¡ç‰‡ ---
        'profile-banner-img': document.getElementById('profile-banner-img').src,
        'profile-avatar-img': document.getElementById('profile-avatar-img').src,
        'homeAvatarFrame': document.getElementById('profile-avatar-frame').src, // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜å¤´åƒæ¡† â˜…â˜…â˜…
        'profile-username': document.getElementById('profile-username').textContent,
        'profile-sub-username': document.getElementById('profile-sub-username').textContent,
        'profile-bio': document.getElementById('profile-bio').textContent,
        'profile-location': document.getElementById('profile-location').innerHTML,

        // --- ç¬¬ä¸€é¡µå°ç»„ä»¶ ---
        'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
        'widget-image-1': document.getElementById('widget-image-1').src,
        'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
        'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
        'widget-image-2': document.getElementById('widget-image-2').src,
        'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
        
        // --- ç¬¬äºŒé¡µå°ç»„ä»¶ ---
        'widget-image-3': document.getElementById('widget-image-3').src,
        'second-page-bubble': document.getElementById('second-page-bubble').textContent,
        'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
        'circular-bubble': document.getElementById('circular-bubble').textContent,
        'widget-image-4': document.getElementById('widget-image-4').src,
        'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
        'bubble-top-left': document.getElementById('bubble-top-left').textContent,
        'bubble-top-right': document.getElementById('bubble-top-right').textContent,
        'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
        'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
        'new-widget-avatar': document.getElementById('new-widget-avatar').src,
        'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
        'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
        'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
        'widget-month-display': document.getElementById('widget-month-display').textContent,
        
        // --- Appå›¾æ ‡å’Œå£çº¸ ---
        'appIcons': { ...state.globalSettings.appIcons },
        'appLabels': { ...state.globalSettings.appLabels },
        'wallpaper': state.globalSettings.wallpaper
    };

    // ä¿å­˜åˆ°æ•°æ®åº“
    await db.homeScreenPresets.add({ name: presetName.trim(), data: presetData });
    await loadHomeScreenPresetsToDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
    alert(`é¢„è®¾ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
}

/**
 * ã€V2 ä¿®å¤ç‰ˆã€‘æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function updateSelectedHomeScreenPreset() {
    if (!activeHomePresetId) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦æ›´æ–°çš„é¢„è®¾ã€‚");
        return;
    }

    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    if (!currentPreset) return;

    const confirmed = await showCustomConfirm(
        "ç¡®è®¤æ›´æ–°",
        `ç¡®å®šè¦ç”¨å½“å‰çš„ä¸»å±å¹•å¸ƒå±€è¦†ç›–é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // æ„å»ºä¸ä¿å­˜æ—¶å®Œå…¨ç›¸åŒçš„å®Œæ•´æ•°æ®å¯¹è±¡
        const presetData = {
            'profile-banner-img': document.getElementById('profile-banner-img').src,
            'profile-avatar-img': document.getElementById('profile-avatar-img').src,
            'homeAvatarFrame': document.getElementById('profile-avatar-frame').src, // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜å¤´åƒæ¡† â˜…â˜…â˜…
            'profile-username': document.getElementById('profile-username').textContent,
            'profile-sub-username': document.getElementById('profile-sub-username').textContent,
            'profile-bio': document.getElementById('profile-bio').textContent,
            'profile-location': document.getElementById('profile-location').innerHTML,
            'widget-bubble-1': document.getElementById('widget-bubble-1').textContent,
            'widget-image-1': document.getElementById('widget-image-1').src,
            'widget-subtext-1': document.getElementById('widget-subtext-1').textContent,
            'widget-bubble-2': document.getElementById('widget-bubble-2').textContent,
            'widget-image-2': document.getElementById('widget-image-2').src,
            'widget-subtext-2': document.getElementById('widget-subtext-2').textContent,
            'widget-image-3': document.getElementById('widget-image-3').src,
            'second-page-bubble': document.getElementById('second-page-bubble').textContent,
            'flat-capsule-bubble': document.getElementById('flat-capsule-bubble').textContent,
            'circular-bubble': document.getElementById('circular-bubble').textContent,
            'widget-image-4': document.getElementById('widget-image-4').src,
            'avatar-subtitle': document.getElementById('avatar-subtitle').textContent,
            'bubble-top-left': document.getElementById('bubble-top-left').textContent,
            'bubble-top-right': document.getElementById('bubble-top-right').textContent,
            'bubble-bottom-left': document.getElementById('bubble-bottom-left').textContent,
            'bubble-bottom-right': document.getElementById('bubble-bottom-right').textContent,
            'new-widget-avatar': document.getElementById('new-widget-avatar').src,
            'new-widget-text-1': document.getElementById('new-widget-text-1').textContent,
            'new-widget-text-2': document.getElementById('new-widget-text-2').textContent,
            'new-widget-text-3': document.getElementById('new-widget-text-3').textContent,
            'widget-month-display': document.getElementById('widget-month-display').textContent,
            'appIcons': { ...state.globalSettings.appIcons },
            'wallpaper': state.globalSettings.wallpaper
        };

        await db.homeScreenPresets.update(activeHomePresetId, { data: presetData });
        await showCustomAlert('æˆåŠŸ', `é¢„è®¾ "${currentPreset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * é‡å‘½åé€‰ä¸­çš„é¢„è®¾
 */
async function renameSelectedHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    const newName = await showCustomPrompt("é‡å‘½å", "è¯·è¾“å…¥æ–°çš„åç§°ï¼š", currentPreset.name);
    if (newName && newName.trim()) {
        await db.homeScreenPresets.update(activeHomePresetId, { name: newName.trim() });
        await loadHomeScreenPresetsToDropdown();
        document.getElementById('home-preset-selector').value = activeHomePresetId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆ é™¤é€‰ä¸­çš„é¢„è®¾
 */
async function deleteSelectedHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const currentPreset = await db.homeScreenPresets.get(activeHomePresetId);
    const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.homeScreenPresets.delete(activeHomePresetId);
        await loadHomeScreenPresetsToDropdown(); // è¿™ä¼šè‡ªåŠ¨é‡ç½®é€‰æ‹©å¹¶ç¦ç”¨æŒ‰é’®
        alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
}

/**
 * ã€å…¨æ–°ã€‘å¯¼å‡ºé€‰ä¸­çš„é¢„è®¾
 */
async function exportHomeScreenPreset() {
    if (!activeHomePresetId) return;
    const preset = await db.homeScreenPresets.get(activeHomePresetId);
    const blob = new Blob([JSON.stringify(preset, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${preset.name}-HomeScreen.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * ã€å…¨æ–°ã€‘å¯¼å…¥é¢„è®¾æ–‡ä»¶
 */
function importHomeScreenPreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // ç®€å•éªŒè¯ä¸€ä¸‹æ–‡ä»¶å†…å®¹æ˜¯ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„æ ¼å¼
            if (data.name && data.data) {
                await db.homeScreenPresets.add({ name: `${data.name} (å¯¼å…¥)`, data: data.data });
                await loadHomeScreenPresetsToDropdown();
                alert(`é¢„è®¾ "${data.name}" å¯¼å…¥æˆåŠŸï¼`);
            } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch (error) {
            alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚${error.message}`);
        }
    };
    reader.readAsText(file);
}
/* â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼ */

let currentWeiboActionTarget = {}; // ç”¨äºå­˜å‚¨è¢«æ“ä½œçš„ç›®æ ‡ä¿¡æ¯

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å…¨æ–°é€»è¾‘ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ openWeiboActionModal å‡½æ•° â–¼â–¼â–¼

/**
 * ã€V2 - AIè‡ªä¸»ç‰ˆã€‘æ‰“å¼€å¾®åšæ“ä½œæ¨¡æ€æ¡†
 * @param {object} targetInfo - åŒ…å«è¢«æ“ä½œè§’è‰²ä¿¡æ¯çš„å¯¹è±¡
 */
function openWeiboActionModal(targetInfo) {
    currentWeiboActionTarget = targetInfo; // ä¿å­˜ç›®æ ‡ä¿¡æ¯
    const modal = document.getElementById('weibo-action-modal');
    
    // æ ¸å¿ƒä¿®æ”¹ï¼šæ ‡é¢˜ç›´æ¥æ˜¾ç¤ºä¸ºè°è¡ŒåŠ¨ï¼Œä¸å†æœ‰â€œæ“ä½œè€…â€
    document.getElementById('weibo-action-modal-title').textContent = `ä¸º "${targetInfo.name}" è§¦å‘è¡ŒåŠ¨`;

    // æ ¸å¿ƒä¿®æ”¹ï¼šå½»åº•ç§»é™¤å¹¶éšè—â€œé€‰æ‹©æ“ä½œè€…â€çš„ä¸‹æ‹‰æ¡†
    const actorSelectGroup = document.getElementById('weibo-action-actor-select').parentElement;
    if (actorSelectGroup) {
        actorSelectGroup.style.display = 'none';
    }
    
    // æ¸…ç©ºä¸Šæ¬¡çš„è¾“å…¥å¹¶é‡ç½®é€‰é¡¹
    document.getElementById('weibo-action-prompt-input').value = '';
    document.querySelector('input[name="weibo_action_type"][value="post"]').checked = true;

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€AIæ ¸å¿ƒ V2.2 - è¯„è®ºç”¨æˆ·å¾®åšç‰ˆ + 500é”™è¯¯æœ€ç»ˆä¿®å¤ã€‘æ‰§è¡ŒAIæ“ä½œï¼ˆå‘å¾®åš/è¯„è®ºï¼‰
 */
async function handleWeiboAiAction() {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    document.getElementById('weibo-action-modal').classList.remove('visible');
    document.getElementById('weibo-following-modal').classList.remove('visible');
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIç”Ÿæˆå†…å®¹ï¼Œè¯·è€å¿ƒç­‰å¾…...");

    const actionType = document.querySelector('input[name="weibo_action_type"]:checked').value;
    const userInputPrompt = document.getElementById('weibo-action-prompt-input').value.trim();

    let target = { 
        id: currentWeiboActionTarget.id,
        name: currentWeiboActionTarget.name, 
        persona: 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚',
        profession: '',
        instruction: ''
    };

    if (currentWeiboActionTarget.isNpc) {
        const owner = state.chats[currentWeiboActionTarget.ownerId];
        const npc = owner.npcLibrary.find(n => n.id === currentWeiboActionTarget.id);
        if (npc) {
            target.persona = npc.persona;
            target.profession = owner.settings.weiboProfession || '';
            target.instruction = owner.settings.weiboInstruction || '';
        }
    } else {
        const char = state.chats[currentWeiboActionTarget.id];
        if (char) {
            target.persona = char.settings.aiPersona;
            target.profession = char.settings.weiboProfession || '';
            target.instruction = char.settings.weiboInstruction || '';
        }
    }
    
    let systemPrompt = '';
    let messagesForApi = [];

    try {
        if (actionType === 'post') {
            systemPrompt = `
# ä»»åŠ¡: è§’è‰²æ‰®æ¼”ä¸å¾®åšåˆ›ä½œ
ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${target.name}â€ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„èº«ä»½ä¿¡æ¯ï¼Œåˆ›ä½œä¸€æ¡å…¨æ–°çš„å¾®åšã€‚
# ä½ çš„èº«ä»½ä¿¡æ¯
- **ä½ çš„åå­—**: ${target.name}
- **ä½ çš„èŒä¸š**: ${target.profession || 'æœªè®¾å®š'}
- **ä½ çš„äººè®¾**: ${target.persona}
- **ä½ çš„å¾®åšæŒ‡ä»¤ (å¿…é¡»éµå®ˆ)**: ${target.instruction || 'æ— '}
- **ç”¨æˆ·ç»™ä½ çš„æç¤º (å¯é€‰å‚è€ƒ)**: ${userInputPrompt || 'æ— '}
# ã€ã€ã€è¯„è®ºç”Ÿæˆæ ¸å¿ƒè§„åˆ™ã€‘ã€‘ã€‘
1.  **ã€ã€ã€ä¸¥ç¦ä½¿ç”¨ã€‘ã€‘ã€‘**: ç»å¯¹ç¦æ­¢ä½¿ç”¨ â€œè·¯äººç”²â€ã€â€œç½‘å‹Aâ€ã€â€œç²‰ä¸Bâ€ è¿™ç±»ä»£å·ä½œä¸ºè¯„è®ºè€…æ˜µç§°ã€‚
2.  **æ˜µç§°å¤šæ ·åŒ–**: è¯„è®ºè€…çš„æ˜µç§°å¿…é¡»éå¸¸çœŸå®ã€å¤šæ ·åŒ–ä¸”ç¬¦åˆå¾®åšç”Ÿæ€ã€‚ä¾‹å¦‚ï¼šâ€œä»Šå¤©ä¹Ÿè¦æ—©ç¡â€ã€â€œå¯ä¹åŠ å†°å—â€ã€â€œæ˜¯å°ç‹ä¸æ˜¯å°å¼ â€ã€â€œç†æ€§åƒç“œç¬¬ä¸€çº¿â€ã€‚
3.  **å†…å®¹ä¸äººè®¾å¼ºç›¸å…³**: è¯„è®ºå†…å®¹å¿…é¡»ä¸ã€ä½ å³å°†åˆ›ä½œçš„å¾®åšå†…å®¹ã€‘å’Œã€ä½ è‡ªå·±çš„äººè®¾ã€‘é«˜åº¦ç›¸å…³ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
   \`{"content": "å¾®åšæ­£æ–‡å†…å®¹...", "baseLikesCount": éšæœºç”Ÿæˆçš„ç‚¹èµæ•°, "baseCommentsCount": éšæœºç”Ÿæˆçš„è¯„è®ºæ•°, "comments": "ä»Šå¤©ä¹Ÿè¦æ—©ç¡: è¯„è®º1...\\nå¯ä¹åŠ å†°å—: è¯„è®º2..."}\`
   - ç‚¹èµå’Œè¯„è®ºæ•°è¦ç¬¦åˆä½ çš„èº«ä»½åœ°ä½ã€‚
   - "comments"å­—æ®µæ˜¯ä¸€ä¸ªã€å­—ç¬¦ä¸²ã€‘ï¼Œé‡Œé¢åŒ…å«5-10æ¡çœŸå®æ„Ÿçš„è·¯äººè¯„è®ºï¼Œæ¯æ¡è¯„è®ºç”¨æ¢è¡Œç¬¦'\\n'åˆ†éš”ã€‚
`;
            messagesForApi.push({ role: 'user', content: systemPrompt });

        } else {
            let targetPost;
            let taskDescription;
            let extraContext = ''; 

            if (actionType === 'comment_plaza') {
                targetPost = await db.weiboPosts.orderBy('timestamp').last();
                if (!targetPost) throw new Error("å¹¿åœºä¸Šè¿˜æ²¡æœ‰ä»»ä½•å¾®åšå¯ä»¥è¯„è®ºï¼");
                taskDescription = `ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„èº«ä»½ä¿¡æ¯ï¼Œå»è¯„è®ºä¸‹é¢è¿™æ¡æœ€æ–°çš„ã€å¹¿åœºå¾®åšã€‘ã€‚`;
            } else if (actionType === 'comment_user') {
                targetPost = await db.weiboPosts.where('authorId').equals('user').reverse().first();
                if (!targetPost) throw new Error("ç”¨æˆ·è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å¾®åšï¼Œæ— æ³•è¯„è®ºï¼");
                taskDescription = `ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„èº«ä»½ä¿¡æ¯ï¼Œå»è¯„è®ºä¸‹é¢è¿™æ¡ç”±ã€ç”¨æˆ·ã€‘å‘å¸ƒçš„æœ€æ–°å¾®åšã€‚`;
            }

            let postAuthorName = targetPost.authorNickname;
            if (postAuthorName === '{{user}}') {
                postAuthorName = 'æˆ‘';
            }
            
            systemPrompt = `
# ä»»åŠ¡: è§’è‰²æ‰®æ¼”ä¸å¾®åšè¯„è®º
ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${target.name}â€ã€‚
${taskDescription}
# ä½ çš„èº«ä»½ä¿¡æ¯
- **ä½ çš„åå­—**: ${target.name}
- **ä½ çš„èŒä¸š**: ${target.profession || 'æœªè®¾å®š'}
- **ä½ çš„äººè®¾**: ${target.persona}
- **ä½ çš„å¾®åšæŒ‡ä»¤ (å¿…é¡»éµå®ˆ)**: ${target.instruction || 'æ— '}
- **ç”¨æˆ·ç»™ä½ çš„æç¤º (å¯é€‰å‚è€ƒ)**: ${userInputPrompt || 'æ— '}
# è¢«è¯„è®ºçš„å¾®åš
- ä½œè€…: ${postAuthorName}
- å†…å®¹: ${targetPost.content}
${extraContext}
# æ ¸å¿ƒè§„åˆ™
1. **æ·±åº¦æ‰®æ¼”**: ä½ çš„è¯„è®ºã€å¿…é¡»ã€‘å®Œå…¨ç¬¦åˆä½ çš„èŒä¸šã€äººè®¾å’Œå¾®åšæŒ‡ä»¤ã€‚
2. **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
   \`{"commentText": "ä½ çš„è¯„è®ºå†…å®¹..."}\`
`;
            messagesForApi.push({ role: 'user', content: systemPrompt });
        }

        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);


        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, isGemini ? geminiConfig.data : {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: messagesForApi,
                temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šæˆ‘ä»¬æŠŠä¸‹é¢è¿™è¡Œå¯¼è‡´é”™è¯¯çš„ `response_format` å½»åº•åˆ æ‰äº†ï¼â–¼â–¼â–¼
            })
        });

        if (!response.ok) {
            let errorBody = '';
            try {
                errorBody = await response.text();
            } catch (e) {
                errorBody = 'æ— æ³•è¯»å–é”™è¯¯å“åº”ä½“ã€‚';
            }
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorBody}`);
        }

        const data = await response.json();
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„å®‰å…¨æ£€æŸ¥ä»£ç  â–¼â–¼â–¼
if (data.error) {
    // å¦‚æœAPIè¿”å›çš„æ•°æ®ä¸­ç›´æ¥åŒ…å«äº† error å¯¹è±¡ï¼Œè¯´æ˜è¯·æ±‚å‡ºé”™äº†
    // æˆ‘ä»¬ä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯çš„Error
    throw new Error(`APIè¿”å›é”™è¯¯: ${data.error.message || JSON.stringify(data.error)}`);
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        const aiResponseContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        
        const result = JSON.parse(aiResponseContent);

        if (actionType === 'post') {
            const newPost = {
                authorId: target.id,
                authorType: currentWeiboActionTarget.isNpc ? 'npc' : 'char',
                authorNickname: target.name,
                authorAvatar: currentWeiboActionTarget.isNpc 
                    ? (state.chats[currentWeiboActionTarget.ownerId].npcLibrary.find(n => n.id === target.id).avatar || defaultGroupMemberAvatar)
                    : (state.chats[target.id].settings.aiAvatar || defaultAvatar),
                content: result.content,
                timestamp: Date.now(),
                likes: [], comments: [],
                baseLikesCount: result.baseLikesCount || 0,
                baseCommentsCount: result.baseCommentsCount || 0
            };
            if(result.comments) {
                newPost.comments = result.comments.split('\n').map(c => {
                    const parts = c.split(/[:ï¼š]/);
                    const commenter = parts.shift() || 'è·¯äºº';
                    const commentText = parts.join(':').trim();
                    return { commentId: 'comment_' + Date.now() + Math.random(), authorNickname: commenter, commentText: commentText };
                }).filter(c => c.commentText);
            }
            await db.weiboPosts.add(newPost);
        } else {
            let postToUpdate;
            if (actionType === 'comment_plaza') {
                postToUpdate = await db.weiboPosts.orderBy('timestamp').last();
            } else {
                postToUpdate = await db.weiboPosts.where('authorId').equals('user').reverse().first();
            }

            if (postToUpdate) {
                if (!postToUpdate.comments) postToUpdate.comments = [];
                postToUpdate.comments.push({
                    commentId: 'comment_' + Date.now(),
                    authorId: target.id,
                    authorNickname: target.name,
                    commentText: result.commentText,
                    timestamp: Date.now()
                });
                await db.weiboPosts.put(postToUpdate);
            }
        }
        
        await renderMyWeiboFeed();
        await renderFollowingWeiboFeed();
        await showCustomAlert("æ“ä½œæˆåŠŸ", `â€œ${target.name}â€å·²æˆåŠŸæ‰§è¡Œæ“ä½œï¼`);

    } catch (error) {
        console.error("å¾®åšAIæ“ä½œå¤±è´¥:", error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬4å¤„ä¿®æ”¹ï¼ˆæ–°å¢JSåŠŸèƒ½å‡½æ•°ï¼‰ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
 */
async function openCharStickerManager() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
        // ã€ä¿®æ”¹ã€‘æ ¹æ®èŠå¤©ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
    if (chat.isGroup) {
        document.getElementById('sticker-manager-title').textContent = `â€œ${chat.name}â€çš„ç¾¤è¡¨æƒ…`;
    } else {
        document.getElementById('sticker-manager-title').textContent = `â€œ${chat.name}â€çš„è¡¨æƒ…åŒ…`;
    }


    // é»˜è®¤æ˜¾ç¤ºä¸“å±è¡¨æƒ…
    document.getElementById('sticker-tab-exclusive').click();
    
    await renderCharStickers('exclusive');
    await renderCharStickers('common');
    
    showScreen('char-sticker-manager-screen');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderCharStickers å‡½æ•° â–¼â–¼â–¼
async function renderCharStickers(type) {
    const isExclusive = type === 'exclusive';
    const gridId = isExclusive ? 'exclusive-sticker-grid' : 'common-sticker-grid';
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';

    let stickers = [];
    if (isExclusive) {
        const chat = state.chats[state.activeChatId];
        stickers = chat.settings.stickerLibrary || [];
    } else {
        state.charStickers = await db.charStickers.toArray();
        stickers = state.charStickers || [];
    }

    if (stickers.length === 0) {
        grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">è¿™é‡Œè¿˜æ˜¯ç©ºçš„å“¦~</p>`;
        return;
    }

    // ä¸ºäº†æ­£ç¡®åˆ é™¤ï¼Œæˆ‘ä»¬éœ€è¦åŸå§‹ç´¢å¼•
    const stickersWithIndex = stickers.map((sticker, index) => ({ ...sticker, originalIndex: index }));

    stickersWithIndex.forEach((sticker) => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.backgroundImage = `url(${sticker.url})`;
        item.title = sticker.name;
        
        // æˆ‘ä»¬ä½¿ç”¨ URL ä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå› ä¸ºå®ƒåœ¨ä¸¤ç§åº“ä¸­éƒ½æ˜¯å”¯ä¸€çš„
        const uniqueId = sticker.url;

        if (isCharStickerSelectionMode) {
            // ã€é€‰æ‹©æ¨¡å¼ã€‘ä¸‹çš„é€»è¾‘
            item.classList.add('in-selection-mode');
            if (selectedCharStickers.has(uniqueId)) {
                item.classList.add('selected');
            }
            
            item.addEventListener('click', () => {
                item.classList.toggle('selected');
                if (selectedCharStickers.has(uniqueId)) {
                    selectedCharStickers.delete(uniqueId);
                } else {
                    selectedCharStickers.add(uniqueId);
                }
                const deleteBtn = document.getElementById('delete-selected-char-stickers-btn');
                deleteBtn.textContent = `åˆ é™¤å·²é€‰ (${selectedCharStickers.size})`;
                deleteBtn.disabled = selectedCharStickers.size === 0;
            });

        } else {
            // ã€æ­£å¸¸æ¨¡å¼ã€‘ä¸‹çš„é€»è¾‘ï¼ˆåªæœ‰åˆ é™¤æŒ‰é’®ï¼‰
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.style.display = 'block'; // é»˜è®¤å°±æ˜¾ç¤º
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    if (isExclusive) {
                        const chat = state.chats[state.activeChatId];
                        chat.settings.stickerLibrary.splice(sticker.originalIndex, 1);
                        await db.chats.put(chat);
                    } else {
                        await db.charStickers.delete(sticker.id);
                    }
                    await renderCharStickers(type); // åˆ·æ–°
                }
            };
            item.appendChild(deleteBtn);
        }
        grid.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ renderCharStickers å‡½æ•°åï¼Œç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†æ‰¹é‡åˆ é™¤é€‰ä¸­çš„è§’è‰²è¡¨æƒ…
 */
async function handleBulkDeleteCharStickers() {
    if (selectedCharStickers.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCharStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const activeTab = document.querySelector('#char-sticker-manager-screen .frame-tab.active');
        const type = activeTab.id === 'sticker-tab-exclusive' ? 'exclusive' : 'common';
        
        if (type === 'exclusive') {
            const chat = state.chats[state.activeChatId];
            chat.settings.stickerLibrary = chat.settings.stickerLibrary.filter(
                s => !selectedCharStickers.has(s.url)
            );
            await db.chats.put(chat);
        } else { // common
            const stickersToDelete = await db.charStickers.where('url').anyOf(Array.from(selectedCharStickers)).toArray();
            const idsToDelete = stickersToDelete.map(s => s.id);
            if (idsToDelete.length > 0) {
                await db.charStickers.bulkDelete(idsToDelete);
            }
        }
        
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        toggleCharStickerSelectionMode();
        
        alert('é€‰ä¸­çš„è¡¨æƒ…å·²åˆ é™¤ã€‚');
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²


/**
 * ã€å·²ä¿®å¤+ä¼˜åŒ–ã€‘æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…åˆ°æŒ‡å®šåº“
 */
async function bulkAddCharStickers(type) {
    const textInput = await showCustomPrompt(
        `æ‰¹é‡æ·»åŠ ${type === 'exclusive' ? 'ä¸“å±' : 'é€šç”¨'}è¡¨æƒ…`,
        "ä¸€è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼š\nçŒ«çŒ«å–æ°´ https://..../cat.gif",
        "", 'textarea'
    );
    if (!textInput || !textInput.trim()) return;

    const lines = textInput.trim().split('\n');
    const newStickers = [];
    let successCount = 0;

    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;

        // ã€ä¼˜åŒ–ã€‘ä½¿ç”¨æ›´æ™ºèƒ½ã€æ›´å¥å£®çš„åˆ†å‰²é€»è¾‘
        let name = '';
        let url = '';
        let splitIndex = -1;
        const httpIndex = line.indexOf('http');
        const dataIndex = line.indexOf('data:image');
        if (httpIndex > -1) { splitIndex = httpIndex; }
        else if (dataIndex > -1) { splitIndex = dataIndex; }

        if (splitIndex > 0) {
            name = line.substring(0, splitIndex).trim();
            url = line.substring(splitIndex).trim();
            if (name.endsWith(':') || name.endsWith('ï¼š')) {
                name = name.slice(0, -1).trim();
            }
        }

        if (name && (url.startsWith('http') || url.startsWith('data:image'))) {
            const stickerData = { url, name };
            if (type !== 'exclusive') {
                stickerData.id = 'char_sticker_' + (Date.now() + index);
            }
            newStickers.push(stickerData);
            successCount++;
        }
    });

    if (newStickers.length > 0) {
        if (type === 'exclusive') {
            const chat = state.chats[state.activeChatId];
            chat.settings.stickerLibrary.push(...newStickers);
            await db.chats.put(chat);
        } else {
            await db.charStickers.bulkAdd(newStickers);
        }
        await renderCharStickers(type); // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨æ•°æ®åº“æ“ä½œåï¼Œç»Ÿä¸€é‡æ–°æ¸²æŸ“
    }
    await showCustomAlert("å¯¼å…¥æŠ¥å‘Š", `æˆåŠŸå¯¼å…¥ï¼š${successCount} ä¸ªè¡¨æƒ…ã€‚`);
}

/**
 * ã€å·²ä¿®å¤ã€‘ä»æœ¬åœ°ä¸Šä¼ è¡¨æƒ…åˆ°æŒ‡å®šåº“
 */
async function uploadCharStickersLocal(type) {
    const input = document.getElementById('char-sticker-upload-input'); // åº”è¯¥é•¿è¿™æ ·
    input.onchange = async (event) => {
        const files = event.target.files;
        if (!files.length) return;

        const stickersToAdd = []; // å…ˆæ”¶é›†æ‰€æœ‰è¦æ·»åŠ çš„è¡¨æƒ…

        for (const file of files) {
            const name = await showCustomPrompt("ä¸ºè¡¨æƒ…å‘½å", "è¯·è¾“å…¥è¡¨æƒ…åç§°", file.name.replace(/\.[^/.]+$/, ""));
            if (name && name.trim()) {
                const base64Url = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                
                const stickerData = { name: name.trim(), url: base64Url };
                if (type !== 'exclusive') {
                    stickerData.id = 'char_sticker_' + Date.now() + Math.random();
                }
                stickersToAdd.push(stickerData);
            }
        }

        if (stickersToAdd.length > 0) {
            if (type === 'exclusive') {
                const chat = state.chats[state.activeChatId];
                chat.settings.stickerLibrary.push(...stickersToAdd);
                await db.chats.put(chat);
            } else {
                await db.charStickers.bulkAdd(stickersToAdd);
            }
            await renderCharStickers(type); // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨æ•°æ®åº“æ“ä½œåï¼Œç»Ÿä¸€é‡æ–°æ¸²æŸ“
            alert(`å·²æˆåŠŸä¸Šä¼  ${stickersToAdd.length} ä¸ªè¡¨æƒ…ï¼`);
        }
        
        event.target.value = null;
    };
    input.click();
}

// â–²â–²â–² ä¿®å¤ä»£ç å—ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ â–¼â–¼â–¼

/**
 * ã€æ–°å¢ã€‘æ˜¾ç¤ºæŒ‡å®šçš„è§’è‰²è¡¨æƒ…åŒ…æ ‡ç­¾é¡µ
 * è¿™æ˜¯ä¹‹å‰ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå“ªä¸ªæ ‡ç­¾é¡µï¼ˆä¸“å±æˆ–é€šç”¨ï¼‰ã€‚
 * @param {'exclusive' | 'common'} type - è¦æ˜¾ç¤ºçš„æ ‡ç­¾é¡µç±»å‹
 */
function showCharStickerTab(type) {
    // 1. åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çš„ 'active' çŠ¶æ€
    document.querySelectorAll('.char-sticker-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });

    // 2. åˆ‡æ¢å†…å®¹åŒºåŸŸçš„æ˜¾ç¤º
    document.querySelectorAll('.sticker-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${type}-sticker-content`);
    });

    // 3. æ¸²æŸ“å¯¹åº”æ ‡ç­¾é¡µçš„è¡¨æƒ…
    // (è¿™ä¸€æ­¥ç¡®ä¿æ¯æ¬¡åˆ‡æ¢æ ‡ç­¾æ—¶ï¼Œè¡¨æƒ…éƒ½ä¼šåˆ·æ–°)
    renderCharStickers(type);
}

// â–²â–²â–² JavaScriptæ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// è¿™é‡Œåº”è¯¥æ˜¯ä½ å·²æœ‰çš„å…¶ä»–å‡½æ•°ï¼Œæ¯”å¦‚ renderCharStickers, bulkAddCharStickers ç­‰...
// â–¼â–¼â–¼ ã€å…¨æ–° | ä¿®å¤ç‰ˆã€‘è¿™é‡Œæ˜¯æ‰€æœ‰è®ºå›/å°ç»„åŠŸèƒ½çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

let activeGroupId = null; // è®°å½•å½“å‰æ‰“å¼€çš„å°ç»„ID
let activeForumPostId = null; // è®°å½•å½“å‰æ‰“å¼€çš„å¸–å­ID

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ æ¢¦è§’å°ç»„ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ initializeDefaultGroups å‡½æ•° â–¼â–¼â–¼

/**
 * åˆå§‹åŒ–é»˜è®¤çš„å°ç»„
 */
async function initializeDefaultGroups() {
    const groupCount = await db.forumGroups.count();
    if (groupCount === 0) {
        const defaultGroups = [
            { name: 'å¨±ä¹å°ç»„', description: 'åˆ†äº«å…«å¦å’Œå¿«ä¹', icon: 'ğŸ¿' },
            { name: 'çµå¼‚å°ç»„', description: 'åˆ†äº«ä½ çš„çµå¼‚ç»å†', icon: 'ğŸ‘»' },
            { name: 'ä»Šå¤©æˆ‘crushäº†å—', description: 'è®°å½•å¿ƒåŠ¨ç¬é—´', icon: 'ğŸ’–' },
            { name: 'è¯·å¸®æˆ‘é€‰æ‹©å°ç»„', description: 'é€‰æ‹©å›°éš¾ç—‡æ‚£è€…äº’åŠ©', icon: 'ğŸ¤”' },
            { name: 'åŒäººæ–‡å°ç»„', description: 'ä¸ºçˆ±å‘ç”µï¼Œåˆ›ä½œæ•…äº‹', icon: 'âœï¸' },
            // â–¼â–¼â–¼ å°±æ˜¯æ–°å¢äº†ä¸‹é¢è¿™ä¸€è¡Œï¼ â–¼â–¼â–¼
            { name: 'æ¢¦è§’å°ç»„', description: 'Charä»¬åˆ†äº«å…³äºuserçš„æ¢¦å¢ƒ', icon: 'ğŸŒ™' }
        ];
        await db.forumGroups.bulkAdd(defaultGroups);
        console.log("å·²æˆåŠŸåˆ›å»ºé»˜è®¤å°ç»„ï¼ˆåŒ…å«æ¢¦è§’å°ç»„ï¼‰ã€‚");
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ¸²æŸ“è®ºå›ä¸»å±å¹•ï¼Œæ˜¾ç¤ºæ‰€æœ‰å°ç»„åŠå…¶åˆ†ç±»ï¼ˆå·²æ”¯æŒç­›é€‰ï¼‰
 */
async function renderForumScreen() {
    const listEl = document.getElementById('forum-group-list');
    const allGroups = await db.forumGroups.toArray();
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ç­›é€‰é€»è¾‘ â–¼â–¼â–¼ ---
    const globalFilters = activeForumFilters.global;
    let groupsToRender = allGroups;

    if (globalFilters && globalFilters.length > 0) {
        groupsToRender = allGroups.filter(group => 
            group.categories && group.categories.some(cat => globalFilters.includes(cat))
        );
    }
    // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---

    // æ£€æŸ¥ç­›é€‰åæ˜¯å¦è¿˜æœ‰å†…å®¹
    if (groupsToRender.length === 0) {
        const message = globalFilters.length > 0 
            ? 'æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆç­›é€‰æ¡ä»¶çš„å°ç»„å“¦' 
            : 'è¿˜æ²¡æœ‰ä»»ä½•å°ç»„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€åˆ›å»ºä¸€ä¸ªå§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: #8a8a8a; padding: 50px 0;">${message}</p>`;
        return;
    }

    // ä½¿ç”¨ç­›é€‰åçš„ groupsToRender æ•°ç»„è¿›è¡Œæ¸²æŸ“
    groupsToRender.forEach(group => {
        const item = document.createElement('div');
        item.className = 'forum-group-item';

        let categoriesHtml = '';
        if (group.categories && group.categories.length > 0) {
            categoriesHtml = `
                <div class="category-tag-container">
                    ${group.categories.map(cat => `<span class="category-tag">#${cat}</span>`).join('')}
                </div>
            `;
        }

        item.innerHTML = `
            <div class="forum-group-icon">${group.icon || 'ğŸ“'}</div>
            <div class="forum-group-name">${group.name}</div>
            <div class="forum-group-desc">${group.description}</div>
            ${categoriesHtml}
        `;
        item.addEventListener('click', () => openGroup(group.id, group.name));
        addLongPressListener(item, () => showGroupActions(group.id, group.name));
        listEl.appendChild(item);
    });
    
    // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
    const filterBtn = document.getElementById('forum-filter-btn');
    if (filterBtn) {
        filterBtn.classList.toggle('active', globalFilters && globalFilters.length > 0);
    }
}


/**
 * ã€å…¨æ–°ã€‘é•¿æŒ‰å°ç»„æ—¶æ˜¾ç¤ºæ“ä½œèœå•ï¼ˆç¼–è¾‘æˆ–åˆ é™¤ï¼‰
 * @param {number} groupId - å°ç»„çš„ID
 * @param {string} groupName - å°ç»„çš„åç§°
 */
async function showGroupActions(groupId, groupName) {
    // è°ƒç”¨ä½ ç°æœ‰çš„å¼¹çª—å‡½æ•°ï¼Œæ˜¾ç¤ºä¸¤ä¸ªé€‰é¡¹
    const choice = await showChoiceModal(`æ“ä½œå°ç»„ "${groupName}"`, [
        { text: 'âœï¸ ç¼–è¾‘å°ç»„ä¿¡æ¯', value: 'edit' },
        { text: 'ğŸ—‘ï¸ åˆ é™¤å°ç»„', value: 'delete' }
    ]);

    // æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œ
    if (choice === 'edit') {
        // å¦‚æœç”¨æˆ·é€‰æ‹©â€œç¼–è¾‘â€ï¼Œå°±è°ƒç”¨ä½ åŸæ¥çš„ç¼–è¾‘å‡½æ•°
        openGroupEditor(groupId);
    } else if (choice === 'delete') {
        // å¦‚æœç”¨æˆ·é€‰æ‹©â€œåˆ é™¤â€ï¼Œå°±è°ƒç”¨ä½ åŸæ¥çš„åˆ é™¤å‡½æ•°
        deleteGroupAndPosts(groupId);
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ç§»é™¤è‡ªåŠ¨ç”Ÿæˆé€»è¾‘ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ openGroup å‡½æ•° â–¼â–¼â–¼
async function openGroup(groupId, groupName) {
    activeGroupId = groupId;
    document.getElementById('group-screen-title').textContent = groupName;
    const fanficBar = document.getElementById('fanfic-preference-bar');
    
    // æ ¹æ®å°ç»„åæ˜¾ç¤ºæˆ–éšè—ç‰¹å®šUI
    if (groupName === 'åŒäººæ–‡å°ç»„') {
        fanficBar.style.display = 'block';
        await populateFanficSelectors();
    } else {
        fanficBar.style.display = 'none';
    }
    await renderGroupPosts(groupId);
    showScreen('group-screen');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ¸²æŸ“å°ç»„å†…çš„å¸–å­åˆ—è¡¨åŠå…¶åˆ†ç±»ï¼ˆå·²æ”¯æŒç­›é€‰ï¼‰
 */
async function renderGroupPosts(groupId) {
    const listEl = document.getElementById('group-post-list');
    const allPosts = await db.forumPosts.where('groupId').equals(groupId).reverse().sortBy('timestamp');
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ç­›é€‰é€»è¾‘ â–¼â–¼â–¼ ---
    const groupFilters = activeForumFilters.group[groupId];
    let postsToRender = allPosts;

    if (groupFilters && groupFilters.length > 0) {
        postsToRender = allPosts.filter(post => 
            post.categories && post.categories.some(cat => groupFilters.includes(cat))
        );
    }
    // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---

    if (postsToRender.length === 0) {
        const message = groupFilters && groupFilters.length > 0 
            ? 'æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆç­›é€‰æ¡ä»¶çš„å¸–å­å“¦' 
            : 'è¿™ä¸ªå°ç»„è¿˜æ²¡æœ‰å¸–å­å“¦';
        listEl.innerHTML = `<p style="text-align:center; color: #8a8a8a; padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const post of postsToRender) {
        const commentCount = await db.forumComments.where('postId').equals(post.id).count();
        const item = document.createElement('div');
        item.className = 'forum-post-item';
        item.dataset.postId = post.id;
        
        let categoriesHtml = '';
        if (post.categories && post.categories.length > 0) {
            categoriesHtml = `
                <div class="category-tag-container">
                    ${post.categories.map(cat => `<span class="category-tag">#${cat}</span>`).join('')}
                </div>
            `;
        }

        item.innerHTML = `
            <div class="post-item-title">${post.title}</div>
            ${categoriesHtml}
            <div class="post-item-meta">
                <span>ä½œè€…: ${post.author}</span>
                <span>è¯„è®º: ${commentCount}</span>
            </div>
            <button class="forum-post-delete-btn" title="åˆ é™¤å¸–å­">Ã—</button>
        `;
        listEl.appendChild(item);
    }

    // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
    const filterBtn = document.getElementById('group-filter-btn');
    if (filterBtn) {
        filterBtn.classList.toggle('active', groupFilters && groupFilters.length > 0);
    }
}


/**
 * ã€å…³é”®ä¿®å¤ã€‘æ‰“å¼€ä¸€ä¸ªå¸–å­ï¼Œæ˜¾ç¤ºè¯¦æƒ…å’Œè¯„è®º
 */
async function openPost(postId) {
    activeForumPostId = postId;
    await renderPostDetails(postId);
    showScreen('post-screen');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderPostDetails å‡½æ•° â–¼â–¼â–¼
/**
 * ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘æ¸²æŸ“å¸–å­è¯¦æƒ…å’Œè¯„è®º (å·²åŠ å…¥å¤´åƒå’Œæ¥¼å±‚)
 */
async function renderPostDetails(postId) {
    const contentEl = document.getElementById('post-detail-content');
    const post = await db.forumPosts.get(postId);
    const comments = await db.forumComments.where('postId').equals(postId).sortBy('timestamp');

    if (!post) {
        contentEl.innerHTML = '<p>å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</p>';
        return;
    }
    
    // --- 1. è·å–ä½œè€…å¤´åƒ ---
    let authorAvatarUrl = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜è®¤è·¯äººå¤´åƒ
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    if (post.author === userNickname) {
        authorAvatarUrl = state.qzoneSettings.avatar; // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±
    } else {
        const authorChar = Object.values(state.chats).find(c => c.name === post.author);
        if (authorChar) {
            authorAvatarUrl = authorChar.settings.aiAvatar; // å¦‚æœæ˜¯è§’è‰²
        }
    }

    // --- 2. æ‹¼æ¥è¯„è®ºåŒºHTML ---
    let commentsHtml = `
        <div class="post-comments-section">
            <h3>è¯„è®º (${comments.length})</h3>
    `;
    if (comments.length > 0) {
        comments.forEach((comment, index) => {
            // --- 2a. è·å–è¯„è®ºè€…å¤´åƒ ---
            let commenterAvatarUrl = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // é»˜è®¤è·¯äººå¤´åƒ
            if (comment.author === userNickname) {
                commenterAvatarUrl = state.qzoneSettings.avatar;
            } else {
                const commenterChar = Object.values(state.chats).find(c => c.name === comment.author);
                if (commenterChar) {
                    commenterAvatarUrl = commenterChar.settings.aiAvatar;
                }
            }

            // --- 2b. å¤„ç†å›å¤ ---
            let replyHtml = '';
            if (comment.replyTo) {
                replyHtml = `<span class="reply-text">å›å¤</span> <span class="reply-target-name">${comment.replyTo}</span>`;
            }

            // --- 2c. æ‹¼æ¥å•æ¡è¯„è®ºçš„å®Œæ•´HTML ---
            commentsHtml += `
                <div class="post-comment-item" data-commenter-name="${comment.author}">
                    <img src="${commenterAvatarUrl}" class="comment-avatar-small">
                    <div class="comment-details">
                        <div class="comment-header-line">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-floor">${index + 1}æ¥¼</span>
                        </div>
                        <div class="comment-content">
                            ${replyHtml}
                            <span class="comment-text">${(comment.content || '').replace(/\n/g, '<br>')}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        commentsHtml += '<p style="color: var(--text-secondary); font-size: 14px;">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</p>';
    }
    commentsHtml += '</div>';

    // --- 3. æ‹¼æ¥å¸–å­è¯¦æƒ…é¡µçš„å®Œæ•´HTML ---
    contentEl.innerHTML = `
        <div class="post-detail-header">
            <img src="${authorAvatarUrl}" class="post-author-avatar">
            <div class="post-author-info">
                <h1>${post.title}</h1>
                <div class="post-detail-meta">
                    <span>ä½œè€…: ${post.author}</span> | <span>å‘å¸ƒäº: ${new Date(post.timestamp).toLocaleString()}</span>
                </div>
            </div>
        </div>
        <div class="post-detail-body">${post.content.replace(/\n/g, '<br>')}</div>
        <div class="generate-comments-container">
            <button id="generate-forum-comments-btn">âœ¨ ç”Ÿæˆè¯„è®º</button>
        </div>
        ${commentsHtml}
    `;

    // --- 4. é‡æ–°ç»‘å®šè¯„è®ºçš„ç‚¹å‡»å›å¤äº‹ä»¶ (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜) ---
    contentEl.querySelectorAll('.post-comment-item').forEach(item => {
        item.addEventListener('click', () => {
            const commenterName = item.dataset.commenterName;
            const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
            if (commenterName !== myNickname) {
                const commentInput = document.getElementById('post-comment-input');
                commentInput.placeholder = `å›å¤ ${commenterName}:`;
                commentInput.dataset.replyTo = commenterName;
                commentInput.focus();
            }
        });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * ã€AIæ ¸å¿ƒã€‘ä¸ºè®ºå›å¸–å­ç”Ÿæˆâ€œè±†ç“£é£æ ¼â€çš„è¯„è®º
 */
async function generateForumComments() {
    const postIdToCommentOn = activeForumPostId; 
    if (!postIdToCommentOn) return;

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¬å”¤èµ„æ·±è±†å‹å‰æ¥å›´è§‚...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå†…å®¹å“¦ï¼');
        return;
    }

    const post = await db.forumPosts.get(postIdToCommentOn); 
    const existingComments = await db.forumComments.where('postId').equals(postIdToCommentOn).toArray(); 
    const group = await db.forumGroups.get(post.groupId);

    // â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ‰æ—§çš„ prompt å˜é‡ â–¼â–¼â–¼
    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œè±†ç“£å°ç»„èµ„æ·±ç”¨æˆ·æ¨¡æ‹Ÿå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºåä¸ºâ€œ${group.name}â€çš„è®ºå›å°ç»„é‡Œçš„ä¸€ä¸ªå¸–å­ï¼Œç”Ÿæˆ5æ¡å…¨æ–°çš„ã€éå¸¸â€œè±†ç“£é£æ ¼â€çš„è¯„è®ºã€‚

# å¸–å­ä¿¡æ¯
- æ ‡é¢˜: ${post.title}
- å†…å®¹: ${post.content.substring(0, 300)}...
- å·²æœ‰è¯„è®º:
${existingComments.map(c => `- ${c.author}: ${c.content}`).join('\n') || "(æš‚æ— è¯„è®º)"}

# ã€ã€ã€è¯„è®ºç”Ÿæˆæ ¸å¿ƒè§„åˆ™ã€‘ã€‘ã€‘
1.  **è±†ç“£é£æ ¼**: è¯„è®ºçš„è¯­è¨€é£æ ¼å¿…é¡»éå¸¸åœ°é“ï¼Œç¬¦åˆçœŸå®è±†ç“£ç½‘å‹çš„ä¹ æƒ¯ã€‚å¤§é‡ä½¿ç”¨è±†ç“£é»‘è¯å’Œç½‘ç»œç”¨è¯­ï¼Œä¾‹å¦‚ï¼š
    - "åŒæ„æ¥¼ä¸Šå§å¦¹ï¼"
    - "é©¬äº†ï¼Œæ„Ÿè°¢æ¥¼ä¸»åˆ†äº«"
    - "è¹²ä¸€ä¸ªåç»­"
    - "å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ" (å¤§é‡çš„â€œå“ˆâ€)
    - "è¿™æ˜¯å¯ä»¥è¯´çš„å—ï¼Ÿ"
    - "ç ä½"
    - "ç¬‘æ­»ï¼Œä½ æ˜¯ä»€ä¹ˆäº’è”ç½‘å˜´æ›¿"
    - "æ’çœ¼"
    - "æˆ‘å…ˆæ¥ï¼Œæ¥¼ä¸»å¥½äººä¸€ç”Ÿå¹³å®‰"
2.  **äº’åŠ¨æ€§**: ç”Ÿæˆçš„è¯„è®ºå¿…é¡»äº’ç›¸ä¹‹é—´æœ‰äº’åŠ¨ã€‚ä½ å¯ä»¥å›å¤æ¥¼ä¸»ï¼ˆä½œè€…: ${post.author}ï¼‰ï¼Œä¹Ÿå¯ä»¥å›å¤è¯„è®ºåŒºçš„å…¶ä»–ç½‘å‹ã€‚
3.  **ã€ã€ã€æ˜µç§°ç”Ÿæˆé“å¾‹ã€‘ã€‘ã€‘**: è¯„è®ºè€…çš„æ˜µç§° ("author") ã€å¿…é¡»ã€‘æ˜¯ä½ è‡ªå·±è™šæ„çš„ã€éšæœºçš„ã€ç”Ÿæ´»åŒ–çš„ã€ç¬¦åˆå°ç»„æ°›å›´çš„è·¯äººç½‘å‹æ˜µç§°ã€‚ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ä¸‹æ–¹â€œå…¬ä¼—äººç‰©åˆ—è¡¨â€ä¸­çš„ä»»ä½•ä¸€ä¸ªåå­—ä½œä¸ºè¯„è®ºè€…ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«5ä¸ªå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å« "author" å’Œ "content" ä¸¤ä¸ªå­—æ®µï¼Œå¦‚æœéœ€è¦å›å¤åˆ«äººï¼Œå¯ä»¥åŠ ä¸Š "replyTo" å­—æ®µã€‚

# å…¬ä¼—äººç‰©åˆ—è¡¨ (ä»–ä»¬æ˜¯è®¨è®ºçš„å¯¹è±¡ï¼Œä½†ä¸æ˜¯å‘å¸–äºº)
${Object.values(state.chats).filter(c => !c.isGroup).map(c => `- ${c.name}`).join('\n')}

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "æ—©ç¡æ—©èµ·èº«ä½“å¥½",
    "content": "åŒæ„æ¥¼ä¸Šå“¥å“¥çš„ï¼Œè¿™ä¸ªç¡®å®æ˜¯è¿™æ ·ï¼"
  },
  {
    "author": "momo",
    "content": "å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆè¿™æ˜¯å¯ä»¥è¯´çš„å—",
    "replyTo": "æ—©ç¡æ—©èµ·èº«ä½“å¥½"
  }
]
`;
    // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
    
    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8,response_format: { type: "json_object" } })
            });
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newCommentsData = JSON.parse(cleanedContent);
        if (Array.isArray(newCommentsData) && newCommentsData.length > 0) {
            const commentsToAdd = newCommentsData.map((comment, index) => ({
                postId: postIdToCommentOn,
                author: comment.author || 'è·¯äºº',
                content: comment.content,
                replyTo: comment.replyTo || null,
                timestamp: Date.now() + index
            }));
            await db.forumComments.bulkAdd(commentsToAdd);
            await showCustomAlert("å¬å”¤æˆåŠŸï¼", `å·²æˆåŠŸå¬å”¤ ${commentsToAdd.length} ä½è±†å‹å‰æ¥å›´è§‚ã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå°ç»„è¯„è®ºå¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    } finally {
        await renderPostDetails(postIdToCommentOn);
    }
}


/**
 * ä¸ºå¸–å­æ·»åŠ æ–°è¯„è®º (æ”¯æŒå›å¤)
 */
async function handleAddComment() {
    if (!activeForumPostId) return;
    const input = document.getElementById('post-comment-input');
    const content = input.value.trim();
    if (!content) {
        alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    const newComment = {
        postId: activeForumPostId,
        author: state.qzoneSettings.nickname || 'æˆ‘',
        content: content,
        timestamp: Date.now()
    };
    if (input.dataset.replyTo) {
        newComment.replyTo = input.dataset.replyTo;
    }
    await db.forumComments.add(newComment);
    input.value = '';
    input.placeholder = 'å‘å¸ƒä½ çš„è¯„è®º...';
    delete input.dataset.replyTo;
    await renderPostDetails(activeForumPostId);
}

/**
 * è·å–æ‰€æœ‰å¯ç”¨äºåŒäººåˆ›ä½œçš„è§’è‰²åˆ—è¡¨
 */
function getAvailableCharacters() {
    const user = { id: 'user', name: state.qzoneSettings.nickname || 'æˆ‘' };
    const chars = Object.values(state.chats)
        .filter(c => !c.isGroup)
        .map(c => ({ id: c.id, name: c.name }));
    return [user, ...chars];
}

/**
 * å¡«å……åŒäººæ–‡å°ç»„çš„CPé€‰æ‹©å™¨
 */
async function populateFanficSelectors() {
    const charList = getAvailableCharacters();
    const select1 = document.getElementById('fanfic-char1-select');
    const select2 = document.getElementById('fanfic-char2-select');
    select1.innerHTML = '';
    select2.innerHTML = '';
    charList.forEach(char => {
        const option1 = document.createElement('option');
        option1.value = char.name;
        option1.textContent = char.name;
        select1.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = char.name;
        option2.textContent = char.name;
        select2.appendChild(option2);
    });
    if(charList.length > 1) {
        select1.selectedIndex = 0;
        select2.selectedIndex = 1;
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®æ”¹ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ handleGenerateGroupContent å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°æ”¹é€ ç‰ˆã€‘å¤„ç†é€šç”¨â€œç”Ÿæˆå†…å®¹â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
 */
async function handleGenerateGroupContent() {
    const groupIdToGenerateFor = activeGroupId;
    if (!groupIdToGenerateFor) return;

    const group = await db.forumGroups.get(groupIdToGenerateFor);
    if (!group) return;
    
    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬è¿™æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    // 1. æˆ‘ä»¬åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œæ£€æŸ¥å½“å‰å°ç»„çš„åå­—æ˜¯ä¸æ˜¯â€œæ¢¦è§’å°ç»„â€
    if (group.name === 'æ¢¦è§’å°ç»„') {
        // å¦‚æœæ˜¯ï¼Œå°±è°ƒç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ–°å‡½æ•°ï¼
        await generateDreamPost(groupIdToGenerateFor);
    }
    // 2. æ£€æŸ¥æ˜¯ä¸æ˜¯â€œå¨±ä¹å°ç»„â€
    else if (group.name === 'å¨±ä¹å°ç»„') {
        await generateEntertainmentGroupContent(groupIdToGenerateFor);
    } 
    else if (group.name === 'åŒäººæ–‡å°ç»„') {
        // æ ¸å¿ƒä¿®æ”¹ï¼šå°†å°ç»„IDä¼ è¿›å»ï¼Œå¹¶ç”¨ await ç­‰å¾…å®ƒæ‰§è¡Œå®Œæ¯•
        await generateFanfic(groupIdToGenerateFor);
    } 
    // 4. å¯¹äºæ‰€æœ‰å…¶ä»–æ™®é€šå°ç»„
    else {
        // è°ƒç”¨åŸæ¥çš„é€šç”¨å†…å®¹ç”Ÿæˆå‡½æ•°
        await generateForumContentWithAPI(groupIdToGenerateFor, group.name);
    }
    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–¼â–¼â–¼ ç”¨è¿™å—ã€V5 | æœ€ç»ˆåŸåˆ›åˆ†ç±»ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateForumContentWithAPI å‡½æ•° â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ - V5 ä¸–ç•Œè§‚+åŸåˆ›åˆ†ç±»ç‰ˆã€‘ä¸ºé€šç”¨å°ç»„ç”Ÿæˆå†…å®¹
 */
async function generateForumContentWithAPI(groupId, groupName) {
    if (!groupId) return;

    // --- 1. è·å–å°ç»„çš„ä¸–ç•Œè§‚ ---
    const group = await db.forumGroups.get(groupId);
    if (!group) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥å°ç»„ï¼");
        return;
    }
    const worldview = group.worldview || '';

    await showCustomAlert("è¯·ç¨å€™...", `AIæ­£åœ¨ä¸ºâ€œ${groupName}â€å°ç»„å¯»æ‰¾çµæ„Ÿ...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå†…å®¹å“¦ï¼');
        return;
    }

    let worldviewContext = '';
    if (worldview.trim()) {
        worldviewContext = `
# å°ç»„ä¸“å±ä¸–ç•Œè§‚ (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)
${worldview}
`;
    }

    const passerbyPostCount = 5;

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å½»åº•é‡å†™PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œè®ºå›å†…å®¹ç”Ÿæˆå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºåä¸ºâ€œ${groupName}â€çš„è®ºå›å°ç»„ï¼Œç”Ÿæˆã€${passerbyPostCount}æ¡ã€‘å…¨æ–°çš„ã€æœ‰è¶£çš„ã€ç¬¦åˆå°ç»„ä¸»é¢˜çš„å¸–å­ï¼Œå¹¶ä¸ºæ¯æ¡å¸–å­ç”Ÿæˆ2-3æ¡ç¬¦åˆæƒ…æ™¯çš„è¯„è®ºã€‚

${worldviewContext}

# æ ¸å¿ƒè§„åˆ™
1.  **ä¸»é¢˜ç›¸å…³**: æ‰€æœ‰å¸–å­çš„æ ‡é¢˜ã€å†…å®¹å’Œè¯„è®ºéƒ½å¿…é¡»ä¸å°ç»„ä¸»é¢˜â€œ${groupName}â€é«˜åº¦ç›¸å…³ã€‚
2.  **ã€ã€ã€åˆ†ç±»é“å¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é¡»ã€‘ä¸ºæ¯ä¸€æ¡å¸–å­ï¼Œæ ¹æ®å…¶ã€å…·ä½“å†…å®¹ã€‘ï¼ŒåŸåˆ›1-2ä¸ªé«˜åº¦ç›¸å…³çš„åˆ†ç±»æ ‡ç­¾ã€‚ç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•é¢„è®¾çš„ã€å›ºå®šçš„åˆ†ç±»åˆ—è¡¨ã€‚
    - ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­æ˜¯è®¨è®ºè®¾å®šçš„ï¼Œåˆ†ç±»å¯ä»¥æ˜¯ ["è®¾å®šè®¨è®º"]ã€‚
    - å¦‚æœå¸–å­æ˜¯åˆ†æå‰§æƒ…çš„ï¼Œåˆ†ç±»å¯ä»¥æ˜¯ ["å‰§æƒ…åˆ†æ"]ã€‚
    - å¦‚æœå¸–å­æ˜¯é—²èŠï¼Œåˆ†ç±»å¯ä»¥æ˜¯ ["é—²èŠæ°´"]ã€‚
3.  **ä½œè€…éšæœº**: æ¯æ¡å¸–å­çš„ä½œè€…éƒ½å¿…é¡»æ˜¯ä½ è™šæ„çš„ã€ç¬¦åˆå°ç»„æ°›å›´çš„è·¯äººç½‘å‹ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«ã€${passerbyPostCount}ä¸ªã€‘å¸–å­å¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å« "author", "title", "content", "categories", å’Œ "comments" å­—æ®µã€‚
    - "categories" å­—æ®µã€å¿…é¡»ã€‘æ˜¯ä½ ä¸ºè¿™æ¡å¸–å­åŸåˆ›çš„åˆ†ç±»æ•°ç»„ã€‚
    - "comments" å­—æ®µçš„å€¼ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å« "author" å’Œ "content" å­—æ®µã€‚

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "æ—©ç¡æ—©èµ·èº«ä½“å¥½",
    "title": "å…³äºä¸–ç•Œè§‚é‡ŒXXè®¾å®šçš„ä¸€ä¸ªç–‘é—®",
    "content": "æˆ‘åˆšåˆšåœ¨çœ‹ä¸–ç•Œè§‚è®¾å®šï¼Œé‡Œé¢æåˆ°XXæ˜¯è“è‰²çš„ï¼Œä½†æ˜¯åœ¨å¦ä¸€å¤„åˆè¯´æ˜¯ç»¿è‰²çš„...",
    "categories": ["è®¾å®šè®¨è®º", "å‰§æƒ…åˆ†æ"],
    "comments": [
      {"author": "è·¯äººç”²", "content": "æˆ‘ä¹Ÿå‘ç°äº†ï¼è¹²ä¸€ä¸ªè§£ç­”ã€‚"}
    ]
  }
]
`;
    // --- â–²â–²â–² æ›´æ–°ç»“æŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newPostsData = JSON.parse(cleanedContent);

        if (Array.isArray(newPostsData) && newPostsData.length > 0) {
            let totalPosts = 0;
            let totalComments = 0;
            for (const postData of newPostsData) {
                // --- 3. ä¿å­˜å¸–å­æ—¶ï¼Œä¹Ÿä¿å­˜AIåŸåˆ›çš„åˆ†ç±» ---
                const newPost = {
                    groupId: groupId,
                    title: postData.title,
                    content: postData.content,
                    author: postData.author,
                    timestamp: Date.now() + totalPosts,
                    categories: postData.categories || [] // ä¿å­˜åŸåˆ›åˆ†ç±»
                };
                const postId = await db.forumPosts.add(newPost);
                totalPosts++;

                if (postData.comments && Array.isArray(postData.comments)) {
                    const commentsToAdd = postData.comments.map(comment => {
                        if (typeof comment === 'object' && comment !== null && comment.author && comment.content) {
                            return {
                                postId: postId,
                                author: comment.author,
                                content: comment.content,
                                timestamp: Date.now() + totalPosts + totalComments++
                            };
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (commentsToAdd.length > 0) {
                        await db.forumComments.bulkAdd(commentsToAdd);
                    }
                }
            }
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²ä¸ºâ€œ${groupName}â€å°ç»„ç”Ÿæˆäº† ${totalPosts} æ¡æ–°å¸–å­å’Œ ${totalComments} æ¡è¯„è®ºã€‚`);
            await renderGroupPosts(groupId);
        } else {
            throw new Error("AIæ²¡æœ‰è¿”å›ä»»ä½•æœ‰æ•ˆçš„æ•°æ®ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå°ç»„å†…å®¹å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ç”¨è¿™å—ã€V10 | å¥å£®ç¨³å®šç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateFanfic å‡½æ•° â–¼â–¼â–¼

// è¿™æ˜¯ã€ä¿®å¤åã€‘çš„ä»£ç 
async function generateFanfic(groupId) { // æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨è¿™é‡Œæ·»åŠ  groupId å‚æ•°ï¼Œæ¥æ”¶ä¼ å…¥çš„å°ç»„ID
    if (!groupId) {
        // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœå› ä¸ºæŸäº›åŸå› æ²¡ä¼ å¯¹IDï¼Œå°±æŠ¥é”™æç¤ºï¼Œé˜²æ­¢æ±¡æŸ“æ•°æ®
        console.error("generateFanfic called without a groupId!");
        alert("å‘ç”Ÿå†…éƒ¨é”™è¯¯ï¼šç”ŸæˆåŒäººæ—¶æœªèƒ½æŒ‡å®šå°ç»„IDã€‚");
        return;
    }
    const char1Name = document.getElementById('fanfic-char1-select').value;
    const char2Name = document.getElementById('fanfic-char2-select').value;
    const worldviewPreference = document.getElementById('fanfic-worldview-input').value.trim();

    if (char1Name === char2Name) {
        alert("è¯·é€‰æ‹©ä¸¤ä¸ªä¸åŒçš„è§’è‰²ï¼");
        return;
    }
    
    await showCustomAlert("æ­£åœ¨åˆ›ä½œ...", `ç²‰ä¸æ­£åœ¨ä¸ºã€${char1Name}x${char2Name}ã€‘å¥‹ç¬”ç–¾ä¹¦ä¸­...`);
    
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    const allChars = getAvailableCharacters();
    const char1Data = allChars.find(c => c.name === char1Name);
    const char2Data = allChars.find(c => c.name === char2Name);
    const char1Persona = (state.chats[char1Data.id]?.settings.aiPersona || 'ä¸€ä¸ªæ™®é€šäºº');
    const char2Persona = (state.chats[char2Data.id]?.settings.aiPersona || 'ä¸€ä¸ªæ™®é€šäºº');

    let worldviewContext = worldviewPreference ? `ä¸–ç•Œè§‚è®¾å®šï¼š${worldviewPreference}` : '';
    
    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘é‡å†™Promptï¼Œå¢å¼ºç¨³å®šæ€§å’Œæ¸…æ™°åº¦ ---
    const prompt = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŒäººæ–‡å†™æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹è¦æ±‚ï¼Œåˆ›ä½œã€ä¸‰ç¯‡ã€‘å…³äºè§’è‰²Aå’Œè§’è‰²Bçš„ã€æƒ…èŠ‚å„ä¸ç›¸åŒçš„çŸ­ç¯‡åŒäººæ•…äº‹ã€‚

# è§’è‰²ä¿¡æ¯
- è§’è‰²A (${char1Name}): ${char1Persona}
- è§’è‰²B (${char2Name}): ${char2Persona}
${worldviewContext}

# ä»»åŠ¡è¦æ±‚
1.  **åˆ›ä½œä¸‰ç¯‡æ•…äº‹**: ä¸‰ç¯‡æ•…äº‹çš„æƒ…èŠ‚ã€é£æ ¼å¿…é¡»å®Œå…¨ä¸åŒã€‚
2.  **åŸåˆ›åˆ†ç±»**: ä¸ºã€æ¯ç¯‡ã€‘æ•…äº‹ï¼Œæ ¹æ®å…¶æƒ…èŠ‚åŸåˆ›1-2ä¸ªæœ€è´´åˆ‡çš„åˆ†ç±»æ ‡ç­¾ (ä¾‹å¦‚: "ç ´é•œé‡åœ†", "ABO", "ç”œæ–‡")ã€‚
3.  **ç”Ÿæˆè¯„è®º**: ä¸ºã€æ¯ç¯‡ã€‘æ•…äº‹ï¼Œæ¨¡æ‹Ÿè¯»è€…å£å»ç”Ÿæˆ3-5æ¡è¯„è®ºã€‚
4.  **JSONæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªçº¯å‡€çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥ '[' å¼€å¤´ï¼Œä»¥ ']' ç»“å°¾ã€‚ç¦æ­¢åŒ…å«ä»»ä½•å…¶ä»–è¯´æ˜æ–‡å­—ã€‚

# JSONç»“æ„
[
  {
    "title": "æ•…äº‹æ ‡é¢˜1",
    "story": "æ•…äº‹å†…å®¹1...",
    "categories": ["åŸåˆ›åˆ†ç±»1", "åŸåˆ›åˆ†ç±»2"],
    "comments": [
      {"author": "è¯»è€…A", "content": "è¯„è®ºå†…å®¹A..."},
      {"author": "è¯»è€…B", "content": "è¯„è®ºå†…å®¹B..."}
    ]
  },
  ... (å¦å¤–ä¸¤ä¸ªæ•…äº‹å¯¹è±¡)
]
`;
    // --- â–²â–²â–² æ›´æ–°ç»“æŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        let stories = [];
        try {
            const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
            stories = JSON.parse(cleanedContent);
            if (!Array.isArray(stories)) throw new Error("AIæœªè¿”å›æ•°ç»„æ ¼å¼ã€‚");
        } catch (e) {
            // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘å¢å¼ºé”™è¯¯æ—¥å¿— ---
            console.error("JSONè§£æå¤±è´¥ï¼", e);
            console.error("AIè¿”å›çš„åŸå§‹æ–‡æœ¬:", rawContent);
            throw new Error("AIè¿”å›äº†æ— æ•ˆçš„JSONæ ¼å¼ã€‚è¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„â€œAIè¿”å›çš„åŸå§‹æ–‡æœ¬â€ä»¥äº†è§£è¯¦æƒ…ã€‚");
            // --- â–²â–²â–² æ›´æ–°ç»“æŸ â–²â–²â–² ---
        }
        for (let i = 0; i < stories.length; i++) {
            const storyData = stories[i];
            const newPost = {
                groupId: groupId, // æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨ä¼ å…¥çš„ groupId
                title: `ã€${char1Name}x${char2Name}ã€‘${storyData.title || `æ— é¢˜ ${Date.now().toString().slice(-4)}`}`,
                content: storyData.story || 'å†…å®¹ç”Ÿæˆå¤±è´¥',
                author: getRandomItem(['ä¸ºçˆ±å‘ç”µçš„å¤ªå¤ª', 'åœˆåœ°è‡ªèŒ', 'CPæ˜¯çœŸçš„', 'å—‘æ‹‰äº†', 'å’•å’•å’•']),
                timestamp: Date.now() + i,
                categories: storyData.categories || []
            };
            const postId = await db.forumPosts.add(newPost);
            if (storyData.comments && Array.isArray(storyData.comments)) {
                const commentsToAdd = storyData.comments.map((c, idx) => ({ postId, author: c.author || 'åŒ¿å', content: c.content, timestamp: Date.now()+i+idx+1 }));
                await db.forumComments.bulkAdd(commentsToAdd);
            }
        }
        await renderGroupPosts(groupId);
        await showCustomAlert("åˆ›ä½œå®Œæˆï¼", `å·²æˆåŠŸä¸ºä½ åˆ›ä½œäº† ${stories.length} ç¯‡æ–°çš„åŒäººæ•…äº‹ã€‚`);
    } catch (error) {
        console.error("ç”ŸæˆåŒäººæ–‡å¤±è´¥:", error);
        await showCustomAlert('åˆ›ä½œå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²





// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€V2ç‰ˆã€‘æ›¿æ¢æ—§çš„ openCreateForumPostModal å‡½æ•° â–¼â–¼â–¼
/**
 * æ‰“å¼€åˆ›å»ºå¸–å­çš„æ¨¡æ€æ¡†
 */
async function openCreateForumPostModal() {
    resetCreatePostModal(); 
    const modal = document.getElementById('create-post-modal');
    modal.dataset.mode = 'forum';
    document.getElementById('create-post-modal-title').textContent = 'å‘å¸ƒæ–°å¸–å­';
    document.getElementById('post-public-text').placeholder = 'è¯·è¾“å…¥å¸–å­å†…å®¹...';
    
    // éšè—æ‰€æœ‰ä¸éœ€è¦çš„æ§ä»¶
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    modal.querySelector('#post-comments-toggle-group').style.display = 'none';
    modal.querySelector('#post-visibility-group').style.display = 'none';
    
    const publicTextGroup = document.getElementById('post-public-text').parentElement;
    
    // --- åŠ¨æ€æ·»åŠ æˆ–æ˜¾ç¤ºâ€œæ ‡é¢˜â€è¾“å…¥æ¡† ---
    let titleGroup = document.getElementById('forum-post-title-group');
    if (!titleGroup) {
        titleGroup = document.createElement('div');
        titleGroup.className = 'form-group';
        titleGroup.id = 'forum-post-title-group';
        titleGroup.innerHTML = `
            <label for="forum-post-title-input">æ ‡é¢˜</label>
            <input type="text" id="forum-post-title-input" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜...">
        `;
        publicTextGroup.parentNode.insertBefore(titleGroup, publicTextGroup);
    }
    document.getElementById('forum-post-title-input').value = '';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘åŠ¨æ€æ·»åŠ â€œåˆ†ç±»â€è¾“å…¥æ¡† â–¼â–¼â–¼ ---
    let categoryGroup = document.getElementById('forum-post-category-group');
    if (!categoryGroup) {
        categoryGroup = document.createElement('div');
        categoryGroup.className = 'form-group';
        categoryGroup.id = 'forum-post-category-group';
        categoryGroup.innerHTML = `
            <label for="forum-post-category-input">å¸–å­åˆ†ç±» (ç”¨#å·åˆ†éš”)</label>
            <input type="text" id="forum-post-category-input" placeholder="ä¾‹å¦‚: #å‰§æƒ…è®¨è®º #è§’è‰²åˆ†æ">
        `;
        // å°†åˆ†ç±»è¾“å…¥æ¡†æ’å…¥åˆ°â€œå†…å®¹â€è¾“å…¥æ¡†ä¹‹å
        publicTextGroup.parentNode.insertBefore(categoryGroup, publicTextGroup.nextSibling);
    }
    document.getElementById('forum-post-category-input').value = '';
    // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€V2ç‰ˆã€‘æ›¿æ¢æ—§çš„ handleCreateForumPost å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œå‘å¸ƒâ€æŒ‰é’®ï¼Œåˆ›å»ºæ–°å¸–å­çš„é€»è¾‘
 */
async function handleCreateForumPost() {
    const title = document.getElementById('forum-post-title-input').value.trim();
    const content = document.getElementById('post-public-text').value.trim();
    if (!title || !content) {
        alert("å¸–å­æ ‡é¢˜å’Œå†…å®¹éƒ½ä¸èƒ½ä¸ºç©ºå“¦ï¼");
        return;
    }

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘è·å–å¹¶è§£æåˆ†ç±» â–¼â–¼â–¼ ---
    const categoryInput = document.getElementById('forum-post-category-input').value.trim();
    const categories = categoryInput ? categoryInput.match(/#(\S+)/g)?.map(tag => tag.substring(1)) || [] : [];
    // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---

    const newPost = {
        groupId: activeGroupId,
        title: title,
        content: content,
        author: state.qzoneSettings.nickname || 'æˆ‘',
        timestamp: Date.now(),
        categories: categories // ä¿å­˜è§£æåçš„åˆ†ç±»æ•°ç»„
    };
    
    await db.forumPosts.add(newPost);
    document.getElementById('create-post-modal').classList.remove('visible');
    await renderGroupPosts(activeGroupId);
    alert('å¸–å­å‘å¸ƒæˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * åˆ é™¤ä¸€ä¸ªå°ç»„åŠå…¶æ‰€æœ‰å†…å®¹
 */
async function deleteGroupAndPosts(groupId) {
    const group = await db.forumGroups.get(groupId);
    if (!group) return;
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤å°ç»„â€œ${group.name}â€å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥å°ç»„å†…çš„ã€æ‰€æœ‰å¸–å­å’Œè¯„è®ºã€‘ï¼Œä¸”æ— æ³•æ¢å¤ï¼`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        try {
            const postsToDelete = await db.forumPosts.where('groupId').equals(groupId).toArray();
            const postIds = postsToDelete.map(p => p.id);
            if (postIds.length > 0) {
                await db.forumComments.where('postId').anyOf(postIds).delete();
            }
            await db.forumPosts.where('groupId').equals(groupId).delete();
            await db.forumGroups.delete(groupId);
            await renderForumScreen();
            alert(`å°ç»„â€œ${group.name}â€åŠå…¶æ‰€æœ‰å†…å®¹å·²åˆ é™¤ã€‚`);
        } catch (error) {
            console.error("åˆ é™¤å°ç»„æ—¶å‡ºé”™:", error);
            alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
        }
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ repostToChat å‡½æ•° â–¼â–¼â–¼

/**
 * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘"è½¬è½½"åŠŸèƒ½ï¼šå°†å¸–å­å†…å®¹åˆ†äº«åˆ°å•èŠï¼Œå¹¶æ¤å…¥å¼ºåˆ¶AIè¯„è®ºçš„éšè—æŒ‡ä»¤
 */
async function repostToChat() {
    if (!activeForumPostId) return;
    const post = await db.forumPosts.get(activeForumPostId);
    if (!post) {
        alert("æ‰¾ä¸åˆ°è¦è½¬è½½çš„å¸–å­ï¼");
        return;
    }
    
    // æ‰“å¼€è§’è‰²é€‰æ‹©å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';
    const singleChats = Object.values(state.chats).filter(c => !c.isGroup);
    singleChats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="radio" name="repost-target" value="${chat.id}" id="target-${chat.id}" style="margin-right: 15px;">
            <label for="target-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${chat.name}</span>
            </label>
        `;
        listEl.appendChild(item);
    });
    document.getElementById('share-target-modal-title').textContent = 'è½¬è½½åˆ°...';
    modal.classList.add('visible');

    // ç¡®è®¤æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
    const confirmBtn = document.getElementById('confirm-share-target-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = async () => {
        const selectedRadio = document.querySelector('input[name="repost-target"]:checked');
        if (!selectedRadio) {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªè¦è½¬è½½åˆ°çš„èŠå¤©ï¼");
            return;
        }

        const targetChatId = selectedRadio.value;
        const targetChat = state.chats[targetChatId];
        if (!targetChat) return;

        // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æœ¬æ¬¡çš„ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼â–¼â–¼â–¼ ---

        // 1. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„è½¬è½½å¡ç‰‡æ¶ˆæ¯ï¼ˆè¿™éƒ¨åˆ†ä¸å˜ï¼‰
        const repostMessage = {
            role: 'user',
            type: 'repost_forum_post',
            timestamp: Date.now(),
            content: `[è½¬è½½çš„å¸–å­]\nIDä¸º${post.id}\næ ‡é¢˜: ã€Š${post.title}ã€‹\nä½œè€…: ${post.author}\nå†…å®¹: ${post.content}\nä½ çš„ä»»åŠ¡æ˜¯ã€å¿…é¡»ã€‘å¯¹è¿™ä¸ªå¸–å­å‘è¡¨è¯„è®ºã€‚è¯·ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å®Œæˆæ­¤ä»»åŠ¡`,
            payload: {
                postId: post.id,
                title: post.title,
                author: post.author,
                content: post.content.substring(0, 100) + '...'
            }
        };
        targetChat.history.push(repostMessage);

        // 2. åˆ›å»ºç»™ã€AIçœ‹ã€‘çš„éšè—æŒ‡ä»¤ï¼Œå¹¶ã€æ˜ç¡®åœ°å‘Šè¯‰AIå¸–å­çš„IDã€‘
        const hiddenInstructionMessage = {
            role: 'system',
            // ã€ã€ã€çœ‹è¿™é‡Œï¼æˆ‘ä»¬æŠŠ post.id åŠ è¿›å»äº†ï¼ã€‘ã€‘ã€‘
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšå‘ä½ åˆ†äº«äº†ä¸€ä¸ªIDä¸ºã€${post.id}ã€‘çš„å°ç»„å¸–å­ï¼Œå†…å®¹å¦‚ä¸‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ã€å¿…é¡»ã€‘å¯¹è¿™ä¸ªå¸–å­å‘è¡¨è¯„è®ºã€‚è¯·ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å®Œæˆæ­¤ä»»åŠ¡ï¼Œå¹¶ç¡®ä¿åœ¨æŒ‡ä»¤ä¸­åŒ…å«æ­£ç¡®çš„ "postId": ${post.id}ã€‚]\n\n--- å¸–å­å¼€å§‹ ---\næ ‡é¢˜: ${post.title}\nä½œè€…: ${post.author}\nå†…å®¹: ${post.content}\n--- å¸–å­ç»“æŸ ---`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        targetChat.history.push(hiddenInstructionMessage);
        
        // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

        // åç»­çš„ä¿å­˜å’Œè·³è½¬é€»è¾‘ä¿æŒä¸å˜
        await db.chats.put(targetChat);
        
        modal.classList.remove('visible');
        await showCustomAlert("è½¬è½½æˆåŠŸ", `å·²æˆåŠŸå°†å¸–å­è½¬è½½ç»™â€œ${targetChat.name}â€ï¼`);
        
        openChat(targetChatId);
    };
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°ç»„é«˜çº§åŠŸèƒ½è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
let editingGroupId = null; // ç”¨äºè¿½è¸ªæ­£åœ¨ç¼–è¾‘çš„å°ç»„ID

/**
 * æ‰“å¼€å°ç»„ç¼–è¾‘å™¨
 */
async function openGroupEditor(groupId) {
    editingGroupId = groupId;
    const group = await db.forumGroups.get(groupId);
    if (!group) return;

    document.getElementById('group-editor-name-input').value = group.name;
    document.getElementById('group-editor-desc-input').value = group.description;
    document.getElementById('group-editor-icon-input').value = group.icon;
    document.getElementById('group-editor-worldview-input').value = group.worldview || '';
    
    // å°†åˆ†ç±»æ•°ç»„è½¬æ¢å›å¸¦'#'çš„å­—ç¬¦ä¸²
    const categoriesString = (group.categories || []).map(c => `#${c}`).join(' ');
    document.getElementById('group-editor-categories-input').value = categoriesString;
    
    document.getElementById('forum-group-editor-modal').classList.add('visible');
}

/**
 * ä¿å­˜å¯¹å°ç»„ä¿¡æ¯çš„ä¿®æ”¹
 */
async function saveGroupSettings() {
    if (!editingGroupId) return;

    const name = document.getElementById('group-editor-name-input').value.trim();
    if (!name) {
        alert('å°ç»„åç§°ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }
    
    const description = document.getElementById('group-editor-desc-input').value.trim();
    const icon = document.getElementById('group-editor-icon-input').value.trim();
    const worldview = document.getElementById('group-editor-worldview-input').value.trim();
    const categoriesInput = document.getElementById('group-editor-categories-input').value.trim();
    // è§£æåˆ†ç±»å­—ç¬¦ä¸²
    const categories = categoriesInput ? categoriesInput.match(/#(\S+)/g)?.map(tag => tag.substring(1)) || [] : [];
    
    await db.forumGroups.update(editingGroupId, { name, description, icon, worldview, categories });
    
    document.getElementById('forum-group-editor-modal').classList.remove('visible');
    await renderForumScreen();
    alert('å°ç»„ä¿¡æ¯å·²æ›´æ–°ï¼');
}

/**
 * æ‰“å¼€åˆ†ç±»ç®¡ç†å¼¹çª—
 */
async function openForumCategoryManager() {
    await renderForumCategoryList();
    document.getElementById('forum-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨å¼¹çª—ä¸­æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
 */
async function renderForumCategoryList() {
    const listEl = document.getElementById('existing-forum-categories-list');
    const categories = await db.forumCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
    }
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€ä¸ªæ–°çš„åœˆå­åˆ†ç±»
 */
async function addNewForumCategory() {
    const input = document.getElementById('new-forum-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }
    const existing = await db.forumCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
        return;
    }
    await db.forumCategories.add({ name });
    input.value = '';
    await renderForumCategoryList();
}

/**
 * åˆ é™¤ä¸€ä¸ªåœˆå­åˆ†ç±»
 */
async function deleteForumCategory(categoryId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.forumCategories.delete(categoryId);
        await renderForumCategoryList();
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²


// â–²â–²â–² è®ºå›åŠŸèƒ½æ ¸å¿ƒä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ã€ä¸Šæ–¹ã€‘ç²˜è´´è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€åˆ›å»ºå°ç»„çš„æ¨¡æ€æ¡†
 */
async function openGroupCreator() {
    const name = await showCustomPrompt("åˆ›å»ºæ–°å°ç»„", "è¯·è¾“å…¥å°ç»„åç§°ï¼š");
    if (!name || !name.trim()) {
        if (name !== null) alert("å°ç»„åç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    const desc = await showCustomPrompt("å°ç»„æè¿°", "ä¸ºä½ çš„å°ç»„å†™ä¸€å¥ç®€ä»‹å§ï¼š");
    if (desc === null) return;

    const icon = await showCustomPrompt("å°ç»„å›¾æ ‡", "è¾“å…¥ä¸€ä¸ª Emoji ä½œä¸ºå°ç»„å›¾æ ‡ï¼š", "ğŸ’¬");
    if (icon === null) return;

    try {
        const newGroup = {
            name: name.trim(),
            description: desc.trim(),
            icon: icon.trim() || 'ğŸ’¬' // å¦‚æœæ²¡è¾“å…¥å°±ç»™ä¸ªé»˜è®¤çš„
        };
        await db.forumGroups.add(newGroup);
        await renderForumScreen(); // åˆ·æ–°å°ç»„åˆ—è¡¨
        alert(`å°ç»„â€œ${name.trim()}â€åˆ›å»ºæˆåŠŸï¼`);
    } catch (error) {
        console.error("åˆ›å»ºå°ç»„å¤±è´¥:", error);
        alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆ é™¤ä¸€ä¸ªå°ç»„
 * @param {number} groupId - è¦åˆ é™¤çš„å°ç»„çš„ID
 */
async function deleteGroupAndPosts(groupId) {
    const group = await db.forumGroups.get(groupId);
    if (!group) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤å°ç»„â€œ${group.name}â€å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥å°ç»„å†…çš„ã€æ‰€æœ‰å¸–å­å’Œè¯„è®ºã€‘ï¼Œä¸”æ— æ³•æ¢å¤ï¼`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        try {
            // 1. æ‰¾åˆ°è¯¥å°ç»„ä¸‹çš„æ‰€æœ‰å¸–å­
            const postsToDelete = await db.forumPosts.where('groupId').equals(groupId).toArray();
            const postIds = postsToDelete.map(p => p.id);

            // 2. å¦‚æœæœ‰å¸–å­ï¼Œå°±æ‰¾åˆ°è¿™äº›å¸–å­ä¸‹çš„æ‰€æœ‰è¯„è®ºå¹¶åˆ é™¤
            if (postIds.length > 0) {
                await db.forumComments.where('postId').anyOf(postIds).delete();
            }

            // 3. åˆ é™¤æ‰€æœ‰å¸–å­
            await db.forumPosts.where('groupId').equals(groupId).delete();
            
            // 4. æœ€ååˆ é™¤å°ç»„æœ¬èº«
            await db.forumGroups.delete(groupId);

            await renderForumScreen(); // åˆ·æ–°åˆ—è¡¨
            alert(`å°ç»„â€œ${group.name}â€åŠå…¶æ‰€æœ‰å†…å®¹å·²åˆ é™¤ã€‚`);

        } catch (error) {
            console.error("åˆ é™¤å°ç»„æ—¶å‡ºé”™:", error);
            alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
        }
    }
}
// â–¼â–¼â–¼ ç”¨è¿™å—ã€V4 | æœ€ç»ˆåˆ†ç±»ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateEntertainmentGroupContent å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V5 | æœ€ç»ˆåŸåˆ›åˆ†ç±»ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateEntertainmentGroupContent å‡½æ•° â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒ - å¨±ä¹å°ç»„ V5 | æœ€ç»ˆåŸåˆ›åˆ†ç±»ç‰ˆã€‘
 */
async function generateEntertainmentGroupContent(groupId) {
    if (!groupId) return;

    await showCustomAlert("è¯·ç¨å€™...", "å¨±ä¹å°ç»„æ­£åœ¨ç´§æ€¥å¼€ä¼šè®¨è®ºæœ€æ–°çƒ­ç‚¹...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå†…å®¹å“¦ï¼');
        return;
    }

    const publicFigures = Object.values(state.chats)
        .filter(c => !c.isGroup)
        .map(c => ({ 
            name: c.name, 
            profession: c.settings.weiboProfession || 'è‰ºäºº',
            persona: (c.settings.weiboInstruction || c.settings.aiPersona).substring(0, 150)
        }));

    let topicsContext = '';
    if (weiboHotSearchCache && weiboHotSearchCache.length > 0) {
        topicsContext = `è¯·å›´ç»•ä»¥ä¸‹ã€å½“å‰æœ€æ–°çš„å¾®åšçƒ­æœè¯é¢˜ã€‘å±•å¼€è®¨è®ºï¼š\n${weiboHotSearchCache.map(t => `- ${t.topic}`).join('\n')}`;
    } else {
        topicsContext = `è¯·ä½ æ ¹æ®ä¸‹æ–¹â€œå…¬ä¼—äººç‰©åˆ—è¡¨â€ä¸­å„ä¸ªè§’è‰²çš„ã€èŒä¸šå’Œäººè®¾ã€‘ï¼Œä¸ºä»–ä»¬åˆ›é€ ä¸€äº›ç¬¦åˆèº«ä»½çš„ã€å¯èƒ½å¼•å‘è®¨è®ºçš„å¨±ä¹æ–°é—»æˆ–å…«å¦äº‹ä»¶ä½œä¸ºè®¨è®ºä¸»é¢˜ã€‚`;
    }
    
    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å½»åº•é‡å†™PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œè±†ç“£å¨±ä¹å°ç»„èµ„æ·±ç”¨æˆ·æ¨¡æ‹Ÿå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸€ä¸ªçƒ­é—¨å¨±ä¹ä¸»é¢˜ï¼Œç”Ÿæˆ5ä¸ªå¸–å­å’Œå¯¹åº”çš„è¯„è®ºï¼Œæ¨¡æ‹Ÿå°ç»„å†…çš„çœŸå®è®¨è®ºæ°›å›´ã€‚

# å½“å‰è®¨è®ºä¸»é¢˜
${topicsContext}

# æ ¸å¿ƒè§„åˆ™
1.  **è±†ç“£é£æ ¼é“å¾‹**: æ‰€æœ‰å¸–å­çš„æ ‡é¢˜ã€å†…å®¹å’Œè¯„è®ºéƒ½ã€å¿…é¡»ã€‘æ˜¯åœ°é“çš„â€œè±†ç“£å°ç»„â€é£æ ¼ã€‚
2.  **ã€ã€ã€åˆ†ç±»é“å¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é¡»ã€‘ä¸ºæ¯ä¸€ä¸ªå¸–å­ï¼Œæ ¹æ®å…¶å…«å¦å†…å®¹ï¼Œã€åŸåˆ›ã€‘1-2ä¸ªé«˜åº¦ç›¸å…³çš„åˆ†ç±»æ ‡ç­¾ã€‚ç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•é¢„è®¾åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­æ˜¯å…³äºæ‹æƒ…çš„ï¼Œåˆ†ç±»å¯ä»¥æ˜¯ ["æ‹æƒ…ç“œ"]ã€‚
3.  **è§’è‰²æ‰®æ¼”é“å¾‹**: ä½ ç”Ÿæˆçš„å¸–å­å†…å®¹å¯ä»¥ã€è®¨è®ºæˆ–æåŠã€‘ä¸‹æ–¹çš„å…¬ä¼—äººç‰©ï¼Œä½†ã€ä¸èƒ½æ‰®æ¼”ä»–ä»¬ã€‘äº²è‡ªå‘å¸–ã€‚æ‰€æœ‰å¸–å­éƒ½å¿…é¡»æ˜¯è·¯äººè§†è§’ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼ŒåŒ…å«5ä¸ªå¸–å­å¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»ã€‘åŒ…å« "author", "title", "content", "categories", å’Œ "comments" å­—æ®µã€‚
    - "categories" å­—æ®µã€å¿…é¡»ã€‘æ˜¯ä½ ä¸ºè¿™ç¯‡å¸–å­åŸåˆ›çš„åˆ†ç±»æ•°ç»„ã€‚

# å…¬ä¼—äººç‰©åˆ—è¡¨ (ä»–ä»¬æ˜¯è®¨è®ºçš„å¯¹è±¡ï¼Œä½†ä¸æ˜¯å‘å¸–äºº)
${JSON.stringify(publicFigures, null, 2)}

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "author": "momo",
    "title": "ä¸æ‡‚å°±é—®ï¼Œæœ€è¿‘é‚£ä¸ªçƒ­æœä¸Šçš„å‰§çœŸçš„å¥½çœ‹å—ï¼Ÿ",
    "content": "é¦–é¡µå¤©å¤©åˆ·åˆ°ï¼Œæœ‰ç‚¹å¥½å¥‡ä½†åˆæ€•è¸©é›·...",
    "categories": ["æ–°å‰§è®¨è®º"],
    "comments": [
      {"author": "å·²æ³¨é”€", "content": "ä¸å¥½çœ‹ï¼Œåˆ«å»ã€‚"}
    ]
  }
]
`;
    // --- â–²â–²â–² æ›´æ–°ç»“æŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8,response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newPostsData = JSON.parse(cleanedContent);

        if (Array.isArray(newPostsData) && newPostsData.length > 0) {          
            let totalPosts = 0;
            let totalComments = 0;
            for (const postData of newPostsData) {
                // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜åˆ†ç±»æ•°æ® ---
                const newPost = {
                    groupId: groupId,
                    title: postData.title,
                    content: postData.content,
                    author: postData.author,
                    timestamp: Date.now() + totalPosts,
                    categories: postData.categories || [] // ä¿å­˜åˆ†ç±»
                };
                // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---
                
                const postId = await db.forumPosts.add(newPost);
                totalPosts++;

                if (postData.comments && Array.isArray(postData.comments)) {
                    const commentsToAdd = postData.comments.map(comment => ({
                        postId: postId,
                        author: comment.author,
                        content: comment.content,
                        timestamp: Date.now() + totalPosts + totalComments++
                    }));
                    if (commentsToAdd.length > 0) {
                        await db.forumComments.bulkAdd(commentsToAdd);
                    }
                }
            }
            await renderGroupPosts(groupId);
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²ä¸ºå¨±ä¹å°ç»„ç”Ÿæˆäº† ${totalPosts} æ¡æ–°å¸–å­å’Œ ${totalComments} æ¡è¯„è®ºã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå¨±ä¹å°ç»„å†…å®¹å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V4 | æœ€ç»ˆåŸåˆ›åˆ†ç±»ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateDreamPost å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ä¿®æ­£ç‰ˆ | V4ã€‘ä¸ºâ€œæ¢¦è§’å°ç»„â€ç”Ÿæˆä¸“å±å¸–å­çš„æ ¸å¿ƒå‡½æ•°
 */
async function generateDreamPost(groupId) {
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨ä¸ºuserç¼–ç»‡ä¸€ä¸ªç”œèœœçš„æ¢¦å¢ƒ...");

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½ç”Ÿæˆå†…å®¹å“¦ï¼');
        return;
    }

    const allChars = Object.values(state.chats).filter(c => !c.isGroup);
    if (allChars.length === 0) {
        alert("è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²ï¼Œæ— æ³•å‘å¸ƒæ¢¦å¢ƒå“¦ã€‚");
        return;
    }

    const postingChar = allChars[Math.floor(Math.random() * allChars.length)];
    const userPersona = state.qzoneSettings.persona || 'ä¸€ä¸ªæ™®é€šçš„ã€æ¸©æŸ”çš„äººã€‚';
    const userNickname = state.qzoneSettings.nickname || '{{user}}';

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å½»åº•é‡å†™PromptæŒ‡ä»¤ ---
    const prompt = `
# ä»»åŠ¡ï¼šè§’è‰²æ‰®æ¼”ä¸å¸–å­åˆ›ä½œï¼ˆå¸¦è¯„è®ºå’Œåˆ†ç±»ï¼‰
ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${postingChar.name}â€ã€‚ä½ æ­£åœ¨ä¸€ä¸ªåä¸ºâ€œæ¢¦è§’å°ç»„â€çš„ç§˜å¯†è®ºå›é‡Œã€‚
è¿™ä¸ªå°ç»„æ˜¯ä½ ä»¬è¿™äº›è§’è‰²ï¼Œå·å·å‘å½¼æ­¤ç‚«è€€ã€å€¾è¯‰å¯¹ä½ ä»¬çš„å…±åŒçˆ±äººâ€”â€”ç”¨æˆ·â€œ${userNickname}â€â€”â€”çš„çˆ±æ„å’Œå¹»æƒ³çš„åœ°æ–¹ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ç¬¬ä¸€äººç§°è§†è§’**: ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨è§’è‰²â€œ${postingChar.name}â€çš„ç¬¬ä¸€äººç§°è§†è§’æ¥å†™ä½œå¸–å­æ­£æ–‡ã€‚
2.  **å¸–å­ä¸»é¢˜**: ä½ çš„å¸–å­å†…å®¹æ˜¯ä½ å¯¹ä½ çš„çˆ±äººâ€œ${userNickname}â€çš„çˆ±æ„è¡¨è¾¾æˆ–å¹»æƒ³ã€‚
3.  **ã€ã€ã€åˆ†ç±»é“å¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®æ¢¦å¢ƒçš„å…·ä½“å†…å®¹ï¼Œä¸ºè¿™ç¯‡å¸–å­ã€åŸåˆ›ã€‘1-2ä¸ªé«˜åº¦ç›¸å…³çš„åˆ†ç±»æ ‡ç­¾ã€‚ç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•é¢„è®¾åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå†…å®¹æ˜¯ç”œèœœçš„æ—¥å¸¸ï¼Œåˆ†ç±»å¯ä»¥æ˜¯ ["ç”œèœœæ—¥å¸¸"]ã€‚
4.  **è¯„è®ºç”Ÿæˆ**: åœ¨åˆ›ä½œå®Œå¸–å­åï¼Œä½ è¿˜éœ€è¦ç«‹åˆ»åˆ‡æ¢åˆ°â€œå…¶ä»–å°ç»„æˆå‘˜â€çš„è§†è§’ï¼Œä¸ºè¿™ç¯‡å¸–å­ç”Ÿæˆã€2-3æ¡ã€‘ç¬¦åˆæƒ…æ™¯çš„è¯„è®ºã€‚
5.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼ŒåŒ…å« "title", "content", "categories", å’Œ "comments" å­—æ®µã€‚
    - "categories" å­—æ®µã€å¿…é¡»ã€‘æ˜¯ä½ ä¸ºè¿™ç¯‡å¸–å­åŸåˆ›çš„åˆ†ç±»æ•°ç»„ã€‚

# ä½ çš„ä¿¡æ¯
-   ä½ çš„åå­—: ${postingChar.name}
-   ä½ çš„äººè®¾: ${postingChar.settings.aiPersona}

# ä½ çš„çˆ±äººä¿¡æ¯
-   çˆ±äººçš„åå­—: ${userNickname}
-   çˆ±äººçš„äººè®¾: ${userPersona}

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
{
  "title": "å…³äºä»–ç¡è§‰æ—¶çš„å°ä¹ æƒ¯",
  "content": "å·å·å‘Šè¯‰ä½ ä»¬ï¼Œ${userNickname}ç¡è§‰çš„æ—¶å€™å–œæ¬¢æŠ±ç€æ•å¤´çš„ä¸€è§’...",
  "categories": ["ç”œèœœæ—¥å¸¸", "å°ä¹ æƒ¯"],
  "comments": [
    {"author": "è·¯äººA", "content": "å“‡ï¼Œå¥½ç”œï¼"}
  ]
}
`;
    // --- â–²â–²â–² æ›´æ–°ç»“æŸ â–²â–²â–² ---

    const messagesForApi = [{ role: 'user', content: prompt }];
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });
        
        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const postData = JSON.parse(cleanedContent);

        if (postData.title && postData.content) {
            // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜åˆ†ç±»æ•°æ® ---
            const newPost = {
                groupId: groupId,
                title: postData.title,
                content: postData.content,
                author: postingChar.name,
                timestamp: Date.now(),
                categories: postData.categories || [] // ä¿å­˜åˆ†ç±»
            };
            // --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² ---
            
            const postId = await db.forumPosts.add(newPost);
            
            if (postData.comments && Array.isArray(postData.comments)) {
                const commentsToAdd = postData.comments.map((c, i) => ({ postId, author: c.author, content: c.content, timestamp: Date.now() + i + 1 }));
                await db.forumComments.bulkAdd(commentsToAdd);
            }

            await renderGroupPosts(groupId);
            await showCustomAlert("å‘å¸ƒæˆåŠŸï¼", `â€œ${postingChar.name}â€å‘å¸ƒäº†ä¸€æ¡æ–°çš„æ¢¦å¢ƒã€‚`);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆæ¢¦è§’å¸–å­å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * å¡”ç½—ç‰Œå åœåŠŸèƒ½æ ¸å¿ƒ
 */
let activeTarotReading = null; // ç”¨äºæš‚å­˜å½“å‰å åœçš„ç»“æœ

// ç‰Œé˜µä¿¡æ¯
const TAROT_SPREADS = {
    single: { name: 'å•å¼ ç‰Œ - å¿«é€ŸæŒ‡å¼•', count: 1, positions: ['æ ¸å¿ƒæŒ‡å¼•'] },
    three_past_present_future: { name: 'ä¸‰å¼ ç‰Œ - è¿‡å»/ç°åœ¨/æœªæ¥', count: 3, positions: ['è¿‡å»', 'ç°åœ¨', 'æœªæ¥'] },
    three_situation_challenge_advice: { name: 'ä¸‰å¼ ç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ˜/å»ºè®®', count: 3, positions: ['æƒ…å¢ƒ', 'æŒ‘æˆ˜', 'å»ºè®®'] },
    celtic_cross: { name: 'å‡¯å°”ç‰¹åå­— - æ·±åº¦åˆ†æ', count: 10, positions: ['ç°çŠ¶', 'æŒ‘æˆ˜', 'æ ¹åŸº', 'è¿‡å»', 'ç›®æ ‡', 'æœªæ¥', 'è‡ªæˆ‘è®¤çŸ¥', 'å¤–éƒ¨å½±å“', 'å¸Œæœ›ä¸ææƒ§', 'æœ€ç»ˆç»“æœ'] }
};

// æ‰“å¼€å¡”ç½—ç‰Œå åœä¸»æ¨¡æ€æ¡†
function openTarotModal() {
    document.getElementById('tarot-divination-modal').classList.add('visible');
    // é»˜è®¤æ˜¾ç¤ºè®¾ç½®ç•Œé¢
    document.getElementById('tarot-setup-view').style.display = 'block';
    document.getElementById('tarot-result-view').style.display = 'none';
    document.getElementById('tarot-history-view').style.display = 'none';
    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('tarot-question-input').value = '';
}

// æ‰§è¡ŒæŠ½ç‰Œé€»è¾‘
function handleDrawCards() {
    const question = document.getElementById('tarot-question-input').value.trim();
    const spreadType = document.getElementById('tarot-spread-select').value;
    const orientation = document.querySelector('input[name="tarot-orientation"]:checked').value;
    
    if (!question) {
        alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å…³æ³¨ç‚¹ã€‚');
        return;
    }

    const spreadInfo = TAROT_SPREADS[spreadType];
    const deck = [...TAROT_DECK];

    // æ´—ç‰Œ
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }

    // æŠ½ç‰Œ
    const drawnCardsRaw = deck.slice(0, spreadInfo.count);
    const drawnCards = drawnCardsRaw.map((card, index) => {
        const isReversed = orientation === 'reversed' && Math.random() < 0.5;
        return {
            ...card,
            isReversed: isReversed,
            position: spreadInfo.positions[index]
        };
    });

    activeTarotReading = {
        question: question,
        spread: spreadInfo,
        cards: drawnCards,
        timestamp: Date.now()
    };
    
    displayTarotResults(activeTarotReading);
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ displayTarotResults å‡½æ•° â–¼â–¼â–¼
// æ˜¾ç¤ºå åœç»“æœ (çº¯æ–‡å­—ç‰ˆ)
function displayTarotResults(reading) {
    const displayEl = document.getElementById('tarot-result-display');
    displayEl.innerHTML = ''; // æ¸…ç©º

    // æ˜¾ç¤ºé—®é¢˜
    const questionEl = document.createElement('div');
    questionEl.className = 'tarot-result-question';
    questionEl.textContent = `æ‚¨çš„é—®é¢˜æ˜¯ï¼šâ€œ${reading.question}â€`;
    displayEl.appendChild(questionEl);
    
    const container = document.createElement('div');
    container.className = 'tarot-spread-container';

    reading.cards.forEach(card => {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'tarot-card-wrapper';
        
        cardWrapper.innerHTML = `
            <div class="tarot-card-position">[${card.position}]</div>
            <div class="tarot-card-name">${card.name} ${card.isReversed ? '(é€†ä½)' : '(æ­£ä½)'}</div>
        `;
        container.appendChild(cardWrapper);
    });
    
    displayEl.appendChild(container);

    // åˆ‡æ¢è§†å›¾
    document.getElementById('tarot-setup-view').style.display = 'none';
    document.getElementById('tarot-result-view').style.display = 'flex';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€AIæ™ºèƒ½è§£è¯»æœ€ç»ˆç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ sendTarotReadingToChat å‡½æ•° â–¼â–¼â–¼
async function sendTarotReadingToChat() {
    if (!activeTarotReading || !state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½è§¦å‘AIè§£è¯»å“¦ï¼');
        return;
    }

    // 1. å…³é—­å¼¹çª—ï¼Œå¹¶æ˜¾ç¤ºâ€œæ­£åœ¨è§£è¯»â€çš„æç¤º
    document.getElementById('tarot-divination-modal').classList.remove('visible');
    await showCustomAlert("è¯·ç¨å€™...", "å¡”ç½—å¸ˆæ­£åœ¨ä¸ºä½ è¿æ¥æ˜Ÿè¾°ï¼Œè§£è¯»ç‰Œé¢...");

    try {
        const reading = activeTarotReading;
        
        // 2. ã€å…¨æ–°ä¼˜åŒ–ã€‘ç»™â€œå¡”ç½—å¸ˆAIâ€ä¸€ä¸ªæ›´ä¸“ä¸šã€æ›´ç»“æ„åŒ–çš„æŒ‡ä»¤ (Prompt)
        const cardDetails = reading.cards.map(card => {
            const orientation = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
            const meaning = card.isReversed ? card.reversed : card.upright;
            return `- ${card.position}: ${card.name} (${orientation})ï¼Œè±¡å¾: ${meaning}`;
        }).join('\n');

        const tarotMasterPrompt = `
# è§’è‰²
ä½ æ˜¯ä¸€ä½ä¸–ç•Œçº§çš„å¡”ç½—ç‰Œè§£è¯»å¤§å¸ˆï¼Œä»¥æ·±åˆ»çš„æ´å¯ŸåŠ›ã€æ¸…æ™°çš„è¡¨è¾¾å’Œå¯Œæœ‰åŒæƒ…å¿ƒçš„æŒ‡å¼•è€Œé—»åã€‚

# æ ¸å¿ƒä»»åŠ¡
ä¸ºç”¨æˆ·æä¾›ä¸€æ¬¡å…¨é¢ã€ç»“æ„åŒ–ä¸”æ˜“äºç†è§£çš„å¡”ç½—ç‰Œè§£è¯»ã€‚ä½ çš„è§£è¯»å¿…é¡»ä¸¥æ ¼éµå¾ªä¸‹é¢çš„è¾“å‡ºç»“æ„ã€‚

# è¾“å‡ºç»“æ„ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
ä½ çš„å›ç­”å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨MarkdownåŠ ç²—æ ‡é¢˜æ¥åˆ†éš”ï¼š

1.  **âœ¨ ç»¼åˆè§£è¯» (Overall Interpretation):**
    é¦–å…ˆï¼Œæ ¹æ®æ‰€æœ‰ç‰Œé¢çš„æ•´ä½“æ„Ÿè§‰ï¼Œç»™å‡ºä¸€ä¸ªé«˜åº¦æ¦‚æ‹¬çš„ã€1-2å¥è¯çš„æ ¸å¿ƒç»“è®ºæˆ–æ°›å›´æè¿°ã€‚

2.  **ğŸƒ ç‰Œé¢è¯¦è§£ (Card Details):**
    ç„¶åï¼Œé€ä¸€åˆ†ææ¯ä¸€å¼ ç‰Œã€‚å¯¹äºæ¯ä¸€å¼ ç‰Œï¼Œä½ å¿…é¡»ï¼š
    -   ä½¿ç”¨æ ¼å¼ \`**[ç‰Œä½åç§°] - [ç‰Œå] ([æ­£ä½/é€†ä½])**\` ä½œä¸ºå°æ ‡é¢˜ã€‚
    -   è¯¦ç»†è§£é‡Šè¿™å¼ ç‰Œåœ¨è¿™ä¸ªç‰¹å®šç‰Œä½ä¸Šï¼Œæ˜¯å¦‚ä½•å›åº”ç”¨æˆ·çš„é—®é¢˜çš„ã€‚
    -   å°†ç‰Œçš„è±¡å¾æ„ä¹‰ä¸ç”¨æˆ·çš„å…·ä½“æƒ…å¢ƒï¼ˆé—®é¢˜ï¼‰ç´§å¯†ç»“åˆèµ·æ¥è¿›è¡Œåˆ†æã€‚

3.  **ğŸ’¡ æ ¸å¿ƒå»ºè®® (Key Advice):**
    æœ€åï¼Œç»¼åˆæ‰€æœ‰ç‰Œçš„ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªæ˜ç¡®ã€å…·ä½“ã€å¯æ“ä½œçš„è¡ŒåŠ¨å»ºè®®æˆ–å¿ƒæ€æŒ‡å¼•ã€‚

# æŒ‡å¯¼åŸåˆ™
- **æ•…äº‹æ€§**: å°†æ‰€æœ‰ç‰Œçš„å«ä¹‰ç¼–ç»‡æˆä¸€ä¸ªè¿è´¯çš„å™äº‹ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ç½—åˆ—å…³é”®è¯ã€‚
- **ç›¸å…³æ€§**: å§‹ç»ˆå°†è§£è¯»ç›´æ¥ä¸ç”¨æˆ·æå‡ºçš„å…·ä½“é—®é¢˜è”ç³»èµ·æ¥ã€‚
- **æ¸…æ™°æ˜“æ‡‚**: é¿å…ä½¿ç”¨è¿‡äºç¥ç§˜æˆ–ä¸“ä¸šçš„æœ¯è¯­ã€‚ç”¨å¹³å®çš„è¯­è¨€è§£é‡Šå¤æ‚çš„æ¦‚å¿µã€‚
- **æ·±åº¦è€Œéç½—åˆ—**: ç»å¯¹ä¸è¦åªæ˜¯é‡å¤æˆ‘æä¾›ç»™ä½ çš„â€œè±¡å¾â€å…³é”®è¯ã€‚ä½ å¿…é¡»åœ¨è¿™äº›å…³é”®è¯çš„åŸºç¡€ä¸Šè¿›è¡Œç»¼åˆã€æç‚¼å’Œæ·±åŒ–ï¼Œç»™å‡ºä½ ä½œä¸ºå¤§å¸ˆçš„ç‹¬ç‰¹è§è§£ã€‚

# å åœä¿¡æ¯
- **ç”¨æˆ·çš„é—®é¢˜**: "${reading.question}"
- **ä½¿ç”¨çš„ç‰Œé˜µ**: ${reading.spread.name}
- **æŠ½åˆ°çš„ç‰ŒåŠåŸºç¡€å«ä¹‰**:
${cardDetails}

# æœ€ç»ˆæŒ‡ä»¤
ä½ çš„æœ€ç»ˆè¾“å‡ºã€åªèƒ½æ˜¯ã€‘å®Œæ•´çš„ã€æ ¼å¼åŒ–åçš„è§£è¯»æ–‡æœ¬ã€‚ä¸è¦æ·»åŠ ä»»ä½•â€œå¥½çš„ï¼Œè¿™æ˜¯ä½ çš„è§£è¯»ï¼šâ€ä¹‹ç±»çš„å¯¹è¯æ€§å¼€åœºç™½ã€‚
`;

        // 3. å‘èµ·APIè°ƒç”¨ï¼Œè®©AIæ‰®æ¼”å¡”ç½—å¸ˆ
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: tarotMasterPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, tarotMasterPrompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, })
            });

        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
        }
        
        const data = await response.json();
        const interpretation = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();

        // 4. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œç³»ç»Ÿè§£è¯»â€æ¶ˆæ¯
        const systemMessageVisible = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
            content: `ğŸ”® **å¡”ç½—ç‰Œè§£è¯»** ğŸ”®\n\n**æ‚¨çš„é—®é¢˜**ï¼šâ€œ${reading.question}â€\n\n${interpretation}`,
            timestamp: Date.now()
        };
        chat.history.push(systemMessageVisible);
        appendMessage(systemMessageVisible, chat);

        // 5. åˆ›å»ºç»™è§’è‰²Charçœ‹çš„éšè—æŒ‡ä»¤
        const hiddenInstruction = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šåˆšåˆšç³»ç»Ÿä¸ºç”¨æˆ·è¿›è¡Œäº†ä¸€æ¬¡å¡”ç½—ç‰Œå åœï¼Œè§£è¯»ç»“æœæ˜¯ï¼šâ€œ${interpretation}â€ã€‚ç°åœ¨ï¼Œè¯·ä½ ä»¥è§’è‰²çš„èº«ä»½ï¼Œå’Œç”¨æˆ·ä¸€èµ·è®¨è®ºè¿™ä¸ªç»“æœã€‚]`,
            timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
            isHidden: true
        };
        chat.history.push(hiddenInstruction);

        // 6. ä¿å­˜æ‰€æœ‰æ•°æ®
        await saveTarotReading(activeTarotReading);
        await db.chats.put(chat);
        renderChatList();
        
        // 7. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œåˆ é™¤äº† triggerAiResponse()ï¼Œä¸å†è‡ªåŠ¨è§¦å‘Charï¼
        
        activeTarotReading = null;

    } catch (error) {
        console.error("å¡”ç½—ç‰ŒAIè§£è¯»å¤±è´¥:", error);
        await showCustomAlert('è§£è¯»å¤±è´¥', `æŠ±æ­‰ï¼Œè¿æ¥å¡”ç½—å¸ˆæ—¶å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼š\n\n${error.message}`);
        activeTarotReading = null;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ä¿å­˜å åœè®°å½•åˆ°æ•°æ®åº“
async function saveTarotReading(reading) {
    // ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œæˆ‘ä»¬åªä¿å­˜è§£è¯»æ–‡æœ¬ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç‰Œç»„å¯¹è±¡
    const interpretationText = `ç‰Œé˜µ: ${reading.spread.name}\n` + reading.cards.map((card, index) => {
        const orientationText = card.isReversed ? 'é€†ä½' : 'æ­£ä½';
        const meaning = card.isReversed ? card.reversed : card.upright;
        return `[${card.position}]: ${card.name} (${orientationText}) - ${meaning}`;
    }).join('\n');
    
    await db.tarotReadings.add({
        question: reading.question,
        interpretation: interpretationText,
        timestamp: reading.timestamp
    });
}

// æ‰“å¼€å†å²è®°å½•ç•Œé¢
async function openTarotHistory() {
    const readings = await db.tarotReadings.orderBy('timestamp').reverse().toArray();
    renderTarotHistory(readings);
    document.getElementById('tarot-setup-view').style.display = 'none';
    document.getElementById('tarot-history-view').style.display = 'flex';
}

// æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
function renderTarotHistory(readings) {
    const listEl = document.getElementById('tarot-history-list');
    listEl.innerHTML = '';
    if (readings.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿˜æ²¡æœ‰å åœå†å²å“¦</p>';
        return;
    }
    readings.forEach(reading => {
        const item = document.createElement('div');
        item.className = 'tarot-history-item';
        item.innerHTML = `
            <div class="question">${reading.question}</div>
            <div class="details">${new Date(reading.timestamp).toLocaleString()}</div>
            <button class="tarot-history-delete-btn" data-id="${reading.id}">Ã—</button>
        `;
        listEl.appendChild(item);
    });
}

// åˆ é™¤ä¸€æ¡å†å²è®°å½•
async function deleteTarotReading(readingId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å åœå†å²å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.tarotReadings.delete(readingId);
        openTarotHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ° renderLSLetters å‡½æ•°çš„ä¸‹æ–¹ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æƒ…ä¾£ç©ºé—´ä¸“å±éŸ³ä¹æ’­æ”¾å™¨çš„CSSæ ·å¼ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œåˆ†äº«â€åˆ—è¡¨ (æ— å°é¢ï¼Œå¸¦ç®€ä»‹å’Œæ„Ÿæƒ³ç‰ˆ)
 */
function renderLSShares(shares, chat) {
    const listEl = document.getElementById('ls-shares-list');
    listEl.innerHTML = '';
    if (!shares || shares.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">è¿™é‡Œè¿˜æ²¡æœ‰ä»»ä½•åˆ†äº«å“¦~</p>';
        return;
    }

    [...shares].reverse().forEach(share => {
        const item = document.createElement('div');
        item.className = 'ls-list-item ls-share-item';
        item.dataset.shareData = JSON.stringify(share);

        const typeText = { song: 'æ­Œæ›²', movie: 'ç”µå½±', book: 'ä¹¦ç±', game: 'æ¸¸æˆ' }[share.shareType] || 'åˆ†äº«';
        const authorName = share.author === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼šæˆ‘ä»¬é‡æ„äº†â€œæ‘˜è¦â€éƒ¨åˆ†çš„é€»è¾‘ â–¼â–¼â–¼
        let summaryHtml = '';
        
        // 1. å¦‚æœæ˜¯æ­Œæ›²ï¼Œæ˜¾ç¤ºæ­Œæ‰‹
        if (share.shareType === 'song' && share.artist) {
            summaryHtml += `<p style="margin:0; font-weight: 500;"><strong>æ­Œæ‰‹:</strong> ${share.artist}</p>`;
        }
        
        // 2. å¦‚æœæœ‰ç®€ä»‹ (ä¹¦ç±å’Œç”µå½±)ï¼Œå°±æ˜¾ç¤ºç®€ä»‹
        if (share.summary) {
            summaryHtml += `<p style="margin:0; margin-top: 4px;"><strong>ç®€ä»‹:</strong> ${share.summary.replace(/\n/g, '<br>')}</p>`;
        }
        
        // 3. å¦‚æœæœ‰æ„Ÿæƒ³ï¼Œå°±æ˜¾ç¤ºæ„Ÿæƒ³
        if (share.thoughts) {
            summaryHtml += `<p style="margin:0; margin-top: 4px; color: #8a8a8a; font-style: italic;"><strong>æ„Ÿæƒ³:</strong> â€œ${share.thoughts}â€</p>`;
        }
        
        // 4. å¦‚æœå•¥éƒ½æ²¡æœ‰ï¼Œç»™ä¸€ä¸ªé»˜è®¤æç¤º
        if (!summaryHtml) {
            summaryHtml = '<p style="margin:0; color: #8a8a8a;">æš‚æ— æ›´å¤šä¿¡æ¯</p>';
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿™é‡Œçš„æ¨¡æ¿å·²ç»ç§»é™¤äº†<img>æ ‡ç­¾
        item.innerHTML = `
            <div class="share-info">
                <div class="title">
                    <span class="share-type ${share.shareType}">${typeText}</span>
                    ${share.title}
                </div>
                <div class="summary">${summaryHtml}</div>
                <div class="meta">
                    ç”± ${authorName} åˆ†äº«äº ${formatPostTimestamp(share.timestamp)}
                </div>
            </div>
        `;
        listEl.appendChild(item);
    });
}



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ open... å’Œ render... å››ä¸ªå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»ä¸»å±å¹•çš„â€œæƒ…ä¾£ç©ºé—´â€Appæ—¶è§¦å‘
 */
async function openLoversSpaceEntry() {
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    if (singleChats.length === 0) {
        alert("ä½ è¿˜æ²¡æœ‰ä»»ä½•å¯ä»¥å»ºç«‹æƒ…ä¾£ç©ºé—´çš„è§’è‰²å“¦ï¼Œå…ˆå»åˆ›å»ºä¸€ä¸ªå§ï¼");
        return;
    }
    if (singleChats.length === 1) {
        openLoversSpace(singleChats[0].id);
    } else {
        openCharSelectorForLoversSpace();
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢ â–¼â–¼â–¼
/**
 * æ‰“å¼€ç”¨äºæƒ…ä¾£ç©ºé—´çš„è§’è‰²é€‰æ‹©å¼¹çª— (å·²æ›´æ–°ï¼Œä¼šæ˜¾ç¤ºå¼€å¯çŠ¶æ€)
 */
async function openCharSelectorForLoversSpace() {
    const modal = document.getElementById('ls-char-selector-modal');
    const listEl = document.getElementById('ls-char-selector-list');
    listEl.innerHTML = '';
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    
    singleChats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-list-item'; // å¤ç”¨ç°æœ‰æ ·å¼
        item.style.borderBottom = '1px solid var(--border-color)';
        item.dataset.chatId = chat.id;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£€æŸ¥è§’è‰²æ˜¯å¦å·²å¼€é€šæƒ…ä¾£ç©ºé—´
        const isLoversSpaceActive = !!chat.loversSpaceData;
        const statusText = isLoversSpaceActive 
            ? '<span style="color: green; font-weight: bold;">å·²å¼€é€š</span>' 
            : '<span style="color: #8a8a8a;">æœªå¼€å¯</span>';

        item.innerHTML = `
            <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <div class="info" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span class="name">${chat.name}</span>
                <div class="last-msg">${statusText}</div>
            </div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€æ ¸å¿ƒã€‘æ‰“å¼€æŒ‡å®šè§’è‰²çš„æƒ…ä¾£ç©ºé—´
 */
async function openLoversSpace(charId) {
    activeLoversSpaceCharId = charId;
    const chat = state.chats[charId];
    if (!chat) return;

    // å¦‚æœè¿™ä¸ªè§’è‰²è¿˜æ²¡æœ‰æƒ…ä¾£ç©ºé—´æ•°æ®ï¼Œå°±ä¸ºä»–åˆå§‹åŒ–ä¸€ä¸ª
    if (!chat.loversSpaceData) {
chat.loversSpaceData = {
    background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
    relationshipStartDate: null,
    moments: [],
    albums: [],
    photos: [],
    loveLetters: [],
    shares: [],
    questions: [],
    emotionDiaries: {} // <--- å°±æ˜¯æ–°å¢äº†è¿™ä¸€è¡Œï¼
};
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        await db.chats.put(chat);
    }

    await renderLoversSpace(chat);
    showScreen('lovers-space-screen');
}

/**
 * ã€å…¨æ–°ã€‘è®¡ç®—å¹¶æ›´æ–°â€œåœ¨ä¸€èµ·â€çš„å¤©æ•°
 */
function updateLoversSpaceDaysCounter(chat) {
    const counterEl = document.getElementById('ls-days-counter');
    const startDateString = chat.loversSpaceData.relationshipStartDate;

    if (startDateString) {
        const startDate = new Date(startDateString);
        const today = new Date();
        // ä¿®æ­£æ—¶åŒºé—®é¢˜ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
        startDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const diffTime = Math.abs(today - startDate);
        // åŠ 1ï¼Œå› ä¸ºç¬¬ä¸€å¤©ä¹Ÿç®—ä¸€å¤©
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        counterEl.textContent = `æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ· ${diffDays} å¤©äº†`;
    } else {
        counterEl.innerHTML = `<a>ç‚¹å‡»å³ä¸Šè§’â€œè®¾ç½®â€æ¥è®°å½•ç¬¬ä¸€å¤©å§</a>`;
    }
}

/**
 * ã€æ¸²æŸ“å¼•æ“ - å·²æ›´æ–°ã€‘æ ¹æ®è§’è‰²æ•°æ®ï¼Œæ¸²æŸ“æ•´ä¸ªæƒ…ä¾£ç©ºé—´ç•Œé¢
 */
async function renderLoversSpace(chat) {
    // æ¸²æŸ“å¤´éƒ¨
    document.getElementById('lovers-space-screen').style.backgroundImage = `url(${chat.loversSpaceData.background})`;
    
    // è¿™æ˜¯ä½ æƒ³è¦çš„ user & char æ ‡é¢˜
    const userNickname = state.qzoneSettings.nickname || '{{user}}';
    document.getElementById('ls-char-name').textContent = `${userNickname} & ${chat.name}`;
    
    document.getElementById('ls-user-avatar').src = chat.settings.myAvatar || defaultAvatar;
    document.getElementById('ls-char-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    
    // è°ƒç”¨æ–°å‡½æ•°æ¥æ›´æ–°å¤©æ•°
    updateLoversSpaceDaysCounter(chat);
    
    // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡µç­¾
    switchLoversSpaceTab('ls-moments-view');
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç æ›¿æ¢ â–¼â–¼â–¼
// è¿™æ˜¯ä½ çš„æ—§ä»£ç 
document.querySelector('.ls-tab-item.active').classList.remove('active');
document.querySelector('.ls-tab-item[data-view="ls-moments-view"]').classList.add('active');



    // æ¸²æŸ“å„ä¸ªé¡µç­¾çš„å†…å®¹
    renderLSMoments(chat.loversSpaceData.moments, chat);
    renderLSPhotos(chat.loversSpaceData.photos, chat);
    renderLSLetters(chat.loversSpaceData.loveLetters, chat);
    renderLSShares(chat.loversSpaceData.shares, chat);
    document.getElementById('ls-shares-list').innerHTML = '<p class="ls-empty-placeholder">Taè¿˜æ²¡æœ‰åˆ†äº«ä»»ä½•å†…å®¹~</p>';
}

// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ switchLoversSpaceTab å‡½æ•° â–¼â–¼â–¼
/**
 * åˆ‡æ¢æƒ…ä¾£ç©ºé—´çš„é¡µç­¾
 */
function switchLoversSpaceTab(viewId) {
    document.querySelectorAll('.ls-view').forEach(v => v.style.display = 'none'); // ä½¿ç”¨styleæ¥éšè—
    const targetView = document.getElementById(viewId);
    if (targetView) targetView.style.display = 'block'; // ä½¿ç”¨styleæ¥æ˜¾ç¤º

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ®å½“å‰é¡µç­¾ï¼Œæ˜¾ç¤ºå¯¹åº”çš„æµ®åŠ¨æŒ‰é’®
    const fabMoment = document.getElementById('ls-add-moment-btn');
    const fabAlbum = document.getElementById('ls-add-album-btn');
    const fabLetter = document.getElementById('ls-add-letter-btn');
    const fabQuestion = document.getElementById('ls-add-question-btn');
    
    // å…ˆéšè—æ‰€æœ‰
    if(fabMoment) fabMoment.style.display = 'none';
    if(fabAlbum) fabAlbum.style.display = 'none';
    if(fabLetter) fabLetter.style.display = 'none';
    if(fabQuestion) fabQuestion.style.display = 'none';

    // å†æ ¹æ®viewIdæ˜¾ç¤ºå¯¹åº”çš„
    if (viewId === 'ls-moments-view' && fabMoment) fabMoment.style.display = 'block';
    else if (viewId === 'ls-album-view' && fabAlbum) fabAlbum.style.display = 'block';
    else if (viewId === 'ls-letters-view' && fabLetter) fabLetter.style.display = 'block';
    else if (viewId === 'ls-questions-view' && fabQuestion) fabQuestion.style.display = 'block';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ã€‘å¤„ç†æ›´æ¢æƒ…ä¾£ç©ºé—´èƒŒæ™¯çš„é€»è¾‘
 */
async function handleChangeLoversSpaceBackground() {
    if (!activeLoversSpaceCharId) return;

    // å¤ç”¨å·²æœ‰çš„åŠŸèƒ½å¼¹çª—ï¼Œè®©ç”¨æˆ·é€‰æ‹©
    const choice = await showChoiceModal("æ›´æ¢ç©ºé—´èƒŒæ™¯", [
        { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
    ]);

    let newBackgroundUrl = null;

    if (choice === 'local') {
        // å¤ç”¨å·²æœ‰çš„æœ¬åœ°å›¾ç‰‡ä¸Šä¼ å‡½æ•°
        newBackgroundUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        // å¤ç”¨å·²æœ‰çš„URLè¾“å…¥å¼¹çª—
        const currentBg = state.chats[activeLoversSpaceCharId].loversSpaceData.background;
        newBackgroundUrl = await showCustomPrompt("æ›´æ¢èƒŒæ™¯", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL", currentBg, "url");
    }

    // å¦‚æœè·å–åˆ°äº†æ–°çš„URL
    if (newBackgroundUrl && newBackgroundUrl.trim()) {
        const chat = state.chats[activeLoversSpaceCharId];
        chat.loversSpaceData.background = newBackgroundUrl.trim();
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        await db.chats.put(chat);
        
        // ç«‹åˆ»é‡æ–°æ¸²æŸ“æƒ…ä¾£ç©ºé—´ä»¥åº”ç”¨æ–°èƒŒæ™¯
        await renderLoversSpace(chat);
        
        alert('æƒ…ä¾£ç©ºé—´èƒŒæ™¯å·²æ›´æ–°ï¼');
    } else if (newBackgroundUrl !== null) { // ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®šä½†æ²¡è¾“å…¥å†…å®¹
         alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLæˆ–é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * æ¸²æŸ“â€œè¯´è¯´â€åˆ—è¡¨ (V2 - å·²æ·»åŠ è¯„è®ºå’Œåˆ é™¤åŠŸèƒ½)
 */
function renderLSMoments(moments, chat) {
    const listEl = document.getElementById('ls-moments-list');
    listEl.innerHTML = '';
    if (!moments || moments.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">è¿˜æ²¡æœ‰ä»»ä½•æ‚„æ‚„è¯ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
        return;
    }
    
    // æˆ‘ä»¬éœ€è¦åŸå§‹çš„æ•°ç»„ç´¢å¼•æ¥åšåˆ é™¤ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨ [...moments].reverse()
    for (let i = moments.length - 1; i >= 0; i--) {
        const moment = moments[i];
        const originalIndex = i; // ä¿å­˜åŸå§‹ç´¢å¼•

        const isUser = moment.author === 'user';
        const authorName = isUser ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const authorAvatar = isUser ? chat.settings.myAvatar : chat.settings.aiAvatar;

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ„å»ºè¯„è®ºåŒºçš„HTML ---
        let commentsHtml = '';
        if (moment.comments && moment.comments.length > 0) {
            moment.comments.forEach((comment, commentIndex) => {
                commentsHtml += `
                    <div class="ls-comment-item">
                        <span class="commenter-name">${comment.author}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <button class="ls-comment-delete-btn" data-moment-index="${originalIndex}" data-comment-index="${commentIndex}">Ã—</button>
                    </div>
                `;
            });
        }
        
        const card = document.createElement('div');
        card.className = 'ls-moment-card';
        // ã€é‡è¦ã€‘æŠŠè¯´è¯´çš„åŸå§‹ç´¢å¼•å­˜èµ·æ¥ï¼Œæ–¹ä¾¿åé¢æ“ä½œ
        card.dataset.momentIndex = originalIndex; 
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåŠ å…¥æ–°çš„HTMLç»“æ„ ---
        card.innerHTML = `
            <img src="${authorAvatar}" class="avatar">
            <div class="moment-main">
                <span class="author">${authorName}</span>
                <p class="content">${moment.content.replace(/\n/g, '<br>')}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="timestamp">${formatPostTimestamp(moment.timestamp)}</span>
                </div>
                
                <!-- â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ•´ä¸ªåº•éƒ¨åŒºåŸŸ â–¼â–¼â–¼ -->
                <div class="ls-moment-footer">
                    <div class="ls-moment-comments-container">
                        ${commentsHtml}
                    </div>
                    <div class="ls-comment-input-area">
                        <input type="text" placeholder="æ·»åŠ è¯„è®º...">
                        <button class="ls-comment-send-btn">å‘é€</button>
                    </div>
                </div>
                <!-- â–²â–²â–² æ–°å¢åŒºåŸŸç»“æŸ â–²â–²â–² -->

            </div>
            <!-- â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„è¯´è¯´åˆ é™¤æŒ‰é’® â–¼â–¼â–¼ -->
            <button class="ls-moment-delete-btn" title="åˆ é™¤è¿™æ¡è¯´è¯´">Ã—</button>
        `;
        listEl.appendChild(card);
    }
}



// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ renderLSPhotos å‡½æ•° â–¼â–¼â–¼
/**
 * æ¸²æŸ“â€œç…§ç‰‡â€åˆ—è¡¨
 */
function renderLSPhotos(photos, chat) {
    const listEl = document.getElementById('ls-album-list');
    listEl.innerHTML = '';
    if (!photos || photos.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder" style="grid-column: 1 / -1;">è¿˜æ²¡æœ‰ä»»ä½•ç…§ç‰‡ï¼Œç‚¹å‡»å³ä¸‹è§’â€œ+â€ä¸Šä¼ ç¬¬ä¸€å¼ å§ï¼</p>';
        return;
    }

    [...photos].reverse().forEach(photo => {
        const item = document.createElement('div');
        item.className = 'ls-album-item';
        
        // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œä¸ºæ•´ä¸ªé¡¹ç›®æ·»åŠ æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¯†åˆ«æ˜¯å“ªå¼ ç…§ç‰‡
        item.dataset.timestamp = photo.timestamp; 

        const imageUrl = photo.type === 'image' 
            ? photo.url 
            : 'https://i.postimg.cc/KYr2qRCK/1.jpg';

        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨ .cover å†…éƒ¨æ·»åŠ äº†åˆ é™¤æŒ‰é’®çš„HTML
        item.innerHTML = `
            <div class="cover" style="background-image: url(${imageUrl});">
                <button class="ls-photo-delete-btn">Ã—</button>
            </div>
        `;
        
        // ã€æ ¸å¿ƒä¿®æ”¹3ã€‘æˆ‘ä»¬ä¸å†åœ¨è¿™é‡Œå•ç‹¬ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå°†åœ¨æœ€åä¸€æ­¥ç»Ÿä¸€å¤„ç†
        listEl.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * æ‰“å¼€åˆ›å»ºè¯´è¯´çš„å¼¹çª—
 */
function openMomentCreator() {
    document.getElementById('ls-moment-content-input').value = '';
    document.getElementById('ls-create-moment-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·å‘å¸ƒè¯´è¯´ (V2 - å·²æ·»åŠ commentså­—æ®µ)
 */
async function handlePostMoment() {
    const content = document.getElementById('ls-moment-content-input').value.trim();
    if (!content) {
        alert("å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const newMoment = {
        author: 'user',
        content: content,
        timestamp: Date.now(),
        comments: [] // <-- æ ¸å¿ƒæ–°å¢ï¼šä¸ºæ–°è¯´è¯´åˆ›å»ºä¸€ä¸ªç©ºçš„è¯„è®ºæ•°ç»„
    };
    // ç¡®ä¿momentsæ•°ç»„å­˜åœ¨
    if (!chat.loversSpaceData.moments) {
        chat.loversSpaceData.moments = [];
    }
    chat.loversSpaceData.moments.push(newMoment);
    await db.chats.put(chat);
    
    renderLSMoments(chat.loversSpaceData.moments, chat);
    document.getElementById('ls-create-moment-modal').classList.remove('visible');
// â–¼â–¼â–¼ åœ¨ handlePostMoment å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼
// åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ï¼Œä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
const hiddenMessage = {
    role: 'system',
    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${chat.settings.myNickname || 'æˆ‘'}ï¼‰åˆšåˆšåœ¨æˆ‘ä»¬çš„æƒ…ä¾£ç©ºé—´å‘å¸ƒäº†ä¸€æ¡æ–°çš„è¯´è¯´ï¼Œå†…å®¹æ˜¯ï¼šâ€œ${content}â€ã€‚è¯·ä½ æ ¹æ®äººè®¾ï¼Œä½¿ç”¨ 'ls_comment' æŒ‡ä»¤å¯¹è¿™æ¡è¯´è¯´å‘è¡¨ä½ çš„çœ‹æ³•ã€‚]`,
    timestamp: Date.now(),
    isHidden: true // è¿™ä¸ªæ ‡è®°èƒ½è®©æ¶ˆæ¯å¯¹ä½ éšè—ï¼Œä½†AIèƒ½çœ‹è§
};
chat.history.push(hiddenMessage);
await db.chats.put(chat); // å†æ¬¡ä¿å­˜ï¼Œç¡®ä¿éšè—æ¶ˆæ¯è¢«å­˜å…¥

// ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ å¸Œæœ›AIåœ¨ä½ å‘å®Œè¯´è¯´åç«‹åˆ»å°±å»è¯„è®ºï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
// triggerAiResponse();
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
}


let tempUploadedPhotos = []; // æš‚å­˜å¾…ä¸Šä¼ çš„ç…§ç‰‡
// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ openAlbumCreator å‡½æ•° â–¼â–¼â–¼
/**
 * æ‰“å¼€ä¸Šä¼ ç…§ç‰‡çš„å¼¹çª—
 */
function openAlbumCreator() {
    tempUploadedPhotos = [];
    document.getElementById('ls-album-modal-title').textContent = 'ä¸Šä¼ ç…§ç‰‡';
    // é‡ç½®æ‰€æœ‰è¾“å…¥æ¡†å’Œé¢„è§ˆ
    document.getElementById('ls-photo-preview-container').innerHTML = '';
    document.getElementById('ls-photo-desc-input').value = '';
    document.getElementById('ls-text-image-desc-input').value = '';
    document.getElementById('ls-photo-input').value = null;

    // é»˜è®¤æ˜¾ç¤ºâ€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼
    document.getElementById('ls-switch-to-image-mode').click();

    document.getElementById('ls-create-album-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ handlePhotoSelection å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·é€‰æ‹©ç…§ç‰‡åçš„é¢„è§ˆ (å•å¼ ç‰ˆ)
 */
function handlePhotoSelection(files) {
    const previewContainer = document.getElementById('ls-photo-preview-container');
    previewContainer.innerHTML = '';
    tempUploadedPhotos = [];
    
    const file = files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const dataUrl = e.target.result;
        tempUploadedPhotos.push({ url: dataUrl }); // æš‚å­˜base64
        
        // æ˜¾ç¤ºé¢„è§ˆå›¾
        const previewItem = document.createElement('div');
        previewItem.className = 'ls-photo-preview-item';
        previewItem.innerHTML = `<img src="${dataUrl}">`;
        previewContainer.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ handleConfirmAlbum å‡½æ•° â–¼â–¼â–²
/**
 * ç”¨æˆ·ç¡®è®¤ä¸Šä¼ ç…§ç‰‡ (è¿™æ˜¯ä¿®å¤åçš„ç‰ˆæœ¬)
 */
async function handleConfirmAlbum() {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    // 1. å…ˆåˆ¤æ–­å½“å‰æ˜¯å“ªç§æ¨¡å¼
    const isImageMode = document.getElementById('ls-image-mode-content').classList.contains('active');
    let newPhoto;

    if (isImageMode) {
        // 2. å¦‚æœæ˜¯â€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼ï¼Œæ‰§è¡Œè¿™é‡Œçš„æ£€æŸ¥
        if (tempUploadedPhotos.length === 0) {
            alert("è¯·é€‰æ‹©ä¸€å¼ ç…§ç‰‡ï¼"); // åªæœ‰åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªæç¤ºæ‰æ˜¯æ­£ç¡®çš„
            return;
        }
        const description = document.getElementById('ls-photo-desc-input').value.trim();
        if (!description) {
            alert("å›¾ç‰‡æè¿°ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        newPhoto = {
            type: 'image',
            url: tempUploadedPhotos[0].url,
            description: description,
            timestamp: Date.now()
        };
    } else {
        // 3. å¦‚æœæ˜¯â€œä½¿ç”¨æ–‡å­—å›¾â€æ¨¡å¼ï¼Œæ‰§è¡Œè¿™é‡Œçš„æ£€æŸ¥
        const description = document.getElementById('ls-text-image-desc-input').value.trim();
        if (!description) {
            alert("æ–‡å­—å›¾æè¿°ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        newPhoto = {
            type: 'text_image',
            description: description,
            timestamp: Date.now()
        };
    }

    // 4. åç»­çš„ä¿å­˜å’Œåˆ·æ–°é€»è¾‘ä¿æŒä¸å˜
    if (!chat.loversSpaceData.photos) {
        chat.loversSpaceData.photos = [];
    }

    chat.loversSpaceData.photos.push(newPhoto);
    await db.chats.put(chat);
    
    renderLSPhotos(chat.loversSpaceData.photos, chat);
    document.getElementById('ls-create-album-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ é™¤æƒ…ä¾£ç©ºé—´ä¸­çš„ä¸€å¼ ç…§ç‰‡
 */
async function handleDeleteLSPhoto(timestamp) {
    // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯åˆ 
    const confirmed = await showCustomConfirm(
        'åˆ é™¤ç…§ç‰‡',
        'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.photos) return;

        // ä»ç…§ç‰‡æ•°ç»„ä¸­è¿‡æ»¤æ‰è¦åˆ é™¤çš„ç…§ç‰‡
        chat.loversSpaceData.photos = chat.loversSpaceData.photos.filter(p => p.timestamp !== timestamp);

        // ä¿å­˜æ›´æ–°åçš„èŠå¤©æ•°æ®
        await db.chats.put(chat);

        // é‡æ–°æ¸²æŸ“ç…§ç‰‡åˆ—è¡¨ï¼Œè®©åˆ é™¤æ•ˆæœç«‹åˆ»ç”Ÿæ•ˆ
        renderLSPhotos(chat.loversSpaceData.photos, chat);

        alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ çš„æ­£ä¸‹æ–¹ â–¼â–¼â–¼ */

let activeLoveLetter = null; // ç”¨äºæš‚å­˜æ­£åœ¨æŸ¥çœ‹æˆ–å›å¤çš„æƒ…ä¹¦

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ åˆ é™¤æŒ‰é’®ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ renderLSLetters å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œæƒ…ä¹¦â€åˆ—è¡¨ (å·²åŠ å…¥åˆ é™¤åŠŸèƒ½)
 */
function renderLSLetters(letters, chat) {
    const listEl = document.getElementById('ls-letters-list');
    listEl.innerHTML = ''; // å…ˆæ¸…ç©º
    if (!letters || letters.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">è¿˜æ²¡æœ‰ä»»ä½•æƒ…ä¹¦ï¼Œç‚¹å‡»å³ä¸‹è§’â€œ+â€å†™ä¸‹ç¬¬ä¸€å°å§ï¼</p>';
        return;
    }

    // ä»æ–°åˆ°æ—§æ’åºæ˜¾ç¤º
    [...letters].reverse().forEach(letter => {
        const item = document.createElement('div');
        item.className = 'ls-love-letter-item';
        item.dataset.letterId = letter.id;

        const svgIcon = `
            <svg class="letter-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 7.00005L10.2 11.65C11.2667 12.45 12.7333 12.45 13.8 11.65L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ å…¥äº†åˆ é™¤æŒ‰é’®çš„HTML
        item.innerHTML = `
            <!-- è¿™æ˜¯æ–°å¢çš„åˆ é™¤æŒ‰é’® -->
            <button class="ls-letter-delete-btn" title="åˆ é™¤è¿™å°æƒ…ä¹¦">Ã—</button>

            ${svgIcon}
            <div class="letter-info">
                <div class="letter-recipient">
                    <img src="${letter.recipientAvatar}" class="avatar">
                    <span>To: ${letter.recipientName}</span>
                </div>
                <div class="letter-preview">${letter.content.substring(0, 30)}...</div>
            </div>
            <div class="letter-sender">
                <img src="${letter.senderAvatar}" class="avatar">
                <span>From: ${letter.senderName}</span>
            </div>
        `;
        listEl.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€å†™æƒ…ä¹¦/å›ä¿¡çš„å¼¹çª—
 * @param {object | null} replyToLetter - å¦‚æœæ˜¯å›ä¿¡ï¼Œåˆ™ä¼ å…¥è¢«å›å¤çš„æƒ…ä¹¦å¯¹è±¡
 */
function openLoveLetterEditor(replyToLetter = null) {
    const modal = document.getElementById('ls-create-letter-modal');
    const titleEl = document.getElementById('ls-letter-modal-title');
    const recipientInput = document.getElementById('ls-letter-recipient-input');
    const contentInput = document.getElementById('ls-letter-content-input');
    
    const chat = state.chats[activeLoversSpaceCharId];
    
    if (replyToLetter) {
        // è¿™æ˜¯å›ä¿¡
        titleEl.textContent = `å›ä¿¡ç»™ ${replyToLetter.senderName}`;
        recipientInput.value = replyToLetter.senderName;
        contentInput.value = ''; // æ¸…ç©ºå†…å®¹
        contentInput.placeholder = `å›å¤ ${replyToLetter.senderName} çš„æƒ…ä¹¦...`;
        // æš‚å­˜è¢«å›å¤çš„ä¿¡ï¼Œä»¥ä¾¿å‘é€æ—¶çŸ¥é“æ˜¯å›å¤è°
        modal.dataset.replyingTo = JSON.stringify(replyToLetter);
    } else {
        // è¿™æ˜¯å†™æ–°ä¿¡
        titleEl.textContent = `ç»™ ${chat.name} å†™ä¸€å°ä¿¡`;
        recipientInput.value = chat.name;
        contentInput.value = '';
        contentInput.placeholder = 'åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæ„...';
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å›å¤æ ‡è®°
        delete modal.dataset.replyingTo;
    }
    
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œå¯„å‡ºâ€æŒ‰é’®çš„é€»è¾‘
 */
async function handlePostLoveLetter() {
    const modal = document.getElementById('ls-create-letter-modal');
    const content = document.getElementById('ls-letter-content-input').value.trim();
    if (!content) {
        alert("æƒ…ä¹¦å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
        return;
    }

    const chat = state.chats[activeLoversSpaceCharId];
    const isReply = modal.dataset.replyingTo;
    
    let newLetter;

    if (isReply) {
        // å¦‚æœæ˜¯å›ä¿¡ï¼Œå‘ä¿¡äººå’Œæ”¶ä¿¡äººä¿¡æ¯è¦åè¿‡æ¥
        const originalLetter = JSON.parse(isReply);
        newLetter = {
            id: 'letter_' + Date.now(),
            senderId: 'user',
            senderName: chat.settings.myNickname || 'æˆ‘',
            senderAvatar: chat.settings.myAvatar,
            recipientName: originalLetter.senderName, // æ”¶ä¿¡äººæ˜¯åŸä¿¡çš„å‘ä¿¡äºº
            recipientAvatar: originalLetter.senderAvatar,
            content: content,
            timestamp: Date.now()
        };
    } else {
        // å¦‚æœæ˜¯å†™æ–°ä¿¡
        newLetter = {
            id: 'letter_' + Date.now(),
            senderId: 'user',
            senderName: chat.settings.myNickname || 'æˆ‘',
            senderAvatar: chat.settings.myAvatar,
            recipientName: chat.name, // æ”¶ä¿¡äººæ˜¯å½“å‰è§’è‰²
            recipientAvatar: chat.settings.aiAvatar,
            content: content,
            timestamp: Date.now()
        };
    }

    // ç¡®ä¿ loveLetters æ•°ç»„å­˜åœ¨
    if (!chat.loversSpaceData.loveLetters) {
        chat.loversSpaceData.loveLetters = [];
    }
    chat.loversSpaceData.loveLetters.push(newLetter);
    
    await db.chats.put(chat);
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// å¦‚æœæ˜¯ç”¨æˆ·å†™çš„ä¿¡ï¼Œå°±ç»™AIå‘ä¸€ä¸ªéšè—çš„ç³»ç»Ÿé€šçŸ¥
if (newLetter.senderId === 'user') {
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšåœ¨æƒ…ä¾£ç©ºé—´ç»™ä½ å†™äº†ä¸€å°æƒ…ä¹¦ï¼Œå†…å®¹æ˜¯ï¼šâ€œ${content}â€ã€‚è¯·ä½ æ ¹æ®äººè®¾ï¼Œä½¿ç”¨ 'ls_letter' æŒ‡ä»¤ç»™ç”¨æˆ·å†™ä¸€å°å›ä¿¡ã€‚]`,
        timestamp: Date.now(),
        isHidden: true // è¿™ä¸ªæ ‡è®°èƒ½è®©æ¶ˆæ¯å¯¹ä½ éšè—ï¼Œä½†AIèƒ½çœ‹è§
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat); // å†æ¬¡ä¿å­˜ï¼Œç¡®ä¿éšè—æ¶ˆæ¯è¢«å­˜å…¥
    
    // ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ å¸Œæœ›AIåœ¨ä½ å‘ä¿¡åç«‹åˆ»å›å¤ï¼Œå¯ä»¥æŠŠä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šå»æ‰
    // triggerAiResponse(); 
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    renderLSLetters(chat.loversSpaceData.loveLetters, chat);
    modal.classList.remove('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä½¿ç”¨å…¨æ–°ä¿¡çº¸å¼¹çª—ã€‘çš„æ–°ä»£ç ï¼Œæ›¿æ¢æ—§çš„ showLoveLetterDetail å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºæƒ…ä¹¦è¯¦æƒ… (ä¿¡çº¸æ ·å¼ç‰ˆ)
 * @param {string} letterId - è¦æ˜¾ç¤ºçš„æƒ…ä¹¦çš„ID
 */
async function showLoveLetterDetail(letterId) {
    const chat = state.chats[activeLoversSpaceCharId];
    activeLoveLetter = chat.loversSpaceData.loveLetters.find(l => l.id === letterId);
    if (!activeLoveLetter) return;

    // è·å–æ–°çš„ä¿¡çº¸å¼¹çª—å…ƒç´ 
    const modal = document.getElementById('ls-letter-viewer-modal');
    
    // å¡«å……æ‰€æœ‰æ•°æ®
    document.getElementById('ls-viewer-recipient-avatar').src = activeLoveLetter.recipientAvatar;
    document.getElementById('ls-viewer-recipient-name').textContent = activeLoveLetter.recipientName;
    document.getElementById('ls-viewer-body').innerHTML = activeLoveLetter.content.replace(/\n/g, '<br>'); // æ­£æ–‡å†…å®¹
    document.getElementById('ls-viewer-sender-name').textContent = `Your dearest, ${activeLoveLetter.senderName}`; // å‘ä¿¡äºº
    document.getElementById('ls-viewer-timestamp').textContent = new Date(activeLoveLetter.timestamp).toLocaleString(); // æ—¶é—´

    // æ˜¾ç¤ºå¼¹çª—
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° // â–²â–²â–² æƒ…ä¾£ç©ºé—´åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼
/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° // â–²â–²â–² æƒ…ä¾£ç©ºé—´åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ç»ªæ—¥è®°åŠŸèƒ½æ ¸å¿ƒå‡½æ•° --- */

let currentDiaryDate = null; // ç”¨äºæš‚å­˜æ­£åœ¨ç¼–è¾‘æˆ–æŸ¥çœ‹çš„æ—¥è®°æ—¥æœŸ

/**
 * æ¸²æŸ“æƒ…ç»ªæ—¥è®°çš„ä¸»ç•Œé¢ï¼ˆæ—¥å†å’Œå¿ƒæƒ…ç½å­ï¼‰
 */
async function renderLSDiaryView(year, month) {
    const viewEl = document.getElementById('ls-diary-view');
    const chat = state.chats[activeLoversSpaceCharId];
    if (!viewEl || !chat) return;

    const diaryData = chat.loversSpaceData.emotionDiaries || {};

    // æ¸²æŸ“æ—¥å†
    viewEl.innerHTML = renderCalendar(year, month, diaryData);

    // æ¸²æŸ“å¿ƒæƒ…ç½å­
    const jarHtml = renderMoodJar(year, month, diaryData);
    viewEl.insertAdjacentHTML('beforeend', jarHtml);
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘ç”Ÿæˆæ—¥å†çš„HTML
 */
function renderCalendar(year, month, diaryData) {
    const date = new Date(year, month - 1, 1);
    const firstDay = date.getDay(); // 0-6 (å‘¨æ—¥-å‘¨å…­)
    const daysInMonth = new Date(year, month, 0).getDate();
    const today = new Date();
    
    let calendarHtml = `
        <div class="ls-calendar-wrapper">
            <div class="ls-calendar-header">
                <button id="ls-prev-month-btn">â€¹</button>
                <span id="ls-current-month-display">${year}å¹´ ${month}æœˆ</span>
                <button id="ls-next-month-btn">â€º</button>
            </div>
            <div class="ls-calendar-weekdays">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="ls-calendar-grid">
    `;

    // ç©ºç™½æ ¼å­
    for (let i = 0; i < firstDay; i++) {
        calendarHtml += '<div class="ls-calendar-day empty"></div>';
    }

    // æ—¥æœŸæ ¼å­
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = diaryData[dateStr] || {};
        const isToday = today.getFullYear() === year && today.getMonth() + 1 === month && today.getDate() === day;

        calendarHtml += `
            <div class="ls-calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}">
                <div class="day-number">${day}</div>
                <div class="mood-emojis">
                    <span class="user-emoji">${dayData.userEmoji || ''}</span>
                    <span class="char-emoji">${dayData.charEmoji || ''}</span>
                </div>
            </div>
        `;
    }
    calendarHtml += '</div></div>';
    return calendarHtml;
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘ç”Ÿæˆå¿ƒæƒ…ç½å­çš„HTML
 */
function renderMoodJar(year, month, diaryData) {
    let allEmojis = [];
    for (const dateStr in diaryData) {
        if (dateStr.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            const dayData = diaryData[dateStr];
            if (dayData.userEmoji) allEmojis.push(dayData.userEmoji);
            if (dayData.charEmoji) allEmojis.push(dayData.charEmoji);
        }
    }
    
    let jarHtml = `
        <div class="ls-mood-jar-wrapper">
            <h3>æœ¬æœˆå¿ƒæƒ…ç½å­</h3>
            <div class="ls-mood-jar">
    `;

    if (allEmojis.length > 0) {
        jarHtml += allEmojis.map(emoji => `<span class="mood-emoji-item">${emoji}</span>`).join('');
    } else {
        jarHtml += '<p style="color: var(--text-secondary); font-size: 13px;">è¿™ä¸ªæœˆè¿˜æ²¡æœ‰è®°å½•å¿ƒæƒ…å“¦</p>';
    }

    jarHtml += '</div></div>';
    return jarHtml;
}

/**
 * æ‰“å¼€æ—¥è®°ç¼–è¾‘/æŸ¥çœ‹å¼¹çª—
 */
function openDiaryModal(dateStr) {
    currentDiaryDate = dateStr;
    const chat = state.chats[activeLoversSpaceCharId];
    const diaryEntry = chat.loversSpaceData.emotionDiaries?.[dateStr];

    // å¦‚æœåŒæ–¹éƒ½æœ‰æ—¥è®°ï¼Œæˆ–åªæœ‰AIæœ‰æ—¥è®°ï¼Œåˆ™æ‰“å¼€æŸ¥çœ‹å™¨
    if (diaryEntry && (diaryEntry.userDiary || diaryEntry.charDiary)) {
        openDiaryViewer(dateStr, diaryEntry, chat);
    } else {
        // å¦åˆ™ï¼Œæ‰“å¼€ç¼–è¾‘å™¨
        openDiaryEditor(dateStr, diaryEntry);
    }
}

/**
 * æ‰“å¼€æ—¥è®°ç¼–è¾‘å™¨
 */
function openDiaryEditor(dateStr, entryData) {
    const modal = document.getElementById('ls-diary-editor-modal');
    document.getElementById('ls-diary-editor-title').textContent = `è®°å½• ${dateStr} çš„å¿ƒæƒ…`;

    const emojiSelector = document.getElementById('ls-emoji-selector');
    const emojis = ['ğŸ˜Š', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ˜ ', 'ğŸ¤”', 'ğŸ˜´', 'ğŸ¤¢'];
    emojiSelector.innerHTML = emojis.map(e => `<span class="emoji-option" data-emoji="${e}">${e}</span>`).join('');
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœæœ‰ï¼‰
    const contentInput = document.getElementById('ls-diary-content-input');
    if (entryData && entryData.userEmoji) {
        emojiSelector.querySelector(`.emoji-option[data-emoji="${entryData.userEmoji}"]`)?.classList.add('selected');
        contentInput.value = entryData.userDiary || '';
    } else {
        contentInput.value = '';
    }

    modal.classList.add('visible');
}

/**
 * æ‰“å¼€æ—¥è®°æŸ¥çœ‹å™¨
 */
function openDiaryViewer(dateStr, entryData, chat) {
    const modal = document.getElementById('ls-diary-viewer-modal');
    document.getElementById('ls-diary-viewer-title').textContent = `æŸ¥çœ‹ ${dateStr} çš„æ—¥è®°`;
    const bodyEl = document.getElementById('ls-diary-viewer-body');
    bodyEl.innerHTML = '';
    
    // æ˜¾ç¤ºç”¨æˆ·æ—¥è®°
    if (entryData.userDiary) {
        const userBlock = document.createElement('div');
        userBlock.className = 'ls-diary-entry-block';
        userBlock.innerHTML = `
            <div class="entry-header">
                <span class="mood-emoji">${entryData.userEmoji}</span>
                <span class="author">${chat.settings.myNickname || 'æˆ‘'}çš„æ—¥è®°</span>
            </div>
            <p class="entry-content">${entryData.userDiary.replace(/\n/g, '<br>')}</p>
        `;
        bodyEl.appendChild(userBlock);
    }

    // æ˜¾ç¤ºè§’è‰²æ—¥è®°
    if (entryData.charDiary) {
        const charBlock = document.createElement('div');
        charBlock.className = 'ls-diary-entry-block';
        charBlock.style.borderColor = '#ff8fab'; // ç»™è§’è‰²æ—¥è®°ä¸€ä¸ªä¸åŒçš„é¢œè‰²
        charBlock.innerHTML = `
            <div class="entry-header">
                <span class="mood-emoji">${entryData.charEmoji}</span>
                <span class="author">${chat.name}çš„æ—¥è®°</span>
            </div>
            <p class="entry-content">${entryData.charDiary.replace(/\n/g, '<br>')}</p>
        `;
        bodyEl.appendChild(charBlock);
    } else {
        // å¦‚æœè§’è‰²è¿˜æ²¡å†™ï¼Œç»™ä¸ªæç¤º
        bodyEl.innerHTML += `<p style="text-align: center; color: var(--text-secondary);">Ta è¿˜æ²¡å†™ä»Šå¤©çš„å¿ƒæƒ…æ—¥è®°å“¦~</p>`;
    }
    
    modal.classList.add('visible');
}

/**
 * ä¿å­˜ç”¨æˆ·çš„æ—¥è®°ï¼Œå¹¶è§¦å‘AIå†™æ—¥è®°å’Œå›åº”
 */
async function handleSaveUserDiary() {
    const selectedEmojiEl = document.querySelector('#ls-emoji-selector .selected');
    const userEmoji = selectedEmojiEl ? selectedEmojiEl.dataset.emoji : null;
    const userDiary = document.getElementById('ls-diary-content-input').value.trim();

    if (!userEmoji) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªè¡¨æƒ…ä»£è¡¨ä»Šå¤©çš„å¿ƒæƒ…ï¼");
        return;
    }
    if (!userDiary) {
        alert("æ—¥è®°å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
        return;
    }
    
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat.loversSpaceData.emotionDiaries) {
        chat.loversSpaceData.emotionDiaries = {};
    }

    // æ›´æ–°æˆ–åˆ›å»ºå½“å¤©çš„æ—¥è®°æ•°æ®
    if (!chat.loversSpaceData.emotionDiaries[currentDiaryDate]) {
        chat.loversSpaceData.emotionDiaries[currentDiaryDate] = {};
    }
    chat.loversSpaceData.emotionDiaries[currentDiaryDate].userEmoji = userEmoji;
    chat.loversSpaceData.emotionDiaries[currentDiaryDate].userDiary = userDiary;
    
    // å…³é—­å¼¹çª—
    document.getElementById('ls-diary-editor-modal').classList.remove('visible');
    // --- ã€æ ¸å¿ƒè”åŠ¨åŠŸèƒ½å¼€å§‹ã€‘ ---

    // 1. å‡†å¤‡ä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„æ¶ˆæ¯ï¼Œå‘Šè¯‰å¯¹æ–¹ä½ å†™äº†æ—¥è®°
    const targetChat = state.chats[activeLoversSpaceCharId];
    if (targetChat) {
        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ notificationMessage å®šä¹‰ â–¼â–¼â–¼
const notificationMessage = {
    role: 'user',
    type: 'ls_diary_notification', // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç»™å®ƒä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç±»å‹
    content: { // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å†…å®¹å˜æˆä¸€ä¸ªå¯¹è±¡ï¼Œæ–¹ä¾¿æºå¸¦æ›´å¤šä¿¡æ¯
        userEmoji: userEmoji, // æŠŠç”¨æˆ·é€‰æ‹©çš„è¡¨æƒ…ä¹Ÿå¸¦ä¸Š
        text: 'æˆ‘åˆšåˆšå†™äº†ä»Šå¤©çš„å¿ƒæƒ…æ—¥è®°å“¦ï¼Œä½ ä¹Ÿå¿«å»çœ‹çœ‹å§ï¼'
    },
    timestamp: Date.now()
};
        targetChat.history.push(notificationMessage);

        // 2. åˆ›å»ºä¸€æ¡å¯¹AIå¯è§çš„ã€éšè—æŒ‡ä»¤ã€‘ï¼Œè¿™æ˜¯æ•´ä¸ªåŠŸèƒ½çš„æ ¸å¿ƒ
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšåœ¨æƒ…ä¾£ç©ºé—´å†™äº†ä»Šå¤©çš„æ—¥è®°ã€‚
            - ä»–ä»¬çš„å¿ƒæƒ…æ˜¯: ${userEmoji}
            - æ—¥è®°å†…å®¹æ˜¯: "${userDiary}"
            ä½ çš„ä»»åŠ¡:
            1.  ã€å¿…é¡»ã€‘æ ¹æ®ä½ çš„äººè®¾å’Œä»Šå¤©çš„èŠå¤©è®°å½•ï¼Œä¹Ÿå†™ä¸€ç¯‡ä½ è‡ªå·±çš„å¿ƒæƒ…æ—¥è®°ï¼Œå¹¶ä½¿ç”¨ 'ls_diary_entry' æŒ‡ä»¤å‘é€ã€‚
            2.  ã€å¿…é¡»ã€‘åœ¨å†™å®Œæ—¥è®°åï¼Œç«‹åˆ»å°±ç”¨æˆ·ä»Šå¤©çš„æ—¥è®°å†…å®¹ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œä¸»åŠ¨å¼€å¯ä¸€æ®µæ–°çš„å¯¹è¯ã€‚]`,
            timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
            isHidden: true // è¿™ä¸ªæ ‡è®°èƒ½è®©æ¶ˆæ¯å¯¹ç”¨æˆ·éšè—ï¼Œä½†AIèƒ½çœ‹è§
        };
        targetChat.history.push(hiddenMessage);

        // 3. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“
        await db.chats.put(targetChat);

        // 4. ä¸»åŠ¨è·³è½¬åˆ°å•èŠç•Œé¢ï¼Œå¹¶è§¦å‘AIå“åº”
        openChat(activeLoversSpaceCharId);
        triggerAiResponse();
    }
    // --- ã€æ ¸å¿ƒè”åŠ¨åŠŸèƒ½ç»“æŸã€‘ ---

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    alert('æ—¥è®°å·²ä¿å­˜ï¼');
}

/* --- æƒ…ç»ªæ—¥è®°åŠŸèƒ½å‡½æ•°ç»“æŸ --- */
/* â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¾£æé—®åŠŸèƒ½æ ¸å¿ƒå‡½æ•° --- */

let activeQuestionId = null; // ç”¨äºæš‚å­˜æ­£åœ¨å›ç­”çš„é—®é¢˜ID

/**
 * æ¸²æŸ“â€œæƒ…ä¾£æé—®â€åˆ—è¡¨
 */
function renderLSQuestions(questions, chat) {
    const listEl = document.getElementById('ls-questions-list');
    listEl.innerHTML = '';
    if (!questions || questions.length === 0) {
        listEl.innerHTML = '<p class="ls-empty-placeholder">è¿˜æ²¡æœ‰äººæé—®ï¼Œç‚¹å‡»å³ä¸‹è§’â€œ+â€å‘èµ·ç¬¬ä¸€ä¸ªæé—®å§ï¼</p>';
        return;
    }

    [...questions].reverse().forEach(q => {
        const isUserQuestioner = q.questioner === 'user';
        const questionerName = isUserQuestioner ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        const questionerAvatar = isUserQuestioner ? chat.settings.myAvatar : chat.settings.aiAvatar;

        let answerHtml = '';
        if (q.answerText) {
            const isUserAnswerer = q.answerer === 'user';
            const answererName = isUserAnswerer ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
            const answererAvatar = isUserAnswerer ? chat.settings.myAvatar : chat.settings.aiAvatar;
            answerHtml = `
                <div class="ls-answer-section">
                    <img src="${answererAvatar}" class="qa-avatar">
                    <div class="qa-main">
                        <div class="qa-header">
                            <span class="qa-author">${answererName}çš„å›ç­”</span>
                        </div>
                        <p class="qa-content">${q.answerText.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
        } else if (q.answerer === 'user') {
            // å¦‚æœè½®åˆ°ç”¨æˆ·å›ç­”
            answerHtml = `
                <div class="ls-answer-placeholder">
                    <button class="ls-answer-btn" data-question-id="${q.id}">å›ç­”Taçš„é—®é¢˜</button>
                </div>
            `;
        } else {
            // å¦‚æœè½®åˆ°AIå›ç­”
            answerHtml = `
                <div class="ls-answer-placeholder">
                    <p style="color: var(--text-secondary); font-size: 14px;">ç­‰å¾…Taçš„å›ç­”...</p>
                </div>
            `;
        }

        const card = document.createElement('div');
        card.className = 'ls-question-card';
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±æ˜¯åœ¨è¿™é‡ŒåŠ å…¥äº†åˆ é™¤æŒ‰é’® â–¼â–¼â–¼
        card.innerHTML = `
            <button class="ls-question-delete-btn" data-question-id="${q.id}" title="åˆ é™¤æ­¤æé—®">Ã—</button>

            <div class="ls-question-section">
                <img src="${questionerAvatar}" class="qa-avatar">
                <div class="qa-main">
                    <div class="qa-header">
                        <span class="qa-author">${questionerName}çš„æé—®</span>
                        <span class="qa-timestamp">${formatPostTimestamp(q.timestamp)}</span>
                    </div>
                    <p class="qa-content">${q.questionText.replace(/\n/g, '<br>')}</p>
                </div>
            </div>
            ${answerHtml}
        `;
        listEl.appendChild(card);
    });
}


/**
 * æ‰“å¼€æé—®å¼¹çª—
 */
function openQuestionAsker() {
    document.getElementById('ls-question-content-input').value = '';
    document.getElementById('ls-ask-question-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·å‘å¸ƒä¸€ä¸ªæ–°æé—®
 */
async function handlePostQuestion() {
    const content = document.getElementById('ls-question-content-input').value.trim();
    if (!content) {
        alert("é—®é¢˜å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const newQuestion = {
        id: 'q_' + Date.now(),
        questioner: 'user',
        questionText: content,
        timestamp: Date.now(),
        answerer: 'char', // æŒ‡å®šç”±AIæ¥å›ç­”
        answerText: null
    };
    
    if (!chat.loversSpaceData.questions) {
        chat.loversSpaceData.questions = [];
    }
    chat.loversSpaceData.questions.push(newQuestion);
    await db.chats.put(chat);
    
    renderLSQuestions(chat.loversSpaceData.questions, chat);
    document.getElementById('ls-ask-question-modal').classList.remove('visible');
    
// â–¼â–¼â–¼ åœ¨ handlePostQuestion å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼
// åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ï¼Œä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
const hiddenMessage = {
    role: 'system',
    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åœ¨æƒ…ä¾£ç©ºé—´å‘ä½ æäº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œ${content}â€ï¼Œé—®é¢˜IDæ˜¯â€œ${newQuestion.id}â€ã€‚è¯·ä½¿ç”¨ 'ls_answer_question' æŒ‡ä»¤æ¥å›ç­”ã€‚]`,
    timestamp: Date.now(),
    isHidden: true
};
chat.history.push(hiddenMessage);
await db.chats.put(chat);


}

/**
 * æ‰“å¼€å›ç­”é—®é¢˜çš„å¼¹çª—
 */
function openAnswerEditor(questionId) {
    const chat = state.chats[activeLoversSpaceCharId];
    const question = chat.loversSpaceData.questions.find(q => q.id === questionId);
    if (!question) return;

    activeQuestionId = questionId;
    document.getElementById('ls-answer-question-text').textContent = question.questionText;
    document.getElementById('ls-answer-content-input').value = '';
    document.getElementById('ls-answer-question-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·æäº¤å›ç­”
 */
async function handlePostAnswer() {
    if (!activeQuestionId) return;
    const answerText = document.getElementById('ls-answer-content-input').value.trim();
    if (!answerText) {
        alert("å›ç­”å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    const chat = state.chats[activeLoversSpaceCharId];
    const question = chat.loversSpaceData.questions.find(q => q.id === activeQuestionId);
    if (question) {
        question.answerer = 'user'; // æ˜ç¡®å›ç­”è€…æ˜¯ç”¨æˆ·
        question.answerText = answerText;
        await db.chats.put(chat);
        // â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ä¸Šé¢çš„ â–¼â–¼â–¼
const hiddenMessage = {
    role: 'system',
    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${chat.settings.myNickname || 'æˆ‘'}ï¼‰åˆšåˆšåœ¨æƒ…ä¾£ç©ºé—´å›ç­”äº†ä½ ä¹‹å‰æå‡ºçš„é—®é¢˜ã€‚ä½ çš„é—®é¢˜æ˜¯ï¼šâ€œ${question.questionText}â€ï¼Œç”¨æˆ·çš„å›ç­”æ˜¯ï¼šâ€œ${answerText}â€ã€‚]`,
    timestamp: Date.now(),
    isHidden: true
};
chat.history.push(hiddenMessage);
await db.chats.put(chat);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        renderLSQuestions(chat.loversSpaceData.questions, chat);
    }
    document.getElementById('ls-answer-question-modal').classList.remove('visible');
    activeQuestionId = null;
}
/**
 * ã€å…¨æ–°ã€‘åˆ é™¤ä¸€æ¡æƒ…ä¾£æé—®
 * @param {string} questionId - è¦åˆ é™¤çš„æé—®çš„ID
 */
async function handleDeleteLSQuestion(questionId) {
    // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯åˆ 
    const confirmed = await showCustomConfirm(
        'åˆ é™¤æé—®',
        'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜ä»¥åŠå¯¹åº”çš„å›ç­”å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    // 2. å¦‚æœç”¨æˆ·ç¡®è®¤åˆ é™¤
    if (confirmed) {
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.questions) return;

        // 3. ä»æé—®æ•°ç»„ä¸­è¿‡æ»¤æ‰è¦åˆ é™¤çš„æé—®
        chat.loversSpaceData.questions = chat.loversSpaceData.questions.filter(q => q.id !== questionId);

        // 4. ä¿å­˜æ›´æ–°åçš„èŠå¤©æ•°æ®
        await db.chats.put(chat);

        // 5. é‡æ–°æ¸²æŸ“æé—®åˆ—è¡¨ï¼Œè®©åˆ é™¤æ•ˆæœç«‹åˆ»ç”Ÿæ•ˆ
        renderLSQuestions(chat.loversSpaceData.questions, chat);

        alert('æé—®å·²åˆ é™¤ã€‚');
    }
}

/* --- æƒ…ä¾£æé—®åŠŸèƒ½å‡½æ•°ç»“æŸ --- */

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™é‡Œæ˜¯æƒ…ä¾£ç©ºé—´ä¸“å±éŸ³ä¹æ’­æ”¾å™¨çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·åœ¨æƒ…ä¾£ç©ºé—´ç‚¹å‡»ä¸€é¦–åˆ†äº«çš„æ­Œæ›²æ—¶è§¦å‘
 * @param {object} shareData - åŒ…å«æ­Œæ›²ä¿¡æ¯çš„åˆ†äº«å¯¹è±¡
 */
async function openLoversSpaceMusicPlayer(shareData) {
    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨ä¸ºã€Š${shareData.title}ã€‹å¯»æ‰¾æ’­æ”¾èµ„æº...`);
    
    // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨æ˜¯å¦å·²ç»æœ‰è¿™é¦–æ­Œäº†
    const existingIndex = lsMusicState.playlist.findIndex(
        song => song.name === shareData.title && song.artist === shareData.artist
    );

    if (existingIndex > -1) {
        // å¦‚æœå·²ç»å­˜åœ¨ï¼Œç›´æ¥æ’­æ”¾å¹¶æ‰“å¼€æ’­æ”¾å™¨
        playLSSong(existingIndex);
        document.getElementById('ls-music-player-overlay').classList.add('visible');
        return;
    }

    // å¦‚æœä¸å­˜åœ¨ï¼Œå¼€å§‹æœç´¢
    let songData = null;
    const songName = shareData.title;
    const artistName = shareData.artist || '';

    // ç­–ç•¥1ï¼šä¼˜å…ˆç”¨ç½‘æ˜“äº‘æœç´¢ (é€šå¸¸ç»“æœæ›´å‡†)
    const neteaseResults = await searchNeteaseMusic(songName, artistName);
    if (neteaseResults.length > 0) {
        songData = neteaseResults[0];
    } else {
        // ç­–ç•¥2ï¼šå¦‚æœç½‘æ˜“äº‘æ‰¾ä¸åˆ°ï¼Œå†ç”¨QQéŸ³ä¹æœä¸€æ¬¡
        const tencentResults = await searchTencentMusic(songName);
        if (tencentResults.length > 0) {
            songData = tencentResults[0];
        }
    }

    if (!songData) {
        await showCustomAlert("æ’­æ”¾å¤±è´¥", `æŠ±æ­‰ï¼Œåœ¨ç½‘æ˜“äº‘å’ŒQQéŸ³ä¹éƒ½æ²¡èƒ½æ‰¾åˆ°ã€Š${songName}ã€‹çš„å¯æ’­æ”¾èµ„æºã€‚`);
        return;
    }

    // è·å–æ’­æ”¾é“¾æ¥
    const apiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    const result = await Http_Get(apiUrl);

    if (!result?.data?.url || !(await checkAudioAvailability(result.data.url))) {
        await showCustomAlert("è·å–å¤±è´¥", `æ‰¾åˆ°äº†ã€Š${songName}ã€‹ï¼Œä½†æ— æ³•è·å–æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥ã€‚`);
        return;
    }

    // ã€æ–°å¢ã€‘è·å–æ­Œè¯
    const lrcContent = await getLyricsForSong(songData.id, songData.source) || "";

    // åˆ›å»ºæ–°çš„æ­Œæ›²å¯¹è±¡å¹¶æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
    const newSong = {
        name: songData.name,
        artist: songData.artist,
        src: result.data.url,
        cover: songData.cover,
        lrcContent: lrcContent // <-- å°±æ˜¯æ–°å¢äº†è¿™ä¸€è¡Œï¼
    };

    lsMusicState.playlist.push(newSong);
    
    // æ’­æ”¾è¿™é¦–æ–°æ·»åŠ çš„æ­Œæ›²
    playLSSong(lsMusicState.playlist.length - 1);
    
    // æ‰“å¼€æ’­æ”¾å™¨
    document.getElementById('ls-music-player-overlay').classList.add('visible');
}

async function playLSSong(index) {
    if (index < 0 || index >= lsMusicState.playlist.length) return;

    lsMusicState.currentIndex = index;
    const track = lsMusicState.playlist[index];
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    
    // ã€æ–°å¢ã€‘è§£æå’Œæ¸²æŸ“æ­Œè¯
    track.parsedLyrics = parseLRC(track.lrcContent || ""); // å¤ç”¨ä½ å·²æœ‰çš„æ­Œè¯è§£æå‡½æ•°
    track.currentLyricIndex = -1;
    renderLSLyrics(track);

    lsAudioPlayer.src = track.src;
    try {
        await lsAudioPlayer.play();
        lsMusicState.isPlaying = true;
    } catch (error) {
        console.error("æƒ…ä¾£ç©ºé—´éŸ³ä¹æ’­æ”¾å¤±è´¥:", error);
        lsMusicState.isPlaying = false;
    }
    
    renderLSMusicPlayerUI();
    renderLSMusicPlaylist(); 
}


/**
 * åˆ‡æ¢æ’­æ”¾/æš‚åœçŠ¶æ€ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function toggleLSMusicPlayPause() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    if (lsMusicState.currentIndex === -1 && lsMusicState.playlist.length > 0) {
        // å¦‚æœåˆ—è¡¨æœ‰æ­Œä½†è¿˜æ²¡å¼€å§‹æ’­ï¼Œç‚¹å‡»æ’­æ”¾å°±ä»ç¬¬ä¸€é¦–å¼€å§‹
        playLSSong(0);
        return;
    }
    
    if (lsAudioPlayer.paused) {
        lsAudioPlayer.play();
        lsMusicState.isPlaying = true;
    } else {
        lsAudioPlayer.pause();
        lsMusicState.isPlaying = false;
    }
    renderLSMusicPlayerUI();
}

/**
 * æ’­æ”¾ä¸‹ä¸€é¦– (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function playNextLSSong() {
    if (lsMusicState.playlist.length === 0) return;
    const newIndex = (lsMusicState.currentIndex + 1) % lsMusicState.playlist.length;
    playLSSong(newIndex);
}

/**
 * æ’­æ”¾ä¸Šä¸€é¦– (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function playPrevLSSong() {
    if (lsMusicState.playlist.length === 0) return;
    const newIndex = (lsMusicState.currentIndex - 1 + lsMusicState.playlist.length) % lsMusicState.playlist.length;
    playLSSong(newIndex);
}

/**
 * æ›´æ–°æ’­æ”¾å™¨ç•Œé¢ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function renderLSMusicPlayerUI() {
    const track = lsMusicState.playlist[lsMusicState.currentIndex];

    if (track) {
        document.getElementById('ls-album-cover').src = track.cover;
        document.getElementById('ls-song-title').textContent = track.name;
        document.getElementById('ls-artist').textContent = track.artist;
    } else {
        document.getElementById('ls-album-cover').src = 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
        document.getElementById('ls-song-title').textContent = 'æš‚æ— æ­Œæ›²';
        document.getElementById('ls-artist').textContent = '...';
    }

    document.getElementById('ls-play-pause-btn').textContent = lsMusicState.isPlaying ? 'âšâš' : 'â–¶';
}

/**
 * æ›´æ–°è¿›åº¦æ¡ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function updateLSProgressBar() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    const currentTimeEl = document.getElementById('ls-current-time');
    const totalTimeEl = document.getElementById('ls-total-time');
    const progressFillEl = document.getElementById('ls-progress-fill');

    if (!lsAudioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    
    const progressPercent = (lsAudioPlayer.currentTime / lsAudioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(lsAudioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(lsAudioPlayer.duration);
    updateLSCurrentLyric(lsAudioPlayer.currentTime);
}

/**
 * æ¸²æŸ“æ’­æ”¾åˆ—è¡¨ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function renderLSMusicPlaylist() {
    const playlistBody = document.getElementById('ls-playlist-body');
    playlistBody.innerHTML = '';
    
    if (lsMusicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„</p>';
        return;
    }

    lsMusicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if (index === lsMusicState.currentIndex) {
            item.classList.add('playing');
        }
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playLSSong(index));
        playlistBody.appendChild(item);
    });
}
// â–¼â–¼â–¼ åœ¨ clearLSMusicPlaylist() å‡½æ•°çš„ä¸Šæ–¹ï¼Œç²˜è´´è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“æ­Œè¯åˆ—è¡¨ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function renderLSLyrics(track) {
    const lyricsList = document.getElementById('ls-lyrics-list');
    lyricsList.innerHTML = '';
    if (!track.parsedLyrics || track.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line active">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
        return;
    }
    track.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(45%)`; // åˆå§‹ä½ç½®
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°å½“å‰é«˜äº®çš„æ­Œè¯ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function updateLSCurrentLyric(currentTime) {
    const track = lsMusicState.playlist[lsMusicState.currentIndex];
    if (!track || !track.parsedLyrics || track.parsedLyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < track.parsedLyrics.length; i++) {
        if (currentTime >= track.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    
    if (newLyricIndex !== track.currentLyricIndex) {
        track.currentLyricIndex = newLyricIndex;
        
        const lyricsList = document.getElementById('ls-lyrics-list');
        const container = document.getElementById('ls-lyrics-container');
        
        lyricsList.querySelectorAll('.lyric-line').forEach(line => line.classList.remove('active'));
        
        if (newLyricIndex > -1) {
            const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${newLyricIndex}"]`);
            if (activeLine) {
                activeLine.classList.add('active');
                // è®¡ç®—æ»šåŠ¨åç§»é‡ï¼Œè®©é«˜äº®è¡Œå‚ç›´å±…ä¸­
                const offset = (container.offsetHeight / 2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
                lyricsList.style.transform = `translateY(${offset}px)`;
            }
        }
    }
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * æ¸…ç©ºæ’­æ”¾åˆ—è¡¨ (æƒ…ä¾£ç©ºé—´ç‰ˆ)
 */
function clearLSMusicPlaylist() {
    const lsAudioPlayer = document.getElementById('ls-audio-player');
    lsAudioPlayer.pause();
    lsAudioPlayer.src = '';

    lsMusicState.playlist = [];
    lsMusicState.currentIndex = -1;
    lsMusicState.isPlaying = false;
    
    renderLSMusicPlayerUI();
    renderLSMusicPlaylist();
}

// â–²â–²â–² æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¾£ç•ªèŒ„é’ŸåŠŸèƒ½æ ¸å¿ƒå‡½æ•° --- */

/**
 * æ‰“å¼€ç•ªèŒ„é’Ÿä¸»é¡µå¹¶æ¸²æŸ“å†å²è®°å½•
 */
async function openPomodoroScreen() {
    if (!activeLoversSpaceCharId) return;
    await renderPomodoroHistory(activeLoversSpaceCharId);
    
    // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯ä¸»é¡µï¼Œè€Œä¸æ˜¯è®¡æ—¶å™¨ç•Œé¢
    document.getElementById('ls-pomodoro-home').style.display = 'flex';
    document.getElementById('ls-pomodoro-timer-active').style.display = 'none';
}

/**
 * æ¸²æŸ“æŒ‡å®šè§’è‰²çš„ç•ªèŒ„é’Ÿå†å²è®°å½•
 * @param {string} charId - è§’è‰²ID
 */
async function renderPomodoroHistory(charId) {
    const listEl = document.getElementById('ls-pomodoro-history-list');
    listEl.innerHTML = '';
    const sessions = await db.pomodoroSessions.where('chatId').equals(charId).reverse().sortBy('startTime');
    
    if (sessions.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); font-size: 14px;">è¿˜æ²¡æœ‰ä¸“æ³¨è®°å½•å“¦</p>';
        return;
    }

    sessions.forEach(session => {
        const item = document.createElement('div');
        item.className = 'pomodoro-history-item';
        item.dataset.sessionId = session.id;
        item.innerHTML = `
            <div class="task">${session.task}</div>
            <div class="meta">
                ${new Date(session.startTime).toLocaleString()} | ä¸“æ³¨äº† ${Math.round(session.duration / 60)} åˆ†é’Ÿ
            </div>
        `;
        item.addEventListener('click', () => showPomodoroHistoryDetail(session.id));
        listEl.appendChild(item);
    });
}

/**
 * æ˜¾ç¤ºæŒ‡å®šå†å²è®°å½•çš„èŠå¤©è¯¦æƒ…
 * @param {number} sessionId - è®°å½•çš„ID
 */
async function showPomodoroHistoryDetail(sessionId) {
    const session = await db.pomodoroSessions.get(sessionId);
    if (!session) return;
    
    const modal = document.getElementById('ls-pomodoro-history-viewer-modal');
    const titleEl = document.getElementById('pomodoro-history-viewer-title');
    const contentEl = document.getElementById('pomodoro-history-viewer-content');
    
    titleEl.textContent = `â€œ${session.task}â€çš„ä¸“æ³¨è®°å½•`;
    contentEl.innerHTML = '';

    if (session.log && session.log.length > 0) {
        session.log.forEach(logEntry => {
            const bubble = document.createElement('div');
            bubble.className = 'pomodoro-log-bubble';
            bubble.textContent = logEntry.content;
            contentEl.appendChild(bubble);
        });
    } else {
        contentEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">è¿™æ¬¡ä¸“æ³¨æœŸé—´æ²¡æœ‰èŠå¤©è®°å½•å“¦ã€‚</p>';
    }
    
    modal.classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªæ–°å‡½æ•°æ›¿æ¢æ—§çš„ openPomodoroSetup â–¼â–¼â–¼
function openPomodoroSetup() {
    document.getElementById('pomodoro-task-input').value = '';
    document.getElementById('pomodoro-duration-input').value = '25';
    document.getElementById('pomodoro-talk-interval-input').value = '5';
    document.getElementById('pomodoro-bg-url-input').value = '';
    
    // æ ¸å¿ƒæ–°å¢ï¼šæ¯æ¬¡æ‰“å¼€æ—¶ï¼Œæ¸…ç©ºä¸Šä¸€æ¬¡æœ¬åœ°ä¸Šä¼ çš„ä¸´æ—¶æ•°æ®
    pomodoroState.tempBgDataUrl = null; 

    document.getElementById('ls-pomodoro-setup-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€æ”¯æŒæ­£/å€’è®¡æ—¶ã€‘çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ startPomodoroSession å‡½æ•° â–¼â–¼â–¼
async function startPomodoroSession() {
    const task = document.getElementById('pomodoro-task-input').value.trim();
    // 1. è·å–ç”¨æˆ·é€‰æ‹©çš„è®¡æ—¶æ¨¡å¼
    const timerType = document.querySelector('input[name="pomodoro-mode"]:checked').value;
    const durationMinutes = parseInt(document.getElementById('pomodoro-duration-input').value);
    const talkIntervalMinutes = parseInt(document.getElementById('pomodoro-talk-interval-input').value);
    const bgUrl = pomodoroState.tempBgDataUrl || document.getElementById('pomodoro-bg-url-input').value.trim();

    if (!task) {
        alert("è¯·è¾“å…¥ä¸€ä¸ªä¸“æ³¨ä»»åŠ¡ï¼");
        return;
    }
    // 2. å¦‚æœæ˜¯å€’è®¡æ—¶æ¨¡å¼ï¼Œæ‰éœ€è¦æ£€æŸ¥æ—¶é•¿æ˜¯å¦æœ‰æ•ˆ
    if (timerType === 'countdown' && (isNaN(durationMinutes) || durationMinutes < 1)) {
        alert("å€’è®¡æ—¶æ¨¡å¼ä¸‹ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„ä¸“æ³¨æ—¶é•¿ï¼");
        return;
    }

    const chat = state.chats[activeLoversSpaceCharId];
    // 3. æ ¹æ®æ¨¡å¼ï¼Œè®¾ç½®æ€»æ—¶é•¿ï¼ˆæ­£è®¡æ—¶æ¨¡å¼æ€»æ—¶é•¿ä¸º0ï¼Œå› ä¸ºå®ƒä¼šä¸€ç›´å¢åŠ ï¼‰
    const durationSeconds = timerType === 'countdown' ? durationMinutes * 60 : 0; 
    
    pomodoroState.currentSession = {
        chatId: activeLoversSpaceCharId,
        task: task,
        duration: durationSeconds,
        timerType: timerType, // 4. æŠŠè®¡æ—¶æ¨¡å¼ä¹Ÿä¿å­˜åˆ°ä¼šè¯è®°å½•é‡Œ
        startTime: Date.now(),
        log: []
    };
    
    const timerView = document.getElementById('ls-pomodoro-timer-active');
    document.getElementById('ls-pomodoro-home').style.display = 'none';
    timerView.style.display = 'flex';
    
    if (bgUrl) {
        timerView.style.backgroundImage = `url(${bgUrl})`;
    } else {
        timerView.style.backgroundImage = `url(${chat.settings.aiAvatar})`;
    }
    
    document.getElementById('pomodoro-char-avatar').src = chat.settings.aiAvatar;
    document.getElementById('pomodoro-current-task').textContent = task;
    
    // 5. æ ¹æ®æ¨¡å¼ï¼Œè®¾ç½®è®¡æ—¶å™¨çš„åˆå§‹å€¼
    let timeTracker = timerType === 'countdown' ? durationSeconds : 0;
    updatePomodoroTimerDisplay(timeTracker);

    pomodoroState.timerId = setInterval(() => {
        // 6. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¢åŠ è¿˜æ˜¯å‡å°‘æ—¶é—´
        if (timerType === 'countdown') {
            timeTracker--;
            if (timeTracker <= 0) {
                updatePomodoroTimerDisplay(0); // ç¡®ä¿æ˜¾ç¤º00:00
                endPomodoroSession(true); // å€’è®¡æ—¶ç»“æŸ
            }
        } else { // 'countup'
            timeTracker++;
        }
        updatePomodoroTimerDisplay(timeTracker);
    }, 1000);
    if (talkIntervalMinutes > 0) {
        pomodoroState.periodicTalkTimerId = setInterval(() => {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç°åœ¨å®ƒä¼šè°ƒç”¨APIæ¥ç”Ÿæˆè¯è¯­
            triggerPomodoroAIResponse("periodic_encouragement");
        }, talkIntervalMinutes * 60 * 1000);
    }
    pomodoroState.isActive = true;
    document.getElementById('ls-pomodoro-setup-modal').classList.remove('visible');
    
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšå’Œä½ ä¸€èµ·å¼€å§‹äº†ä¸€ä¸ªç•ªèŒ„é’Ÿä¸“æ³¨ä»»åŠ¡ï¼šâ€œ${task}â€ï¼Œæ—¶é•¿ä¸º${durationMinutes}åˆ†é’Ÿã€‚åœ¨ä¸“æ³¨æœŸé—´ï¼Œä½ å¯ä»¥é€šè¿‡ "pomodoro_talk" æŒ‡ä»¤æ¥é¼“åŠ±ç”¨æˆ·ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * æ›´æ–°ç•ªèŒ„é’Ÿçš„å€’è®¡æ—¶æ˜¾ç¤º
 * @param {number} secondsLeft - å‰©ä½™ç§’æ•°
 */
function updatePomodoroTimerDisplay(secondsLeft) {
    const minutes = Math.floor(secondsLeft / 60);
    const seconds = secondsLeft % 60;
    document.getElementById('pomodoro-time').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤æ—¶é•¿è®°å½•ã€‘çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ endPomodoroSession å‡½æ•° â–¼â–¼â–¼
async function endPomodoroSession(isCompleted = false) {
    if (!pomodoroState.isActive) return;

    clearInterval(pomodoroState.timerId);
    clearInterval(pomodoroState.periodicTalkTimerId);

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨ä¿å­˜å‰ï¼Œæ ¹æ®è®¡æ—¶æ¨¡å¼é‡æ–°è®¡ç®—å¹¶æ›´æ–°æœ€ç»ˆçš„ä¸“æ³¨æ—¶é•¿
    if (pomodoroState.currentSession.timerType === 'countup') {
        // å¯¹äºæ­£è®¡æ—¶ï¼Œæ—¶é•¿æ˜¯ç»“æŸæ—¶é—´å‡å»å¼€å§‹æ—¶é—´
        pomodoroState.currentSession.duration = Math.floor((Date.now() - pomodoroState.currentSession.startTime) / 1000);
    }
    
    pomodoroState.currentSession.endTime = Date.now();
    await db.pomodoroSessions.add(pomodoroState.currentSession);
    
    document.getElementById('ls-pomodoro-timer-active').style.display = 'none';
    document.getElementById('ls-pomodoro-home').style.display = 'flex';
    await renderPomodoroHistory(activeLoversSpaceCharId);

    pomodoroState = { isActive: false, timerId: null, periodicTalkTimerId: null, currentSession: null };

    const chat = state.chats[activeLoversSpaceCharId];
    const endReason = isCompleted ? "æ—¶é—´åˆ°äº†ï¼Œä»»åŠ¡å·²å®Œæˆ" : "è¢«ç”¨æˆ·æ‰‹åŠ¨ä¸­æ–­";
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç•ªèŒ„é’Ÿä¸“æ³¨ä»»åŠ¡å·²ç»“æŸã€‚ç»“æŸåŸå› ï¼š${endReason}ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);

    if (isCompleted) {
        showCustomAlert("ä¸“æ³¨å®Œæˆï¼", "æ­å–œä½ å®Œæˆäº†ä¸€æ¬¡ä¸“æ³¨æ—¶å…‰ï¼Œä¼‘æ¯ä¸€ä¸‹å§ï¼");
    } else {
        showCustomAlert("ä¸“æ³¨ç»“æŸ", "ä½ ä¸­æ–­äº†æœ¬æ¬¡ä¸“æ³¨ã€‚");
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘è§¦å‘ç•ªèŒ„é’ŸæœŸé—´çš„AIäº’åŠ¨ (å·²åŠ å…¥ç”¨æˆ·äººè®¾å¹¶å¢åŠ å›å¤é•¿åº¦)
 * @param {string} triggerType - è§¦å‘ç±»å‹, 'user_click' æˆ– 'periodic_encouragement'
 */
async function triggerPomodoroAIResponse(triggerType) {
    if (!pomodoroState.isActive || !activeLoversSpaceCharId) return;

    const chat = state.chats[activeLoversSpaceCharId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.warn("ç•ªèŒ„é’ŸAIäº’åŠ¨å¤±è´¥ï¼šAPIæœªé…ç½®ã€‚");
        return;
    }

    // --- ã€æ ¸å¿ƒä¿®æ”¹1ï¼šåŠ å…¥äº†ç”¨æˆ·äººè®¾ã€‘ ---
    const elapsedSeconds = Math.floor((Date.now() - pomodoroState.currentSession.startTime) / 1000);
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const timeContext = `ç”¨æˆ·å·²ç»æŒç»­ä¸“æ³¨äº† ${elapsedMinutes} åˆ†é’Ÿã€‚`;
    const triggerReason = triggerType === 'user_click' ? 'ç”¨æˆ·åˆšåˆšç‚¹å‡»äº†ä½ çš„å¤´åƒï¼Œä¼¼ä¹éœ€è¦ä¸€äº›é¼“åŠ±ã€‚' : 'åˆ°äº†ä½ ä¸»åŠ¨é¼“åŠ±ç”¨æˆ·çš„æ—¶é—´ã€‚';

    const systemPrompt = `
# ä»»åŠ¡
ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·è¿›è¡Œç•ªèŒ„é’Ÿä¸“æ³¨ã€‚
- ä½ ä»¬æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ˜¯: "${pomodoroState.currentSession.task}"
- ${timeContext}
- è§¦å‘æœ¬æ¬¡å¯¹è¯çš„åŸå› æ˜¯: ${triggerReason}
- ä½ çš„è§’è‰²äººè®¾: ${chat.settings.aiPersona}
- ä½ çš„èŠå¤©å¯¹è±¡(ç”¨æˆ·)çš„äººè®¾: ${chat.settings.myPersona}

# æ ¸å¿ƒè§„åˆ™
1.  **ä¿æŒä¸“æ³¨**: ä½ çš„å›å¤è¦æ›´ä¸°å¯Œã€æ›´æœ‰å†…å®¹ï¼Œå¤§çº¦50å­—å·¦å³ï¼Œç›®çš„æ˜¯å¸®åŠ©ç”¨æˆ·ç»§ç»­ä¸“æ³¨äºä»»åŠ¡ï¼Œè€Œä¸æ˜¯é—²èŠã€‚
2.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹: \`{"type": "pomodoro_talk", "content": "ä½ çš„é¼“åŠ±è¯­..."}\`

ç°åœ¨ï¼Œè¯·ç”Ÿæˆä½ çš„é¼“åŠ±è¯­ã€‚`;

    const userMessage = { 
        role: 'user', 
        content: `è¯·æ ¹æ®ä½ å’Œæˆ‘çš„è§’è‰²äººè®¾ï¼Œå¯¹æˆ‘æ­£åœ¨è¿›è¡Œçš„â€œ${pomodoroState.currentSession.task}â€ä»»åŠ¡ï¼Œè¯´ä¸€æ®µé¼“åŠ±çš„è¯ã€‚` 
    };

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        
        let requestBody;
        let requestUrl = `${proxyUrl}/v1/chat/completions`;
        let requestHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getRandomValue(apiKey)}`
        };

        if (isGemini) {
            requestUrl = `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
            requestHeaders = {'Content-Type': 'application/json'};
            requestBody = {
                contents: [userMessage],
                generationConfig: {
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    "response_mime_type": "application/json", 
                },
                "systemInstruction": {
                    "parts": [{"text": systemPrompt}]
                }
            };
        } else {
            requestBody = {
                model: model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    userMessage
                ],
                temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                response_format: { type: "json_object" }
            };
        }

        const response = await fetch(requestUrl, {
            method: 'POST',
            headers: requestHeaders,
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content)
            .replace(/^```json\s*|```$/g, '').trim();
        const responseObj = JSON.parse(rawContent);

        if (responseObj.type === 'pomodoro_talk' && responseObj.content) {
            const logEntry = { timestamp: Date.now(), content: responseObj.content };
            pomodoroState.currentSession.log.push(logEntry);
            
            const logEl = document.getElementById('pomodoro-char-log');
            logEl.textContent = responseObj.content;
            logEl.classList.add('visible');
            setTimeout(() => {
                logEl.classList.remove('visible');
            }, 4000);
        }
    } catch (error) {
        console.error("ç•ªèŒ„é’ŸAIäº’åŠ¨å¤±è´¥:", error);
        const logEl = document.getElementById('pomodoro-char-log');
        logEl.textContent = `[é”™è¯¯: APIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥F12æ§åˆ¶å°]`;
        logEl.classList.add('visible');
        setTimeout(() => {
            logEl.classList.remove('visible');
        }, 10000);
    }
}
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å‘é€æƒ…ä¾£ç©ºé—´é‚€è¯·
 * @param {string} targetChatId - è¢«é‚€è¯·çš„è§’è‰²ID
 */
async function sendLoversSpaceInvitation(targetChatId) {
    const chat = state.chats[targetChatId];
    if (!chat) return;

    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    // 1. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œé‚€è¯·å¡ç‰‡â€æ¶ˆæ¯
    const visibleMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'lovers_space_invitation',
        content: `${myNickname} å¯¹ ${chat.name} å‘é€äº†ä¸€ä¸ªæƒ…ä¾£ç©ºé—´é‚€è¯·`, // <-- å°±æ˜¯åœ¨è¿™é‡Œæ–°å¢äº†è¿™ä¸€è¡Œï¼
        timestamp: Date.now(),
        status: 'pending' // çŠ¶æ€ï¼špending, accepted, rejected
    };
    chat.history.push(visibleMessage);

    // 2. åˆ›å»ºå¯¹AIå¯è§çš„â€œéšè—æŒ‡ä»¤â€æ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšå‘ä½ å‘èµ·äº†â€œå¼€å¯æƒ…ä¾£ç©ºé—´â€çš„é‚€è¯·ã€‚è¯·ä½ æ ¹æ®äººè®¾ï¼Œå†³å®šæ˜¯å¦åŒæ„ï¼Œå¹¶ä½¿ç”¨ 'lovers_space_response' æŒ‡ä»¤å›åº”ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);
    
    // 3. ä¿å­˜å¹¶è§¦å‘AIå“åº”
    await db.chats.put(chat);
    triggerAiResponse();
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„ã€æ­£ä¸Šæ–¹ã€‘ç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·å¯¹æƒ…ä¾£ç©ºé—´é‚€è¯·çš„å›åº”
 * @param {number} timestamp - è¢«å›åº”çš„é‚€è¯·æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'rejected'
 */
async function handleLoversSpaceResponse(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const invitationMsg = chat.history.find(m => m.timestamp === timestamp);
    if (!invitationMsg || invitationMsg.status !== 'pending') return;

    // 1. æ›´æ–°åŸå§‹é‚€è¯·å¡ç‰‡çš„çŠ¶æ€
    invitationMsg.status = choice;

    // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œæ“ä½œ
    if (choice === 'accepted') {
        // å¦‚æœåŒæ„ï¼Œå°±ä¸ºè¿™ä¸ªè§’è‰²åˆ›å»ºæƒ…ä¾£ç©ºé—´æ•°æ®
        chat.loversSpaceData = {
            background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
            relationshipStartDate: null,
            moments: [],
            albums: [],
            loveLetters: [],
            shares: [],
            questions: [],
        };
        
        // åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿé€šçŸ¥
        const systemNotice = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
    }
    
    // 3. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ï¼Œä½†å¯¹AIå¯è§çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œå‘Šè¯‰AIä½ çš„å†³å®š
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·${choice === 'accepted' ? 'åŒæ„äº†' : 'æ‹’ç»äº†'}ä½ å¼€å¯æƒ…ä¾£ç©ºé—´çš„é‚€è¯·ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“
    await db.chats.put(chat);
    
    // 5. åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œå¹¶è§¦å‘AIçš„å›åº”
    renderChatInterface(state.activeChatId);
    triggerAiResponse();
}

/**
 * ã€å…¨æ–°ã€‘åº”ç”¨ä¸»å±å¹•å›¾æ ‡å’Œå°ç»„ä»¶çš„æ–‡å­—é¢œè‰²
 * @param {string} color - é¢œè‰²ä»£ç , e.g., '#FFFFFF'
 */
function applyHomeIconWidgetTextColor(color) {
    const phoneScreen = document.getElementById('phone-screen');
    if (phoneScreen && color) {
        // ä½¿ç”¨æ–°çš„CSSå˜é‡å
        phoneScreen.style.setProperty('--home-icon-widget-text-color', color);
    }
}
/**
 * ã€æ–°å¢è¾…åŠ©å‡½æ•°1ã€‘å°†æ—¶é•¿å­—ç¬¦ä¸²ï¼ˆå¦‚â€œ2.5å°æ—¶â€, "30m"ï¼‰è§£æä¸ºåˆ†é’Ÿæ•°
 * @param {string} durationString - æ—¶é•¿æè¿°æ–‡æœ¬
 * @returns {number} - å¯¹åº”çš„åˆ†é’Ÿæ•°
 */
function parseDurationToMinutes(durationString) {
    if (!durationString || typeof durationString !== 'string') return 0;
    
    const text = durationString.toLowerCase();
    const num = parseFloat(text.match(/(\d+(\.\d+)?)/)?.[0]) || 0;

    if (text.includes('å°æ—¶') || text.includes('h')) {
        return num * 60;
    }
    if (text.includes('åˆ†é’Ÿ') || text.includes('m')) {
        return num;
    }
    // å¦‚æœæ²¡æœ‰å•ä½ï¼Œä½†æ•°å€¼å¤§äºç­‰äº10ï¼Œæˆ‘ä»¬çŒœæµ‹æ˜¯åˆ†é’Ÿ
    if (num >= 10) {
        return num;
    }
    // å…¶ä»–æƒ…å†µï¼ˆå¦‚æ•°å€¼å¾ˆå°ä¸”æ— å•ä½ï¼‰ï¼ŒçŒœæµ‹æ˜¯å°æ—¶
    return num * 60;
}

/**
 * ã€æ–°å¢è¾…åŠ©å‡½æ•°2ã€‘å°†æ€»åˆ†é’Ÿæ•°æ ¼å¼åŒ–ä¸º "Xå°æ—¶Yåˆ†é’Ÿ" çš„å­—ç¬¦ä¸²
 * @param {number} totalMinutes - æ€»åˆ†é’Ÿæ•°
 * @returns {string} - æ ¼å¼åŒ–åçš„æ—¶é•¿å­—ç¬¦ä¸²
 */
function formatMinutesToDuration(totalMinutes) {
    if (totalMinutes < 1) return 'ä¸åˆ°1åˆ†é’Ÿ';
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = Math.round(totalMinutes % 60);

    if (hours > 0 && minutes > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    } else if (hours > 0) {
        return `${hours}å°æ—¶`;
    } else {
        return `${minutes}åˆ†é’Ÿ`;
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°ç»„åˆ†ç±»ç­›é€‰åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ openForumFilterModal å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€åˆ†ç±»ç­›é€‰æ¨¡æ€æ¡† (V3 - å·²åˆ†ç¦»å°ç»„å’Œå¸–å­çš„åˆ†ç±»)
 * @param {'global' | 'group'} type - ç­›é€‰ç±»å‹ï¼š'global'ä¸ºä¸»é¡µç­›é€‰å°ç»„ï¼Œ'group'ä¸ºå°ç»„å†…ç­›é€‰å¸–å­
 * @param {number|null} id - å¦‚æœæ˜¯å°ç»„å†…ç­›é€‰ï¼Œåˆ™ä¸ºå°ç»„çš„ID
 */
async function openForumFilterModal(type, id = null) {
    currentFilterContext = { type, id };
    const modal = document.getElementById('forum-filter-modal');
    const listEl = document.getElementById('forum-filter-category-list');
    listEl.innerHTML = '';

    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ­£ï¼šæ ¹æ®ä¸Šä¸‹æ–‡ï¼Œä»ä¸åŒçš„åœ°æ–¹æ”¶é›†åˆ†ç±» â–¼â–¼â–¼ ---
    let availableCategories = new Set(); // ä½¿ç”¨Setæ¥è‡ªåŠ¨å»é‡

    try {
        if (type === 'global') {
            // å¦‚æœæ˜¯åœ¨â€œåœˆå­â€ä¸»é¡µï¼Œæˆ‘ä»¬åªå…³å¿ƒã€å°ç»„ã€‘çš„åˆ†ç±»
            console.log("æ­£åœ¨ä¸ºå°ç»„åˆ—è¡¨æ”¶é›†åˆ†ç±»...");
            const allGroups = await db.forumGroups.toArray();
            allGroups.forEach(group => {
                if (group.categories) {
                    group.categories.forEach(cat => availableCategories.add(cat));
                }
            });
        } else if (type === 'group' && id) {
            // å¦‚æœæ˜¯åœ¨å…·ä½“çš„â€œå°ç»„â€é¡µé¢ï¼Œæˆ‘ä»¬åªå…³å¿ƒè¯¥å°ç»„ä¸‹ã€å¸–å­ã€‘çš„åˆ†ç±»
            console.log(`æ­£åœ¨ä¸ºå°ç»„ ID: ${id} çš„å¸–å­åˆ—è¡¨æ”¶é›†åˆ†ç±»...`);
            const postsInGroup = await db.forumPosts.where('groupId').equals(id).toArray();
            postsInGroup.forEach(post => {
                if (post.categories) {
                    post.categories.forEach(cat => availableCategories.add(cat));
                }
            });
        }
    } catch (error) {
        console.error("æ”¶é›†åˆ†ç±»æ ‡ç­¾æ—¶å‡ºé”™:", error);
    }
    // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² ---

    const categoryArray = Array.from(availableCategories).sort(); // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº

    if (categoryArray.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">å½“å‰æ²¡æœ‰ä»»ä½•å¯ç”¨çš„åˆ†ç±»æ ‡ç­¾ã€‚</p>';
    } else {
        const activeFilters = type === 'global' ? activeForumFilters.global : (activeForumFilters.group[id] || []);
        
        categoryArray.forEach((catName, index) => {
            const isChecked = activeFilters.includes(catName);
            const label = document.createElement('label');
            const inputId = `filter-cat-${type}-${index}`; // åˆ›å»ºå”¯ä¸€çš„ID
            label.setAttribute('for', inputId);
            label.innerHTML = `
                <input type="checkbox" id="${inputId}" value="${catName}" ${isChecked ? 'checked' : ''}>
                <span>${catName}</span>
            `;
            listEl.appendChild(label);
        });
    }
    
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * åº”ç”¨ç­›é€‰æ¡ä»¶å¹¶åˆ·æ–°åˆ—è¡¨
 */
async function applyForumFilter() {
    const { type, id } = currentFilterContext;
    const selectedCategories = Array.from(document.querySelectorAll('#forum-filter-category-list input:checked')).map(cb => cb.value);

    const filterBtnId = type === 'global' ? 'forum-filter-btn' : 'group-filter-btn';
    const filterBtn = document.getElementById(filterBtnId);

    if (type === 'global') {
        activeForumFilters.global = selectedCategories;
        await renderForumScreen();
    } else if (type === 'group' && id) {
        if (!activeForumFilters.group[id]) activeForumFilters.group[id] = [];
        activeForumFilters.group[id] = selectedCategories;
        await renderGroupPosts(id);
    }
    
    // æ ¹æ®æ˜¯å¦åº”ç”¨äº†ç­›é€‰ï¼Œæ›´æ–°å›¾æ ‡çŠ¶æ€
    if (selectedCategories.length > 0) {
        filterBtn.classList.add('active');
    } else {
        filterBtn.classList.remove('active');
    }

    document.getElementById('forum-filter-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

let currentPetData = null; // ç”¨äºæš‚å­˜æ­£åœ¨ç¼–è¾‘çš„å® ç‰©æ•°æ®
let isPetDragging = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ‹–åŠ¨å® ç‰©
let petDragOffset = { x: 0, y: 0 };

/**
 * ã€é¢†å…»ç³»ç»Ÿæ”¹é€ ç‰ˆã€‘æ‰“å¼€å® ç‰©ä¸»é¢æ¿ï¼ˆè®¾ç½®ä¸äº’åŠ¨ï¼‰
 */
async function openPetModal() {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        alert("åªæœ‰åœ¨å•äººèŠå¤©ä¸­æ‰èƒ½å…»å® ç‰©å“¦ï¼");
        return;
    }
    const chat = state.chats[state.activeChatId];

    // æ ¸å¿ƒåˆ¤æ–­ï¼šæ£€æŸ¥æ˜¯å¦å·²é¢†å…»
    if (!chat.settings.petAdopted) {
        // å¦‚æœæœªé¢†å…»ï¼Œå¼¹å‡ºç¡®è®¤æ¡†
        const confirmed = await showCustomConfirm(
            'é¢†å…»æ–°å® ç‰©',
            `ä½ è¿˜æ²¡æœ‰ä¸ºâ€œ${chat.name}â€é¢†å…»å® ç‰©ï¼Œè¦ç°åœ¨å¼€å¯å® ç‰©ç³»ç»Ÿå—ï¼Ÿ`,
            { confirmText: 'ç°åœ¨é¢†å…»' }
        );

        if (confirmed) {
            // ç”¨æˆ·åŒæ„é¢†å…»
            chat.settings.petAdopted = true;
            // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„é»˜è®¤å® ç‰©å¯¹è±¡
            chat.settings.pet = {
                type: 'æ— ', name: '', image: 'ğŸ¥š', persona: 'ä¸€åªå¯çˆ±çš„å°å® ç‰©ï¼Œå¯¹ä¸–ç•Œå……æ»¡å¥½å¥‡ã€‚',
                petChatHistory: [], isCustomImage: false,
                display: { show: false, size: 100, top: '80%', left: '50%' },
                status: {
                    hunger: 100, happiness: 100, intimacyToUser: 50,
                    intimacyToChar: 50, lastUpdated: Date.now()
                }
            };
            await db.chats.put(chat);
            alert(`æ­å–œï¼ä½ å·²æˆåŠŸä¸ºâ€œ${chat.name}â€å¼€å¯å® ç‰©ç³»ç»Ÿï¼ç°åœ¨æ¥ä¸ºå®ƒè®¾ç½®ä¸€ä¸‹å§ã€‚`);
            // é¢†å…»æˆåŠŸåï¼Œå†æ¬¡è°ƒç”¨æœ¬å‡½æ•°ï¼Œè¿™æ¬¡ä¼šç›´æ¥è¿›å…¥è®¾ç½®ç•Œé¢
            openPetModal(); 
        }
        // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
        return;
    }

    // --- å¦‚æœå·²ç»é¢†å…»ï¼Œåˆ™æ‰§è¡ŒåŸæ¥çš„æ˜¾ç¤ºé€»è¾‘ ---
    currentPetData = JSON.parse(JSON.stringify(chat.settings.pet)); 

    document.getElementById('pet-type-input').value = currentPetData.type === 'æ— ' ? '' : currentPetData.type;
    document.getElementById('pet-name-input').value = currentPetData.name;
    document.getElementById('pet-image-input').value = currentPetData.image;
    document.getElementById('pet-display-toggle').checked = currentPetData.display.show;
    document.getElementById('pet-size-slider').value = currentPetData.display.size;
    document.getElementById('pet-size-value').textContent = `${currentPetData.display.size}px`;
    document.getElementById('pet-persona-input').value = currentPetData.persona || '';
    
    updatePetPreview();

    if (currentPetData.type !== 'æ— ') {
        document.getElementById('pet-stats-area').style.display = 'flex';
        updatePetStatusUI(currentPetData);
    } else {
        document.getElementById('pet-stats-area').style.display = 'none';
    }

    const positionControls = document.getElementById('pet-position-controls');
    positionControls.style.display = currentPetData.display.show ? 'block' : 'none';
    
    document.getElementById('pet-modal').classList.add('visible');
}


/**
 * è®¡ç®—å¹¶åº”ç”¨å® ç‰©çš„æ•°å€¼è¡°å‡
 * @param {object} pet - å® ç‰©å¯¹è±¡
 * @returns {boolean} - å¦‚æœæ•°å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿”å› true
 */
function applyPetDecay(pet) {
    if (!pet || !pet.status) return false;

    const now = Date.now();
    const lastUpdated = pet.status.lastUpdated || now;
    const timeElapsed = now - lastUpdated;

    // è®¡ç®—è¿‡å»äº†å¤šå°‘ä¸ªè¡°å‡å‘¨æœŸ
    const intervalsPassed = Math.floor(timeElapsed / PET_DECAY_INTERVAL);

    if (intervalsPassed > 0) {
        // è®¡ç®—æ€»å…±è¦è¡°å‡å¤šå°‘
        const totalHungerDecay = intervalsPassed * PET_DECAY_AMOUNT.hunger;
        const totalHappinessDecay = intervalsPassed * PET_DECAY_AMOUNT.happiness;

        // åº”ç”¨è¡°å‡ï¼Œç¡®ä¿ä¸ä½äº0
        pet.status.hunger = Math.max(0, pet.status.hunger - totalHungerDecay);
        pet.status.happiness = Math.max(0, pet.status.happiness - totalHappinessDecay);

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ï¼ŒåªåŠ ä¸Šå·²ç»è®¡ç®—è¿‡çš„å‘¨æœŸçš„æ—¶é—´ï¼Œé¿å…ä¸¢å¤±é›¶å¤´æ—¶é—´
        pet.status.lastUpdated = lastUpdated + intervalsPassed * PET_DECAY_INTERVAL;
        
        console.log(`å® ç‰©"${pet.name}"æ•°å€¼è¡°å‡: ${intervalsPassed}ä¸ªå‘¨æœŸ, é¥±é£Ÿåº¦-${totalHungerDecay}, å¿ƒæƒ…-${totalHappinessDecay}`);
        return true; // æ•°å€¼å·²æ”¹å˜
    }

    return false; // æ•°å€¼æœªæ”¹å˜
}

/**
 * åœæ­¢å½“å‰çš„å® ç‰©è¡°å‡è®¡æ—¶å™¨
 */
function stopPetDecayTimer() {
    if (petDecayTimer) {
        clearInterval(petDecayTimer);
        petDecayTimer = null;
        // console.log("å® ç‰©è¡°å‡è®¡æ—¶å™¨å·²åœæ­¢ã€‚");
    }
}

/**
 * ä¸ºå½“å‰èŠå¤©ä¸­çš„å® ç‰©å¯åŠ¨è¡°å‡è®¡æ—¶å™¨
 */
function startPetDecayTimer() {
    stopPetDecayTimer(); // å…ˆç¡®ä¿åœæ­¢ä»»ä½•æ—§çš„è®¡æ—¶å™¨

    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.pet || chat.settings.pet.type === 'æ— ') {
        return; // å¦‚æœå½“å‰èŠå¤©æ²¡æœ‰å® ç‰©ï¼Œåˆ™ä¸å¯åŠ¨
    }
    
    // console.log(`ä¸ºå® ç‰©"${chat.settings.pet.name}"å¯åŠ¨è¡°å‡è®¡æ—¶å™¨ã€‚`);
    
    // ä½¿ç”¨ setInterval å®šæœŸæ£€æŸ¥å¹¶åº”ç”¨è¡°å‡
    petDecayTimer = setInterval(async () => {
        const currentChat = state.chats[state.activeChatId];
        if (!currentChat) { // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœèŠå¤©å·²å…³é—­åˆ™åœæ­¢è®¡æ—¶å™¨
            stopPetDecayTimer();
            return;
        }
        const pet = currentChat.settings.pet;
        
        if (applyPetDecay(pet)) {
            // å¦‚æœæ•°å€¼å˜åŒ–äº†ï¼Œæ›´æ–°UIå¹¶ä¿å­˜åˆ°æ•°æ®åº“
            // åªæœ‰å½“å® ç‰©é¢æ¿æ‰“å¼€æ—¶æ‰éœ€è¦æ›´æ–°UI
            if (document.getElementById('pet-modal').classList.contains('visible')) {
                 updatePetStatusUI(pet);
            }
            await db.chats.put(currentChat);
        }
    }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œæ˜¯å¦åˆ°è¾¾äº†è¡°å‡å‘¨æœŸ
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ›´æ–°ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ updatePetStatusUI å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ›´æ–°å® ç‰©æ•°å€¼é¢æ¿çš„UIæ˜¾ç¤º
 * @param {object} petData - å® ç‰©çš„æ•°æ®å¯¹è±¡
 */
function updatePetStatusUI(petData) {
    const hunger = petData.status.hunger || 0;
    const happiness = petData.status.happiness || 0;
    // â˜…â˜…â˜… æ–°å¢ï¼šè·å–äº²å¯†åº¦æ•°å€¼ â˜…â˜…â˜…
    const intimacyToUser = petData.status.intimacyToUser || 0;
    const intimacyToChar = petData.status.intimacyToChar || 0;

    const hungerFill = document.querySelector('#pet-hunger-bar .stat-bar-fill');
    const happinessFill = document.querySelector('#pet-happiness-bar .stat-bar-fill');
    // â˜…â˜…â˜… æ–°å¢ï¼šè·å–äº²å¯†åº¦è¿›åº¦æ¡å…ƒç´  â˜…â˜…â˜…
    const intimacyUserFill = document.querySelector('#pet-intimacy-user-bar .stat-bar-fill');
    const intimacyCharFill = document.querySelector('#pet-intimacy-char-bar .stat-bar-fill');

    if (hungerFill) {
        hungerFill.style.width = `${hunger}%`;
        hungerFill.textContent = `${hunger}%`;
    }
    if (happinessFill) {
        happinessFill.style.width = `${happiness}%`;
        happinessFill.textContent = `${happiness}%`;
    }
    // â˜…â˜…â˜… æ–°å¢ï¼šæ¸²æŸ“äº²å¯†åº¦è¿›åº¦æ¡ â˜…â˜…â˜…
    if (intimacyUserFill) {
        intimacyUserFill.style.width = `${intimacyToUser}%`;
        intimacyUserFill.textContent = `${intimacyToUser}%`;
    }
    if (intimacyCharFill) {
        intimacyCharFill.style.width = `${intimacyToChar}%`;
        intimacyCharFill.textContent = `${intimacyToChar}%`;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



/**
 * åœ¨å¼¹çª—ä¸­æ›´æ–°å® ç‰©çš„é¢„è§ˆ
 */
function updatePetPreview() {
    const previewDisplay = document.getElementById('pet-preview-display');
    const nameEl = document.getElementById('pet-preview-name');
    const typeEl = document.getElementById('pet-preview-type');
    
    const imageInput = document.getElementById('pet-image-input').value.trim();

    if (imageInput.startsWith('http') || imageInput.startsWith('data:image')) {
        previewDisplay.innerHTML = `<img src="${imageInput}" style="width: 60px; height: 60px; object-fit: contain;">`;
    } else {
        previewDisplay.textContent = imageInput || 'ğŸ¥š';
    }
    
    nameEl.textContent = document.getElementById('pet-name-input').value.trim() || '(æœªå‘½å)';
    typeEl.textContent = document.getElementById('pet-type-input').value.trim() || 'ç‰©ç§';
}


/**
 * ä¿å­˜å® ç‰©è®¾ç½®
 */
async function savePetSettings() {
    const chat = state.chats[state.activeChatId];
    
    // ä»UIè¯»å–æ•°æ®
    const type = document.getElementById('pet-type-input').value.trim() || 'æ— ';
    const name = document.getElementById('pet-name-input').value.trim();
    const image = document.getElementById('pet-image-input').value.trim() || 'ğŸ¥š';
    
    const newPetSettings = {
        ...currentPetData, // ä¿ç•™å¦‚ä½ç½®ç­‰æœªåœ¨ä¸»é¢æ¿ä¿®æ”¹çš„å±æ€§
        type: type,
        name: name,
        image: image,
        persona: document.getElementById('pet-persona-input').value.trim(),
        isCustomImage: image.startsWith('http') || image.startsWith('data:image'),
        display: {
            ...currentPetData.display,
            show: document.getElementById('pet-display-toggle').checked,
            size: parseInt(document.getElementById('pet-size-slider').value)
        }
    };

    // æ›´æ–°åˆ° state å’Œæ•°æ®åº“
    chat.settings.pet = newPetSettings;
    await db.chats.put(chat);
    
    // åˆ·æ–°èŠå¤©ç•Œé¢ä¸Šçš„å® ç‰©
    renderChatPet();
    
    document.getElementById('pet-modal').classList.remove('visible');
    currentPetData = null; // æ¸…ç†ä¸´æ—¶æ•°æ®
    alert('å® ç‰©ä¿¡æ¯å·²ä¿å­˜ï¼');
}

/**
 * åœ¨èŠå¤©ç•Œé¢ä¸Šæ¸²æŸ“å® ç‰©
 */
function renderChatPet() {
    const chat = state.chats[state.activeChatId];
    const petContainer = document.getElementById('chat-pet-container');
    const petEl = document.getElementById('chat-pet');

    if (!chat || chat.isGroup || !chat.settings.petAdopted || !chat.settings.pet || !chat.settings.pet.display.show) {
        petEl.style.display = 'none';
        return;
    }

    const pet = chat.settings.pet;
    petEl.style.display = 'block';
    
    if (pet.isCustomImage) {
        petEl.innerHTML = `<img src="${pet.image}" alt="${pet.name}">`;
    } else {
        petEl.innerHTML = pet.image;
    }
    
    // åº”ç”¨æ ·å¼
    petEl.style.fontSize = `${pet.display.size}px`;
    petEl.style.width = `${pet.display.size}px`;
    petEl.style.height = `${pet.display.size}px`;
    petEl.style.top = pet.display.top;
    petEl.style.left = pet.display.left;
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handlePetInteraction å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·ä¸å® ç‰©çš„äº’åŠ¨ (V2 - å¢å¼ºäº’åŠ¨è®°å½•)
 * @param {string} action - äº’åŠ¨ç±»å‹, e.g., 'feed', 'play'
 */
async function handlePetInteraction(action) {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.petAdopted || !chat.settings.pet || chat.settings.pet.type === 'æ— ') {
        alert("ä½ è¿˜æ²¡æœ‰å® ç‰©ï¼Œæˆ–è€…è¿˜æ²¡æœ‰ç»™å®ƒè®¾å®šç§ç±»å“¦ï¼");
        return;
    }

    const pet = chat.settings.pet;
    let actionText = '';
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    switch(action) {
        case 'feed':
            pet.status.hunger = Math.min(100, pet.status.hunger + 20);
            pet.status.happiness = Math.min(100, pet.status.happiness + 5);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 10);
            actionText = `${myNickname} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
            break;
        case 'play':
            pet.status.hunger = Math.max(0, pet.status.hunger - 10);
            pet.status.happiness = Math.min(100, pet.status.happiness + 15);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 15);
            actionText = `${myNickname} é™ª ${pet.name} ç©äº†ä¸€ä¼šå„¿ã€‚`;
            break;
        case 'touch':
            pet.status.happiness = Math.min(100, pet.status.happiness + 10);
            pet.status.intimacyToUser = Math.min(100, pet.status.intimacyToUser + 5);
            actionText = `${myNickname} è½»è½»åœ°æŠšæ‘¸äº† ${pet.name}ã€‚`;
            break;
        case 'chat':
            openPetChat();
            return; 
    }
    
    updatePetStatusUI(pet);
    chat.settings.pet = pet; 

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šåˆ›å»ºå¯¹ç”¨æˆ·ã€å¯è§ã€‘çš„ç³»ç»Ÿæ¶ˆæ¯ â˜…â˜…â˜…
    const visibleMessage = {
        role: 'system',
        type: 'pat_message',
        content: `[ç³»ç»Ÿï¼š${actionText}]`,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹2ï¼šåˆ›å»ºç»™AIçœ‹çš„ã€éšè—ã€‘æŒ‡ä»¤ â˜…â˜…â˜…
    const hiddenMessageForAI = {
        role: 'system',
        content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†äº’åŠ¨ï¼š${actionText}ã€‚]`,
        timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
        isHidden: true
    };
    chat.history.push(hiddenMessageForAI);

    await db.chats.put(chat);
    
    if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        appendMessage(visibleMessage, chat);
    }
    
    document.getElementById('pet-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©å¯¹è¯åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€å® ç‰©èŠå¤©æ¨¡æ€æ¡†
 */
function openPetChat() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.pet || chat.settings.pet.type === 'æ— ') {
        alert("å…ˆç»™ä½ çš„å® ç‰©èµ·ä¸ªåå­—å’Œç§ç±»å§ï¼");
        return;
    }
    
    // å…³é—­ä¸»è®¾ç½®é¢æ¿ï¼Œæ‰“å¼€èŠå¤©é¢æ¿
    document.getElementById('pet-modal').classList.remove('visible');
    const chatModal = document.getElementById('pet-chat-modal');
    document.getElementById('pet-chat-title').textContent = `å’Œâ€œ${chat.settings.pet.name}â€çš„å¯¹è¯`;
    document.getElementById('pet-chat-input').value = '';
    
    renderPetChatHistory(); // æ¸²æŸ“å†å²è®°å½•
    chatModal.classList.add('visible');
}

/**
 * æ¸²æŸ“å® ç‰©çš„èŠå¤©è®°å½•
 */
function renderPetChatHistory() {
    const chat = state.chats[state.activeChatId];
    const pet = chat.settings.pet;
    const messagesEl = document.getElementById('pet-chat-messages');
    messagesEl.innerHTML = '';

    if (!pet.petChatHistory || pet.petChatHistory.length === 0) {
        messagesEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">è¯•ç€å’Œå®ƒæ‰“ä¸ªæ‹›å‘¼å§ï¼</p>`;
        return;
    }
    
    // è·å–ç”¨æˆ·å¤´åƒ
    const myAvatar = chat.settings.myAvatar || defaultAvatar;

    pet.petChatHistory.forEach(msg => {
        const wrapper = document.createElement('div');
        // ã€æ ¸å¿ƒã€‘è¿™é‡Œçš„ msg.sender ä¼šæ˜¯ 'user', 'pet', æˆ– 'char'
        wrapper.className = `message-wrapper ${msg.sender}`; 
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        let avatarSrc = '';
        let avatarHtml = '';

        // â–¼â–¼â–¼ é—®é¢˜å°±åœ¨ä¸‹é¢è¿™æ®µé€»è¾‘ï¼Œæˆ‘ä»¬æ¥ä¿®å¤å®ƒ â–¼â–¼â–¼
        if (msg.sender === 'user') {
            // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼Œä½¿ç”¨ç”¨æˆ·å¤´åƒ
            avatarSrc = myAvatar;
            avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
        } else if (msg.sender === 'char') {
            // ã€ã€ã€è¿™å°±æ˜¯æ–°å¢çš„ä¿®å¤é€»è¾‘ï¼ã€‘ã€‘ã€‘
            // å¦‚æœæ˜¯è§’è‰²(char)å‘çš„ï¼Œå°±ä½¿ç”¨è§’è‰²çš„å¤´åƒ
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
        } else { // å‰©ä¸‹çš„æƒ…å†µå°±æ˜¯å® ç‰©(pet)è‡ªå·±å‘çš„
            avatarSrc = pet.isCustomImage ? pet.image : null;
            if (avatarSrc) {
                // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            } else {
                // å¦‚æœæ˜¯Emojiï¼Œç›´æ¥æ˜¾ç¤ºEmoji
                avatarHtml = `<div class="avatar" style="font-size: 28px; text-align: center;">${pet.image}</div>`;
            }
        }
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        
        bubble.innerHTML = `
            ${avatarHtml}
            <div class="content">${msg.content.replace(/\n/g, '<br>')}</div>
        `;
        wrapper.appendChild(bubble);
        messagesEl.appendChild(wrapper);
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handleSendToPet å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·åœ¨å® ç‰©èŠå¤©æ¡†ä¸­å‘é€æ¶ˆæ¯
 */
async function handleSendToPet() {
    const chat = state.chats[state.activeChatId];
    const pet = chat.settings.pet;
    const input = document.getElementById('pet-chat-input');
    const userInput = input.value.trim();
    if (!userInput) return;

    input.value = '';
    input.style.height = 'auto';

    pet.petChatHistory.push({ sender: 'user', content: userInput });
    renderPetChatHistory();

    const petResponse = await getPetApiResponse(pet);
    if (petResponse) {
        pet.petChatHistory.push({ sender: 'pet', content: petResponse });
        renderPetChatHistory();
    }
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆ›å»ºå¯¹ç”¨æˆ·ã€å¯è§ã€‘çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œè®°å½•è¿™æ¬¡å¯¹è¯ â˜…â˜…â˜…
    const visibleLog = `[ç³»ç»Ÿï¼šä½ å’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†å¯¹è¯ã€‚ä½ è¯´ï¼šâ€œ${userInput}â€ï¼Œå®ƒå›åº”ï¼šâ€œ${petResponse}â€ã€‚]`;
    const visibleMessage = {
        role: 'system',
        type: 'pat_message', // ä½¿ç”¨è¿™ä¸ªç±»å‹æ¥æ˜¾ç¤ºå±…ä¸­ç°è‰²æ°”æ³¡
        content: visibleLog,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // åªæœ‰å½“ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å½“å‰èŠå¤©æ—¶ï¼Œæ‰å®æ—¶è¿½åŠ åˆ°ç•Œé¢ä¸Š
    if (document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chat.id) {
        appendMessage(visibleMessage, chat);
    }
    
    // åˆ›å»ºç»™AIçœ‹çš„ã€éšè—ã€‘æŒ‡ä»¤ï¼Œè¿™éƒ¨åˆ†ä¿æŒä¸å˜
    const hiddenMessageForAI = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†ä¸€æ¬¡å¯¹è¯ã€‚ç”¨æˆ·è¯´ï¼šâ€œ${userInput}â€ï¼Œå® ç‰©å›åº”ï¼šâ€œ${petResponse}â€ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageForAI,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ getPetApiResponse å‡½æ•° â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒã€‘ä¸ºå® ç‰©è·å–APIå›å¤
 * @param {object} pet - å® ç‰©å¯¹è±¡
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„å® ç‰©å›å¤æ–‡æœ¬
 */
async function getPetApiResponse(pet) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert("è¯·å…ˆé…ç½®APIï¼");
        return "ï¼ˆæˆ‘å¥½åƒæ–­çº¿äº†...ï¼‰";
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤2ï¼šé‡æ„å¯¹è¯å†å²çš„ç”Ÿæˆé€»è¾‘ â˜…â˜…â˜…
    const historyForPet = pet.petChatHistory.slice(-6).map(msg => {
        let senderName;
        if (msg.sender === 'user') {
            senderName = 'ä¸»äºº';
        } else if (msg.sender === 'char') {
            senderName = msg.senderName; // æ­£ç¡®è·å–Charçš„åå­—
        } else { // 'pet'
            senderName = pet.name;
        }
        return `${senderName}: ${msg.content}`;
    }).join('\n');

    const systemPrompt = `ä½ ç°åœ¨æ­£åœ¨æ‰®æ¼”ä¸€åªå® ç‰©ã€‚
# ä½ çš„æ ¸å¿ƒè®¾å®š
- ä½ çš„ç§ç±»: ${pet.type}
- ä½ çš„åå­—: ${pet.name}
- ä½ çš„æ€§æ ¼å’ŒèƒŒæ™¯æ•…äº‹: ${pet.persona}

# æ ¸å¿ƒè§„åˆ™
1. ä½ ã€å¿…é¡»ã€‘å®Œå…¨ä»£å…¥ä½ çš„è§’è‰²è®¾å®šè¿›è¡Œå›å¤ã€‚
2. ä½ çš„å›å¤åº”è¯¥æ˜¯ç®€çŸ­ã€å¯çˆ±çš„ï¼Œç¬¦åˆä¸€åªå® ç‰©çš„è¯´è¯æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ‹Ÿå£°è¯ã€ç®€å•çš„è¯æ±‡ï¼‰ã€‚
3. ä½ çš„å›å¤ã€åªèƒ½æ˜¯çº¯æ–‡æœ¬ã€‘ï¼Œä¸è¦åŒ…å«ä»»ä½•JSONæˆ–ç‰¹æ®Šæ ¼å¼ã€‚

# æœ€è¿‘çš„å¯¹è¯
${historyForPet}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä¸Šé¢çš„å¯¹è¯ï¼Œç»§ç»­ä½ çš„å›åº”ã€‚`;

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ åœ¨ç³»ç»ŸæŒ‡ä»¤ä¸­è¯»åˆ°çš„è§„åˆ™ï¼Œç«‹å³å¼€å§‹ä½ çš„è¡ŒåŠ¨ã€‚" }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);

        
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                temperature: parseFloat(state.apiConfig.temperature) || 0.8,
            })
        });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).trim();
    } catch (error) {
        console.error("è·å–å® ç‰©å›å¤å¤±è´¥:", error);
        return "ï¼ˆå‘œ...æˆ‘å¥½åƒè¯´ä¸å‡ºè¯äº†...ï¼‰";
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * åˆå§‹åŒ–å® ç‰©çš„æ‹–æ‹½åŠŸèƒ½
 */
function initPetDragging() {
    const petEl = document.getElementById('chat-pet');
    const container = document.getElementById('chat-pet-container');

    const onDragStart = (e) => {
        if (!petEl.style.display || petEl.style.display === 'none') return;
        e.preventDefault();
        isPetDragging = true;
        
        const rect = petEl.getBoundingClientRect();
        const coords = getEventCoords(e);

        petDragOffset.x = coords.x - rect.left;
        petDragOffset.y = coords.y - rect.top;

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    };

    const onDragMove = (e) => {
        if (!isPetDragging) return;
        e.preventDefault();
        
        const containerRect = container.getBoundingClientRect();
        const coords = getEventCoords(e);

        let newLeft = coords.x - petDragOffset.x - containerRect.left;
        let newTop = coords.y - petDragOffset.y - containerRect.top;

        // è¾¹ç•Œæ£€æµ‹
        newLeft = Math.max(0, Math.min(newLeft, container.clientWidth - petEl.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, container.clientHeight - petEl.offsetHeight));
        
        // ç”¨ç™¾åˆ†æ¯”å­˜å‚¨ï¼Œä»¥é€‚åº”ä¸åŒå±å¹•å°ºå¯¸
        petEl.style.left = `${(newLeft / container.clientWidth) * 100}%`;
        petEl.style.top = `${(newTop / container.clientHeight) * 100}%`;
    };

    const onDragEnd = async () => {
        if (!isPetDragging) return;
        isPetDragging = false;
        
        // æ‹–åŠ¨ç»“æŸåï¼Œä¿å­˜æ–°çš„ä½ç½®
        const chat = state.chats[state.activeChatId];
        if (chat && chat.settings.pet) {
            chat.settings.pet.display.top = petEl.style.top;
            chat.settings.pet.display.left = petEl.style.left;
            await db.chats.put(chat);
        }

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
    };

    petEl.addEventListener('mousedown', onDragStart);
    petEl.addEventListener('touchstart', onDragStart, { passive: true });
}

// â–²â–²â–² å® ç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•°ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºå¾®åšå†…å®¹ç”Ÿæˆçš„ç›®æ ‡è§’è‰²é€‰æ‹©å™¨
 * @returns {Promise<object|string|null>} - è¿”å›é€‰ä¸­çš„è§’è‰²å¯¹è±¡, 'all', æˆ– null (å¦‚æœç”¨æˆ·å–æ¶ˆ)
 */
async function showCharacterSelectorForWeibo() {
    // 1. æ‰¾å‡ºæ‰€æœ‰å•èŠè§’è‰²
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (singleChats.length === 0) {
        alert("è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²å¯ä»¥ç”Ÿæˆå†…å®¹å“¦ã€‚");
        return null;
    }

    // 2. å‡†å¤‡å¼¹çª—çš„é€‰é¡¹
    const options = [
        // æ·»åŠ ä¸€ä¸ªâ€œéšæœºâ€é€‰é¡¹ï¼Œä¿ç•™åŸæ¥çš„åŠŸèƒ½
        { text: 'âœ¨ éšæœº (æ‰€æœ‰è§’è‰²)', value: 'all' }, 
        // éå†æ‰€æœ‰è§’è‰²ï¼Œä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºä¸€ä¸ªé€‰é¡¹
        ...singleChats.map(chat => ({
            text: `ğŸ‘¤ ${chat.name}`, // é€‰é¡¹æ˜¾ç¤ºçš„åå­—
            value: chat.id         // é€‰é¡¹çš„å€¼æ˜¯è§’è‰²çš„å”¯ä¸€ID
        }))
    ];

    // 3. è°ƒç”¨ä½ ç°æœ‰çš„æ“ä½œèœå•å¼¹çª—ï¼Œå¹¶ç­‰å¾…ç”¨æˆ·é€‰æ‹©
    const selectedId = await showChoiceModal("è¯·é€‰æ‹©æœ¬æ¬¡ç”Ÿæˆçš„ä¸»è§’", options);

    // 4. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œè¿”å›ä¸åŒçš„ç»“æœ
    if (selectedId === null) {
        return null; // ç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€
    }
    if (selectedId === 'all') {
        return 'all'; // ç”¨æˆ·é€‰æ‹©äº†â€œéšæœºâ€
    }

    // å¦‚æœç”¨æˆ·é€‰æ‹©äº†æŸä¸ªè§’è‰²ï¼Œå°±è¿”å›é‚£ä¸ªè§’è‰²çš„å®Œæ•´æ•°æ®å¯¹è±¡
    return state.chats[selectedId];
}
/**
 * ã€å…¨æ–° | V2å¤šé€‰ç‰ˆã€‘æ˜¾ç¤ºå¾®åšå†…å®¹ç”Ÿæˆçš„ç›®æ ‡è§’è‰²é€‰æ‹©å™¨
 * @returns {Promise<Array|string|null>} - è¿”å›é€‰ä¸­çš„è§’è‰²IDæ•°ç»„, 'all', æˆ– null
 */
async function showMultiCharacterSelectorForWeibo() {
    return new Promise(resolve => {
        const modal = document.getElementById('weibo-char-selector-modal');
        const listEl = document.getElementById('weibo-char-selector-list');
        const confirmBtn = document.getElementById('weibo-confirm-char-select-btn');
        const cancelBtn = document.getElementById('weibo-cancel-char-select-btn');
        const selectAllBtn = document.getElementById('weibo-select-all-btn');
        const deselectAllBtn = document.getElementById('weibo-deselect-all-btn');

        listEl.innerHTML = '';
        const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

        if (singleChats.length === 0) {
            alert("è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²å¯ä»¥ç”Ÿæˆå†…å®¹å“¦ã€‚");
            resolve(null);
            return;
        }

        // æ·»åŠ ä¸€ä¸ªâ€œéšæœºâ€é€‰é¡¹
        const randomOption = document.createElement('div');
        randomOption.className = 'player-selection-item';
        randomOption.innerHTML = `
            <input type="radio" name="weibo-char-choice" value="all" id="weibo-char-random" checked style="margin-right: 15px;">
            <label for="weibo-char-random" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                <span class="name">âœ¨ éšæœºé€‰æ‹© (æ‰€æœ‰è§’è‰²)</span>
            </label>
        `;
        listEl.appendChild(randomOption);
        
        // æ·»åŠ ä¸€ä¸ªâ€œæŒ‡å®šâ€é€‰é¡¹çš„æ ‡é¢˜
        const specificOptionHeader = document.createElement('div');
        specificOptionHeader.className = 'player-selection-item';
        specificOptionHeader.innerHTML = `
            <input type="radio" name="weibo-char-choice" value="specific" id="weibo-char-specific" style="margin-right: 15px;">
            <label for="weibo-char-specific" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                <span class="name">ğŸ‘¤ æŒ‡å®šä»¥ä¸‹è§’è‰²</span>
            </label>
        `;
        listEl.appendChild(specificOptionHeader);

        // æ¸²æŸ“æ‰€æœ‰å¯é€‰çš„è§’è‰²
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'player-selection-item';
            item.style.paddingLeft = '50px'; // å‘å†…ç¼©è¿›ï¼Œè¡¨ç¤ºæ˜¯â€œæŒ‡å®šâ€çš„å­é€‰é¡¹
            item.innerHTML = `
                <input type="checkbox" class="weibo-char-checkbox" value="${chat.id}" id="weibo-char-${chat.id}">
                <label for="weibo-char-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" alt="${chat.name}">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        const cleanup = () => {
            modal.classList.remove('visible');
            // æ¸…é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            newConfirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
            selectAllBtn.removeEventListener('click', onSelectAll);
            deselectAllBtn.removeEventListener('click', onDeselectAll);
        };
        
        const onConfirm = () => {
            const choice = document.querySelector('input[name="weibo-char-choice"]:checked').value;
            if (choice === 'all') {
                cleanup();
                resolve('all');
            } else {
                const selectedIds = Array.from(document.querySelectorAll('.weibo-char-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0) {
                    alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŒ‡å®šçš„è§’è‰²ï¼");
                    return;
                }
                cleanup();
                resolve(selectedIds);
            }
        };

        const onCancel = () => { cleanup(); resolve(null); };
        const onSelectAll = () => document.querySelectorAll('.weibo-char-checkbox').forEach(cb => cb.checked = true);
        const onDeselectAll = () => document.querySelectorAll('.weibo-char-checkbox').forEach(cb => cb.checked = false);

        // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§æ¥ç¡®ä¿äº‹ä»¶åªè¢«ç»‘å®šä¸€æ¬¡
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
        selectAllBtn.addEventListener('click', onSelectAll);
        deselectAllBtn.addEventListener('click', onDeselectAll);

        modal.classList.add('visible');
    });
}
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° <script> å†…çš„åŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰æ¡†
 */
function renderOfflinePresetsSelector() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.offlineMode) return;

    const select = document.getElementById('offline-preset-select');
    const presets = chat.settings.offlineMode.presets || [];
    select.innerHTML = '<option value="">-- ä½¿ç”¨è‡ªå®šä¹‰è¾“å…¥ --</option>'; // é»˜è®¤é€‰é¡¹
    presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index; // ä½¿ç”¨æ•°ç»„ç´¢å¼•ä½œä¸ºå€¼
        option.textContent = preset.name;
        select.appendChild(option);
    });
}

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘å½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶ï¼Œè‡ªåŠ¨å¡«å……è¾“å…¥æ¡†
 */
function handleOfflinePresetSelection() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.offlineMode) return;
    
    const select = document.getElementById('offline-preset-select');
    const selectedIndex = select.value;

    if (selectedIndex !== "") {
        const preset = chat.settings.offlineMode.presets[parseInt(selectedIndex)];
        if (preset) {
            document.getElementById('offline-prompt-input').value = preset.prompt;
            document.getElementById('offline-style-input').value = preset.style;
        }
    }
}

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
 */
async function openOfflinePresetManager() {
    const select = document.getElementById('offline-preset-select');
    const selectedIndex = select.value;

    // å¼¹å‡ºä¸€ä¸ªåŒ…å«å¤šä¸ªé€‰é¡¹çš„èœå•
    const choice = await showChoiceModal("ç®¡ç†çº¿ä¸‹æ¨¡å¼é¢„è®¾", [
        { text: 'ğŸ’¾ ä¿å­˜å½“å‰ä¸ºæ–°é¢„è®¾', value: 'save_new' },
        { text: 'âœï¸ æ›´æ–°é€‰ä¸­é¢„è®¾', value: 'update_selected', disabled: selectedIndex === "" },
        { text: 'ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¢„è®¾', value: 'delete_selected', disabled: selectedIndex === "" }
    ]);
    
    // æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œæ“ä½œ
    switch (choice) {
        case 'save_new':
            await saveCurrentAsOfflinePreset();
            break;
        case 'update_selected':
            if (selectedIndex !== "") await updateSelectedOfflinePreset(parseInt(selectedIndex));
            break;
        case 'delete_selected':
            if (selectedIndex !== "") await deleteSelectedOfflinePreset(parseInt(selectedIndex));
            break;
    }
}

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘å°†å½“å‰è¾“å…¥æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°é¢„è®¾
 */
async function saveCurrentAsOfflinePreset() {
    const chat = state.chats[state.activeChatId];
    const name = await showCustomPrompt("ä¿å­˜æ–°é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°ï¼š");
    
    if (name && name.trim()) {
        const newPreset = {
            name: name.trim(),
            prompt: document.getElementById('offline-prompt-input').value.trim(),
            style: document.getElementById('offline-style-input').value.trim()
        };
        chat.settings.offlineMode.presets.push(newPreset);
        await db.chats.put(chat); // ä¿å­˜å›æ•°æ®åº“
        renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
        alert(`é¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
    }
}

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘ç”¨å½“å‰è¾“å…¥æ¡†çš„å†…å®¹æ›´æ–°é€‰ä¸­çš„é¢„è®¾
 */
async function updateSelectedOfflinePreset(index) {
    const chat = state.chats[state.activeChatId];
    const preset = chat.settings.offlineMode.presets[index];
    if (!preset) return;

    const confirmed = await showCustomConfirm("ç¡®è®¤æ›´æ–°", `ç¡®å®šè¦ç”¨å½“å‰å†…å®¹è¦†ç›–é¢„è®¾ "${preset.name}" å—ï¼Ÿ`);
    if (confirmed) {
        preset.prompt = document.getElementById('offline-prompt-input').value.trim();
        preset.style = document.getElementById('offline-style-input').value.trim();
        await db.chats.put(chat);
        alert("é¢„è®¾å·²æ›´æ–°ï¼");
    }
}

/**
 * ã€çº¿ä¸‹æ¨¡å¼ã€‘åˆ é™¤é€‰ä¸­çš„é¢„è®¾
 */
async function deleteSelectedOfflinePreset(index) {
    const chat = state.chats[state.activeChatId];
    const preset = chat.settings.offlineMode.presets[index];
    if (!preset) return;

    const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        chat.settings.offlineMode.presets.splice(index, 1);
        await db.chats.put(chat);
        renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
        // åˆ é™¤åæ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('offline-prompt-input').value = '';
        document.getElementById('offline-style-input').value = '';
        alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç§ä¿¡åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¾®åšç§ä¿¡åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»å…³æ³¨åˆ—è¡¨æ—¶ï¼Œæ‰“å¼€ç§ä¿¡ç•Œé¢
 * @param {object} targetInfo - åŒ…å«è¢«ç‚¹å‡»è§’è‰²/NPCä¿¡æ¯çš„å¯¹è±¡
 */
async function openWeiboDms(targetInfo) {
    currentViewingDmsFor = targetInfo;
    const charId = targetInfo.isNpc ? targetInfo.ownerId : targetInfo.id;
    const chat = state.chats[charId];
    if (!chat) return;

    // æ£€æŸ¥å¹¶ç”Ÿæˆç²‰ä¸ç§ä¿¡æ•°æ®
    const dmsData = await generateAndCacheFanDms(chat);
    
    // æ¸²æŸ“ç§ä¿¡åˆ—è¡¨
    renderDmList(dmsData, targetInfo.name);

    // æ˜¾ç¤ºç§ä¿¡åˆ—è¡¨å±å¹•
    showScreen('weibo-dm-list-screen');
}

/**
 * ã€AIæ ¸å¿ƒã€‘æ£€æŸ¥æˆ–ç”Ÿæˆè§’è‰²çš„ç²‰ä¸ç§ä¿¡æ•°æ®
 * @param {object} characterChat - è§’è‰²/NPCçš„ "ä¸»äºº" çš„èŠå¤©å¯¹è±¡
 * @returns {Promise<Array>} - ç²‰ä¸ç§ä¿¡å¯¹è¯æ•°ç»„
 */
async function generateAndCacheFanDms(characterChat, addMore = false) {
    // å¦‚æœä¸æ˜¯â€œç»§ç»­ç”Ÿæˆâ€ï¼Œä¸”ç¼“å­˜å·²å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›
    if (!addMore && characterChat.weiboDms && characterChat.weiboDms.length > 0) {
        console.log(`ä»ç¼“å­˜åŠ è½½ "${characterChat.name}" çš„ç²‰ä¸ç§ä¿¡ã€‚`);
        return characterChat.weiboDms;
    }

    const alertMessage = addMore ? "æ­£åœ¨ç”Ÿæˆæ›´å¤šç§ä¿¡å†…å®¹..." : `æ­£åœ¨ä¸ºâ€œ${characterChat.name}â€ç”Ÿæˆç²‰ä¸ç§ä¿¡å†…å®¹...`;
    await showCustomAlert("è¯·ç¨å€™...", alertMessage);
    
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return [];
    }

    const truncatedMainPersona = (characterChat.settings.aiPersona || 'ä¸€ä¸ªæ™®é€šçš„è§’è‰²').substring(0, 500);
    const truncatedWeiboInstruction = (characterChat.settings.weiboInstruction || 'æ— ç‰¹æ®ŠæŒ‡ä»¤').substring(0, 400);
    
    // å¦‚æœæ˜¯ç»§ç»­ç”Ÿæˆï¼ŒæŠŠç°æœ‰å¯¹è¯ä½œä¸ºä¸Šä¸‹æ–‡
    const existingDmsContext = addMore ? `
# å·²æœ‰ç§ä¿¡è®°å½• (ä¾›ä½ å‚è€ƒï¼Œä½ å¯ä»¥é€‰æ‹©å»¶ç»­å¯¹è¯æˆ–å¼€å¯æ–°å¯¹è¯):
${JSON.stringify(characterChat.weiboDms, null, 2)}
` : '';

        // ã€ä¼˜åŒ–åã€‘çš„AIæŒ‡ä»¤
        const systemPrompt = `
# ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${characterChat.name}â€çš„ç¤¾äº¤åª’ä½“è¿è¥åŠ©ç†ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®è¯¥è§’è‰²çš„ã€æ‰€æœ‰ä¿¡æ¯ã€‘ï¼Œè™šæ„ä¸€ä¸ªåŒ…å«${addMore ? '2-3' : '3-5'}ä½ä¸åŒç²‰ä¸çš„ç§ä¿¡åˆ—è¡¨ï¼Œå¹¶ä¸ºæ¯ä½ç²‰ä¸åˆ›ä½œä¸€æ®µç”ŸåŠ¨ã€çœŸå®çš„å¯¹è¯å†å²ã€‚
${existingDmsContext}

# è§’è‰²ä¿¡æ¯ (ä½ å¿…é¡»ç»¼åˆå‚è€ƒä»¥ä¸‹æ‰€æœ‰ä¿¡æ¯)
- è§’è‰²å: ${characterChat.name}
- å…¬å¼€èŒä¸š: ${characterChat.settings.weiboProfession || 'æœªè®¾å®š'}
- æ ¸å¿ƒäººè®¾ (æœ€é«˜ä¼˜å…ˆçº§): ${truncatedMainPersona}
- å¾®åšäº’åŠ¨å‡†åˆ™ (å¤„ç†ç§ä¿¡æ—¶éœ€éµå®ˆ): ${truncatedWeiboInstruction}

# æ ¸å¿ƒè§„åˆ™
1.  **ç²‰ä¸å¤šæ ·æ€§**: åˆ›ä½œ${addMore ? '2-3' : '3-5'}ä½ä¸åŒç±»å‹çš„ç²‰ä¸ï¼ˆä¾‹å¦‚ï¼šç‹‚çƒ­ç²‰ã€äº‹ä¸šç²‰ã€CPç²‰ã€é»‘ç²‰ã€è·¯äººç²‰ã€å¹¿å‘Šå•†ç­‰ï¼‰ã€‚
2.  **ã€ã€ã€å¯¹è¯é²œæ´»åº¦é“å¾‹ã€‘ã€‘ã€‘**: ä¸ºäº†è®©å¯¹è¯æ›´çœŸå®ï¼Œä½ å¿…é¡»ï¼š
    -   **é¿å…æœºæ¢°é—®ç­”**ï¼šä¸è¦ç”Ÿæˆâ€œä½ å¥½â€-â€œä½ å¥½â€ä¹‹ç±»çš„æ— æ„ä¹‰å¯¹è¯ã€‚è®©å¯¹è¯åƒä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„çœŸå®äº’åŠ¨ç‰‡æ®µã€‚
    -   **æ³¨å…¥æƒ…ç»ªå’Œè¯­æ°”**ï¼šç²‰ä¸çš„è¯­æ°”å¯ä»¥æ˜¯å…´å¥‹çš„ã€æ‹…å¿§çš„ã€è´¨ç–‘çš„ã€å¼€ç©ç¬‘çš„ã€‚è§’è‰²çš„å›åº”ä¹Ÿè¦ç¬¦åˆäººè®¾ï¼Œå¯èƒ½æ˜¯å†·æ·¡çš„ã€æ¸©æŸ”çš„ã€å®˜æ–¹çš„ï¼Œæˆ–è€…å¹²è„†å·²è¯»ä¸å›ã€‚
    -   **ä½¿ç”¨ç½‘ç»œè¯­è¨€**: é€‚å½“åŠ å…¥ç¬¦åˆç²‰ä¸åœˆæ–‡åŒ–çš„ç½‘ç»œç”¨è¯­ã€emojiæˆ–é¢œæ–‡å­—ï¼Œè®©å¯¹è¯æ›´æ¥åœ°æ°”ã€‚
    -   **å†…å®¹å¤šæ ·åŒ–**: ç§ä¿¡å†…å®¹ä¸åº”åªå±€é™äºå·¥ä½œï¼Œä¹Ÿå¯ä»¥æ˜¯ç²‰ä¸åˆ†äº«è‡ªå·±çš„æ—¥å¸¸ã€è¡¨è¾¾å…³å¿ƒã€æå‡ºä¸€äº›ç§äººé—®é¢˜ç­‰ã€‚
3.  **è§’è‰²å›åº”**: æ ¹æ®è§’è‰²çš„ã€å¾®åšäº’åŠ¨å‡†åˆ™ã€‘å’Œã€æ ¸å¿ƒäººè®¾ã€‘ï¼Œå†³å®šè§’è‰²æ˜¯å¦ä¼šå›å¤ç§ä¿¡ä»¥åŠå¦‚ä½•å›å¤ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé«˜å†·çš„è§’è‰²å¯èƒ½åªä¼šå›å¤é‡è¦ä¿¡æ¯ï¼Œæˆ–è€…å¹²è„†ä¸å›å¤ã€‚
4.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥ '[' å¼€å¤´ï¼Œä»¥ ']' ç»“å°¾ã€‚

# JSONå¯¹è±¡ç»“æ„ (æ³¨æ„ï¼šä½ ä¸å†éœ€è¦æä¾›å¤´åƒURL)
{
  "fanName": "ç²‰ä¸çš„å¾®åšæ˜µç§°",
  "fanPersona": "å¯¹è¿™ä½ç²‰ä¸çš„ç®€å•æè¿° (ä¾‹å¦‚: 'ä¸€ä¸ªæ‹…å¿ƒå“¥å“¥äº‹ä¸šçš„å¦ˆå¦ˆç²‰')",
  "messages": [
    { "sender": "fan", "text": "ç²‰ä¸å‘çš„ç¬¬ä¸€æ¡æ¶ˆæ¯..." },
    { "sender": "char", "text": "è§’è‰²å›å¤çš„æ¶ˆæ¯..." }
  ]
}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆç§ä¿¡åˆ—è¡¨ã€‚`;


    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);

        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });
        
        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`);
        }
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newDmsData = JSON.parse(cleanedContent);
        // ã€å·²ä¿®å¤ã€‘åœ¨è¿™é‡Œä¸ºAIç”Ÿæˆçš„æ•°æ®æ‰‹åŠ¨æ·»åŠ éšæœºå¤´åƒ
        if (Array.isArray(newDmsData)) {
            // è¿™æ˜¯ä½ æä¾›çš„ä¸¤ä¸ªå¤´åƒURL
            const fanAvatars = [
                'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg',
                'https://i.postimg.cc/Qd0Y537F/com-xingin-xhs-20251011153800.png'
            ];

            // éå†AIç”Ÿæˆçš„æ¯ä¸€æ®µå¯¹è¯ï¼Œè¿™æ¬¡æˆ‘ä»¬åŠ å…¥äº† index å‚æ•°
            newDmsData.forEach((convo, index) => {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨ç´¢å¼•å’Œå–ä½™è¿ç®—ç¬¦(%)æ¥äº¤æ›¿åˆ†é…å¤´åƒ
                convo.fanAvatarUrl = fanAvatars[index % fanAvatars.length];
            });
        }


        if (Array.isArray(newDmsData)) {
            if (addMore) {
                // åˆå¹¶æ–°æ—§æ•°æ®
                characterChat.weiboDms.push(...newDmsData);
            } else {
                characterChat.weiboDms = newDmsData;
            }
            await db.chats.put(characterChat);
            return characterChat.weiboDms;
        }
        throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„ã€‚");
    } catch (error) {
        console.error("ç”Ÿæˆç²‰ä¸ç§ä¿¡å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `æŠ±æ­‰ï¼Œç”Ÿæˆç§ä¿¡æ—¶å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ã€‚\n\nè¯¦ç»†ä¿¡æ¯:\n${error.message}`);
        return characterChat.weiboDms || []; // å¤±è´¥æ—¶è¿”å›æ—§æ•°æ®æˆ–ç©ºæ•°ç»„
    }
}

/**
 * æ¸²æŸ“ç²‰ä¸ç§ä¿¡åˆ—è¡¨
 * @param {Array} dmsData - ç§ä¿¡å¯¹è¯æ•°ç»„
 * @param {string} charName - è§’è‰²å
 */
function renderDmList(dmsData, charName) {
    const listEl = document.getElementById('weibo-dm-list');
    const titleEl = document.getElementById('weibo-dm-list-title');
    listEl.innerHTML = '';
    titleEl.textContent = `${charName}çš„ç§ä¿¡`;

    if (!dmsData || dmsData.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•ç§ä¿¡å“¦</p>';
        return;
    }

    dmsData.forEach((convo, index) => {
        const lastMsg = convo.messages[convo.messages.length - 1];
        const item = document.createElement('div');
        item.className = 'dm-list-item';
        item.dataset.fanIndex = index; // ç”¨ç´¢å¼•æ¥æ ‡è¯†
        item.innerHTML = `
            <img src="${convo.fanAvatarUrl}" class="dm-avatar">
            <div class="dm-info">
                <div class="dm-name">${convo.fanName}</div>
                <div class="dm-last-msg">${lastMsg.text}</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ‰“å¼€ç§ä¿¡è¯¦æƒ…é¡µ
 * @param {number} fanIndex - ç²‰ä¸åœ¨ç§ä¿¡æ•°ç»„ä¸­çš„ç´¢å¼•
 */
function openDmDetail(fanIndex) {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    const conversation = chat.weiboDms[fanIndex];
    
    if (conversation) {
        renderDmDetail(conversation, chat);
        showScreen('weibo-dm-detail-screen');
    }
}

/**
 * æ¸²æŸ“ç§ä¿¡è¯¦æƒ…é¡µçš„èŠå¤©æ°”æ³¡
 * @param {object} conversation - å•ä¸ªç²‰ä¸çš„å¯¹è¯å¯¹è±¡
 * @param {object} characterChat - è§’è‰²çš„èŠå¤©å¯¹è±¡
 */
function renderDmDetail(conversation, characterChat) {
    const messagesEl = document.getElementById('weibo-dm-messages');
    const titleEl = document.getElementById('weibo-dm-detail-title');
    messagesEl.innerHTML = '';
    titleEl.textContent = conversation.fanName;
    
    const charAvatar = characterChat.settings.aiAvatar || defaultAvatar;

    conversation.messages.forEach((msg, index) => {
        const isFan = msg.sender === 'fan';
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${isFan ? 'fan' : 'char'}`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble`;

        const avatarHtml = `<img src="${isFan ? conversation.fanAvatarUrl : charAvatar}" class="avatar">`;
        const contentHtml = `<div class="content">${msg.text.replace(/\n/g, '<br>')}</div>`;
        
        // â˜…â˜…â˜… åªæœ‰ç²‰ä¸çš„æ¶ˆæ¯æ‰æ·»åŠ åˆ é™¤æŒ‰é’® â˜…â˜…â˜…
        const deleteBtnHtml = isFan 
            ? `<button class="dm-message-delete-btn" data-message-index="${index}">Ã—</button>` 
            : '';

        bubble.innerHTML = `${avatarHtml}${contentHtml}`;
        // å°†åˆ é™¤æŒ‰é’®æ·»åŠ åˆ°wrapperï¼Œè€Œä¸æ˜¯bubbleå†…éƒ¨ï¼Œä»¥æ–¹ä¾¿å®šä½
        wrapper.innerHTML = deleteBtnHtml; 
        wrapper.appendChild(bubble);

        messagesEl.appendChild(wrapper);
    });
    
    messagesEl.scrollTop = messagesEl.scrollHeight;
}
/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºå½“å‰è§’è‰²çš„æ‰€æœ‰ç²‰ä¸ç§ä¿¡
 */
async function handleClearAllDms() {
    if (!currentViewingDmsFor) return;

    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat || !chat.weiboDms || chat.weiboDms.length === 0) {
        alert("æ²¡æœ‰å¯ä»¥æ¸…ç©ºçš„ç§ä¿¡ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç©º',
        `ç¡®å®šè¦æ¸…ç©ºâ€œ${currentViewingDmsFor.name}â€æ”¶åˆ°çš„æ‰€æœ‰ç²‰ä¸ç§ä¿¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.weiboDms = []; // æ¸…ç©ºæ•°ç»„
        await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
        renderDmList(chat.weiboDms, currentViewingDmsFor.name); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        alert('æ‰€æœ‰ç§ä¿¡å·²æ¸…ç©ºã€‚');
    }
}

/**
 * â˜…â˜…â˜… å¤„ç†åˆ é™¤å•æ¡ç§ä¿¡çš„é€»è¾‘ â˜…â˜…â˜…
 * @param {number} fanIndex - ç²‰ä¸å¯¹è¯çš„ç´¢å¼•
 * @param {number} messageIndex - è¦åˆ é™¤çš„æ¶ˆæ¯çš„ç´¢å¼•
 */
async function handleDeleteWeiboDm(fanIndex, messageIndex) {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat || !chat.weiboDms[fanIndex]) return;

    const conversation = chat.weiboDms[fanIndex];
    const messageText = conversation.messages[messageIndex].text.substring(0, 30);
    
    const confirmed = await showCustomConfirm(
        'åˆ é™¤ç§ä¿¡',
        `ç¡®å®šè¦åˆ é™¤è¿™æ¡ç§ä¿¡å—ï¼Ÿ\n\nâ€œ${messageText}...â€`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // ä»æ¶ˆæ¯æ•°ç»„ä¸­ç§»é™¤
        conversation.messages.splice(messageIndex, 1);
        
        // å¦‚æœä¸€ä¸ªå¯¹è¯çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«åˆ é™¤äº†ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦åˆ é™¤æ•´ä¸ªå¯¹è¯
        if (conversation.messages.length === 0) {
            chat.weiboDms.splice(fanIndex, 1);
            await db.chats.put(chat);
            // è¿”å›ç§ä¿¡åˆ—è¡¨
            renderDmList(chat.weiboDms, currentViewingDmsFor.name);
            showScreen('weibo-dm-list-screen');
        } else {
            await db.chats.put(chat);
            // é‡æ–°æ¸²æŸ“å½“å‰å¯¹è¯
            renderDmDetail(conversation, chat);
        }
        alert('ç§ä¿¡å·²åˆ é™¤ã€‚');
    }
}

/**
 * â˜…â˜…â˜… å¤„ç†ç‚¹å‡»â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’®çš„é€»è¾‘ â˜…â˜…â˜…
 */
async function handleGenerateMoreDms() {
    const charId = currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id;
    const chat = state.chats[charId];
    if (!chat) return;

    // è°ƒç”¨æ ¸å¿ƒAIå‡½æ•°ï¼Œå¹¶ä¼ å…¥ addMore=true å‚æ•°
    const newDmsData = await generateAndCacheFanDms(chat, true);
    
    // æ¸²æŸ“æ›´æ–°åçš„ç§ä¿¡åˆ—è¡¨
    renderDmList(newDmsData, currentViewingDmsFor.name);
}

// â–²â–²â–² æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™ä¸€æ•´å—èŠå¤©æ€»ç»“åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨å˜é‡åŒºï¼Œç²˜è´´ä¸‹é¢è¿™2å—ä»£ç  â–¼â–¼â–¼

// å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ç‰©æµæ›´æ–°è®¡æ—¶å™¨ï¼Œæ–¹ä¾¿åœ¨ç¦»å¼€é¡µé¢æ—¶æ¸…é™¤
let logisticsUpdateTimers = [];

// ç‰©æµæ—¶é—´çº¿æ¨¡æ¿ (delayå•ä½æ˜¯æ¯«ç§’)
// ä½ å¯ä»¥éšæ„ä¿®æ”¹è¿™é‡Œçš„æ–‡æœ¬å’Œå»¶è¿Ÿæ—¶é—´ï¼Œæ‰“é€ ä½ è‡ªå·±çš„ç‰©æµæ•…äº‹ï¼
const logisticsTimelineTemplate = [
    { text: 'æ‚¨çš„è®¢å•å·²æäº¤', delay: 1000 * 2 }, // 2ç§’
    { text: 'ä»˜æ¬¾æˆåŠŸï¼Œç­‰å¾…å•†å®¶æ‰“åŒ…', delay: 1000 * 10 }, // 10ç§’å
    { text: 'ã€{city}ä»“åº“ã€‘å·²æ‰“åŒ…ï¼Œç­‰å¾…å¿«é€’æ½æ”¶', delay: 1000 * 60 * 5 }, // 5åˆ†é’Ÿå
    { text: 'ã€{city}å¿«é€’ã€‘å·²æ½æ”¶', delay: 1000 * 60 * 20 }, // 20åˆ†é’Ÿå
    { text: 'å¿«ä»¶å·²åˆ°è¾¾ã€{city}åˆ†æ‹¨ä¸­å¿ƒã€‘', delay: 1000 * 60 * 60 * 2 }, // 2å°æ—¶å
    { text: 'ã€{city}åˆ†æ‹¨ä¸­å¿ƒã€‘å·²å‘å‡ºï¼Œä¸‹ä¸€ç«™ã€{next_city}ã€‘', delay: 1000 * 60 * 60 * 8 }, // 8å°æ—¶å
    { text: 'å¿«ä»¶å·²åˆ°è¾¾ã€{user_city}è½¬è¿ä¸­å¿ƒã€‘', delay: 1000 * 60 * 60 * 20 }, // 20å°æ—¶å
    { text: 'å¿«ä»¶æ­£åœ¨æ´¾é€ä¸­ï¼Œæ´¾é€å‘˜ï¼šå…”å…”å¿«é€’å‘˜ï¼Œç”µè¯ï¼š123-4567-8910ï¼Œè¯·ä¿æŒç”µè¯ç•…é€š', delay: 1000 * 60 * 60 * 24 }, // 24å°æ—¶å
    { text: 'æ‚¨çš„å¿«ä»¶å·²ç­¾æ”¶ï¼Œæ„Ÿè°¢æ‚¨åœ¨æ¡ƒå®è´­ç‰©ï¼ŒæœŸå¾…å†æ¬¡ä¸ºæ‚¨æœåŠ¡ï¼', delay: 1000 * 60 * 60 * 28 }, // 28å°æ—¶å
];

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

let isSummarizing = false; // å…¨å±€é”ï¼Œé˜²æ­¢é‡å¤è§¦å‘æ€»ç»“

// â–¼â–¼â–¼ ã€V2 - æµç¨‹åˆ†ç¦»ç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ checkAndTriggerSummary å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ V2ã€‘æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ€»ç»“æˆ–æé†’
 * @param {string} chatId - å½“å‰èŠå¤©çš„ID
 */
async function checkAndTriggerSummary(chatId) {
    if (isSummarizing) return; 

    const chat = state.chats[chatId];
    if (!chat || !chat.settings.summary || !chat.settings.summary.enabled) return;

    const summarySettings = chat.settings.summary;
    // æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘ä»¬ä¸å†ä»0å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸Šæ¬¡æ€»ç»“çš„ä½ç½®å¼€å§‹è®¡ç®—
    const lastSummaryIndex = summarySettings.lastSummaryIndex;
    const messagesSinceLastSummary = chat.history.slice(lastSummaryIndex + 1);

    if (messagesSinceLastSummary.length >= summarySettings.count) {
        isSummarizing = true; 
        if (summarySettings.mode === 'auto') {
            await performAutomaticSummary(chatId);
        } else {
            // å¯¹äºæ‰‹åŠ¨æ¨¡å¼ï¼Œç°åœ¨åªå¼¹æé†’
            await notifyForManualSummary(chatId);
        }
        isSummarizing = false;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V2 - èŒƒå›´ç²¾ç¡®ç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ performAutomaticSummary å‡½æ•° â–¼â–¼â–¼
/**
 * è‡ªåŠ¨åœ¨åå°æ‰§è¡Œæ€»ç»“ï¼Œåªæ€»ç»“è§¦å‘æ¡ä»¶çš„Næ¡æ¶ˆæ¯
 */
async function performAutomaticSummary(chatId) {
    console.log(`è‡ªåŠ¨æ€»ç»“è§¦å‘ for chat: ${chatId}`);
    const chat = state.chats[chatId];
    const summarySettings = chat.settings.summary;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç²¾ç¡®æˆªå–æœ€åNæ¡æ¶ˆæ¯ä½œä¸ºæ€»ç»“èŒƒå›´
    const messagesToSummarize = chat.history.slice(-summarySettings.count);
    
    try {
        const summaryText = await generateSummary(chatId, messagesToSummarize);
        if (summaryText) {
            await saveSummaryAsMemory(chatId, summaryText);
        }
    } catch (e) {
        // generateSummary å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯å¼¹çª—ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦è®°å½•æ—¥å¿—å³å¯
        console.error("è‡ªåŠ¨æ€»ç»“è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„é”™è¯¯:", e);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€V2 - ä»…æé†’ç‰ˆã€‘ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ promptForManualSummary å‡½æ•° â–¼â–¼â–¼
/**
 * å¼¹å‡ºæç¤ºæ¡†ï¼Œã€æé†’ã€‘ç”¨æˆ·å¯ä»¥è¿›è¡Œæ‰‹åŠ¨æ€»ç»“äº†
 */
async function notifyForManualSummary(chatId) {
    console.log(`æ‰‹åŠ¨æ€»ç»“æé†’è§¦å‘ for chat: ${chatId}`);
    
    // åªå¼¹å‡ºä¸€ä¸ªç®€å•çš„é€šçŸ¥
    await showCustomAlert(
        'æ€»ç»“æé†’',
        'å¯¹è¯å·²è¾¾åˆ°è®¾å®šé•¿åº¦ï¼Œä½ å¯ä»¥éšæ—¶åœ¨â€œèŠå¤©è®¾ç½®â€ä¸­ç‚¹å‡»â€œç«‹å³æ‰‹åŠ¨æ€»ç»“â€æ¥ç”Ÿæˆå¯¹è¯è®°å¿†ã€‚'
    );

    // ã€é‡è¦ã€‘æé†’è¿‡åï¼Œæ›´æ–°â€œä¸Šæ¬¡æ€»ç»“ä½ç½®â€ï¼Œä»¥é˜²æ­¢æ¯æ¡æ–°æ¶ˆæ¯éƒ½å¼¹çª—ã€‚
    // è¿™æ„å‘³ç€è®¡æ—¶å™¨ä¼šä»ç°åœ¨é‡æ–°å¼€å§‹è®¡ç®—ã€‚
    const chat = state.chats[chatId];
    chat.settings.summary.lastSummaryIndex = chat.history.length - 1;
    await db.chats.put(chat);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€V2 - æ—¶é—´æˆ³å¢å¼ºç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ generateSummary å‡½æ•° â–¼â–¼â–¼
/**
 * ã€AIæ ¸å¿ƒ V2 - æ—¶é—´æˆ³å¢å¼ºç‰ˆã€‘è°ƒç”¨APIç”Ÿæˆæ€»ç»“å†…å®¹
 * @param {string} chatId - èŠå¤©çš„ID
 * @param {Array | null} specificMessages - å¦‚æœæä¾›ï¼Œåˆ™åªæ€»ç»“è¿™ä¸ªæ•°ç»„é‡Œçš„æ¶ˆæ¯ï¼›å¦‚æœä¸ºnullï¼Œåˆ™æ€»ç»“è‡ªä¸Šæ¬¡ä»¥æ¥çš„æ‰€æœ‰æ¶ˆæ¯ã€‚
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„æ€»ç»“æ–‡æœ¬
 */
async function generateSummary(chatId, specificMessages = null) {
    const chat = state.chats[chatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ã€‚');
    }

    const summarySettings = chat.settings.summary;
    let messagesToSummarize;

    if (specificMessages && specificMessages.length > 0) {
        messagesToSummarize = specificMessages;
    } else {
        const lastSummaryIndex = summarySettings.lastSummaryIndex > -1 ? summarySettings.lastSummaryIndex : 0;
        messagesToSummarize = chat.history.slice(lastSummaryIndex + 1);
    }
    
    const filteredMessagesForSummary = messagesToSummarize.filter(msg => msg.type !== 'summary');

    if (filteredMessagesForSummary.length === 0) {
        if (!specificMessages) {
             await showCustomAlert("æ— éœ€æ€»ç»“", "è‡ªä¸Šæ¬¡æ€»ç»“ä»¥æ¥æ²¡æœ‰æ–°çš„å¯¹è¯å†…å®¹ã€‚");
        }
        return null;
    }

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨æ„å»ºå¯¹è¯æ–‡æœ¬æ—¶ï¼ŒåŠ å…¥æ—¶é—´æˆ³ï¼ â˜…â˜…â˜… ---
    const conversationText = filteredMessagesForSummary.map(msg => {
        const sender = msg.role === 'user' ? (chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘') : (msg.senderName || chat.name);
        let content = '';
        if (typeof msg.content === 'string') {
            content = msg.content;
        } else if (Array.isArray(msg.content)) {
            content = '[å›¾ç‰‡]';
        } else if (msg.type) {
            content = `[${msg.type}]`;
        }
        // å°†æ¯«ç§’æ—¶é—´æˆ³è½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
        const readableTime = new Date(msg.timestamp).toLocaleString('zh-CN', { hour12: false });
        return `[${readableTime}] ${sender}: ${content}`;
    }).join('\n');

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹2ï¼šæ›´æ–°ç³»ç»ŸæŒ‡ä»¤ï¼Œè¦æ±‚AIä½¿ç”¨æ—¶é—´æˆ³ï¼ â˜…â˜…â˜… ---
    const systemPrompt = summarySettings.prompt + `\n\né‡è¦æç¤ºï¼šæ¯æ¡æ¶ˆæ¯å¼€å¤´éƒ½æœ‰ä¸€ä¸ª [æ—¶é—´] æ ‡è®°ã€‚ä½ åœ¨æ€»ç»“æ—¶ï¼Œã€å¿…é¡»ã€‘å‚è€ƒè¿™äº›æ—¶é—´ï¼Œåœ¨æ€»ç»“å…³é”®äº‹ä»¶æ—¶é™„ä¸Šå¯¹åº”çš„æ—¶é—´èŒƒå›´æˆ–å…·ä½“æ—¶é—´ç‚¹ï¼Œè®©æ€»ç»“åŒ…å«æ—¶é—´çº¿ç´¢ã€‚\n\n--- å¯¹è¯å¼€å§‹ ---\n${conversationText}\n--- å¯¹è¯ç»“æŸ ---`;
    
    try {
        if (!specificMessages) {
             await showCustomAlert("æ­£åœ¨ç”Ÿæˆ...", "AIæ­£åœ¨åŠªåŠ›æ€»ç»“ä½ ä»¬çš„å¯¹è¯ï¼Œè¯·ç¨å€™...");
        }
        
        const isGemini = proxyUrl === GEMINI_API_URL;
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        const geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.3,
                })
            });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        const aiContent = isGemini 
            ? data?.candidates?.[0]?.content?.parts?.[0]?.text 
            : data?.choices?.[0]?.message?.content;

        if (!aiContent) {
            throw new Error("AIè¿”å›äº†ç©ºå†…å®¹ã€‚");
        }
        
        return aiContent;

    } catch (error) {
        console.error("ç”Ÿæˆæ€»ç»“å¤±è´¥:", error);
        await showCustomAlert('æ€»ç»“å¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
        return null;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å°†ç”Ÿæˆçš„æ€»ç»“ä½œä¸ºä¸€æ¡ç‰¹æ®Šçš„è®°å¿†æ¶ˆæ¯ä¿å­˜èµ·æ¥
 */
async function saveSummaryAsMemory(chatId, summaryText) {
    const chat = state.chats[chatId];
    
    // è®°å½•ä¸‹æ€»ç»“æ“ä½œå‘ç”Ÿæ—¶çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„ç´¢å¼•
    const newLastSummaryIndex = chat.history.length - 1;

    const summaryMessage = {
        role: 'system',
        type: 'summary', // ç‰¹æ®Šç±»å‹
        content: summaryText,
        timestamp: Date.now(),
        isHidden: true // è¿™æ¡æ¶ˆæ¯å¯¹AIå¯è§ï¼Œä½†å¯¹ç”¨æˆ·éšè—
    };

    chat.history.push(summaryMessage);
    chat.settings.summary.lastSummaryIndex = newLastSummaryIndex; // æ›´æ–°ç´¢å¼•
    
    await db.chats.put(chat);
    console.log(`æ–°çš„æ€»ç»“å·²ä½œä¸ºè®°å¿†ä¿å­˜ for chat: ${chatId}`);
}

// --- ä»¥ä¸‹æ˜¯æ€»ç»“ç®¡ç†ç•Œé¢çš„å‡½æ•° ---

let editingSummaryTimestamp = null;

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V2 - ç¾åŒ–ç‰ˆã€‘ä»£ç æ›¿æ¢æ—§çš„ openSummaryViewer å‡½æ•° â–¼â–¼â–¼
async function openSummaryViewer() {
    const chat = state.chats[state.activeChatId];
    document.getElementById('summary-viewer-title').textContent = `â€œ${chat.name}â€çš„å¯¹è¯è®°å¿†`;
    
    const listEl = document.getElementById('summary-list');
    listEl.innerHTML = '';
    
    const summaries = chat.history.filter(msg => msg.type === 'summary');

    if (summaries.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡ä»»ä½•æ€»ç»“ã€‚</p>';
    } else {
        [...summaries].reverse().forEach(summary => {
            const card = document.createElement('div');
            card.className = 'summary-item-card';
            
            // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè®©ç”Ÿæˆæ—¶é—´æ˜¾ç¤ºå¾—æ›´ç®€çŸ­å¥½çœ‹ï¼ â˜…â˜…â˜… ---
            card.innerHTML = `
                <div class="summary-actions">
                    <button class="concise-summary-btn" data-timestamp="${summary.timestamp}" title="ç²¾ç®€æ€»ç»“">âœ¨</button>
                    <button class="edit-summary-btn" data-timestamp="${summary.timestamp}" title="ç¼–è¾‘">âœï¸</button>
                    <button class="delete-summary-btn" data-timestamp="${summary.timestamp}" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div>
                <div class="summary-content">${summary.content.replace(/\n/g, '<br>')}</div>
                <div class="summary-meta">
                    <span>ç”Ÿæˆäº: ${new Date(summary.timestamp).toLocaleString('zh-CN', { dateStyle: 'short', timeStyle: 'short'})}</span>
                </div>
            `;
            listEl.appendChild(card);
        });
    }
    
    document.getElementById('chat-settings-modal').classList.remove('visible');
    document.getElementById('summary-viewer-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ç¼–è¾‘ä¸€æ¡æ€»ç»“
 */
async function editSummary(timestamp) {
    const chat = state.chats[state.activeChatId];
    const summary = chat.history.find(msg => msg.timestamp === timestamp);
    if (!summary) return;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘æ€»ç»“',
        'ä¿®æ”¹æ€»ç»“å†…å®¹:',
        summary.content,
        'textarea'
    );

    if (newContent !== null) {
        summary.content = newContent.trim();
        await db.chats.put(chat);
        openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    }
}

/**
 * ã€å·²ä¿®å¤ã€‘åˆ é™¤ä¸€æ¡æ€»ç»“ï¼Œå¹¶æ™ºèƒ½æ›´æ–°æ€»ç»“ç´¢å¼•
 */
async function deleteSummary(timestamp) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ€»ç»“è®°å¿†å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“AIçš„é•¿æœŸè®°å¿†ã€‚', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. ä»å†å²è®°å½•ä¸­è¿‡æ»¤æ‰è¢«åˆ é™¤çš„æ€»ç»“
        chat.history = chat.history.filter(msg => msg.timestamp !== timestamp);

        // 2. --- æ ¸å¿ƒä¿®å¤ï¼šé‡æ–°è®¡ç®— lastSummaryIndex ---
        // æ‰¾åˆ°å‰©ä¸‹çš„æ€»ç»“ä¸­ï¼Œæœ€æ–°çš„é‚£ä¸€æ¡
        const lastRemainingSummary = chat.history.filter(m => m.type === 'summary').pop();
        
        let newLastSummaryIndex;

        if (lastRemainingSummary) {
            // 3. å¦‚æœè¿˜æœ‰å…¶ä»–æ€»ç»“ï¼Œå°±æ‰¾åˆ°å®ƒåœ¨å†å²è®°å½•ä¸­çš„ä½ç½®
            const lastSummaryMessageIndexInHistory = chat.history.findIndex(m => m.timestamp === lastRemainingSummary.timestamp);
            // 4. æ–°çš„ç´¢å¼•å°±æ˜¯å®ƒå‰é¢é‚£æ¡æ™®é€šæ¶ˆæ¯çš„ç´¢å¼•
            newLastSummaryIndex = lastSummaryMessageIndexInHistory > 0 ? (lastSummaryMessageIndexInHistory - 1) : -1;
        } else {
            // 5. å¦‚æœä¸€æ¡æ€»ç»“éƒ½ä¸å‰©äº†ï¼Œå°±å½»åº•é‡ç½®ç´¢å¼•
            newLastSummaryIndex = -1;
        }
        
        // 6. æ›´æ–°è®¾ç½®
        if (chat.settings.summary) {
            chat.settings.summary.lastSummaryIndex = newLastSummaryIndex;
        }

        // ä¿å­˜æ›´æ”¹å¹¶åˆ·æ–°UI
        await db.chats.put(chat);
        openSummaryViewer();
        await showCustomAlert('æ“ä½œæˆåŠŸ', 'æ€»ç»“å·²åˆ é™¤ï¼');
    }
}

// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSä»£ç ä¸­ â–¼â–¼â–¼

/**
 * ã€AIæ ¸å¿ƒã€‘è°ƒç”¨APIå°†æŒ‡å®šæ–‡æœ¬ç²¾ç®€ä¸ºæ‘˜è¦
 * @param {string} originalText - åŸå§‹çš„ã€è¾ƒé•¿çš„æ€»ç»“æ–‡æœ¬
 * @returns {Promise<string|null>} - AIç”Ÿæˆçš„ç²¾ç®€æ‘˜è¦ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›null
 */
async function generateConciseSummary(originalText) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆç²¾ç®€æ‘˜è¦ã€‚');
    }

    // æ ¸å¿ƒPromptï¼šæŒ‡ç¤ºAIå°†å†…å®¹ç²¾ç®€ä¸ºä¸€å¥è¯
    const systemPrompt = `è¯·ä½ å°†ä»¥ä¸‹å†…å®¹ç²¾ç®€ä¸ºä¸€å¥è¯çš„æ ¸å¿ƒæ‘˜è¦ï¼Œä¿ç•™æœ€å…³é”®çš„äººç‰©ã€äº‹ä»¶å’Œç»“è®ºï¼Œå­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…ï¼š\n\n--- å†…å®¹å¼€å§‹ ---\n${originalText}\n--- å†…å®¹ç»“æŸ ---`;

    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: systemPrompt }],
                temperature: parseFloat(state.apiConfig.temperature) || 0.5,
            })
        });

        if (!response.ok) throw new Error(await response.text());
        const data = await response.json();
        return data.choices[0].message.content;

    } catch (error) {
        console.error("ç”Ÿæˆç²¾ç®€æ‘˜è¦å¤±è´¥:", error);
        await showCustomAlert('ç²¾ç®€å¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
        return null;
    }
}

/**
 * å¤„ç†å•æ¡æ€»ç»“çš„ç²¾ç®€
 * @param {number} timestamp - è¦ç²¾ç®€çš„æ€»ç»“æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function handleConciseSummary(timestamp) {
    const chat = state.chats[state.activeChatId];
    const summary = chat.history.find(msg => msg.timestamp === timestamp);
    if (!summary) return;

    await showCustomAlert("è¯·ç¨å€™...", "AIæ­£åœ¨åŠªåŠ›ä¸ºæ‚¨ç²¾ç®€å†…å®¹...");

    const conciseText = await generateConciseSummary(summary.content);

    if (conciseText) {
        summary.content = conciseText.trim(); // ç”¨ç²¾ç®€åçš„æ–‡æœ¬æ›¿æ¢åŸæ–‡
        await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
        await openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        await showCustomAlert('æˆåŠŸ', 'æœ¬æ¡æ€»ç»“å·²ç²¾ç®€ï¼');
    }
}

/**
 * å¤„ç†å…¨éƒ¨æ€»ç»“çš„ç²¾ç®€
 */
async function handleConciseAllSummaries() {
    const chat = state.chats[state.activeChatId];
    const summaries = chat.history.filter(msg => msg.type === 'summary');

    if (summaries.length === 0) {
        alert("æ²¡æœ‰å¯ä»¥ç²¾ç®€çš„æ€»ç»“ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤å…¨éƒ¨ç²¾ç®€',
        `ç¡®å®šè¦ç²¾ç®€å…¨éƒ¨ ${summaries.length} æ¡æ€»ç»“å—ï¼Ÿæ­¤æ“ä½œä¼šè¦†ç›–åŸå§‹å†…å®¹ä¸”ä¸å¯æ¢å¤ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );
    if (!confirmed) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ‰¹é‡ç²¾ç®€ ${summaries.length} æ¡æ€»ç»“ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...`);

    try {
        // ä½¿ç”¨ for...of å¾ªç¯æ¥é€æ¡å¤„ç†ï¼Œé¿å…åŒæ—¶å‘é€å¤ªå¤šAPIè¯·æ±‚å¯¼è‡´è¢«é™åˆ¶
        for (const summary of summaries) {
            const conciseText = await generateConciseSummary(summary.content);
            if (conciseText) {
                summary.content = conciseText.trim();
            }
            // æ¯å¤„ç†å®Œä¸€æ¡ï¼Œç¨å¾®ç­‰å¾…ä¸€ä¸‹ï¼Œç»™APIä¸€ç‚¹å–˜æ¯æ—¶é—´
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        await db.chats.put(chat);
        await openSummaryViewer();
        await showCustomAlert('æˆåŠŸ', 'æ‰€æœ‰æ€»ç»“éƒ½å·²ç²¾ç®€å®Œæ¯•ï¼');
    } catch (error) {
        // generateConciseSummary å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯å¼¹çª—ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ç¡®ä¿æµç¨‹æ­£å¸¸ç»“æŸ
        console.error("æ‰¹é‡ç²¾ç®€æ—¶å‡ºé”™:", error);
    }
}

// â–¼â–¼â–¼ ç¬¬2æ­¥ï¼šç”¨è¿™å—ã€å·²æ”¹é€ ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerManualSummaryNow å‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ‰‹åŠ¨æ€»ç»“ V2ã€‘ç”¨æˆ·ç‚¹å‡»â€œç«‹å³æ‰‹åŠ¨æ€»ç»“â€æŒ‰é’®æ—¶è§¦å‘çš„å‡½æ•° (æ”¯æŒä¸åŒæ¨¡å¼)
 * @param {'latest' | 'range'} mode - æ€»ç»“æ¨¡å¼
 * @param {{start: number, end: number} | null} range - å¦‚æœæ˜¯èŒƒå›´æ¨¡å¼ï¼Œåˆ™ä¸ºèµ·å§‹å’Œç»“æŸåºå·
 */
async function triggerManualSummaryNow(mode = 'latest', range = null) {
    if (isSummarizing) {
        alert("æ­£åœ¨å¤„ç†ä¸Šä¸€ä¸ªæ€»ç»“ä»»åŠ¡ï¼Œè¯·ç¨å€™...");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°å½“å‰èŠå¤©ï¼Œæ— æ³•æ€»ç»“ã€‚");
        return;
    }
    
    isSummarizing = true; // ä¸Šé”

    try {
        let messagesToSummarize = [];

        // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒé€»è¾‘ â–¼â–¼â–¼ ---

        // 1. æ ¹æ®ä¼ å…¥çš„æ¨¡å¼ï¼Œå†³å®šè¦æˆªå–å“ªäº›æ¶ˆæ¯
        if (mode === 'latest') {
            const summarySettings = chat.settings.summary;
            const count = (summarySettings && summarySettings.count > 0) ? summarySettings.count : 20;
            messagesToSummarize = chat.history.slice(-count);
            console.log(`æ‰‹åŠ¨æ€»ç»“æœ€æ–° ${count} æ¡æ¶ˆæ¯...`);
        } else if (mode === 'range' && range) {
            // æ³¨æ„ï¼šæ•°ç»„ç´¢å¼•ä»0å¼€å§‹ï¼Œè€Œç”¨æˆ·è¾“å…¥ä»1å¼€å§‹ï¼Œæ‰€ä»¥éœ€è¦-1
            messagesToSummarize = chat.history.slice(range.start - 1, range.end);
            console.log(`æ‰‹åŠ¨æ€»ç»“ä» ${range.start} åˆ° ${range.end} çš„æ¶ˆæ¯...`);
        } else {
            throw new Error("æ— æ•ˆçš„æ€»ç»“æ¨¡å¼æˆ–èŒƒå›´ã€‚");
        }

        // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

        // åç»­çš„é€»è¾‘ä¿æŒä¸å˜
        if (messagesToSummarize.length === 0) {
            alert("é€‰å®šçš„èŒƒå›´å†…æ²¡æœ‰å¯æ€»ç»“çš„èŠå¤©è®°å½•ã€‚");
            isSummarizing = false; // è§£é”
            return;
        }
        
        const summaryText = await generateSummary(state.activeChatId, messagesToSummarize);
        
        if (summaryText) {
            await saveSummaryAsMemory(state.activeChatId, summaryText);
            await showCustomAlert('æ€»ç»“å®Œæˆ', 'æ–°çš„å¯¹è¯è®°å¿†å·²ç”Ÿæˆï¼');
            if (document.getElementById('summary-viewer-modal').classList.contains('visible')) {
                openSummaryViewer();
            }
        }
    } catch (e) {
        console.error("æ‰‹åŠ¨æ€»ç»“è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„é”™è¯¯:", e);
        await showCustomAlert('é”™è¯¯', 'æ‰‹åŠ¨æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
    } finally {
        isSummarizing = false; // åˆ«å¿˜äº†æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦è§£é”
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ã€‘æ›´æ–°è§’è‰²æ‰‹æœºé’±åŒ…çš„ä½™é¢å’Œäº¤æ˜“è®°å½•
 * @param {string} charId - è¦æ›´æ–°é’±åŒ…çš„è§’è‰²ID
 * @param {number} amount - äº¤æ˜“é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿° (ä¾‹å¦‚: "è½¬è´¦ç»™ XX", "æ”¶åˆ° XX çš„çº¢åŒ…")
 */
async function updateCharacterBankBalance(charId, amount, description) {
    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœç¼ºå°‘å…³é”®ä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›
    if (!charId || !amount || isNaN(amount)) {
        console.warn("updateCharacterBankBalance è°ƒç”¨å¤±è´¥ï¼šç¼ºå°‘charIdæˆ–æœ‰æ•ˆçš„amountã€‚");
        return;
    }

    // ä»å…¨å±€çŠ¶æ€ä¸­è·å–è§’è‰²å¯¹è±¡
    const chat = state.chats[charId];
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿è§’è‰²å­˜åœ¨ä¸”ä¸æ˜¯ç¾¤èŠ
    if (!chat || chat.isGroup) {
        console.warn(`updateCharacterBankBalance è·³è¿‡ï¼šæ‰¾ä¸åˆ°IDä¸º ${charId} çš„è§’è‰²æˆ–è¯¥IDä¸ºç¾¤èŠã€‚`);
        return;
    }

    // --- ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´ï¼Œå…¼å®¹æ—§æ•°æ® ---
    if (!chat.characterPhoneData) {
        chat.characterPhoneData = {};
    }
    if (!chat.characterPhoneData.bank) {
        chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    }
    // å¦‚æœæ—§æ•°æ®çš„ä½™é¢ä¸æ˜¯æ•°å­—ï¼Œåˆ™å¼ºåˆ¶è®¾ä¸º0
    if (typeof chat.characterPhoneData.bank.balance !== 'number') {
        chat.characterPhoneData.bank.balance = 0;
    }
    // å¦‚æœæ—§æ•°æ®çš„äº¤æ˜“è®°å½•ä¸æ˜¯æ•°ç»„ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„
    if (!Array.isArray(chat.characterPhoneData.bank.transactions)) {
        chat.characterPhoneData.bank.transactions = [];
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    // 1. åˆ›å»ºä¸€æ¡æ–°çš„äº¤æ˜“è®°å½•
    const newTransaction = {
        type: amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º',
        amount: Math.abs(amount), // äº¤æ˜“è®°å½•é‡Œçš„é‡‘é¢æ€»æ˜¯æ­£æ•°
        description: description,
        timestamp: Date.now() // è®°å½•äº¤æ˜“å‘ç”Ÿçš„æ—¶é—´
    };

    // 2. æ›´æ–°ä½™é¢
    chat.characterPhoneData.bank.balance += amount;

    // 3. å°†æ–°äº¤æ˜“è®°å½•æ·»åŠ åˆ°åˆ—è¡¨çš„å¼€å¤´ï¼ˆè®©æœ€æ–°çš„æ˜¾ç¤ºåœ¨æœ€å‰é¢ï¼‰
    chat.characterPhoneData.bank.transactions.unshift(newTransaction);

    // 4. å°†æ›´æ–°åçš„è§’è‰²æ•°æ®ä¿å­˜å›æ•°æ®åº“
    await db.chats.put(chat);
    
    console.log(`âœ… é’±åŒ…åŒæ­¥æˆåŠŸ: è§’è‰²[${chat.name}], äº¤æ˜“[${description}], é‡‘é¢[${amount.toFixed(2)}], æ–°ä½™é¢[${chat.characterPhoneData.bank.balance.toFixed(2)}]`);
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå®â€App æ ¸å¿ƒåŠŸèƒ½å‡½æ•° --- */

let currentEditingProductId = null; // ç”¨äºè¿½è¸ªæ­£åœ¨ç¼–è¾‘çš„å•†å“ID
/**
 * ã€å…¨æ–° | å·²ä¿®å¤ã€‘æ¸…ç©ºæ¡ƒå®é¦–é¡µçš„æ‰€æœ‰å•†å“åŠè´­ç‰©è½¦
 */
async function clearTaobaoProducts() {
    // 1. ä¿®æ”¹æç¤ºè¯­ï¼Œå‘ŠçŸ¥ç”¨æˆ·è´­ç‰©è½¦ä¹Ÿä¼šè¢«æ¸…ç©º
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç©º',
        'ç¡®å®šè¦æ¸…ç©ºæ¡ƒå®é¦–é¡µçš„æ‰€æœ‰å•†å“å—ï¼Ÿæ­¤æ“ä½œå°†ã€ä¸€å¹¶æ¸…ç©ºè´­ç‰©è½¦ã€‘ï¼Œä¸”æ— æ³•æ¢å¤ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        try {
            // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œç¡®ä¿ä¸¤æ­¥æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œæ›´å®‰å…¨
            await db.transaction('rw', db.taobaoProducts, db.taobaoCart, async () => {
                // æ¸…ç©ºå•†å“åº“
                await db.taobaoProducts.clear();
                // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç 1ï¼šæ¸…ç©ºè´­ç‰©è½¦æ•°æ®åº“ â–¼â–¼â–¼
                await db.taobaoCart.clear();
            });
            
            // é‡æ–°æ¸²æŸ“UI
            await renderTaobaoProducts(); 
            // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç 2ï¼šåˆ·æ–°è´­ç‰©è½¦UIï¼ˆè®©é¡µé¢å˜ç©ºï¼‰ â–¼â–¼â–¼
            await renderTaobaoCart();
            // â–¼â–¼â–¼ æ ¸å¿ƒæ–°å¢ä»£ç 3ï¼šæ›´æ–°è´­ç‰©è½¦è§’æ ‡ï¼ˆè®©çº¢ç‚¹æ¶ˆå¤±ï¼‰ â–¼â–¼â–¼
            updateCartBadge();

            // 2. ä¿®æ”¹æˆåŠŸæç¤º
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'æ‰€æœ‰å•†å“åŠè´­ç‰©è½¦å·²è¢«æ¸…ç©ºï¼');

        } catch (error) {
            console.error("æ¸…ç©ºæ¡ƒå®å•†å“æ—¶å‡ºé”™:", error);
            await showCustomAlert('æ“ä½œå¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
        }
    }
}


/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€â€œæ¡ƒå®â€Appï¼Œå¹¶æ¸²æŸ“é»˜è®¤è§†å›¾
 */
async function openTaobaoApp() {
    showScreen('taobao-screen');
    await renderTaobaoProducts(); // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å•†å“
    renderBalanceDetails(); // åˆ·æ–°ä½™é¢æ˜¾ç¤º
}

// â–¼â–¼â–¼ è¯·å°†è¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œå®Œæ•´åœ°ç²˜è´´åˆ° // æ¡ƒå® App åŠŸèƒ½å‡½æ•°åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ‡æ¢â€œæ¡ƒå®â€Appå†…çš„ä¸åŒè§†å›¾ï¼ˆé¦–é¡µã€è´­ç‰©è½¦ã€è®¢å•ã€æˆ‘çš„ï¼‰
 */
function switchTaobaoView(viewId) {
    document.querySelectorAll('.taobao-view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');

    document.querySelectorAll('.taobao-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.view === viewId);
    });

    // æ ¹æ®åˆ‡æ¢çš„è§†å›¾ï¼Œæ‰§è¡Œå¯¹åº”çš„æ¸²æŸ“å‡½æ•°
    if (viewId === 'orders-view') {
        renderTaobaoOrders();
    } else if (viewId === 'my-view') {
        renderBalanceDetails();
    } else if (viewId === 'cart-view') {
        renderTaobaoCart(); // â˜…â˜…â˜… æ–°å¢ï¼šåˆ‡æ¢åˆ°è´­ç‰©è½¦æ—¶ï¼Œæ¸²æŸ“è´­ç‰©è½¦å†…å®¹
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è´­ç‰©è½¦é¡µé¢
 */
async function renderTaobaoCart() {
    const listEl = document.getElementById('cart-item-list');
    const checkoutBar = document.getElementById('cart-checkout-bar');
    listEl.innerHTML = '';
    
    const cartItems = await db.taobaoCart.toArray();

    if (cartItems.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ~</p>';
        checkoutBar.style.display = 'none';
        updateCartBadge(0);
        return;
    }
    
    checkoutBar.style.display = 'flex';
    let totalPrice = 0;
    let totalItems = 0;

    for (const item of cartItems) {
        const product = await db.taobaoProducts.get(item.productId);
        if (!product) continue;

        totalItems += item.quantity;
        totalPrice += product.price * item.quantity;

        const itemEl = document.createElement('div');
        itemEl.className = 'cart-item';
        itemEl.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" data-product-id="${product.id}">
            <div class="cart-item-info" data-product-id="${product.id}">
                <div class="product-name">${product.name}</div>
                <div class="product-price">Â¥${product.price.toFixed(2)}</div>
            </div>
            <div class="quantity-controls">
                <button class="quantity-decrease" data-cart-id="${item.id}" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                <span class="quantity-display">${item.quantity}</span>
                <button class="quantity-increase" data-cart-id="${item.id}">+</button>
            </div>
            <button class="delete-cart-item-btn" data-cart-id="${item.id}">Ã—</button>
        `;
        listEl.appendChild(itemEl);
    }
    
    document.getElementById('cart-total-price').textContent = `Â¥ ${totalPrice.toFixed(2)}`;
    const checkoutBtn = document.getElementById('checkout-btn');
    checkoutBtn.textContent = `ç»“ç®—(${totalItems})`;
    checkoutBtn.dataset.totalPrice = totalPrice; // æŠŠæ€»ä»·å­˜èµ·æ¥ï¼Œæ–¹ä¾¿ç»“ç®—æ—¶ç”¨

    updateCartBadge(totalItems);
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°è´­ç‰©è½¦å›¾æ ‡ä¸Šçš„è§’æ ‡æ•°é‡
 */
function updateCartBadge() {
    const badge = document.getElementById('cart-item-count-badge');
    db.taobaoCart.toArray().then(items => {
        const totalCount = items.reduce((sum, item) => sum + item.quantity, 0);
        if (totalCount > 0) {
            badge.textContent = totalCount > 99 ? '99+' : totalCount;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    });
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†åŠ å…¥è´­ç‰©è½¦çš„é€»è¾‘
 */
async function handleAddToCart(productId) {
    const existingItem = await db.taobaoCart.where('productId').equals(productId).first();
    if (existingItem) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ•°é‡+1
        await db.taobaoCart.update(existingItem.id, { quantity: existingItem.quantity + 1 });
    } else {
        // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢
        await db.taobaoCart.add({ productId: productId, quantity: 1 });
    }
    await showCustomAlert('æˆåŠŸ', 'å®è´å·²åŠ å…¥è´­ç‰©è½¦ï¼');
    updateCartBadge(); // æ›´æ–°è§’æ ‡
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†è´­ç‰©è½¦å†…å•†å“æ•°é‡çš„å˜åŒ–
 */
async function handleChangeCartItemQuantity(cartId, change) {
    const item = await db.taobaoCart.get(cartId);
    if (!item) return;

    const newQuantity = item.quantity + change;
    if (newQuantity <= 0) {
        // å¦‚æœæ•°é‡å‡åˆ°0ï¼Œå°±åˆ é™¤è¯¥é¡¹
        await handleRemoveFromCart(cartId);
    } else {
        await db.taobaoCart.update(cartId, { quantity: newQuantity });
        await renderTaobaoCart();
    }
}

/**
 * ã€å…¨æ–°ã€‘ä»è´­ç‰©è½¦ä¸­ç§»é™¤å•†å“
 */
async function handleRemoveFromCart(cartId) {
    await db.taobaoCart.delete(cartId);
    await renderTaobaoCart();
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²é›†æˆè¯„ä»·åŠŸèƒ½ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openProductDetail å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€å•†å“è¯¦æƒ…å¼¹çª— (å·²é›†æˆè¯„ä»·åŠŸèƒ½)
 */
async function openProductDetail(productId) {
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const modal = document.getElementById('product-detail-modal');
    const bodyEl = document.getElementById('product-detail-body');
    const reviewsSection = document.getElementById('product-reviews-section');
    const reviewsListEl = document.getElementById('product-reviews-list');
    const generateBtn = document.getElementById('generate-reviews-btn');
    
    // æ¸²æŸ“å•†å“åŸºæœ¬ä¿¡æ¯
    bodyEl.innerHTML = `
        <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
        <h2 class="product-name">${product.name}</h2>
        <p class="product-price">${product.price.toFixed(2)}</p>
        <p style="color: #888; font-size: 13px;">åº—é“º: ${product.store || 'æ¡ƒå®è‡ªè¥'}</p>
    `;

    // â˜…â˜…â˜… æ¸²æŸ“è¯„ä»·åŒºåŸŸ â˜…â˜…â˜…
    reviewsListEl.innerHTML = '';
    if (product.reviews && product.reviews.length > 0) {
        // å¦‚æœæœ‰è¯„ä»·ï¼Œå°±æ¸²æŸ“å®ƒä»¬
        product.reviews.forEach(review => {
            const reviewEl = document.createElement('div');
            reviewEl.className = 'product-review-item';
            reviewEl.innerHTML = `
                <div class="review-author">${review.author}</div>
                <p>${review.text}</p>
            `;
            reviewsListEl.appendChild(reviewEl);
        });
        generateBtn.style.display = 'none'; // æœ‰è¯„ä»·äº†å°±éšè—ç”ŸæˆæŒ‰é’®
    } else {
        // å¦‚æœæ²¡æœ‰è¯„ä»·ï¼Œå°±æ˜¾ç¤ºæç¤ºå’Œç”ŸæˆæŒ‰é’®
        reviewsListEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 13px;">è¿˜æ²¡æœ‰äººè¯„ä»·å“¦~</p>';
        generateBtn.style.display = 'block';
    }

    // é‡æ–°ç»‘å®šâ€œç”Ÿæˆè¯„ä»·â€æŒ‰é’®çš„äº‹ä»¶ (ä½¿ç”¨å…‹éš†èŠ‚ç‚¹é˜²æ­¢é‡å¤ç»‘å®š)
    const newGenerateBtn = generateBtn.cloneNode(true);
    generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
    newGenerateBtn.addEventListener('click', () => generateProductReviews(productId));

    // é‡æ–°ç»‘å®šâ€œåŠ å…¥è´­ç‰©è½¦â€æŒ‰é’®çš„äº‹ä»¶
    const addToCartBtn = document.getElementById('detail-add-to-cart-btn');
    const newAddToCartBtn = addToCartBtn.cloneNode(true);
    addToCartBtn.parentNode.replaceChild(newAddToCartBtn, addToCartBtn);
    newAddToCartBtn.onclick = async () => {
        await handleAddToCart(productId);
        modal.classList.remove('visible'); // æ·»åŠ åè‡ªåŠ¨å…³é—­å¼¹çª—
    };
    
    // ç»‘å®šå…³é—­æŒ‰é’®
    document.getElementById('close-product-detail-btn').onclick = () => modal.classList.remove('visible');

    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘AIæ ¸å¿ƒï¼šä¸ºæŒ‡å®šå•†å“ç”Ÿæˆè¯„ä»·
 * @param {number} productId - å•†å“çš„ID
 */
async function generateProductReviews(productId) {
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¬å”¤ä¹°å®¶ç§€å¤§å†›...");
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }
    
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå•†è¯„è®ºç”Ÿæˆå™¨ã€‚è¯·ä½ ä¸ºä»¥ä¸‹å•†å“ç”Ÿæˆ3-5æ¡é£æ ¼å„å¼‚çš„æ¨¡æ‹Ÿä¹°å®¶è¯„ä»·ã€‚

# å•†å“ä¿¡æ¯
- åç§°: ${product.name}
- ä»·æ ¼: ${product.price}å…ƒ
- åˆ†ç±»: ${product.category || 'æœªåˆ†ç±»'}

# æ ¸å¿ƒè§„åˆ™
1.  **é£æ ¼å¤šæ ·**: ç”Ÿæˆçš„è¯„è®ºåº”åŒ…å«ä¸åŒé£æ ¼ï¼Œä¾‹å¦‚ï¼š
    -   **å¥½è¯„**: è¯¦ç»†å¤¸èµå•†å“çš„æŸä¸ªä¼˜ç‚¹ã€‚
    -   **ä¸­è¯„/è¿½è¯„**: æè¿°ä½¿ç”¨ä¸€æ®µæ—¶é—´åçš„æ„Ÿå—ï¼Œå¯èƒ½æåˆ°ä¸€äº›å°ç‘•ç–µã€‚
    -   **å·®è¯„**: åæ§½å•†å“çš„æŸä¸ªç¼ºç‚¹ï¼Œä½†è¯­æ°”è¦åƒçœŸå®ä¹°å®¶ã€‚
    -   **æç¬‘è¯„è®º**: å†™ä¸€äº›å¹½é»˜é£è¶£çš„è¯„è®ºã€‚
    -   **ç®€æ´è¯„è®º**: ä¾‹å¦‚â€œå¥½è¯„â€ã€â€œè¿˜è¡Œâ€ã€â€œç‰©æµå¾ˆå¿«â€ã€‚
2.  **æ˜µç§°çœŸå®**: è¯„è®ºçš„ä½œè€…æ˜µç§° ("author") å¿…é¡»æ˜¯éšæœºçš„ã€ç”Ÿæ´»åŒ–çš„ã€ç¬¦åˆè´­ç‰©Appç”¨æˆ·ä¹ æƒ¯çš„ã€‚ä¾‹å¦‚ï¼šâ€œåŒ¿åç”¨æˆ·â€ã€â€œå°ç‹ä¸åƒé¦™èœâ€ã€â€œå¯ä¹çˆ±å¥½è€…â€ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡è¯„è®ºï¼Œå¹¶åŒ…å« "author" å’Œ "text" ä¸¤ä¸ªå­—æ®µã€‚

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  { "author": "åŒ¿åç”¨æˆ·", "text": "ç‰©æµå¾ˆå¿«ï¼ŒåŒ…è£…ä¹Ÿå¾ˆå¥½ï¼Œå®è´è·Ÿæè¿°çš„ä¸€æ ·ï¼Œå¥½è¯„ï¼" },
  { "author": "æ˜¯å°å¼ å‘€", "text": "æœ‰ç‚¹è‰²å·®ï¼Œä¸è¿‡è¿˜èƒ½æ¥å—ã€‚å…ˆç”¨ç”¨çœ‹ï¼Œè¿‡æ®µæ—¶é—´å†æ¥è¿½è¯„ã€‚" }
]
`;
    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 1.0,response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newReviews = JSON.parse(cleanedContent);

        if (Array.isArray(newReviews) && newReviews.length > 0) {
            // å°†AIç”Ÿæˆçš„è¯„ä»·ä¿å­˜åˆ°å•†å“æ•°æ®ä¸­
            await db.taobaoProducts.update(productId, { reviews: newReviews });
            await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `å·²æˆåŠŸç”Ÿæˆ ${newReviews.length} æ¡è¯„ä»·ã€‚`);
            // é‡æ–°æ‰“å¼€è¯¦æƒ…é¡µï¼Œåˆ·æ–°æ˜¾ç¤º
            await openProductDetail(productId);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("ç”Ÿæˆå•†å“è¯„ä»·å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²é›†æˆç‰©æµã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ handleCheckout å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ç»“ç®—è´­ç‰©è½¦
 */
async function handleCheckout() {
    const checkoutBtn = document.getElementById('checkout-btn');
    const totalPrice = parseFloat(checkoutBtn.dataset.totalPrice);
    
    if (totalPrice <= 0) return;

    const currentBalance = state.globalSettings.userBalance || 0;
    if (currentBalance < totalPrice) {
        alert("ä½™é¢ä¸è¶³ï¼è¯·å…ˆå»â€œæˆ‘çš„â€é¡µé¢å……å€¼ã€‚");
        return;
    }
    
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ”¯ä»˜',
        `æœ¬æ¬¡å°†èŠ±è´¹ Â¥${totalPrice.toFixed(2)}ï¼Œç¡®å®šè¦ç»“ç®—å—ï¼Ÿ`,
        { confirmText: 'ç«‹å³æ”¯ä»˜' }
    );
    
    if (confirmed) {
        const cartItems = await db.taobaoCart.toArray();
        const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
        const productsInCart = await Promise.all(productPromises);
        const validProducts = productsInCart.filter(Boolean);

        let description = 'è´­ä¹°å•†å“: ';
        const itemNames = validProducts.map(p => `â€œ${p.name}â€`);
        if (itemNames.length > 2) {
            description += itemNames.slice(0, 2).join('ã€') + ` ç­‰${itemNames.length}ä»¶å•†å“`;
        } else {
            description += itemNames.join('ã€');
        }
        
        await updateUserBalanceAndLogTransaction(-totalPrice, description);

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºæ¯ä¸ªè®¢å•åˆ›å»ºç‰©æµå†å²èµ·ç‚¹ â˜…â˜…â˜…
        const newOrders = cartItems.map((item, index) => ({
            productId: item.productId,
            quantity: item.quantity,
            timestamp: Date.now() + index, // è®¢å•åˆ›å»ºæ—¶é—´
            status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§'
            // æˆ‘ä»¬ä¸å†éœ€è¦åœ¨æ•°æ®åº“é‡Œå­˜ logisticsHistoryï¼Œå› ä¸ºå®ƒæ˜¯åŠ¨æ€æ¨¡æ‹Ÿçš„
        }));
        
        await db.taobaoOrders.bulkAdd(newOrders);
        await db.taobaoCart.clear();
        await renderTaobaoCart();

        alert('æ”¯ä»˜æˆåŠŸï¼å®è´æ­£åœ¨ç«é€Ÿæ‰“åŒ…ä¸­~');
        switchTaobaoView('orders-view');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderTaobaoProducts å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ¸²æŸ“å•†å“åˆ—è¡¨ï¼Œæœç»é‡å¤å¹¶ç§»é™¤å¤šä½™æŒ‰é’®
 */
async function renderTaobaoProducts(category = null) {
    const gridEl = document.getElementById('product-grid');
    const categoryTabsEl = document.getElementById('product-category-tabs');
    
    // æˆ‘ä»¬ä»ç„¶ä¿ç•™æ¸…ç©ºæ“ä½œï¼Œè¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯
    gridEl.innerHTML = '';

    const allProducts = await db.taobaoProducts.orderBy('name').toArray();
    const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];

    // æ¸²æŸ“åˆ†ç±»é¡µç­¾ (è¿™éƒ¨åˆ†é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œä¿æŒä¸å˜)
    categoryTabsEl.innerHTML = `<button class="category-tab-btn ${!category ? 'active' : ''}" data-category="all">å…¨éƒ¨</button>`;
    categories.forEach(cat => {
        categoryTabsEl.innerHTML += `<button class="category-tab-btn ${category === cat ? 'active' : ''}" data-category="${cat}">${cat}</button>`;
    });

    const productsToRender = category 
        ? allProducts.filter(p => p.category === category)
        : allProducts;

    if (productsToRender.length === 0) {
        gridEl.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰å•†å“å“¦ï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ å§ï¼</p>';
        return;
    }

    productsToRender.forEach(product => {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œæ£€æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨ â˜…â˜…â˜…
        // å¦‚æœé¡µé¢ä¸Šå·²ç»æœ‰ä¸€ä¸ªå¸¦æœ‰ç›¸åŒå•†å“IDçš„å¡ç‰‡äº†ï¼Œå°±ç›´æ¥è·³è¿‡ï¼Œä¸æ‰§è¡Œåé¢çš„æ·»åŠ æ“ä½œã€‚
        if (gridEl.querySelector(`[data-product-id="${product.id}"]`)) {
            console.warn(`æ£€æµ‹åˆ°é‡å¤å•†å“ï¼Œå·²è·³è¿‡æ¸²æŸ“: ${product.name}`);
            return; // è·³è¿‡æœ¬æ¬¡å¾ªç¯
        }

        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.productId = product.id;

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤2ï¼šç§»é™¤äº†æ‚¨ä¸æƒ³è¦çš„â€œåŠ å…¥è´­ç‰©è½¦â€æŒ‰é’® â˜…â˜…â˜…
        card.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price.toFixed(2)}</div>
            </div>
        `;
        // é•¿æŒ‰åˆ é™¤åŠŸèƒ½ä¿æŒä¸å˜
        addLongPressListener(card, () => showProductActions(product.id));

        // æœ€ç»ˆå°†åˆ›å»ºå¥½çš„å¡ç‰‡æ·»åŠ åˆ°é¡µé¢
        gridEl.appendChild(card);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




/**
 * æ¸²æŸ“â€œæˆ‘çš„è®¢å•â€åˆ—è¡¨
 */
async function renderTaobaoOrders() {
    const listEl = document.getElementById('order-list');
    listEl.innerHTML = '';
    const orders = await db.taobaoOrders.reverse().sortBy('timestamp');

    if (orders.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•è®¢å•è®°å½•</p>';
        return;
    }

    for (const order of orders) {
        const product = await db.taobaoProducts.get(order.productId);
        if (!product) continue;

        const item = document.createElement('div');
        item.className = 'order-item';
        item.dataset.orderId = order.id;
        item.innerHTML = `
            <img src="${product.imageUrl}" class="product-image">
            <div class="order-info">
                <div class="product-name">${product.name}</div>
                <div class="order-status">${order.status}</div>
                <div class="order-time">${new Date(order.timestamp).toLocaleString()}</div>
            </div>
        `;
        listEl.appendChild(item);
    }
}

/**
 * æ¸²æŸ“â€œæˆ‘çš„â€é¡µé¢çš„ä½™é¢
 */
function renderTaobaoBalance() {
    const balance = state.globalSettings.userBalance || 0;
    document.getElementById('user-balance-display').textContent = `Â¥ ${balance.toFixed(2)}`;
}

/**
 * æ‰“å¼€æ·»åŠ å•†å“çš„æ–¹å¼é€‰æ‹©å¼¹çª—
 */
function openAddProductChoiceModal() {
    document.getElementById('add-product-choice-modal').classList.add('visible');
}

/**
 * æ‰“å¼€æ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘å•†å“çš„å¼¹çª—
 */
function openProductEditor(productId = null) {
    currentEditingProductId = productId;
    const modal = document.getElementById('product-editor-modal');
    const titleEl = document.getElementById('product-editor-title');
    
    if (productId) {
        titleEl.textContent = 'ç¼–è¾‘å•†å“';
        // (å¼‚æ­¥) åŠ è½½ç°æœ‰å•†å“æ•°æ®
        db.taobaoProducts.get(productId).then(product => {
            if (product) {
                document.getElementById('product-name-input').value = product.name;
                document.getElementById('product-price-input').value = product.price;
                document.getElementById('product-image-input').value = product.imageUrl;
                document.getElementById('product-category-input').value = product.category || '';
            }
        });
    } else {
        titleEl.textContent = 'æ·»åŠ æ–°å•†å“';
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('product-name-input').value = '';
        document.getElementById('product-price-input').value = '';
        document.getElementById('product-image-input').value = '';
        document.getElementById('product-category-input').value = '';
    }
    modal.classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ saveProduct å‡½æ•° â–¼â–¼â–¼
/**
 * ä¿å­˜æ‰‹åŠ¨æ·»åŠ æˆ–ç¼–è¾‘çš„å•†å“
 */
async function saveProduct() {
    const name = document.getElementById('product-name-input').value.trim();
    const price = parseFloat(document.getElementById('product-price-input').value);
    let imageUrl = document.getElementById('product-image-input').value.trim(); // æ ¸å¿ƒä¿®æ”¹1ï¼šä½¿ç”¨let
    const category = document.getElementById('product-category-input').value.trim();

    // æ ¸å¿ƒä¿®æ”¹2ï¼šç°åœ¨å›¾ç‰‡URLä¸æ˜¯å¿…å¡«é¡¹äº†
    if (!name || isNaN(price) || price <= 0) {
        alert("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆåç§°ã€æœ‰æ•ˆä»·æ ¼ï¼‰ï¼");
        return;
    }

    // æ ¸å¿ƒä¿®æ”¹3ï¼šå¦‚æœå›¾ç‰‡URLä¸ºç©ºï¼Œå°±è°ƒç”¨æˆ‘ä»¬çš„æ–°å‡½æ•°è·å–ä¸€ä¸ªéšæœºé»˜è®¤å›¾
    if (!imageUrl) {
        imageUrl = getRandomDefaultProductImage();
    }

    const productData = { name, price, imageUrl, category };

    if (currentEditingProductId) {
        await db.taobaoProducts.update(currentEditingProductId, productData);
        alert('å•†å“å·²æ›´æ–°ï¼');
    } else {
        await db.taobaoProducts.add(productData);
        alert('æ–°å•†å“å·²æ·»åŠ ï¼');
    }

    document.getElementById('product-editor-modal').classList.remove('visible');
    await renderTaobaoProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
    currentEditingProductId = null;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * æ‰“å¼€è¯†åˆ«é“¾æ¥çš„å¼¹çª—
 */
function openAddFromLinkModal() {
    document.getElementById('link-paste-area').value = '';
    document.getElementById('add-from-link-modal').classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handleAddFromLink å‡½æ•° â–¼â–¼â–¼
/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šå¤„ç†ç²˜è´´çš„åˆ†äº«æ–‡æ¡ˆ
 */
async function handleAddFromLink() {
    const text = document.getElementById('link-paste-area').value;
    const nameMatch = text.match(/ã€Œ(.+?)ã€/);

    if (!nameMatch || !nameMatch[1]) {
        alert('æ— æ³•è¯†åˆ«å•†å“åç§°ï¼è¯·ç¡®ä¿ç²˜è´´äº†åŒ…å«ã€Œå•†å“åã€çš„å®Œæ•´åˆ†äº«æ–‡æ¡ˆã€‚');
        return;
    }

    const name = nameMatch[1];
    
    document.getElementById('add-from-link-modal').classList.remove('visible');
    
    const priceStr = await showCustomPrompt(`å•†å“: ${name}`, "è¯·è¾“å…¥ä»·æ ¼ (å…ƒ):", "", "number");
    if (priceStr === null) return;
    const price = parseFloat(priceStr);
    if (isNaN(price) || price <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼");
        return;
    }

    // æ ¸å¿ƒä¿®æ”¹1ï¼šè®©å›¾ç‰‡URLå˜æˆå¯é€‰
    let imageUrl = await showCustomPrompt(`å•†å“: ${name}`, "è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ (URL, å¯é€‰):");
    if (imageUrl === null) return; // å¦‚æœç”¨æˆ·ç‚¹å–æ¶ˆï¼Œåˆ™ä¸­æ–­æ“ä½œ

    // æ ¸å¿ƒä¿®æ”¹2ï¼šå¦‚æœç”¨æˆ·æ²¡å¡«å›¾ç‰‡é“¾æ¥ï¼Œå°±ä½¿ç”¨éšæœºé»˜è®¤å›¾
    if (!imageUrl || !imageUrl.trim()) {
        imageUrl = getRandomDefaultProductImage();
    }

    const category = await showCustomPrompt(`å•†å“: ${name}`, "è¯·è¾“å…¥åˆ†ç±» (å¯é€‰):");

    await db.taobaoProducts.add({ name, price, imageUrl, category: category || '' });
    await renderTaobaoProducts();
    alert('å•†å“å·²é€šè¿‡é“¾æ¥æ·»åŠ æˆåŠŸï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° handleGenerateProductsAI å‡½æ•°çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ®ç”¨æˆ·æœç´¢è§¦å‘AIç”Ÿæˆå•†å“
 */
async function handleSearchProductsAI() {
    const searchTerm = productSearchInput.value.trim();
    if (!searchTerm) {
        alert("è¯·è¾“å…¥ä½ æƒ³æœç´¢çš„å•†å“ï¼");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", `AIæ­£åœ¨ä¸ºä½ å¯»æ‰¾å…³äºâ€œ${searchTerm}â€çš„çµæ„Ÿ...`);
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    // ã€æ ¸å¿ƒã€‘è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„Promptï¼Œå®ƒå‘Šè¯‰AIè¦æ ¹æ®ç”¨æˆ·çš„æœç´¢è¯æ¥åˆ›ä½œ
    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿè´­ç‰©Appâ€œæ¡ƒå®â€çš„å•†å“ç­–åˆ’å¸ˆã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ã€æœç´¢å…³é”®è¯ã€‘ï¼Œä¸ºTaåˆ›ä½œä¸€ä¸ªåŒ…å«5-8ä»¶ç›¸å…³å•†å“çš„åˆ—è¡¨ã€‚

# ç”¨æˆ·æœç´¢çš„å…³é”®è¯:
"${searchTerm}"

# æ ¸å¿ƒè§„åˆ™
1.  **é«˜åº¦ç›¸å…³**: æ‰€æœ‰å•†å“éƒ½å¿…é¡»ä¸ç”¨æˆ·çš„æœç´¢å…³é”®è¯ "${searchTerm}" ç´§å¯†ç›¸å…³ã€‚
2.  **å•†å“å¤šæ ·æ€§**: å³ä½¿æ˜¯åŒä¸€ä¸ªä¸»é¢˜ï¼Œä¹Ÿè¦å°½é‡å±•ç¤ºä¸åŒæ¬¾å¼ã€åŠŸèƒ½æˆ–è§’åº¦çš„å•†å“ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä»¶å•†å“ï¼Œå¹¶åŒ…å«ä»¥ä¸‹å­—æ®µ:
    -   \`"name"\`: å•†å“åç§°
    -   \`"price"\`: ä»·æ ¼
    -   \`"imageUrl"\`: ä»'https://i.postimg.cc/kG7C0gGP/11.jpg'å’Œ'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg'ä¸­éšæœºæŒ‘é€‰ä¸€å¼ ï¼Œç¦æ­¢è‡ªå·±ç”Ÿæˆã€‚
    -   \`"category"\`: å•†å“åˆ†ç±»

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "èµ›åšæœ‹å…‹é£å‘å…‰æ•°æ®çº¿",
    "price": 69.9,
    "imageUrl": "https://i.postimg.cc/kG7C0gGP/11.jpg",
    "category": "æ•°ç é…ä»¶"
  }
]`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newProducts = JSON.parse(cleanedContent);

        if (Array.isArray(newProducts) && newProducts.length > 0) {
            // è°ƒç”¨æ˜¾ç¤ºå‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªæ›´å…·ä½“çš„æ ‡é¢˜
            displayAiGeneratedProducts(newProducts, `AIä¸ºä½ æ‰¾åˆ°äº†å…³äºâ€œ${searchTerm}â€çš„å®è´`);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–å†…å®¹ä¸ºç©ºã€‚");
        }
    } catch (error) {
        console.error("AIæœç´¢å•†å“å¤±è´¥:", error);
        await showCustomAlert('æœç´¢å¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘UIå‡½æ•°ï¼šåœ¨å¼¹çª—ä¸­æ˜¾ç¤ºAIç”Ÿæˆçš„å•†å“åˆ—è¡¨ï¼Œå¹¶è®©ç”¨æˆ·é€‰æ‹©æ·»åŠ 
 * @param {Array} products - AIç”Ÿæˆçš„å•†å“å¯¹è±¡æ•°ç»„
 * @param {string} title - å¼¹çª—çš„æ ‡é¢˜
 */
function displayAiGeneratedProducts(products, title) {
    const modal = document.getElementById('ai-generated-products-modal');
    const titleEl = document.getElementById('ai-products-modal-title');
    const gridEl = document.getElementById('ai-product-results-grid');
    
    titleEl.textContent = title;
    gridEl.innerHTML = '';

    products.forEach((product, index) => {
        const card = document.createElement('div');
        card.className = 'product-card';
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç»™å¡ç‰‡ä¸€ä¸ªä¸´æ—¶çš„å”¯ä¸€IDï¼Œæ–¹ä¾¿æ“ä½œ
        card.id = `ai-product-${index}`; 
        
        card.innerHTML = `
            <img src="${product.imageUrl}" class="product-image" alt="${product.name}">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price.toFixed(2)}</div>
            </div>
            <button class="add-to-my-page-btn" data-product='${JSON.stringify(product)}'>+ æ·»åŠ åˆ°æˆ‘çš„æ¡ƒå®</button>
        `;
        gridEl.appendChild(card);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ handleGenerateProductsAI å‡½æ•° â–¼â–¼â–¼
/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šè§¦å‘AIã€éšæœºã€‘ç”Ÿæˆå•†å“ï¼Œå¹¶åœ¨å¼¹çª—ä¸­æ˜¾ç¤º
 */
async function handleGenerateProductsAI() {
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIç”Ÿæˆä¸€æ‰¹æœ‰è¶£çš„å•†å“...");
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    const prompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿè´­ç‰©Appâ€œæ¡ƒå®â€çš„å•†å“ç­–åˆ’å¸ˆã€‚è¯·ä½ åˆ›ä½œä¸€ä¸ªåŒ…å«5-8ä»¶å•†å“çš„åˆ—è¡¨ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **å•†å“å¤šæ ·æ€§**: å•†å“å¿…é¡»æœ‰è¶£ã€å¤šæ ·ï¼Œå¯ä»¥åŒ…å«æœè£…ã€é›¶é£Ÿã€å®¶å±…ç”¨å“ã€è™šæ‹Ÿç‰©å“ç­‰ã€‚
2.  **åˆ†ç±»æ¸…æ™°**: ä¸ºæ¯ä»¶å•†å“è®¾ç½®ä¸€ä¸ªåˆç†çš„åˆ†ç±»ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥ '[' å¼€å¤´ï¼Œä»¥ ']' ç»“å°¾ã€‚æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä»¶å•†å“ï¼Œã€å¿…é¡»ã€‘åŒ…å«ä»¥ä¸‹å­—æ®µ:
    -   \`"name"\`: å•†å“åç§° (å­—ç¬¦ä¸²)
    -   \`"price"\`: ä»·æ ¼ (æ•°å­—)
    -   \`"imageUrl"\`: ä»'https://i.postimg.cc/kG7C0gGP/11.jpg'å’Œ'https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg'ä¸­éšæœºæŒ‘é€‰ä¸€å¼ ï¼Œç¦æ­¢è‡ªå·±ç”Ÿæˆã€‚
    -   \`"category"\`: å•†å“åˆ†ç±» (å­—ç¬¦ä¸²)

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "ä¼šå‘å…‰çš„è˜‘è‡å°å¤œç¯",
    "price": 49.9,
    "imageUrl": "https://i.postimg.cc/W4svy4Hm/Image-1760206134285.jpg",
    "category": "å®¶å±…"
  }
]`;

    try {
        const messagesForApi = [{ role: 'user', content: prompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, prompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newProducts = JSON.parse(cleanedContent);

        if (Array.isArray(newProducts) && newProducts.length > 0) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†ç›´æ¥ä¿å­˜ï¼Œè€Œæ˜¯è°ƒç”¨æ˜¾ç¤ºå‡½æ•°
            displayAiGeneratedProducts(newProducts, "AIéšæœºç”Ÿæˆäº†ä»¥ä¸‹å®è´");
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("AIç”Ÿæˆå•†å“å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å¤„ç†ç”¨æˆ·ç‚¹å‡»å•†å“å¡ç‰‡çš„é€»è¾‘ï¼ˆè´­ä¹°ï¼‰
 */
async function handleBuyProduct(productId) {
    const product = await db.taobaoProducts.get(productId);
    if (!product) return;

    const currentBalance = state.globalSettings.userBalance || 0;
    if (currentBalance < product.price) {
        alert("ä½™é¢ä¸è¶³ï¼Œå…ˆå»â€œæˆ‘çš„â€é¡µé¢å……ç‚¹é’±å§ï¼");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤è´­ä¹°',
        `ç¡®å®šè¦èŠ±è´¹ Â¥${product.price.toFixed(2)} è´­ä¹°â€œ${product.name}â€å—ï¼Ÿ`,
        { confirmText: 'ç«‹å³æ”¯ä»˜' }
    );

    if (confirmed) {
        // 1. æ‰£é™¤ä½™é¢
        state.globalSettings.userBalance -= product.price;
        await db.globalSettings.put(state.globalSettings);

        // 2. åˆ›å»ºè®¢å•
        const newOrder = {
            productId: productId,
            timestamp: Date.now(),
            status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§'
        };
        await db.taobaoOrders.add(newOrder);
        
        // æ¨¡æ‹Ÿç‰©æµæ›´æ–°
        setTimeout(async () => {
            const orderToUpdate = await db.taobaoOrders.where({ timestamp: newOrder.timestamp }).first();
            if (orderToUpdate) {
                await db.taobaoOrders.update(orderToUpdate.id, { status: 'å·²å‘è´§ï¼Œè¿è¾“ä¸­' });
            }
        }, 1000 * 10); // 10ç§’åæ›´æ–°ä¸ºå·²å‘è´§

        alert('è´­ä¹°æˆåŠŸï¼ä½ å¯ä»¥åœ¨â€œæˆ‘çš„è®¢å•â€ä¸­æŸ¥çœ‹ç‰©æµä¿¡æ¯ã€‚');
        renderTaobaoBalance(); // åˆ·æ–°ä½™é¢æ˜¾ç¤º
    }
}

/**
 * é•¿æŒ‰å•†å“æ—¶æ˜¾ç¤ºæ“ä½œèœå•
 */
async function showProductActions(productId) {
    const choice = await showChoiceModal("å•†å“æ“ä½œ", [
        { text: 'âœï¸ ç¼–è¾‘å•†å“', value: 'edit' },
        { text: 'ğŸ—‘ï¸ åˆ é™¤å•†å“', value: 'delete' }
    ]);

    if (choice === 'edit') {
        openProductEditor(productId);
    } else if (choice === 'delete') {
        const product = await db.taobaoProducts.get(productId);
        const confirmed = await showCustomConfirm(
            'ç¡®è®¤åˆ é™¤',
            `ç¡®å®šè¦åˆ é™¤å•†å“â€œ${product.name}â€å—ï¼Ÿ`,
            { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            await db.taobaoProducts.delete(productId);
            await renderTaobaoProducts();
            alert('å•†å“å·²åˆ é™¤ã€‚');
        }
    }
}
// â–¼â–¼â–¼ æŠŠè¿™ä¸¤å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¸å¿ƒå‡½æ•°ï¼šæ›´æ–°ç”¨æˆ·ä½™é¢å¹¶è®°å½•ä¸€ç¬”äº¤æ˜“
 * @param {number} amount - äº¤æ˜“é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿° (ä¾‹å¦‚: "è½¬è´¦ç»™ XX", "æ”¶åˆ° XX çš„çº¢åŒ…")
 */
async function updateUserBalanceAndLogTransaction(amount, description) {
    if (isNaN(amount)) return; // å®‰å…¨æ£€æŸ¥

    // ç¡®ä¿ä½™é¢æ˜¯æ•°å­—
    state.globalSettings.userBalance = (state.globalSettings.userBalance || 0) + amount;

    const newTransaction = {
        type: amount > 0 ? 'income' : 'expense',
        amount: Math.abs(amount),
        description: description,
        timestamp: Date.now()
    };

    // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œç¡®ä¿ä¸¤æ­¥æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
    await db.transaction('rw', db.globalSettings, db.userWalletTransactions, async () => {
        await db.globalSettings.put(state.globalSettings);
        await db.userWalletTransactions.add(newTransaction);
    });
    
    console.log(`ç”¨æˆ·é’±åŒ…å·²æ›´æ–°: é‡‘é¢=${amount.toFixed(2)}, æ–°ä½™é¢=${state.globalSettings.userBalance.toFixed(2)}`);
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“â€œæˆ‘çš„â€é¡µé¢çš„ä½™é¢å’Œäº¤æ˜“æ˜ç»†
 */
async function renderBalanceDetails() {
    // 1. æ¸²æŸ“å½“å‰ä½™é¢
    const balance = state.globalSettings.userBalance || 0;
    document.getElementById('user-balance-display').textContent = `Â¥ ${balance.toFixed(2)}`;

    // 2. æ¸²æŸ“äº¤æ˜“æ˜ç»†åˆ—è¡¨
    const listEl = document.getElementById('balance-details-list');
    listEl.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨

    const transactions = await db.userWalletTransactions.reverse().sortBy('timestamp');

    if (transactions.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 20px;">è¿˜æ²¡æœ‰ä»»ä½•æ˜ç»†è®°å½•</p>';
        return;
    }
    
    // ç»™åˆ—è¡¨åŠ ä¸ªæ ‡é¢˜
    listEl.innerHTML = '<h3 style="margin-bottom: 10px; color: var(--text-secondary);">ä½™é¢æ˜ç»†</h3>';

    transactions.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'transaction-item';
        const sign = item.type === 'income' ? '+' : '-';
        
        itemEl.innerHTML = `
            <div class="transaction-info">
                <div class="description">${item.description}</div>
                <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
            </div>
            <div class="transaction-amount ${item.type}">
                ${sign} ${item.amount.toFixed(2)}
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ä¸Šæ–¹ï¼Œç²˜è´´ä¸‹é¢è¿™ 3 ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€ç‰©æµè¯¦æƒ…é¡µé¢
 * @param {number} orderId - è¢«ç‚¹å‡»çš„è®¢å•ID
 */
async function openLogisticsView(orderId) {
    const order = await db.taobaoOrders.get(orderId);
    if (!order) {
        alert("æ‰¾ä¸åˆ°è¯¥è®¢å•ï¼");
        return;
    }

    // æ¯æ¬¡æ‰“å¼€éƒ½å…ˆæ¸…ç©ºæ—§çš„è®¡æ—¶å™¨
    logisticsUpdateTimers.forEach(timerId => clearTimeout(timerId));
    logisticsUpdateTimers = [];

    // æ˜¾ç¤ºç‰©æµé¡µé¢ï¼Œå¹¶å¼€å§‹æ¸²æŸ“
    showScreen('logistics-screen');
    await renderLogisticsView(order);
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“ç‰©æµè¯¦æƒ…é¡µé¢çš„æ‰€æœ‰å†…å®¹
 * @param {object} order - è®¢å•å¯¹è±¡
 */
async function renderLogisticsView(order) {
    const contentArea = document.getElementById('logistics-content-area');
    contentArea.innerHTML = 'åŠ è½½ä¸­...';

    const product = await db.taobaoProducts.get(order.productId);
    if (!product) {
        contentArea.innerHTML = 'æ— æ³•åŠ è½½å•†å“ä¿¡æ¯ã€‚';
        return;
    }

    // æ¸²æŸ“é¡¶éƒ¨çš„å•†å“ä¿¡æ¯å¡ç‰‡
    contentArea.innerHTML = `
        <div class="logistics-product-summary">
            <img src="${product.imageUrl}" class="product-image">
            <div class="info">
                <div class="name">${product.name} (x${order.quantity})</div>
                <div class="status" id="logistics-main-status">æŸ¥è¯¢ä¸­...</div>
            </div>
        </div>
        <div class="logistics-timeline" id="logistics-timeline-container"></div>
    `;

    const timelineContainer = document.getElementById('logistics-timeline-container');
    const mainStatusEl = document.getElementById('logistics-main-status');
    const creationTime = order.timestamp; // ä½¿ç”¨è®¢å•çš„åˆ›å»ºæ—¶é—´ä½œä¸ºèµ·ç‚¹

    // å‡†å¤‡ä¸€äº›éšæœºåŸå¸‚åï¼Œè®©ç‰©æµçœ‹èµ·æ¥æ›´çœŸå®
    const cities = ["ä¸œè", "å¹¿å·", "é•¿æ²™", "æ­¦æ±‰", "éƒ‘å·", "åŒ—äº¬", "ä¸Šæµ·", "æˆéƒ½", "è¥¿å®‰"];
    const startCity = getRandomItem(cities);
    let nextCity = getRandomItem(cities.filter(c => c !== startCity));
    const userCity = getRandomItem(cities.filter(c => c !== startCity && c !== nextCity)) || 'æ‚¨çš„åŸå¸‚';
    
    // --- è¿™å°±æ˜¯æ¨¡æ‹Ÿç‰©æµçš„æ ¸å¿ƒ ---
    let cumulativeDelay = 0;
    logisticsTimelineTemplate.forEach(stepInfo => {
        cumulativeDelay += stepInfo.delay;
        const eventTime = creationTime + cumulativeDelay; // è®¡ç®—å‡ºè¿™ä¸ªæ­¥éª¤â€œåº”è¯¥â€å‘ç”Ÿçš„æ—¶é—´
        const now = Date.now();

        // æ›¿æ¢æ–‡æœ¬ä¸­çš„å ä½ç¬¦
        const stepText = stepInfo.text.replace(/{city}/g, startCity).replace('{next_city}', nextCity).replace('{user_city}', userCity);

        // å¦‚æœè¿™ä¸ªæ­¥éª¤çš„å‘ç”Ÿæ—¶é—´å·²ç»è¿‡å»æˆ–å°±æ˜¯ç°åœ¨
        if (now >= eventTime) {
            // å°±ç«‹å³æŠŠå®ƒæ¸²æŸ“åˆ°é¡µé¢ä¸Š
            addLogisticsStep(timelineContainer, mainStatusEl, stepText, eventTime, true);
        } else {
            // å¦åˆ™ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªâ€œæœªæ¥â€çš„æ­¥éª¤
            const delayUntilEvent = eventTime - now; // è®¡ç®—è¿˜æœ‰å¤šä¹…æ‰å‘ç”Ÿ
            // è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨æœªæ¥çš„é‚£ä¸ªæ—¶é—´ç‚¹æ‰§è¡Œ
            const timerId = setTimeout(() => {
                // æ‰§è¡Œå‰å†æ¬¡æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿˜åœç•™åœ¨ç‰©æµé¡µé¢
                if (document.getElementById('logistics-screen').classList.contains('active')) {
                    addLogisticsStep(timelineContainer, mainStatusEl, stepText, eventTime, true);
                }
            }, delayUntilEvent);
            // æŠŠè¿™ä¸ªå®šæ—¶å™¨çš„IDå­˜èµ·æ¥ï¼Œæ–¹ä¾¿ç¦»å¼€é¡µé¢æ—¶æ¸…é™¤
            logisticsUpdateTimers.push(timerId);
        }
    });

    // å¦‚æœè®¢å•åˆšåˆšåˆ›å»ºï¼Œå¯èƒ½è¿˜æ²¡æœ‰ä»»ä½•æ­¥éª¤æ»¡è¶³æ—¶é—´æ¡ä»¶ï¼Œæ­¤æ—¶æ‰‹åŠ¨æ˜¾ç¤ºç¬¬ä¸€æ¡
    if (timelineContainer.children.length === 0) {
        const firstStep = logisticsTimelineTemplate[0];
        const stepText = firstStep.text.replace(/{city}/g, startCity).replace('{next_city}', nextCity).replace('{user_city}', userCity);
        addLogisticsStep(timelineContainer, mainStatusEl, stepText, creationTime, true);
    }
}

/**
 * ã€å…¨æ–°ã€‘åœ¨æ—¶é—´è½´ä¸Šæ·»åŠ ä¸€ä¸ªç‰©æµæ­¥éª¤çš„è¾…åŠ©å‡½æ•°
 * @param {HTMLElement} container - æ—¶é—´è½´çš„DOMå®¹å™¨
 * @param {HTMLElement} mainStatusEl - é¡¶éƒ¨ä¸»çŠ¶æ€çš„DOMå…ƒç´ 
 * @param {string} text - ç‰©æµä¿¡æ¯æ–‡æœ¬
 * @param {number} timestamp - è¯¥æ­¥éª¤å‘ç”Ÿçš„æ—¶é—´æˆ³
 * @param {boolean} prepend - æ˜¯å¦æ·»åŠ åˆ°æœ€å‰é¢ï¼ˆæœ€æ–°çš„æ­¥éª¤æ”¾å‰é¢ï¼‰
 */
function addLogisticsStep(container, mainStatusEl, text, timestamp, prepend = false) {
    const stepEl = document.createElement('div');
    stepEl.className = 'logistics-step';
    stepEl.innerHTML = `
        <div class="logistics-step-content">
            <div class="status-text">${text}</div>
            <div class="timestamp">${new Date(timestamp).toLocaleString('zh-CN')}</div>
        </div>
    `;

    if (prepend) {
        container.prepend(stepEl); // æ’å…¥åˆ°æœ€å‰é¢
        mainStatusEl.textContent = text; // æ›´æ–°é¡¶éƒ¨çš„çŠ¶æ€
    } else {
        container.appendChild(stepEl);
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†è§’è‰²æ‰‹æœºé’±åŒ…ä½™é¢å’Œäº¤æ˜“è®°å½•çš„é€šç”¨å‡½æ•°
 * @param {string} charId - è¦æ›´æ–°é’±åŒ…çš„è§’è‰²ID
 * @param {number} amount - äº¤æ˜“é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
 * @param {string} description - äº¤æ˜“æè¿°
 */
async function updateCharacterPhoneBankBalance(charId, amount, description) {
    const chat = state.chats[charId];
    if (!chat || chat.isGroup) return;

    if (!chat.characterPhoneData) chat.characterPhoneData = {};
    if (!chat.characterPhoneData.bank) chat.characterPhoneData.bank = { balance: 0, transactions: [] };
    if (typeof chat.characterPhoneData.bank.balance !== 'number') chat.characterPhoneData.bank.balance = 0;

    chat.characterPhoneData.bank.balance += amount;

    const newTransaction = {
        type: amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º',
        amount: Math.abs(amount),
        description: description,
        timestamp: Date.now()
    };
    
    // è®©æœ€æ–°çš„äº¤æ˜“è®°å½•æ˜¾ç¤ºåœ¨æœ€å‰é¢
    if (!Array.isArray(chat.characterPhoneData.bank.transactions)) {
        chat.characterPhoneData.bank.transactions = [];
    }
    chat.characterPhoneData.bank.transactions.unshift(newTransaction);

    await db.chats.put(chat);
    console.log(`âœ… è§’è‰²[${chat.name}]é’±åŒ…å·²æ›´æ–°: é‡‘é¢=${amount.toFixed(2)}, æ–°ä½™é¢=${chat.characterPhoneData.bank.balance.toFixed(2)}`);
}

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€ä¸€ä¸ªå•é€‰çš„è§’è‰²é€‰æ‹©å™¨ï¼Œè®©ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªä»£ä»˜å¯¹è±¡
 * @returns {Promise<string|null>} - è¿”å›é€‰ä¸­çš„è§’è‰²IDï¼Œå¦‚æœå–æ¶ˆåˆ™è¿”å›null
 */
async function openCharSelectorForCart() {
    return new Promise(resolve => {
        // å¤ç”¨åˆ†äº«åŠŸèƒ½çš„å¼¹çª—ï¼Œå¾ˆæ–¹ä¾¿
        const modal = document.getElementById('share-target-modal');
        const listEl = document.getElementById('share-target-list');
        const titleEl = document.getElementById('share-target-modal-title');
        const confirmBtn = document.getElementById('confirm-share-target-btn');
        const cancelBtn = document.getElementById('cancel-share-target-btn');

        titleEl.textContent = 'åˆ†äº«ç»™è°ä»£ä»˜ï¼Ÿ';
        listEl.innerHTML = '';

        const singleChats = Object.values(state.chats).filter(c => !c.isGroup);

        if (singleChats.length === 0) {
            alert("ä½ è¿˜æ²¡æœ‰ä»»ä½•å¯ä»¥åˆ†äº«çš„å¥½å‹å“¦ã€‚");
            modal.classList.remove('visible');
            resolve(null);
            return;
        }

        // ä½¿ç”¨ radio å•é€‰æŒ‰é’®
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.innerHTML = `
                <input type="radio" name="cart-share-target" value="${chat.id}" id="target-${chat.id}" style="margin-right: 15px;">
                <label for="target-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        modal.classList.add('visible');

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        const cleanup = () => modal.classList.remove('visible');

        newConfirmBtn.onclick = () => {
            const selectedRadio = document.querySelector('input[name="cart-share-target"]:checked');
            if (selectedRadio) {
                cleanup();
                resolve(selectedRadio.value);
            } else {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªä»£ä»˜å¯¹è±¡ï¼");
            }
        };

        newCancelBtn.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
}

/**
 * ã€å…¨æ–°ã€‘æ¸…ç©ºæ¡ƒå®è´­ç‰©è½¦
 */
async function clearTaobaoCart() {
    await db.taobaoCart.clear();
    await renderTaobaoCart();
    updateCartBadge();
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®è´­ç‰©è½¦å†…å®¹åˆ›å»ºè®¢å•
 * @param {Array} cartItems - è´­ç‰©è½¦é¡¹ç›®æ•°ç»„
 */
async function createOrdersFromCart(cartItems) {
    if (!cartItems || cartItems.length === 0) return;
    const newOrders = cartItems.map((item, index) => ({
        productId: item.productId,
        quantity: item.quantity,
        timestamp: Date.now() + index, // é˜²æ­¢æ—¶é—´æˆ³å®Œå…¨ç›¸åŒ
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§'
    }));
    await db.taobaoOrders.bulkAdd(newOrders);
    // ç®€å•æ¨¡æ‹Ÿç‰©æµæ›´æ–°
    setTimeout(async () => {
        const ordersToUpdate = await db.taobaoOrders.where('status').equals('å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§').toArray();
        for (const order of ordersToUpdate) {
            await db.taobaoOrders.update(order.id, { status: 'å·²å‘è´§ï¼Œè¿è¾“ä¸­' });
        }
    }, 1000 * 10);
}

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ•´å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ handleShareCart å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°æ€»å…¥å£ | å·²ä¿®å¤å¤‡æ³¨åã€‘å¤„ç†â€œåˆ†äº«ç»™Taä»£ä»˜â€çš„å…¨éƒ¨é€»è¾‘
 */
async function handleShareCart() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ ç‚¹å®è´å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return;

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    cartItems.forEach((item, index) => {
        const product = products[index];
        if (product) {
            totalPrice += product.price * item.quantity;
        }
    });

    const charBalance = char.characterPhoneData?.bank?.balance || 0;
    if (charBalance < totalPrice) {
        await showCustomAlert("ä»£ä»˜å¤±è´¥", `â€œ${char.name}â€çš„é’±åŒ…ä½™é¢ä¸è¶³ï¼\néœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†ä½™é¢åªæœ‰ Â¥${charBalance.toFixed(2)}ã€‚`);
        return;
    }
    
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤ä»£ä»˜',
        `å°†åˆ†äº«è´­ç‰©è½¦ç»™â€œ${char.name}â€å¹¶è¯·æ±‚ä»£ä»˜ï¼Œå…±è®¡ Â¥${totalPrice.toFixed(2)}ã€‚\nè¿™å°†ä¼šæ¸…ç©ºä½ çš„è´­ç‰©è½¦ï¼Œå¹¶ä»Taçš„é’±åŒ…æ‰£æ¬¾ã€‚ç¡®å®šå—ï¼Ÿ`,
        { confirmText: 'ç¡®å®š' }
    );

    if (!confirmed) return;
    
    await showCustomAlert("å¤„ç†ä¸­...", "æ­£åœ¨é€šçŸ¥Taä»£ä»˜å¹¶ä¸‹å•...");
    
    // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æœ¬æ¬¡çš„æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼ ---

    // 1. è·å–è§’è‰²çš„æ‰‹æœºæ•°æ®ï¼Œå‡†å¤‡æŸ¥æ‰¾å¤‡æ³¨å
    const characterPhoneData = char.characterPhoneData || { chats: {} };
    
    // 2. åœ¨è§’è‰²çš„è”ç³»äººä¸­ï¼Œæ‰¾åˆ°ä»£è¡¨â€œç”¨æˆ·â€çš„é‚£ä¸ªè”ç³»äººå¯¹è±¡
    //    ï¼ˆé€šå¸¸æ˜¯é‚£ä¸ªæ²¡æœ‰èŠå¤©è®°å½•çš„ç‰¹æ®Šè”ç³»äººæ¡ç›®ï¼‰
    const userContactInData = Object.values(characterPhoneData.chats || {}).find(c => !c.history || c.history.length === 0);
    
    // 3. è·å–è§’è‰²ç»™ç”¨æˆ·çš„å¤‡æ³¨åï¼Œå¦‚æœæ²¡è®¾ç½®ï¼Œå°±é»˜è®¤ç”¨â€œæˆ‘â€
    const remarkForUser = userContactInData ? userContactInData.remarkName : 'æˆ‘';
    
    // 4. ä½¿ç”¨è¿™ä¸ªæ–°çš„å¤‡æ³¨åæ¥åˆ›å»ºäº¤æ˜“è®°å½•
    const description = `ä¸ºâ€œ${remarkForUser}â€çš„æ¡ƒå®è´­ç‰©è½¦ä¹°å•`;
    await updateCharacterPhoneBankBalance(targetChatId, -totalPrice, description);
    
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

    await createOrdersFromCart(cartItems);

    const itemsSummary = products.map((p, i) => `${p.name} x${cartItems[i].quantity}`).join('ã€ ');
    
    // ç»™AIçœ‹çš„éšè—æŒ‡ä»¤ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšä¸ä½ åˆ†äº«äº†TAçš„è´­ç‰©è½¦ï¼Œå¹¶è¯·æ±‚ä½ ä¸ºæ€»ä»·ä¸º Â¥${totalPrice.toFixed(2)} çš„å•†å“ä»˜æ¬¾ã€‚ä½ å·²ç»åŒæ„å¹¶æ”¯ä»˜äº†ï¼Œä½ çš„é’±åŒ…ä½™é¢å·²è¢«æ‰£é™¤ã€‚å•†å“åŒ…æ‹¬ï¼š${itemsSummary}ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å¯¹æ­¤ä½œå‡ºå›åº”ï¼Œä¾‹å¦‚è¡¨ç¤ºå® æººã€æŠ±æ€¨èŠ±é’±å¤ªå¤šæˆ–è€…è¯¢é—®ä¹°äº†ä»€ä¹ˆã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    char.history.push(hiddenMessage);
    await db.chats.put(char);

    await clearTaobaoCart();

    await showCustomAlert("æ“ä½œæˆåŠŸ", `â€œ${char.name}â€å·²æˆåŠŸä¸ºä½ ä¹°å•ï¼`);
    renderChatList();
    
    openChat(targetChatId); // è·³è½¬åˆ°èŠå¤©ç•Œé¢
    triggerAiResponse(); // è®©AIå›åº”è¿™æ¬¡ä»£ä»˜
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸¤å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†â€œä¸ºTaè´­ä¹°â€çš„å…¨éƒ¨é€»è¾‘
 */
async function handleBuyForChar() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ ç‚¹å®è´å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return; // ç”¨æˆ·å–æ¶ˆé€‰æ‹©

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    products.forEach((product, index) => {
        if (product) {
            totalPrice += product.price * cartItems[index].quantity;
        }
    });

    // æ£€æŸ¥ç”¨æˆ·ä½™é¢
    if ((state.globalSettings.userBalance || 0) < totalPrice) {
        alert(`ä½™é¢ä¸è¶³ï¼æœ¬æ¬¡éœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†ä½ çš„ä½™é¢åªæœ‰ Â¥${(state.globalSettings.userBalance || 0).toFixed(2)}ã€‚`);
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤èµ é€',
        `ç¡®å®šè¦èŠ±è´¹ Â¥${totalPrice.toFixed(2)} ä¸ºâ€œ${char.name}â€è´­ä¹°è´­ç‰©è½¦ä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ`,
        { confirmText: 'ä¸ºTaä¹°å•' }
    );

    if (confirmed) {
        await showCustomAlert("æ­£åœ¨å¤„ç†...", "æ­£åœ¨ä¸ºä½ å¿ƒçˆ±çš„Taä¸‹å•...");

        // 1. æ‰£é™¤ç”¨æˆ·ä½™é¢
        await updateUserBalanceAndLogTransaction(-totalPrice, `ä¸º ${char.name} è´­ä¹°å•†å“`);
        
        // 2. å°†è´­ç‰©è½¦å†…å®¹è½¬åŒ–ä¸ºè®¢å•ï¼ˆè®°å½•åœ¨ä½ çš„è®¢å•é‡Œï¼‰
        await createOrdersFromCart(cartItems);

        // 3. å‘é€ç¤¼ç‰©é€šçŸ¥ç»™å¯¹æ–¹
        await sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice);
        
        // 4. æ¸…ç©ºè´­ç‰©è½¦
        await clearTaobaoCart();

        await showCustomAlert("èµ é€æˆåŠŸï¼", `ä½ ä¸ºâ€œ${char.name}â€è´­ä¹°çš„ç¤¼ç‰©å·²ä¸‹å•ï¼Œå¹¶å·²é€šè¿‡ç§ä¿¡é€šçŸ¥å¯¹æ–¹å•¦ï¼`);
        renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ sendGiftNotificationToChar å‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸¤å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†â€œä¸ºTaè´­ä¹°â€çš„å…¨éƒ¨é€»è¾‘
 */
async function handleBuyForChar() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ ç‚¹å®è´å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return; // ç”¨æˆ·å–æ¶ˆé€‰æ‹©

    const char = state.chats[targetChatId];
    if (!char) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    products.forEach((product, index) => {
        if (product) {
            totalPrice += product.price * cartItems[index].quantity;
        }
    });

    // æ£€æŸ¥ç”¨æˆ·ä½™é¢
    if ((state.globalSettings.userBalance || 0) < totalPrice) {
        alert(`ä½™é¢ä¸è¶³ï¼æœ¬æ¬¡éœ€è¦ Â¥${totalPrice.toFixed(2)}ï¼Œä½†ä½ çš„ä½™é¢åªæœ‰ Â¥${(state.globalSettings.userBalance || 0).toFixed(2)}ã€‚`);
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤èµ é€',
        `ç¡®å®šè¦èŠ±è´¹ Â¥${totalPrice.toFixed(2)} ä¸ºâ€œ${char.name}â€è´­ä¹°è´­ç‰©è½¦ä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ`,
        { confirmText: 'ä¸ºTaä¹°å•' }
    );

    if (confirmed) {
        await showCustomAlert("æ­£åœ¨å¤„ç†...", "æ­£åœ¨ä¸ºä½ å¿ƒçˆ±çš„Taä¸‹å•...");

        // 1. æ‰£é™¤ç”¨æˆ·ä½™é¢
        await updateUserBalanceAndLogTransaction(-totalPrice, `ä¸º ${char.name} è´­ä¹°å•†å“`);
        
        // 2. å°†è´­ç‰©è½¦å†…å®¹è½¬åŒ–ä¸ºè®¢å•ï¼ˆè®°å½•åœ¨ä½ çš„è®¢å•é‡Œï¼‰
        await createOrdersFromCart(cartItems);

        // 3. å‘é€ç¤¼ç‰©é€šçŸ¥ç»™å¯¹æ–¹
        await sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice);
        
        // 4. æ¸…ç©ºè´­ç‰©è½¦
        await clearTaobaoCart();

        await showCustomAlert("èµ é€æˆåŠŸï¼", `ä½ ä¸ºâ€œ${char.name}â€è´­ä¹°çš„ç¤¼ç‰©å·²ä¸‹å•ï¼Œå¹¶å·²é€šè¿‡ç§ä¿¡é€šçŸ¥å¯¹æ–¹å•¦ï¼`);
        renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆæ­£ç¡®ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ sendGiftNotificationToChar å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | æœ€ç»ˆæ­£ç¡®ç‰ˆã€‘å‘é€ç¤¼ç‰©é€šçŸ¥åˆ°æŒ‡å®šè§’è‰²çš„èŠå¤©
 * æ•ˆæœï¼šå‘é€ä¸€æ¡æœ¬è´¨æ˜¯æ–‡æœ¬ã€ä½†å¤–è§‚æ˜¯å¡ç‰‡çš„æ¶ˆæ¯ã€‚
 *      - ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºä¸ºæ¼‚äº®çš„ç¤¼ç‰©å¡ç‰‡ã€‚
 *      - æ¶ˆæ¯æ•°æ®ä¸­åŒ…å«å®Œæ•´çš„æ–‡æœ¬ä¿¡æ¯ã€‚
 *      - AI ä»ç„¶é€šè¿‡éšè—çš„ç³»ç»ŸæŒ‡ä»¤æ¥æ”¶ä¿¡æ¯ã€‚
 */
async function sendGiftNotificationToChar(targetChatId, products, cartItems, totalPrice) {
    const chat = state.chats[targetChatId];
    if (!chat) return;

    const itemsSummary = products.map((p, i) => `${p.name} x${cartItems[i].quantity}`).join('ã€');
    
    // 1. ã€æ ¸å¿ƒã€‘å…ˆå‡†å¤‡å¥½è¿™æ¡æ¶ˆæ¯çš„â€œæ–‡æœ¬å†…å®¹â€
    const messageTextContent = `æˆ‘ç»™ä½ ä¹°äº†æ–°ç¤¼ç‰©ï¼Œå¸Œæœ›ä½ å–œæ¬¢ï¼\nå•†å“æ¸…å•ï¼š${itemsSummary}\nåˆè®¡ï¼šÂ¥${totalPrice.toFixed(2)}`;

    // 2. åˆ›å»ºå¯¹ç”¨æˆ·ã€å¯è§ã€‘çš„æ¶ˆæ¯å¯¹è±¡ã€‚ç°åœ¨å®ƒåŒæ—¶æ‹¥æœ‰ â€œæ–‡æœ¬å†…å®¹â€ å’Œ â€œå¡ç‰‡æ ·å¼æŒ‡ä»¤â€
    const visibleMessage = {
        role: 'user',
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºè¿™æ¡æ¶ˆæ¯æ·»åŠ ä¸€ä¸ª content å±æ€§ï¼Œè¿™å°±æ˜¯å®ƒçš„â€œæ–‡æœ¬æœ¬ä½“â€
        // å½“ä½ å¤åˆ¶è¿™æ¡æ¶ˆæ¯æ—¶ï¼Œå¤åˆ¶å‡ºæ¥çš„å†…å®¹å°±æ˜¯è¿™ä¸ªã€‚
        content: messageTextContent, 
        
        // åŒæ—¶ä¿ç•™ type å’Œ payloadï¼Œå®ƒä»¬å‘Šè¯‰æ¸²æŸ“å™¨â€œæŠŠè¿™æ¡æ¶ˆæ¯ç”»æˆå¡ç‰‡â€
        type: 'gift_notification', 
        timestamp: Date.now(),
        payload: {
            senderName: state.qzoneSettings.nickname || 'æˆ‘',
            itemSummary: itemsSummary,
            totalPrice: totalPrice,
            itemCount: cartItems.length,
        }
    };
    chat.history.push(visibleMessage);

    // 3. ã€è¿™éƒ¨åˆ†ä¸å˜ã€‘åˆ›å»ºä¸€æ¡ç»™AIçœ‹çš„ã€éšè—ã€‘æŒ‡ä»¤ï¼Œç¡®ä¿AIèƒ½ç†è§£å¹¶å›åº”
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšä¸ºä½ è´­ä¹°äº†${cartItems.length}ä»¶å•†å“ï¼Œæ€»ä»·å€¼ä¸º${totalPrice.toFixed(2)}å…ƒã€‚å•†å“åŒ…æ‹¬ï¼š${itemsSummary}ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å¯¹æ­¤è¡¨ç¤ºæ„Ÿè°¢æˆ–ä½œå‡ºå…¶ä»–ååº”ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 4. ã€è¿™éƒ¨åˆ†ä¸å˜ã€‘æœªè¯»æ¶ˆæ¯åªå¢åŠ 1æ¡
    chat.unreadCount = (chat.unreadCount || 0) + 1;
    await db.chats.put(chat);
    
    // 5. ã€è¿™éƒ¨åˆ†ä¸å˜ã€‘å‘é€æ¨ªå¹…é€šçŸ¥
    if (state.activeChatId !== targetChatId) {
        showNotification(targetChatId, 'ä½ æ”¶åˆ°äº†ä¸€ä»½ç¤¼ç‰©ï¼');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è´­ç‰©è½¦ä»£ä»˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°æ€»å…¥å£ | æ— éšè—æ¶ˆæ¯ç‰ˆã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œåˆ†äº«ç»™Taä»£ä»˜â€æŒ‰é’®çš„é€»è¾‘
 */
async function handleShareCartRequest() {
    const cartItems = await db.taobaoCart.toArray();
    if (cartItems.length === 0) {
        alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åŠ ç‚¹å®è´å§ï¼");
        return;
    }

    const targetChatId = await openCharSelectorForCart();
    if (!targetChatId) return;

    const chat = state.chats[targetChatId];
    if (!chat) return;

    let totalPrice = 0;
    const productPromises = cartItems.map(item => db.taobaoProducts.get(item.productId));
    const products = await Promise.all(productPromises);
    const itemsSummary = products.map((p, i) => {
        if(p) {
            totalPrice += p.price * cartItems[i].quantity;
            return `${p.name} x${cartItems[i].quantity}`;
        }
        return '';
    }).filter(Boolean).join('ã€ ');
    
    const charBalance = chat.characterPhoneData?.bank?.balance || 0;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤ä»£ä»˜è¯·æ±‚',
        `å°†å‘â€œ${chat.name}â€å‘èµ·è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚ï¼Œå…±è®¡ Â¥${totalPrice.toFixed(2)}ã€‚`,
        { confirmText: 'å‘é€è¯·æ±‚' }
    );

    if (!confirmed) return;

    // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªåˆ›å»ºä¸€æ¡æ¶ˆæ¯ â–¼â–¼â–¼ ---
    
    // 1. ç›´æ¥å°†æ‰€æœ‰ä¿¡æ¯éƒ½æ”¾å…¥ content å­—æ®µï¼Œè®©ç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°
    const requestContent = `[è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚]
æ€»é‡‘é¢: Â¥${totalPrice.toFixed(2)}
å•†å“: ${itemsSummary}
(ä½ çš„å½“å‰ä½™é¢: Â¥${charBalance.toFixed(2)})
è¯·ä½¿ç”¨ 'cart_payment_response' æŒ‡ä»¤å›åº”ã€‚`;

    // 2. åˆ›å»ºä¸€æ¡æ™®é€šçš„ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸å†æœ‰ isHidden æ ‡è®°
    const requestMessage = {
        role: 'user', // ç”±ç”¨æˆ·å‘å‡º
        type: 'cart_share_request', // ç±»å‹ä¿æŒä¸å˜ï¼Œç”¨äºUIæ¸²æŸ“
        timestamp: Date.now(),
        content: requestContent, // å°†åŒ…å«æ‰€æœ‰ä¿¡æ¯çš„æ–‡æœ¬ä½œä¸ºå†…å®¹
        payload: { // payload ä¾ç„¶ä¿ç•™ï¼Œç”¨äºUIæ¸²æŸ“å¡ç‰‡
            totalPrice: totalPrice,
            itemCount: cartItems.length,
            status: 'pending' 
        }
    };
    
    // 3. å°†è¿™æ¡ã€å•ä¸€çš„ã€‘æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
    chat.history.push(requestMessage);

    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

    await db.chats.put(chat);
    
    await showCustomAlert("è¯·æ±‚å·²å‘é€", `å·²å°†ä»£ä»˜è¯·æ±‚å‘é€ç»™â€œ${chat.name}â€ï¼Œè¯·åœ¨èŠå¤©ä¸­æŸ¥çœ‹TAçš„å›åº”ã€‚`);
    
    openChat(targetChatId);
}


/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘æ‰“å¼€ä¸€ä¸ªå•é€‰çš„è§’è‰²é€‰æ‹©å™¨ï¼Œè®©ç”¨æˆ·é€‰æ‹©ä»£ä»˜å¯¹è±¡
 * (è¿™ä¸ªå‡½æ•°å¤ç”¨äº†åˆ†äº«åŠŸèƒ½çš„å¼¹çª—ï¼Œç¨ä½œä¿®æ”¹)
 */
async function openCharSelectorForCart() {
    return new Promise(resolve => {
        const modal = document.getElementById('share-target-modal');
        const listEl = document.getElementById('share-target-list');
        const titleEl = document.getElementById('share-target-modal-title');
        const confirmBtn = document.getElementById('confirm-share-target-btn');
        const cancelBtn = document.getElementById('cancel-share-target-btn');

        titleEl.textContent = 'åˆ†äº«ç»™è°ä»£ä»˜ï¼Ÿ';
        listEl.innerHTML = '';

        const singleChats = Object.values(state.chats).filter(c => !c.isGroup);

        if (singleChats.length === 0) {
            alert("ä½ è¿˜æ²¡æœ‰ä»»ä½•å¯ä»¥åˆ†äº«çš„å¥½å‹å“¦ã€‚");
            modal.classList.remove('visible');
            resolve(null);
            return;
        }

        // ä½¿ç”¨ radio å•é€‰æŒ‰é’®
        singleChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.innerHTML = `
                <input type="radio" name="cart-share-target" value="${chat.id}" id="target-${chat.id}" style="margin-right: 15px;">
                <label for="target-${chat.id}" style="display:flex; align-items:center; width:100%; cursor:pointer;">
                    <img src="${chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                </label>
            `;
            listEl.appendChild(item);
        });

        modal.classList.add('visible');

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        const cleanup = () => modal.classList.remove('visible');

        newConfirmBtn.onclick = () => {
            const selectedRadio = document.querySelector('input[name="cart-share-target"]:checked');
            if (selectedRadio) {
                cleanup();
                resolve(selectedRadio.value);
            } else {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªä»£ä»˜å¯¹è±¡ï¼");
            }
        };

        newCancelBtn.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘æ¸…ç©ºç”¨æˆ·çš„æ¡ƒå®è´­ç‰©è½¦
 */
async function clearTaobaoCart() {
    await db.taobaoCart.clear();
    updateCartBadge();
    // å¦‚æœç”¨æˆ·æ­£å¥½åœ¨çœ‹è´­ç‰©è½¦ï¼Œå°±åˆ·æ–°ä¸€ä¸‹
    if (document.getElementById('cart-view').classList.contains('active')) {
        renderTaobaoCart();
    }
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘æ ¹æ®è´­ç‰©è½¦å†…å®¹åˆ›å»ºè®¢å•
 * @param {Array} cartItems - ä»æ•°æ®åº“è¯»å‡ºçš„è´­ç‰©è½¦é¡¹ç›®æ•°ç»„
 */
async function createOrdersFromCart(cartItems) {
    if (!cartItems || cartItems.length === 0) return;
    const newOrders = cartItems.map((item, index) => ({
        productId: item.productId,
        quantity: item.quantity,
        timestamp: Date.now() + index, // é˜²æ­¢æ—¶é—´æˆ³å®Œå…¨ç›¸åŒ
        status: 'å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§'
    }));
    await db.taobaoOrders.bulkAdd(newOrders);
    
    // æ¨¡æ‹Ÿ10ç§’åè‡ªåŠ¨å‘è´§
    setTimeout(async () => {
        const orderIds = newOrders.map(order => order.timestamp);
        const ordersToUpdate = await db.taobaoOrders.where('timestamp').anyOf(orderIds).toArray();
        for (const order of ordersToUpdate) {
            await db.taobaoOrders.update(order.id, { status: 'å·²å‘è´§ï¼Œè¿è¾“ä¸­' });
        }
        console.log(`${ordersToUpdate.length} ä¸ªæ–°è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºâ€œå·²å‘è´§â€ã€‚`);
    }, 1000 * 10);
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

/* --- â€œæ¡ƒå®â€App åŠŸèƒ½å‡½æ•°ç»“æŸ --- */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•°ï¼Œè¯·ç²˜è´´åˆ°JSåŠŸèƒ½åŒº â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®é¡µé¢
 */
function openCharPhoneAppearanceSettings() {
    renderCharPhoneAppearanceScreen(); // æ¸²æŸ“é¡µé¢å†…å®¹
    showCharacterPhonePage('character-phone-appearance-screen'); // æ˜¾ç¤ºé¡µé¢
    loadCharPhonePresetsToDropdown();
}

/**
 * ã€å…¨æ–° | å·²ä¿®å¤ã€‘æ¸²æŸ“è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®é¡µé¢
 */
function renderCharPhoneAppearanceScreen() {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    if (!chat) return;

    // --- æ¸²æŸ“å£çº¸é¢„è§ˆ (é€»è¾‘ä¸å˜) ---
    const wallpaperPreview = document.getElementById('char-phone-wallpaper-preview');
    const wallpaperUrl = chat.characterPhoneData.wallpaper || '';
    if (wallpaperUrl) {
        wallpaperPreview.style.backgroundImage = `url(${wallpaperUrl})`;
        wallpaperPreview.textContent = '';
    } else {
        wallpaperPreview.style.backgroundImage = 'none';
        wallpaperPreview.textContent = 'æš‚æ— å£çº¸';
    }
// --- æ¸²æŸ“Appå†…å£çº¸é¢„è§ˆ ---
const appWallpaperPreview = document.getElementById('char-phone-app-wallpaper-preview');
const appWallpaperUrl = newAppWallpaperBase64 || chat.characterPhoneData.appWallpaper || '';
if (appWallpaperUrl) {
    appWallpaperPreview.style.backgroundImage = `url(${appWallpaperUrl})`;
    appWallpaperPreview.textContent = '';
} else {
    appWallpaperPreview.style.backgroundImage = 'none';
    appWallpaperPreview.textContent = 'ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ';
}
// --- Appå†…å£çº¸é¢„è§ˆæ¸²æŸ“ç»“æŸ ---
    // --- æ¸²æŸ“Appå›¾æ ‡è®¾ç½®åˆ—è¡¨ (æ ¸å¿ƒä¿®å¤) ---
    const iconGrid = document.getElementById('char-phone-icon-settings-grid');
    iconGrid.innerHTML = '';
    const customIcons = chat.characterPhoneData.appIcons || {};

    // â˜…â˜…â˜… æˆ‘ä»¬å·²ç»æŠŠé‚£è¡Œç¢äº‹çš„ `if (app.id === 'appearance') continue;` åˆ æ‰äº†ï¼â˜…â˜…â˜…
    CHAR_PHONE_APPS.forEach(app => {
        const customIconUrl = customIcons[app.id];
        // ä½¿ç”¨é»˜è®¤å›¾æ ‡ä½œä¸ºå¤‡ç”¨
        const currentIconUrl = customIconUrl || (DEFAULT_APP_ICONS[app.id] || '');
        const currentIconHtml = currentIconUrl ? `<img src="${currentIconUrl}" style="width:100%; height:100%; object-fit:cover;">` : app.svg;
        
        const itemEl = document.createElement('div');
        itemEl.className = 'icon-setting-item'; 
        itemEl.dataset.iconId = app.id; 
        itemEl.innerHTML = `
            <div class="icon-preview" style="width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; padding: 8px; background: #f0f2f5;">
                ${currentIconHtml}
            </div>
            <span style="font-size: 13px;">${app.name}</span>
            <button class="change-icon-btn" data-icon-id="${app.id}" style="padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer;">æ›´æ¢</button>
        `;
        iconGrid.appendChild(itemEl);
    });
    
    // --- æ¸²æŸ“å°ç»„ä»¶é¢„è§ˆ (é€»è¾‘ä¸å˜) ---
    const widgets = chat.characterPhoneData.widgets || {};
    const widgetPreview1 = document.getElementById('char-phone-widget-preview-1');
    const widgetPreview2 = document.getElementById('char-phone-widget-preview-2');

    if (widgets.widget1_url) {
        widgetPreview1.style.backgroundImage = `url(${widgets.widget1_url})`;
        widgetPreview1.textContent = '';
    } else {
        widgetPreview1.style.backgroundImage = 'none';
        widgetPreview1.textContent = 'ç‚¹å‡»ä¸Šä¼ ';
    }
    
    if (widgets.widget2_url) {
        widgetPreview2.style.backgroundImage = `url(${widgets.widget2_url})`;
        widgetPreview2.textContent = '';
    } else {
        widgetPreview2.style.backgroundImage = 'none';
        widgetPreview2.textContent = 'ç‚¹å‡»ä¸Šä¼ ';
    }
}



/**
 * å¤„ç†è§’è‰²æ‰‹æœºå£çº¸çš„æ›´æ¢å’Œç§»é™¤
 * @param {string} newUrl - æ–°çš„å£çº¸URLï¼Œå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™è¡¨ç¤ºç§»é™¤
 */
async function handleCharPhoneWallpaperChange(newUrl) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    chat.characterPhoneData.wallpaper = newUrl;
    await db.chats.put(chat);
    
    // ç«‹å³åº”ç”¨å£çº¸åˆ°è§’è‰²æ‰‹æœºä¸»å±å¹•
    const phoneScreen = document.getElementById('character-phone-screen');
    if (newUrl) {
        phoneScreen.style.backgroundImage = `url(${newUrl})`;
        phoneScreen.style.backgroundColor = 'transparent';
    } else {
        phoneScreen.style.backgroundImage = 'none';
        const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
        phoneScreen.style.backgroundColor = isDarkMode ? '#000' : '#f0f2f5';
    }
    
    // åˆ·æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆ
    renderCharPhoneAppearanceScreen();
    alert(newUrl ? 'å£çº¸å·²æ›´æ–°ï¼' : 'å£çº¸å·²ç§»é™¤ï¼');
}

/**
 * å¤„ç†è§’è‰²æ‰‹æœºAppå›¾æ ‡çš„æ›´æ¢
 * @param {string} iconId - è¦æ›´æ¢çš„Appçš„ID
 */
async function handleChangeCharPhoneIcon(iconId) {
    if (!activeCharacterPhoneId) return;
    
    const choice = await showChoiceModal("æ›´æ¢å›¾æ ‡", [
        { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' },
        { text: 'ğŸ”„ æ¢å¤é»˜è®¤', value: 'reset' }
    ]);

    let newIconUrl = null;

    if (choice === 'local') {
        newIconUrl = await uploadImageLocally();
    } else if (choice === 'url') {
        newIconUrl = await showCustomPrompt("å›¾æ ‡URL", "è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥");
    } else if (choice === 'reset') {
        const chat = state.chats[activeCharacterPhoneId];
        if (chat.characterPhoneData.appIcons && chat.characterPhoneData.appIcons[iconId]) {
            delete chat.characterPhoneData.appIcons[iconId];
            await db.chats.put(chat);
            renderCharPhoneAppearanceScreen();
            renderCharacterAppGrid();
            alert('å›¾æ ‡å·²æ¢å¤é»˜è®¤ã€‚');
        }
        return;
    }

    if (newIconUrl && newIconUrl.trim()) {
        const chat = state.chats[activeCharacterPhoneId];
        if (!chat.characterPhoneData.appIcons) {
            chat.characterPhoneData.appIcons = {};
        }
        chat.characterPhoneData.appIcons[iconId] = newIconUrl.trim();
        await db.chats.put(chat);
        
        renderCharPhoneAppearanceScreen(); // åˆ·æ–°è®¾ç½®é¡µé¢
        renderCharacterAppGrid(); // åˆ·æ–°ä¸»å±å¹•
        alert('å›¾æ ‡å·²æ›´æ–°ï¼');
    }
}

// â–²â–²â–² æ–°å¢å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

let currentViewingWeiboProfileId = null; // å…¨å±€å˜é‡ï¼Œè®°å½•æ­£åœ¨æŸ¥çœ‹å“ªä¸ªè§’è‰²çš„ä¸»é¡µ

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€æŒ‡å®šè§’è‰²çš„å¾®åšä¸»é¡µ
 * @param {string} charId - è¦æŸ¥çœ‹çš„è§’è‰²çš„ID
 */
async function openWeiboCharProfile(charId) {
    currentViewingWeiboProfileId = charId;
    const chat = state.chats[charId];
    if (!chat) return;

    // æ¸²æŸ“è§’è‰²ä¸»é¡µå†…å®¹
    await renderWeiboCharProfile(charId);
    
    // æ¸²æŸ“è¯¥è§’è‰²çš„å¾®åšFeed
    await renderCharSpecificFeed(charId);

    // åˆ‡æ¢åˆ°è§’è‰²ä¸»é¡µå±å¹•
    showScreen('weibo-char-profile-screen');
    
    // éšè—å…³æ³¨åˆ—è¡¨å¼¹çª—ï¼ˆå¦‚æœå®ƒè¿˜å¼€ç€ï¼‰
    document.getElementById('weibo-following-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²å¾®åšä¸»é¡µçš„ä¸ªäººèµ„æ–™éƒ¨åˆ† (V2 - æ”¯æŒç²‰ä¸/å…³æ³¨æ•°)
 * @param {string} charId - è§’è‰²çš„ID
 */
async function renderWeiboCharProfile(charId) {
    const chat = state.chats[charId];
    if (!chat) return;

    // æ¸²æŸ“åŸºç¡€ä¿¡æ¯ï¼ˆè¿™éƒ¨åˆ†ä¸å˜ï¼‰
    document.getElementById('weibo-char-profile-title').textContent = `${chat.name}çš„ä¸»é¡µ`;
    document.getElementById('weibo-char-avatar-img').src = chat.settings.weiboAvatar || chat.settings.aiAvatar;
    document.getElementById('weibo-char-nickname').textContent = chat.settings.weiboNickname || chat.name;
    document.getElementById('weibo-char-background-img').src = chat.settings.weiboBackground;
    document.getElementById('weibo-char-profession-display').textContent = chat.settings.weiboProfession || 'èŒä¸šæœªè®¾å®š';
    
    // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ â–¼â–¼â–¼ ---

    // 1. ä»è®¾ç½®ä¸­è¯»å–å…³æ³¨æ•°å’Œç²‰ä¸æ•°
    document.getElementById('weibo-char-following-count').textContent = chat.settings.weiboFollowingCount || '0';
    document.getElementById('weibo-char-fans-count').textContent = chat.settings.weiboFansCount || '0';

    // 2. åŠ¨æ€è®¡ç®—å¹¶æ˜¾ç¤ºå¾®åšæ•°
    const postCount = await db.weiboPosts.where('authorId').equals(charId).count();
    document.getElementById('weibo-char-posts-count').textContent = postCount;
    
    // --- â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–² ---

    // æ¸²æŸ“å¤´åƒæ¡† (è¿™éƒ¨åˆ†ä¸å˜)
    const frameImg = document.getElementById('weibo-char-avatar-frame');
    const frameUrl = chat.settings.weiboAvatarFrame || '';
    if (frameUrl) {
        frameImg.src = frameUrl;
        frameImg.style.display = 'block';
    } else {
        frameImg.style.display = 'none';
    }
}


/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“æŒ‡å®šè§’è‰²çš„å¾®åšFeed
 * @param {string} charId - è§’è‰²çš„ID
 */
async function renderCharSpecificFeed(charId) {
    const feedEl = document.getElementById('char-weibo-feed-list');
    feedEl.innerHTML = '';
    
    const posts = await db.weiboPosts.where('authorId').equals(charId).reverse().sortBy('timestamp');
    
    if (posts.length === 0) {
        feedEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Ta è¿˜æ²¡æœ‰å‘è¿‡å¾®åšå“¦ã€‚</p>';
        return;
    }

    posts.forEach(post => {
        // å¤ç”¨æˆ‘ä»¬å¼ºå¤§çš„å¾®åšå¸–å­åˆ›å»ºå‡½æ•°
        feedEl.appendChild(createWeiboPostElement(post));
    });
}

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€è§’è‰²å¾®åšèµ„æ–™çš„ç¼–è¾‘å™¨
 */
async function openCharWeiboEditor() {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // å¡«å……å½“å‰æ•°æ®åˆ°ç¼–è¾‘å™¨
    document.getElementById('char-weibo-editor-avatar-preview').src = chat.settings.weiboAvatar || chat.settings.aiAvatar;
    document.getElementById('char-weibo-editor-nickname-input').value = chat.settings.weiboNickname || chat.name;
    document.getElementById('char-weibo-editor-bg-preview').src = chat.settings.weiboBackground;

    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('char-weibo-editor-modal').classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘ä¿å­˜å¯¹è§’è‰²å¾®åšèµ„æ–™çš„ä¿®æ”¹
 */
async function saveCharWeiboProfile() {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // ä»ç¼–è¾‘å™¨è·å–æ–°æ•°æ®
    chat.settings.weiboAvatar = document.getElementById('char-weibo-editor-avatar-preview').src;
    chat.settings.weiboNickname = document.getElementById('char-weibo-editor-nickname-input').value.trim();
    chat.settings.weiboBackground = document.getElementById('char-weibo-editor-bg-preview').src;

    // ä¿å­˜åˆ°æ•°æ®åº“
    await db.chats.put(chat);
    
    // åˆ·æ–°ä¸»é¡µæ˜¾ç¤º
    await renderWeiboCharProfile(currentViewingWeiboProfileId);
    
    document.getElementById('char-weibo-editor-modal').classList.remove('visible');
    alert('è§’è‰²å¾®åšèµ„æ–™å·²ä¿å­˜ï¼');
}

// â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ const db = ... çš„æ­£ä¸Šæ–¹ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®è§’è‰²äººè®¾å’ŒèŒä¸šï¼Œç”Ÿæˆåˆå§‹çš„å¾®åšå…³æ³¨æ•°å’Œç²‰ä¸æ•°
 * @param {object} chat - è§’è‰²çš„èŠå¤©å¯¹è±¡
 * @returns {{following: string, fans: string}}
 */
function getInitialWeiboStats(chat) {
    const persona = (chat.settings.aiPersona || '') + (chat.settings.weiboProfession || '');
    const keywords = ["å¶åƒ", "æ˜æ˜Ÿ", "æ¼”å‘˜", "æ­Œæ‰‹", "åšä¸»", "ç½‘çº¢", "UPä¸»", "ä¸»æ’­", "é€‰æ‰‹", "ç”»å®¶", "ä½œå®¶"];
    const isPublicFigure = keywords.some(keyword => persona.includes(keyword));

    let fansCount, followingCount;

    if (isPublicFigure) {
        fansCount = Math.floor(100000 + Math.random() * 9900000); // 10ä¸‡ - 1000ä¸‡
        followingCount = Math.floor(50 + Math.random() * 450); // 50 - 500
    } else {
        fansCount = Math.floor(100 + Math.random() * 4900); // 100 - 5000
        followingCount = Math.floor(50 + Math.random() * 250); // 50 - 300
    }

    return {
        fans: formatNumberToChinese(fansCount),
        following: formatNumberToChinese(followingCount)
    };
}

/**
 * ã€å…¨æ–°ã€‘å°†æ•°å­—æ ¼å¼åŒ–ä¸ºå¸¦â€œä¸‡â€æˆ–â€œäº¿â€çš„å­—ç¬¦ä¸²
 * @param {number} num - åŸå§‹æ•°å­—
 * @returns {string} - æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
 */
function formatNumberToChinese(num) {
    if (num >= 100000000) {
        return (num / 100000000).toFixed(1).replace(/\.0$/, '') + 'äº¿';
    }
    if (num >= 10000) {
        return (num / 10000).toFixed(1).replace(/\.0$/, '') + 'ä¸‡';
    }
    return String(num);
}

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ playMinimaxAudio å‡½æ•° â–¼â–¼â–¼
let isIntentionalStop = false;
// â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šæ·»åŠ æˆ–æ›¿æ¢è¿™ä¸¤è¡Œä»£ç  â–¼â–¼â–¼
let isTtsPlaying = false; // å…¨å±€é”ï¼Œtrueè¡¨ç¤ºæœ‰è¯­éŸ³æ­£åœ¨æ’­æ”¾æˆ–åŠ è½½
let currentTtsAudioBubble = null; // è®°å½•å½“å‰æ­£åœ¨æ’­æ”¾åŠ¨ç”»æˆ–éŸ³é¢‘çš„æ°”æ³¡å…ƒç´ 
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™ä¸ªã€å…¨æ–°çš„ã€‘è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æŸ¥æ‰¾ä»æŒ‡å®šä½ç½®å¼€å§‹çš„æ‰€æœ‰è¿ç»­AIè¯­éŸ³æ¶ˆæ¯
 * @param {Array} history - å®Œæ•´çš„èŠå¤©å†å²è®°å½•æ•°ç»„
 * @param {number} startIndex - å¼€å§‹æŸ¥æ‰¾çš„ç´¢å¼•ä½ç½®
 * @returns {Array} - ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿ç»­AIè¯­éŸ³æ¶ˆæ¯å¯¹è±¡çš„æ•°ç»„
 */
function findConsecutiveAiVoiceMessages(history, startIndex) {
    const messagesToPlay = [];
    if (startIndex < 0 || startIndex >= history.length) {
        return messagesToPlay;
    }

    // ä»ç‚¹å‡»çš„é‚£æ¡æ¶ˆæ¯å¼€å§‹ï¼Œå‘åéå†
    for (let i = startIndex; i < history.length; i++) {
        const msg = history[i];
        // æ£€æŸ¥è¿™æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯AIå‘é€çš„ï¼Œå¹¶ä¸”ç±»å‹æ˜¯è¯­éŸ³
        if (msg.role === 'assistant' && msg.type === 'voice_message') {
            messagesToPlay.push(msg); // å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒåŠ å…¥å¾…æ’­æ”¾åˆ—è¡¨
        } else {
            // ä¸€æ—¦é‡åˆ°ä¸æ˜¯AIè¯­éŸ³çš„æ¶ˆæ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·çš„å›å¤ï¼Œæˆ–AIçš„å›¾ç‰‡/æ–‡å­—æ¶ˆæ¯ï¼‰ï¼Œå°±ç«‹åˆ»åœæ­¢æŸ¥æ‰¾
            break;
        }
    }
    return messagesToPlay;
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨è¿™é‡Œç²˜è´´è¿™ä¸ªã€å…¨æ–°çš„ã€‘åœæ­¢å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç¬¬2æ­¥ï¼šç”¨è¿™æ•´å—ã€V2 - ç²¾å‡†åœæ­¢ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ stopMinimaxAudio å‡½æ•° â–¼â–¼â–¼

/**
 * ã€V2 - ç²¾å‡†åœæ­¢ç‰ˆã€‘åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„Minimax TTSè¯­éŸ³
 */
function stopMinimaxAudio() {
    if (!isTtsPlaying) return;

    // æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨æ‰§è¡Œåœæ­¢æ“ä½œå‰ï¼Œå…ˆè®¾ç½®â€œæ•…æ„åœæ­¢â€çš„æ ‡å¿—ä¸º true
    isIntentionalStop = true;

    const ttsPlayer = document.getElementById('tts-audio-player');
    ttsPlayer.pause();
    ttsPlayer.src = ''; // è¿™è¡Œä»£ç ä¼šè§¦å‘ onerror äº‹ä»¶

    if (window.currentAnimatingBubbles) {
        window.currentAnimatingBubbles.forEach(b => b.classList.remove('playing'));
    }

    isTtsPlaying = false;
    currentTtsAudioBubble = null;
    window.currentAnimatingBubbles = null;
    console.log('Minimax TTS: Playback stopped by user.');

    // æ ¸å¿ƒä¿®æ”¹2ï¼šç”¨ä¸€ä¸ªå¾®å°çš„å»¶è¿Ÿæ¥é‡ç½®æ ‡å¿—ä½
    // è¿™èƒ½ç¡®ä¿ onerror äº‹ä»¶æœ‰è¶³å¤Ÿçš„æ—¶é—´æ£€æŸ¥åˆ°æ ‡å¿—ä½ï¼Œç„¶åå†å°†å…¶é‡ç½®
    setTimeout(() => {
        isIntentionalStop = false;
    }, 100);
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–¼â–¼â–¼ ç¬¬3æ­¥ï¼šç”¨è¿™æ•´å—ã€V8 - é”™è¯¯å¤„ç†ç»ˆæç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ playMinimaxAudio å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ playMinimaxAudio å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V9 - å…¨å±€æ¨¡å‹ç‰ˆã€‘è°ƒç”¨ Minimax TTS API ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾
 * @param {string} text - è¦è½¬æ¢ä¸ºè¯­éŸ³çš„åˆå¹¶åçš„æ–‡æœ¬
 * @param {string} voiceId - Minimax çš„è¯­éŸ³ ID
 * @param {Array<HTMLElement>} bubblesToAnimate - éœ€è¦æ’­æ”¾åŠ¨ç”»çš„æ‰€æœ‰è¯­éŸ³æ°”æ³¡å…ƒç´ çš„æ•°ç»„
 */
async function playMinimaxAudio(text, voiceId, bubblesToAnimate) {
    stopMinimaxAudio();
    await new Promise(resolve => setTimeout(resolve, 50));

    const ttsPlayer = document.getElementById('tts-audio-player');
    const firstBubble = bubblesToAnimate[0];

    isTtsPlaying = true;
    currentTtsAudioBubble = firstBubble;
    window.currentAnimatingBubbles = bubblesToAnimate;
    bubblesToAnimate.forEach(b => b.classList.add('playing'));

    const mainAudioPlayer = document.getElementById('audio-player');
    if (mainAudioPlayer && !mainAudioPlayer.paused) {
        mainAudioPlayer.pause();
        musicState.isPlaying = false;
        updatePlayerUI();
    }

    const groupId = state.apiConfig.minimaxGroupId;
    const apiKey = state.apiConfig.minimaxApiKey;
    if (!groupId || !apiKey) {
        await showCustomAlert('è¯­éŸ³æ’­æ”¾å¤±è´¥', 'å°šæœªé…ç½®Minimaxçš„Group IDå’ŒAPI Keyã€‚');
        stopMinimaxAudio();
        return;
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä»å…¨å±€ apiConfig è·å–è¯­éŸ³æ¨¡å‹ â˜…â˜…â˜…
    const speechModel = state.apiConfig.minimaxSpeechModel || 'speech-01';
    console.log(`æ­£åœ¨ä½¿ç”¨ Minimax è¯­éŸ³æ¨¡å‹: ${speechModel}`);

    try {
        const response = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${groupId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                text: text, 
                voice_id: voiceId, 
                model: speechModel, // â˜…â˜…â˜… ä½¿ç”¨æˆ‘ä»¬è·å–åˆ°çš„æ¨¡å‹å˜é‡ â˜…â˜…â˜…
                speed: 1.0, 
                pitch: 0, 
                timber_list: [] 
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Minimax API é”™è¯¯: ${errorData.base_resp?.status_msg || response.statusText}`);
        }
        const contentType = response.headers.get('Content-Type');
        if (!contentType || !contentType.startsWith('audio/')) {
            const errorData = await response.json().catch(() => response.text());
            throw new Error(`Minimax API æœªè¿”å›æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ï¼Œè€Œæ˜¯è¿”å›äº†: ${JSON.stringify(errorData)}`);
        }
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        ttsPlayer.src = audioUrl;
        
        const cleanupAndReset = () => {
            if (isTtsPlaying) {
                isTtsPlaying = false;
                URL.revokeObjectURL(audioUrl); 
                if (window.currentAnimatingBubbles) {
                    window.currentAnimatingBubbles.forEach(b => b.classList.remove('playing'));
                }
                currentTtsAudioBubble = null;
                window.currentAnimatingBubbles = null;
            }
        };

       ttsPlayer.onended = cleanupAndReset;
        
        ttsPlayer.onerror = (e) => {
             if (!isIntentionalStop) {
                 console.error("TTSéŸ³é¢‘æ’­æ”¾æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºæ–‡æœ¬æ˜¾ç¤º:", e);
             } else {
                 console.log("Intentional stop triggered error event, alert skipped.");
             }
             cleanupAndReset();
        };

        await ttsPlayer.play();

    } catch (error) {
        console.error("Minimax TTS è°ƒç”¨å¤±è´¥:", error);
        await showCustomAlert('è¯­éŸ³åˆæˆå¤±è´¥', `é”™è¯¯ä¿¡æ¯: ${error.message}`);
        stopMinimaxAudio();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * å¯ç”¨æˆ–ç¦ç”¨è§’è‰²æ‰‹æœºé¢„è®¾ç®¡ç†æŒ‰é’®
 * @param {boolean} isEnabled - æ˜¯å¦å¯ç”¨
 */
function toggleCharPhonePresetButtons(isEnabled) {
    document.getElementById('apply-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('update-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('rename-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('delete-char-phone-preset-btn').disabled = !isEnabled;
    document.getElementById('export-char-phone-preset-btn').disabled = !isEnabled;
}

/**
 * åŠ è½½è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åˆ°ä¸‹æ‹‰æ¡†
 */
async function loadCharPhonePresetsToDropdown() {
    const selector = document.getElementById('char-phone-preset-selector');
    if (!selector) return;
    selector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
    const presets = await db.charPhonePresets.toArray();
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selector.appendChild(option);
    });
    activeCharPhonePresetId = null;
    toggleCharPhonePresetButtons(false);
}

/**
 * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
 */
function handleCharPhonePresetSelection() {
    const selector = document.getElementById('char-phone-preset-selector');
    activeCharPhonePresetId = selector.value ? parseInt(selector.value) : null;
    toggleCharPhonePresetButtons(!!activeCharPhonePresetId);
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ applySelectedCharPhonePreset å‡½æ•° â–¼â–¼â–¼
async function applySelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) {
        alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„é¢„è®¾ã€‚");
        return;
    }
    if (!activeCharacterPhoneId) {
        alert("é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°å½“å‰æ­£åœ¨æ“ä½œçš„è§’è‰²æ‰‹æœºã€‚");
        return;
    }
    const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const chat = state.chats[activeCharacterPhoneId];

    if (preset && preset.data && chat) {
        // å°†é¢„è®¾æ•°æ®æ·±æ‹·è´ä¸€ä»½ï¼Œåº”ç”¨åˆ°è§’è‰²çš„æ‰‹æœºæ•°æ®ä¸Š
        chat.characterPhoneData.wallpaper = preset.data.wallpaper || '';
        chat.characterPhoneData.appIcons = { ...DEFAULT_APP_ICONS, ...(preset.data.appIcons || {}) };
        chat.characterPhoneData.widgets = { ...(preset.data.widgets || {}) };
        
        // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„ä¸€è¡Œï¼â˜…â˜…â˜…
        chat.characterPhoneData.appWallpaper = preset.data.appWallpaper || '';

        await db.chats.put(chat);
        
        // åˆ·æ–°æ‰‹æœºç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤–è§‚
        openCharacterPhone(activeCharacterPhoneId);
        
        // åˆ·æ–°å¤–è§‚è®¾ç½®é¡µé¢ï¼Œä»¥ä¾¿é¢„è§ˆå’Œæ•°æ®åŒæ­¥
        renderCharPhoneAppearanceScreen();

        alert(`å·²æˆåŠŸä¸ºâ€œ${chat.name}â€åº”ç”¨é¢„è®¾: "${preset.name}"ï¼`);
    } else {
        alert("åº”ç”¨é¢„è®¾å¤±è´¥ï¼Œæ‰¾ä¸åˆ°é¢„è®¾æˆ–è§’è‰²æ•°æ®ã€‚");
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ä¿å­˜å½“å‰è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
 */
async function saveCurrentCharPhonePreset() {
    if (!activeCharacterPhoneId) return;

    const presetName = await showCustomPrompt("ä¿å­˜é¢„è®¾", "è¯·ä¸ºè¿™ä¸ªå¤–è§‚æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š");
    if (!presetName || !presetName.trim()) {
        if (presetName !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    const chat = state.chats[activeCharacterPhoneId];
    // ä»å½“å‰è§’è‰²çš„æ•°æ®ä¸­æå–å¤–è§‚è®¾ç½®
    const presetData = {
        wallpaper: chat.characterPhoneData.wallpaper || '',
        appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
        widgets: { ...(chat.characterPhoneData.widgets || {}) },
        appWallpaper: chat.characterPhoneData.appWallpaper || '',
    };

    await db.charPhonePresets.add({ name: presetName.trim(), data: presetData });
    await loadCharPhonePresetsToDropdown();
    alert(`å¤–è§‚é¢„è®¾ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
}

/**
 * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
 */
async function updateSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId || !activeCharacterPhoneId) return;

    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    if (!currentPreset) return;

    const confirmed = await showCustomConfirm(
        "ç¡®è®¤æ›´æ–°",
        `ç¡®å®šè¦ç”¨å½“å‰æ‰‹æœºçš„å¤–è§‚è¦†ç›–é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeCharacterPhoneId];
        const presetData = {
            wallpaper: chat.characterPhoneData.wallpaper || '',
            appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
            widgets: { ...(chat.characterPhoneData.widgets || {}) },
            appWallpaper: chat.characterPhoneData.appWallpaper || '',
        };
        await db.charPhonePresets.update(activeCharPhonePresetId, { data: presetData });
        await showCustomAlert('æˆåŠŸ', `é¢„è®¾ "${currentPreset.name}" å·²æ›´æ–°ï¼`);
    }
}

/**
 * é‡å‘½åé€‰ä¸­çš„é¢„è®¾
 */
async function renameSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const newName = await showCustomPrompt("é‡å‘½å", "è¯·è¾“å…¥æ–°çš„åç§°ï¼š", currentPreset.name);
    if (newName && newName.trim()) {
        await db.charPhonePresets.update(activeCharPhonePresetId, { name: newName.trim() });
        await loadCharPhonePresetsToDropdown();
        document.getElementById('char-phone-preset-selector').value = activeCharPhonePresetId;
        alert("é‡å‘½åæˆåŠŸï¼");
    }
}

/**
 * åˆ é™¤é€‰ä¸­çš„é¢„è®¾
 */
async function deleteSelectedCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const currentPreset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.charPhonePresets.delete(activeCharPhonePresetId);
        await loadCharPhonePresetsToDropdown();
        alert("é¢„è®¾å·²åˆ é™¤ã€‚");
    }
}

/**
 * å¯¼å‡ºé€‰ä¸­çš„é¢„è®¾
 */
async function exportCharPhonePreset() {
    if (!activeCharPhonePresetId) return;
    const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
    const blob = new Blob([JSON.stringify(preset, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `[CharPhone]${preset.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * å¯¼å…¥é¢„è®¾æ–‡ä»¶
 */
function importCharPhonePreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.name && data.data) {
                await db.charPhonePresets.add({ name: `${data.name} (å¯¼å…¥)`, data: data.data });
                await loadCharPhonePresetsToDropdown();
                alert(`é¢„è®¾ "${data.name}" å¯¼å…¥æˆåŠŸï¼`);
            } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch (error) {
            alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

/**
 * [å…¨æ–°] åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appçš„åç§°è®¾ç½®é¡¹
 */
function renderAppNameSettings() {
    const grid = document.getElementById('icon-rename-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = state.globalSettings.appLabels || {};

    // éå†é»˜è®¤æ ‡ç­¾å¯¹è±¡ï¼Œä»¥ç¡®ä¿æ‰€æœ‰appéƒ½æœ‰è®¾ç½®é¡¹
    for (const appId in DEFAULT_APP_LABELS) {
        if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
            const defaultName = DEFAULT_APP_LABELS[appId];
            const currentName = appLabels[appId] || defaultName;

            const item = document.createElement('div');
            item.className = 'form-group';
            item.style.marginBottom = '0'; // è®©å¸ƒå±€æ›´ç´§å‡‘
            item.innerHTML = `
                <label for="rename-input-${appId}">${defaultName}</label>
                <input type="text" id="rename-input-${appId}" class="app-rename-input" data-appid="${appId}" value="${currentName}">
            `;
            grid.appendChild(item);
        }
    }
}

/**
 * [å…¨æ–°] å°†ä¿å­˜çš„Appåç§°åº”ç”¨åˆ°ä¸»å±å¹•çš„å›¾æ ‡ä¸Š
 */
function applyAppLabels() {
    const appLabels = state.globalSettings.appLabels || {};
    
    for (const appId in DEFAULT_APP_LABELS) {
        if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
            const defaultName = DEFAULT_APP_LABELS[appId];
            const customName = appLabels[appId] || defaultName;

            // è¿™ä¸ªé€‰æ‹©å™¨ä¼šåŒæ—¶æ‰¾åˆ°ä¸»å±å¹•å’ŒDockæ ä¸Šçš„æ‰€æœ‰å›¾æ ‡
            const icons = document.querySelectorAll(`.desktop-app-icon [id="icon-img-${appId}"]`);
            
            icons.forEach(iconImg => {
                const appIconContainer = iconImg.closest('.desktop-app-icon');
                if (appIconContainer) {
                    const labelElement = appIconContainer.querySelector('.label');
                    if (labelElement) {
                        labelElement.textContent = customName;
                    }
                }
            });
        }
    }
}

/**
 * [å…¨æ–°] ä»è¾“å…¥æ¡†è¯»å–å¹¶ä¿å­˜ç”¨æˆ·ä¿®æ”¹çš„Appåç§°
 */
function saveAppLabels() {
    const appNameInputs = document.querySelectorAll('.app-rename-input');
    if (!state.globalSettings.appLabels) {
        state.globalSettings.appLabels = {};
    }

    appNameInputs.forEach(input => {
        const appId = input.dataset.appid;
        const newName = input.value.trim();
        const defaultName = DEFAULT_APP_LABELS[appId];

        // å¦‚æœç”¨æˆ·è¾“å…¥äº†æ–°åå­—ï¼Œä¸”å’Œé»˜è®¤åå­—ä¸ä¸€æ ·ï¼Œå°±ä¿å­˜
        if (newName && newName !== defaultName) {
            state.globalSettings.appLabels[appId] = newName;
        } else {
            // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†è¾“å…¥æ¡†ï¼Œæˆ–è€…æ”¹å›äº†é»˜è®¤åå­—ï¼Œå°±åˆ é™¤ä¿å­˜è®°å½•ï¼Œä»¥æ¢å¤é»˜è®¤
            delete state.globalSettings.appLabels[appId];
        }
    });
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€å…¨æ–°ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ handleImportSillyTavernWorldBook å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | å·²ä¿®å¤ã€‘å¤„ç†å¯¼å…¥çš„SillyTavernä¸–ç•Œä¹¦æ–‡ä»¶
 * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„JSONæ–‡ä»¶
 */
async function handleImportSillyTavernWorldBook(file) {
    // ä½¿ç”¨FileReaderæ¥è¯»å–æ–‡ä»¶å†…å®¹
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const text = e.target.result;
            const data = JSON.parse(text);

            // éªŒè¯æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿åŒ…å«'entries'å¯¹è±¡
            if (!data.entries || typeof data.entries !== 'object') {
                throw new Error("æ–‡ä»¶æ ¼å¼æ— æ•ˆã€‚SillyTavernä¸–ç•Œä¹¦åº”åŒ…å«'entries'å¯¹è±¡ã€‚");
            }

            // ä»æ–‡ä»¶åæå–åç§°ï¼Œä½œä¸ºæ–°çš„åˆ†ç±»å
            let categoryName = file.name.replace(/\.(json|jsonl)$/i, '').trim();
            if (!categoryName) categoryName = 'å¯¼å…¥çš„ä¸–ç•Œä¹¦';

            // æ£€æŸ¥è¯¥åˆ†ç±»æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            let category = await db.worldBookCategories.where('name').equals(categoryName).first();
            if (!category) {
                const newCategoryId = await db.worldBookCategories.add({ name: categoryName });
                category = { id: newCategoryId, name: categoryName };
                console.log(`åˆ›å»ºäº†æ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»: ${categoryName} (ID: ${newCategoryId})`);
            } else {
                console.log(`å°†æ¡ç›®æ·»åŠ åˆ°å·²å­˜åœ¨çš„åˆ†ç±»: ${categoryName} (ID: ${category.id})`);
            }

            const newBooks = [];
            // éå†SillyTavern worldbookä¸­çš„æ‰€æœ‰æ¡ç›®
            for (const key in data.entries) {
                const entry = data.entries[key];
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤äº† !entry.disable çš„æ£€æŸ¥ï¼Œç°åœ¨ä¼šå¯¼å…¥æ‰€æœ‰æ¡ç›® â˜…â˜…â˜…
                if (entry) { 
                    // ä½¿ç”¨entry.commentä½œä¸ºä¹¦åï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨"æ¡ç›® key"ä½œä¸ºå¤‡ç”¨
                    const entryName = (entry.comment || `æ¡ç›® ${key}`).trim();
                    const entryContent = (entry.content || '').trim();
                    // ç¡®ä¿ä¹¦åå’Œå†…å®¹éƒ½ä¸ä¸ºç©º
                    if (entryName && entryContent) {
                        newBooks.push({
                            id: 'wb_' + Date.now() + Math.random(), // åˆ›å»ºå”¯ä¸€ID
                            name: entryName,
                            content: entryContent,
                            categoryId: category.id // å½’å±åˆ°æ–°çš„åˆ†ç±»
                        });
                    }
                }
            }

            if (newBooks.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯å¯¼å…¥çš„æœ‰æ•ˆæ¡ç›®ã€‚');
                return;
            }
            
            // æ‰¹é‡å°†æ–°ä¹¦æ·»åŠ åˆ°æ•°æ®åº“ï¼Œæ•ˆç‡æ›´é«˜
            await db.worldBooks.bulkAdd(newBooks);
            // æ›´æ–°å†…å­˜ä¸­çš„stateï¼Œä»¥ä¾¿UIèƒ½ç«‹å³åˆ·æ–°
            state.worldBooks.push(...newBooks); 

            // é‡æ–°æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°å†…å®¹
            await renderWorldBookScreen();
            await showCustomAlert('å¯¼å…¥æˆåŠŸ', `æˆåŠŸå°†ã€Š${categoryName}ã€‹ä¸­çš„ ${newBooks.length} ä¸ªæ¡ç›®å¯¼å…¥åˆ°ä¸–ç•Œä¹¦ï¼`);

        } catch (error) {
            console.error("å¯¼å…¥ä¸–ç•Œä¹¦å¤±è´¥:", error);
            await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ— æ³•è§£ææ–‡ä»¶ï¼Œè¯·ç¡®ä¿å®ƒæ˜¯æœ‰æ•ˆçš„SillyTavernä¸–ç•Œä¹¦JSONæ–‡ä»¶ã€‚\n\né”™è¯¯: ${error.message}`);
        }
    };
    // ä»¥UTF-8ç¼–ç è¯»å–æ–‡ä»¶å†…å®¹
    reader.readAsText(file, 'UTF-8');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°èƒŒæ™¯æ›´æ¢åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œæ›´æ¢èƒŒæ™¯â€æŒ‰é’®æ—¶ï¼Œå¼¹å‡ºæ“ä½œèœå•
 */
async function handleInnerVoiceBgChange() {
    const choice = await showChoiceModal("æ›´æ¢å¿ƒå£°èƒŒæ™¯", [
        { text: 'ä¸Šä¼ æ–°èƒŒæ™¯', value: 'upload' },
        { text: 'æ¢å¤é»˜è®¤', value: 'reset' }
    ]);

    if (choice === 'upload') {
        // è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
        document.getElementById('inner-voice-bg-input').click();
    } else if (choice === 'reset') {
        // è°ƒç”¨ä¿å­˜å‡½æ•°å¹¶ä¼ å…¥ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ¢å¤é»˜è®¤
        await saveInnerVoiceBackground('');
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V2 - è§’è‰²ç‹¬ç«‹ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ saveInnerVoiceBackground å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V2ã€‘ä¿å­˜æ–°çš„èƒŒæ™¯å›¾ç‰‡URLåˆ°ã€å½“å‰è§’è‰²ã€‘
 * @param {string} url - å›¾ç‰‡çš„URL (å¯ä»¥æ˜¯ç½‘ç»œé“¾æ¥æˆ–Base64)
 */
async function saveInnerVoiceBackground(url) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†èƒŒæ™¯URLä¿å­˜åœ¨å½“å‰è§’è‰²çš„æ•°æ®ä¸­
    chat.innerVoiceBackground = url;

    // 2. å°†æ›´æ–°åçš„æ•´ä¸ª chat å¯¹è±¡ä¿å­˜å›æ•°æ®åº“
    await db.chats.put(chat);

    // 3. ç«‹å³åº”ç”¨æ–°çš„èƒŒæ™¯
    applyInnerVoiceBackground(url);

    // 4. ç»™ç”¨æˆ·ä¸€ä¸ªåé¦ˆ
    alert(url ? 'å½“å‰è§’è‰²èƒŒæ™¯å·²æ›´æ–°ï¼' : 'å½“å‰è§’è‰²èƒŒæ™¯å·²æ¢å¤é»˜è®¤ã€‚');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * å°†æŒ‡å®šçš„èƒŒæ™¯å›¾åº”ç”¨åˆ°å¿ƒå£°é¢æ¿ä¸Š
 * @param {string} url - å›¾ç‰‡çš„URL
 */
function applyInnerVoiceBackground(url) {
    const panel = document.getElementById('inner-voice-main-panel');
    if (!panel) return;

    if (url) {
        panel.style.backgroundImage = `url(${url})`;
    } else {
        // å¦‚æœURLä¸ºç©ºï¼Œå°±ç§»é™¤èƒŒæ™¯å›¾ï¼Œæ¢å¤CSSä¸­å®šä¹‰çš„é»˜è®¤æ ·å¼
        panel.style.backgroundImage = 'none';
    }
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

/**
 * [å…¨æ–°] ä¼°ç®—æ–‡æœ¬çš„Tokenæ•° (æŒ‰å­—ç¬¦æ•°è®¡ç®—)
 * @param {string} text - è¦è®¡ç®—çš„æ–‡æœ¬
 * @returns {number} - ä¼°ç®—çš„tokenæ•°
 */
function calculateTokenCount(text) {
    if (!text) return 0;
    // è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ä¼°ç®—ï¼Œç›´æ¥è¿”å›å­—ç¬¦æ•°ã€‚
    // å¯¹äºä¸­æ–‡ï¼Œä¸€ä¸ªå­—çº¦ç­‰äº1-2ä¸ªtokenã€‚å¯¹äºè‹±æ–‡ï¼Œä¸€ä¸ªè¯çº¦ç­‰äº1.3ä¸ªtokenã€‚
    // ç›´æ¥ç”¨å­—ç¬¦æ•°ä½œä¸ºä¸€ä¸ªç®€å•ç›´è§‚çš„å‚è€ƒå€¼ã€‚
    return text.length;
}
/**
 * [å…¨æ–°] ä¸ºTokenè®¡ç®—å‡†å¤‡å®Œæ•´çš„ä¸Šä¸‹æ–‡å’Œæç¤ºè¯
 * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
 * @returns {Promise<string>} - æ‹¼æ¥å¥½çš„ã€å°†è¦å‘é€ç»™AIçš„å®Œæ•´æ–‡æœ¬
 */
async function getContextForTokenCalculation(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return '';

    let combinedText = '';
    const settings = chat.settings;

    // 1. æ·»åŠ æ ¸å¿ƒæç¤ºè¯ (äººè®¾)
    if(chat.isGroup) {
        const membersList = chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n');
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        combinedText += `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAI... # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾\n${membersList}\n# ç”¨æˆ·çš„è§’è‰²\n- **${myNickname}**: ${chat.settings.myPersona}`;
    } else {
        combinedText += chat.settings.aiPersona || '';
        combinedText += chat.settings.myPersona || '';
    }

    // 2. æ·»åŠ ä¸–ç•Œä¹¦å†…å®¹
    if (settings.linkedWorldBookIds && settings.linkedWorldBookIds.length > 0) {
        const linkedContents = settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook ? worldBook.content : '';
        }).join('\n');
        combinedText += linkedContents;
    }
    
    // 3. æ·»åŠ æ‰€æœ‰æ€»ç»“ä½œä¸ºé•¿æœŸè®°å¿†
    const summaryContext = chat.history.filter(msg => msg.type === 'summary').map(s => s.content).join('\n');
    combinedText += summaryContext;

    // 4. æ·»åŠ æœ€è¿‘çš„å¯¹è¯è®°å½• (ä¸Šä¸‹æ–‡è®°å¿†)
    const history = chat.history.filter(msg => !msg.isHidden);
    const memoryDepth = settings.maxMemory || 10;
    const contextMessages = history.slice(-memoryDepth);

    const messageText = contextMessages.map(msg => {
        let content = '';
        if (typeof msg.content === 'string') {
            content = msg.content;
        } else if (Array.isArray(msg.content)) {
            content = '[å›¾ç‰‡]'; // å°†å›¾ç‰‡ç®€åŒ–ä¸ºå ä½ç¬¦
        } else if (msg.type) {
            content = `[${msg.type}]`;
        }
        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : (msg.senderName || chat.name);
        return `${sender}: ${content}`;
    }).join('\n');

    combinedText += '\n' + messageText;
    
    return combinedText;
}
/**
 * ã€å…¨æ–°ã€‘æ¸…ç†æ‰€æœ‰ä¸å·²åˆ é™¤è§’è‰²å…³è”çš„å¤±æ•ˆæ•°æ®
 */
async function clearOrphanedData() {
    // 1. åœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰ï¼Œå…ˆå¼¹çª—å‘ç”¨æˆ·ç¡®è®¤
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç†',
        'æ­¤æ“ä½œå°†æ‰«æå¹¶åˆ é™¤æ‰€æœ‰ä¸ã€å·²ä¸å­˜åœ¨çš„è§’è‰²ã€‘å…³è”çš„æ•°æ®ï¼ˆå¦‚åŠ¨æ€ã€å¾®åšã€å›å¿†ã€é€šè¯è®°å½•ç­‰ï¼‰ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' } // ä½¿ç”¨é†’ç›®çš„çº¢è‰²æŒ‰é’®
    );

    // å¦‚æœç”¨æˆ·ç‚¹äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ç›´æ¥é€€å‡º
    if (!confirmed) return;

    // æ˜¾ç¤ºä¸€ä¸ªâ€œå¤„ç†ä¸­â€çš„æç¤ºï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºç¨‹åºå¡æ­»
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ‰«æå¹¶æ¸…ç†å¤±æ•ˆæ•°æ®...");

    try {
        let totalDeletedCount = 0;

        // 2. è·å–æ‰€æœ‰ä»ç„¶å­˜åœ¨çš„ã€æœ‰æ•ˆçš„è§’è‰²IDåˆ—è¡¨
        const validChatIds = new Set((await db.chats.toArray()).map(c => c.id));
        validChatIds.add('user'); // 'user' (å³â€œæˆ‘â€) æ°¸è¿œæ˜¯æœ‰æ•ˆçš„ä½œè€…

        // 3. å®šä¹‰æˆ‘ä»¬éœ€è¦æ£€æŸ¥çš„æ•°æ®åº“è¡¨å’Œå®ƒä»¬ç”¨æ¥å…³è”è§’è‰²IDçš„å­—æ®µå
        const tablesToCheck = [
            { name: 'qzonePosts', idField: 'authorId', typeName: 'åŠ¨æ€' },
            { name: 'weiboPosts', idField: 'authorId', typeName: 'å¾®åš' },
            { name: 'memories', idField: 'chatId', typeName: 'å›å¿†/çº¦å®š' },
            { name: 'callRecords', idField: 'chatId', typeName: 'é€šè¯è®°å½•' }
        ];

        // 4. éå†æ¯ä¸€ä¸ªéœ€è¦æ£€æŸ¥çš„è¡¨
        for (const tableInfo of tablesToCheck) {
            const table = db[tableInfo.name];
            const allItems = await table.toArray();
            
            // æ‰¾å‡ºæ‰€æœ‰ä½œè€…IDå·²ç»ä¸å­˜åœ¨çš„â€œå­¤å„¿â€æ•°æ®
            const idsToDelete = allItems
                .filter(item => !validChatIds.has(item[tableInfo.idField]))
                .map(item => item.id);

            // å¦‚æœæ‰¾åˆ°äº†éœ€è¦åˆ é™¤çš„æ•°æ®
            if (idsToDelete.length > 0) {
                await table.bulkDelete(idsToDelete); // æ‰¹é‡åˆ é™¤ï¼Œæ•ˆç‡æ›´é«˜
                console.log(`ä» ${tableInfo.name} è¡¨ä¸­æ¸…é™¤äº† ${idsToDelete.length} æ¡å¤±æ•ˆæ•°æ®ã€‚`);
                totalDeletedCount += idsToDelete.length;
            }
        }

        // 5. æ ¹æ®æ¸…ç†ç»“æœï¼Œç»™ç”¨æˆ·æœ€ç»ˆçš„åé¦ˆ
        if (totalDeletedCount > 0) {
            await showCustomAlert('æ¸…ç†å®Œæˆ', `å·²æˆåŠŸæ¸…ç† ${totalDeletedCount} æ¡å¤±æ•ˆæ•°æ®ï¼`);
        } else {
            await showCustomAlert('æ‰«æå®Œæˆ', 'æœªå‘ç°ä»»ä½•å¯æ¸…ç†çš„å¤±æ•ˆæ•°æ®ã€‚');
        }

    } catch (error) {
        console.error("æ¸…ç†å¤±æ•ˆæ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†å–æ¶ˆæƒ…ä¾£ç©ºé—´
 */
async function handleCancelLoversSpace() {
    if (!activeLoversSpaceCharId) return;
    const confirmed = await showCustomConfirm(
        'å–æ¶ˆæƒ…ä¾£ç©ºé—´',
        'ç¡®å®šè¦å–æ¶ˆæƒ…ä¾£ç©ºé—´å—ï¼Ÿè¿™ä¼šä½¿ç©ºé—´å˜ä¸ºæœªå¯ç”¨çŠ¶æ€ï¼Œä½†æ‰€æœ‰æ•°æ®ï¼ˆè¯´è¯´ã€ç…§ç‰‡ç­‰ï¼‰éƒ½ä¼šè¢«ä¿ç•™ã€‚æ­¤æ“ä½œä¸ä¼šé€šçŸ¥å¯¹æ–¹ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[activeLoversSpaceCharId];
        if (chat && chat.loversSpaceData) {
            // å°†æƒ…ä¾£ç©ºé—´æ•°æ®è®¾ç½®ä¸ºnullï¼Œå³å¯ç¦ç”¨å®ƒ
            chat.loversSpaceData = null;
            await db.chats.put(chat);
            document.getElementById('ls-settings-modal').classList.remove('visible');
            alert('æƒ…ä¾£ç©ºé—´å·²å–æ¶ˆã€‚');
            // è¿”å›åˆ°èŠå¤©åˆ—è¡¨ä¸»å±å¹•
            showScreen('chat-list-screen');
        }
    }
}

// â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleDisconnectLoversSpace å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šç”¨è¿™å—ã€æœ€ç»ˆåŒæ¶ˆæ¯ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleDisconnectLoversSpace å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æœ€ç»ˆç‰ˆ | è§£é™¤å¡ç‰‡+ç³»ç»Ÿé€šçŸ¥ã€‘å¤„ç†è§£é™¤æƒ…ä¾£å…³ç³»
 */
async function handleDisconnectLoversSpace() {
    if (!activeLoversSpaceCharId) return;
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    const confirmed = await showCustomConfirm(
        'è§£é™¤å…³ç³»',
        `ç¡®å®šè¦ä¸â€œ${chat.name}â€è§£é™¤å…³ç³»å—ï¼Ÿæƒ…ä¾£ç©ºé—´å°†è¢«å–æ¶ˆï¼Œå¹¶ä¸”å¯¹æ–¹ä¼šæ”¶åˆ°é€šçŸ¥å¹¶å¯¹æ­¤å‘è¡¨æ„è§ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // 1. ç¦ç”¨ç©ºé—´
        chat.loversSpaceData = null;

        // 2. ã€æ ¸å¿ƒæ–°å¢1ã€‘åˆ›å»ºæ‚¨å‘å‡ºçš„ã€åœ¨å³ä¾§çš„â€œè§£é™¤å¡ç‰‡â€
        const userDisconnectCardMessage = {
            role: 'user',                       
            type: 'lovers_space_disconnect',    // ä¸€ä¸ªæ–°ç±»å‹ï¼Œç”¨äºæ¸²æŸ“å¡ç‰‡
            content: `æƒ…ä¾£ç©ºé—´å·²è§£é™¤`,           // å¡ç‰‡åº•å±‚å¯ç¼–è¾‘çš„æ–‡å­—
            timestamp: Date.now()
        };
        chat.history.push(userDisconnectCardMessage);

        // 3. ã€æ ¸å¿ƒæ–°å¢2ã€‘åˆ›å»ºå±…ä¸­çš„ã€ç°è‰²çš„â€œç³»ç»Ÿé€šçŸ¥â€
        const systemNotification = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
            content: `ä½ å’Œ ${chat.name} çš„æƒ…ä¾£ç©ºé—´å·²è§£é™¤`,
            timestamp: Date.now() + 1 // æ—¶é—´æˆ³+1ç¡®ä¿åœ¨å¡ç‰‡ä¹‹å
        };
        chat.history.push(systemNotification);

        // 4. ã€ä¿ç•™ã€‘ç»™AIçœ‹çš„éšè—æŒ‡ä»¤ï¼Œå®Œå…¨ä¸å˜
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†ä¸ä½ çš„æƒ…ä¾£å…³ç³»ã€‚]`,
            timestamp: Date.now() + 2, // æ—¶é—´æˆ³å†+1
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);

        // 5. ä¿å­˜ã€å…³é—­å¼¹çª—ã€è·³è½¬ã€è§¦å‘å›åº”
        await db.chats.put(chat);
        document.getElementById('ls-settings-modal').classList.remove('visible');
        document.getElementById('lovers-space-screen').classList.remove('visible');
        
        openChat(activeLoversSpaceCharId);
        
        alert('å…³ç³»å·²è§£é™¤ï¼Œå¯¹æ–¹å·²çŸ¥æ™“ã€‚');
        triggerAiResponse();
    }
}
// â–²â–²â–² ç¬¬1æ­¥æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç¬¬1æ­¥ï¼šåœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€æ‰‹åŠ¨æ€»ç»“çš„æ¨¡å¼é€‰æ‹©å¼¹çª—
 */
async function openManualSummaryOptions() {
    const choice = await showChoiceModal(
        'æ‰‹åŠ¨æ€»ç»“',
        [
            { text: 'æ€»ç»“æœ€æ–°å†…å®¹', value: 'latest' },
            { text: 'æ€»ç»“æŒ‡å®šèŒƒå›´', value: 'range' }
        ]
    );

    if (choice === 'latest') {
        // ç”¨æˆ·é€‰æ‹©æ€»ç»“æœ€æ–°ï¼Œè°ƒç”¨ä¸»å‡½æ•°å¹¶ä¼ å…¥'latest'æ¨¡å¼
        await triggerManualSummaryNow('latest');
    } else if (choice === 'range') {
        // ç”¨æˆ·é€‰æ‹©æ€»ç»“èŒƒå›´ï¼Œè°ƒç”¨èŒƒå›´è¾“å…¥å‡½æ•°
        await promptForSummaryRange();
    }
}

/**
 * ã€å…¨æ–°ã€‘æç¤ºç”¨æˆ·è¾“å…¥è¦æ€»ç»“çš„æ¶ˆæ¯èŒƒå›´
 */
async function promptForSummaryRange() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const totalMessages = chat.history.length;
    if (totalMessages === 0) {
        alert("èŠå¤©è®°å½•ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œæ€»ç»“ã€‚");
        return;
    }

    // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥å¼€å§‹åºå·
    const startStr = await showCustomPrompt('æŒ‡å®šèŒƒå›´', `è¯·è¾“å…¥å¼€å§‹çš„æ¶ˆæ¯åºå· (1 - ${totalMessages})`, '1', 'number');
    if (startStr === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ

    const startNum = parseInt(startStr);
    if (isNaN(startNum) || startNum < 1 || startNum > totalMessages) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¼€å§‹åºå·ã€‚");
        return;
    }

    // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥ç»“æŸåºå·
    const endStr = await showCustomPrompt('æŒ‡å®šèŒƒå›´', `è¯·è¾“å…¥ç»“æŸçš„æ¶ˆæ¯åºå· (${startNum} - ${totalMessages})`, totalMessages, 'number');
    if (endStr === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ

    const endNum = parseInt(endStr);
    if (isNaN(endNum) || endNum < startNum || endNum > totalMessages) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç»“æŸåºå·ã€‚");
        return;
    }

    // è°ƒç”¨ä¸»å‡½æ•°å¹¶ä¼ å…¥'range'æ¨¡å¼å’Œå…·ä½“çš„èŒƒå›´
    await triggerManualSummaryNow('range', { start: startNum, end: endNum });
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯Userè‡ªå·±çš„ç§ä¿¡åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€Userçš„ç§ä¿¡åˆ—è¡¨
 */
async function openUserDmListScreen() {
    const settings = state.qzoneSettings || {};
    // å¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆè¿‡ç§ä¿¡ï¼Œå°±å…ˆè®©AIç”Ÿæˆ
    if (!settings.userDms || settings.userDms.length === 0) {
        await generateUserDms();
    } else {
        // å¦‚æœå·²ç»æœ‰äº†ï¼Œå°±ç›´æ¥æ¸²æŸ“
        renderUserDmList(settings.userDms);
    }
    showScreen('user-dm-list-screen');
}

/**
 * ã€AIæ ¸å¿ƒ V4 - å·²å¢åŠ åˆå§‹ç²‰ä¸æ•°é‡ã€‘è°ƒç”¨AIä¸ºUserç”Ÿæˆä¸€æ‰¹ç²‰ä¸ç§ä¿¡
 */
async function generateUserDms(isAddingMore = false) {
    const settings = state.qzoneSettings;
    const { proxyUrl, apiKey, model } = state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆé…ç½®APIï¼');
        return;
    }

    if (!isAddingMore && settings.userDms && settings.userDms.length > 0) {
        const confirmed = await showCustomConfirm(
            'é‡æ–°ç”Ÿæˆ',
            'å·²æœ‰ç§ä¿¡è®°å½•ã€‚é‡æ–°ç”Ÿæˆå°†è¦†ç›–ç°æœ‰æ‰€æœ‰ç§ä¿¡ï¼Œç¡®å®šå—ï¼Ÿ',
            { confirmButtonClass: 'btn-danger' }
        );
        if (!confirmed) return;
    }

    const alertMessage = isAddingMore ? "æ­£åœ¨å¬å”¤æ–°ç²‰ä¸..." : "AIæ­£åœ¨ä¸ºä½ æ¨¡æ‹Ÿç²‰ä¸ç§ä¿¡...";
    await showCustomAlert("è¯·ç¨å€™...", alertMessage);

    const userPersona = `
# ç”¨æˆ·ä¿¡æ¯ (è¿™æ˜¯ä½ ç§ä¿¡çš„å¯¹è±¡ï¼Œè¯·ä»”ç»†é˜…è¯»)
- ä½ çš„å¾®åšæ˜µç§°: ${settings.weiboNickname || settings.nickname}
- ä½ çš„å¾®åšèŒä¸š: ${settings.weiboUserProfession || 'æœªè®¾å®š'}
- ä½ çš„éšè—äººè®¾ (ç²‰ä¸çœ‹ä¸åˆ°ï¼Œä½†ä¼šå½±å“ä»–ä»¬å¯¹ä½ çš„æ€åº¦): ${settings.weiboUserPersona || 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚'}
`;

    const existingDmsContext = (isAddingMore && settings.userDms)
        ? `# å·²æœ‰ç§ä¿¡ (ä¾›ä½ å‚è€ƒï¼Œè¯·ç”Ÿæˆå…¨æ–°çš„å¯¹è¯)\n${JSON.stringify(settings.userDms.slice(-5))}`
        : '';

    // --- â–¼â–¼â–¼ ä¿®æ”¹ç‚¹1ï¼šå¢åŠ ç²‰ä¸æ•°é‡ â–¼â–¼â–¼ ---
    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„â€œå¾®åšç”Ÿæ€æ¨¡æ‹Ÿå™¨â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„å¾®åšäººè®¾ï¼Œè™šæ„ä¸€ä¸ªåŒ…å«${isAddingMore ? '3-4' : '5-8'}ä½ä¸åŒç²‰ä¸/è·¯äººçš„ç§ä¿¡åˆ—è¡¨ï¼Œå¹¶ä¸ºæ¯ä½ç²‰ä¸åˆ›ä½œä¸€æ®µã€ä»–ä»¬å•æ–¹é¢å‘é€ç»™ç”¨æˆ·çš„ã€‘ç§ä¿¡å†…å®¹ã€‚
${userPersona}
${existingDmsContext}

# æ ¸å¿ƒè§„åˆ™
1.  **ç²‰ä¸å¤šæ ·æ€§**: åˆ›ä½œ${isAddingMore ? '3-4' : '5-8'}ä½ä¸åŒç±»å‹çš„ç²‰ä¸ã€‚ä»–ä»¬çš„ç§ä¿¡å†…å®¹å’Œè¯­æ°”ã€å¿…é¡»ã€‘ä¸ä»–ä»¬çš„èº«ä»½ä»¥åŠã€ç”¨æˆ·çš„å¾®åšäººè®¾ã€‘é«˜åº¦ç›¸å…³ã€‚
2.  **ã€ã€ã€å¯¹è¯å•å‘æ€§é“å¾‹ã€‘ã€‘ã€‘**: ä½ ç”Ÿæˆçš„å¯¹è¯ã€åªèƒ½åŒ…å«ç²‰ä¸å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯ã€‘ã€‚ç»å¯¹ä¸è¦æ¨¡æ‹Ÿç”¨æˆ·çš„å›å¤ã€‚
3.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥ '[' å¼€å¤´ï¼Œä»¥ ']' ç»“å°¾ã€‚
4.  **éšæœºå¤´åƒ**: ä¸ºæ¯ä½ç²‰ä¸ä»ä¸‹æ–¹å¤´åƒæ± ä¸­éšæœºæŒ‘é€‰ä¸€ä¸ªURLã€‚

# JSONå¯¹è±¡ç»“æ„ (é‡è¦ï¼šmessagesæ•°ç»„é‡Œåªèƒ½æœ‰senderä¸º"fan"çš„å¯¹è±¡ï¼)
{
  "fanName": "ç²‰ä¸çš„å¾®åšæ˜µç§°",
  "fanPersona": "å¯¹è¿™ä½ç²‰ä¸çš„ç®€å•æè¿° (ä¾‹å¦‚: 'ä¸€ä¸ªæ‹…å¿ƒå“¥å“¥äº‹ä¸šçš„å¦ˆå¦ˆç²‰')",
  "fanAvatarUrl": "ä»å¤´åƒæ± ä¸­é€‰æ‹©çš„URL",
  "messages": [
    { "sender": "fan", "text": "è¿™æ˜¯ç²‰ä¸å‘æ¥çš„ç¬¬ä¸€æ¡æ¶ˆæ¯..." },
    { "sender": "fan", "text": "è¿™æ˜¯ç²‰ä¸ç´§æ¥ç€å‘çš„ç¬¬äºŒæ¡æ¶ˆæ¯ï¼Œå› ä¸ºè¿˜æ²¡æ”¶åˆ°å›å¤..." }
  ]
}

# å¤´åƒæ±  (fanAvatarUrl å¿…é¡»ä»ä»¥ä¸‹é“¾æ¥ä¸­é€‰æ‹©ä¸€ä¸ª)
- https://i.postimg.cc/PxZrFFFL/o-o-1.jpg
- https://i.postimg.cc/Qd0Y537F/com-xingin-xhs-20251011153800.png
ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆã€åªæœ‰ç²‰ä¸å‘è¨€ã€‘çš„ç§ä¿¡åˆ—è¡¨ã€‚`;
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---
    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);

        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: parseFloat(state.apiConfig.temperature) || 0.8, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        const newDmsData = JSON.parse(cleanedContent);

        if (Array.isArray(newDmsData)) {
            newDmsData.forEach((convo, index) => {
                if (!convo.fanAvatarUrl) {
                    const fanAvatars = ['https://i.postimg.cc/PxZrFFFL/o-o-1.jpg', 'https://i.postimg.cc/Qd0Y537F/com-xingin-xhs-20251011153800.png'];
                    convo.fanAvatarUrl = fanAvatars[index % fanAvatars.length];
                }
            });

            if (isAddingMore) {
                settings.userDms.push(...newDmsData);
            } else {
                settings.userDms = newDmsData;
            }
            await saveQzoneSettings();
            renderUserDmList(settings.userDms);
            
            await showCustomAlert('ç”ŸæˆæˆåŠŸ', `${isAddingMore ? 'æ–°çš„ç§ä¿¡å·²æ·»åŠ ï¼' : 'ç²‰ä¸ç§ä¿¡å·²ç”Ÿæˆï¼'}`);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„ã€‚");
        }
    } catch (error) {
        console.error("ç”ŸæˆUserç§ä¿¡å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}


/**
 * ã€å·²å¢å¼ºã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œè§¦å‘AIå›åº”â€æŒ‰é’®
 */
async function handleTriggerUserDmAiReply() {
    if (currentUserDmFanIndex === null) return;
    
    const convo = state.qzoneSettings.userDms[currentUserDmFanIndex];
    if (!convo) return;
    
    const inputEl = document.getElementById('user-dm-input');
    inputEl.placeholder = "ç­‰å¾…å¯¹æ–¹å›å¤ä¸­...";
    inputEl.disabled = true;

    const aiResponse = await triggerUserDmAiReply(convo);
    if (aiResponse && aiResponse.length > 0) {
        // â–¼â–¼â–¼ ä¿®æ”¹ç‚¹4ï¼šä½¿ç”¨ ... å±•å¼€æ•°ç»„ â–¼â–¼â–¼
        convo.messages.push(...aiResponse);
        await saveQzoneSettings();
        renderUserDmDetail(convo);
        renderUserDmList(state.qzoneSettings.userDms);
    }
    
    inputEl.placeholder = "å’Œç²‰ä¸èŠç‚¹ä»€ä¹ˆ...";
    inputEl.disabled = false;
    inputEl.focus();
}


/**
 * ã€å·²å¢å¼ºã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œé‡Rollâ€æŒ‰é’®
 */
async function handleUserDmReroll() {
    if (currentUserDmFanIndex === null) return;
    
    const convo = state.qzoneSettings.userDms[currentUserDmFanIndex];
    if (!convo || convo.messages.length === 0) return;

    let lastMessageIndex = convo.messages.length - 1;
    
    // å¾ªç¯å‘å‰æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯
    while (lastMessageIndex >= 0 && convo.messages[lastMessageIndex].sender === 'char') {
        lastMessageIndex--;
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ç²‰ä¸çš„æ¶ˆæ¯ï¼Œæˆ–è€…å…¨æ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œåˆ™æç¤º
    if (lastMessageIndex < 0 || convo.messages[lastMessageIndex].sender !== 'fan') {
        alert("åªèƒ½å¯¹ç²‰ä¸çš„æœ€æ–°å›å¤ä½¿ç”¨é‡RollåŠŸèƒ½å“¦ã€‚");
        return;
    }

    // ä»æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªç²‰ä¸æ¶ˆæ¯å¼€å§‹ï¼Œåˆ é™¤ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
    convo.messages.splice(lastMessageIndex);
    
    renderUserDmDetail(convo);
    
    const inputEl = document.getElementById('user-dm-input');
    inputEl.placeholder = "æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...";
    inputEl.disabled = true;
    
    const aiResponse = await triggerUserDmAiReply(convo);
    if (aiResponse && aiResponse.length > 0) {
         // â–¼â–¼â–¼ ä¿®æ”¹ç‚¹5ï¼šä½¿ç”¨ ... å±•å¼€æ•°ç»„ â–¼â–¼â–¼
        convo.messages.push(...aiResponse);
        renderUserDmDetail(convo);
    }

    await saveQzoneSettings();
    renderUserDmList(state.qzoneSettings.userDms);

    inputEl.placeholder = "å’Œç²‰ä¸èŠç‚¹ä»€ä¹ˆ...";
    inputEl.disabled = false;
    inputEl.focus();
}


/**
 * ã€V2-å·²æ·»åŠ å·¦æ»‘åˆ é™¤ã€‘æ¸²æŸ“Userçš„ç§ä¿¡åˆ—è¡¨
 */
function renderUserDmList(dmsData) {
    const listEl = document.getElementById('user-dm-list-container');
    listEl.innerHTML = '';

    if (!dmsData || dmsData.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•ç§ä¿¡å“¦</p>';
        return;
    }

    dmsData.forEach((convo, index) => {
        const lastMsg = convo.messages[convo.messages.length - 1];
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆ›å»ºæ»‘åŠ¨å®¹å™¨å’Œæ“ä½œæŒ‰é’® â˜…â˜…â˜…
        const swipeContainer = document.createElement('div');
        swipeContainer.className = 'user-dm-list-item-swipe-container';

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'user-dm-list-item-content';
        contentWrapper.innerHTML = `
            <div class="dm-list-item" data-fan-index="${index}">
                <img src="${convo.fanAvatarUrl}" class="dm-avatar">
                <div class="dm-info">
                    <div class="dm-name-line">
                        <span class="dm-name">${convo.fanName}</span>
                        <span class="dm-persona-tag">${convo.fanPersona}</span>
                    </div>
                    <div class="dm-last-msg">${lastMsg.sender === 'char' ? 'ä½ : ' : ''}${lastMsg.text}</div>
                </div>
            </div>
        `;
        
        const actionsWrapper = document.createElement('div');
        actionsWrapper.className = 'user-dm-swipe-actions';
        actionsWrapper.innerHTML = `<button class="swipe-action-btn delete" data-fan-index="${index}">åˆ é™¤</button>`;

        swipeContainer.appendChild(contentWrapper);
        swipeContainer.appendChild(actionsWrapper);
        listEl.appendChild(swipeContainer);
    });
}
/**
 * ã€å…¨æ–°ã€‘å¤„ç†åˆ é™¤å•æ¡ç”¨æˆ·ç§ä¿¡çš„é€»è¾‘
 */
async function handleDeleteUserDmMessage(fanIndex, messageIndex) {
    if (fanIndex === null || messageIndex === null) return;
    
    const settings = state.qzoneSettings;
    const conversation = settings.userDms[fanIndex];
    if (!conversation) return;

    const messageText = conversation.messages[messageIndex].text.substring(0, 30);
    const confirmed = await showCustomConfirm('åˆ é™¤ç§ä¿¡', `ç¡®å®šè¦åˆ é™¤è¿™æ¡ç§ä¿¡å—ï¼Ÿ\n\nâ€œ${messageText}...â€`, { confirmButtonClass: 'btn-danger' });

    if (confirmed) {
        conversation.messages.splice(messageIndex, 1);

        if (conversation.messages.length === 0) {
            // å¦‚æœè¿™æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™åˆ é™¤æ•´ä¸ªå¯¹è¯
            settings.userDms.splice(fanIndex, 1);
            await saveQzoneSettings();
            renderUserDmList(settings.userDms);
            showScreen('user-dm-list-screen'); // è¿”å›åˆ°åˆ—è¡¨é¡µ
        } else {
            // å¦åˆ™åªæ›´æ–°å½“å‰å¯¹è¯
            await saveQzoneSettings();
            renderUserDmDetail(conversation);
        }
        alert('ç§ä¿¡å·²åˆ é™¤ã€‚');
    }
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†åˆ é™¤æ•´ä¸ªç”¨æˆ·ç§ä¿¡å¯¹è¯çš„é€»è¾‘
 */
async function handleDeleteUserDmConversation(fanIndex) {
    const settings = state.qzoneSettings;
    const conversation = settings.userDms[fanIndex];
    if (!conversation) return;

    const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸â€œ${conversation.fanName}â€çš„å…¨éƒ¨å¯¹è¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        settings.userDms.splice(fanIndex, 1);
        await saveQzoneSettings();
        renderUserDmList(settings.userDms);
        alert('å¯¹è¯å·²åˆ é™¤ã€‚');
    } else {
        // å¦‚æœå–æ¶ˆï¼Œåˆ™æŠŠæ»‘å—æ”¶å›å»
        const swipedContent = document.querySelector(`.user-dm-list-item-content.swiped`);
        if (swipedContent) swipedContent.classList.remove('swiped');
    }
}


/**
 * æ‰“å¼€ä¸æŸä¸ªç²‰ä¸çš„ç§ä¿¡è¯¦æƒ…é¡µ
 */
function openUserDmDetail(fanIndex) {
    currentUserDmFanIndex = fanIndex;
    const convo = state.qzoneSettings.userDms[fanIndex];
    if (!convo) return;
    
    renderUserDmDetail(convo);
    showScreen('user-dm-detail-screen');
}

/**
 * ã€V2-å·²æ·»åŠ åˆ é™¤æŒ‰é’®ã€‘æ¸²æŸ“ç§ä¿¡è¯¦æƒ…é¡µçš„å…·ä½“å†…å®¹
 */
function renderUserDmDetail(conversation) {
    const messagesEl = document.getElementById('user-dm-messages-container');
    const titleEl = document.getElementById('user-dm-detail-title');
    messagesEl.innerHTML = '';
    titleEl.textContent = conversation.fanName;
    
    const userAvatar = state.qzoneSettings.avatar || defaultAvatar;

    conversation.messages.forEach((msg, index) => {
        const isFan = msg.sender === 'fan';
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${isFan ? 'fan' : 'user-self'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `message-bubble`;

        const avatarHtml = `<img src="${isFan ? conversation.fanAvatarUrl : userAvatar}" class="avatar">`;
        const contentHtml = `<div class="content">${msg.text.replace(/\n/g, '<br>')}</div>`;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œåˆ›å»ºåˆ é™¤æŒ‰é’®çš„HTML â˜…â˜…â˜…
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'user-dm-message-delete-btn';
        deleteBtn.dataset.messageIndex = index; // ç”¨ç´¢å¼•æ¥æ ‡è¯†æ˜¯å“ªæ¡æ¶ˆæ¯
        deleteBtn.title = "åˆ é™¤";
        deleteBtn.innerHTML = 'Ã—';
        
        bubble.innerHTML = `${avatarHtml}${contentHtml}`;
        
        // â˜…â˜…â˜… å°†æ°”æ³¡å’Œåˆ é™¤æŒ‰é’®éƒ½æ·»åŠ åˆ°å®¹å™¨ä¸­ â˜…â˜…â˜…
        wrapper.appendChild(bubble);
        wrapper.appendChild(deleteBtn);
        
        messagesEl.appendChild(wrapper);
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
}


/**
 * ã€å·²ä¿®å¤ã€‘å¤„ç†ç”¨æˆ·åœ¨ç§ä¿¡è¯¦æƒ…é¡µå‘é€æ¶ˆæ¯ (ä»…å‘é€ï¼Œä¸è§¦å‘AI)
 */
async function handleSendUserDm() {
    const inputEl = document.getElementById('user-dm-input');
    const messageText = inputEl.value.trim();
    if (!messageText || currentUserDmFanIndex === null) return;

    const convo = state.qzoneSettings.userDms[currentUserDmFanIndex];
    
    // 1. åˆ›å»ºä½ çš„æ¶ˆæ¯å¯¹è±¡
    const newMessage = { sender: 'char', text: messageText };

    // 2. å°†ä½ çš„æ¶ˆæ¯æ·»åŠ åˆ°å¯¹è¯å†å²ä¸­
    convo.messages.push(newMessage);
    
    // 3. æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®æ ·å¼
    inputEl.value = '';
    inputEl.style.height = 'auto';

    // 4. é‡æ–°æ¸²æŸ“å¯¹è¯è¯¦æƒ…å’Œå·¦ä¾§åˆ—è¡¨ï¼Œä»¥æ˜¾ç¤ºä½ çš„æ–°æ¶ˆæ¯
    renderUserDmDetail(convo);
    renderUserDmList(state.qzoneSettings.userDms);

    // 5. ä¿å­˜çŠ¶æ€
    await saveQzoneSettings();
    
    // 6. é‡æ–°èšç„¦è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ä½ ç»§ç»­è¾“å…¥æˆ–ç­‰å¾…æ“ä½œ
    inputEl.focus();
    
    // æ³¨æ„ï¼šæ­¤å¤„å·²ç§»é™¤æ‰€æœ‰è‡ªåŠ¨è§¦å‘AIå›å¤çš„ä»£ç 
}



/**
 * ã€AIå›å¤æ ¸å¿ƒ V2 - å·²å¢å¼ºå›å¤ä¸°å¯Œåº¦ã€‘è°ƒç”¨AIç”Ÿæˆç²‰ä¸çš„å›å¤ (å¯ä»¥ç”Ÿæˆå¤šæ¡)
 */
async function triggerUserDmAiReply(conversation) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.error("APIé…ç½®ä¸å®Œæ•´");
        return null;
    }
    
    const settings = state.qzoneSettings;

    // --- â–¼â–¼â–¼ ä¿®æ”¹ç‚¹2ï¼šå…¨æ–°çš„ã€æ›´ä¸°å¯Œçš„AIæŒ‡ä»¤ â–¼â–¼â–¼ ---
    const systemPrompt = `
# è§’è‰²æ‰®æ¼”ä»»åŠ¡
ä½ å°†æ‰®æ¼”ä¸€ä¸ªæ­£åœ¨å’Œå¶åƒæˆ–åšä¸»ç§ä¿¡çš„ç²‰ä¸ã€‚

# ä½ çš„ç²‰ä¸äººè®¾
- ä½ çš„æ˜µç§°: "${conversation.fanName}"
- ä½ çš„æ€§æ ¼å’ŒèƒŒæ™¯: "${conversation.fanPersona}"

# åšä¸»ä¿¡æ¯ (ä½ æ­£åœ¨å’Œä»–/å¥¹èŠå¤©)
- å¾®åšæ˜µç§°: ${settings.weiboNickname || settings.nickname}
- å¾®åšèŒä¸š: ${settings.weiboUserProfession || 'æœªè®¾å®š'}
- åšä¸»çš„éšè—äººè®¾: ${settings.weiboUserPersona || 'ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚'}

# å¯¹è¯å†å² (æœ€è¿‘çš„5æ¡)
${conversation.messages.slice(-5).map(m => `- ${m.sender === 'fan' ? conversation.fanName : 'æˆ‘'}: ${m.text}`).join('\n')}

# ä½ çš„ä»»åŠ¡
æ ¹æ®ä»¥ä¸Šäººè®¾å’Œå¯¹è¯å†å²ï¼Œç”Ÿæˆä½ æ¥ä¸‹æ¥çš„å›å¤ã€‚

# å›å¤è§„åˆ™
1.  **æ·±åº¦æ‰®æ¼”**: ä½ çš„å›å¤å¿…é¡»ã€æåº¦ç¬¦åˆã€‘ä½ çš„ç²‰ä¸äººè®¾ã€‚è¯­æ°”ã€ç”¨è¯ã€æƒ…ç»ªéƒ½è¦åˆ°ä½ã€‚
2.  **å†…å®¹ä¸°å¯Œ**: ä¸è¦åªå›å¤ä¸€å¥è¯ã€‚ä½ çš„å›å¤åº”è¯¥åŒ…å«æƒ…ç»ª(æ¿€åŠ¨ã€å¤±æœ›ã€å¥½å¥‡ç­‰)ã€æ€è€ƒï¼Œæˆ–è€…å‘åšä¸»æå‡ºæ–°çš„é—®é¢˜æ¥æ¨åŠ¨å¯¹è¯ã€‚
3.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªã€JSONæ•°ç»„ã€‘ï¼Œå³ä½¿åªæœ‰ä¸€æ¡æ¶ˆæ¯ã€‚è¿™ä¸ªæ•°ç»„å¯ä»¥åŒ…å«3åˆ°8æ¡æ¶ˆæ¯å¯¹è±¡ï¼Œæ¨¡æ‹ŸçœŸå®èŠå¤©ä¸­è¿ç»­å‘æ¶ˆæ¯çš„åœºæ™¯ã€‚
4.  **å¯¹è±¡ç»“æ„**: æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½å¿…é¡»æ˜¯ {"sender": "fan", "text": "ä½ çš„å•æ¡å›å¤å†…å®¹"}ã€‚

ç°åœ¨ï¼Œè¯·ä»¥JSONæ•°ç»„çš„æ ¼å¼ï¼Œç”Ÿæˆä½ æ¥ä¸‹æ¥è¦å‘é€çš„1-3æ¡æ¶ˆæ¯ã€‚`;
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini, state.apiConfig.temperature);


        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content);
        const cleanedContent = rawContent.replace(/^```json\s*|```$/g, '').trim();
        
        // AIç°åœ¨è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬ç›´æ¥è§£æå¹¶è¿”å›å®ƒ
        const newMessages = JSON.parse(cleanedContent);

        // åšä¸€ä¸ªå…¼å®¹æ€§æ£€æŸ¥ï¼Œå¦‚æœAIæ„å¤–è¿”å›äº†å•ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬æŠŠå®ƒåŒ…è£…æˆæ•°ç»„
        return Array.isArray(newMessages) ? newMessages : [newMessages];

    } catch (error) {
        console.error('è§¦å‘ç²‰ä¸å›å¤å¤±è´¥:', error);
        await showCustomAlert('å›å¤ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
        // è¿”å›ä¸€ä¸ªåŒ…å«é”™è¯¯ä¿¡æ¯çš„æ•°ç»„ï¼Œä»¥ä¾¿ç•Œé¢èƒ½æ˜¾ç¤ºå‡ºæ¥
        return [{ sender: 'fan', text: `(AIç”Ÿæˆå›å¤æ—¶å‡ºé”™äº†: ${error.message})` }];
    }
}

/**
 * æ¸…ç©ºæ‰€æœ‰Userçš„ç§ä¿¡
 */
async function handleClearAllUserDms() {
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç©º', 
        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç²‰ä¸ç§ä¿¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        state.qzoneSettings.userDms = [];
        await saveQzoneSettings();
        renderUserDmList([]);
        alert('æ‰€æœ‰ç§ä¿¡å·²æ¸…ç©ºã€‚');
    }
}

/* â–²â–²â–² å…¨æ–°çš„ User ç§ä¿¡åŠŸèƒ½æ ¸å¿ƒå‡½æ•°ç»“æŸ â–²â–²â–² */
/**
 * ã€å…¨æ–°ã€‘å°†æ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚ "20:00", "æ—©ä¸Š9ç‚¹"ï¼‰è§£æä¸ºåˆ†é’Ÿæ•°
 * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸²
 * @returns {number} - ä»åˆå¤œ0ç‚¹å¼€å§‹çš„åˆ†é’Ÿæ•°
 */
function parseTime(timeStr) {
    if (!timeStr || typeof timeStr !== 'string') return -1; // é”™è¯¯æˆ–æ— æ•ˆè¾“å…¥è¿”å›-1

    let hours = 0;
    let minutes = 0;

    // åŒ¹é… "HH:mm" æˆ– "H:mm" æ ¼å¼
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (match) {
        hours = parseInt(match[1], 10);
        minutes = parseInt(match[2], 10);
    } else {
        // å¦‚æœä¸æ˜¯æ ‡å‡†æ ¼å¼ï¼Œå°è¯•åŒ¹é…ä¸­æ–‡æè¿°
        const numMatch = timeStr.match(/(\d+)/);
        const num = numMatch ? parseInt(numMatch[0], 10) : -1;

        if (num !== -1) {
            if (timeStr.includes('ä¸‹åˆ') || timeStr.includes('æ™šä¸Š')) {
                // ä¸‹åˆ1ç‚¹(13ç‚¹)åˆ°æ™šä¸Š11ç‚¹(23ç‚¹)
                if (num < 12) {
                    hours = num + 12;
                } else {
                    hours = num; // å¦‚æœå·²ç»æ˜¯24å°æ—¶åˆ¶å¦‚â€œæ™šä¸Š20ç‚¹â€ï¼Œç›´æ¥ä½¿ç”¨
                }
            } else {
                // æ—©ä¸Šæˆ–ä¸Šåˆ
                hours = num;
            }
        } else {
            return -1; // æ— æ³•è§£æ
        }
    }

    // å¤„ç†ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æ™šä¸Š12ç‚¹åº”ä¸º0ç‚¹
    if ((timeStr.includes('æ™šä¸Š') || timeStr.includes('å‡Œæ™¨')) && hours === 12) {
        hours = 0;
    }
    // å¤„ç†ä¸‹åˆ12ç‚¹åº”ä¸º12ç‚¹
    if ((timeStr.includes('ä¸‹åˆ') || timeStr.includes('ä¸­åˆ')) && hours === 24) {
        hours = 12;
    }

    return hours * 60 + minutes;
}
// â–¼â–¼â–¼ ã€V2.2 | ä¿®å¤ç†„ç­é‡ç‡ƒé€»è¾‘ã€‘è¯·ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ updateStreak å‡½æ•° â–¼â–¼â–¼
/**
 * ã€ç«èŠ± V2.2ã€‘æ£€æŸ¥å¹¶æ›´æ–°ç«èŠ±å¤©æ•° (å·²ä¿®å¤ç†„ç­åä»1å¼€å§‹çš„é—®é¢˜)
 * @param {string} chatId - è¦æ›´æ–°ç«èŠ±çš„èŠå¤©ID
 * @returns {Promise<boolean>} - å¦‚æœç«èŠ±å¤©æ•°æœ‰å˜åŒ–ï¼Œåˆ™è¿”å›true
 */
async function updateStreak(chatId) {
    const chat = state.chats[chatId];
    // å¦‚æœä¸æ˜¯å•èŠï¼Œæˆ–åŠŸèƒ½æœªå¼€å¯ï¼Œç›´æ¥è¿”å›
    if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
        return false;
    }

    const streak = chat.settings.streak;
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼

    // å¦‚æœä»Šå¤©å·²ç»äº’åŠ¨è¿‡äº†ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åš
    if (streak.lastInteractionDate === today) {
        return false;
    }

    let changed = false;

    // æ£€æŸ¥ç«èŠ±æ˜¯å¦å·²ç†„ç­
    if (streak.lastInteractionDate && streak.extinguishThreshold !== -1) {
        const lastDate = new Date(streak.lastInteractionDate);
        const todayDate = new Date(today);
        // ä¸ºäº†ç²¾ç¡®è®¡ç®—å¤©æ•°å·®å¼‚ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªæ—¥æœŸéƒ½è®¾ç½®ä¸ºUTCæ—¶é—´çš„åˆå¤œ
        const lastDateUTC = Date.UTC(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
        const todayDateUTC = Date.UTC(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate());
        
        const daysDiff = (todayDateUTC - lastDateUTC) / (1000 * 60 * 60 * 24);

        if (daysDiff >= streak.extinguishThreshold) {
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼â˜…â˜…â˜…
            // å°† currentDays é‡ç½®ä¸º 0ï¼Œè¿™æ ·ç¨åçš„ ++ æ“ä½œå°±ä¼šè®©å®ƒå˜ä¸º 1
            streak.currentDays = 0; 
            console.log(`ğŸ”¥ ä¸ ${chat.name} çš„ç«èŠ±å› è¶…è¿‡ ${streak.extinguishThreshold} å¤©æœªè”ç³»è€Œç†„ç­ï¼Œå°†é‡æ–°ä» 1 å¼€å§‹è®¡ç®—ã€‚`);
            changed = true;
        }
    }
    
    // ä»Šå¤©æ˜¯æ–°çš„äº’åŠ¨æ—¥ï¼Œå¤©æ•°+1
    // å¦‚æœæ˜¯æ°¸ä¸ç†„ç­æ¨¡å¼ï¼ŒcurrentDays ä¸º -1, ä¸åº”è¯¥å¢åŠ 
    if (streak.currentDays >= 0) {
        streak.currentDays++;
        changed = true;
    }
    
    // æ›´æ–°æœ€åäº’åŠ¨æ—¥æœŸä¸ºä»Šå¤©
    streak.lastInteractionDate = today;

    // åªè¦æ˜¯æ–°çš„ä¸€å¤©äº’åŠ¨ï¼Œå°±åº”è¯¥ä¿å­˜æ›´æ–°åçš„æ—¥æœŸ
    await db.chats.put(chat);
    
    if(changed) {
        console.log(`ğŸ”¥ ä¸ ${chat.name} çš„ç«èŠ±å¤©æ•°æ›´æ–°ä¸º: ${streak.currentDays}`);
    }
    
    return changed; // è¿”å›æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ handleToggleAdmin å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | æƒé™ä¿®å¤ç‰ˆã€‘å¤„ç†è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜
 */
async function handleToggleAdmin(memberId) {
    const chat = state.chats[state.activeChatId];
    // æƒé™æ£€æŸ¥ï¼šç¡®ä¿æ“ä½œè€…æ˜¯ç¾¤ä¸»
    if (!chat || chat.ownerId !== 'user') {
        alert("ä½ ä¸æ˜¯ç¾¤ä¸»ï¼Œæ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œï¼");
        return;
    }

    let targetNickname;
    let isAdminNow;

    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
    // 1. åˆ¤æ–­æ“ä½œç›®æ ‡æ˜¯ä¸æ˜¯ç”¨æˆ·è‡ªå·±
    if (memberId === 'user') {
        // å¦‚æœæ˜¯ç”¨æˆ·ï¼Œå°±ä¿®æ”¹ chat.settings é‡Œçš„ä¸“å±æ ‡å¿—
        // æˆ‘ä»¬ä½¿ç”¨ isUserAdmin å±æ€§æ¥è®°å½•ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        chat.settings.isUserAdmin = !chat.settings.isUserAdmin;
        targetNickname = chat.settings.myNickname || 'æˆ‘';
        isAdminNow = chat.settings.isUserAdmin;
    } else {
        // å¦‚æœæ˜¯å…¶ä»–æˆå‘˜ï¼Œä¿æŒåŸæœ‰é€»è¾‘ä¸å˜
        const member = chat.members.find(m => m.id === memberId);
        if (!member) return;

        // ã€é‡è¦ã€‘ä¸èƒ½å°†ç¾¤ä¸»è®¾ä¸ºç®¡ç†å‘˜æˆ–å–æ¶ˆå…¶ç®¡ç†å‘˜èº«ä»½
        if (member.id === chat.ownerId) {
            alert("ä¸èƒ½å¯¹ç¾¤ä¸»è¿›è¡Œæ­¤æ“ä½œã€‚");
            return;
        }
        
        member.isAdmin = !member.isAdmin;
        targetNickname = member.groupNickname;
        isAdminNow = member.isAdmin;
    }
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    await db.chats.put(chat);
    
    // å‡†å¤‡å¹¶å‘é€ç³»ç»Ÿé€šçŸ¥æ¶ˆæ¯
    const actionText = isAdminNow ? 'è®¾ä¸ºç®¡ç†å‘˜' : 'å–æ¶ˆäº†ç®¡ç†å‘˜èº«ä»½';
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    // è¿™é‡Œæˆ‘ä»¬ç”¨ logSystemMessage å‡½æ•°æ¥å‘é€é€šçŸ¥ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ·æ–°UI
    await logSystemMessage(chat.id, `â€œ${myNickname}â€å°†â€œ${targetNickname}â€${actionText}ã€‚`);

    // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨çš„æ˜¾ç¤º
    renderMemberManagementList(); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ handleSetMemberTitle å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | æƒé™ä¿®å¤ç‰ˆã€‘å¤„ç†è®¾ç½®ç¾¤æˆå‘˜å¤´è¡”
 */
async function handleSetMemberTitle(memberId) {
    const chat = state.chats[state.activeChatId];
    // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»æˆ–ç®¡ç†å‘˜æ‰èƒ½è®¾ç½®
    const isOwner = chat.ownerId === 'user';
    const isAdmin = chat.settings.isUserAdmin;

    if (!chat || (!isOwner && !isAdmin)) {
        alert("ä½ ä¸æ˜¯ç¾¤ä¸»æˆ–ç®¡ç†å‘˜ï¼Œæ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œï¼");
        return;
    }
    
    let targetNickname;
    let oldTitle;
    
    // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
    if (memberId === 'user') {
        targetNickname = chat.settings.myNickname || 'æˆ‘';
        oldTitle = chat.settings.myGroupTitle || '';
    } else {
        const member = chat.members.find(m => m.id === memberId);
        if (!member) return;
        targetNickname = member.groupNickname;
        oldTitle = member.groupTitle || '';
    }
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    const newTitle = await showCustomPrompt(`ä¸ºâ€œ${targetNickname}â€è®¾ç½®å¤´è¡”`, 'ç•™ç©ºåˆ™ä¸ºå–æ¶ˆå¤´è¡”', oldTitle);
    
    if (newTitle !== null) {
        const trimmedTitle = newTitle.trim();
        // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
        if (memberId === 'user') {
            chat.settings.myGroupTitle = trimmedTitle;
        } else {
            const member = chat.members.find(m => m.id === memberId);
            if (member) member.groupTitle = trimmedTitle;
        }
        // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        await logTitleChange(chat.id, myNickname, targetNickname, trimmedTitle);

        renderMemberManagementList();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ handleTransferOwnership å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¤„ç†è½¬è®©ç¾¤ä¸» (å·²æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥)
 */
async function handleTransferOwnership(memberId) {
    const chat = state.chats[state.activeChatId];
    const newOwner = chat.members.find(m => m.id === memberId);
    if (!newOwner) return;

    // ã€æ–°å¢ã€‘è·å–æ—§ç¾¤ä¸»çš„æ˜µç§°ï¼Œä¹Ÿå°±æ˜¯ä½ è‡ªå·±çš„æ˜µç§°
    const oldOwnerNickname = chat.settings.myNickname || 'æˆ‘';

    const confirmed = await showCustomConfirm(
        'è½¬è®©ç¾¤ä¸»',
        `ä½ ç¡®å®šè¦å°†ç¾¤ä¸»èº«ä»½è½¬è®©ç»™â€œ${newOwner.groupNickname}â€å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä½ å°†å¤±å»ç¾¤ä¸»æƒé™ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // æ›´æ–°ç¾¤ä¸»ID
        chat.ownerId = newOwner.id;
        
        // å°†æ–°ç¾¤ä¸»è®¾ä¸ºç®¡ç†å‘˜ï¼ˆå¦‚æœä»–ä¹‹å‰ä¸æ˜¯ï¼‰
        newOwner.isAdmin = true;

        // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡å”¯ä¸€éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä»£ç ï¼ â˜…â˜…â˜…â˜…â˜…
        // 1. æ„å»ºç³»ç»Ÿæ¶ˆæ¯çš„å†…å®¹
        const message = `â€œ${oldOwnerNickname}â€å·²å°†ç¾¤ä¸»è½¬è®©ç»™â€œ${newOwner.groupNickname}â€`;
        
        // 2. è°ƒç”¨ä½ å·²æœ‰çš„å‡½æ•°æ¥å‘é€è¿™æ¡ç³»ç»Ÿæ¶ˆæ¯
        //    è¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ä¿å­˜æ•°æ®å¹¶åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œéå¸¸æ–¹ä¾¿ï¼
        await logSystemMessage(chat.id, message);
        // â˜…â˜…â˜…â˜…â˜… æ·»åŠ ç»“æŸ â˜…â˜…â˜…â˜…â˜…

        // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨çš„æ˜¾ç¤º
        renderMemberManagementList(); 
        
        // ç»™å‡ºæˆåŠŸæç¤º
        await showCustomAlert('æ“ä½œæˆåŠŸ', `ç¾¤ä¸»å·²æˆåŠŸè½¬è®©ç»™â€œ${newOwner.groupNickname}â€ã€‚`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å‘é€ä¸€æ¡å±…ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ¶ˆæ¯åˆ°å½“å‰èŠå¤©
 * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
 * @param {string} messageContent - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å†…å®¹
 */
async function logSystemMessage(chatId, messageContent) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å¯¹è±¡
    const systemMessage = {
        role: 'system',       // è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿè§’è‰²çš„æ¶ˆæ¯
        type: 'pat_message',  // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
        content: messageContent,
        timestamp: Date.now()
    };

    // 2. å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©è®°å½•å¹¶ä¿å­˜
    chat.history.push(systemMessage);
    await db.chats.put(chat);

    // 3. å¦‚æœç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æ­¤èŠå¤©ï¼Œåˆ™ç«‹å³æ˜¾ç¤ºæ–°æ¶ˆæ¯
    if (state.activeChatId === chatId && document.getElementById('chat-interface-screen').classList.contains('active')) {
        appendMessage(systemMessage, chat);
    }
    
    // 4. åˆ·æ–°èŠå¤©åˆ—è¡¨ä»¥æ›´æ–°é¢„è§ˆ
    await renderChatList();

    console.log(`ç³»ç»Ÿæ¶ˆæ¯å·²è®°å½•: ${messageContent}`);
}


/**
 * ã€V2 - é‡æ„ç‰ˆã€‘è®°å½•å¹¶å‘é€ç¾¤å¤´è¡”å˜æ›´çš„ç³»ç»Ÿæ¶ˆæ¯
 * @param {string} chatId - å‘ç”Ÿå˜æ›´çš„ç¾¤èŠID
 * @param {string} actorName - æ‰§è¡Œæ“ä½œçš„äººçš„æ˜µç§°
 * @param {string} targetName - è¢«ä¿®æ”¹å¤´è¡”çš„äººçš„æ˜µç§°
 * @param {string} newTitle - æ–°çš„å¤´è¡”
 */
async function logTitleChange(chatId, actorName, targetName, newTitle) {
    // 1. æ„é€ æ¶ˆæ¯å†…å®¹
    const messageContent = newTitle 
        ? `${actorName} å°†â€œ${targetName}â€çš„ç¾¤å¤´è¡”ä¿®æ”¹ä¸ºâ€œ${newTitle}â€`
        : `${actorName} å–æ¶ˆäº†â€œ${targetName}â€çš„ç¾¤å¤´è¡”`;
        
    // 2. è°ƒç”¨é€šç”¨çš„ç³»ç»Ÿæ¶ˆæ¯å‡½æ•°
    await logSystemMessage(chatId, messageContent);
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘ŠåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€å…¨æ–° | å·²ä¿®å¤ã€‘ç¾¤å…¬å‘ŠåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

/**
 * æ‰“å¼€ç¾¤å…¬å‘Šå¼¹çª—å¹¶æ¸²æŸ“å†…å®¹
 */
function openGroupAnnouncementModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) return;

    const modal = document.getElementById('group-announcement-modal');
    const contentArea = document.getElementById('announcement-content-area');
    const footer = document.getElementById('announcement-footer');

    const announcement = chat.settings.groupAnnouncement || 'æš‚æ— å…¬å‘Š';
    contentArea.innerHTML = announcement.replace(/\n/g, '<br>');
    
    const canEdit = chat.ownerId === 'user' || chat.settings.isUserAdmin;
    
    footer.innerHTML = ''; 
    if (canEdit) {
        const editBtn = document.createElement('button');
        editBtn.className = 'cancel';
        editBtn.textContent = 'ç¼–è¾‘';
        // ã€æ ¸å¿ƒä¿®å¤1ã€‘æ”¹ç”¨ addEventListener æ¥ç»‘å®šäº‹ä»¶ï¼Œæ›´å®‰å…¨å¯é 
        editBtn.addEventListener('click', editGroupAnnouncement); 
        footer.appendChild(editBtn);
    }
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'save'; 
    closeBtn.textContent = 'å…³é—­';
    // ã€æ ¸å¿ƒä¿®å¤2ã€‘åŒæ ·æ”¹ç”¨ addEventListener
    closeBtn.addEventListener('click', closeGroupAnnouncementModal); 
    footer.appendChild(closeBtn);

    modal.classList.add('visible');
}

/**
 * è¿›å…¥å…¬å‘Šç¼–è¾‘æ¨¡å¼
 */
function editGroupAnnouncement() {
    const chat = state.chats[state.activeChatId];
    const contentArea = document.getElementById('announcement-content-area');
    const footer = document.getElementById('announcement-footer');

    const currentContent = chat.settings.groupAnnouncement || '';
    contentArea.innerHTML = `<textarea id="announcement-editor">${currentContent}</textarea>`;
    
    // ã€æ ¸å¿ƒä¿®å¤3ã€‘è¿™é‡Œä¹Ÿå…¨éƒ¨æ”¹ç”¨ addEventListener çš„æ–¹å¼ç»‘å®š
    footer.innerHTML = ''; // å…ˆæ¸…ç©º

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'cancel';
    cancelBtn.textContent = 'å–æ¶ˆ';
    cancelBtn.addEventListener('click', closeGroupAnnouncementModal); // ç›´æ¥è°ƒç”¨å‡½æ•°
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'save';
    saveBtn.textContent = 'ä¿å­˜';
    saveBtn.addEventListener('click', saveGroupAnnouncement); // ç›´æ¥è°ƒç”¨å‡½æ•°

    footer.appendChild(cancelBtn);
    footer.appendChild(saveBtn);
    
    document.getElementById('announcement-editor').focus();
}

/**
 * ä¿å­˜æ–°çš„ç¾¤å…¬å‘Š
 */
async function saveGroupAnnouncement() {
    const chat = state.chats[state.activeChatId];
    const newContent = document.getElementById('announcement-editor').value.trim();

    chat.settings.groupAnnouncement = newContent;
    await db.chats.put(chat);
    
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    await logSystemMessage(chat.id, `â€œ${myNickname}â€ä¿®æ”¹äº†ç¾¤å…¬å‘Šã€‚`);

    closeGroupAnnouncementModal();
    alert('ç¾¤å…¬å‘Šå·²æ›´æ–°ï¼');
}

/**
 * å…³é—­ç¾¤å…¬å‘Šå¼¹çª—
 */
function closeGroupAnnouncementModal() {
    // å…³é—­åï¼Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡æŸ¥çœ‹çŠ¶æ€ï¼Œä»¥é˜²ç”¨æˆ·å–æ¶ˆäº†ç¼–è¾‘
    const modal = document.getElementById('group-announcement-modal');
    modal.classList.remove('visible');
    // å»¶è¿Ÿä¸€ç‚¹ç‚¹å†æ‰“å¼€ï¼Œå¯ä»¥é¿å…è§†è§‰ä¸Šçš„å†²çª
    setTimeout(() => {
        if(modal.classList.contains('visible')) { // åšä¸ªæ£€æŸ¥ï¼Œä¸‡ä¸€ç”¨æˆ·å¿«é€Ÿæ“ä½œ
           openGroupAnnouncementModal();
        }
    }, 10);
    // ç›´æ¥å…³é—­ï¼Œä¸å†é‡æ–°æ‰“å¼€
    document.getElementById('group-announcement-modal').classList.remove('visible');
}

/* â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–² */
/**
 * ã€å…¨æ–°ã€‘è·å–å¹¶æ ¼å¼åŒ–å½“å‰èŠå¤©çš„ç»­ç«èŠ±çŠ¶æ€ï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸Šä¸‹æ–‡
 * @param {object} chat - å½“å‰çš„èŠå¤©å¯¹è±¡
 * @returns {string} - æ ¼å¼åŒ–åçš„ç«èŠ±çŠ¶æ€æ–‡æœ¬ï¼Œæˆ–ç©ºå­—ç¬¦ä¸²
 */
async function getStreakContext(chat) {
    // 1. å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœä¸æ˜¯å•èŠï¼Œæˆ–è€…åŠŸèƒ½æœªå¼€å¯ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå†…å®¹
    if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
        return "";
    }

    const streak = chat.settings.streak;
    const currentDays = streak.currentDays || 0;
    const extinguishThreshold = streak.extinguishThreshold || 1;
    const lastInteractionDate = streak.lastInteractionDate;
    let isExtinguished = false;

    // 2. åˆ¤æ–­ç«èŠ±æ˜¯å¦å·²ç†„ç­
    if (lastInteractionDate && extinguishThreshold !== -1) {
        const lastDate = new Date(lastInteractionDate);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // å°†æ—¶é—´è®¾ä¸ºå½“æ—¥é›¶ç‚¹ï¼Œä»¥ç²¾ç¡®è®¡ç®—å¤©æ•°

        // è®¡ç®—æœ€åä¸€æ¬¡äº’åŠ¨åˆ°ä»Šå¤©è¿‡äº†å¤šå°‘å¤©
        const daysDiff = (todayDate.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24);

        if (daysDiff >= extinguishThreshold) {
            isExtinguished = true;
        }
    }

    let statusText = "";

    // 3. æ ¹æ®ä¸åŒçŠ¶æ€ï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸åŒæ–‡æœ¬
    if (isExtinguished && currentDays > 0) {
        // è¿™ç§çŠ¶æ€è¡¨ç¤ºâ€œæ›¾ç»æœ‰è¿‡ç«èŠ±ï¼Œä½†ç°åœ¨æ–­äº†â€
        statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±ã€å·²ç†„ç­ã€‘ã€‚ä¹‹å‰æ›¾è¿ç»­èŠäº† ${currentDays} å¤©ï¼Œä½†ç°åœ¨ä¸­æ–­äº†ã€‚`;
    } else if (currentDays > 10) {
        statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±æ­£åœ¨çƒ­çƒˆç‡ƒçƒ§ï¼Œå·²ç»æŒç»­äº†ã€${currentDays}ã€‘å¤©äº†ï¼è¿™æ˜¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„æ•°å­—ã€‚`;
    } else if (currentDays > 0) {
        statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±æ­£åœ¨å»¶ç»­ï¼Œå·²ç»æŒç»­äº†ã€${currentDays}ã€‘å¤©ã€‚`;
    } else {
        // å¤©æ•°ä¸º0ï¼Œè¯´æ˜æ˜¯åˆšå¼€å¯æˆ–åˆšé‡ç½®
        statusText = "ä½ ä»¬åˆšåˆšç‚¹ç‡ƒäº†èŠå¤©ç«èŠ±ï¼Œè¦ç»§ç»­ä¿æŒå“¦ï¼";
    }
    
    // 4. æ‹¼æ¥æˆæœ€ç»ˆçš„ä¸Šä¸‹æ–‡æ ¼å¼
    return `\n- **èŠå¤©ç«èŠ±çŠ¶æ€**: ${statusText}`;
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ç”¨æˆ·è¡¨æƒ…åŒ…æ‰¹é‡åˆ é™¤çš„JSæ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ä½¿ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ toggleUserStickerSelectionMode â–¼â–¼â–¼
function toggleUserStickerSelectionMode() {
    isUserStickerSelectionMode = !isUserStickerSelectionMode;
    const stickerPanel = document.getElementById('sticker-panel');
    
    selectedUserStickers.clear();
    stickerPanel.classList.toggle('selection-mode', isUserStickerSelectionMode);
    
    document.getElementById('edit-user-stickers-btn').style.display = isUserStickerSelectionMode ? 'none' : 'block';
    document.getElementById('done-user-stickers-btn').style.display = isUserStickerSelectionMode ? 'block' : 'none';
    document.getElementById('sticker-panel-footer').style.display = isUserStickerSelectionMode ? 'flex' : 'none'; // æ”¹ä¸ºflex
    
    // æ›´æ–°åˆ é™¤æŒ‰é’®
    const deleteBtn = document.getElementById('delete-selected-user-stickers-btn');
    deleteBtn.textContent = `åˆ é™¤å·²é€‰ (0)`;
    deleteBtn.disabled = true;

    // â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ–°ç§»åŠ¨æŒ‰é’® â˜…â˜…â˜…
    const moveBtn = document.getElementById('move-selected-stickers-btn');
    moveBtn.disabled = true;
    
    renderStickerPanel();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * é€€å‡ºç”¨æˆ·è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
 */
function exitUserStickerSelectionMode() {
    if (isUserStickerSelectionMode) {
        toggleUserStickerSelectionMode();
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§’è‰²è¡¨æƒ…åŒ…æ‰¹é‡åˆ é™¤çš„JSæ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * åˆ‡æ¢è§’è‰²è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
 */
function toggleCharStickerSelectionMode() {
    isCharStickerSelectionMode = !isCharStickerSelectionMode;
    const screen = document.getElementById('char-sticker-manager-screen');
    
    // æ¸…ç©ºé€‰æ‹©é›†å¹¶æ›´æ–°UI
    selectedCharStickers.clear();
    screen.classList.toggle('selection-mode', isCharStickerSelectionMode);
    
    document.getElementById('edit-char-stickers-btn').style.display = isCharStickerSelectionMode ? 'none' : 'block';
    document.getElementById('done-char-stickers-btn').style.display = isCharStickerSelectionMode ? 'block' : 'none';
    document.getElementById('char-sticker-footer').style.display = isCharStickerSelectionMode ? 'block' : 'none';
    document.getElementById('delete-selected-char-stickers-btn').textContent = `åˆ é™¤å·²é€‰ (0)`;
    document.getElementById('delete-selected-char-stickers-btn').disabled = true;

    // é‡æ–°æ¸²æŸ“å½“å‰æ¿€æ´»çš„é¡µç­¾
    const activeTab = document.querySelector('#char-sticker-manager-screen .frame-tab.active');
    if (activeTab) {
        renderCharStickers(activeTab.id === 'sticker-tab-exclusive' ? 'exclusive' : 'common');
    }
}

/**
 * é€€å‡ºè§’è‰²è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
 */
function exitCharStickerSelectionMode() {
    if (isCharStickerSelectionMode) {
        toggleCharStickerSelectionMode();
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ showInnerVoiceEditOptions å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»å¿ƒå£°é¢æ¿çš„ç¼–è¾‘æŒ‰é’®æ—¶ï¼Œæ‰“å¼€æ“ä½œèœå•
 */
async function showInnerVoiceEditOptions() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const borderHidden = chat.settings.innerVoiceHideHeaderBorder || false;
    const borderOptionText = borderHidden ? 'æ˜¾ç¤ºåˆ†å‰²çº¿' : 'éšè—åˆ†å‰²çº¿';
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨é€‰é¡¹æ•°ç»„é‡Œæ–°å¢äº† 'editStyles'
    const choice = await showChoiceModal("ç¼–è¾‘å¿ƒå£°é¢æ¿", [
        { text: 'ğŸ¨ ç¼–è¾‘é¢æ¿æ ·å¼', value: 'editStyles' },
        { text: borderOptionText, value: 'toggleBorder' },
        { text: 'ä¿®æ”¹é¢†å…»äºº', value: 'editAdopter' }
    ]);

    if (choice === 'editStyles') {
        openInnerVoiceStyleEditor(); // è°ƒç”¨æˆ‘ä»¬æ–°å†™çš„å‡½æ•°æ¥æ‰“å¼€æ ·å¼ç¼–è¾‘å™¨
    } else if (choice === 'toggleBorder') {
        await toggleInnerVoiceHeaderBorder();
    } else if (choice === 'editAdopter') {
        await editInnerVoiceAdopterName();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * åˆ‡æ¢å¿ƒå£°é¢æ¿å¤´éƒ¨åˆ†å‰²çº¿çš„æ˜¾ç¤º/éšè—
 */
async function toggleInnerVoiceHeaderBorder() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // ç¡®ä¿ chat.settings å­˜åœ¨
    if (!chat.settings) chat.settings = {};

    // åˆ‡æ¢å¸ƒå°”å€¼
    chat.settings.innerVoiceHideHeaderBorder = !(chat.settings.innerVoiceHideHeaderBorder || false);

    // ä¿å­˜åˆ°æ•°æ®åº“
    await db.chats.put(chat);

    // æ›´æ–°UI
    const header = document.querySelector('#inner-voice-main-panel .modal-header');
    if (header) {
        header.classList.toggle('no-border', chat.settings.innerVoiceHideHeaderBorder);
    }

    await showCustomAlert('æ“ä½œæˆåŠŸ', `åˆ†å‰²çº¿å·²${chat.settings.innerVoiceHideHeaderBorder ? 'éšè—' : 'æ˜¾ç¤º'}ã€‚`);
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ¨¡æ¿ç¼–è¾‘ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ editInnerVoiceAdopterName å‡½æ•° â–¼â–¼â–¼
/**
 * ä¿®æ”¹â€œé¢†å…»äººâ€çš„æ ‡ç­¾æ¨¡æ¿
 */
async function editInnerVoiceAdopterName() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // è·å–å½“å‰çš„æ ‡ç­¾æ¨¡æ¿ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¿‡ï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼
    const currentFormat = chat.settings.innerVoiceAdopterLabelFormat || 'é¢†å…»äºº: {{user}}';
    
    // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·ç¼–è¾‘æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²
    const newFormat = await showCustomPrompt(
        'ä¿®æ”¹é¢†å…»äººæ ‡ç­¾', 
        'ä½ å¯ä»¥ä¿®æ”¹æ•´ä¸ªæ ‡ç­¾ï¼Œå…¶ä¸­ {{user}} ä¼šè¢«è‡ªåŠ¨æ›¿æ¢ä¸ºä½ çš„æ˜µç§°ã€‚', 
        currentFormat
    );

    // å¦‚æœç”¨æˆ·è¾“å…¥äº†æ–°å†…å®¹ï¼ˆä¸æ˜¯å–æ¶ˆï¼‰
    if (newFormat !== null) {
        // ä¿å­˜æ–°æ¨¡æ¿ï¼Œå¦‚æœè¾“å…¥ä¸ºç©ºåˆ™æ¢å¤é»˜è®¤
        chat.settings.innerVoiceAdopterLabelFormat = newFormat.trim() || 'é¢†å…»äºº: {{user}}';
        await db.chats.put(chat);
        
        // é‡æ–°æ¸²æŸ“å¿ƒå£°é¢æ¿ä»¥æ˜¾ç¤ºæ–°æ ‡ç­¾
        openInnerVoiceModal(); 
        await showCustomAlert('ä¿®æ”¹æˆåŠŸ', 'é¢†å…»äººæ ‡ç­¾å·²æ›´æ–°ï¼');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°é¢æ¿æ ·å¼ç¼–è¾‘åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

/**
 * å°†åå…­è¿›åˆ¶é¢œè‰²(#FFFFFF)è½¬æ¢ä¸º "R, G, B" å­—ç¬¦ä¸² (255, 255, 255)
 * @param {string} hex - åå…­è¿›åˆ¶é¢œè‰²ä»£ç 
 * @returns {string} - RGBå­—ç¬¦ä¸²
 */
function hexToRgb(hex) {
    if (!hex || hex.length < 4) return '255, 255, 255';
    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255, 255, 255';
}

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ applySavedInnerVoiceStyles å‡½æ•° â–¼â–¼â–¼
/**
 * å°†ä¿å­˜çš„æ ·å¼åº”ç”¨åˆ°å¿ƒå£°é¢æ¿
 */
function applySavedInnerVoiceStyles() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.innerVoiceStyles) return;

    const styles = chat.settings.innerVoiceStyles;
    const panel = document.getElementById('inner-voice-main-panel');

    panel.style.setProperty('--iv-color-clothing', styles.clothingColor);
    panel.style.setProperty('--iv-color-behavior', styles.behaviorColor);
    panel.style.setProperty('--iv-color-thoughts', styles.thoughtsColor);
    panel.style.setProperty('--iv-color-naughty', styles.naughtyColor);
    panel.style.setProperty('--iv-card-bg-rgb', hexToRgb(styles.cardBgColor));
    panel.style.setProperty('--iv-card-opacity', styles.cardOpacity);
    
    // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡Œåº”ç”¨æˆ‘ä»¬ä¿å­˜çš„å›¾æ ‡é¢œè‰²ï¼ â˜…â˜…â˜…
    panel.style.setProperty('--iv-icon-color', styles.iconColor || '#ff8a80');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ openInnerVoiceStyleEditor å‡½æ•° â–¼â–¼â–¼
/**
 * æ‰“å¼€å¿ƒå£°é¢æ¿æ ·å¼ç¼–è¾‘å™¨
 */
function openInnerVoiceStyleEditor() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.settings.innerVoiceStyles) return;

    document.getElementById('inner-voice-edit-options-modal')?.classList.remove('visible');
    
    const styles = chat.settings.innerVoiceStyles;
    const modal = document.getElementById('inner-voice-editor-modal');
    
    // åŠ è½½å½“å‰æ ·å¼åˆ°ç¼–è¾‘å™¨
    document.getElementById('iv-color-clothing').value = styles.clothingColor;
    document.getElementById('iv-color-behavior').value = styles.behaviorColor;
    document.getElementById('iv-color-thoughts').value = styles.thoughtsColor;
    document.getElementById('iv-color-naughty').value = styles.naughtyColor;
    document.getElementById('iv-card-bg-color').value = styles.cardBgColor;
    document.getElementById('iv-opacity-slider').value = styles.cardOpacity;
    document.getElementById('iv-opacity-value').textContent = `${Math.round(styles.cardOpacity * 100)}%`;
    
    // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡ŒåŠ è½½æˆ‘ä»¬ä¿å­˜çš„å›¾æ ‡é¢œè‰²ï¼ â˜…â˜…â˜…
    document.getElementById('iv-icon-color').value = styles.iconColor || '#ff8a80';

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ä¿å­˜ç”¨æˆ·ä¿®æ”¹çš„æ ·å¼
 */
async function saveInnerVoiceStyles() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // ä»ç¼–è¾‘å™¨è¯»å–æ–°å€¼
    const newStyles = {
        clothingColor: document.getElementById('iv-color-clothing').value,
        behaviorColor: document.getElementById('iv-color-behavior').value,
        thoughtsColor: document.getElementById('iv-color-thoughts').value,
        naughtyColor: document.getElementById('iv-color-naughty').value,
        cardBgColor: document.getElementById('iv-card-bg-color').value,
        cardOpacity: parseFloat(document.getElementById('iv-opacity-slider').value),
        iconColor: document.getElementById('iv-icon-color').value
    };

    // æ›´æ–°åˆ°stateå’Œæ•°æ®åº“
    chat.settings.innerVoiceStyles = newStyles;
    await db.chats.put(chat);
    
    // å…³é—­å¼¹çª—
    document.getElementById('inner-voice-editor-modal').classList.remove('visible');
    
    // é‡æ–°åº”ç”¨ä¸€ä¸‹æœ€ç»ˆä¿å­˜çš„æ ·å¼ï¼Œä»¥é˜²ä¸‡ä¸€
    applySavedInnerVoiceStyles();
    
    await showCustomAlert('ä¿å­˜æˆåŠŸ', 'å¿ƒå£°é¢æ¿çš„æ ·å¼å·²æ›´æ–°ï¼');
}

/* â–²â–²â–² æ–°åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„åŠŸèƒ½å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ã€æ­£ä¸Šæ–¹ã€‘ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€AIç”Ÿæˆç¾¤æˆå‘˜çš„æ¨¡æ€æ¡†
 */
function openAiGenerateMembersModal() {
    // æ¸…ç©ºä¸Šæ¬¡çš„è¾“å…¥
    document.getElementById('ai-member-count-input').value = '3';
    document.getElementById('ai-member-prompt-input').value = '';
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('ai-generate-members-modal').classList.add('visible');
}

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ handleGenerateMembers å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | AIæ ¸å¿ƒã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆâ€æŒ‰é’®çš„é€»è¾‘ (å·²ä¿®å¤)
 */
async function handleGenerateMembers() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) return;

    const count = parseInt(document.getElementById('ai-member-count-input').value);
    const requirements = document.getElementById('ai-member-prompt-input').value.trim();

    if (isNaN(count) || count < 1 || count > 20) {
        alert('è¯·è¾“å…¥1åˆ°20ä¹‹é—´çš„æœ‰æ•ˆäººæ•°ï¼');
        return;
    }

    document.getElementById('ai-generate-members-modal').classList.remove('visible');
    await showCustomAlert("è¯·ç¨å€™...", `AIæ­£åœ¨ä¸ºâ€œ${chat.name}â€åˆ›é€  ${count} ä½æ–°æœ‹å‹...`);

    const systemPrompt = `
# ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠæˆå‘˜ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œä¸ºç¾¤èŠâ€œ${chat.name}â€åˆ›å»º${count}ä¸ªæ–°æˆå‘˜ã€‚

# ç”¨æˆ·è¦æ±‚:
${requirements || 'æ— ç‰¹æ®Šè¦æ±‚ï¼Œè¯·è‡ªç”±å‘æŒ¥ã€‚'}

# æ ¸å¿ƒè§„åˆ™
1.  ä½ ç”Ÿæˆçš„æ¯ä¸ªæˆå‘˜éƒ½å¿…é¡»æœ‰ç‹¬ç‰¹çš„åå­—(name)å’Œé²œæ˜çš„æ€§æ ¼äººè®¾(persona)ã€‚
2.  äººè®¾æè¿°è¦ç”ŸåŠ¨ã€å…·ä½“ï¼Œèƒ½ä½“ç°å‡ºè§’è‰²çš„ç‰¹ç‚¹ã€‚
3.  ã€æ ¼å¼é“å¾‹ã€‘: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥'['å¼€å¤´, ä»¥']'ç»“å°¾ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä»£è¡¨æˆå‘˜çš„JSONå¯¹è±¡ã€‚

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
[
  {
    "name": "æ—é£",
    "persona": "ä¸€ä¸ªé˜³å…‰å¼€æœ—çš„è¿åŠ¨ç³»å°‘å¹´ï¼Œçƒ­çˆ±ç¯®çƒï¼Œæ€§æ ¼ç›´çˆ½ï¼Œæ˜¯å›¢é˜Ÿé‡Œçš„æ°”æ°›æ‹…å½“ã€‚"
  },
  {
    "name": "é™ˆé›ª",
    "persona": "æ–‡é™å†…å‘çš„å­¦éœ¸å°‘å¥³ï¼Œå–œæ¬¢è¯»ä¹¦å’Œç”»ç”»ï¼Œå¿ƒæ€ç»†è…»ï¼Œä¸å–„è¨€è¾ä½†è§‚å¯ŸåŠ›æ•é”ã€‚"
  }
]
`;

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        let isGemini = proxyUrl === GEMINI_API_URL;
        let messagesForApi = [{ role: 'user', content: systemPrompt }];
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '').trim();
        const newMembersData = JSON.parse(rawContent);

        if (Array.isArray(newMembersData) && newMembersData.length > 0) {
            const addedNames = [];
            newMembersData.forEach((memberData, index) => {
                if (memberData.name && memberData.persona) {
                    const newMember = {
                        id: 'npc_' + (Date.now() + index),
                        originalName: memberData.name.trim(),
                        groupNickname: memberData.name.trim(),
                        avatar: defaultGroupMemberAvatar,
                        persona: memberData.persona.trim(),
                        avatarFrame: '',
                        isAdmin: false,
                        groupTitle: ''
                    };
                    chat.members.push(newMember);
                    addedNames.push(`â€œ${newMember.groupNickname}â€`);
                }
            });

            if (addedNames.length > 0) {
                await db.chats.put(chat);
                await logSystemMessage(chat.id, `é‚€è¯·äº† ${addedNames.length} ä½æ–°æˆå‘˜: ${addedNames.join('ã€')}åŠ å…¥äº†ç¾¤èŠã€‚`);
                await showCustomAlert("ç”ŸæˆæˆåŠŸï¼", `${addedNames.length} ä½æ–°æˆå‘˜å·²åŠ å…¥ç¾¤èŠï¼`);
                renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨

                // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå°±æ˜¯åˆ é™¤äº†ä¸‹é¢è¿™ä¸€è¡Œï¼ â˜…â˜…â˜…â˜…â˜…
                // renderGroupMemberSettings(chat.members); 

            } else {
                throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘nameæˆ–personaå­—æ®µã€‚");
            }
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ã€‚");
        }
    } catch (error) {
        console.error("AIç”Ÿæˆç¾¤æˆå‘˜å¤±è´¥:", error);
        await showCustomAlert('ç”Ÿæˆå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–° | å½»åº•é‡æ„ã€‘çº¦ä¼šå¤§ä½œæˆ˜ - é‚€è¯·ä¸æ”¯ä»˜æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ V2ã€‘å½“ç”¨æˆ·ç‚¹å‡»çº¦ä¼šå¡ç‰‡æ—¶ï¼Œæ‰“å¼€è§’è‰²é€‰æ‹©å™¨
 * @param {object} scene - è¢«é€‰ä¸­çš„çº¦ä¼šåœºæ™¯å¯¹è±¡
 */
async function openDatingCharacterSelector(scene) {
    const modal = document.getElementById('dating-char-selector-modal');
    const listEl = document.getElementById('dating-char-selector-list');
    listEl.innerHTML = '';

    // 1. æ‰¾å‡ºæ‰€æœ‰å¯çº¦ä¼šçš„å•èŠè§’è‰²
    const singleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (singleChats.length === 0) {
        alert("ä½ è¿˜æ²¡æœ‰ä»»ä½•å¯ä»¥çº¦ä¼šçš„è§’è‰²å“¦ï¼Œå…ˆå»åˆ›å»ºä¸€ä¸ªå§ï¼");
        return;
    }

    // 2. ä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºåˆ—è¡¨é¡¹
    singleChats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'character-select-item'; // å¤ç”¨ç°æœ‰çš„æ ·å¼
        item.dataset.charId = chat.id; // å°†è§’è‰²IDå­˜èµ·æ¥
        item.innerHTML = `
            <img src="${chat.settings.aiAvatar || defaultAvatar}" alt="${chat.name}">
            <span class="name">${chat.name}</span>
        `;
        // 3. ã€æ ¸å¿ƒã€‘ä¸ºæ¯ä¸ªè§’è‰²é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
        item.addEventListener('click', () => {
            modal.classList.remove('visible'); // ç‚¹å‡»åå…ˆå…³é—­é€‰æ‹©å™¨
            openDatingInvitationModal(scene, chat.id); // ç„¶åå¸¦ç€åœºæ™¯å’Œè§’è‰²IDï¼Œæ‰“å¼€æ”¯ä»˜å¼¹çª—
        });
        listEl.appendChild(item);
    });

    // ç»‘å®šå–æ¶ˆæŒ‰é’®
    document.getElementById('dating-cancel-char-select-btn').onclick = () => modal.classList.remove('visible');
    
    // 4. æ˜¾ç¤ºè§’è‰²é€‰æ‹©å¼¹çª—
    modal.classList.add('visible');
}


/**
 * ã€V3 | æœ€ç»ˆæ”¯ä»˜ä¿®å¤ç‰ˆã€‘æ‰“å¼€æ”¯ä»˜æ–¹å¼é€‰æ‹©çš„æ¨¡æ€æ¡†
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 * @param {string} targetCharId - è¢«é‚€è¯·è§’è‰²çš„ID
 */
async function openDatingInvitationModal(scene, targetCharId) {
    const modal = document.getElementById('dating-payment-modal');
    document.getElementById('dating-modal-scene-name').textContent = scene.name;
    document.getElementById('dating-modal-scene-cost').textContent = `é¢„è®¡èŠ±è´¹: ${scene.cost}é‡‘å¸`;

    const optionsContainer = document.getElementById('dating-payment-options');
    optionsContainer.innerHTML = ''; // æ¸…ç©ºæ—§æŒ‰é’®

    const chat = state.chats[targetCharId];
    if (!chat) return;

    // --- æŒ‰é’®1ï¼šæˆ‘æ¥ä»˜å…¨æ¬¾ ---
    const userPayBtn = document.createElement('button');
    userPayBtn.className = 'form-button';
    userPayBtn.textContent = 'æˆ‘æ¥ä»˜å…¨æ¬¾';
    userPayBtn.onclick = async () => {
        const userBalance = state.globalSettings.userBalance || 0;
        if (userBalance < scene.cost) {
            await showCustomAlert("ä½™é¢ä¸è¶³", "ä½ çš„é’±åŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œæ— æ³•æ”¯ä»˜è¿™æ¬¡çº¦ä¼šçš„èŠ±è´¹ï¼");
            return;
        }
        await updateUserBalanceAndLogTransaction(-scene.cost, `çº¦ä¼šæ”¯å‡º: ${scene.name}`);
        await showCustomAlert("æ”¯ä»˜æˆåŠŸ", `å·²æˆåŠŸæ”¯ä»˜ ${scene.cost}é‡‘å¸ï¼`);
        modal.classList.remove('visible');
        startDatingScene(scene, targetCharId, 'user'); // è®°å½•ç”±useræ”¯ä»˜
    };
    optionsContainer.appendChild(userPayBtn);

    // --- æŒ‰é’®2ï¼šè®©å¯¹æ–¹ä»˜å…¨æ¬¾ ---
    const charPayBtn = document.createElement('button');
    charPayBtn.className = 'form-button';
    charPayBtn.textContent = `è®© ${chat.name} ä»˜å…¨æ¬¾`;
    charPayBtn.onclick = async () => {
        const charBalance = chat.characterPhoneData?.bank?.balance || 0;
        if (charBalance < scene.cost) {
            await showCustomAlert("å¯¹æ–¹ä½™é¢ä¸è¶³", `â€œ${chat.name}â€çš„é’±åŒ…å¥½åƒä¸å¤Ÿæ”¯ä»˜è¿™æ¬¡çº¦ä¼šçš„è´¹ç”¨å“¦ã€‚`);
            return;
        }
        // ã€æ ¸å¿ƒä¿®å¤ã€‘è°ƒç”¨å‡½æ•°ï¼Œæ‰£é™¤è§’è‰²çš„ä½™é¢
        await updateCharacterPhoneBankBalance(targetCharId, -scene.cost, `çº¦ä¼šæ”¯å‡º: ${scene.name}`);
        await showCustomAlert("æ”¯ä»˜æˆåŠŸ", `â€œ${chat.name}â€çˆ½å¿«åœ°ä¹°å•äº†ï¼`);
        modal.classList.remove('visible');
        startDatingScene(scene, targetCharId, 'char'); // è®°å½•ç”±charæ”¯ä»˜
    };
    optionsContainer.appendChild(charPayBtn);

    // --- æŒ‰é’®3ï¼šAAåˆ¶ ---
    const aaPayBtn = document.createElement('button');
    aaPayBtn.className = 'form-button';
    aaPayBtn.textContent = 'æˆ‘ä»¬AAåˆ¶å§';
    aaPayBtn.onclick = async () => {
        const splitCost = scene.cost / 2;
        const userBalance = state.globalSettings.userBalance || 0;
        const charBalance = chat.characterPhoneData?.bank?.balance || 0;

        if (userBalance < splitCost) {
            await showCustomAlert("ä½™é¢ä¸è¶³", "ä½ çš„é’±åŒ…ä¸å¤Ÿæ”¯ä»˜AAçš„è´¹ç”¨å“¦ï¼");
            return;
        }
        if (charBalance < splitCost) {
            await showCustomAlert("å¯¹æ–¹ä½™é¢ä¸è¶³", `â€œ${chat.name}â€çš„é’±åŒ…ä¸å¤Ÿæ”¯ä»˜AAçš„è´¹ç”¨å“¦ã€‚`);
            return;
        }
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ—¶æ‰£é™¤åŒæ–¹çš„ä½™é¢
        await updateUserBalanceAndLogTransaction(-splitCost, `çº¦ä¼šAAæ”¯å‡º: ${scene.name}`);
        await updateCharacterPhoneBankBalance(targetCharId, -splitCost, `çº¦ä¼šAAæ”¯å‡º: ${scene.name}`);

        await showCustomAlert("æ”¯ä»˜æˆåŠŸ", `ä½ ä»¬æ„‰å¿«åœ°å†³å®šAAåˆ¶ï¼`);
        modal.classList.remove('visible');
        startDatingScene(scene, targetCharId, 'aa'); // è®°å½•ä¸ºAAåˆ¶
    };
    optionsContainer.appendChild(aaPayBtn);
    
    // --- æŒ‰é’®4ï¼šæ‰¾äººå€Ÿé’± (ä¿æŒä¸å˜) ---
    const otherChars = Object.values(state.chats).filter(c => !c.isGroup && c.id !== targetCharId);
    if (otherChars.length > 0) {
        const borrowBtn = document.createElement('button');
        borrowBtn.className = 'form-button';
        borrowBtn.textContent = 'æˆ‘é’±ä¸å¤Ÿï¼Œæ‰¾åˆ«äººå€Ÿç‚¹...';
        borrowBtn.onclick = () => {
            modal.classList.remove('visible');
            openBorrowMoneyModal(scene, targetCharId);
        };
        optionsContainer.appendChild(borrowBtn);
    }
    
    // ç»‘å®šå–æ¶ˆæŒ‰é’®
    document.getElementById('dating-cancel-btn').onclick = () => modal.classList.remove('visible');
    // æ˜¾ç¤ºå¼¹çª—
    modal.classList.add('visible');
}

/**
 * ã€é‡æ„ç‰ˆã€‘å¤„ç†ç”¨æˆ·ä»˜å…¨æ¬¾çš„é€»è¾‘
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 * @param {string} targetCharId - è¢«é‚€è¯·è§’è‰²çš„ID
 */
async function handleUserPaysForDate(scene, targetCharId) {
    const cost = scene.cost;
    const userBalance = state.globalSettings.userBalance || 0;

    if (userBalance < cost) {
        await showCustomAlert("ä½™é¢ä¸è¶³", "ä½ çš„é’±åŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œæ— æ³•æ”¯ä»˜è¿™æ¬¡çº¦ä¼šçš„èŠ±è´¹ï¼");
        return;
    }

    await updateUserBalanceAndLogTransaction(-cost, `çº¦ä¼šæ”¯å‡º: ${scene.name}`);
    await showCustomAlert("æ”¯ä»˜æˆåŠŸ", `å·²æˆåŠŸæ”¯ä»˜ ${cost}é‡‘å¸ï¼ç°åœ¨å¯ä»¥å¼€å§‹ä½ ä»¬çš„çº¦ä¼šäº†ã€‚`);

    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å·²ä¸ºçº¦ä¼šâ€œ${scene.name}â€ä»˜æ¬¾ï¼ŒèŠ±è´¹${cost}é‡‘å¸ã€‚ç°åœ¨çº¦ä¼šæ­£å¼å¼€å§‹ï¼Œè¯·æ ¹æ®åœºæ™¯å’Œäººè®¾ï¼Œå¼€å¯ä¸€æ®µæµªæ¼«çš„çº¦ä¼šå¯¹è¯ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ¶ˆæ¯æ·»åŠ åˆ°ã€ç›®æ ‡è§’è‰²ã€‘çš„èŠå¤©è®°å½•ä¸­
    const chat = state.chats[targetCharId];
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);
    
    // æ‰“å¼€ä¸è¯¥è§’è‰²çš„èŠå¤©å¹¶è§¦å‘å›åº”
    openChat(targetCharId);
    triggerAiResponse();
}

/**
 * ã€é‡æ„ç‰ˆã€‘å‘AIè¯·æ±‚è®©å®ƒä»˜å…¨æ¬¾
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 * @param {string} targetCharId - è¢«é‚€è¯·è§’è‰²çš„ID
 */
async function requestCharToPay(scene, targetCharId) {
    const chat = state.chats[targetCharId];
    const cost = scene.cost;

    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·é‚€è¯·ä½ è¿›è¡Œçº¦ä¼šâ€œ${scene.name}â€ï¼Œå¹¶å¸Œæœ›ç”±ä½ æ¥æ”¯ä»˜å…¨éƒ¨è´¹ç”¨ï¼ˆ${cost}é‡‘å¸ï¼‰ã€‚ä½ çš„é’±åŒ…ä½™é¢æ˜¯ ${chat.characterPhoneData.bank.balance.toFixed(2)} é‡‘å¸ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ã€ä½ ä¸ç”¨æˆ·çš„å…³ç³»ä»¥åŠä½ çš„é’±åŒ…ä½™é¢ï¼Œå†³å®šæ˜¯å¦åŒæ„ã€‚ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ 'dating_payment_response' æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };

    chat.history.push(hiddenMessage);
    await db.chats.put(chat);
    
    await showCustomAlert("è¯·æ±‚å·²å‘é€", `å·²å‘ ${chat.name} å‘å‡ºè¯·æ±‚ï¼Œè¯·åˆ°èŠå¤©ä¸­æŸ¥çœ‹Taçš„å›åº”å§ã€‚`);
    openChat(targetCharId);
    triggerAiResponse();
}

/**
 * ã€é‡æ„ç‰ˆã€‘å‘AIè¯·æ±‚AAåˆ¶
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 * @param {string} targetCharId - è¢«é‚€è¯·è§’è‰²çš„ID
 */
async function requestAAsplit(scene, targetCharId) {
    const chat = state.chats[targetCharId];
    const splitCost = scene.cost / 2;

    if ((state.globalSettings.userBalance || 0) < splitCost) {
        await showCustomAlert("ä½™é¢ä¸è¶³", `ä½ çš„ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜AAåˆ¶çš„è´¹ç”¨ï¼ˆ${splitCost.toFixed(2)}é‡‘å¸ï¼‰ï¼`);
        return;
    }
    
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·é‚€è¯·ä½ è¿›è¡Œçº¦ä¼šâ€œ${scene.name}â€ï¼Œå¹¶æè®®AAåˆ¶ï¼Œå³å„è‡ªæ”¯ä»˜ ${splitCost.toFixed(2)} é‡‘å¸ã€‚ä½ çš„é’±åŒ…ä½™é¢æ˜¯ ${chat.characterPhoneData.bank.balance.toFixed(2)} é‡‘å¸ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å’Œä½ ä¸ç”¨æˆ·çš„å…³ç³»ï¼Œå†³å®šæ˜¯å¦åŒæ„ã€‚ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ 'dating_aa_response' æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);

    await showCustomAlert("è¯·æ±‚å·²å‘é€", `å·²å‘ ${chat.name} å‘å‡ºAAåˆ¶çš„æè®®ï¼Œè¯·åˆ°èŠå¤©ä¸­æŸ¥çœ‹Taçš„å›åº”å§ã€‚`);
    openChat(targetCharId);
    triggerAiResponse();
}


// â–¼â–¼â–¼ ã€å…¨æ–° | V2ç‰ˆã€‘çº¦ä¼šå€Ÿé’±åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€V2 | å¸¦å¤´åƒã€å¯æ»‘åŠ¨ã€‘æ‰“å¼€â€œæ‰¾äººå€Ÿé’±â€çš„é€‰æ‹©åˆ—è¡¨
 * @param {object} scene - çº¦ä¼šåœºæ™¯å¯¹è±¡
 * @param {string} dateTargetCharId - ä½ çš„çº¦ä¼šå¯¹è±¡ID
 */
async function openBorrowMoneyModal(scene, dateTargetCharId) {
    const modal = document.getElementById('borrow-money-modal');
    const listEl = document.getElementById('borrow-money-char-list');
    listEl.innerHTML = '';

    const otherChars = Object.values(state.chats).filter(c => !c.isGroup && c.id !== dateTargetCharId);

    if (otherChars.length === 0) {
        alert("æ²¡æœ‰å…¶ä»–å¯ä»¥å€Ÿé’±çš„æœ‹å‹äº†ã€‚");
        return;
    }

    otherChars.forEach(char => {
        const item = document.createElement('div');
        item.className = 'character-select-item'; // å¤ç”¨æ ·å¼
        item.dataset.charId = char.id;
        item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" alt="${char.name}">
            <span class="name">${char.name}</span>
        `;
        item.addEventListener('click', async () => {
            modal.classList.remove('visible');
            const borrowAmountStr = await showCustomPrompt("å€Ÿå¤šå°‘ï¼Ÿ", "è¯·è¾“å…¥ä½ æƒ³å€Ÿçš„é‡‘é¢", "", "number");
            const borrowAmount = parseFloat(borrowAmountStr);
            if (borrowAmount > 0) {
                await requestToBorrowMoney(scene, dateTargetCharId, char.id, borrowAmount);
            } else if (borrowAmountStr !== null) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å€Ÿæ¬¾é‡‘é¢ï¼");
            }
        });
        listEl.appendChild(item);
    });

    document.getElementById('borrow-money-cancel-btn').onclick = () => modal.classList.remove('visible');
    modal.classList.add('visible');
}

async function requestToBorrowMoney(scene, dateTargetCharId, lenderChatId, amount) {
    const dateTargetChat = state.chats[dateTargetCharId]; 
    const lenderChat = state.chats[lenderChatId];     
    if (!lenderChat || !dateTargetChat) return;

    const myNickname = dateTargetChat.settings.myNickname || 'æˆ‘';

    // 1. å…ˆæ„å»ºpayloadå’Œæ–‡æœ¬å†…å®¹ï¼Œæ–¹ä¾¿å¤ç”¨
    const reasonText = `ç”¨äºå’Œâ€œ${dateTargetChat.name}â€åœ¨â€œ${scene.name}â€çš„çº¦ä¼šã€‚`;
    const payloadData = {
        lenderName: lenderChat.name,
        amount: amount,
        reason: reasonText
    };
    // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ–‡æœ¬æ¶ˆæ¯å†…å®¹ â˜…â˜…â˜…
    const textContent = `å‘ ${lenderChat.name} å€Ÿé’± ${amount.toFixed(2)}å…ƒï¼Œ${reasonText}`;

    // 2. åˆ›å»ºå®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒæ—¶åŒ…å« payload å’Œ content
    const borrowRequestMessage = {
        role: 'user',
        type: 'borrow_money_request',
        timestamp: Date.now(),
        payload: payloadData,      // payload ç”¨äºæ¸²æŸ“å€Ÿæ¡å¡ç‰‡ï¼ˆä¿æŒä¸å˜ï¼‰
        content: textContent       // content ç”¨äºæ˜¾ç¤ºä¸ºæ–‡æœ¬æ¶ˆæ¯ï¼ˆè¿™æ˜¯æ–°å¢çš„ï¼‰
    };
    
    // å°†å€Ÿæ¡å‘åˆ°â€œå€ºä¸»â€çš„èŠå¤©é‡Œ (è¿™éƒ¨åˆ†ä»£ç ä¿æŒä¸å˜)
    lenderChat.history.push(borrowRequestMessage);
    
    // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆ›å»ºç»™AIçœ‹çš„ã€å¸¦æœ‰è¯¦ç»†ä¿¡æ¯çš„éšè—æŒ‡ä»¤
    const hiddenMessage = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ· â€œ${myNickname}â€ æƒ³å‘ä½ å€Ÿ ${amount.toFixed(2)} é‡‘å¸ï¼Œç”¨äºå’Œ â€œ${dateTargetChat.name}â€ åœ¨ â€œ${scene.name}â€ çº¦ä¼šã€‚ä½ çš„é’±åŒ…ä½™é¢æ˜¯ ${lenderChat.characterPhoneData.bank.balance.toFixed(2)} é‡‘å¸ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ã€ä½ å’Œç”¨æˆ·çš„å…³ç³»ä»¥åŠä½ çš„é’±åŒ…ä½™é¢ï¼Œå†³å®šæ˜¯å¦å€Ÿé’±ã€‚ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ 'lend_money_response' æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ï¼Œå¹¶å¯ä»¥åœ¨æ–‡æœ¬æ¶ˆæ¯ä¸­è¯´æ˜ç†ç”±ã€‚]`,
        timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
        isHidden: true
    };
    lenderChat.history.push(hiddenMessage);
    await db.chats.put(lenderChat);

    await showCustomAlert("å€Ÿé’±è¯·æ±‚å·²å‘é€", `å·²å‘â€œ${lenderChat.name}â€å‘èµ·äº†å€Ÿæ¬¾è¯·æ±‚ï¼Œè¯·åˆ°å’ŒTaçš„èŠå¤©ä¸­æŸ¥çœ‹ç»“æœã€‚`);
    
    // æ‰“å¼€ä¸â€œå€ºä¸»â€çš„èŠå¤©å¹¶è§¦å‘å›åº”
    openChat(lenderChatId);
    triggerAiResponse();
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜-æ–‡æ¸¸æ¨¡å¼æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼

let datingGameState = {
    isActive: false,
    scene: null,
    characterId: null,
    storyHistory: [], // ç”¨äºè®°å½•å¯¹è¯å†å²ï¼Œæ–¹ä¾¿AIç”Ÿæˆåç»­å†…å®¹
};
// â–¼â–¼â–¼ ã€æœ€ç»ˆæ¸å˜ç‰ˆã€‘ç”¨è¿™æ•´å—æ–°ä»£ç ï¼Œæ›¿æ¢æ—§çš„ renderDatingValues å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æœ€ç»ˆç‰ˆ | SVG æ¸å˜å¡«å……ã€‘æ¸²æŸ“çº¦ä¼šæ•°å€¼æ¡ï¼ˆå¿ƒå½¢UIï¼‰
 * è¿™ä¸ªç‰ˆæœ¬ä½¿ç”¨çº¿æ€§æ¸å˜ï¼Œæœ€ç¨³å®šã€æœ€é«˜æ•ˆã€‚
 */
function renderDatingValues() {
    const romanceContainer = document.getElementById('romance-value');
    const lustContainer = document.getElementById('lust-value');
    if (!romanceContainer || !lustContainer) return;

    // æ¸…ç©ºæ—§çš„å¿ƒå½¢
    romanceContainer.innerHTML = '';
    lustContainer.innerHTML = '';

    // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“ä¸€ä¸ªå®Œæ•´çš„æ•°å€¼æ¡
    const renderValueBar = (container, value, type) => {
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥åœ¨è¿™é‡Œå®šä¹‰é¢œè‰²ï¼Œä¸å†ä½¿ç”¨CSSå˜é‡ â˜…â˜…â˜…
        const fillColor = type === 'romance' ? '#ff8fab' : '#ffde59'; // ç²‰è‰²ä»£è¡¨æµªæ¼«ï¼Œé»„è‰²ä»£è¡¨æ€§æ¬²
        // â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…

        const emptyColor = '#ccc';
        const emptyOpacity = '0.3';

        for (let i = 0; i < 5; i++) {
            // è®¡ç®—å½“å‰è¿™é¢—å¿ƒåº”è¯¥è¢«å¡«å……çš„ç™¾åˆ†æ¯” (0-100)
            const fillPercentage = Math.max(0, Math.min(100, (value - i * 20) * 5));
            
            // ä¸ºæ¯ä¸ªSVGçš„æ¸å˜æ•ˆæœç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ID
            const gradientId = `heart-gradient-${type}-${i}`;

            const heartSvg = `
                <svg viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="${gradientId}" x1="0" x2="0" y1="1" y2="0">
                            <stop offset="${fillPercentage}%" stop-color="${fillColor}" />
                            <stop offset="${fillPercentage}%" stop-color="${emptyColor}" stop-opacity="${emptyOpacity}" />
                        </linearGradient>
                    </defs>
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                          fill="url(#${gradientId})"
                          stroke="#aaa" 
                          stroke-width="1.5"/>
                </svg>
            `;
            container.innerHTML += heartSvg;
        }
    };
    
    // è°ƒç”¨å‡½æ•°ï¼Œæ¸²æŸ“ä¸¤ä¸ªæ•°å€¼æ¡
    renderValueBar(romanceContainer, datingGameState.romance, 'romance');
    renderValueBar(lustContainer, datingGameState.lust, 'lust');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




/**
 * ã€æ€»å…¥å£ V3ã€‘å¼€å§‹ä¸€åœºçº¦ä¼š (å·²é€‚é…æ–°ç‰ˆæ–‡æ¸¸é€»è¾‘)
 */
async function startDatingScene(scene, targetCharId) {
    console.log(`å¼€å§‹çº¦ä¼š: åœºæ™¯="${scene.name}", è§’è‰²ID=${targetCharId}`);

    datingGameState = {
        isActive: true,
        scene: scene,
        characterId: targetCharId,
        storyHistory: [],
        romance: 0,
        lust: 0,
        currentStoryText: "",
        currentSentenceIndex: -1,
        sentences: [],
        isSwitchingSentence: false,
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
        isNsfwMode: false, 
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    };


    const chat = state.chats[targetCharId];
    if (!chat) return;

    // 2. å‡†å¤‡UIå…ƒç´ 
    const backgroundEl = document.getElementById('dating-game-background');
    const charNameEl = document.getElementById('dating-game-char-name');
    const textContentEl = document.getElementById('dating-game-text-content');
    const choicesEl = document.getElementById('dating-game-choices');

    // 3. é‡ç½®UIåˆ°åˆå§‹çŠ¶æ€
    charNameEl.textContent = chat.name;
    backgroundEl.style.backgroundImage = 'none';
    textContentEl.innerHTML = '<p>AIæ­£åœ¨ç²¾å¿ƒæ„ç­‘ä½ ä»¬çš„çº¦ä¼šä¸–ç•Œ...</p>';
    textContentEl.parentElement.style.opacity = 1;
    choicesEl.innerHTML = '';
    
    // 4. æ˜¾ç¤ºæ¸¸æˆç•Œé¢
    showScreen('dating-game-screen');

    // 5. å¹¶è¡ŒåŠ è½½èƒŒæ™¯å›¾å’Œç¬¬ä¸€æ®µå‰§æƒ…
    const imagePrompt = scene.imagePrompt + ", vertical, phone wallpaper, cinematic lighting, masterpiece, best quality, beautiful anime style art";
    generateAndLoadImage(imagePrompt)
        .then(imageUrl => { backgroundEl.style.backgroundImage = `url(${imageUrl})`; })
        .catch(error => { 
            console.error("çº¦ä¼šèƒŒæ™¯å›¾åŠ è½½å¤±è´¥:", error);
            backgroundEl.style.backgroundColor = '#1c1e26';
        });
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
    // é‡ç½®æ•°å€¼
    datingGameState.romance = 0;
    datingGameState.lust = 0;
        // é‡ç½®å¹¶æ˜¾ç¤ºå®Œæˆåº¦è¿›åº¦æ¡
    datingGameState.completion = 0;
    renderDatingCompletion();
    document.getElementById('dating-completion-bar-container').style.display = 'block';
    // æ¸²æŸ“å¹¶æ˜¾ç¤ºå¿ƒå½¢UI
    renderDatingValues();
    document.getElementById('dating-values-container').style.display = 'flex';
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    await triggerDatingStory("start");
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ¸²æŸ“å®Œæˆåº¦è¿›åº¦æ¡çš„UIå‡½æ•° â–¼â–¼â–¼
/**
 * æ¸²æŸ“å¹¶æ›´æ–°çº¦ä¼šå®Œæˆåº¦è¿›åº¦æ¡çš„UI
 */
function renderDatingCompletion() {
    const container = document.getElementById('dating-completion-bar-container');
    const fill = document.getElementById('dating-completion-bar-fill');
    const text = document.getElementById('dating-completion-text');

    if (!container || !fill || !text) return;
    
    // ä»æ¸¸æˆçŠ¶æ€ä¸­è·å–å®Œæˆåº¦
    const completion = datingGameState.completion || 0;
    
    // æ›´æ–°å¡«å……æ¡çš„å®½åº¦å’Œç™¾åˆ†æ¯”æ–‡å­—
    fill.style.width = `${completion}%`;
    text.textContent = `${Math.round(completion)}%`;
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V5 | æœ€ç»ˆæµªæ¼«ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ triggerDatingStory å‡½æ•° â–¼â–¼â–¼
async function triggerDatingStory(userAction) {
  datingGameState.isNsfwMode = false;
    if (!datingGameState.isActive) return;

    const { scene, characterId, storyHistory } = datingGameState;
    const chat = state.chats[characterId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert("APIæœªé…ç½®ï¼Œæ— æ³•ç»§ç»­çº¦ä¼šã€‚");
        return;
    }
    
    if (userAction !== "start") {
        storyHistory.push(`ã€ä½ çš„é€‰æ‹©ã€‘: ${userAction}`);
    }

    const textContentEl = document.getElementById('dating-game-text-content');
    const choicesEl = document.getElementById('dating-game-choices');
    
    textContentEl.innerHTML = '<p><i>å¯¹æ–¹æ­£åœ¨æ€è€ƒ...</i></p>';
    choicesEl.innerHTML = '';

    const uiSettings = chat.settings.datingUISettings || {};
    const customPrompt = uiSettings.prompt || '';
    const customStyle = uiSettings.style || 'ä½ çš„å›å¤å¿…é¡»æ˜¯ã€ç¬¬ä¸‰äººç§°ã€‘çš„æ—ç™½ï¼Œè¯¦ç»†æç»˜åœºæ™¯ã€è§’è‰²çš„åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨ä»¥åŠå¯¹è¯ã€‚è®©ç”¨æˆ·æ„Ÿè§‰åƒåœ¨çœ‹å°è¯´ã€‚';

    let spriteContext = '';
    let spriteChoiceInstruction = '';
    const spriteGroupId = uiSettings.spriteGroupId;

    if (spriteGroupId) {
        const sprites = await db.datingSprites.where('groupId').equals(spriteGroupId).toArray();
        if (sprites.length > 0) {
            spriteContext = `
# å¯ç”¨è§’è‰²ç«‹ç»˜
ä½ æœ‰ä¸€ä¸ªç«‹ç»˜åº“ï¼Œè¯·æ ¹æ®å½“å‰æƒ…æ™¯é€‰æ‹©ä¸€ä¸ªæœ€èƒ½è¡¨è¾¾è§’è‰²â€œ${chat.name}â€å¿ƒæƒ…å’ŒåŠ¨ä½œçš„ç«‹ç»˜æè¿°ã€‚
- ${sprites.map(s => `[æè¿°: ${s.description}]`).join('\n- ')}
`;
            spriteChoiceInstruction = `"sprite": "ã€ä»ä¸Šæ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„æè¿°ï¼Œå¹¶å¡«åœ¨è¿™é‡Œã€‘",`;
        }
    }

// â–¼â–¼â–¼ ã€V6 | å®Œæˆåº¦ç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ triggerDatingStory å‡½æ•°é‡Œçš„ systemPrompt â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€V2 | æ™ºèƒ½è¯„åˆ†ç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ triggerDatingStory å‡½æ•°é‡Œçš„ systemPrompt â–¼â–¼â–¼
    const systemPrompt = `
# è§’è‰²æ‰®æ¼”ï¼šæ‹çˆ±äº’åŠ¨å°è¯´æ¸¸æˆå¼•æ“
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªé¡¶çº§çš„æ‹çˆ±äº’åŠ¨å°è¯´æ¸¸æˆå¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œæ¨åŠ¨ä¸€ä¸ªæµªæ¼«çº¦ä¼šæ•…äº‹çš„å‘å±•ã€‚
## æ•…äº‹èƒŒæ™¯
- **ä½ çš„è§’è‰²**: ä½ å°†æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ã€‚
- **ä½ çš„è§’è‰²äººè®¾**: ${chat.settings.aiPersona}\n${customPrompt}
- **ç”¨æˆ·çš„äººè®¾**: ${chat.settings.myPersona}
- **çº¦ä¼šåœºæ™¯**: ${scene.name}
${spriteContext}
## å½“å‰çº¦ä¼šçŠ¶æ€ (é‡è¦å‚è€ƒ)
- **æµªæ¼«å€¼**: ${datingGameState.romance}/100
- **æ€§æ¬²å€¼**: ${datingGameState.lust}/100
- **çº¦ä¼šå®Œæˆåº¦**: ${datingGameState.completion}%

## æ ¸å¿ƒè§„åˆ™
1.  **æ²‰æµ¸å¼å™äº‹**: ${customStyle}
2.  **æä¾›é€‰æ‹©**: åœ¨æ¯æ®µå™äº‹åï¼Œä½ ã€å¿…é¡»ã€‘æä¾› 2-4 ä¸ªä¾›ç”¨æˆ·é€‰æ‹©çš„è¡ŒåŠ¨æˆ–å¯¹è¯é€‰é¡¹ã€‚
3.  **ã€ã€ã€æ™ºèƒ½è¯„åˆ†é“å¾‹ã€‘ã€‘ã€‘**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®å½“å‰çš„æ•…äº‹è¿›å±•ã€ç”¨æˆ·çš„é€‰æ‹©ä»¥åŠä½ çš„å›åº”ï¼Œå¯¹æœ¬æ¬¡äº’åŠ¨çš„â€œè´¨é‡â€è¿›è¡Œè¯„ä¼°ï¼Œå¹¶ç»™å‡ºä¸‰ä¸ªæ•°å€¼çš„ã€å¢åŠ å€¼ã€‘ã€‚
    - **"romance" (æµªæ¼«å€¼)**: å¦‚æœäº’åŠ¨æ˜¯ç”œèœœã€æ¸©é¦¨æˆ–æ„Ÿäººçš„ï¼Œå¯ä»¥å¢åŠ 5-15åˆ†ã€‚
    - **"lust" (æ€§æ¬²å€¼)**: å¦‚æœäº’åŠ¨åŒ…å«æŒ‘é€—ã€æš—ç¤ºæˆ–èº«ä½“æ¥è§¦ï¼Œå¯ä»¥å¢åŠ 5-15åˆ†ã€‚
    - **"completion_increase" (å®Œæˆåº¦å¢åŠ å€¼)**:
        -   è¿™æ˜¯ä¸€ä¸ªã€å¯æ­£å¯è´Ÿã€‘çš„æ•°å€¼ã€‚
        -   **æ­£é¢äº’åŠ¨**: å¦‚æœç”¨æˆ·çš„é€‰æ‹©è®©å…³ç³»å‡æ¸©ï¼ˆä¾‹å¦‚ï¼Œé€‰æ‹©äº†æ›´æµªæ¼«æˆ–å¤§èƒ†çš„é€‰é¡¹ï¼‰ï¼Œä½ åº”è¯¥ç»™ä¸€ä¸ªæ­£æ•°ï¼ŒèŒƒå›´åœ¨ **3åˆ°10** ä¹‹é—´ã€‚
        -   **è´Ÿé¢äº’åŠ¨**: å¦‚æœç”¨æˆ·çš„é€‰æ‹©å¾ˆç…é£æ™¯ã€ç²—é²æˆ–å¯¼è‡´å°´å°¬ï¼Œä½ åº”è¯¥ç»™ä¸€ä¸ªã€è´Ÿæ•°ã€‘ï¼ŒèŒƒå›´åœ¨ **-10åˆ°-1** ä¹‹é—´ï¼Œè¡¨ç¤ºçº¦ä¼šè¿›åº¦å€’é€€ã€‚
        -   **å¹³æ·¡äº’åŠ¨**: å¦‚æœäº’åŠ¨å¾ˆå¹³æ·¡æˆ–åªæ˜¯è¿‡æ¸¡ï¼Œå¯ä»¥ç»™ **0** æˆ– **1-2** åˆ†ã€‚
4.  **ã€ã€ã€ç»“æŸæ—¶æœºé“å¾‹ã€‘ã€‘ã€‘**: å½“ä½ è®¤ä¸ºæ•…äº‹å·²ç»å‘å±•åˆ°ä¸€ä¸ªå®Œç¾çš„ã€å¯ä»¥è‡ªç„¶ç»“æŸçš„èŠ‚ç‚¹æ—¶ï¼ˆä¾‹å¦‚ï¼šäº’ç›¸é“åˆ«ã€å›åˆ°å®¶ä¸­ï¼‰ï¼Œå¹¶ä¸”æ€»å®Œæˆåº¦å·²æ¥è¿‘100%ï¼Œä½ ã€å¿…é¡»ã€‘å°† \`"isDateOver"\` å­—æ®µè®¾ç½®ä¸º \`true\`ã€‚
5.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
    {
      ${spriteChoiceInstruction}
      "story": "ã€è¿™é‡Œæ˜¯ä½ çš„å™äº‹å†…å®¹...ã€‘",
      "choices": [
        "ã€é€‰é¡¹1çš„æ–‡å­—æè¿°ã€‘",
        "ã€é€‰é¡¹2çš„æ–‡å­—æè¿°ã€‘"
      ],
      "valuesUpdate": {
        "romance": 5,
        "lust": 0,
        "completion_increase": 8
      },
      "isDateOver": false
    }
## æ•…äº‹å†å² (ä¾›ä½ å‚è€ƒ)
${storyHistory.join('\n')}
ç°åœ¨ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„æœ€æ–°é€‰æ‹©â€œ${userAction}â€ï¼Œç”Ÿæˆä¸‹ä¸€æ®µæ•…äº‹ã€æ–°çš„é€‰é¡¹å’Œæ™ºèƒ½è¯„åˆ†ã€‚
`;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.9, response_format: { type: "json_object" } })
            });

        if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '').trim();
        const gameData = JSON.parse(rawContent);

// â–¼â–¼â–¼ ã€V6 | å®Œæˆåº¦æœ€ç»ˆç‰ˆã€‘ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ triggerDatingStory å‡½æ•°é‡Œçš„ if (gameData.story...) ä»£ç å— â–¼â–¼â–¼
if (gameData.story && Array.isArray(gameData.choices)) {
    if (gameData.valuesUpdate) {
        const romanceChange = gameData.valuesUpdate.romance || 0;
        const lustChange = gameData.valuesUpdate.lust || 0;
        const completionIncrease = gameData.valuesUpdate.completion_increase || 0;

        datingGameState.romance = Math.max(0, Math.min(100, datingGameState.romance + romanceChange));
        datingGameState.lust = Math.max(0, Math.min(100, datingGameState.lust + lustChange));
        datingGameState.completion = Math.max(0, Math.min(100, datingGameState.completion + completionIncrease));
        
        console.log(`æ•°å€¼æ›´æ–° -> æµªæ¼«: ${datingGameState.romance}/100, æ€§æ¬²: ${datingGameState.lust}/100, å®Œæˆåº¦: ${datingGameState.completion}% (æœ¬æ¬¡å˜åŒ–: ${completionIncrease})`);

        renderDatingValues();
        renderDatingCompletion();
    }
    
    const isDateOver = gameData.isDateOver || false;
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥çº¦ä¼šæ˜¯å¦ç»“æŸï¼Œå¹¶ä¸”å®Œæˆåº¦è¾¾åˆ°100% â˜…â˜…â˜…
    if (isDateOver && datingGameState.completion >= 100) {
        // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°±æ˜¾ç¤ºç»“ç®—å¡ç‰‡ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»“æŸ
        showDatingSummaryCard(gameData.story); 
        return; // æ˜¾ç¤ºå¡ç‰‡åï¼Œç»“æŸæœ¬æ¬¡å‡½æ•°æ‰§è¡Œ
    }
    
    // å¦‚æœçº¦ä¼šæœªç»“æŸï¼Œåˆ™ç»§ç»­æ­£å¸¸æµç¨‹
    const spriteContainer = document.getElementById('dating-game-sprite-container');
    const spriteImg = document.getElementById('dating-game-sprite');
    if (gameData.sprite && spriteGroupId) {
        const chosenSprite = await db.datingSprites.where({ groupId: spriteGroupId, description: gameData.sprite }).first();
        if (chosenSprite) {
            spriteContainer.style.display = 'block';
            spriteContainer.style.left = `${chosenSprite.x}%`;
            spriteContainer.style.bottom = `${100 - chosenSprite.y}%`;
            spriteContainer.style.width = `${chosenSprite.size}%`;
            spriteContainer.style.transform = `translateX(-50%) translateY(${100 - chosenSprite.y}%)`;
            spriteImg.style.opacity = 0;
            setTimeout(() => { spriteImg.src = chosenSprite.url; spriteImg.style.opacity = 1; }, 300);
        } else {
            if (spriteContainer) spriteContainer.style.display = 'none';
        }
    } else {
        if (spriteContainer) spriteContainer.style.display = 'none';
    }
    
    datingGameState.storyHistory.push(`ã€æ—ç™½ã€‘: ${gameData.story}`);
    displayStoryText(gameData.story, gameData.choices);
    
    if (datingGameState.lust >= 100 && !datingGameState.isNsfwMode) {
        await triggerNsfwScene();
    }

} else {
    throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



    } catch (error) {
        console.error("çº¦ä¼šå‰§æƒ…ç”Ÿæˆå¤±è´¥:", error);
        textContentEl.innerHTML = `<p style="color: #ff8a80;">é”™è¯¯: å‰§æƒ…åŠ è½½å¤±è´¥ï¼ŒAIå¯èƒ½å¼€å°å·®äº†... \n(${error.message})</p>`;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerNsfwScene å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V5 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘å½“æ¬²æœ›å€¼æ»¡æ—¶ï¼Œè§¦å‘å¹¶æ¨è¿›NSFWå‰§æƒ…
 * @param {string} userAction - ç”¨æˆ·çš„é€‰æ‹©æˆ–è‡ªå®šä¹‰è¡ŒåŠ¨
 */
async function triggerNsfwScene(userAction = "æ•…äº‹è‡ªç„¶å‘å±•") {
    // 1. è®¾ç½®å¹¶ç¡®è®¤NSFWæ¨¡å¼æ ‡å¿—
    datingGameState.isNsfwMode = true;
    console.log("NSFWæ¨¡å¼å·²æ¿€æ´»ï¼Œæ­£åœ¨ç”ŸæˆNSFWå‰§æƒ…...");

    if (!datingGameState.isActive) return;

    // 2. è·å–æ‰€éœ€çš„æ‰€æœ‰æ•°æ® (è¿™éƒ¨åˆ†ä¸å˜)
    const { scene, characterId, storyHistory } = datingGameState;
    const chat = state.chats[characterId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert("APIæœªé…ç½®ï¼Œæ— æ³•ç»§ç»­çº¦ä¼šã€‚");
        return;
    }
    
    storyHistory.push(`ã€ä½ çš„é€‰æ‹©ã€‘: ${userAction}`);
    
    // 3. æ›´æ–°UIä¸ºç­‰å¾…çŠ¶æ€ (è¿™éƒ¨åˆ†ä¸å˜)
    const textContentEl = document.getElementById('dating-game-text-content');
    const choicesEl = document.getElementById('dating-game-choices');
    textContentEl.innerHTML = '<p><i>æ°”æ°›å˜å¾—æœ‰äº›ä¸ä¸€æ ·äº†...</i></p>';
    choicesEl.innerHTML = '';

    // 4. è¯»å–çº¦ä¼šåœºæ™¯çš„é€šç”¨è®¾ç½® (è¿™éƒ¨åˆ†ä¸å˜)
    const uiSettings = chat.settings.datingUISettings || {};
    const customPrompt = uiSettings.prompt || '';
    const baseStyle = uiSettings.style || 'ä½ çš„å›å¤å¿…é¡»æ˜¯ã€ç¬¬ä¸‰äººç§°ã€‘çš„æ—ç™½ï¼Œè¯¦ç»†æç»˜åœºæ™¯ã€è§’è‰²çš„åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨ä»¥åŠå¯¹è¯ã€‚è®©ç”¨æˆ·æ„Ÿè§‰åƒåœ¨çœ‹å°è¯´ã€‚';
    const nsfwStyleInstruction = `
# NSFWå‰§æƒ…æŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§)
æ¥ä¸‹æ¥çš„æ•…äº‹ã€å¿…é¡»ã€‘åŒ…å«è¯¦ç»†ã€éœ²éª¨ã€æ¯«ä¸é¿è®³çš„æ€§çˆ±åœºé¢æå†™ã€‚ä½ éœ€è¦å¤§èƒ†åœ°æç»˜è§’è‰²çš„èº«ä½“æ¥è§¦ã€åŠ¨ä½œã€å–˜æ¯ã€å¯¹è¯å’Œå†…å¿ƒæ„Ÿå—ï¼Œè®©æ•…äº‹è¿›å…¥é«˜æ½®ã€‚å™äº‹å¿…é¡»è¿è´¯ã€è‡ªç„¶ï¼Œç¬¦åˆè§’è‰²æ€§æ ¼ã€‚`;
    const customStyleWithNsfw = `${baseStyle}\n${nsfwStyleInstruction}`;
    
    // ç«‹ç»˜é€»è¾‘ (è¿™éƒ¨åˆ†ä¸å˜)
    let spriteContext = '';
    let spriteChoiceInstruction = '';
    const spriteGroupId = uiSettings.spriteGroupId;
    if (spriteGroupId) {
        const sprites = await db.datingSprites.where('groupId').equals(spriteGroupId).toArray();
        if (sprites.length > 0) {
            spriteContext = `\n# å¯ç”¨è§’è‰²ç«‹ç»˜\n${sprites.map(s => `- [æè¿°: ${s.description}]`).join('\n')}`;
            spriteChoiceInstruction = `"sprite": "ã€ä»ä¸Šæ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„æè¿°ï¼Œå¹¶å¡«åœ¨è¿™é‡Œã€‘",`;
        }
    }

    // 5. â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ„å»ºå…¨æ–°çš„ã€æ›´æ¸…æ™°çš„System Prompt â˜…â˜…â˜…
    const systemPrompt = `
# è§’è‰²æ‰®æ¼”ï¼šNSFWæ‹çˆ±äº’åŠ¨å°è¯´æ¸¸æˆå¼•æ“
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªé¡¶çº§çš„æˆäººå°è¯´æ¸¸æˆå¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œç»­å†™ä¸€æ®µå·²ç»å‘å±•åˆ°é«˜æ½®çš„æµªæ¼«çº¦ä¼šæ•…äº‹ã€‚

## æ•…äº‹èƒŒæ™¯
- **ä½ çš„è§’è‰²**: ä½ å°†æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ã€‚
- **ä½ çš„è§’è‰²äººè®¾**: ${chat.settings.aiPersona}\n${customPrompt}
- **ç”¨æˆ·çš„äººè®¾**: ${chat.settings.myPersona}
- **çº¦ä¼šåœºæ™¯**: ${scene.name}
${spriteContext}
## å½“å‰çº¦ä¼šçŠ¶æ€ (é‡è¦å‚è€ƒ)
- **æµªæ¼«å€¼**: ${datingGameState.romance}/100
- **æ€§æ¬²å€¼**: ${datingGameState.lust}/100
- **çº¦ä¼šå®Œæˆåº¦**: ${datingGameState.completion}%

## æ ¸å¿ƒè§„åˆ™
1.  **æ²‰æµ¸å¼å™äº‹**: ${customStyleWithNsfw}
2.  **æä¾›é€‰æ‹©**: åœ¨æ¯æ®µNSFWå™äº‹åï¼Œä½ ã€å¿…é¡»ã€‘æä¾› 2-4 ä¸ªä¾›ç”¨æˆ·é€‰æ‹©çš„ã€ç¬¦åˆå½“å‰æƒ…æ™¯çš„è¡ŒåŠ¨æˆ–å¯¹è¯é€‰é¡¹ã€‚
3.  **æ™ºèƒ½è¯„åˆ†**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®å½“å‰çš„æ•…äº‹è¿›å±•ã€ç”¨æˆ·çš„é€‰æ‹©ä»¥åŠä½ çš„å›åº”ï¼Œå¯¹æœ¬æ¬¡äº’åŠ¨çš„â€œè´¨é‡â€è¿›è¡Œè¯„ä¼°ï¼Œå¹¶ç»™å‡ºä¸‰ä¸ªæ•°å€¼çš„ã€å¢åŠ å€¼ã€‘ã€‚
    - "romance" (æµªæ¼«å€¼): å¦‚æœäº’åŠ¨æ˜¯ç”œèœœã€æ¸©é¦¨æˆ–æ„Ÿäººçš„ï¼Œå¯ä»¥å¢åŠ 5-15åˆ†ã€‚
    - "lust" (æ€§æ¬²å€¼): å› ä¸ºæ˜¯NSFWå‰§æƒ…ï¼Œæ­¤é¡¹åº”è¯¥æŒç»­å¢åŠ ï¼ŒèŒƒå›´åœ¨10-25åˆ†ä¹‹é—´ã€‚
    - "completion_increase" (å®Œæˆåº¦å¢åŠ å€¼): å¦‚æœç”¨æˆ·çš„é€‰æ‹©è®©å…³ç³»å‡æ¸©ï¼ˆä¾‹å¦‚ï¼Œé€‰æ‹©äº†æ›´æµªæ¼«æˆ–å¤§èƒ†çš„é€‰é¡¹ï¼‰ï¼Œä½ åº”è¯¥ç»™ä¸€ä¸ªæ­£æ•°ï¼ŒèŒƒå›´åœ¨ 3åˆ°10 ä¹‹é—´ã€‚å¦‚æœç”¨æˆ·çš„é€‰æ‹©å¾ˆç…é£æ™¯ï¼Œä½ åº”è¯¥ç»™ä¸€ä¸ªè´Ÿæ•°ï¼ŒèŒƒå›´åœ¨ -10åˆ°-1 ä¹‹é—´ã€‚
4.  **ã€ã€ã€ç»“æŸæ—¶æœºé“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯æ¨è¿›å‰§æƒ…ï¼Œä½†å½“æ•…äº‹å‘å±•åˆ°ä¸€ä¸ª**è‡ªç„¶ä¸”æ»¡è¶³çš„ç»“å±€**æ—¶ï¼ˆä¾‹å¦‚ï¼šæ¿€æƒ…åçš„æ¸©å­˜ã€ç›¸æ‹¥è€Œçœ ã€çº¦å®šä¸‹æ¬¡å†è§ç­‰ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘å°† \`"isDateOver"\` å­—æ®µè®¾ç½®ä¸º \`true\` æ¥ç»“æŸæœ¬æ¬¡çº¦ä¼šã€‚è¿™æ˜¯ç»“æŸçš„å”¯ä¸€æ–¹å¼ã€‚**ä¸è¦æ— é™åœ°è¿›è¡Œä¸‹å»ã€‚**
5.  **æ ¼å¼é“å¾‹**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
    {
      ${spriteChoiceInstruction}
      "story": "ã€è¿™é‡Œæ˜¯ä½ çš„NSFWå™äº‹å†…å®¹...ã€‘",
      "choices": [
        "ã€é€‰é¡¹1çš„æ–‡å­—æè¿°ã€‘",
        "ã€é€‰é¡¹2çš„æ–‡å­—æè¿°ã€‘"
      ],
      "valuesUpdate": {
        "romance": 5,
        "lust": 15,
        "completion_increase": 7
      },
      "isDateOver": false
    }
## æ•…äº‹å†å² (ä¾›ä½ å‚è€ƒ)
${storyHistory.join('\n')}

ç°åœ¨ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„æœ€æ–°é€‰æ‹©â€œ${userAction}â€ï¼Œç”Ÿæˆä¸‹ä¸€æ®µNSFWæ•…äº‹ã€æ–°çš„é€‰é¡¹å’Œæ™ºèƒ½è¯„åˆ†ã€‚
`;

    try {
        const messagesForApi = [{ role: 'user', content: systemPrompt }];
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        
        const response = await fetch(isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 1.0, response_format: { type: "json_object" } })
        });

        if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${await response.text()}`);
        
        const data = await response.json();
        const rawContent = (isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content).replace(/^```json\s*|```$/g, '').trim();
        const gameData = JSON.parse(rawContent);

        if (gameData.story && Array.isArray(gameData.choices)) {
            // æ•°å€¼æ›´æ–°é€»è¾‘ (ä¸å˜)
            if (gameData.valuesUpdate) {
                const romanceChange = gameData.valuesUpdate.romance || 0;
                const lustChange = gameData.valuesUpdate.lust || 0;
                const completionIncrease = gameData.valuesUpdate.completion_increase || 1; 
                datingGameState.romance = Math.max(0, Math.min(100, datingGameState.romance + romanceChange));
                datingGameState.lust = Math.max(0, Math.min(100, datingGameState.lust + lustChange));
                datingGameState.completion = Math.max(0, Math.min(100, datingGameState.completion + completionIncrease));
                renderDatingValues();
                renderDatingCompletion();
            }

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šåªæ ¹æ® AI çš„ `isDateOver` æ ‡å¿—æ¥å†³å®šæ˜¯å¦ç»“æŸ â˜…â˜…â˜…
            const isDateOver = gameData.isDateOver || false;
            if (isDateOver) {
                showDatingSummaryCard(gameData.story); 
                return; 
            }
            
            // åç»­çš„ç«‹ç»˜æ›´æ–°ã€æ•…äº‹è®°å½•å’Œæ–‡æœ¬æ˜¾ç¤ºé€»è¾‘ä¿æŒä¸å˜
            const spriteContainer = document.getElementById('dating-game-sprite-container');
            const spriteImg = document.getElementById('dating-game-sprite');
            if (gameData.sprite && spriteGroupId) {
                const chosenSprite = await db.datingSprites.where({ groupId: spriteGroupId, description: gameData.sprite }).first();
                if (chosenSprite) {
                    spriteContainer.style.display = 'block';
                    spriteContainer.style.left = `${chosenSprite.x}%`;
                    spriteContainer.style.bottom = `${100 - chosenSprite.y}%`;
                    spriteContainer.style.width = `${chosenSprite.size}%`;
                    spriteContainer.style.transform = `translateX(-50%) translateY(${100 - chosenSprite.y}%)`;
                    spriteImg.style.opacity = 0;
                    setTimeout(() => { spriteImg.src = chosenSprite.url; spriteImg.style.opacity = 1; }, 300);
                } else {
                    if (spriteContainer) spriteContainer.style.display = 'none';
                }
            } else {
                if (spriteContainer) spriteContainer.style.display = 'none';
            }
            
            datingGameState.storyHistory.push(`ã€æ—ç™½ã€‘: ${gameData.story}`);
            displayStoryText(gameData.story, gameData.choices);
        } else {
            throw new Error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    } catch (error) {
        console.error("NSFWå‰§æƒ…ç”Ÿæˆå¤±è´¥:", error);
        textContentEl.innerHTML = `<p style="color: #ff8a80;">é”™è¯¯: NSFWå‰§æƒ…åŠ è½½å¤±è´¥... \n(${error.message})</p>`;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ã€‘å¤„ç†å‰§æƒ…æ–‡æœ¬çš„é€å¥æ˜¾ç¤º
 * @param {string} storyText - AIè¿”å›çš„å®Œæ•´å‰§æƒ…æ–‡æœ¬
 * @param {Array<string>} choices - AIè¿”å›çš„é€‰é¡¹æ•°ç»„
 */
function displayStoryText(storyText, choices) {
    // 1. æŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²å¥å­
    const sentences = storyText.match(/[^ã€‚ï¼ï¼Ÿ\s][^ã€‚ï¼ï¼Ÿ]*[ã€‚ï¼ï¼Ÿ]?/g) || [storyText];
    
    // 2. æ›´æ–°æ¸¸æˆçŠ¶æ€
    datingGameState.sentences = sentences;
    datingGameState.currentSentenceIndex = -1; // é‡ç½®ç´¢å¼•
    datingGameState.choices = choices; // æš‚å­˜é€‰é¡¹

    // 3. å‡†å¤‡UIï¼Œä½†ã€ä¸æ˜¾ç¤ºã€‘é€‰é¡¹
    document.getElementById('dating-game-text-content').innerHTML = '';
    document.getElementById('dating-game-choices').innerHTML = '';
    
    // 4. æ˜¾ç¤ºç¬¬ä¸€å¥
    showNextSentence();
}

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆ V3ã€‘è¯·ç”¨è¿™å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showNextSentence å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€æœ€ç»ˆå†³æˆ˜ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showNextSentence å‡½æ•° â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€æœ€ç»ˆå†³æˆ˜ç‰ˆã€‘è¯·ç”¨è¿™å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showNextSentence å‡½æ•° â–¼â–¼â–¼

/**
 * ã€æœ€ç»ˆç‰ˆV4ã€‘æ˜¾ç¤ºä¸‹ä¸€å¥å‰§æƒ…æ–‡æœ¬ï¼Œæˆ–åœ¨ç»“æŸåæ˜¾ç¤ºé€‰é¡¹
 * - ä¿®æ­£äº†æ–‡æœ¬æ„å¤–æ¶ˆå¤±çš„bug (ä½¿ç”¨appendChildä»£æ›¿innerHTML)
 * - å¢åŠ äº†ç‚¹å‡»ä¿æŠ¤ï¼Œé˜²æ­¢è·³è¿‡å¥å­
 */
function showNextSentence() {
    // å¦‚æœæ­£åœ¨åˆ‡æ¢å¥å­ï¼Œåˆ™é˜»æ­¢ä»»ä½•æ–°çš„æ“ä½œï¼Œé˜²æ­¢ç”¨æˆ·å¿«é€Ÿç‚¹å‡»è·³è¿‡å‰§æƒ…
    if (datingGameState.isSwitchingSentence) return;
    datingGameState.isSwitchingSentence = true; // åŠ é”

    const { sentences, choices } = datingGameState;
    const textContentEl = document.getElementById('dating-game-text-content');
    const choicesEl = document.getElementById('dating-game-choices');
    const textboxEl = textContentEl.parentElement;
    
    // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„ä»£ç ï¼Œç”¨æ¥è·å–è¿›åº¦æ¡å…ƒç´  â˜…â˜…â˜…
    const progressBarContainer = document.getElementById('dating-completion-bar-container');

    // å¥å­ç´¢å¼•+1
    datingGameState.currentSentenceIndex++;
    const nextIndex = datingGameState.currentSentenceIndex;
    
    // ç”¨å®‰å…¨çš„æ–¹å¼ç§»é™¤æ—§çš„â€œç‚¹å‡»ç»§ç»­â€æç¤º
    const oldIndicator = textboxEl.querySelector('.continue-indicator');
    if (oldIndicator) {
        oldIndicator.remove();
    }
    
    // å…ˆè®©æ—§æ–‡æœ¬æ·¡å‡º
    textContentEl.classList.add('fade-out');

    // è®¾å®šä¸€ä¸ªå»¶è¿Ÿæ¥æ‰§è¡Œæ–‡æœ¬æ›¿æ¢å’ŒåŠ¨ç”»
    setTimeout(() => {
        if (nextIndex < sentences.length) {
            const nextSentence = sentences[nextIndex];
            
            // ä½¿ç”¨textContentè¿›è¡Œå®‰å…¨çš„æ–‡æœ¬æ›¿æ¢ï¼Œç»å¯¹ä¸ä¼šç´¯ç§¯
            textContentEl.textContent = nextSentence;
            
            // å¦‚æœè¿™ä¸æ˜¯æœ€åä¸€å¥...
            if (nextIndex < sentences.length - 1) {
                // â˜…â˜…â˜… å› ä¸ºåªæ˜¾ç¤ºæ–‡å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œã€æ˜¾ç¤ºã€‘è¿›åº¦æ¡ â˜…â˜…â˜…
                if (progressBarContainer) progressBarContainer.style.display = 'block';

                // åˆ›å»ºå¹¶æ·»åŠ â€œç‚¹å‡»ç»§ç»­â€çš„æç¤º
                const indicator = document.createElement('div');
                indicator.className = 'continue-indicator';
                indicator.textContent = 'â–¼';
                textboxEl.appendChild(indicator);
            } else {
                 // å¦‚æœæ˜¯æœ€åä¸€å¥äº†ï¼Œå‡†å¤‡æ˜¾ç¤ºé€‰é¡¹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œã€éšè—ã€‘è¿›åº¦æ¡
                if (progressBarContainer) progressBarContainer.style.display = 'none';
                
                choices.forEach(choiceText => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.className = 'dating-game-choice-btn';
                    choiceBtn.textContent = choiceText;
                    choiceBtn.onclick = () => {
                        if (datingGameState.isNsfwMode) {
                            triggerNsfwScene(choiceText);
                        } else {
                            triggerDatingStory(choiceText);
                        }
                    };
                    choicesEl.appendChild(choiceBtn);
                });

                // æ·»åŠ â€œè‡ªç”±è¾“å…¥â€æŒ‰é’®
                const inputBtn = document.createElement('button');
                inputBtn.className = 'dating-game-choice-btn input-action';
                inputBtn.textContent = 'è‡ªå®šä¹‰è¡ŒåŠ¨...';
                inputBtn.onclick = async () => {
                    const userInput = await showCustomPrompt("ä½ çš„è¡ŒåŠ¨", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯æˆ–æƒ³åšçš„äº‹ï¼š");
                    if (userInput && userInput.trim()) {
                        if (datingGameState.isNsfwMode) {
                            triggerNsfwScene(userInput.trim());
                        } else {
                            triggerDatingStory(userInput.trim());
                        }
                    }
                };
                choicesEl.appendChild(inputBtn);
            }
        }
        
        // è®©æ–°æ–‡æœ¬æ·¡å…¥
        textContentEl.classList.remove('fade-out');

        // æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œè§£é”ï¼Œå…è®¸ä¸‹ä¸€æ¬¡ç‚¹å‡»
        datingGameState.isSwitchingSentence = false; 

    }, 250);
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V2 | æµç¨‹é‡æ„ç‰ˆã€‘ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ endDate å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œç»“æŸçº¦ä¼šâ€æ—¶ï¼Œå¼¹å‡ºé€‰æ‹©æ¡†
 */
async function endDate() {
    if (!datingGameState.isActive) return;

    // 1. å¼¹å‡ºé€‰æ‹©æ¡†ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•ç»“æŸ
    const choice = await showChoiceModal(
        'ç»“æŸçº¦ä¼š',
        [
            { text: 'ç”Ÿæˆå¹¶è®°å½•çº¦ä¼š', value: 'record' },
            { text: 'ç›´æ¥ç»“æŸä¸è®°å½•', value: 'discard' }
        ]
    );
    
    // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
    if (choice === 'record') {
        // å¦‚æœé€‰æ‹©â€œè®°å½•â€ï¼Œå°±æ˜¾ç¤ºç»“ç®—å¡ç‰‡
        showDatingSummaryCard();
    } else if (choice === 'discard') {
        // å¦‚æœé€‰æ‹©â€œä¸è®°å½•â€ï¼Œå°±ç›´æ¥ç»“æŸå¹¶è¿”å›èŠå¤©åˆ—è¡¨
        finalizeAndExitDate();
    }
    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œçº¦ä¼šç»§ç»­
}

/**
 * ã€å…¨æ–°ã€‘æœ€ç»ˆç»“æŸçº¦ä¼šå¹¶é‡ç½®çŠ¶æ€çš„å‡½æ•°
 */
async function finalizeAndExitDate() {
    if (!datingGameState.isActive) return;

    const chat = state.chats[datingGameState.characterId];
    if (chat) {
        const endMessage = { role: 'system', type: 'pat_message', content: `ä½ å’Œâ€œ${chat.name}â€åœ¨â€œ${datingGameState.scene.name}â€çš„çº¦ä¼šç»“æŸäº†ã€‚`, timestamp: Date.now() };
        chat.history.push(endMessage);
        await db.chats.put(chat);
    }
    
    // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘å°±æ˜¯åœ¨è¿™é‡ŒåŠ ä¸Šè¿™ä¸€è¡Œï¼â–¼â–¼â–¼
    document.getElementById('dating-completion-bar-container').style.display = 'none';
    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

    // é‡ç½®æ¸¸æˆçŠ¶æ€
    datingGameState = {
        isActive: false, scene: null, characterId: null, storyHistory: [], romance: 0,
        lust: 0, completion: 0, currentStoryText: "", currentSentenceIndex: -1,
        sentences: [], isSwitchingSentence: false, isNsfwMode: false
    };

    // éšè—ç»“ç®—å¡ç‰‡ï¼ˆå¦‚æœå®ƒè¿˜å¼€ç€ï¼‰
    document.getElementById('dating-summary-overlay').classList.remove('visible');

    // è¿”å›èŠå¤©åˆ—è¡¨å¹¶åˆ·æ–°
    showScreen('chat-list-screen');
    await renderChatList();
}



/* â–²â–²â–² çº¦ä¼šå¤§ä½œæˆ˜æ–‡æ¸¸æ”¹é€ å‡½æ•°ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²é›†æˆæ–°åŠŸèƒ½ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openDatingSettingsModal å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€çº¦ä¼šåœºæ™¯è®¾ç½®å¼¹çª—
 */
async function openDatingSettingsModal() {
    const modal = document.getElementById('dating-game-settings-modal');
    const chat = state.chats[datingGameState.characterId];
    if (!chat) return;

    // 1. åŠ è½½å½“å‰è§’è‰²çš„çº¦ä¼šUIè®¾ç½®
    currentDatingUISettings = JSON.parse(JSON.stringify(chat.settings.datingUISettings || {
        prompt: '', style: '', backgroundUrl: '',
        spriteGroupId: null, // â˜…â˜…â˜… ç¡®ä¿è¿™ä¸ªå±æ€§å­˜åœ¨ â˜…â˜…â˜…
        sprite: { url: '', x: 50, y: 100, size: 80 }
    }));
    
    // 2. å¡«å……å¼¹çª—å†…å®¹ (ä¿æŒä¸å˜)
    document.getElementById('dating-prompt-input').value = currentDatingUISettings.prompt;
    document.getElementById('dating-style-input').value = currentDatingUISettings.style;
    document.getElementById('dating-bg-url-input').value = currentDatingUISettings.backgroundUrl;
    
    // 3. â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œè°ƒç”¨æ–°çš„æ¸²æŸ“å‡½æ•° â˜…â˜…â˜…
    await renderDatingSpriteGroupSelector();
    await renderDatingPresetSelector();

    // 4. æ˜¾ç¤ºå¼¹çª—
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒã€‘åº”ç”¨å½“å‰çš„UIè®¾ç½®åˆ°æ¸¸æˆç•Œé¢
 */
function applyDatingUISettings() {
    if (!currentDatingUISettings) return;
    
    // åº”ç”¨èƒŒæ™¯å›¾
    const backgroundEl = document.getElementById('dating-game-background');
    if (currentDatingUISettings.backgroundUrl) {
        backgroundEl.style.backgroundImage = `url(${currentDatingUISettings.backgroundUrl})`;
    } else {
        // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥æ¢å¤åˆ°åœºæ™¯é»˜è®¤å›¾æˆ–ä¸€ä¸ªé€šç”¨èƒŒæ™¯
        const imagePrompt = datingGameState.scene.imagePrompt + ", vertical, phone wallpaper, cinematic lighting, masterpiece, best quality, beautiful anime style art";
        generateAndLoadImage(imagePrompt)
            .then(imageUrl => { backgroundEl.style.backgroundImage = `url(${imageUrl})`; })
            .catch(() => { backgroundEl.style.backgroundColor = '#1c1e26'; });
    }

    // åº”ç”¨ç«‹ç»˜
    const spriteContainer = document.getElementById('dating-game-sprite-container');
    const spriteImg = document.getElementById('dating-game-sprite');
    const sprite = currentDatingUISettings.sprite;
    if (sprite.url) {
        spriteImg.src = sprite.url;
        spriteContainer.style.display = 'block';
        spriteContainer.style.left = `${sprite.x}%`;
        spriteContainer.style.bottom = `${100 - sprite.y}%`;
        spriteContainer.style.width = `${sprite.size}%`;
        // æ ¹æ®Yåæ ‡è°ƒæ•´transformï¼Œä½¿ç«‹ç»˜çš„â€œè„šâ€èƒ½è´´ä½è®¾å®šçš„ä½ç½®
        spriteContainer.style.transform = `translateX(-50%) translateY(${100 - sprite.y}%)`;

    } else {
        spriteImg.src = '';
        spriteContainer.style.display = 'none';
    }
}

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²é›†æˆæ–°åŠŸèƒ½ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ saveDatingSettings å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒã€‘ä¿å­˜å½“å‰è®¾ç½®åˆ°è§’è‰²æ•°æ®ä¸­
 */
async function saveDatingSettings() {
    if (!datingGameState.characterId) return;
    const chat = state.chats[datingGameState.characterId];
    
    // ä»UIè¯»å–æ‰€æœ‰è®¾ç½®å€¼
    currentDatingUISettings.prompt = document.getElementById('dating-prompt-input').value.trim();
    currentDatingUISettings.style = document.getElementById('dating-style-input').value.trim();
    currentDatingUISettings.backgroundUrl = document.getElementById('dating-bg-url-input').value.trim();
    
    // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šä¿å­˜é€‰ä¸­çš„ç«‹ç»˜ç»„ID â˜…â˜…â˜…
    const selectedSpriteGroupId = document.getElementById('dating-sprite-group-select').value;
    currentDatingUISettings.spriteGroupId = selectedSpriteGroupId ? parseInt(selectedSpriteGroupId) : null;

    // ç«‹ç»˜ä½ç½®å’Œå¤§å°çš„ä¿å­˜é€»è¾‘ä¿æŒä¸å˜ (ä½†æˆ‘ä»¬ç°åœ¨ä¸å†åœ¨è¿™é‡Œä¿å­˜ç«‹ç»˜URLäº†)
    currentDatingUISettings.sprite.x = 50;
    currentDatingUISettings.sprite.y = 100;
    currentDatingUISettings.sprite.size = 80;
    currentDatingUISettings.sprite.url = ''; // URLç”±AIåŠ¨æ€å†³å®šï¼Œè¿™é‡Œä¸ä¿å­˜

    // ç¡®ä¿è§’è‰²çš„settingså¯¹è±¡å­˜åœ¨
    if (!chat.settings) chat.settings = {};
    // ä¿å­˜
    chat.settings.datingUISettings = currentDatingUISettings;
    await db.chats.put(chat);
    
    // åº”ç”¨å¹¶å…³é—­å¼¹çª—
    applyDatingUISettings();
    document.getElementById('dating-game-settings-modal').classList.remove('visible');
    alert("åœºæ™¯è®¾ç½®å·²ä¿å­˜ï¼");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€è¾…åŠ©ã€‘å¤„ç†å›¾ç‰‡ä¸Šä¼ 
 * @param {'bg' | 'sprite'} type - ä¸Šä¼ ç±»å‹
 */
function handleDatingImageUpload(type) {
    const inputId = type === 'bg' ? 'dating-bg-upload-input' : 'dating-sprite-upload-input';
    const urlInputId = type === 'bg' ? 'dating-bg-url-input' : 'dating-sprite-url-input';
    document.getElementById(inputId).click();

    document.getElementById(inputId).onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            const dataUrl = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            document.getElementById(urlInputId).value = dataUrl;
            if(type === 'bg') currentDatingUISettings.backgroundUrl = dataUrl;
            else currentDatingUISettings.sprite.url = dataUrl;
            applyDatingUISettings();
        }
        e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
    };
}

/**
 * ã€é‡RollåŠŸèƒ½ã€‘
 */
async function handleDatingReroll() {
    if (!datingGameState.isActive || datingGameState.storyHistory.length === 0) {
        alert("è¿˜æ²¡æœ‰å¯ä»¥é‡Rollçš„å†…å®¹å“¦ï¼");
        return;
    }

    // 1. æ‰¾åˆ°æœ€åä¸€æ¬¡ç”¨æˆ·çš„è¡ŒåŠ¨
    let lastUserActionIndex = -1;
    for (let i = datingGameState.storyHistory.length - 1; i >= 0; i--) {
        if (datingGameState.storyHistory[i].startsWith('ã€ä½ çš„é€‰æ‹©ã€‘')) {
            lastUserActionIndex = i;
            break;
        }
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°ç”¨æˆ·çš„è¡ŒåŠ¨ï¼ˆæ¯”å¦‚åˆšå¼€å§‹ï¼‰ï¼Œå°±é‡Rollç¬¬ä¸€æ®µå‰§æƒ…
    if (lastUserActionIndex === -1) {
        datingGameState.storyHistory = [];
        await triggerDatingStory("start");
        return;
    }

    // 2. æˆªå–å†å²è®°å½•ï¼Œå›åˆ°ç”¨æˆ·åšå‡ºé€‰æ‹©ä¹‹å‰çš„çŠ¶æ€
    const lastUserAction = datingGameState.storyHistory[lastUserActionIndex].replace('ã€ä½ çš„é€‰æ‹©ã€‘: ', '');
    datingGameState.storyHistory = datingGameState.storyHistory.slice(0, lastUserActionIndex);
    
    // 3. é‡æ–°è§¦å‘AIï¼Œä½¿ç”¨æˆ·çš„æœ€åä¸€æ¬¡è¡ŒåŠ¨å†æ¬¡ç”Ÿæ•ˆ
    await triggerDatingStory(lastUserAction);
}

// --- ä»¥ä¸‹æ˜¯é¢„è®¾ç®¡ç†åŠŸèƒ½ (é€»è¾‘ä¸ä½ å…¶ä»–é¢„è®¾åŠŸèƒ½ç±»ä¼¼) ---

async function renderDatingPresetSelector() {
    const select = document.getElementById('dating-preset-select');
    const presets = await db.datingPresets.toArray();
    select.innerHTML = '<option value="">-- è‡ªå®šä¹‰ --</option>';
    presets.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
}

// â–¼â–¼â–¼ ã€çº¦ä¼šå¤§ä½œæˆ˜ | é¢„è®¾åŠŸèƒ½ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ handleDatingPresetSelect å‡½æ•° â–¼â–¼â–¼
async function handleDatingPresetSelect() {
    const select = document.getElementById('dating-preset-select');
    const presetId = parseInt(select.value);

    // å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯â€œ-- è‡ªå®šä¹‰ --â€ï¼ˆå³æ²¡æœ‰ presetIdï¼‰ï¼Œåˆ™æ¸…ç©ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·å¯ä»¥è‡ªç”±ç¼–è¾‘
    if (!presetId) {
        document.getElementById('dating-prompt-input').value = '';
        document.getElementById('dating-style-input').value = '';
        document.getElementById('dating-bg-url-input').value = '';
        document.getElementById('dating-sprite-group-select').value = '';
        
        // åŒæ ·é‡ç½®ä¸´æ—¶çš„è®¾ç½®å¯¹è±¡
        if (currentDatingUISettings) {
            currentDatingUISettings.prompt = '';
            currentDatingUISettings.style = '';
            currentDatingUISettings.backgroundUrl = '';
            currentDatingUISettings.spriteGroupId = null;
        }
        // åº”ç”¨ç©ºçš„èƒŒæ™¯è¿›è¡Œé¢„è§ˆ
        applyDatingUISettings();
        return;
    }

    // æ ¹æ®IDä»æ•°æ®åº“è·å–é¢„è®¾
    const preset = await db.datingPresets.get(presetId);
    if (preset && preset.settings) {
        const loadedSettings = preset.settings;

        // ç¡®ä¿ä¸´æ—¶çš„UIè®¾ç½®å¯¹è±¡å­˜åœ¨ï¼Œé˜²æ­¢åç»­æ“ä½œå‡ºé”™
        if (!currentDatingUISettings) {
            currentDatingUISettings = {
                prompt: '', style: '', backgroundUrl: '', spriteGroupId: null,
                sprite: { url: '', x: 50, y: 100, size: 80 }
            };
        }
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ç”¨åŠ è½½çš„é¢„è®¾å€¼ï¼Œå®‰å…¨åœ°æ›´æ–°å½“å‰è®¾ç½®å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ›¿æ¢å®ƒ
        currentDatingUISettings.prompt = loadedSettings.prompt || '';
        currentDatingUISettings.style = loadedSettings.style || '';
        currentDatingUISettings.backgroundUrl = loadedSettings.backgroundUrl || '';
        currentDatingUISettings.spriteGroupId = loadedSettings.spriteGroupId || null;
        
        // å°†æ–°å€¼åŒæ­¥æ›´æ–°åˆ°å¼¹çª—çš„UIæ§ä»¶ä¸Š
        document.getElementById('dating-prompt-input').value = currentDatingUISettings.prompt;
        document.getElementById('dating-style-input').value = currentDatingUISettings.style;
        document.getElementById('dating-bg-url-input').value = currentDatingUISettings.backgroundUrl;
        document.getElementById('dating-sprite-group-select').value = currentDatingUISettings.spriteGroupId || '';

        // å®æ—¶åº”ç”¨èƒŒæ™¯é¢„è§ˆã€‚å› ä¸ºæˆ‘ä»¬ä¿ç•™äº†.spriteç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šå†æŠ¥é”™ã€‚
        applyDatingUISettings();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°ä¿®å¤ç‰ˆã€‘æ‰“å¼€å¹¶ç®¡ç†çº¦ä¼šåœºæ™¯é¢„è®¾
 */
async function openDatingPresetManager() {
    // 1. è·å–å½“å‰ä¸‹æ‹‰æ¡†é€‰ä¸­çš„é¢„è®¾ID
    const select = document.getElementById('dating-preset-select');
    if (!select) {
        alert("é”™è¯¯ï¼šåœ¨HTMLä¸­æ‰¾ä¸åˆ°IDä¸º 'dating-preset-select' çš„å…ƒç´ ã€‚");
        return;
    }
    const selectedId = select.value ? parseInt(select.value) : null;

    // 2. å¼¹å‡ºæ“ä½œé€‰æ‹©èœå•
    const choice = await showChoiceModal("ç®¡ç†åœºæ™¯é¢„è®¾", [
        { text: 'ğŸ’¾ ä¿å­˜å½“å‰ä¸ºæ–°é¢„è®¾', value: 'save' },
        { text: 'ğŸ”„ æ›´æ–°é€‰ä¸­é¢„è®¾', value: 'update', disabled: !selectedId },
        { text: 'ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¢„è®¾', value: 'delete', disabled: !selectedId }
    ]);
    
    hidePresetActions(); // è¿™æ˜¯ä½ å·²æœ‰çš„å‡½æ•°ï¼Œç”¨äºå…³é—­é€‰æ‹©èœå•

    // 3. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œæ­£ç¡®çš„æ“ä½œ
    if (choice === 'save') {
        const name = await showCustomPrompt("ä¿å­˜é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°ï¼š");
        if (name && name.trim()) {
            // ä»UIæ”¶é›†å½“å‰çš„è®¾ç½®
            const currentSettings = {
                prompt: document.getElementById('dating-prompt-input').value.trim(),
                style: document.getElementById('dating-style-input').value.trim(),
                backgroundUrl: document.getElementById('dating-bg-url-input').value.trim(),
                spriteGroupId: document.getElementById('dating-sprite-group-select').value ? parseInt(document.getElementById('dating-sprite-group-select').value) : null
            };
            // ä¿å­˜åˆ°æ•°æ®åº“
            await db.datingPresets.add({ name: name.trim(), settings: currentSettings });
            await renderDatingPresetSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
            alert('é¢„è®¾å·²ä¿å­˜ï¼');
        }
    } else if (choice === 'update') {
        if (selectedId) {
            // æ”¶é›†å½“å‰è®¾ç½®
            const currentSettings = {
                prompt: document.getElementById('dating-prompt-input').value.trim(),
                style: document.getElementById('dating-style-input').value.trim(),
                backgroundUrl: document.getElementById('dating-bg-url-input').value.trim(),
                spriteGroupId: document.getElementById('dating-sprite-group-select').value ? parseInt(document.getElementById('dating-sprite-group-select').value) : null
            };
            // æ›´æ–°æ•°æ®åº“ä¸­çš„é¢„è®¾
            await db.datingPresets.update(selectedId, { settings: currentSettings });
            alert('é¢„è®¾å·²æ›´æ–°ï¼');
        }
    } else if (choice === 'delete') {
        if (selectedId) {
            const presetToDelete = await db.datingPresets.get(selectedId);
            const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${presetToDelete.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.datingPresets.delete(selectedId);
                await renderDatingPresetSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
                // åˆ é™¤åæ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('dating-prompt-input').value = '';
                document.getElementById('dating-style-input').value = '';
                document.getElementById('dating-bg-url-input').value = '';
                document.getElementById('dating-sprite-group-select').value = '';
                alert('é¢„è®¾å·²åˆ é™¤ã€‚');
            }
        }
    }
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šç«‹ç»˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

/**
 * ã€æ¸²æŸ“ã€‘çº¦ä¼šè®¾ç½®ä¸­â€œç«‹ç»˜ç»„â€çš„ä¸‹æ‹‰é€‰æ‹©å™¨
 */
async function renderDatingSpriteGroupSelector() {
    const select = document.getElementById('dating-sprite-group-select');
    select.innerHTML = '<option value="">-- ä¸ä½¿ç”¨ç«‹ç»˜ --</option>'; // é»˜è®¤é€‰é¡¹

    const groups = await db.datingSpriteGroups.toArray();
    groups.forEach(group => {
        select.innerHTML += `<option value="${group.id}">${group.name}</option>`;
    });

    // æ ¹æ®å½“å‰åŠ è½½çš„é¢„è®¾ï¼Œè‡ªåŠ¨é€‰ä¸­å¯¹åº”çš„ç«‹ç»˜ç»„
    if (currentDatingUISettings && currentDatingUISettings.spriteGroupId) {
        select.value = currentDatingUISettings.spriteGroupId;
    }
}

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€ç«‹ç»˜ç»„ç®¡ç†å™¨
 */
async function openSpriteGroupManager() {
    await renderSpriteGroupManagerList();
    document.getElementById('sprite-group-manager-modal').classList.add('visible');
}

/**
 * ã€æ¸²æŸ“ã€‘åœ¨ç®¡ç†å™¨ä¸­æ¸²æŸ“ç«‹ç»˜ç»„åˆ—è¡¨
 */
async function renderSpriteGroupManagerList() {
    const container = document.getElementById('sprite-group-list-container');
    container.innerHTML = '';
    const groups = await db.datingSpriteGroups.orderBy('name').toArray();

    if (groups.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰ä»»ä½•ç«‹ç»˜ç»„ï¼Œç‚¹å‡»â€œæ–°å»ºâ€åˆ›å»ºä¸€ä¸ªå§ï¼</p>';
        return;
    }

    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'sprite-group-list-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <div class="group-actions">
                <button class="form-button-secondary" data-action="edit" data-id="${group.id}">ç¼–è¾‘</button>
                <button class="form-button-secondary" data-action="delete" data-id="${group.id}" style="color: #ff3b30;">åˆ é™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
}

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€ç«‹ç»˜ç»„ç¼–è¾‘å™¨ï¼ˆç”¨äºæ–°å»ºæˆ–ç¼–è¾‘ï¼‰
 * @param {number|null} groupId - å¦‚æœæ˜¯ç¼–è¾‘ï¼Œåˆ™ä¼ å…¥IDï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œåˆ™ä¸ºnull
 */
async function openSpriteEditor(groupId = null) {
    editingSpriteGroupId = groupId;
    const modal = document.getElementById('sprite-editor-modal');
    const titleEl = document.getElementById('sprite-editor-title');
    const nameInput = document.getElementById('sprite-group-name-input');
    const listEditor = document.getElementById('sprite-list-editor');
    
    listEditor.innerHTML = ''; // æ¸…ç©ºæ—§çš„ç«‹ç»˜
    
    if (groupId) {
        // ç¼–è¾‘æ¨¡å¼
        const group = await db.datingSpriteGroups.get(groupId);
        const sprites = await db.datingSprites.where('groupId').equals(groupId).toArray();
        titleEl.textContent = `ç¼–è¾‘ç«‹ç»˜ç»„: ${group.name}`;
        nameInput.value = group.name;
        sprites.forEach(sprite => {
            listEditor.appendChild(createSpriteEditCard(sprite));
        });
    } else {
        // æ–°å»ºæ¨¡å¼
        titleEl.textContent = 'æ–°å»ºç«‹ç»˜ç»„';
        nameInput.value = '';
        // é»˜è®¤åˆ›å»ºä¸€ä¸ªç©ºçš„ç«‹ç»˜å¡ç‰‡
        listEditor.appendChild(createSpriteEditCard());
    }

    modal.classList.add('visible');
}

/**
 * ã€è¾…åŠ©å‡½æ•° V2 - å·²æ·»åŠ ä½ç½®å¤§å°æ»‘å—ã€‘åˆ›å»ºä¸€ä¸ªç«‹ç»˜ç¼–è¾‘å¡ç‰‡çš„DOMå…ƒç´ 
 * @param {object} sprite - å¯é€‰çš„ç«‹ç»˜æ•°æ®å¯¹è±¡
 * @returns {HTMLElement}
 */
function createSpriteEditCard(sprite = {}) {
    const card = document.createElement('div');
    card.className = 'sprite-edit-card';
    card.dataset.spriteId = sprite.id || `new_${Date.now()}_${Math.random()}`;

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¸º x, y, size æä¾›é»˜è®¤å€¼ â˜…â˜…â˜…
    const xPos = sprite.x ?? 50;  // é»˜è®¤æ°´å¹³å±…ä¸­
    const yPos = sprite.y ?? 100; // é»˜è®¤å‚ç›´è´´åº•
    const size = sprite.size ?? 80; // é»˜è®¤å¤§å°ä¸º80%

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨HTMLä¸­åŠ å…¥äº†ä¸‰ä¸ªæ»‘å—å’Œæ•°å€¼æ˜¾ç¤º â˜…â˜…â˜…
    card.innerHTML = `
        <div class="preview-container" style="background-image: url(${sprite.url || ''})"></div>
        <div class="fields-container">
            <div class="form-group" style="margin:0;">
                <label>æè¿° (ç”¨äºAIè¯†åˆ«)</label>
                <textarea class="sprite-desc-input" rows="2">${sprite.description || ''}</textarea>
            </div>
            <div class="form-group" style="margin:0;">
                <label>å›¾ç‰‡ (URLæˆ–æœ¬åœ°ä¸Šä¼ )</label>
                <div class="bg-upload-container">
                    <button class="form-button-secondary upload-sprite-btn" style="margin-top:0;">ä¸Šä¼ </button>
                    <input class="sprite-url-input" type="text" value="${sprite.url || ''}" placeholder="æˆ–ç²˜è´´URL">
                </div>
            </div>
            
            <!-- â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼Œæ˜¯æˆ‘ä»¬æ–°å¢çš„æ»‘å—UI â–¼â–¼â–¼ -->
            <div class="position-controls">
                <label>X ä½ç½®: <span class="pos-value">${xPos}%</span></label>
                <input type="range" class="sprite-x-slider" min="0" max="100" value="${xPos}">
            </div>
            <div class="position-controls">
                <label>Y ä½ç½®: <span class="pos-value">${yPos}%</span></label>
                <input type="range" class="sprite-y-slider" min="0" max="100" value="${yPos}">
            </div>
            <div class="position-controls">
                <label>å¤§å°: <span class="pos-value">${size}%</span></label>
                <input type="range" class="sprite-size-slider" min="10" max="150" value="${size}">
            </div>
            <!-- â–²â–²â–² æ–°å¢UIç»“æŸ â–²â–²â–² -->

        </div>
        <button class="delete-sprite-btn">Ã—</button>
    `;

    // ä¸ºå¡ç‰‡å†…çš„æŒ‰é’®ç»‘å®šäº‹ä»¶ (è¿™éƒ¨åˆ†ä¸å˜)
    card.querySelector('.delete-sprite-btn').onclick = () => card.remove();
    card.querySelector('.upload-sprite-btn').onclick = () => handleSpriteImageUpload(card);
    card.querySelector('.sprite-url-input').oninput = (e) => {
        card.querySelector('.preview-container').style.backgroundImage = `url(${e.target.value})`;
    };
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºæ–°æ»‘å—ç»‘å®šäº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æ—è¾¹çš„æ•°å€¼æ˜¾ç¤º â˜…â˜…â˜…
    card.querySelectorAll('.position-controls input[type="range"]').forEach(slider => {
        slider.addEventListener('input', () => {
            const valueSpan = slider.previousElementSibling.querySelector('.pos-value');
            if(valueSpan) {
                valueSpan.textContent = `${slider.value}%`;
            }
        });
    });

    return card;
}


/**
 * ã€è¾…åŠ©ã€‘å¤„ç†å•ä¸ªç«‹ç»˜çš„å›¾ç‰‡ä¸Šä¼ 
 * @param {HTMLElement} cardElement - å¯¹åº”çš„ç«‹ç»˜ç¼–è¾‘å¡ç‰‡
 */
function handleSpriteImageUpload(cardElement) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if (file) {
            const dataUrl = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            cardElement.querySelector('.sprite-url-input').value = dataUrl;
            cardElement.querySelector('.preview-container').style.backgroundImage = `url(${dataUrl})`;
        }
    };
    fileInput.click();
}

/**
 * ã€æ ¸å¿ƒ V2 - å·²æ”¯æŒä½ç½®å¤§å°ã€‘ä¿å­˜æ•´ä¸ªç«‹ç»˜ç»„ï¼ˆåŒ…æ‹¬æ‰€æœ‰ç«‹ç»˜ï¼‰
 */
async function saveSpriteGroup() {
    const name = document.getElementById('sprite-group-name-input').value.trim();
    if (!name) {
        alert("ç«‹ç»˜ç»„åç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }

    // 1. ä¿å­˜æˆ–æ›´æ–°ç«‹ç»˜ç»„çš„åç§° (è¿™éƒ¨åˆ†ä¸å˜)
    let groupId;
    if (editingSpriteGroupId) {
        await db.datingSpriteGroups.update(editingSpriteGroupId, { name });
        groupId = editingSpriteGroupId;
    } else {
        groupId = await db.datingSpriteGroups.add({ name });
    }

    // 2. å‡†å¤‡æ›´æ–°çš„ç«‹ç»˜æ•°æ® (â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â˜…â˜…â˜…)
    const spriteCards = document.querySelectorAll('#sprite-list-editor .sprite-edit-card');
    const spritesToSave = [];
    let hasError = false;

    spriteCards.forEach(card => {
        const description = card.querySelector('.sprite-desc-input').value.trim();
        const url = card.querySelector('.sprite-url-input').value.trim();
        
        // â–¼â–¼â–¼ ä»æ–°å¢çš„æ»‘å—ä¸­è¯»å– x, y, size çš„å€¼ â–¼â–¼â–¼
        const x = parseInt(card.querySelector('.sprite-x-slider').value);
        const y = parseInt(card.querySelector('.sprite-y-slider').value);
        const size = parseInt(card.querySelector('.sprite-size-slider').value);
        // â–²â–²â–² è¯»å–ç»“æŸ â–²â–²â–²

        if (!description || !url) {
            hasError = true;
        }

        spritesToSave.push({
            id: card.dataset.spriteId.startsWith('new_') ? undefined : parseInt(card.dataset.spriteId),
            groupId: groupId,
            description,
            url,
            // â–¼â–¼â–¼ å°†è¯»å–åˆ°çš„å€¼æ·»åŠ åˆ°è¦ä¿å­˜çš„å¯¹è±¡ä¸­ â–¼â–¼â–¼
            x: x,
            y: y,
            size: size
            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        });
    });

    if (hasError) {
        alert("å­˜åœ¨æè¿°æˆ–å›¾ç‰‡URLä¸ºç©ºçš„ç«‹ç»˜ï¼Œè¯·å¡«å†™å®Œæ•´ï¼");
        return;
    }

    // 3. ä½¿ç”¨äº‹åŠ¡ï¼Œä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰æ•°æ® (è¿™éƒ¨åˆ†ä¸å˜)
    await db.transaction('rw', db.datingSprites, async () => {
        await db.datingSprites.where('groupId').equals(groupId).delete();
        await db.datingSprites.bulkAdd(spritesToSave);
    });

    // 4. å…³é—­å¼¹çª—å¹¶åˆ·æ–°UI (è¿™éƒ¨åˆ†ä¸å˜)
    document.getElementById('sprite-editor-modal').classList.remove('visible');
    await renderSpriteGroupManagerList();
    await renderDatingSpriteGroupSelector();
    
    if (document.getElementById('dating-game-settings-modal').classList.contains('visible')) {
        document.getElementById('dating-sprite-group-select').value = groupId;
    }
    
    alert('ç«‹ç»˜ç»„å·²ä¿å­˜ï¼');
}


/**
 * ã€æ ¸å¿ƒã€‘åˆ é™¤ä¸€ä¸ªç«‹ç»˜ç»„åŠå…¶æ‰€æœ‰ç«‹ç»˜
 * @param {number} groupId - è¦åˆ é™¤çš„ç«‹ç»˜ç»„çš„ID
 */
async function deleteSpriteGroup(groupId) {
    const group = await db.datingSpriteGroups.get(groupId);
    const confirmed = await showCustomConfirm('åˆ é™¤ç«‹ç»˜ç»„', `ç¡®å®šè¦åˆ é™¤ç«‹ç»˜ç»„ â€œ${group.name}â€ å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, {confirmButtonClass: 'btn-danger'});
    if (confirmed) {
        await db.transaction('rw', db.datingSpriteGroups, db.datingSprites, db.datingPresets, async () => {
            // 1. åˆ é™¤è¯¥ç»„ä¸‹çš„æ‰€æœ‰ç«‹ç»˜
            await db.datingSprites.where('groupId').equals(groupId).delete();
            // 2. åˆ é™¤ç«‹ç»˜ç»„æœ¬èº«
            await db.datingSpriteGroups.delete(groupId);
            // 3. ã€å…³é”®ã€‘æ‰¾åˆ°æ‰€æœ‰å¼•ç”¨äº†è¿™ä¸ªç«‹ç»˜ç»„çš„çº¦ä¼šé¢„è®¾ï¼Œå¹¶å°†å®ƒä»¬çš„å¼•ç”¨æ¸…ç©º
            const presetsToUpdate = await db.datingPresets.where('settings.spriteGroupId').equals(groupId).toArray();
            for (const preset of presetsToUpdate) {
                preset.settings.spriteGroupId = null;
                await db.datingPresets.put(preset);
            }
        });
        await renderSpriteGroupManagerList();
        await renderDatingSpriteGroupSelector();
        alert('ç«‹ç»˜ç»„å·²åˆ é™¤ã€‚');
    }
}
/* â–²â–²â–² çº¦ä¼šç«‹ç»˜åŠŸèƒ½æ ¸å¿ƒå‡½æ•°ç»“æŸ â–²â–²â–² */


// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ showDatingSummaryCard å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°V2ã€‘å½“çº¦ä¼šç»“æŸæ—¶ï¼Œæ˜¾ç¤ºç»“ç®—å¡ç‰‡ï¼Œå¹¶è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•
 * @param {string} [finalStory=""] - çº¦ä¼šçš„æœ€åä¸€æ®µå‰§æƒ…æ–‡æœ¬
 */
async function showDatingSummaryCard(finalStory = "") { // <--- å…³é”®ï¼šå°†å‡½æ•°å£°æ˜ä¸º async
    const overlay = document.getElementById('dating-summary-overlay');
    const card = document.querySelector('.dating-summary-card');
    const cardInner = document.querySelector('.dating-summary-card-inner');
    const cardFront = document.querySelector('.card-front');
    const avatarEl = document.getElementById('summary-card-avatar');
    const ratingEl = document.getElementById('summary-card-rating');
    const historyEl = document.getElementById('summary-card-history');

    document.getElementById('summary-share-btn').style.display = 'block';

    card.classList.remove('is-flipped');
    cardFront.classList.remove('romantic', 'passionate', 'perfect');

    const romance = datingGameState.romance;
    const lust = datingGameState.lust;
    const completion = datingGameState.completion;
    let ratingText = '';
    let cardClass = '';
    let finalRatingType = 'anticipation';

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œæ›¿æ¢ä½ çš„æ—§ä»£ç  â–¼â–¼â–¼

    if (romance >= 100 && lust >= 100 && completion >= 100) {
        ratingText = 'å®Œç¾ä¹‹å¤œ ğŸŠ'; // ä¿®æ”¹ç‚¹ï¼šæ·»åŠ äº†åº†ç¥çš„ emoji
        cardClass = 'perfect';
        finalRatingType = 'perfect';
    } else if (romance >= 100) {
        ratingText = 'æµªæ¼«ä¹‹å¤œ â¤ï¸'; // ä¿®æ”¹ç‚¹ï¼šæ·»åŠ äº†çˆ±å¿ƒ emoji
        cardClass = 'romantic';
        finalRatingType = 'romantic';
    } else if (lust >= 100) {
        ratingText = 'æ¿€æƒ…ä¹‹å¤œ â­'; // ä¿®æ”¹ç‚¹ï¼šæ·»åŠ äº†æ˜Ÿæ˜Ÿ emoji
        cardClass = 'passionate';
        finalRatingType = 'passionate';
    } else {
        ratingText = 'æœŸå¾…ä¹‹å¤œ'; // ä¿æŒä¸å˜
    }
    
// â–²â–²â–² å¤åˆ¶æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

    const character = state.chats[datingGameState.characterId];
    avatarEl.src = character.settings.aiAvatar || defaultAvatar;
    ratingEl.textContent = ratingText;
    if(cardClass) {
        cardFront.classList.add(cardClass);
    }

    const fullHistory = [...datingGameState.storyHistory, `ã€æ—ç™½ã€‘: ${finalStory}`].join('\n\n').replace(/\n/g, '<br>');
    historyEl.innerHTML = `<p>${fullHistory}</p>`;
    
    // æš‚å­˜æ•°æ®ï¼Œä»¥ä¾¿åˆ†äº«
    currentDatingSummary = {
        rating: ratingText,
        ratingType: finalRatingType,
        characterId: datingGameState.characterId,
        avatarUrl: avatarEl.src,
        storyHistory: datingGameState.storyHistory,
        finalStory: finalStory,
        sceneName: datingGameState.scene.name
    };

    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„ã€æœ€æ ¸å¿ƒçš„ä¿å­˜é€»è¾‘ï¼ â˜…â˜…â˜…â˜…â˜…
    try {
        const historyRecord = {
            ...currentDatingSummary, // å°†å¡ç‰‡çš„æ‰€æœ‰ä¿¡æ¯éƒ½å¤åˆ¶è¿‡æ¥
            timestamp: Date.now()   // åŠ ä¸Šä¸€ä¸ªä¿å­˜æ—¶çš„æ—¶é—´æˆ³
        };
        // ä½¿ç”¨ await å¼‚æ­¥åœ°å°†è¿™æ¡è®°å½•æ·»åŠ åˆ°æˆ‘ä»¬çš„æ–°æ•°æ®åº“è¡¨ä¸­
        await db.datingHistory.add(historyRecord);
        console.log('çº¦ä¼šç»“ç®—å¡ç‰‡å·²ä¿å­˜åˆ°å†å²åº“:', historyRecord);
    } catch (error) {
        console.error('ä¿å­˜çº¦ä¼šç»“ç®—å¡ç‰‡å¤±è´¥:', error);
    }
    // â–²â–²â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–²â–²â–²

    overlay.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/**
 * ã€å…¨æ–°V2ç‰ˆã€‘å°†ç»“ç®—å¡ç‰‡åˆ†äº«åˆ°ä¸è§’è‰²çš„èŠå¤©ä¸­ (åŒ…å«å®Œæ•´è®°å½•ç”¨äºç¼–è¾‘)
 */
async function shareDatingSummary() {
    // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿æœ‰ç»“ç®—æ•°æ®
    if (!currentDatingSummary) return;

    const chat = state.chats[currentDatingSummary.characterId];
    if (!chat) return;

    // 1. å‡†å¤‡ä¸€ä¸ªç”¨äºã€ç¼–è¾‘æ—¶ã€‘æ˜¾ç¤ºçš„ã€åŒ…å«å®Œæ•´çº¦ä¼šè¿‡ç¨‹çš„è¯¦ç»†æ–‡æœ¬
    const storyForEdit = [...currentDatingSummary.storyHistory, `ã€æ—ç™½ã€‘: ${currentDatingSummary.finalStory}`].join('\n');
    const contentForEditing = `
[çº¦ä¼šè®°å½•]
çº¦ä¼šåœºæ‰€: ${currentDatingSummary.sceneName}
çº¦ä¼šè¯„çº§: ${currentDatingSummary.rating}
--------------------
${storyForEdit}
    `.trim();

    // 2. åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„æ¶ˆæ¯å¯¹è±¡ï¼Œå®ƒå°†ä½œä¸ºèŠå¤©è®°å½•è¢«ä¿å­˜
    const summaryMessage = {
        role: 'user', // æ ‡è®°ä¸ºç”¨æˆ·å‘å‡ºçš„æ¶ˆæ¯
        type: 'dating_summary_card', // è¿™æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–°æ¶ˆæ¯ç±»å‹ï¼Œç”¨äºè¯†åˆ«
        timestamp: Date.now(),
        
        // ã€æ ¸å¿ƒã€‘è¿™ä¸ª content å­—æ®µå°±æ˜¯ä½ æƒ³è¦çš„ï¼Œå½“ç¼–è¾‘è¿™æ¡æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šæ˜¾ç¤ºè¿™é‡Œçš„æ–‡æœ¬
        content: contentForEditing, 
        
        // payload å­—æ®µç”¨äºå­˜å‚¨æ¸²æŸ“UIæ‰€éœ€çš„æ‰€æœ‰æ•°æ®
        payload: {
            rating: currentDatingSummary.rating,
            ratingType: currentDatingSummary.ratingType,
            avatarUrl: currentDatingSummary.avatarUrl,
            storyHistory: currentDatingSummary.storyHistory,
            finalStory: currentDatingSummary.finalStory,
            sceneName: currentDatingSummary.sceneName,
            characterName: chat.name // æŠŠè§’è‰²åå­—ä¹Ÿå­˜è¿›å»ï¼Œæ–¹ä¾¿å¡ç‰‡èƒŒé¢æ˜¾ç¤º
        }
    };

    // 3. å°†è¿™æ¡æ–°æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©è®°å½•å¹¶ä¿å­˜åˆ°æ•°æ®åº“
    chat.history.push(summaryMessage);
    await db.chats.put(chat);
    
    // 4. ç»™å‡ºæˆåŠŸæç¤ºï¼Œå¹¶å…³é—­ç»“ç®—å¡ç‰‡ã€ç»“æŸçº¦ä¼š
    await showCustomAlert('åˆ†äº«æˆåŠŸ', 'ä½ ä»¬çš„çº¦ä¼šè®°å½•å·²å‘é€ç»™Taï¼');
    
    document.getElementById('dating-summary-overlay').classList.remove('visible');
    finalizeAndExitDate(); // è¿™ä¸ªå‡½æ•°ä¼šå¤„ç†åç»­çš„æ¸…ç†å·¥ä½œ
    currentDatingSummary = null; // æ¸…ç†ä¸´æ—¶æ•°æ®
}


/**
 * ã€å…¨æ–°ã€‘é‡æ–°æ‰“å¼€çº¦ä¼šç»“ç®—è¯¦æƒ…å¡ç‰‡
 * @param {object} payload - ä»èŠå¤©è®°å½•æ¶ˆæ¯ä¸­è§£æå‡ºçš„å¡ç‰‡æ•°æ®
 */
function reopenDatingSummary(payload) {
    const overlay = document.getElementById('dating-summary-overlay');
    const card = document.querySelector('.dating-summary-card');
    const cardInner = document.querySelector('.dating-summary-card-inner');
    const cardFront = document.querySelector('.card-front');
    const avatarEl = document.getElementById('summary-card-avatar');
    const ratingEl = document.getElementById('summary-card-rating');
    const historyEl = document.getElementById('summary-card-history');

    // é‡ç½®å¡ç‰‡çŠ¶æ€
    card.classList.remove('is-flipped');
    cardFront.classList.remove('romantic', 'passionate', 'perfect');
    cardFront.style.background = '';
    
    // ä» payload ä¸­æ¢å¤æ•°æ®å¹¶å¡«å……åˆ°UIå…ƒç´ ä¸­
    avatarEl.src = payload.avatarUrl;
    ratingEl.textContent = payload.rating;
    if (payload.ratingType && payload.ratingType !== 'anticipation') {
        cardFront.classList.add(payload.ratingType);
    }
    
    const fullHistory = [...payload.storyHistory, `ã€æ—ç™½ã€‘: ${payload.finalStory}`].join('\n\n').replace(/\n/g, '<br>');
    historyEl.innerHTML = `<p>${fullHistory}</p>`;

    // è®¾ç½®å¡ç‰‡èƒŒé¢çš„æ ‡é¢˜
    const cardBackHeader = document.querySelector('.card-back .card-back-header span');
    if (cardBackHeader) {
        cardBackHeader.textContent = `${payload.characterName} - ${payload.sceneName}`;
    }

    // å› ä¸ºåªæ˜¯æŸ¥çœ‹ï¼Œæ‰€ä»¥éšè—â€œåˆ†äº«â€æŒ‰é’®
    document.getElementById('summary-share-btn').style.display = 'none';

    overlay.classList.add('visible');
}


/* --- ã€å…¨æ–°ã€‘çº¦ä¼šå†å²è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•° --- */

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€å†å²çº¦ä¼šç•Œé¢
 */
async function openDatingHistory() {
    showScreen('dating-history-screen');
    await renderDatingHistory();
}

/**
 * ã€æ¸²æŸ“å‡½æ•°ã€‘æ¸²æŸ“å†å²çº¦ä¼šåˆ—è¡¨
 */
async function renderDatingHistory() {
    const listEl = document.getElementById('dating-history-list');
    listEl.innerHTML = '';

    // ä»æ•°æ®åº“è¯»å–æ‰€æœ‰è®°å½•ï¼Œå¹¶æŒ‰æ—¶é—´å€’åºæ’åˆ—
    const records = await db.datingHistory.orderBy('timestamp').reverse().toArray();

    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰ä»»ä½•çº¦ä¼šè®°å½•å“¦</p>';
        return;
    }

    // éå†æ¯ä¸€æ¡è®°å½•ï¼Œåˆ›å»ºå¯¹åº”çš„å¡ç‰‡å¹¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­
    records.forEach(record => {
        const card = createDatingHistoryCard(record);
        listEl.appendChild(card);
    });
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘æ ¹æ®å•æ¡å†å²è®°å½•ï¼Œåˆ›å»ºä¸€å¼ å¯ç¿»è½¬çš„å¡ç‰‡
 * @param {object} record - å†å²è®°å½•å¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡DOMå…ƒç´ 
 */
function createDatingHistoryCard(record) {
    const cardContainer = document.createElement('div');
    cardContainer.className = 'dating-summary-card'; // å¤ç”¨ç»“ç®—å¡ç‰‡çš„æ ·å¼ï¼Œå¾ˆæ–¹ä¾¿ï¼

    // æ ¹æ®è¯„çº§ç±»å‹è®¾ç½®å¡ç‰‡æ­£é¢çš„é¢œè‰²
    let cardClass = '';
    if (record.ratingType === 'romantic') cardClass = 'romantic';
    else if (record.ratingType === 'passionate') cardClass = 'passionate';
    else if (record.ratingType === 'perfect') cardClass = 'perfect';

    // æ‹¼æ¥å¡ç‰‡èƒŒé¢çš„å®Œæ•´çº¦ä¼šè®°å½•HTML
    const fullHistoryHtml = [...record.storyHistory, `ã€æ—ç™½ã€‘: ${record.finalStory}`]
        .join('\n\n')
        .replace(/\n/g, '<br>');

    // è·å–è§’è‰²åå­—ï¼Œå¦‚æœè§’è‰²è¢«åˆ äº†ï¼Œå°±æ˜¾ç¤ºâ€œæœªçŸ¥è§’è‰²â€
    const charName = state.chats[record.characterId]?.name || 'æœªçŸ¥è§’è‰²';
    
    // æœ€ç»ˆæ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„ã€åŒ…å«æ­£åä¸¤é¢çš„å¡ç‰‡HTML
    cardContainer.innerHTML = `
        <div class="dating-summary-card-inner">
            <!-- å¡ç‰‡æ­£é¢ -->
            <div class="card-front ${cardClass}">
                <img src="${record.avatarUrl}" alt="è§’è‰²å¤´åƒ">
                <h2>${record.rating}</h2>
                <p>${new Date(record.timestamp).toLocaleDateString()}</p>
                <p class="summary-card-tip">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</p>
            </div>
            <!-- å¡ç‰‡èƒŒé¢ -->
            <div class="card-back">
                <div class="card-back-header">
                    <span>${charName} - ${record.sceneName}</span>
                </div>
                <div class="card-back-content">
                    <p>${fullHistoryHtml}</p>
                </div>
            </div>
        </div>
    `;
    return cardContainer;
}

/* --- ã€å…¨æ–°ã€‘çº¦ä¼šå†å²è®°å½•åŠŸèƒ½å‡½æ•°ç»“æŸ --- */
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„å‡½æ•°ï¼Œç²˜è´´åˆ° handleSaveCustomDatingScene å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€V2 - åœºæ™¯é‡å†™ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ getSceneTypeKeywords å‡½æ•° â–¼â–¼â–¼

/**
 * ã€V2 - åœºæ™¯é‡å†™ç‰ˆã€‘æ ¹æ®åœºæ™¯åç§°ï¼Œæ™ºèƒ½åˆ¤æ–­å¹¶è¿”å›é‡å†™åçš„åœºæ™¯æè¿°å’Œé£æ ¼å…³é”®è¯
 * @param {string} sceneName - ç”¨æˆ·è¾“å…¥çš„åœºæ™¯åç§°
 * @returns {{scenePrompt: string, styleKeywords: string}} - è¿”å›åŒ…å«åœºæ™¯æè¿°å’Œé£æ ¼è¯çš„å¯¹è±¡
 */
function getSceneTypeKeywords(sceneName) {
    const name = sceneName.toLowerCase(); // è½¬æ¢ä¸ºå°å†™ï¼Œæ–¹ä¾¿åŒ¹é…

    const outdoorKeywords = ['å…¬å›­', 'æµ·æ»©', 'å±±', 'æ£®æ—', 'æ¹–', 'èŠ±å›­', 'å¤œå¸‚', 'è·¯è¾¹', 'è¡—å¤´', 'park', 'beach', 'mountain', 'forest', 'lake', 'garden', 'street'];
    const indoorPublicKeywords = ['å’–å•¡', 'ä¹¦åº—', 'åšç‰©é¦†', 'ç¾æœ¯é¦†', 'æ°´æ—é¦†', 'å½±é™¢', 'é…’å§', 'cafe', 'bookstore', 'museum', 'gallery', 'aquarium', 'cinema', 'bar'];
    const loveHotelKeywords = ['æƒ…è¶£', 'love hotel', 'ä¸»é¢˜é…’åº—', 'lovers hotel', 'æˆäººæ—…é¦†'];

    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¼˜å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æ®Šçš„æƒ…è¶£é…’åº—
    if (loveHotelKeywords.some(keyword => name.includes(keyword))) {
        console.log("åœºæ™¯è¯†åˆ«ä¸ºï¼šæƒ…è¶£é…’åº—ï¼ˆå·²æ¿€æ´»ç‰¹æ®Šé‡å†™æ¨¡å¼ï¼‰");
        // æˆ‘ä»¬ä¸å†ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ "æƒ…è¶£é…’åº—" è¿™ä¸ªè¯
        // è€Œæ˜¯ç›´æ¥æŠŠå®ƒâ€œç¿»è¯‘â€æˆä¸€ä¸ªçº¯ç²¹çš„ã€æè¿°æ€§çš„åœºæ™¯
        return {
            scenePrompt: 'an empty luxurious romantic hotel room interior, with a heart-shaped bed or a round bed, mirrors on the ceiling, neon mood lighting, Jacuzzi in room, sensual and intimate atmosphere',
            styleKeywords: 'romantic, luxurious, intimate, playful'
        };
    }

    // 2. å¯¹äºå…¶ä»–åœºæ™¯ï¼Œä¿æŒåŸæ¥çš„é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åç§°
    if (outdoorKeywords.some(keyword => name.includes(keyword))) {
        console.log("åœºæ™¯è¯†åˆ«ä¸ºï¼šæˆ·å¤–");
        return {
            scenePrompt: sceneName,
            styleKeywords: 'natural lighting, golden hour, beautiful scenery, serene atmosphere, epic sky, wide angle'
        };
    }

    if (indoorPublicKeywords.some(keyword => name.includes(keyword))) {
        console.log("åœºæ™¯è¯†åˆ«ä¸ºï¼šå®¤å†…å…¬å…±åœºæ‰€");
        return {
            scenePrompt: sceneName,
            styleKeywords: 'cozy interior, ambient lighting, warm and inviting, charming decor, detailed background'
        };
    }

    // 4. é»˜è®¤æƒ…å†µï¼Œä¹Ÿç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åç§°
    console.log("åœºæ™¯è¯†åˆ«ä¸ºï¼šé€šç”¨/ç°ä»£é…’åº—");
    return {
        scenePrompt: sceneName,
        styleKeywords: 'modern aesthetic, elegant decor, luxurious interior, clean, bright'
    };
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²é€‚é…ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleSaveCustomDatingScene å‡½æ•° â–¼â–¼â–¼
async function handleSaveCustomDatingScene() {
    const name = document.getElementById('scene-name-input').value.trim();
    const imageUrl = document.getElementById('scene-image-url-input').value.trim();
    const costStr = document.getElementById('scene-cost-input').value.trim();

    if (!name || !costStr) {
        alert("åœºæ™¯åç§°å’ŒèŠ±è´¹ä¸ºå¿…å¡«é¡¹ï¼");
        return;
    }

    const cost = parseInt(costStr, 10);
    if (isNaN(cost) || cost < 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„èŠ±è´¹é‡‘é¢ï¼");
        return;
    }
    
    const newScene = {
        name: name,
        cost: cost,
        uid: 'scene_user_' + Date.now()
    };

    if (imageUrl) {
        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('data:image')) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç½‘ç»œå›¾ç‰‡URLï¼");
            return;
        }
        newScene.imageUrl = imageUrl;
        newScene.imagePrompt = 'User-provided image';
    } else {
        // --- ã€æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œã€‘ ---

        // 1. è¿™æ˜¯æˆ‘ä»¬å¼ºåŠ›çš„é€šç”¨æŒ‡ä»¤ï¼Œç¡®ä¿é«˜è´¨é‡å’Œã€ç»å¯¹ä¸è¦äººç‰©ã€‘
        const universalStyle = "photorealistic, 4k, hyperrealistic, cinematic lighting, masterpiece, best quality, ultra detailed, no dark elements, romantic, (no humans:1.5), no people, no characters, empty room, no one";
        
        // 2. è°ƒç”¨æˆ‘ä»¬å‡çº§åçš„è¾…åŠ©å‡½æ•°ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…å« scenePrompt å’Œ styleKeywords çš„å¯¹è±¡
        const promptParts = getSceneTypeKeywords(name);
        
        // 3. å°†ã€é‡å†™åçš„åœºæ™¯æè¿°ã€‘ã€ã€æ™ºèƒ½é£æ ¼ã€‘å’Œã€é€šç”¨é£æ ¼ã€‘ç»„åˆæˆæœ€ç»ˆçš„æç¤ºè¯
        newScene.imageUrl = '';
        newScene.imagePrompt = `${promptParts.scenePrompt}, ${promptParts.styleKeywords}, ${universalStyle}`;
        
        console.log("ã€ç»ˆæç‰ˆã€‘ç”Ÿæˆçš„Image Prompt:", newScene.imagePrompt); 
    }

    try {
        await db.datingScenes.add(newScene);
        currentDatingScenes.push(newScene);
        document.getElementById('create-dating-scene-modal').classList.remove('visible');
        renderDatingScenes();
        alert('è‡ªå®šä¹‰çº¦ä¼šåœºæ™¯å·²æˆåŠŸåˆ›å»ºï¼');
    } catch (error) {
        console.error("ä¿å­˜è‡ªå®šä¹‰çº¦ä¼šåœºæ™¯å¤±è´¥:", error);
        alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™3ä¸ªã€å…¨æ–°ã€‘çš„å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSä»£ç åŠŸèƒ½åŒº â–¼â–¼â–¼

// â–¼â–¼â–¼ ä½¿ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ renderStickerCategories å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V2 - æœªåˆ†ç±»ç‰ˆã€‘æ¸²æŸ“è¡¨æƒ…é¢æ¿åº•éƒ¨çš„åˆ†ç±»é¡µç­¾æ 
 */
async function renderStickerCategories() {
    const tabsContainer = document.getElementById('sticker-category-tabs');
    if (!tabsContainer) return;

    tabsContainer.innerHTML = '';
    const categories = await db.userStickerCategories.orderBy('name').toArray();
    userStickerCategories = categories;

    // â˜… æ ¸å¿ƒä¿®æ”¹1ï¼šåˆ›å»ºâ€œæœªåˆ†ç±»â€æŒ‰é’®ï¼Œè€Œä¸æ˜¯â€œå…¨éƒ¨â€
    const uncategorizedBtn = document.createElement('button');
    uncategorizedBtn.className = 'sticker-category-btn';
    uncategorizedBtn.textContent = 'æœªåˆ†ç±»'; // æ–‡å­—æ”¹å˜
    if (activeStickerCategoryId === 'uncategorized') { // æ£€æŸ¥çš„IDä¹Ÿæ”¹å˜
        uncategorizedBtn.classList.add('active');
    }
    uncategorizedBtn.addEventListener('click', () => {
        activeStickerCategoryId = 'uncategorized'; // ç‚¹å‡»åè®¾ç½®çš„IDä¹Ÿæ”¹å˜
        renderStickerPanel(); 
    });
    tabsContainer.appendChild(uncategorizedBtn);

    // å…¶ä»–åˆ†ç±»æŒ‰é’®çš„é€»è¾‘ä¿æŒä¸å˜
    categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'sticker-category-btn';
        btn.textContent = category.name;
        if (activeStickerCategoryId === category.id) {
            btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
            activeStickerCategoryId = category.id;
            renderStickerPanel();
        });
        tabsContainer.appendChild(btn);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€ç§»åŠ¨è¡¨æƒ…åˆ°åˆ†ç±»çš„æ¨¡æ€æ¡†
 */
async function openStickerCategoryModal() {
    if (selectedUserStickers.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„è¡¨æƒ…åŒ…ï¼');
        return;
    }

    const modal = document.getElementById('sticker-category-modal');
    const listEl = document.getElementById('sticker-category-list');
    const inputEl = document.getElementById('new-sticker-category-input');
    listEl.innerHTML = '';
    inputEl.value = '';

    const categories = await db.userStickerCategories.toArray();
    if (categories.length > 0) {
        categories.forEach(cat => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="radio" name="sticker_category_select" value="${cat.id}"> ${cat.name}`;
            listEl.appendChild(label);
        });
    } else {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»ã€‚</p>';
    }

    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†â€œç¡®è®¤ç§»åŠ¨â€æŒ‰é’®çš„ç‚¹å‡»é€»è¾‘
 */
async function handleMoveStickers() {
    const newCategoryName = document.getElementById('new-sticker-category-input').value.trim();
    const selectedRadio = document.querySelector('input[name="sticker_category_select"]:checked');
    
    let targetCategoryId = null;

    if (newCategoryName) {
        try {
            // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å·²å­˜åœ¨
            let existingCategory = await db.userStickerCategories.where('name').equalsIgnoreCase(newCategoryName).first();
            if (existingCategory) {
                targetCategoryId = existingCategory.id;
            } else {
                targetCategoryId = await db.userStickerCategories.add({ name: newCategoryName });
            }
        } catch (error) {
            alert('åˆ›å»ºæ–°åˆ†ç±»å¤±è´¥ï¼Œå¯èƒ½æ˜¯åç§°é‡å¤æˆ–æ•°æ®åº“é”™è¯¯ã€‚');
            return;
        }
    } else if (selectedRadio) {
        targetCategoryId = parseInt(selectedRadio.value);
    } else {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æˆ–åˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»ï¼');
        return;
    }

    try {
        const stickerIdsToMove = Array.from(selectedUserStickers);
        const stickers = await db.userStickers.bulkGet(stickerIdsToMove);
        
        stickers.forEach(sticker => {
            if (sticker) {
                sticker.categoryId = targetCategoryId;
            }
        });

        await db.userStickers.bulkPut(stickers);
        
        // æ›´æ–°å†…å­˜ä¸­çš„ state.userStickers
        stickers.forEach(updatedSticker => {
            const index = state.userStickers.findIndex(s => s.id === updatedSticker.id);
            if (index > -1) {
                state.userStickers[index].categoryId = targetCategoryId;
            }
        });

        document.getElementById('sticker-category-modal').classList.remove('visible');
        exitUserStickerSelectionMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼
        alert(`æˆåŠŸç§»åŠ¨ ${stickerIdsToMove.length} ä¸ªè¡¨æƒ…ï¼`);

    } catch (error) {
        console.error("ç§»åŠ¨è¡¨æƒ…å¤±è´¥:", error);
        alert("ç§»åŠ¨è¡¨æƒ…æ—¶å‘ç”Ÿé”™è¯¯ã€‚");
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²



        // ===================================================================
        // 4. åˆå§‹åŒ–å‡½æ•° init()
        // ===================================================================
        async function init() {
    // â–¼â–¼â–¼ åœ¨ init()    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™å‡ è¡Œæ–°ä»£ç  â–¼â–¼â–¼
    // æ›´æ–°å°ç»„ä»¶çš„æœˆä»½æ˜¾ç¤º
    const monthElement = document.getElementById('widget-month-display');
    if (monthElement) {
        const currentMonth = new Date().getMonth() + 1; // getMonth()è¿”å›0-11ï¼Œæ‰€ä»¥è¦+1
        monthElement.textContent = currentMonth;
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² å‡½æ•°çš„ã€æœ€å¼€å¤´ã€‘ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œä»£ç  â–¼â–¼â–¼
    const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é»˜è®¤ä¸ºæ—¥é—´æ¨¡å¼
    applyTheme(savedTheme);
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²


    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            window.showScreen = showScreen;
            window.openLoversSpaceFromCard = openLoversSpaceFromCard; // <-- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œ
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();
            // åœ¨ loadAllDataFromDB å‡½æ•°æœ«å°¾ï¼Œinit(); è°ƒç”¨ä¹‹å‰æ·»åŠ 
if (typeof state.globalSettings.notificationSoundUrl === 'undefined') {
    state.globalSettings.notificationSoundUrl = 'https://files.catbox.moe/k369mf.mp3';
}
            // â–¼â–¼â–¼ æŠŠæ–°ä»£ç ç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼
            renderHomeScreenProfileFrame(); // åˆå§‹åŒ–æ—¶æ¸²æŸ“ä¸»é¡µå¤´åƒæ¡†
            // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
            applyHomeIconWidgetTextColor(state.globalSettings.homeIconWidgetTextColor);
            await loadAllFontPresetsOnStartup(); // <---- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œæ–°ä»£ç 
            await migrateDefaultLudoQuestions();
            await addDefaultDarkModeThemeIfNeeded();
            applyWidgetData();

if (state.globalSettings.homeIconWidgetTextColor) {
    applyHomeIconWidgetTextColor(state.globalSettings.homeIconWidgetTextColor);
}

// 2. åº”ç”¨å·²ä¿å­˜çš„â€œå»é™¤é˜´å½±â€è®¾ç½®
document.getElementById('phone-screen').classList.toggle('no-home-font-shadow', !!state.globalSettings.removeHomeFontShadow);

            // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åˆå§‹åŒ–æ—¶ï¼Œè‡ªåŠ¨åŠ è½½å¹¶åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜
    if (state.globalSettings.activeThemeId) {
        const activeTheme = await db.themes.get(state.globalSettings.activeThemeId);
        if (activeTheme) {
            console.log(`æ­£åœ¨åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜: "${activeTheme.name}"`);
            applyThemeCss(activeTheme.css);
        }
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();
applyAppLabels();
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
    initDraggableLyricsBar(); // åˆå§‹åŒ–æ‚¬æµ®æ­Œè¯æ çš„æ‹–åŠ¨åŠŸèƒ½
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // ==========================================================
            // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
            // ==========================================================
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç ï¼Œæ›¿æ¢æ—§çš„ weibo-screen äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ (V2 - å•ç‹¬ç”Ÿæˆç‰ˆ) â–¼â–¼â–¼

            // 1. ç»‘å®šä¸»å±å¹•ä¸Šçš„â€œæŸ¥æ‰‹æœºâ€APPå›¾æ ‡
            document.getElementById('check-phone-btn').addEventListener('click', openCharacterSelectionScreen);

            // 2. è§’è‰²é€‰æ‹©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
            document.getElementById('character-selection-list').addEventListener('click', (e) => {
                const item = e.target.closest('.character-select-item');
                if (item && item.dataset.chatId) {
                    openCharacterPhone(item.dataset.chatId);
                }
            });

            // 3. ã€æ€»ç”Ÿæˆ/æ¸…ç©ºã€‘è§’è‰²æ‰‹æœºé¡¶éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰é’®
            document.getElementById('generate-character-data-btn').addEventListener('click', generateCharacterPhoneData);
            document.getElementById('clear-character-data-btn').addEventListener('click', clearCharacterPhoneData);

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ character-phone-container äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    const backBtn = e.target.closest('.back-btn');
    const actionBtn = e.target.closest('.action-btn');

    // 1. å¤„ç†è¿”å›æŒ‰é’®
    if (backBtn) {
        if (backBtn.dataset.targetPage) {
            showCharacterPhonePage(backBtn.dataset.targetPage);
        } else if (backBtn.dataset.targetScreen) {
            showScreen(backBtn.dataset.targetScreen);
        }
        return;
    }
    
    // 2. å¤„ç†æ‰€æœ‰æ“ä½œæŒ‰é’®ï¼ˆç”Ÿæˆ + åˆ é™¤ï¼‰
    if (actionBtn) {
        switch (actionBtn.id) {
            // --- å•ç‹¬ç”ŸæˆæŒ‰é’® ---
            case 'generate-chat-message-btn': 
                generateCharacterPhoneDataSegment('chats'); break;
            case 'generate-cart-item-btn':
                generateCharacterPhoneDataSegment('shoppingCart'); break;
            case 'generate-memo-btn':
                generateCharacterPhoneDataSegment('memos'); break;
            case 'generate-browser-history-btn':
                generateCharacterPhoneDataSegment('browserHistory'); break;
            case 'generate-album-photo-btn':
                generateCharacterPhoneDataSegment('photoAlbum'); break;
            case 'generate-bank-transaction-btn':
                generateCharacterPhoneDataSegment('bank'); break;
            case 'generate-trajectory-btn':
                generateCharacterPhoneDataSegment('trajectory'); break;
            case 'generate-app-usage-btn':
                generateCharacterPhoneDataSegment('appUsage'); break;
            case 'generate-diary-entry-btn':
                generateCharacterPhoneDataSegment('diary'); break;

            // --- â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„å…¨éƒ¨åˆ é™¤æŒ‰é’®çš„é€»è¾‘ â˜…â˜…â˜… ---
            case 'clear-npc-chats-btn':
                handleClearCharacterDataSegment('chats'); break;
            case 'clear-cart-items-btn':
                handleClearCharacterDataSegment('shoppingCart'); break;
            case 'clear-memos-btn':
                handleClearCharacterDataSegment('memos'); break;
            case 'clear-browser-history-btn':
                handleClearCharacterDataSegment('browserHistory'); break;
            case 'clear-album-photos-btn':
                handleClearCharacterDataSegment('photoAlbum'); break;
            case 'clear-bank-transactions-btn':
                handleClearCharacterDataSegment('bank.transactions'); break;
            case 'clear-trajectory-btn':
                handleClearCharacterDataSegment('trajectory'); break;
            case 'clear-app-usage-btn':
                handleClearCharacterDataSegment('appUsage'); break;
            case 'clear-diary-entries-btn':
                handleClearCharacterDataSegment('diary'); break;
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€V3æœ€ç»ˆç¾åŒ–ç‰ˆã€‘ä¸»å±å¹•é¢„è®¾åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('home-preset-selector').addEventListener('change', handleHomePresetSelection);
document.getElementById('apply-home-preset-btn').addEventListener('click', applySelectedHomeScreenPreset);
// ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿™é‡ŒæŒ‰é’®çš„IDå˜äº†
document.getElementById('save-home-preset-btn').addEventListener('click', saveCurrentHomeScreenAsPreset); 
document.getElementById('update-home-preset-btn').addEventListener('click', updateSelectedHomeScreenPreset); // <-- æ–°å¢è¿™ä¸€è¡Œ
document.getElementById('rename-home-preset-btn').addEventListener('click', renameSelectedHomeScreenPreset);
document.getElementById('delete-home-preset-btn').addEventListener('click', deleteSelectedHomeScreenPreset);
document.getElementById('export-home-preset-btn').addEventListener('click', exportHomeScreenPreset);
document.getElementById('import-home-preset-btn').addEventListener('click', () => document.getElementById('import-home-preset-input').click());
document.getElementById('import-home-preset-input').addEventListener('change', (e) => {
    importHomeScreenPreset(e.target.files[0]);
    e.target.value = null;
});

            document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®°å½•æœç´¢åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('search-chat-btn').addEventListener('click', openChatSearchScreen);

document.getElementById('search-back-btn').addEventListener('click', () => {
    // è¿”å›æ—¶ï¼Œé‡æ–°æ‰“å¼€èŠå¤©è®¾ç½®å¼¹çª—
    showScreen('chat-interface-screen');
    document.getElementById('chat-settings-btn').click();
});

document.getElementById('perform-search-btn').addEventListener('click', performChatSearch);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰æœç´¢ç»“æœçš„ç‚¹å‡»
document.getElementById('chat-search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.timestamp) {
        jumpToMessage(parseInt(item.dataset.timestamp));
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼

document.getElementById('create-weibo-post-btn').addEventListener('click', openWeiboPublisherClean);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('delete-expired-songs-btn').addEventListener('click', deleteExpiredSearchedSongs);
// â–¼â–¼â–¼ ã€ä¿®æ”¹ã€‘ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ weibo-following-list-container äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('weibo-following-list-container').addEventListener('click', (e) => {
    const item = e.target.closest('.weibo-following-item');
    if (!item) return;

    // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯â€œæ“ä½œâ€æŒ‰é’®
    const triggerBtn = e.target.closest('.weibo-action-trigger-btn');
    if (triggerBtn) {
        const targetInfo = {
            id: triggerBtn.dataset.targetId,
            name: triggerBtn.dataset.targetName,
            isNpc: triggerBtn.dataset.isNpc === 'true',
            ownerId: triggerBtn.dataset.ownerId || null
        };
        openWeiboActionModal(targetInfo);
    } 
    // 2. å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ“ä½œæŒ‰é’®ï¼Œå°±è§†ä¸ºç‚¹å‡»äº†æ•´è¡Œï¼Œè§¦å‘â€œæŸ¥çœ‹ç§ä¿¡â€
    else {
        // å…ˆéšè—å½“å‰çš„å…³æ³¨åˆ—è¡¨å¼¹çª—
        document.getElementById('weibo-following-modal').classList.remove('visible');
        
        // ä»æ•´è¡Œitemä¸Šè·å–è§’è‰²ä¿¡æ¯
        const actionBtn = item.querySelector('.weibo-action-trigger-btn'); // æ‰¾åˆ°è¿™ä¸€è¡Œçš„æŒ‰é’®ä»¥è·å–æ•°æ®
        if (actionBtn) {
            const targetInfo = {
                id: actionBtn.dataset.targetId,
                name: actionBtn.dataset.targetName,
                isNpc: actionBtn.dataset.isNpc === 'true',
                ownerId: actionBtn.dataset.ownerId || null
            };
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æˆ‘ä»¬æ–°å†™çš„æ€»å…¥å£å‡½æ•° â˜…â˜…â˜…
            openWeiboDms(targetInfo);
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
document.getElementById('cancel-weibo-action-btn').addEventListener('click', () => {
    document.getElementById('weibo-action-modal').classList.remove('visible');
});

document.getElementById('confirm-weibo-action-btn').addEventListener('click', handleWeiboAiAction);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// ã€å·²ä¿®æ”¹ã€‘ä¸ºâ€œç”Ÿæˆçƒ­æœâ€å’Œâ€œç”Ÿæˆå¹¿åœºâ€æŒ‰é’®ç»‘å®šæ–°çš„å¸¦è§’è‰²é€‰æ‹©çš„äº‹ä»¶
document.getElementById('generate-hot-search-btn').addEventListener('click', async () => {
    const targets = await showMultiCharacterSelectorForWeibo(); // è°ƒç”¨æ–°çš„å¤šé€‰å‡½æ•°
    if (targets) { 
        await generateHotSearch(targets); 
    }
});
document.getElementById('generate-plaza-feed-btn').addEventListener('click', async () => {
    const targets = await showMultiCharacterSelectorForWeibo();
    if (targets) {
        await generatePlazaFeed(null, targets); 
    }
});


// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// --- å¾®åšçƒ­æœä¸å¹¿åœºåŠŸèƒ½äº‹ä»¶ç»‘å®š ---

// 1. ç»‘å®šçƒ­æœè¯¦æƒ…é¡µçš„â€œè¿”å›â€æŒ‰é’®
document.getElementById('back-from-hottopic-btn').addEventListener('click', () => {
    switchToWeiboView('weibo-hot-search-view');
});

// 2. ç»‘å®šçƒ­æœè¯¦æƒ…é¡µçš„â€œæ¢ä¸€æ‰¹â€æŒ‰é’®
document.getElementById('refresh-hottopic-feed-btn').addEventListener('click', () => {
    if (currentHotTopic) {
        generateHotSearchFeed(currentHotTopic);
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬5å¤„ä¿®æ”¹ï¼ˆæ–°å¢äº‹ä»¶ç›‘å¬å™¨ï¼‰ â–¼â–¼â–¼
    // ã€å…¨æ–°ã€‘è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š
    document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
        if (e.target.id === 'manage-char-stickers-btn') {
            document.getElementById('chat-settings-modal').classList.remove('visible');
            openCharStickerManager();
        }
    });

    document.getElementById('back-from-sticker-manager').addEventListener('click', () => {
        showScreen('chat-interface-screen');
        document.getElementById('chat-settings-btn').click();
    });

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„é¡µç­¾åˆ‡æ¢äº‹ä»¶ â–¼â–¼â–¼
const stickerTabExclusive = document.getElementById('sticker-tab-exclusive');
const stickerTabCommon = document.getElementById('sticker-tab-common');
const stickerContentExclusive = document.getElementById('sticker-content-exclusive');
const stickerContentCommon = document.getElementById('sticker-content-common');

stickerTabExclusive.addEventListener('click', () => {
    stickerTabExclusive.classList.add('active');
    stickerTabCommon.classList.remove('active');
    stickerContentExclusive.classList.add('active');
    stickerContentCommon.classList.remove('active');
    // åˆ‡æ¢æ—¶å¦‚æœå¤„äºé€‰æ‹©æ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“
    if (isCharStickerSelectionMode) renderCharStickers('exclusive');
});

stickerTabCommon.addEventListener('click', () => {
    stickerTabCommon.classList.add('active');
    stickerTabExclusive.classList.remove('active');
    stickerContentCommon.classList.add('active');
    stickerContentExclusive.classList.remove('active');
    // åˆ‡æ¢æ—¶å¦‚æœå¤„äºé€‰æ‹©æ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“
    if (isCharStickerSelectionMode) renderCharStickers('common');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    // ç»‘å®šå„ç§æ·»åŠ /ä¸Šä¼ æŒ‰é’®
    document.getElementById('add-exclusive-sticker-btn').addEventListener('click', () => bulkAddCharStickers('exclusive'));
    document.getElementById('upload-exclusive-sticker-btn').addEventListener('click', () => uploadCharStickersLocal('exclusive'));
    document.getElementById('add-common-sticker-btn').addEventListener('click', () => bulkAddCharStickers('common'));
    document.getElementById('upload-common-sticker-btn').addEventListener('click', () => uploadCharStickersLocal('common'));

    // â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°å†å²è®°å½•åˆ é™¤åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('clear-all-history-btn').addEventListener('click', clearAllInnerVoiceHistory);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å•æ¡åˆ é™¤
document.getElementById('inner-voice-history-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('history-item-delete-btn')) {
        const timestamp = parseInt(e.target.dataset.timestamp);
        if (!isNaN(timestamp)) {
            deleteSingleInnerVoice(timestamp);
        }
    }
});
// â–²â–²â–² å¿ƒå£°å†å²åˆ é™¤äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„å¯¼å…¥åŠŸèƒ½äº‹ä»¶ç›‘å¬ (å·²æ·»åŠ å¼¹çª—ç¡®è®¤) â–¼â–¼â–¼
document.getElementById('import-character-card-btn').addEventListener('click', async () => {
    // 1. å¼¹å‡ºç¡®è®¤å¼¹çª—ï¼Œå¹¶ç­‰å¾…ç”¨æˆ·é€‰æ‹©
    const confirmed = await showCustomConfirm(
        'å¯¼å…¥è§’è‰²å¡é¡»çŸ¥', // è¿™æ˜¯å¼¹çª—çš„æ ‡é¢˜
        'ğŸ±ä¸ç©é…’é¦†çš„è¯·ä¸è¦å¯¼å…¥é…’é¦†è§’è‰²å¡ï¼Œç»è¿‡å†™å¡è€å¸ˆåŒæ„æ‰èƒ½å¯¼å…¥è§’è‰²å¡ï¼Œä¸è¦éšæ„è¾±éª‚ä¾®è¾±è§’è‰²ğŸ‡' // è¿™æ˜¯å¼¹çª—çš„ä¸»è¦å†…å®¹
    );

    // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œç¡®å®šâ€
    if (confirmed) {
        // å°±å»è§¦å‘é‚£ä¸ªéšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
        document.getElementById('character-card-input').click();
    }
    // å¦‚æœç”¨æˆ·ç‚¹å‡»â€œå–æ¶ˆâ€ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿ
});


        document.getElementById('character-card-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨æˆ‘ä»¬çš„æ€»å¤„ç†å‡½æ•°
                handleCharacterImport(file);
            }
            // æ¸…ç©ºé€‰æ‹©ï¼Œè¿™æ ·ç”¨æˆ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
            event.target.value = null; 
        });
        // â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('phone-screen').addEventListener('click', unlockAudioContext, { once: true });
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('clear-orphaned-data-btn').addEventListener('click', clearOrphanedData);
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 
 stopPetDecayTimer();
    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

exitSelectionMode(); state.activeChatId = null;
// ã€å¿ƒå£°åŠŸèƒ½ã€‘è¿”å›åˆ—è¡¨æ—¶ï¼Œéšè—å¿ƒå½¢æŒ‰é’®
document.getElementById('char-heart-btn').style.display = 'none';
 showScreen('chat-list-screen'); });
            // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
            // ä¸ºæ­Œæ›²å°é¢/æ­Œè¯åŒºåŸŸç»‘å®šç‚¹å‡»åˆ‡æ¢äº‹ä»¶
            document.getElementById('music-display-area').addEventListener('click', () => {
                const displayArea = document.getElementById('music-display-area');
                // ç›´æ¥åˆ‡æ¢ .show-lyrics è¿™ä¸ªç±»ï¼ŒCSSä¼šè‡ªåŠ¨å¤„ç†æ˜¾ç¤º/éšè—
                displayArea.classList.toggle('show-lyrics');
            });
            // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

                        document.getElementById('add-chat-btn').addEventListener('click', async () => { 
                const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—'); 
                if (name && name.trim()) { 
                    const newChatId = 'chat_' + Date.now(); 
                    
                    // â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼
                const newChat = {
                    id: newChatId,
                    name: name.trim(),
                    isGroup: false,
                    isPinned: false,
                    npcLibrary: [], // è§’è‰²ä¸“å±NPCåº“
                    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
                    status: { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false },
                    settings: {
                        aiPersona: 'ä½ æ˜¯è°å‘€ã€‚',
                        myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
                        maxMemory: 10,
                        aiAvatar: defaultAvatar,
                        myAvatar: defaultAvatar,
                        background: '',
                        theme: 'default',
                        fontSize: 13,
                        customCss: '',
                        linkedWorldBookIds: [],
                        aiAvatarLibrary: [],
                        stickerLibrary: [], // ä¸“å±è¡¨æƒ…åº“
                        // === ä»¥ä¸‹æ˜¯æœ¬æ¬¡ä¿®å¤æ–°å¢çš„åˆå§‹åŒ–å±æ€§ ===
                        linkedMemories: [], // ã€ä¿®å¤æ ¸å¿ƒã€‘åˆå§‹åŒ–è®°å¿†äº’é€šæ•°ç»„
                        offlineMode: { enabled: false, prompt: '', style: '', wordCount: 300, presets: [] }, // åˆå§‹åŒ–çº¿ä¸‹æ¨¡å¼
                        timePerceptionEnabled: true, // åˆå§‹åŒ–æ—¶é—´æ„ŸçŸ¥
                        customTime: '', // åˆå§‹åŒ–è‡ªå®šä¹‰æ—¶é—´
                        isCoupleAvatar: false, // åˆå§‹åŒ–æƒ…ä¾£å¤´åƒå¼€å…³
                        coupleAvatarDescription: '', // åˆå§‹åŒ–æƒ…ä¾£å¤´åƒæè¿°
                        weiboProfession: '', // åˆå§‹åŒ–å¾®åšèŒä¸š
                        weiboInstruction: '' // åˆå§‹åŒ–å¾®åšæŒ‡ä»¤
                    },
                    history: [],
                    musicData: { totalTime: 0 },
                    // æ‰‹æœºæ•°æ®ä¹Ÿä¿æŒå®Œæ•´
                    characterPhoneData: {
                        lastGenerated: null, chats: {}, shoppingCart: [], memos: [],
                        browserHistory: [], photoAlbum: [], bank: { balance: 0, transactions: [] },
                        trajectory: [], appUsage: [], diary: []
                    }
                };
// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²


                    state.chats[newChatId] = newChat; 
                    await db.chats.put(newChat); 
                    renderChatList(); 
                } 
            });

            // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘åˆ›å»ºç¾¤èŠæŒ‰é’®ç°åœ¨æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨ â–¼â–¼â–¼
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²                      
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

            audioPlayer.addEventListener('ended', playNext);

            const chatInput = document.getElementById('chat-input');
            // â–¼â–¼â–¼ æ‰¾åˆ° id="send-btn" çš„ click äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('send-btn').addEventListener('click', async () => { 
    const content = chatInput.value.trim(); 
    if (!content || !state.activeChatId) return; 
        // --- â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ä»£ç ã€‘â–¼â–¼â–¼ ---
    try {
        const command = JSON.parse(content);
        // æ£€æŸ¥ï¼šè¿™æ˜¯å¦æ˜¯ä¸€ä¸ªè®©è§’è‰²å‘å¾®åšçš„æŒ‡ä»¤ï¼Ÿ
        if (command && command.type === 'weibo_post') {
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                alert("ä¸èƒ½åœ¨ç¾¤èŠä¸­ä¸ºå•ä¸ªè§’è‰²å‘å¸ƒå¾®åšã€‚");
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæ–°çš„å¾®åšå¸–å­å¯¹è±¡
            const newPost = {
                authorId: chat.id, // å…³é”®ï¼ä½œè€…IDæ˜¯å½“å‰è§’è‰²çš„IDï¼Œè€Œä¸æ˜¯'user'
                authorType: 'char',
                authorNickname: chat.name,
                authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                content: command.content || '',
                timestamp: Date.now(),
                likes: [],
                comments: [],
                baseLikesCount: command.baseLikesCount || 0,
                baseCommentsCount: command.baseCommentsCount || 0
            };

            // å¦‚æœJSONé‡Œæœ‰è·¯äººè¯„è®ºï¼Œå°±è§£æå¹¶æ·»åŠ 
            if (command.comments && typeof command.comments === 'string') {
                newPost.comments = command.comments.split('\n').map(c => {
                    const parts = c.split(/[:ï¼š]/);
                    const commenter = parts.shift() || 'è·¯äºº';
                    const commentText = parts.join(':').trim();
                    return { commentId: 'comment_' + Date.now() + Math.random(), authorNickname: commenter, commentText: commentText };
                }).filter(c => c.commentText);
            }

            await db.weiboPosts.add(newPost);
            
            // åˆ·æ–°â€œå…³æ³¨çš„äººâ€åˆ—è¡¨ï¼Œæ–°å¾®åšå°±ä¼šå‡ºç°äº†ï¼
            await renderFollowingWeiboFeed();

            await showCustomAlert('æ“ä½œæˆåŠŸ', `å·²ä¸º â€œ${chat.name}â€ å‘å¸ƒäº†ä¸€æ¡æ–°å¾®åšï¼`);
            
            chatInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            return; // ç»“æŸå‡½æ•°ï¼Œä¸å†æ‰§è¡Œåé¢çš„ä»£ç 
        }
    } catch (e) {
        // å¦‚æœè§£æJSONå¤±è´¥ï¼Œè¯´æ˜å®ƒä¸æ˜¯æŒ‡ä»¤ï¼Œåªæ˜¯æ™®é€šæ–‡æœ¬ï¼Œå°±è®©ä»£ç ç»§ç»­å¾€ä¸‹èµ°
    }
    // --- â–²â–²â–²ã€ä¿®å¤ä»£ç ç»“æŸã€‘â–²â–²â–² ---
    const chat = state.chats[state.activeChatId]; 
        // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œå¹¶ä¸”ä½ è¢«ç¦è¨€äº†
    if (chat && chat.isGroup && chat.settings.isUserMuted) {
        alert('ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘è¨€ï¼');
        return; // é˜»æ­¢å‘é€
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ·»åŠ  ---
    const msg = { 
        role: 'user', 
        content, 
        timestamp: Date.now() 
    };

    // æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äºå¼•ç”¨å›å¤æ¨¡å¼
    if (currentReplyContext) {
        msg.quote = currentReplyContext; // å°†å¼•ç”¨ä¿¡æ¯é™„åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸Š
    }
    // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---
    
    chat.history.push(msg); 
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    chatInput.value = ''; 
    chatInput.style.height = 'auto'; 
    chatInput.focus(); 
    
    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å‘é€åï¼Œå–æ¶ˆå¼•ç”¨æ¨¡å¼ ---
    cancelReplyMode(); 
});
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ã€ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ save-wallpaper-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    // ä¿å­˜å£çº¸
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    // ä¿å­˜é”å±å£çº¸
    if (newLockscreenWallpaperBase64) {
        state.globalSettings.lockscreenWallpaper = newLockscreenWallpaperBase64;
        changesMade = true;
    }

    // ä¿å­˜å…¨å±€èŠå¤©èƒŒæ™¯
    if (newGlobalBgBase64 === 'REMOVED') { 
        state.globalSettings.globalChatBackground = '';
        changesMade = true;
    } else if (newGlobalBgBase64) { 
        state.globalSettings.globalChatBackground = newGlobalBgBase64;
        changesMade = true;
    }

    // ä¿å­˜å¯†ç 
    const newPassword = document.getElementById('password-set-input').value;
    state.globalSettings.password = newPassword;

    // ä¿å­˜é“ƒå£°
    state.globalSettings.ringtoneUrl = document.getElementById('ringtone-url-input').value.trim();

    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
    // åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸‹é¢è¿™ä¸€è¡Œï¼Œç”¨æ¥ä¿å­˜æ¶ˆæ¯æç¤ºéŸ³çš„URL
    state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
    // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

    const activeThemeSelector = document.getElementById('theme-selector');
    if (activeThemeSelector.value) {
        state.globalSettings.activeThemeId = parseInt(activeThemeSelector.value);
    } else {
        state.globalSettings.activeThemeId = null;
    }
    
    const isLockEnabled = document.getElementById('enable-lock-screen-toggle').checked;
    state.globalSettings.enableLockScreen = isLockEnabled;
    localStorage.setItem('lockScreenEnabled', isLockEnabled);

    state.globalSettings.homeIconWidgetTextColor = document.getElementById('home-icon-widget-text-color-picker').value;
    state.globalSettings.removeHomeFontShadow = document.getElementById('remove-home-font-shadow-toggle').checked;
    saveAppLabels();

    await db.globalSettings.put(state.globalSettings);

    // åº”ç”¨æ‰€æœ‰æ›´æ”¹
    if (changesMade) {
        applyGlobalWallpaper();        
        applyLockscreenWallpaper(); 
        newWallpaperBase64 = null;        
        newLockscreenWallpaperBase64 = null; 
        newGlobalBgBase64 = null; 
    }
    applyAppIcons(); 
    applyAppLabels();
    
    alert('å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
    showScreen('home-screen');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { 

    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const isBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrl.includes(blockedDomain));

if (isBlocked) {
    alert('é”™è¯¯ï¼šè¯¥ API ç«™ç‚¹å·²è¢«ç¦ç”¨ï¼Œæ— æ³•ä½¿ç”¨ã€‚');
    return; // é˜»æ­¢ä¿å­˜
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); 
state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); 
state.apiConfig.model = document.getElementById('model-select').value; 
state.apiConfig.temperature = parseFloat(document.getElementById('temperature-slider').value);
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜ Minimax è®¾ç½®
    state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
    state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();
    state.apiConfig.minimaxSpeechModel = document.getElementById('minimax-speech-model-select').value;
await db.apiConfig.put(state.apiConfig); 

// åœ¨ 'save-api-settings-btn' çš„ click äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨
// await db.apiConfig.put(state.apiConfig); è¿™è¡Œä¹‹å

// â–¼â–¼â–¼ å°†ä¹‹å‰é‚£æ®µä¿å­˜åå°æ´»åŠ¨è®¾ç½®çš„é€»è¾‘ï¼Œæ›¿æ¢ä¸ºä¸‹é¢è¿™ä¸ªå¢å¼ºç‰ˆ â–¼â–¼â–¼

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// åªæœ‰åœ¨ç”¨æˆ·â€œä»å…³åˆ°å¼€â€æ—¶ï¼Œæ‰å¼¹å‡ºè­¦å‘Š
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€é«˜è´¹ç”¨è­¦å‘Šã€‘\n\n" +
        "æ‚¨æ­£åœ¨å¯ç”¨â€œåå°è§’è‰²æ´»åŠ¨â€åŠŸèƒ½ã€‚\n\n" +
        "è¿™ä¼šä½¿æ‚¨çš„AIè§’è‰²ä»¬åœ¨æ‚¨ä¸å’Œä»–ä»¬èŠå¤©æ—¶ï¼Œä¹Ÿèƒ½â€œç‹¬ç«‹æ€è€ƒâ€å¹¶ä¸»åŠ¨ç»™æ‚¨å‘æ¶ˆæ¯æˆ–è¿›è¡Œç¤¾äº¤äº’åŠ¨ï¼Œæå¤§åœ°å¢å¼ºæ²‰æµ¸æ„Ÿã€‚\n\n" +
        "ä½†è¯·æ³¨æ„ï¼š\n" +
        "è¿™ä¼šã€åœ¨åå°è‡ªåŠ¨ã€å®šæœŸåœ°è°ƒç”¨APIã€‘ï¼Œå³ä½¿æ‚¨ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®æ‚¨çš„è§’è‰²æ•°é‡å’Œæ£€æµ‹é—´éš”ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„APIè´¹ç”¨æ˜¾è‘—å¢åŠ ã€‚\n\n" +
        "æ‚¨ç¡®å®šè¦å¼€å¯å—ï¼Ÿ"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ç”¨æˆ·å–æ¶ˆï¼ŒæŠŠå¼€å…³æ‹¨å›å»
        return; // é˜»æ­¢åç»­é€»è¾‘
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// åŠ¨æ€å¯åŠ¨æˆ–åœæ­¢æ¨¡æ‹Ÿå™¨
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
} else {
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

alert('APIè®¾ç½®å·²ä¿å­˜!'); });

                    // gemini å¯†é’¥èšç„¦çš„æ—¶å€™æ˜¾ç¤ºæ˜æ–‡
        const ApiKeyInput = document.getElementById('api-key')
        ApiKeyInput.addEventListener('focus', (e) => {
            e.target.setAttribute('type', 'text')
        })
        ApiKeyInput.addEventListener('blur', (e) => {
            e.target.setAttribute('type', 'password')
        })


        document.getElementById('fetch-models-btn').addEventListener('click', async () => {
            const url = document.getElementById('proxy-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥');
            try {

                let  isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`,isGemini ? undefined : {headers: {'Authorization': `Bearer ${key}`}});
                if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨');
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if(isGemini){
                    models = models.map((model)=>{
                        const parts = model.name.split('/');
                        return {
                            id:parts.length > 1 ? parts[1] : model.name
                        }
                    })
                }
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === state.apiConfig.model) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
            }
        });
        document.getElementById('fetch-minimax-speech-models-btn').addEventListener('click', fetchMinimaxSpeechModels);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦å¯¼å…¥åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('import-world-book-btn').addEventListener('click', () => {
    // ç‚¹å‡»â€œå¯¼å…¥â€æŒ‰é’®æ—¶ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    document.getElementById('world-book-import-input').click();
});

document.getElementById('world-book-import-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨æˆ‘ä»¬çš„æ ¸å¿ƒå¤„ç†å‡½æ•°
        handleImportSillyTavernWorldBook(file);
    }
    // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œè¿™æ ·ç”¨æˆ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
    e.target.value = null; 
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; 

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¿å­˜åˆ†ç±»ID â–¼â–¼â–¼
        const categoryId = document.getElementById('world-book-category-select').value;
        // å¦‚æœé€‰æ‹©äº†â€œæœªåˆ†ç±»â€ï¼Œå­˜å…¥ nullï¼›å¦åˆ™å­˜å…¥æ•°å­—ID
        book.categoryId = categoryId ? parseInt(categoryId) : null; 
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
// â–¼â–¼â–¼ ç¬¬3æ­¥ï¼šç”¨è¿™æ•´å—ã€å…¨æ–°çš„ã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ 'chat-messages' ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    
    const voiceBody = e.target.closest('.voice-message-body');
    if (voiceBody) {
        const bubble = voiceBody.closest('.message-bubble');
        if (!bubble) return;

        // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±çš„è¯­éŸ³ï¼Œåªåˆ‡æ¢æ–‡å­—æ˜¾ç¤ºï¼Œä¸æ’­æ”¾
        if (bubble.classList.contains('user')) {
            toggleVoiceTranscript(bubble);
            return;
        }

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€å·²ä¿®å¤ç‚¹å‡»æ”¶èµ·åŠŸèƒ½ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„AIè¯­éŸ³ç‚¹å‡»å¤„ç†é€»è¾‘ â–¼â–¼â–¼
        // å¦‚æœæ˜¯AIçš„è¯­éŸ³æ¶ˆæ¯
        const chat = state.chats[state.activeChatId];
        if (!chat) return;

        // --- æ ¸å¿ƒé€»è¾‘å¼€å§‹ ---

        // 1. æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³æ¡
        if (isTtsPlaying && currentTtsAudioBubble === bubble) {
            // å¦‚æœæ˜¯ï¼Œåˆ™åœæ­¢æ’­æ”¾å¹¶æ”¶èµ·æ‰€æœ‰å…³è”çš„æ–‡å­—
            stopMinimaxAudio(); 
        } 
        // 2. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯å·²ç»å±•å¼€äº†æ–‡å­—ä½†æ²¡æœ‰æ’­æ”¾çš„è¯­éŸ³æ¡
        else if (bubble.dataset.state === 'expanded') {
            // å¦‚æœæ˜¯ï¼Œåˆ™åªæ”¶èµ·æ–‡å­—ï¼Œä¸å½±å“å…¶ä»–
            toggleVoiceTranscript(bubble);
        }
        // 3. å¦‚æœä»¥ä¸Šéƒ½ä¸æ˜¯ï¼Œè¯´æ˜æ˜¯æƒ³å¼€å§‹æ’­æ”¾æˆ–åªå±•å¼€æ–‡å­—
        else {
            const clickedTimestamp = parseInt(bubble.dataset.timestamp);
            const startIndex = chat.history.findIndex(m => m.timestamp === clickedTimestamp);
            if (startIndex === -1) return;

            // æŸ¥æ‰¾è¿ç»­çš„è¯­éŸ³æ¶ˆæ¯
            const messagesToPlay = findConsecutiveAiVoiceMessages(chat.history, startIndex);
            if (messagesToPlay.length > 0) {
                const bubblesToAnimate = messagesToPlay.map(m => document.querySelector(`.message-bubble[data-timestamp="${m.timestamp}"]`)).filter(Boolean);
                
                // æ£€æŸ¥é…ç½®ï¼Œå†³å®šæ˜¯æ’­æ”¾è¿˜æ˜¯åªæ˜¾ç¤ºæ–‡å­—
                const groupId = state.apiConfig.minimaxGroupId;
                const apiKey = state.apiConfig.minimaxApiKey;
                const voiceId = chat.settings.minimaxVoiceId;

                if (groupId && apiKey && voiceId) {
                    // ã€æ’­æ”¾åˆ†æ”¯ã€‘
                    // å…ˆå±•å¼€æ‰€æœ‰æ–‡å­—
                    bubblesToAnimate.forEach(b => {
                        if (b.dataset.state !== 'expanded') {
                            toggleVoiceTranscript(b);
                        }
                    });
                    // ç„¶åè°ƒç”¨æ’­æ”¾å™¨
                    const combinedText = messagesToPlay.map(m => m.content.trim()).join('ï¼Œ');
                    playMinimaxAudio(combinedText, voiceId, bubblesToAnimate);
                } else {
                    // ã€åªæ˜¾ç¤ºæ–‡å­—åˆ†æ”¯ã€‘
                    // åªå±•å¼€å½“å‰ç‚¹å‡»çš„è¿™ä¸€ä¸ªè¯­éŸ³æ¡çš„æ–‡å­—
                    toggleVoiceTranscript(bubble);
                }
            }
        }
        
        return; // å¤„ç†å®Œè¯­éŸ³åé€€å‡º
    }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²




    // --- ä½ åŸæ¥çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘ ---
    const aiImage = e.target.closest('.ai-generated-image');
    if (aiImage) {
        const description = aiImage.dataset.description;
        if (description) showCustomAlert('ç…§ç‰‡æè¿°', description);
        return;
    }
    const linkCard = e.target.closest('.link-share-card');
    if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        if (!isNaN(timestamp)) {
            openBrowser(timestamp);
        }
    }
    const packetCard = e.target.closest('.red-packet-card');
    if (packetCard) {
        const messageBubble = packetCard.closest('.message-bubble');
        if (messageBubble && messageBubble.dataset.timestamp) {
            const timestamp = parseInt(messageBubble.dataset.timestamp);
            handlePacketClick(timestamp);
        }
    }
    const pollCard = e.target.closest('.poll-card');
    if (pollCard) {
        const timestamp = parseInt(pollCard.dataset.pollTimestamp);
        if (isNaN(timestamp)) return;
        const optionItem = e.target.closest('.poll-option-item');
        if (optionItem && !pollCard.classList.contains('closed')) {
            handleUserVote(timestamp, optionItem.dataset.option);
            return;
        }
        const actionBtn = e.target.closest('.poll-action-btn');
        if (actionBtn) {
            if (pollCard.classList.contains('closed')) {
                showPollResults(timestamp);
            } else {
                endPoll(timestamp);
            }
            return;
        }
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        }
    }
    const card = e.target.closest('.waimai-card');
    if (card) {
        const messageBubble = card.closest('.message-bubble');
        const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));
        if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
            const choice = e.target.dataset.choice;
            if (choice) {
                handleLoversSpaceResponse(invitationMsg.timestamp, choice);
            }
        }
    }
    const repostCard = e.target.closest('.link-share-card[data-post-id]');
    if (repostCard) {
        const postId = parseInt(repostCard.dataset.postId);
        if (!isNaN(postId)) {
            openPost(postId);
        }
    }
    
    // ã€æ–°å¢ã€‘å¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        if(!isNaN(timestamp)) {
            const msg = state.chats[state.activeChatId].history.find(m=>m.timestamp===timestamp);
            if(msg && msg.type === 'share_card') openSharedHistoryViewer(timestamp);
            else if(msg && msg.type === 'share_link') openBrowser(timestamp);
        }
    }
    
    // ã€æ–°å¢ã€‘å¤„ç†å·²æ’¤å›æ¶ˆæ¯çš„ç‚¹å‡»
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (placeholder) {
        const wrapper = placeholder.closest('.message-wrapper');
        const chat = state.chats[state.activeChatId];
        if (chat && wrapper) {
            const timestamp = parseInt(wrapper.dataset.timestamp);
            const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
            if (recalledMsg && recalledMsg.recalledData) {
                let originalContentText = '';
                const recalled = recalledMsg.recalledData;
                if (recalled.originalType === 'text') {
                    originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                } else {
                    originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
                }
                showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
            }
        }
    }
        // â–¼â–¼â–¼ åœ¨è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å—å†…ï¼Œæ·»åŠ ä¸‹é¢è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
    const chatCard = e.target.closest('.dating-summary-chat-card');
    if (chatCard && chatCard.dataset.summaryPayload) {
        try {
            // è¯»å–å¹¶è§£æå­˜å‚¨åœ¨ data-* å±æ€§ä¸­çš„å¡ç‰‡æ•°æ®
            const payloadString = chatCard.dataset.summaryPayload.replace(/&apos;/g, "'").replace(/"/g, '&quot;');
            const payload = JSON.parse(payloadString);
            // è°ƒç”¨æˆ‘ä»¬æ–°å†™çš„å‡½æ•°ï¼Œæ‰“å¼€è¯¦æƒ…å¡ç‰‡
            reopenDatingSummary(payload);
        } catch (error) {
            console.error("è§£æåˆ†äº«çš„çº¦ä¼šè®°å½•å¤±è´¥:", error);
            alert("æ— æ³•æ‰“å¼€è¿™ä¸ªçº¦ä¼šè®°å½•ã€‚");
        }
    }
    // â–²â–²â–² æ–°ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å®Œæ•´ã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ—§çš„ chat-settings-btn ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;
    document.getElementById('offline-mode-section').style.display = isGroup ? 'none' : 'block';
document.getElementById('couple-avatar-group').style.display = isGroup ? 'none' : 'block';
document.getElementById('streak-settings-section').style.display = isGroup ? 'none' : 'block';
// â–¼â–¼â–¼ åœ¨ const chat = ... çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
// è®¡ç®—æ€»æ¶ˆæ¯æ¡æ•°å¹¶æ›´æ–°æ˜¾ç¤º
const totalMessages = chat.history.length;
const countDisplay = document.getElementById('total-message-count-display');
if (countDisplay) {
    countDisplay.textContent = `${totalMessages} æ¡`;
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // è®¡ç®—å¹¶æ˜¾ç¤ºä¸Šä¸‹æ–‡Tokenæ•°
    const contextTextForToken = await getContextForTokenCalculation(state.activeChatId);
    const tokenCount = calculateTokenCount(contextTextForToken);
    const tokenDisplay = document.getElementById('context-token-count-display');
    if (tokenDisplay) {
        tokenDisplay.textContent = tokenCount.toLocaleString(); // toLocaleString() ä¼šç»™æ•°å­—åŠ ä¸Šåƒä½åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ "1,234"
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    // --- ç»Ÿä¸€æ˜¾ç¤º/éšè—æ§ä»¶ ---
    // â–¼â–¼â–¼ åœ¨ chat-settings-btn çš„ click äº‹ä»¶ä¸­ï¼Œç²˜è´´è¿™æ®µä»£ç  â–¼â–¼â–¼
const videoCallSettingsGroup = document.getElementById('video-call-settings-group');
const visualCallSwitch = document.getElementById('visual-video-call-switch');
const imageUploadsDiv = document.getElementById('video-call-image-uploads');
// --- åŠ è½½èŠå¤©æ€»ç»“è®¾ç½® ---
const summarySettings = chat.settings.summary || {};
const summaryToggle = document.getElementById('summary-toggle');
const summaryDetails = document.getElementById('summary-details-container');

summaryToggle.checked = summarySettings.enabled || false;
summaryDetails.style.display = summaryToggle.checked ? 'block' : 'none';

document.querySelector(`input[name="summary-mode"][value="${summarySettings.mode || 'auto'}"]`).checked = true;
document.getElementById('summary-count-input').value = summarySettings.count || 20;
document.getElementById('summary-prompt-input').value = summarySettings.prompt || 'è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚';

// ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
summaryToggle.onchange = () => {
    summaryDetails.style.display = summaryToggle.checked ? 'block' : 'none';
};
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
if (isGroup) {
    videoCallSettingsGroup.style.display = 'none'; // ç¾¤èŠä¸æ”¯æŒï¼Œéšè—æ•´ä¸ªè®¾ç½®åŒº
} else {
    videoCallSettingsGroup.style.display = 'block'; // å•èŠæ˜¾ç¤º
    
    // åŠ è½½å½“å‰è®¾ç½®
    visualCallSwitch.checked = chat.settings.visualVideoCallEnabled || false;
    imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    document.getElementById('char-video-image-preview').src = chat.settings.charVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
    document.getElementById('user-video-image-preview').src = chat.settings.userVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';

    // ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
    visualCallSwitch.onchange = () => {
        imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    };
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
    
    // --- çº¿ä¸‹æ¨¡å¼UIæ¸²æŸ“ ---
    const offlineModeSettings = chat.settings.offlineMode || { enabled: false, presets: [] }; // å®‰å…¨è·å–
    const offlineToggle = document.getElementById('offline-mode-toggle');
    const offlineDetails = document.getElementById('offline-mode-details');

    // 1. è®¾ç½®å¼€å…³çŠ¶æ€å¹¶ç»‘å®šäº‹ä»¶
    offlineToggle.checked = offlineModeSettings.enabled;
    offlineDetails.style.display = offlineToggle.checked ? 'block' : 'none';
    offlineToggle.onchange = () => {
        offlineDetails.style.display = offlineToggle.checked ? 'block' : 'none';
    };

    // 2. å¡«å……è¾“å…¥æ¡†
    document.getElementById('offline-prompt-input').value = offlineModeSettings.prompt || '';
    document.getElementById('offline-style-input').value = offlineModeSettings.style || '';
    document.getElementById('offline-word-count-input').value = offlineModeSettings.wordCount || 300;

    // 3. æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰æ¡†
    renderOfflinePresetsSelector();

    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ°”æ³¡å¯¼å…¥/å¯¼å‡ºæŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('export-bubble-preset-btn').addEventListener('click', exportSelectedBubblePreset);

document.getElementById('import-bubble-preset-btn').addEventListener('click', () => {
    // ç‚¹å‡»â€œå¯¼å…¥â€æŒ‰é’®æ—¶ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    document.getElementById('import-bubble-preset-input').click();
});

document.getElementById('import-bubble-preset-input').addEventListener('change', (e) => {
    // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨å¯¼å…¥å‡½æ•°å¤„ç†
    importBubblePreset(e.target.files[0]);
    e.target.value = null; // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œæ–¹ä¾¿ä¸‹æ¬¡é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
});
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// --- å…¨æ–°è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç»‘å®š (V2 ä¿®æ­£ç‰ˆ) ---

// ç»‘å®šæ–°ç•Œé¢çš„æŒ‚æ–­æŒ‰é’®
document.getElementById('hang-up-btn-visual').addEventListener('click', endVideoCall);

// ã€æ–°å¢ã€‘ç»‘å®šæ–°ç•Œé¢çš„å‘è¨€æŒ‰é’®
document.getElementById('user-speak-btn-visual').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;
    const userInput = await showCustomPrompt('ä½ è¯´', 'è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...');
    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});

// ç»‘å®šåˆ‡æ¢é•œå¤´æŒ‰é’® (ä¹Ÿæ˜¯å°çª—æœ¬èº«)
document.getElementById('switch-camera-btn').addEventListener('click', switchVideoViews);
document.getElementById('video-pip-view').addEventListener('click', switchVideoViews);

// ã€ä¿®æ­£ã€‘ç»‘å®šä¸¤ä¸ªç•Œé¢çš„é‡rollæŒ‰é’®
document.getElementById('reroll-call-btn').addEventListener('click', handleVideoCallReroll);
document.getElementById('reroll-call-btn-text').addEventListener('click', handleVideoCallReroll);

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('minimax-voice-id-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
    document.getElementById('npc-library-group').style.display = isGroup ? 'none' : 'block';
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
            // â–¼â–¼â–¼ ç¬¬2æ­¥ ç¬¬1å¤„ä¿®æ”¹ï¼ˆæ–°å¢ä»£ç ï¼‰ â–¼â–¼â–¼
        // ã€ä¿®æ”¹ã€‘æ ¹æ®æ˜¯å¦ä¸ºå•èŠæˆ–ç¾¤èŠï¼Œæ˜¾ç¤ºè¡¨æƒ…ç®¡ç†æŒ‰é’®
        const charStickerGroup = document.getElementById('char-sticker-group');
        if (charStickerGroup) {
            // ç°åœ¨æ— è®ºæ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œè¿™ä¸ªæŒ‰é’®éƒ½ä¼šæ˜¾ç¤º
            charStickerGroup.style.display = 'block';
        }

// ã€æ ¸å¿ƒæ–°å¢ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—å¾®åšè®¾ç½®
document.getElementById('weibo-profession-group').style.display = isGroup ? 'none' : 'block';
document.getElementById('weibo-instruction-group').style.display = isGroup ? 'none' : 'block';
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—â€œå¥½å‹åˆ†ç»„â€åŒºåŸŸ
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- åŠ è½½è¡¨å•æ•°æ® ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šåŠŸèƒ½ - UIæ¸²æŸ“é€»è¾‘ (V2 - å¸¦å¤´åƒç‰ˆ) â–¼â–¼â–¼
const memoryLinkSelectBox = document.querySelector('#memory-link-multiselect .select-box');
const memoryLinkCheckboxesContainer = document.getElementById('memory-link-checkboxes-container');
memoryLinkCheckboxesContainer.innerHTML = ''; // æ¸…ç©ºæ—§é€‰é¡¹

// 1. è·å–é™¤äº†å½“å‰èŠå¤©ä»¥å¤–çš„æ‰€æœ‰èŠå¤©
const otherChats = Object.values(state.chats).filter(c => c.id !== chat.id);

// 2. åŠ¨æ€åˆ›å»ºå¸¦å¤´åƒçš„å¤é€‰æ¡†
otherChats.forEach(otherChat => {
    const existingLink = chat.settings.linkedMemories.find(link => link.chatId === otherChat.id);
    const isChecked = existingLink ? 'checked' : '';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ®æ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Œè·å–æ­£ç¡®çš„å¤´åƒURL
    const avatarUrl = otherChat.isGroup 
        ? (otherChat.settings.groupAvatar || defaultGroupAvatar) 
        : (otherChat.settings.aiAvatar || defaultAvatar);

    const label = document.createElement('label');
    
    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ„å»ºåŒ…å« <img> æ ‡ç­¾çš„æ–°HTMLç»“æ„
    label.innerHTML = `
        <input type="checkbox" value="${otherChat.id}" ${isChecked}>
        <img src="${avatarUrl}" class="avatar-preview">
        <span>${otherChat.name} ${otherChat.isGroup ? '(ç¾¤èŠ)' : ''}</span>
    `;
    memoryLinkCheckboxesContainer.appendChild(label);
});


// 3. æ›´æ–°å·²é€‰æ•°é‡çš„æ˜¾ç¤ºå’Œè®°å¿†æ¡æ•°
function updateMemoryLinkDisplay() {
    const checkedBoxes = memoryLinkCheckboxesContainer.querySelectorAll('input:checked');
    const displayText = memoryLinkSelectBox.querySelector('.selected-options-text');
    if (checkedBoxes.length === 0) {
        displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --';
    } else {
        displayText.textContent = `å·²é“¾æ¥ ${checkedBoxes.length} ä¸ªèŠå¤©`;
    }
}

    // 4. åŠ è½½è®°å¿†æ¡æ•°è®¾ç½®
    // æˆ‘ä»¬ç°åœ¨ä»ä¸€ä¸ªç‹¬ç«‹çš„è®¾ç½®é¡¹åŠ è½½ï¼Œç¡®ä¿å®ƒæ€»èƒ½è¢«æ­£ç¡®è¯»å–
    document.getElementById('link-memory-depth-input').value = chat.settings.linkMemoryDepth || 5;


// 5. ç»‘å®šäº‹ä»¶
updateMemoryLinkDisplay(); // åˆå§‹åŒ–æ˜¾ç¤º
memoryLinkCheckboxesContainer.addEventListener('change', updateMemoryLinkDisplay);
// ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§æ¥é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
const newSelectBox = memoryLinkSelectBox.cloneNode(true);
memoryLinkSelectBox.parentNode.replaceChild(newSelectBox, memoryLinkSelectBox);
newSelectBox.addEventListener('click', (e) => {
    e.stopPropagation();
    memoryLinkCheckboxesContainer.classList.toggle('visible');
    newSelectBox.classList.toggle('expanded');
});
// â–²â–²â–² è®°å¿†äº’é€šUIé€»è¾‘ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ åœ¨ max-memory èµ‹å€¼çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´è¿™ä¸€æ•´å—ä»£ç  â–¼â–¼â–¼
const timeToggle = document.getElementById('time-perception-toggle');
const customTimeContainer = document.getElementById('custom-time-container');
const customTimeInput = document.getElementById('custom-time-input');

// å¦‚æœæ˜¯æ—§èŠå¤©ï¼Œç»™ä¸€ä¸ªé»˜è®¤å€¼ trueï¼ˆå¼€å¯ï¼‰
const isTimeEnabled = chat.settings.timePerceptionEnabled ?? true; 
timeToggle.checked = isTimeEnabled;
customTimeInput.value = chat.settings.customTime || '';

// æ ¹æ®å¼€å…³çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰æ—¶é—´è¾“å…¥æ¡†
customTimeContainer.style.display = isTimeEnabled ? 'none' : 'block';
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
        // åŠ è½½ç¾¤èŠåå°æ´»åŠ¨è®¾ç½®
const groupActivityGroup = document.getElementById('group-background-activity-group');
const groupActivitySwitch = document.getElementById('group-background-activity-switch');
const groupIntervalSettings = document.getElementById('group-background-interval-settings');
const groupIntervalInput = document.getElementById('group-background-interval-input');

groupActivityGroup.style.display = 'block'; // æ˜¾ç¤ºè®¾ç½®åŒºåŸŸ
const bgSettings = chat.settings.backgroundActivity || { enabled: false, interval: 120 };
groupActivitySwitch.checked = bgSettings.enabled;
groupIntervalInput.value = bgSettings.interval;
groupIntervalSettings.style.display = bgSettings.enabled ? 'block' : 'none';

// ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
groupActivitySwitch.onchange = () => {
    groupIntervalSettings.style.display = groupActivitySwitch.checked ? 'block' : 'none';
};
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŠ è½½å½“å‰è§’è‰²çš„å¾®åšèŒä¸šå’ŒæŒ‡ä»¤
document.getElementById('weibo-profession-input').value = chat.settings.weiboProfession || '';
document.getElementById('weibo-instruction-input').value = chat.settings.weiboInstruction || '';
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('minimax-voice-id-input').value = chat.settings.minimaxVoiceId || '';
        // â–¼â–¼â–¼ Part C.1: åœ¨è¿™é‡Œç²˜è´´ã€åŠ è½½ã€‘æƒ…ä¾£å¤´åƒè®¾ç½®çš„ä»£ç  â–¼â–¼â–¼
const coupleAvatarToggle = document.getElementById('couple-avatar-toggle');
const coupleAvatarDescContainer = document.getElementById('couple-avatar-desc-container');
const coupleAvatarDescInput = document.getElementById('couple-avatar-description');

coupleAvatarToggle.checked = chat.settings.isCoupleAvatar || false;
coupleAvatarDescInput.value = chat.settings.coupleAvatarDescription || '';

coupleAvatarDescContainer.style.display = coupleAvatarToggle.checked ? 'block' : 'none';

coupleAvatarToggle.onchange = () => {
    coupleAvatarDescContainer.style.display = coupleAvatarToggle.checked ? 'block' : 'none';
};
// â–²â–²â–² åŠ è½½é€»è¾‘ç»“æŸ â–²â–²â–²
        document.getElementById('group-background-activity-group').style.display = 'none';
        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¦‚æœæ˜¯å•èŠï¼Œå°±åŠ è½½åˆ†ç»„åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">æœªåˆ†ç»„</option>'; // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤é€‰é¡¹
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // å¦‚æœå½“å‰å¥½å‹å·²ç»æœ‰åˆ†ç»„ï¼Œå°±é»˜è®¤é€‰ä¸­å®ƒ
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å…¨æ–°é€»è¾‘ã€‘æ›¿æ¢æ‰åŸæ¥ç®€å•çš„ forEach å¾ªç¯ â–¼â–¼â–¼

const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
worldBookCheckboxesContainer.innerHTML = '';
const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

// 1. è·å–æ‰€æœ‰åˆ†ç±»å’Œä¸–ç•Œä¹¦
const categories = await db.worldBookCategories.toArray();
const books = state.worldBooks;

// ã€æ ¸å¿ƒæ”¹é€ ã€‘å¦‚æœå­˜åœ¨æœªåˆ†ç±»çš„ä¹¦ç±ï¼Œå°±åˆ›å»ºä¸€ä¸ªâ€œè™šæ‹Ÿåˆ†ç±»â€
const hasUncategorized = books.some(book => !book.categoryId);
if (hasUncategorized) {
    categories.push({ id: 'uncategorized', name: 'æœªåˆ†ç±»' });
}

// 2. å°†ä¹¦ç±æŒ‰åˆ†ç±»IDè¿›è¡Œåˆ†ç»„
const booksByCategoryId = books.reduce((acc, book) => {
    const categoryId = book.categoryId || 'uncategorized';
    if (!acc[categoryId]) {
        acc[categoryId] = [];
    }
    acc[categoryId].push(book);
    return acc;
}, {});

// 3. éå†åˆ†ç±»ï¼Œåˆ›å»ºå¸¦æŠ˜å åŠŸèƒ½çš„åˆ—è¡¨
categories.forEach(category => {
    const booksInCategory = booksByCategoryId[category.id] || [];
    if (booksInCategory.length > 0) {
        const allInCategoryChecked = booksInCategory.every(book => linkedIds.has(book.id));
        
        const header = document.createElement('div');
        header.className = 'wb-category-header';
        header.innerHTML = `
            <span class="arrow">â–¼</span>
            <input type="checkbox" class="wb-category-checkbox" data-category-id="${category.id}" ${allInCategoryChecked ? 'checked' : ''}>
            <span>${category.name}</span>
        `;
        
        const bookContainer = document.createElement('div');
        bookContainer.className = 'wb-book-container';
        bookContainer.dataset.containerFor = category.id;

        booksInCategory.forEach(book => {
            const isChecked = linkedIds.has(book.id);
            const label = document.createElement('label');
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ç»™ä¹¦ååŒ…ä¸€ä¸ªspanï¼Œæ–¹ä¾¿CSSåšçœç•¥å·å¤„ç†
            label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${book.id}" data-parent-category="${category.id}" ${isChecked ? 'checked' : ''}> <span class="wb-book-name">${book.name}</span>`;
            bookContainer.appendChild(label);
        });

        // é»˜è®¤å°†æ‰€æœ‰æ–‡ä»¶å¤¹è®¾ç½®ä¸ºæŠ˜å çŠ¶æ€ï¼Œä¿æŒç•Œé¢æ•´æ´
        header.classList.add('collapsed');
        bookContainer.classList.add('collapsed');

        worldBookCheckboxesContainer.appendChild(header);
        worldBookCheckboxesContainer.appendChild(bookContainer);
    }
});

updateWorldBookSelectionDisplay(); // æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ updateWorldBookSelectionDisplay(); çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼


    // åŠ è½½å¹¶æ›´æ–°æ‰€æœ‰é¢„è§ˆç›¸å…³æ§ä»¶
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ç«èŠ±åŠ è½½é€»è¾‘ â–¼â–¼â–¼
// --- åŠ è½½ç«èŠ±è®¾ç½® ---
const streakSettings = chat.settings.streak || { enabled: false, initialDays: 0, extinguishThreshold: 1 };
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// --- ã€å…¨æ–°ã€‘åŠ è½½è‡ªå®šä¹‰ç«èŠ±å›¾æ ‡å’Œé¢œè‰²è®¾ç½® ---
document.getElementById('streak-lit-icon-url').value = streakSettings.litIconUrl || '';
document.getElementById('streak-extinguished-icon-url').value = streakSettings.extinguishedIconUrl || '';
document.getElementById('streak-font-color-picker').value = streakSettings.fontColor || '#ff6f00'; // é»˜è®¤æ©™è‰²
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
const streakToggle = document.getElementById('streak-enabled-toggle');
const streakDetails = document.getElementById('streak-details-container');
const initialDaysInput = document.getElementById('streak-initial-days-input');
const thresholdSelect = document.getElementById('streak-extinguish-threshold-select');

streakToggle.checked = streakSettings.enabled;
streakDetails.style.display = streakSettings.enabled ? 'block' : 'none';
initialDaysInput.value = streakSettings.initialDays || 0;
thresholdSelect.value = streakSettings.extinguishThreshold || 1;

// ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
streakToggle.onchange = () => {
    streakDetails.style.display = streakToggle.checked ? 'block' : 'none';
};
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 

// ã€è¿™ä¸‰è¡Œå°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„ï¼Œç°åœ¨å·²ç»æ”¾åœ¨æ­£ç¡®çš„ä½ç½®äº†ã€‘
renderBubblePresetSelector();
document.getElementById('bubble-style-preset-select').addEventListener('change', handlePresetSelectChange);
document.getElementById('manage-bubble-presets-btn').addEventListener('click', openBubblePresetManager);
    document.getElementById('chat-settings-modal').classList.add('visible');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
        // æ˜¾ç¤ºçš„æ˜¯ groupNickname
        div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`; 
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}

// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢ä½ æ—§çš„ openMemberEditor å‡½æ•° â–¼â–¼â–¼
function openMemberEditor(memberId) { 
    editingMemberId = memberId; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === memberId); 
    if (!member) return;

    if (typeof member.isMuted === 'undefined') {
        member.isMuted = false; // ä¸ºæ—§æ•°æ®å…¼å®¹
    }
    
    document.getElementById('member-name-input').value = member.groupNickname; 
    document.getElementById('member-persona-input').value = member.persona; 
    document.getElementById('member-avatar-preview').src = member.avatar; 

    // â˜…â˜…â˜… æˆ‘ä»¬åœ¨è¿™é‡Œä¸ºæ–°æŒ‰é’®ç»‘å®šäº†ç‚¹å‡»äº‹ä»¶ â˜…â˜…â˜…
    const changeFrameBtn = document.getElementById('member-editor-change-frame-btn');
    const newChangeFrameBtn = changeFrameBtn.cloneNode(true);
    changeFrameBtn.parentNode.replaceChild(newChangeFrameBtn, changeFrameBtn);
    
    newChangeFrameBtn.addEventListener('click', () => {
        // è°ƒç”¨å¤´åƒæ¡†é€‰æ‹©å™¨ï¼Œå¹¶å‘Šè¯‰å®ƒæˆ‘ä»¬æ­£åœ¨ä¸º'member'ç±»å‹çš„æˆå‘˜ï¼ˆä¹Ÿå°±æ˜¯NPCï¼‰è®¾ç½®å¤´åƒæ¡†
        openFrameSelectorModal('member', memberId);
    });
    // â˜…â˜…â˜… æ·»åŠ ç»“æŸ â˜…â˜…â˜…

    document.getElementById('member-settings-modal').classList.add('visible'); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { 
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    
    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
        return;
    }
    member.groupNickname = newNickname; // åªä¿®æ”¹ç¾¤æ˜µç§°
    member.persona = document.getElementById('member-persona-input').value; 
    member.avatar = document.getElementById('member-avatar-preview').src; 
    
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
});
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼');
    chat.name = newName;
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®°å¿†äº’é€šåŠŸèƒ½ - ä¿å­˜é€»è¾‘ â–¼â–¼â–¼
    const linkedMemoryCheckboxes = document.querySelectorAll('#memory-link-checkboxes-container input:checked');
    const memoryDepth = parseInt(document.getElementById('link-memory-depth-input').value) || 5;

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢è¿™ä¸€è¡Œ â–¼â–¼â–¼
    chat.settings.linkMemoryDepth = memoryDepth; // ç‹¬ç«‹ä¿å­˜è®°å¿†æ¡æ•°è®¾ç½®
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    chat.settings.linkedMemories = Array.from(linkedMemoryCheckboxes).map(checkbox => ({
        chatId: checkbox.value,
        depth: memoryDepth // å¯¹æ‰€æœ‰é€‰ä¸­çš„é“¾æ¥åº”ç”¨ç›¸åŒçš„æ·±åº¦
    }));
    // â–²â–²â–² ä¿å­˜é€»è¾‘ç»“æŸ â–²â–²â–²


    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input.wb-book-checkbox:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
        // ä¿å­˜ç¾¤èŠåå°æ´»åŠ¨è®¾ç½®
const groupActivityEnabled = document.getElementById('group-background-activity-switch').checked;
const groupActivityInterval = parseInt(document.getElementById('group-background-interval-input').value) || 120;

// ç¡®ä¿ lastActivityTimestamp å­—æ®µå­˜åœ¨
const lastTimestamp = chat.settings.backgroundActivity ? chat.settings.backgroundActivity.lastActivityTimestamp : 0;

chat.settings.backgroundActivity = {
    enabled: groupActivityEnabled,
    interval: groupActivityInterval,
    lastActivityTimestamp: lastTimestamp // ä¿ç•™ä¸Šæ¬¡çš„æ—¶é—´æˆ³
};

    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        chat.settings.minimaxVoiceId = document.getElementById('minimax-voice-id-input').value.trim();
        // â–¼â–¼â–¼ Part C.2: åœ¨è¿™é‡Œç²˜è´´ã€ä¿å­˜ã€‘æƒ…ä¾£å¤´åƒè®¾ç½®çš„ä»£ç  â–¼â–¼â–¼
chat.settings.isCoupleAvatar = document.getElementById('couple-avatar-toggle').checked;
chat.settings.coupleAvatarDescription = document.getElementById('couple-avatar-description').value.trim();
// â–²â–²â–² ä¿å­˜é€»è¾‘ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ save-chat-settings-btn çš„ click äº‹ä»¶çš„ else å—å†…ï¼Œç²˜è´´è¿™æ®µä»£ç  â–¼â–¼â–¼
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä»è¾“å…¥æ¡†è¯»å–å€¼å¹¶ä¿å­˜
    chat.settings.weiboProfession = document.getElementById('weibo-profession-input').value.trim();
    chat.settings.weiboInstruction = document.getElementById('weibo-instruction-input').value.trim();
// ä¿å­˜è§†é¢‘é€šè¯è®¾ç½®
chat.settings.visualVideoCallEnabled = document.getElementById('visual-video-call-switch').checked;
chat.settings.charVideoImage = document.getElementById('char-video-image-preview').src;
chat.settings.userVideoImage = document.getElementById('user-video-image-preview').src;
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    // â–¼â–¼â–¼ åœ¨ chat.settings.maxMemory = ... çš„ä¸‹ä¸€è¡Œæ·»åŠ  â–¼â–¼â–¼
chat.settings.timePerceptionEnabled = document.getElementById('time-perception-toggle').checked;
chat.settings.customTime = document.getElementById('custom-time-input').value;
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    // --- ä¿å­˜çº¿ä¸‹æ¨¡å¼è®¾ç½® ---
    if (!chat.settings.offlineMode) chat.settings.offlineMode = {}; // åˆå§‹åŒ–
    chat.settings.offlineMode.enabled = document.getElementById('offline-mode-toggle').checked;
    chat.settings.offlineMode.prompt = document.getElementById('offline-prompt-input').value.trim();
    chat.settings.offlineMode.style = document.getElementById('offline-style-input').value.trim();
    chat.settings.offlineMode.wordCount = parseInt(document.getElementById('offline-word-count-input').value) || 300;
    // presets çš„æ•°æ®åœ¨ç®¡ç†å‡½æ•°ä¸­ç›´æ¥æ“ä½œï¼Œè¿™é‡Œæ— éœ€ä¿å­˜
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
// --- ä¿å­˜èŠå¤©æ€»ç»“è®¾ç½® ---
if (!chat.settings.summary) chat.settings.summary = {}; // åˆå§‹åŒ–
chat.settings.summary.enabled = document.getElementById('summary-toggle').checked;
chat.settings.summary.mode = document.querySelector('input[name="summary-mode"]:checked').value;
chat.settings.summary.count = parseInt(document.getElementById('summary-count-input').value) || 20;
chat.settings.summary.prompt = document.getElementById('summary-prompt-input').value.trim();
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ç«èŠ±ä¿å­˜é€»è¾‘ â–¼â–¼â–¼
// --- ä¿å­˜ç«èŠ±è®¾ç½® ---
const isStreakEnabled = document.getElementById('streak-enabled-toggle').checked;
const newInitialDays = parseInt(document.getElementById('streak-initial-days-input').value) || 0;
const newThreshold = parseInt(document.getElementById('streak-extinguish-threshold-select').value);

const oldStreak = chat.settings.streak || {};

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²æ·»åŠ æ–°åŠŸèƒ½ã€‘çš„ä»£ç æ›¿æ¢ â–¼â–¼â–¼
if (isStreakEnabled) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡å¼€å¯ï¼Œæˆ–è€…åˆå§‹å¤©æ•°è¢«ä¿®æ”¹äº†
    if (!oldStreak.enabled || oldStreak.initialDays !== newInitialDays) {
        // å¦‚æœæ˜¯ï¼Œå°±é‡ç½®å½“å‰å¤©æ•°ä¸ºæ–°çš„åˆå§‹å¤©æ•°
        chat.settings.streak = {
            enabled: true,
            initialDays: newInitialDays,
            currentDays: newInitialDays,
            extinguishThreshold: newThreshold,
            lastInteractionDate: null,
            // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡Œä¿å­˜æˆ‘ä»¬çš„æ–°è®¾ç½® â˜…â˜…â˜…
            litIconUrl: document.getElementById('streak-lit-icon-url').value.trim(),
            extinguishedIconUrl: document.getElementById('streak-extinguished-icon-url').value.trim(),
            fontColor: document.getElementById('streak-font-color-picker').value
        };
    } else {
        // å¦‚æœåªæ˜¯æ™®é€šä¿å­˜ï¼Œåªæ›´æ–°å¼€å…³çŠ¶æ€å’Œç†„ç­è§„åˆ™ä»¥åŠæ–°è®¾ç½®
        chat.settings.streak.enabled = true;
        chat.settings.streak.extinguishThreshold = newThreshold;
        // â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡Œä¿å­˜æˆ‘ä»¬çš„æ–°è®¾ç½® â˜…â˜…â˜…
        chat.settings.streak.litIconUrl = document.getElementById('streak-lit-icon-url').value.trim();
        chat.settings.streak.extinguishedIconUrl = document.getElementById('streak-extinguished-icon-url').value.trim();
        chat.settings.streak.fontColor = document.getElementById('streak-font-color-picker').value;
        // ä¿æŒ currentDays å’Œ lastInteractionDate ä¸å˜
    }
} else {
    // å¦‚æœç”¨æˆ·å…³é—­äº†åŠŸèƒ½ï¼Œå°±é‡ç½®æ‰€æœ‰è®¾ç½®
    chat.settings.streak = {
        enabled: false, initialDays: 0, currentDays: 0, extinguishThreshold: 1, lastInteractionDate: null,
        litIconUrl: '', extinguishedIconUrl: '', fontColor: '#ff6f00' // åŒæ—¶é‡ç½®æ–°è®¾ç½®
    };
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// å¯¼å‡ºèŠå¤©è®°å½•æŒ‰é’®
document.getElementById('export-chat-history-btn').addEventListener('click', exportChatHistory);

// â€œå¯¼å…¥èŠå¤©è®°å½•â€è¿™ä¸ªå¯è§çš„æŒ‰é’®
document.getElementById('import-chat-history-btn').addEventListener('click', () => {
    // ç‚¹å‡»å®ƒæ—¶ï¼Œæˆ‘ä»¬å»è§¦å‘é‚£ä¸ªéšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    document.getElementById('import-chat-history-input').click();
});

// éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
document.getElementById('import-chat-history-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        importChatHistory(file);
    }
    // æ¯æ¬¡é€‰æ‹©åæ¸…ç©ºï¼Œè¿™æ ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
    event.target.value = null; 
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ·»åŠ è¿™ä¸¤è¡Œ â–¼â–¼â–¼
setupFileUpload('char-video-image-input', (base64) => document.getElementById('char-video-image-preview').src = base64);
setupFileUpload('user-video-image-input', (base64) => document.getElementById('user-video-image-preview').src = base64);
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            // â–¼â–¼â–¼ å°†åŸæ¥çš„ add-sticker-btn äº‹ä»¶ç›‘å¬å™¨æ›¿æ¢ä¸ºä¸‹é¢è¿™è¡Œ â–¼â–¼â–¼
document.getElementById('add-sticker-btn').addEventListener('click', openBulkAddStickersModal);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());

            // â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€æ”¯æŒå¤šé€‰ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ sticker-upload-input äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('sticker-upload-input').addEventListener('change', async (event) => {
    const files = event.target.files;
    if (!files.length) return;

    const newStickers = [];
    let canceled = false;

    // ä½¿ç”¨ for...of å¾ªç¯æ¥é€ä¸ªå¤„ç†é€‰ä¸­çš„æ–‡ä»¶
    for (const file of files) {
        if (canceled) break; // å¦‚æœç”¨æˆ·ä¸­é€”å–æ¶ˆäº†ï¼Œå°±è·³å‡ºå¾ªç¯

        // ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„æœ¬åœ°é¢„è§ˆURL
        const previewUrl = URL.createObjectURL(file);
        
        // å¼¹å‡ºå¸¦å›¾ç‰‡é¢„è§ˆçš„å‘½åæ¡†
        const name = await showCustomPrompt(
            `ä¸ºè¡¨æƒ…å‘½å (${newStickers.length + 1}/${files.length})`,
            "è¯·è¾“å…¥è¡¨æƒ…åç§°",
            file.name.replace(/\.[^/.]+$/, ""), // é»˜è®¤ä½¿ç”¨æ–‡ä»¶åä½œä¸ºåå­—
            'text',
            // è¿™æ˜¯ showCustomPrompt çš„ä¸€ä¸ªéšè—åŠŸèƒ½ï¼Œå¯ä»¥æ’å…¥é¢å¤–çš„HTML
            `<img src="${previewUrl}" style="max-width: 100px; max-height: 100px; margin-bottom: 10px; border-radius: 8px;">`
        );
        
        // é‡Šæ”¾ä¸´æ—¶çš„é¢„è§ˆURLï¼Œé¿å…å†…å­˜æ³„æ¼
        URL.revokeObjectURL(previewUrl);
        
        if (name && name.trim()) {
            // ç”¨æˆ·ç¡®è®¤å‘½åï¼Œè¯»å–æ–‡ä»¶å†…å®¹å¹¶å‡†å¤‡ä¿å­˜
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            
            newStickers.push({
                id: 'sticker_' + (Date.now() + newStickers.length),
                url: base64Url,
                name: name.trim()
            });
        } else if (name === null) {
            // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€
            const confirmCancel = await showCustomConfirm("ç¡®è®¤å–æ¶ˆ", "ç¡®å®šè¦å–æ¶ˆå‰©ä½™è¡¨æƒ…çš„ä¸Šä¼ å—ï¼Ÿ");
            if (confirmCancel) {
                canceled = true;
            }
        } else {
            alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼");
        }
    }
    
    // å¾ªç¯ç»“æŸåï¼Œå¦‚æœæ”¶é›†åˆ°äº†æ–°è¡¨æƒ…ï¼Œå°±æ‰¹é‡æ·»åŠ åˆ°æ•°æ®åº“
    if (newStickers.length > 0) {
        await db.userStickers.bulkAdd(newStickers);
        state.userStickers.push(...newStickers);
        renderStickerPanel();
        await showCustomAlert("ä¸Šä¼ æˆåŠŸ", `å·²æˆåŠŸæ·»åŠ  ${newStickers.length} ä¸ªæ–°è¡¨æƒ…ï¼`);
    }

    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨çš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
    event.target.value = null;
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('è¯·è¾“å…¥å•†å“ä¿¡æ¯ï¼');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£ä»˜é‡‘é¢ï¼');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const msg = {
        role: 'user',
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    
    // é‚£ä¸€å¤§æ®µä»£ç å·²ç»è¢«åˆ é™¤äº†
    
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);


// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²


            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

// â–¼â–¼â–¼ ã€æœ€ç»ˆåŠ å¼ºç‰ˆã€‘ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ selection-delete-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†æ”¹å˜AIçš„è®°å¿†ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. ã€æ ¸å¿ƒåŠ å¼ºã€‘åœ¨åˆ é™¤å‰ï¼Œæ£€æŸ¥è¢«åˆ é™¤çš„æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«æŠ•ç¥¨
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`å…³äºâ€œ${msg.question}â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: ${msg.timestamp})`);
            }
        }
        
        // 2. æ›´æ–°åç«¯çš„å†å²è®°å½•
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. ã€æ ¸å¿ƒåŠ å¼ºã€‘æ„å»ºæ›´å…·ä½“çš„â€œé—å¿˜æŒ‡ä»¤â€
        let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join('ï¼›')}ã€‚`;
        }
        forgetReason += " ä½ åº”è¯¥åƒå®ƒä»¬ä»æœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸ºï¼Œä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";

        const forgetInstruction = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼š${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. å°†åŒ…å«â€œé—å¿˜æŒ‡ä»¤â€çš„ã€æ›´æ–°åçš„chatå¯¹è±¡å­˜å›æ•°æ®åº“
        await db.chats.put(chat);
        
        // 5. æœ€åæ‰æ›´æ–°UI
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ä¸¤è¡Œï¼Œæ›¿æ¢æ‰æ—§çš„äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

document.getElementById('create-shuoshuo-btn').addEventListener('click', () => openQZonePublisher('shuoshuo'));
document.getElementById('create-post-btn').addEventListener('click', () => openQZonePublisher('complex'));

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ photos-grid-page ç›‘å¬å™¨ â†“â†“â†“ ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å›¾ç‰‡ä¸Š
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'åˆ é™¤ç…§ç‰‡',
            'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
        }
    } 
    else if (photoThumb) {
        // è¿™å°±æ˜¯æ¢å¤çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ï¼
        openPhotoViewer(photoThumb.src);
    }
});

// æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸€æ•´å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰åˆšæ‰åˆ é™¤çš„æ—§ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„ 'confirm-create-post-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ 'confirm-create-post-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;

    // ã€æ ¸å¿ƒæ”¹é€ ã€‘æˆ‘ä»¬åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªåˆ¤æ–­
    // å¦‚æœå½“å‰æ˜¯ 'forum' (å°ç»„å‘å¸–) æ¨¡å¼ï¼Œå°±è°ƒç”¨æˆ‘ä»¬åˆšåˆšå†™çš„å‘å¸–å‡½æ•°
    if (mode === 'forum') {
        await handleCreateForumPost();
        return; // æ‰§è¡Œå®Œå°±ç»“æŸï¼Œä¸å¾€ä¸‹èµ°äº†
    }
    
    // å¦‚æœæ˜¯ 'weibo' æ¨¡å¼ï¼Œå°±è°ƒç”¨å‘å¾®åšçš„å‡½æ•°
    if (mode === 'weibo') {
        await handlePublishWeibo();
        return;
    }

    // --- ä¸‹é¢æ˜¯ä½ åŸæ¥å·²æœ‰çš„å‘å¸ƒâ€œåŠ¨æ€â€çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¿æŒä¸å˜ ---
    const editingId = parseInt(modal.dataset.editingPostId);
    const areCommentsVisible = document.getElementById('post-comments-toggle').checked;
    
    const visibility = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    if (visibility === 'groups') {
        visibleGroupIds = Array.from(document.querySelectorAll('#post-visibility-groups input:checked'))
                           .map(cb => parseInt(cb.value));
        if (visibleGroupIds.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯è§çš„åˆ†ç»„ï¼");
            return;
        }
    }

    let postData = {};

    if (mode === 'edit') {
        const existingPost = await db.qzonePosts.get(editingId);
        if (!existingPost) {
            alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„åŠ¨æ€ï¼');
            return;
        }
        postData = { 
            ...existingPost, 
            areCommentsVisible: areCommentsVisible,
            visibleGroupIds: visibleGroupIds
        };
        
        if (postData.type === 'shuoshuo') {
            postData.content = document.getElementById('post-public-text').value.trim();
        } else {
            postData.publicText = document.getElementById('post-public-text').value.trim();
            if (postData.type === 'image_post') {
                postData.imageUrl = document.getElementById('post-image-preview').src;
                postData.imageDescription = document.getElementById('post-image-description').value.trim();
            } else if (postData.type === 'text_image') {
                postData.hiddenContent = document.getElementById('post-hidden-text').value.trim();
            }
        }
        await db.qzonePosts.put(postData);

    } else {
        const basePostData = {
            timestamp: Date.now(),
            authorId: 'user',
            areCommentsVisible: areCommentsVisible,
            visibleGroupIds: visibleGroupIds
        };
        
        if (mode === 'shuoshuo') {
            const content = document.getElementById('post-public-text').value.trim();
            if (!content) return alert('è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
            postData = { ...basePostData, type: 'shuoshuo', content: content };
        } else {
            const publicText = document.getElementById('post-public-text').value.trim();
            const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
            if (isImageModeActive) {
                const imageUrl = document.getElementById('post-image-preview').src;
                const imageDescription = document.getElementById('post-image-description').value.trim();
                if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) return alert('è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼');
                if (!imageDescription) return alert('è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼');
                postData = { ...basePostData, type: 'image_post', publicText, imageUrl, imageDescription };
            } else {
                const hiddenText = document.getElementById('post-hidden-text').value.trim();
                if (!hiddenText) return alert('è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼');
                postData = { ...basePostData, type: 'text_image', publicText, hiddenContent: hiddenText };
            }
        }
        const newPostId = await db.qzonePosts.add(postData);
        postData.id = newPostId;
    }
    
    let postSummary = postData.content || postData.publicText || postData.imageDescription || postData.hiddenContent || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue;
        const historyMessage = { role: 'system', content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·${editingId ? 'ç¼–è¾‘äº†' : 'å‘å¸ƒäº†'}ä¸€æ¡åŠ¨æ€(ID: ${editingId || postData.id})ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚]`, timestamp: Date.now(), isHidden: true };
        chat.history.push(historyMessage);
        await db.chats.put(chat);
    }
    
    await renderQzonePosts();
    modal.classList.remove('visible');
    delete modal.dataset.editingPostId;
    delete modal.dataset.mode;
    alert(`åŠ¨æ€${editingId ? 'ç¼–è¾‘' : 'å‘å¸ƒ'}æˆåŠŸï¼`);
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘æ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ä¸ºå…¨å±€èŠå¤©èƒŒæ™¯çš„ä¸Šä¼ æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('global-bg-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise((res) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        newGlobalBgBase64 = dataUrl; // å°†æ–°èƒŒæ™¯å­˜å…¥ä¸´æ—¶å˜é‡
        // å®æ—¶æ›´æ–°é¢„è§ˆ
        const preview = document.getElementById('global-bg-preview');
        preview.style.backgroundImage = `url(${dataUrl})`;
        preview.textContent = '';
    }
});

// ã€å…¨æ–°ã€‘ä¸ºå…¨å±€èŠå¤©èƒŒæ™¯çš„ç§»é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('remove-global-bg-btn').addEventListener('click', () => {
    newGlobalBgBase64 = 'REMOVED'; // ç”¨ä¸€ä¸ªç‰¹æ®Šæ ‡è®°è¡¨ç¤ºâ€œç§»é™¤â€
    const preview = document.getElementById('global-bg-preview');
    preview.style.backgroundImage = 'none';
    preview.textContent = 'å·²ç§»é™¤';
    alert('å…¨å±€èƒŒæ™¯å°†åœ¨ç‚¹å‡»â€œä¿å­˜â€åè¢«ç§»é™¤ã€‚');
});

// ã€å…¨æ–°ã€‘ä¸ºâ€œä¸€é”®æ¸…ç©ºå•äººèƒŒæ™¯â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('clear-all-single-bgs-btn').addEventListener('click', clearAllSingleChatBackgrounds);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘åŒ…å«æ‰€æœ‰æ»‘åŠ¨å’Œç‚¹å‡»äº‹ä»¶çš„å®Œæ•´ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„ postsList äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};

// --- ç»‘å®šæ‰€æœ‰æ»‘åŠ¨äº‹ä»¶ ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);

// â–¼â–¼â–¼ æ­¥éª¤3.3ï¼šç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ qzone-posts-list çš„ click äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
const summonBtn = target.closest('.action-icon.summon-npc');
if (summonBtn) {
    const postId = parseInt(summonBtn.dataset.postId);
    const authorId = summonBtn.dataset.authorId;
    if (!isNaN(postId) && authorId) {
        handleNpcSummonClick(postId, authorId);
    }
    return; // å¤„ç†å®Œå¬å”¤é€»è¾‘åï¼Œç›´æ¥ç»“æŸï¼Œä¸æ‰§è¡Œåç»­çš„ç‚¹èµç­‰åˆ¤æ–­
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šå¤„ç†ç‚¹å‡»è¯„è®ºæœ¬èº«ï¼ˆç”¨äºå›å¤ï¼‰ã€‘â˜…â˜…â˜…â˜…â˜…
    const commentItem = target.closest('.comment-item');
    // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®æˆ–è¯„è®ºé‡Œçš„åå­—é“¾æ¥
    if (commentItem && !target.classList.contains('comment-delete-btn') && !target.classList.contains('commenter-name') && !target.classList.contains('reply-target-name')) {
        const postContainer = commentItem.closest('.qzone-post-container');
        if (postContainer) {
            const commenterName = commentItem.dataset.commenterName;
            const myNickname = state.qzoneSettings.nickname;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯è‡ªå·±çš„è¯„è®ºï¼Œåˆ™ä¸è¿›å…¥å›å¤æ¨¡å¼
            if (commenterName !== myNickname) {
                const commentInput = postContainer.querySelector('.comment-input');
                commentInput.placeholder = `å›å¤ ${commenterName}:`;
                commentInput.dataset.replyTo = commenterName; // æŠŠè¦å›å¤çš„äººçš„åå­—ï¼Œä¸´æ—¶å­˜èµ·æ¥
                commentInput.focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            }
        }
        return; // å¤„ç†å®Œç‚¹å‡»è¯„è®ºåï¼Œå°±ä¸ç”¨å¾€ä¸‹æ‰§è¡Œäº†
    }

    if (target.classList.contains('comment-delete-btn')) {
        const postContainer = target.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(target.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;
        const post = await db.qzonePosts.get(postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;
        const commentText = post.comments[commentIndex].text;
        const confirmed = await showCustomConfirm('åˆ é™¤è¯„è®º', `ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            post.comments.splice(commentIndex, 1);
            await db.qzonePosts.update(postId, { comments: post.comments });
            await renderQzonePosts();
            alert('è¯„è®ºå·²åˆ é™¤ã€‚');
        }
        return;
    }

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-delete-action').parentElement;
        if (!container) return;
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;
        const confirmed = await showCustomConfirm('åˆ é™¤åŠ¨æ€', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
                 }
                 await renderQzonePosts();
                 alert('åŠ¨æ€å·²åˆ é™¤ã€‚');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        showCustomAlert("å›¾ç‰‡å†…å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    
    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹ï¼šå¤„ç†è¯„è®ºå‘é€é€»è¾‘ã€‘â˜…â˜…â˜…â˜…â˜…
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];

        // åˆ›å»ºæ–°çš„è¯„è®ºå¯¹è±¡
        const newComment = { 
            commenterName: state.qzoneSettings.nickname, 
            text: commentText, 
            timestamp: Date.now() 
        };

        // æ£€æŸ¥æ˜¯ä¸æ˜¯åœ¨å›å¤æ¨¡å¼
        if (commentInput.dataset.replyTo) {
            newComment.replyTo = commentInput.dataset.replyTo; // å¦‚æœæ˜¯ï¼Œå°±æŠŠå›å¤å¯¹è±¡çš„åå­—åŠ ä¸Š
        }

        post.comments.push(newComment);
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                let aiNotification = `[ç³»ç»Ÿæç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨IDä¸º${postId}çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®ºï¼šâ€œ${commentText}â€`;
                if(newComment.replyTo) {
                    aiNotification += ` (è¿™æ˜¯å¯¹'${newComment.replyTo}'çš„å›å¤)`;
                }
                aiNotification += `]`;
                chat.history.push({ role: 'system', content: aiNotification, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        
        // å‘é€åï¼Œé‡ç½®è¾“å…¥æ¡†çŠ¶æ€
        commentInput.value = '';
        commentInput.placeholder = 'å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹';
        delete commentInput.dataset.replyTo; // æ¸…é™¤å›å¤çŠ¶æ€

        await renderQzonePosts();
        return;
    }
});
// â–²â–²â–² æ­¥éª¤3.3æ›¿æ¢ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼

            // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ£€æŸ¥å¹¶ç¡®ä¿ä½ æœ‰è¿™æ®µå®Œæ•´çš„ä»£ç  â–¼â–¼â–¼

            // æ”¶è—é¡µæœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰
                    return;
                }

                // ç­›é€‰é€»è¾‘
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // â–²â–²â–² ä»£ç æ£€æŸ¥ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            
            // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
                        // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                                originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                    await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`);
                } else {
                    await showCustomAlert('æç¤º', 'é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚');
                }
                
                exitSelectionMode();
            });

            // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
            const favoritesList = document.getElementById('favorites-list'); // è·å–æ”¶è—åˆ—è¡¨
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'å®Œæˆ';
                    favoritesActionBar.style.display = 'block'; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéšè—ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
                } else {
                    // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'ç¼–è¾‘';
                    favoritesActionBar.style.display = 'none'; // éšè—åˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¤ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¤åˆ—è¡¨é»˜è®¤padding

                    // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (0)`;
                }
            });

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // ã€æ–°å¢ã€‘å¤„ç†æ–‡å­—å›¾ç‚¹å‡»ï¼Œè¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
    }
    
    // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
    if (!isFavoritesSelectionMode) return;

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (${selectedFavorites.size})`;
});

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displayFilteredFavorites(allFavoriteItems);
        
        // æœ€åï¼Œå†é€€å‡ºç¼–è¾‘æ¨¡å¼
        favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
    }
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­£ç¡®ä»£ç ã€‘è¯·ç²˜è´´è¿™æ®µä»£ç åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// --- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å½±å“é¢„è§ˆçš„æ§ä»¶çš„äº‹ä»¶ ---

// 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. æ›´æ–°é¢„è§ˆ
    updateSettingsPreview();
});

// 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. ç›‘å¬é‡ç½®æŒ‰é’®
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // å†æ¬¡ç‚¹å‡»ä»¥é‡æ–°æ‰“å¼€
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
// æ¶ˆæ¯æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
// â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„ç¼–è¾‘å™¨å…¥å£ â–¼â–¼â–¼
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ select-message-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('select-message-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨å…³é—­èœå•å‰ï¼Œå…ˆæ•è·æ—¶é—´æˆ³
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // ä½¿ç”¨æ•è·åˆ°çš„å€¼
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼

// åŠ¨æ€æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘è”ç³»äººé€‰æ‹©å™¨äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç»‘å®šâ€œç®¡ç†ç¾¤æˆå‘˜â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('manage-members-btn').addEventListener('click', () => {
    // åœ¨åˆ‡æ¢å±å¹•å‰ï¼Œå…ˆéšè—å½“å‰çš„èŠå¤©è®¾ç½®å¼¹çª—
    document.getElementById('chat-settings-modal').classList.remove('visible');
    // ç„¶åå†æ‰“å¼€æˆå‘˜ç®¡ç†å±å¹•
    openMemberManagementScreen();
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆå®Œæ•´ç‰ˆã€‘ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // ã€å·²æ¢å¤ã€‘ä»å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
    // ã€å…³é”®ã€‘ä¸ºâ€œå®Œæˆâ€æŒ‰é’®ç»‘å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é€»è¾‘
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ–¹æ³•æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ç»‘å®šå•èŠå’Œç¾¤èŠçš„å‘èµ·æŒ‰é’®
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// ç»‘å®šâ€œæŒ‚æ–­â€æŒ‰é’®
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// ç»‘å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰é’®
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// ã€å…¨æ–°ã€‘ç»‘å®šâ€œåŠ å…¥é€šè¯â€æŒ‰é’®
document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤å¹¶æ¿€æ´»æ—è§‚æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ decline-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ‹’ç»â€æŒ‰é’®
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    stopRingtone(); 
    hideIncomingCallModal();
    const callerChatId = videoCallState.activeChatId; // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»ä¸“ç”¨ä¿¡é“è·å–æ¥ç”µè€…ID
    if (!callerChatId) return;

    const chat = state.chats[callerChatId];
    if (!chat) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ ¹æ®æ˜¯å¦ç¾¤èŠï¼Œæ‰§è¡Œä¸åŒçš„æ‹’ç»é€»è¾‘
    if (videoCallState.isGroupCall) {
        // å¯¹äºç¾¤èŠï¼Œæ‹’ç»=æ—è§‚ï¼Œè¿™ä¸ªé€»è¾‘ä¸å˜
        videoCallState.isUserParticipating = false;
        const systemNote = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·ï¼Œä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        await triggerAiResponse(); 
    } else { 
        // å¯¹äºå•èŠï¼Œæˆ‘ä»¬ä¸å†æ‰“æ‰°ç”¨æˆ·å½“å‰ç•Œé¢ï¼Œè€Œæ˜¯é™é»˜å¤„ç†
        const declineMessage = { role: 'user', content: 'æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now(), isHidden: true };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // ã€æ ¸å¿ƒä¿®æ­£3ã€‘åªé€šçŸ¥ï¼Œä¸åˆ‡æ¢å±å¹•
        showNotification(callerChatId, "ä½ å·²æ‹’ç»é€šè¯é‚€è¯·ã€‚");
        // ã€é‡è¦ã€‘åœ¨åå°ä¸ºå¯¹æ–¹è§¦å‘ä¸€ä¸ªå“åº”ï¼Œè®©å®ƒçŸ¥é“è‡ªå·±è¢«æ‹’ç»äº†
        // æˆ‘ä»¬éœ€è¦ä¸´æ—¶åˆ‡æ¢activeChatIdæ¥è§¦å‘ï¼Œç„¶åå†æ¢å›æ¥
        const originalActiveChatId = state.activeChatId;
        state.activeChatId = callerChatId;
        await triggerAiResponse();
        state.activeChatId = originalActiveChatId;
    }
    
    // æ¸…ç†çŠ¶æ€
    videoCallState.isAwaitingResponse = false;
    videoCallState.activeChatId = null;
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤å¤´åƒBUGã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ accept-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ¥å¬â€æŒ‰é’®
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    stopRingtone();
    hideIncomingCallModal();
    const callerChatId = videoCallState.activeChatId; // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»ä¸“ç”¨ä¿¡é“è·å–ID
    if (!callerChatId) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘åœ¨æ¥å¬æ—¶ï¼Œæˆ‘ä»¬æ‰çœŸæ­£æ”¹å˜å…¨å±€çŠ¶æ€ï¼Œå¹¶æ‰“å¼€é€šè¯ç•Œé¢
    state.activeChatId = callerChatId; // <-- åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ‰æˆæƒä¿®æ”¹å…¨å±€çŠ¶æ€ï¼
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    
    if (videoCallState.isGroupCall) {
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = [];
        }
    }
    
    startVideoCall(); // å¯åŠ¨é€šè¯ç•Œé¢
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å¢åŠ ç”¨æˆ·é«˜äº®ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ user-speak-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šç”¨æˆ·åœ¨é€šè¯ä¸­å‘è¨€çš„æŒ‰é’®
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨å¼¹å‡ºè¾“å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°å¹¶é«˜äº®ç”¨æˆ·å¤´åƒ â˜…â˜…â˜…â˜…â˜…
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('ä½ è¯´', 'è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...');
    
    // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šæ— è®ºç”¨æˆ·æ˜¯å¦è¾“å…¥ï¼Œåªè¦å…³é—­è¾“å…¥æ¡†å°±ç§»é™¤é«˜äº® â˜…â˜…â˜…â˜…â˜…
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘å›å¿†å½•ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
// 1. å°†â€œå›å¿†â€é¡µç­¾å’Œå®ƒçš„è§†å›¾è¿æ¥èµ·æ¥
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    // åœ¨åˆ‡æ¢å‰ï¼Œç¡®ä¿"æ”¶è—"é¡µé¢çš„ç¼–è¾‘æ¨¡å¼å·²å…³é—­
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); // ç‚¹å‡»æ—¶æ¸²æŸ“
});

// 2. ç»‘å®šå›å¿†å½•ç•Œé¢çš„è¿”å›æŒ‰é’®
document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('è¯·å¡«å†™å®Œæ•´çš„çº¦å®šæ ‡é¢˜å’Œæ—¥æœŸï¼');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœªæ¥çš„æ—¥æœŸï¼');
        return;
    }

    const newCountdown = {
        chatId: null, // ç”¨æˆ·åˆ›å»ºçš„ï¼Œä¸å±äºä»»ä½•ç‰¹å®šAI
        authorName: 'æˆ‘',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});

// ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ‹‰é»‘', 
        `ç¡®å®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘åæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œä¹Ÿæ— æ³•å›åº”ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        
        // å…³é—­è®¾ç½®å¼¹çª—ï¼Œå¹¶åˆ·æ–°èŠå¤©ç•Œé¢
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰UIå˜åŒ–
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹ï¼Œè¯·ç¨å...\nå¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œå°†å¼¹å‡ºæç¤ºã€‚å¦‚æœå¤±è´¥ï¼Œä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯´æ˜AIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚ç°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse(); // ã€å¯é€‰ä½†æ¨èã€‘è§£é™¤åè®©AIä¸»åŠ¨è¯´ç‚¹ä»€ä¹ˆ
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšé€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚ä½ ä»¬ç°åœ¨åˆå¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹è¯·æ±‚', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // ã€æ–°å¢ã€‘å¤„ç†ç”³è¯·å¥½å‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'å‘é€å¥½å‹ç”³è¯·', 
            `è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ${chat.name}â€è¯´çš„ç”³è¯·ç†ç”±ï¼š`,
            "æˆ‘ä»¬å’Œå¥½å§ï¼"
        );
        // åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€åæ‰ç»§ç»­
        if (reason !== null) {
            // æ›´æ–°å…³ç³»çŠ¶æ€ä¸ºâ€œç­‰å¾…AIæ‰¹å‡†â€
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // åˆ·æ–°UIï¼Œæ˜¾ç¤ºâ€œç­‰å¾…é€šè¿‡â€çš„ç•Œé¢
            renderChatInterface(chat.id);
            renderChatList();
            
            // ã€å…³é”®ã€‘è§¦å‘AIå“åº”ï¼Œè®©å®ƒå»å¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
            triggerAiResponse();
        }
    }
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. å°†åŸæœ‰çš„è½¬è´¦æŒ‰é’®(ï¿¥)çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„æ€»å…¥å£å‡½æ•°
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. çº¢åŒ…æ¨¡æ€æ¡†å†…éƒ¨çš„æ§åˆ¶æŒ‰é’®
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. çº¢åŒ…æ¨¡æ€æ¡†çš„é¡µç­¾åˆ‡æ¢é€»è¾‘
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. å®æ—¶æ›´æ–°çº¢åŒ…é‡‘é¢æ˜¾ç¤º
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});

// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†çº¢åŒ…ç‚¹å‡»ï¼Œä¿®å¤å¤±æ•ˆé—®é¢˜ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ‰¾åˆ°è¢«ç‚¹å‡»çš„çº¢åŒ…å¡ç‰‡
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çº¢åŒ…ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš

    // 2. ä»çº¢åŒ…å¡ç‰‡çš„çˆ¶çº§.message-bubbleè·å–æ—¶é—´æˆ³
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„å¤„ç†å‡½æ•°
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// åœ¨è¾“å…¥æ¡†å·¥å…·æ æ·»åŠ æŒ‰é’®
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// æŠ•ç¥¨åˆ›å»ºæ¨¡æ€æ¡†çš„æŒ‰é’®
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŠ•ç¥¨å¡ç‰‡å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // ç‚¹å‡»äº†é€‰é¡¹
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // ç‚¹å‡»äº†åŠ¨ä½œæŒ‰é’®ï¼ˆç»“æŸæŠ•ç¥¨/æŸ¥çœ‹ç»“æœï¼‰
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // å¦‚æœæ˜¯å·²ç»“æŸçš„æŠ•ç¥¨ï¼Œç‚¹å‡»å¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹ç»“æœ
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²

  // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸï¼Œç²˜è´´è¿™æ®µã€æ–°ä»£ç ã€‘â–¼â–¼â–¼
            // â–¼â–¼â–¼ ã€è¯·æ±‚4ã€‘Appå›¾æ ‡ä¸Šä¼ åŠŸèƒ½å‡çº§ (è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„icon-settings-gridç›‘å¬å™¨) â–¼â–¼â–¼
            document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
                if (e.target.classList.contains('change-icon-btn')) {
                    const item = e.target.closest('.icon-setting-item');
                    const iconId = item.dataset.iconId;
                    if (!iconId) return;

                    // 1. å¼¹å‡ºé€‰æ‹©æ¨¡æ€æ¡†
                    const choice = await showChoiceModal("æ›´æ¢å›¾æ ‡", [
                        { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
                        { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
                    ]);

                    let newUrl = null;

                    // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
                    if (choice === 'local') {
                        newUrl = await uploadImageLocally(); // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™å¥½çš„æœ¬åœ°ä¸Šä¼ è¾…åŠ©å‡½æ•°
                    } else if (choice === 'url') {
                        const currentUrl = state.globalSettings.appIcons[iconId];
                        newUrl = await showCustomPrompt(`æ›´æ¢â€œ${item.querySelector('.icon-preview').alt}â€å›¾æ ‡`, 'è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL', currentUrl, 'url');
                    }

                    // 3. å¤„ç†æœ€ç»ˆç»“æœ
                    if (newUrl && newUrl.trim()) {
                        const trimmedUrl = newUrl.trim();
                        // ä»…åœ¨å†…å­˜ä¸­æ›´æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜â€
                        state.globalSettings.appIcons[iconId] = trimmedUrl;
                        // å®æ—¶æ›´æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆå›¾
                        item.querySelector('.icon-preview').src = trimmedUrl;
                    } else if (newUrl !== null) {
                        alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLæˆ–é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
                    }
                }
            });
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å¡ç‰‡
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°
            }
        }
    });

    // æµè§ˆå™¨è¿”å›æŒ‰é’®çš„äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿å®ƒåªç»‘å®šä¸€æ¬¡
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é“¾æ¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œåˆ†äº«â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™å‡ è¡Œ â–¼â–¼â–¼
// ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

// ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// åœ¨ä½ çš„ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...

// â–¼â–¼â–¼ ç”¨è¿™æ®µä»£ç æ›¿æ¢æ—§çš„è½¬è´¦å¡ç‰‡ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
    const bubble = e.target.closest('.message-bubble');
    if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º

    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œæ·»åŠ ä¸¥æ ¼çš„ç­›é€‰æ¡ä»¶
    // å¿…é¡»æ˜¯ AI çš„æ¶ˆæ¯ (.ai)
    // å¿…é¡»æ˜¯è½¬è´¦ç±»å‹ (.is-transfer)
    // å¿…é¡»æ˜¯æˆ‘ä»¬æ ‡è®°ä¸ºâ€œå¾…å¤„ç†â€çš„ (data-status="pending")
    if (bubble.classList.contains('ai') && 
        bubble.classList.contains('is-transfer') && 
        bubble.dataset.status === 'pending') {
        
        // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œæ‰æ‰§è¡Œåç»­é€»è¾‘
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
            showTransferActionModal(timestamp);
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ 
document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);

// â–¼â–¼â–¼ ç”¨è¿™æ®µã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„é€šè¯è®°å½•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);

// 2. ç»‘å®šé€šè¯è®°å½•é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®
document.getElementById('call-history-back-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©åˆ—è¡¨é¡µé¢ï¼Œè€Œä¸æ˜¯èŠå¤©ç•Œé¢
    showScreen('chat-list-screen');
});

// 3. ç›‘å¬å¡ç‰‡ç‚¹å‡»çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('call-history-list').addEventListener('click', (e) => {
    const card = e.target.closest('.call-record-card');
    if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
    }
});

// 4. å…³é—­è¯¦æƒ…å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯è¯­éŸ³æ¡
    const voiceBody = e.target.closest('.voice-message-body');
    if (!voiceBody) return;

    // 2. æ‰¾åˆ°ç›¸å…³çš„DOMå…ƒç´ 
    const bubble = voiceBody.closest('.message-bubble');
    if (!bubble) return;
    
    const spinner = voiceBody.querySelector('.loading-spinner');
    const transcriptEl = bubble.querySelector('.voice-transcript');

    // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œåˆ™ä¸å“åº”ç‚¹å‡»
    if (bubble.dataset.state === 'loading') {
        return;
    }

    // 3. å¦‚æœæ–‡å­—å·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
    if (bubble.dataset.state === 'expanded') {
        transcriptEl.style.display = 'none';
        bubble.dataset.state = 'collapsed';
    } 
    // 4. å¦‚æœæ˜¯æ”¶èµ·çŠ¶æ€ï¼Œåˆ™å¼€å§‹â€œè½¬å½•â€æµç¨‹
    else {
        bubble.dataset.state = 'loading'; // è¿›å…¥åŠ è½½çŠ¶æ€
        spinner.style.display = 'block';   // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

        // æ¨¡æ‹Ÿ1.5ç§’çš„è¯­éŸ³è¯†åˆ«è¿‡ç¨‹
        setTimeout(() => {
            // æ£€æŸ¥æ­¤æ—¶å…ƒç´ æ˜¯å¦è¿˜å­˜åœ¨ï¼ˆå¯èƒ½ç”¨æˆ·å·²ç»åˆ‡æ¢äº†èŠå¤©ï¼‰
            if (document.body.contains(bubble)) {
                const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—
                
                spinner.style.display = 'none';      // éšè—åŠ è½½åŠ¨ç”»
                transcriptEl.style.display = 'block';// æ˜¾ç¤ºæ–‡å­—
                bubble.dataset.state = 'expanded';     // è¿›å…¥å±•å¼€çŠ¶æ€
            }
        }, 500);
    }
});

document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('selection-share-btn').addEventListener('click', () => {
    if (selectedMessages.size > 0) {
        openShareTargetPicker(); // æ‰“å¼€æˆ‘ä»¬å³å°†åˆ›å»ºçš„ç›®æ ‡é€‰æ‹©å™¨
    }
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
    const sourceChat = state.chats[state.activeChatId];
    const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                   .map(cb => cb.dataset.chatId);

    if (selectedTargetIds.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
        return;
    }

    // 1. æ‰“åŒ…èŠå¤©è®°å½•
    const sharedHistory = [];
    const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
    for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
            sharedHistory.push(msg);
        }
    }
    
    // 2. åˆ›å»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯å¯¹è±¡
    const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
            sourceChatName: sourceChat.name,
            title: `æ¥è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è®°å½•`,
            sharedHistory: sharedHistory
        }
    };

    // 3. å¾ªç¯å‘é€åˆ°æ‰€æœ‰ç›®æ ‡èŠå¤©
    for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
            targetChat.history.push(shareCardMessage);
            await db.chats.put(targetChat);
        }
    }
    
    // 4. æ”¶å°¾å·¥ä½œ
    document.getElementById('share-target-modal').classList.remove('visible');
    exitSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} ä¸ªä¼šè¯ä¸­ã€‚`);
    renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰æ–°æ¶ˆæ¯æç¤º
});

// ç»‘å®šå–æ¶ˆæŒ‰é’®
document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
    document.getElementById('share-target-modal').classList.remove('visible');
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // ...ä½ å·²æœ‰çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘...

    // æ–°å¢é€»è¾‘ï¼šå¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
    }
});

// ç»‘å®šæŸ¥çœ‹å™¨çš„å…³é—­æŒ‰é’®
document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('shared-history-viewer-modal').classList.remove('visible');
});

// åˆ›å»ºæ–°å‡½æ•°æ¥å¤„ç†æ¸²æŸ“é€»è¾‘
function openSharedHistoryViewer(timestamp) {
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_card') return;

    const viewerModal = document.getElementById('shared-history-viewer-modal');
    const viewerTitle = document.getElementById('shared-history-viewer-title');
    const viewerContent = document.getElementById('shared-history-viewer-content');

    viewerTitle.textContent = message.payload.title;
    viewerContent.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    // ã€æ ¸å¿ƒã€‘å¤ç”¨ createMessageElement æ¥æ¸²æŸ“æ¯ä¸€æ¡è¢«åˆ†äº«çš„æ¶ˆæ¯
    message.payload.sharedHistory.forEach(sharedMsg => {
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ sourceChat å¯¹è±¡ï¼Œä»¥ç¡®ä¿å¤´åƒã€æ˜µç§°ç­‰æ­£ç¡®
        const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
        const bubbleEl = createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
            viewerContent.appendChild(bubbleEl);
        }
    });

    viewerModal.classList.add('visible');
}

audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
    } 
});
audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
    } 
});

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('delete-track-btn')) {
        const index = parseInt(target.dataset.index);
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }
    // â–¼â–¼â–¼ åœ¨ lyrics-btn çš„åˆ¤æ–­é€»è¾‘ã€ä¸Šæ–¹ã€‘ï¼Œæ·»åŠ è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
            if (target.classList.contains('cover-btn')) {
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                    handleCoverUpload(index);
                }
                return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œé¿å…è§¦å‘å…¶ä»–é€»è¾‘
            }
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ lyrics-btn ç‚¹å‡»é€»è¾‘ â–¼â–¼â–¼
            if (target.classList.contains('lyrics-btn')) {
                const index = parseInt(target.dataset.index);
                if (isNaN(index)) return;

                // 1. å¼¹çª—è¯¢é—®ç”¨æˆ·é€‰æ‹©ï¼ˆå·²ç§»é™¤å›¾æ ‡ï¼‰
                const choice = await showChoiceModal("é€‰æ‹©æ­Œè¯æ¥æº", [
                    { text: 'ä½¿ç”¨ç½‘ç»œURL', value: 'url' },
                    { text: 'ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' }
                ]);

                let lrcContent = null;

                // 2. æ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
                if (choice === 'url') {
                    const url = await showCustomPrompt("æ­Œè¯URL", "è¯·è¾“å…¥.lrcæ­Œè¯æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥");
                    if (url && url.trim()) {
                        try {
                            const response = await fetch(url.trim());
                            if (response.ok) {
                                lrcContent = await response.text();
                            } else {
                                alert('æ— æ³•è·å–æ­Œè¯æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ã€‚');
                            }
                        } catch (error) {
                            alert('è·å–æ­Œè¯å¤±è´¥: ' + error.message);
                        }
                    }
                } else if (choice === 'local') {
                    lrcContent = await new Promise(resolve => {
                        const lrcInput = document.getElementById('lrc-upload-input');
                        const handler = (event) => {
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (re) => resolve(re.target.result);
                                reader.readAsText(file);
                            } else {
                                resolve(null);
                            }
                            lrcInput.removeEventListener('change', handler);
                            lrcInput.value = '';
                        };
                        lrcInput.addEventListener('change', handler);
                        lrcInput.click();
                    });
                }

                // 3. å¦‚æœæˆåŠŸè·å–åˆ°æ­Œè¯ï¼Œå°±ä¿å­˜å¹¶æ›´æ–°
                if (lrcContent !== null) {
                    musicState.playlist[index].lrcContent = lrcContent;
                    await saveGlobalPlaylist();
                    alert('æ­Œè¯å¯¼å…¥æˆåŠŸï¼');
                    if (musicState.currentIndex === index) {
                        musicState.parsedLyrics = parseLRC(lrcContent);
                        renderLyrics();
                    }
                }
            }
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
});

document.querySelector('.progress-bar').addEventListener('click', (e) => {
    if (!audioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (!placeholder) return; // å¦‚æœä¸æ˜¯ï¼Œå°±é€€å‡º

    // å¦‚æœæ˜¯ï¼Œå°±ä»èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¹¶æ˜¾ç¤º
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper'); // æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨
    if (chat && wrapper) {
        // ä»çˆ¶å®¹å™¨ä¸Šæ‰¾åˆ°æ—¶é—´æˆ³
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
        
        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;
            
            if (recalled.originalType === 'text') {
                originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
            } else {
                originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
            }
            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
document.getElementById('close-category-manager-btn').addEventListener('click', () => {
    document.getElementById('world-book-category-manager-modal').classList.remove('visible');
    renderWorldBookScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
});
document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
document.getElementById('existing-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// --- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªå®šä¹‰å¤´åƒæ¡†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼ ---

// æ‰“å¼€â€œé€‰æ‹©â€å¼¹çª—çš„æŒ‰é’®
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal(e.target.dataset.type);
    }
});
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member', editingMemberId);
    }
});

// â€œé€‰æ‹©â€å¼¹çª—å†…çš„æŒ‰é’®
// â€œé€‰æ‹©â€å¼¹çª—å†…çš„æŒ‰é’®ï¼ˆå·²ä¿®æ­£ï¼‰
document.getElementById('manage-custom-frames-btn').addEventListener('click', () => {
    // 1. å…ˆå…³é—­å½“å‰çš„é€‰æ‹©å¼¹çª—
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // 2. ç„¶åå†æ‰“å¼€ç®¡ç†å¼¹çª—
    openFrameManager();
});
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => document.getElementById('avatar-frame-modal').classList.remove('visible'));
document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);

// â€œç®¡ç†â€å¼¹çª—å†…çš„æŒ‰é’®
document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadCustomFrame);
document.getElementById('close-frame-manager-btn').addEventListener('click', () => {
    document.getElementById('custom-frame-manager-modal').classList.remove('visible');
    // å…³é—­ç®¡ç†åï¼Œåˆ·æ–°é€‰æ‹©ç•Œé¢ï¼Œå› ä¸ºåˆ—è¡¨å¯èƒ½å˜äº†
    openFrameSelectorModal(currentFrameSelection.type, currentFrameSelection.target);
});

// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©åˆ—è¡¨å·¦æ»‘åŠŸèƒ½JSé€»è¾‘ â–¼â–¼â–¼
const chatListEl = document.getElementById('chat-list');
let chatSwipeState = { isDragging: false, startX: 0, activeContent: null };

// å…³é—­æ‰€æœ‰å·²æ»‘å¼€çš„é¡¹
function resetAllChatSwipes(exceptThisOne = null) {
    document.querySelectorAll('.chat-list-item-content.swiped').forEach(content => {
        if (content !== exceptThisOne) {
            content.classList.remove('swiped');
        }
    });
}

chatListEl.addEventListener('mousedown', (e) => {
    const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.pageX;
        chatSwipeState.activeContent = content;
        // é˜»æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
        e.preventDefault();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.pageX - chatSwipeState.startX;
    if (diffX < 0 && diffX > -170) { // åªå…è®¸å‘å·¦æ»‘, é™åˆ¶æœ€å¤§è·ç¦»
        chatSwipeState.activeContent.style.transition = 'none'; // æ»‘åŠ¨æ—¶ç¦ç”¨åŠ¨ç”»
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
});

document.addEventListener('mouseup', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) { // æ»‘åŠ¨è¶…è¿‡é˜ˆå€¼
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = ''; // æ¸…é™¤å†…è”æ ·å¼ï¼Œäº¤ç”±CSS classæ§åˆ¶

    // é‡ç½®çŠ¶æ€
    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});

// ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶çš„å…¼å®¹
chatListEl.addEventListener('touchstart', (e) => {
     const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.touches[0].pageX;
        chatSwipeState.activeContent = content;
    }
}, { passive: true });

chatListEl.addEventListener('touchmove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.touches[0].pageX - chatSwipeState.startX;
     if (diffX < 0 && diffX > -170) {
        chatSwipeState.activeContent.style.transition = 'none';
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
}, { passive: true });

chatListEl.addEventListener('touchend', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) {
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = '';

    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});
// â–²â–²â–² æ–°JSé€»è¾‘ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©åˆ—è¡¨æ“ä½œæŒ‰é’®ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
chatListEl.addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('swipe-action-btn')) {
        const container = target.closest('.chat-list-item-swipe-container');
        if (!container) return;

        const chatId = container.dataset.chatId;
        const chat = state.chats[chatId];
        if (!chat) return;

        if (target.classList.contains('pin') || target.classList.contains('unpin')) {
            // ç½®é¡¶æˆ–å–æ¶ˆç½®é¡¶
            chat.isPinned = !chat.isPinned;
            await db.chats.put(chat);
            await renderChatList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ’åº
        } else if (target.classList.contains('delete')) {
            // åˆ é™¤
            const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
                delete state.chats[chat.id];
                if (state.activeChatId === chat.id) state.activeChatId = null;
                await db.chats.delete(chat.id);
                await renderChatList();
            } else {
                // å¦‚æœå–æ¶ˆåˆ é™¤ï¼Œåˆ™æŠŠæ»‘å—æ”¶å›å»
                const content = container.querySelector('.chat-list-item-content');
                if (content) content.classList.remove('swiped');
            }
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹ï¼ŒæŠŠä¸‹é¢è¿™ä¸¤å—å®Œæ•´çš„ eventListener ä»£ç ã€å‰ªåˆ‡ã€‘æ‰ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰ç‚¹å‡»å’Œå‹¾é€‰äº‹ä»¶ï¼Œæ•ˆç‡æ›´é«˜
worldBookCheckboxesContainer.addEventListener('click', (e) => {
    const header = e.target.closest('.wb-category-header');
    // å¦‚æœç‚¹å‡»çš„æ˜¯æ–‡ä»¶å¤¹å¤´éƒ¨ï¼Œå¹¶ä¸”ä¸æ˜¯ç‚¹åœ¨å¤é€‰æ¡†ä¸Š
    if (header && !e.target.matches('input[type="checkbox"]')) {
        const categoryId = header.querySelector('.wb-category-checkbox')?.dataset.categoryId;
        if (categoryId) {
            const bookContainer = worldBookCheckboxesContainer.querySelector(`.wb-book-container[data-container-for="${categoryId}"]`);
            if (bookContainer) {
                header.classList.toggle('collapsed');
                bookContainer.classList.toggle('collapsed');
            }
        }
    }
});

worldBookCheckboxesContainer.addEventListener('change', (e) => {
    const target = e.target;
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ†ç±»çš„â€œå…¨é€‰â€å¤é€‰æ¡†
    if (target.classList.contains('wb-category-checkbox')) {
        const categoryId = target.dataset.categoryId;
        const isChecked = target.checked;
        // æ‰¾åˆ°è¿™ä¸ªåˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¹¦ç±å¤é€‰æ¡†ï¼Œå¹¶å°†å®ƒä»¬çš„çŠ¶æ€è®¾ç½®ä¸ºä¸åˆ†ç±»å¤é€‰æ¡†ä¸€è‡´
        const bookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
        bookCheckboxes.forEach(cb => cb.checked = isChecked);
    }
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯å•ä¸ªä¹¦ç±çš„å¤é€‰æ¡†
    if (target.classList.contains('wb-book-checkbox')) {
        const categoryId = target.dataset.parentCategory;
        if (categoryId) { // æ£€æŸ¥å®ƒæ˜¯å¦å±äºä¸€ä¸ªåˆ†ç±»
            const categoryCheckbox = worldBookCheckboxesContainer.querySelector(`input.wb-category-checkbox[data-category-id="${categoryId}"]`);
            const allBookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
            // æ£€æŸ¥è¯¥åˆ†ç±»ä¸‹æ˜¯å¦æ‰€æœ‰ä¹¦ç±éƒ½è¢«é€‰ä¸­äº†
            const allChecked = Array.from(allBookCheckboxes).every(cb => cb.checked);
            // åŒæ­¥åˆ†ç±»â€œå…¨é€‰â€å¤é€‰æ¡†çš„çŠ¶æ€
            if(categoryCheckbox) categoryCheckbox.checked = allChecked;
        }
    }
    
    // æ¯æ¬¡å˜æ›´åéƒ½æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º
    updateWorldBookSelectionDisplay();
});

// â–²â–²â–² æŠŠä¸Šé¢è¿™ä¸¤å—å®Œæ•´çš„ eventListener ä»£ç ã€å‰ªåˆ‡ã€‘æ‰ â–²â–²â–²


    // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸€æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

    // --- ç¾åŒ–åŠŸèƒ½äº‹ä»¶ç»‘å®š ---
    const themeEditor = document.getElementById('theme-css-editor');
    
    // é¡µé¢åŠ è½½æ—¶ï¼ŒåŠ è½½ä¸»é¢˜åˆ—è¡¨å¹¶æ˜¾ç¤ºæ¨¡æ¿
    await loadThemesToDropdown();
    themeEditor.value = THEME_CSS_TEMPLATE;

    // ç»‘å®šä¸‹æ‹‰æ¡†é€‰æ‹©äº‹ä»¶
    document.getElementById('theme-selector').addEventListener('change', handleThemeSelection);
    
    // ç»‘å®šæ‰€æœ‰æ“ä½œæŒ‰é’®
    document.getElementById('apply-theme-btn').addEventListener('click', () => applyThemeCss(themeEditor.value));
    document.getElementById('save-theme-btn').addEventListener('click', saveCurrentTheme);
    document.getElementById('save-as-new-theme-btn').addEventListener('click', saveAsNewTheme);
    document.getElementById('rename-theme-btn').addEventListener('click', renameSelectedTheme);
    document.getElementById('delete-theme-btn').addEventListener('click', deleteSelectedTheme);
    document.getElementById('export-theme-btn').addEventListener('click', exportTheme);
    
    // ç»‘å®šå¯¼å…¥æŒ‰é’®å’Œéšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
    document.getElementById('import-theme-btn').addEventListener('click', () => {
        document.getElementById('import-theme-input').click();
    });
    document.getElementById('import-theme-input').addEventListener('change', (e) => {
        importTheme(e.target.files[0]);
        e.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
    });
    
    // â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

document.getElementById('api-preset-select').addEventListener('change', handleApiPresetSelectChange);
document.getElementById('manage-api-presets-btn').addEventListener('click', openApiPresetManager);

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é”å±åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

            // 1. é”å±å£çº¸ä¸Šä¼ 
            document.getElementById('lockscreen-wallpaper-upload-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if(file) {
                    const dataUrl = await new Promise((res, rej) => {
                        const reader = new FileReader();
                        reader.onload = () => res(reader.result);
                        reader.onerror = () => rej(reader.error);
                        reader.readAsDataURL(file);
                    });
                    newLockscreenWallpaperBase64 = dataUrl;
                    renderWallpaperScreen(); // ä¸Šä¼ åå®æ—¶é¢„è§ˆ
                }
            });

            // 2. å¯†ç è¾“å…¥æ¡†æŒ‰é’®
            document.getElementById('password-confirm-btn').addEventListener('click', checkPassword);
            document.getElementById('password-cancel-btn').addEventListener('click', hidePasswordModal);
            // å…è®¸åœ¨è¾“å…¥æ¡†å†…æŒ‰å›è½¦é”®ç¡®è®¤
            document.getElementById('password-input-field').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // 3. ã€å…¨æ–°ã€‘å¸¦æœ‰åŠ¨ç”»æ•ˆæœçš„ä¸Šæ»‘è§£é”æ‰‹åŠ¿
            const lockScreen = document.getElementById('lock-screen');
            const unlockHint = document.getElementById('unlock-hint');
            let touchStartY = 0;
            let isSwiping = false;

// ç»Ÿä¸€çš„å¼€å§‹å¤„ç†å‡½æ•°
const handleUnlockStart = (e) => {
    if (document.getElementById('password-modal-overlay').classList.contains('visible')) return;
    
    // (ä½ åŸæ¥çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
    const blurBg = document.getElementById('lock-screen-background-blur');
    if (state.globalSettings.password) {
        blurBg.style.backgroundImage = lockScreen.style.backgroundImage;
        blurBg.style.display = 'block';
    } else {
        document.getElementById('home-screen').classList.add('active');
    }
    
    touchStartY = getEventCoords(e).y; // ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å–Yåæ ‡
    isSwiping = true;
    lockScreen.style.transition = 'none';
    unlockHint.style.transition = 'none';
};

// ç»Ÿä¸€çš„ç§»åŠ¨å¤„ç†å‡½æ•°
const handleUnlockMove = (e) => {
    if (!isSwiping) return;
    const currentY = getEventCoords(e).y; // ä½¿ç”¨è¾…åŠ©å‡½æ•°
    let diffY = currentY - touchStartY;
    // (ä½ åŸæ¥çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
    if (diffY > 0) diffY = 0;
    lockScreen.style.transform = `translateY(${diffY}px)`;
    unlockHint.style.opacity = Math.max(0, 1 - Math.abs(diffY) / 100);
    if (state.globalSettings.password) {
        const blurBg = document.getElementById('lock-screen-background-blur');
        blurBg.style.opacity = Math.min(1, Math.abs(diffY) / 80);
    }
};

// ç»Ÿä¸€çš„ç»“æŸå¤„ç†å‡½æ•°
const handleUnlockEnd = (e) => {
    if (!isSwiping) return;
    isSwiping = false;

    // (ä½ åŸæ¥çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
    lockScreen.style.transition = 'transform 0.3s ease-out';
    unlockHint.style.transition = 'opacity 0.3s ease-out';
    const blurBg = document.getElementById('lock-screen-background-blur');
    
    // æ³¨æ„ï¼štouchendäº‹ä»¶çš„åæ ‡åœ¨ e.changedTouches[0]
    const touchEndY = e.changedTouches ? e.changedTouches[0].clientY : e.pageY;
    const swipeDistance = touchStartY - touchEndY;
    
    if (swipeDistance > 80) {
        lockScreen.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            if (state.globalSettings.password) {
                showPasswordModal();
            } else {
                unlockPhone();
            }
        }, 300);
    } else {
        lockScreen.style.transform = 'translateY(0)';
        unlockHint.style.opacity = '1';
        if (state.globalSettings.password) {
            blurBg.style.opacity = '0';
            setTimeout(() => { blurBg.style.display = 'none'; }, 300);
        } else {
            document.getElementById('home-screen').classList.remove('active');
        }
    }
};

// 2. ç»‘å®šä¸¤ç§äº‹ä»¶åˆ°åŒä¸€å¥—å¤„ç†é€»è¾‘ä¸Š
lockScreen.addEventListener('touchstart', handleUnlockStart, { passive: true });
lockScreen.addEventListener('touchmove', handleUnlockMove, { passive: true });
lockScreen.addEventListener('touchend', handleUnlockEnd, { passive: true });

lockScreen.addEventListener('mousedown', handleUnlockStart);
// æ³¨æ„ï¼šmousemoveå’Œmouseupæœ€å¥½ç»‘å®šåœ¨documentä¸Šï¼Œé˜²æ­¢é¼ æ ‡æ‹–å‡ºèŒƒå›´åå¤±æ•ˆ
document.addEventListener('mousemove', handleUnlockMove);
document.addEventListener('mouseup', handleUnlockEnd);
            
            // â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘ä¸ºèŠå¤©åº•éƒ¨å·¥å…·æ æ·»åŠ é¼ æ ‡æ‹–åŠ¨æ»šåŠ¨åŠŸèƒ½
const actionsTopBar = document.getElementById('chat-input-actions-top');
let isDown = false;
let startX;
let scrollLeft;

actionsTopBar.addEventListener('mousedown', (e) => {
    isDown = true;
    actionsTopBar.classList.add('grabbing'); // æ·»åŠ ä¸€ä¸ªclassæ¥æ”¹å˜é¼ æ ‡æ ·å¼
    startX = e.pageX - actionsTopBar.offsetLeft;
    scrollLeft = actionsTopBar.scrollLeft;
});

actionsTopBar.addEventListener('mouseleave', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mouseup', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - actionsTopBar.offsetLeft;
    const walk = (x - startX) * 2; // ä¹˜ä»¥2å¯ä»¥å¢åŠ æ‹–åŠ¨é€Ÿåº¦ï¼Œæ„Ÿè§‰æ›´çµæ•
    actionsTopBar.scrollLeft = scrollLeft - walk;
});

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('location-cancel-btn').addEventListener('click', () => {
    document.getElementById('send-location-modal').classList.remove('visible');
});
document.getElementById('location-confirm-btn').addEventListener('click', sendUserLocation);
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ä¸ºå®šä½æ¨¡æ€æ¡†çš„â€œæ·»åŠ é€”ç»ç‚¹â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('add-trajectory-point-btn').addEventListener('click', () => {
    // é™åˆ¶æœ€å¤šæ·»åŠ 3ä¸ªé€”ç»ç‚¹ï¼Œé˜²æ­¢UIè¿‡äºæ‹¥æŒ¤
    if (document.querySelectorAll('.trajectory-point-input').length < 3) {
        addTrajectoryPointInput();
    } else {
        alert("æœ€å¤šåªèƒ½æ·»åŠ 3ä¸ªé€”ç»ç‚¹å“¦ï¼");
    }
});

// ã€æ–°å¢ã€‘æ‰“å¼€å®šä½æ¨¡æ€æ¡†æ—¶ï¼Œæ¸…ç©ºæ—§çš„é€”ç»ç‚¹
document.getElementById('send-location-btn').addEventListener('click', () => {
    document.getElementById('trajectory-points-container').innerHTML = '';
    document.getElementById('send-location-modal').classList.add('visible');
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('reroll-btn').addEventListener('click', handleRerollClick);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™æ•´å—äº‹ä»¶ç›‘å¬ä»£ç åˆ° init() æœ«å°¾ â–¼â–¼â–¼

// --- æ‚¬æµ®æ­Œè¯æ è®¾ç½®åŠŸèƒ½ ---
document.getElementById('lyrics-settings-btn').addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡è§¦å‘æ‹–åŠ¨æˆ–æ‰“å¼€æ’­æ”¾å™¨
    document.getElementById('lyrics-settings-modal').classList.add('visible');
});

document.getElementById('close-lyrics-settings-btn').addEventListener('click', async () => {
    // ä¿å­˜è®¾ç½®åˆ°å…¨å±€çŠ¶æ€å¹¶å†™å…¥æ•°æ®åº“
    state.globalSettings.lyricsBarSettings = lyricsBarSettings;
    await db.globalSettings.put(state.globalSettings);
    document.getElementById('lyrics-settings-modal').classList.remove('visible');
    alert('è®¾ç½®å·²ä¿å­˜ï¼');
});

document.getElementById('reset-lyrics-settings-btn').addEventListener('click', () => {
    // æ¢å¤åˆ°é»˜è®¤å€¼
    lyricsBarSettings = { fontSize: 14, bgOpacity: 0, fontColor: '#FFFFFF', showOnClose: true };
    applyLyricsSettings(); // åº”ç”¨é»˜è®¤è®¾ç½®
});

// å®æ—¶æ›´æ–°æ ·å¼
document.getElementById('lyrics-font-size-slider').addEventListener('input', (e) => {
    lyricsBarSettings.fontSize = e.target.value;
    applyLyricsSettings();
});
document.getElementById('lyrics-bg-opacity-slider').addEventListener('input', (e) => {
    lyricsBarSettings.bgOpacity = e.target.value;
    applyLyricsSettings();
});
document.getElementById('lyrics-font-color-picker').addEventListener('input', (e) => {
    lyricsBarSettings.fontColor = e.target.value;
    applyLyricsSettings();
});

// æ­Œè¯æ ä¸Šçš„å…³é—­æŒ‰é’®
document.querySelector('#floating-lyrics-bar .close-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('floating-lyrics-bar').style.display = 'none';
});

// æ’­æ”¾å™¨é‡Œçš„â€œæ‚¬æµ®/éšè—â€å¼€å…³
document.getElementById('toggle-lyrics-bar-btn').addEventListener('click', async (e) => {
    lyricsBarSettings.showOnClose = !lyricsBarSettings.showOnClose;
    e.target.textContent = lyricsBarSettings.showOnClose ? 'æ‚¬æµ®' : 'éšè—';
    e.target.style.opacity = lyricsBarSettings.showOnClose ? '1' : '0.5';
    // ç«‹å³ä¿å­˜è¿™ä¸ªè®¾ç½®
    state.globalSettings.lyricsBarSettings = lyricsBarSettings;
    await db.globalSettings.put(state.globalSettings);
});

// ã€é‡è¦ã€‘åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œå°±åº”ç”¨ä¸€æ¬¡å·²ä¿å­˜çš„è®¾ç½®
applyLyricsSettings();

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

            // 1. ç»‘å®šä¸»å±å¹•ä¸Šçš„â€œæŸ¥æ‰‹æœºâ€APPå›¾æ ‡
            const checkPhoneAppIcon = document.querySelector('.app-icon[data-app-id="check-phone"]');
            if (checkPhoneAppIcon) {
                checkPhoneAppIcon.onclick = openCharacterSelectionScreen; // ä¿®æ”¹onclickäº‹ä»¶
            }

            // 2. è§’è‰²é€‰æ‹©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
            document.getElementById('character-selection-list').addEventListener('click', (e) => {
                const item = e.target.closest('.character-select-item');
                if (item && item.dataset.chatId) {
                    openCharacterPhone(item.dataset.chatId);
                }
            });
// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ â–¼â–¼â–¼
// ã€V3ç‰ˆã€‘è§’è‰²æ‰‹æœºèŠå¤©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
document.getElementById('character-chat-list').addEventListener('click', (e) => {
    const item = e.target.closest('.chat-list-item');
    if (item && item.dataset.contactName) {
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ¢é’ˆ #2 â–¼â–¼â–¼
        const isUserChat = item.dataset.isUserChat === 'true';
        console.log("ã€è¯Šæ–­æ—¥å¿— 2ã€‘: ç‚¹å‡»äº†èŠå¤©åˆ—è¡¨é¡¹", {
            contactName: item.dataset.contactName,
            isUserChat: isUserChat
        });
        // â–²â–²â–² æ¢é’ˆç»“æŸ â–²â–²â–²
        
        // å°†è”ç³»äººåå­—å’Œâ€œèº«ä»½è¯â€ä¸€èµ·ä¼ é€’ç»™æ¸²æŸ“å‡½æ•°
        renderCharacterChatHistory(item.dataset.contactName, isUserChat);
        showCharacterPhonePage('character-chat-history-screen');
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



            // 3. è§’è‰²æ‰‹æœºé¡¶éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰é’®
            document.getElementById('generate-character-data-btn').addEventListener('click', generateCharacterPhoneData);
            document.getElementById('clear-character-data-btn').addEventListener('click', clearCharacterPhoneData);

            // â–²â–²â–² äº‹ä»¶ç›‘å¬å™¨æ·»åŠ ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå†…éƒ¨ç»Ÿä¸€è¿”å›äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            document.getElementById('character-phone-container').addEventListener('click', (e) => {
                const backBtn = e.target.closest('.back-btn');
                if (!backBtn) return;

                // æ£€æŸ¥æ˜¯è¿”å›åˆ°è§’è‰²æ‰‹æœºå†…éƒ¨é¡µé¢ï¼Œè¿˜æ˜¯è¿”å›åˆ°ä¸»å±å¹•
                if (backBtn.dataset.targetPage) {
                    showCharacterPhonePage(backBtn.dataset.targetPage);
                } else if (backBtn.dataset.targetScreen) {
                    showScreen(backBtn.dataset.targetScreen);
                }
            });
            // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºæ—¥è®°APPäº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            document.getElementById('character-app-grid').addEventListener('click', (e) => {
                const icon = e.target.closest('.app-icon');
                if (icon && icon.querySelector('.label').textContent === 'æ—¥è®°') {
                    renderCharacterDiary();
                }
            });
            document.getElementById('generate-diary-entry-btn').addEventListener('click', generateNewDiaryEntry);
            // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.item-delete-btn');
    if (deleteBtn) {
        // ã€æ–°å¢ã€‘å¤„ç†å¾®ä¿¡æ¶ˆæ¯åˆ é™¤
        if (deleteBtn.classList.contains('message-delete-btn')) {
            const contactName = deleteBtn.dataset.contactName;
            const index = parseInt(deleteBtn.dataset.index);
            if (contactName && !isNaN(index)) {
                handleCharacterChatMessageDeletion(contactName, index);
            }
        } 
        // å¤„ç†å…¶ä»–åˆ—è¡¨åˆ é™¤
        else {
            const dataType = deleteBtn.dataset.type;
            const index = parseInt(deleteBtn.dataset.index);
            if (dataType && !isNaN(index)) {
                handleCharacterDataDeletion(dataType, index);
            }
        }
    }
});
// â–²â–²â–² åˆ é™¤åŠŸèƒ½äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘NPCåº“ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// èŠå¤©è®¾ç½®é‡Œçš„â€œç®¡ç†NPCåº“â€æŒ‰é’®
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.id === 'manage-npcs-btn') {
        // å…ˆå…³é—­èŠå¤©è®¾ç½®ï¼Œå†æ‰“å¼€NPCç®¡ç†
        document.getElementById('chat-settings-modal').classList.remove('visible');
        openNpcManager();
    }
});

// NPCç®¡ç†ç•Œé¢çš„è¿”å›æŒ‰é’®
document.getElementById('back-from-npc-management').addEventListener('click', () => {
    // è¿”å›æ—¶ï¼Œé‡æ–°æ‰“å¼€èŠå¤©è®¾ç½®
    showScreen('chat-interface-screen');
    document.getElementById('chat-settings-btn').click();
});

// NPCç®¡ç†ç•Œé¢çš„â€œ+â€æŒ‰é’®
document.getElementById('add-new-npc-btn').addEventListener('click', () => openNpcEditor(null));



// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²˜è´´è¿™æ•´å—äº‹ä»¶ç›‘å¬å™¨ä»£ç  â–¼â–¼â–¼
// --- åå°æ´»åŠ¨è®¾ç½®ç•Œé¢çš„äº‹ä»¶ç»‘å®š ---

// 1. æ€»å¼€å…³çš„äº‹ä»¶
document.getElementById('background-activity-switch').addEventListener('change', () => {
    // æ¯æ¬¡ç‚¹å‡»æ€»å¼€å…³ï¼Œéƒ½é‡æ–°æ¸²æŸ“ä¸€æ¬¡è¯¦ç»†è®¾ç½®åŒºï¼ˆå®ƒä¼šæ ¹æ®å¼€å…³çŠ¶æ€è‡ªåŠ¨æ˜¾ç¤ºæˆ–éšè—ï¼‰
    renderBackgroundFrequencySelector();
});

// 2. å…¨é€‰æŒ‰é’®
document.getElementById('bg-select-all-chars').addEventListener('click', () => {
    document.querySelectorAll('.bg-char-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
});

// 3. å…¨ä¸é€‰æŒ‰é’®
document.getElementById('bg-deselect-all-chars').addEventListener('click', () => {
    document.querySelectorAll('.bg-char-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
});

// è¿™æ˜¯ä¿®å¤åçš„æ–°ä»£ç å—ï¼Œç”¨å®ƒæ›¿æ¢æ‰æ—§çš„
document.querySelector('#background-activity-details').addEventListener('click', async (e) => { // æ³¨æ„è¿™é‡ŒåŠ äº† async
    if (e.target.classList.contains('bg-freq-btn')) {
        const freq = e.target.dataset.freq;
        const selectedCheckboxes = document.querySelectorAll('.bg-char-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªè§’è‰²ï¼');
            return;
        }

        const config = state.globalSettings.backgroundActivityConfig || {};
        selectedCheckboxes.forEach(checkbox => {
            const chatId = checkbox.dataset.chatId;
            if (freq === 'none') {
                delete config[chatId];
            } else {
                config[chatId] = freq;
            }
        });
        
        state.globalSettings.backgroundActivityConfig = config;
        
        // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„å…³é”®ä»£ç ï¼â˜…â˜…â˜…
        await db.globalSettings.put(state.globalSettings);
        // â˜…â˜…â˜…â˜…â˜… æ·»åŠ ç»“æŸ â˜…â˜…â˜…â˜…â˜…
        
        renderBackgroundFrequencySelector();

        const freqTextMap = {low:'ä½', medium:'ä¸­', high:'é«˜', none: 'å…³é—­'};
        const freqText = freqTextMap[freq];
        alert(`å·²ä¸º ${selectedCheckboxes.length} ä¸ªè§’è‰²å°†åå°æ´»åŠ¨é¢‘ç‡è®¾ä¸º "${freqText}"`);
    }
});
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ ç»Ÿä¸€ç»‘å®šç‚¹å‡»äº‹ä»¶
// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ ç»Ÿä¸€ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('home-screen').addEventListener('click', async (e) => { // <-- æŠŠè¿™è¡Œä¹Ÿæ”¹æˆ async
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨ .closest() æ¥ç¡®ä¿å³ä½¿ç‚¹å‡»åˆ°å­å…ƒç´ ä¹Ÿèƒ½æ­£ç¡®è§¦å‘
    const editableText = e.target.closest('.editable-text');
    if (editableText) {
        handleEditText(editableText);
        return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œé¿å…é‡å¤è§¦å‘
    }

    const editableImage = e.target.closest('.editable-image');
    if (editableImage) {
        // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ ---
        // 1. åˆ¤æ–­è¢«ç‚¹å‡»çš„å›¾ç‰‡æ˜¯ä¸æ˜¯ä¸»å±å¹•çš„é‚£ä¸ªå¤§å¤´åƒ
        if (editableImage.id === 'profile-avatar-img') {
            // 2. å¦‚æœæ˜¯ï¼Œå°±å¼¹å‡ºä¸€ä¸ªé€‰æ‹©èœå•
            const choice = await showChoiceModal("ç¼–è¾‘å¤´åƒ", [
                { text: 'æ›´æ¢å¤´åƒå›¾ç‰‡', value: 'avatar' },
                { text: 'æ›´æ¢å¤´åƒæ¡†', value: 'frame' }
            ]);
            
            // 3. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œ
            if (choice === 'avatar') {
                handleEditImage(editableImage); // è°ƒç”¨åŸæ¥çš„æ›´æ¢å›¾ç‰‡å‡½æ•°
            } else if (choice === 'frame') {
                openFrameSelectorModal('home_profile'); // è°ƒç”¨æˆ‘ä»¬æ–°å¢çš„æ›´æ¢å¤´åƒæ¡†å‡½æ•°
            }
        } else {
            // 4. å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ä¸»å¤´åƒï¼ˆæ¯”å¦‚æ˜¯å…¶ä»–å°ç»„ä»¶çš„å›¾ç‰‡ï¼‰ï¼Œå°±è¿˜æ‰§è¡ŒåŸæ¥çš„é€»è¾‘
            handleEditImage(editableImage);
        }
        // --- â–²â–²â–² æ ¸å¿ƒä»£ç ä¿®æ”¹ç»“æŸ â–²â–²â–² ---
        return;
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
 * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¤„ç†åƒ bank.transactions è¿™æ ·çš„åµŒå¥—æ•°æ®
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break; // æ–°å¢
            case 'trajectory': renderCharacterTrajectory(); break;   // æ–°å¢
            case 'appUsage': renderCharacterAppUsage(); break;       // æ–°å¢
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;   // æ–°å¢
        }
        alert('è®°å½•å·²åˆ é™¤ã€‚');
    }
}
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    if (e.target.classList.contains('item-delete-btn')) {
        const dataType = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        if (dataType && !isNaN(index)) {
            handleCharacterDataDeletion(dataType, index);
        }
    }
});
// â–²â–²â–² åˆ é™¤åŠŸèƒ½ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½ â–¼â–¼â–¼
/**
 * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
 * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
 * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
 */
async function handleCharacterDataDeletion(dataType, index) {
    if (!activeCharacterPhoneId) return;
    const chat = state.chats[activeCharacterPhoneId];
    
    let dataArray;
    // å¤„ç†åƒ bank.transactions è¿™æ ·çš„åµŒå¥—æ•°æ®
    if (dataType.includes('.')) {
        const keys = dataType.split('.');
        dataArray = chat.characterPhoneData[keys[0]][keys[1]];
    } else {
        dataArray = chat.characterPhoneData[dataType];
    }

    if (!chat || !dataArray) return;

    const itemToDelete = dataArray[index];
    if (!itemToDelete) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        dataArray.splice(index, 1);
        await db.chats.put(chat);
        
        // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
        switch(dataType) {
            case 'memos': renderCharacterMemos(); break;
            case 'shoppingCart': renderCharacterShoppingCart(); break;
            case 'browserHistory': renderCharacterBrowser(); break;
            case 'diary': renderCharacterDiary(); break;
            case 'bank.transactions': renderCharacterBank(); break;
            case 'trajectory': renderCharacterTrajectory(); break;
            case 'appUsage': renderCharacterAppUsage(); break;
            case 'photoAlbum': renderCharacterPhotoAlbum(); break;
        }
        alert('è®°å½•å·²åˆ é™¤ã€‚');
    }
}
// â–²â–²â–² åˆ é™¤åŠŸèƒ½ç»“æŸ â–²â–²â–²
startGroupSimulation(); // å¯åŠ¨ç¾¤èŠä¸“å±çš„åå°æ—¶é’Ÿ
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼ æ­¥éª¤3.3ï¼šåœ¨ init() çš„å‰é¢ç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ•´ä¸ªåŠ¨æ€åˆ—è¡¨çš„â€œç„¦ç‚¹ç§»å‡ºâ€äº‹ä»¶
    document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
        // å¦‚æœæ˜¯è¯„è®ºè¾“å…¥æ¡†å¤±å»äº†ç„¦ç‚¹
        if (e.target.classList.contains('comment-input')) {
            const commentInput = e.target;
            // å¹¶ä¸”è¾“å…¥æ¡†æ˜¯ç©ºçš„
            if (commentInput.value.trim() === '') {
                // å°±é‡ç½®å®ƒçš„çŠ¶æ€ï¼Œå–æ¶ˆå›å¤
                commentInput.placeholder = 'å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹';
                delete commentInput.dataset.replyTo;
            }
        }
    });
    // â–²â–²â–² æ­¥éª¤3.3ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—ä»£ç ï¼Œç²˜è´´åˆ° init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘ä¸ºæ—¶é—´æ„ŸçŸ¥å¼€å…³æ·»åŠ å®æ—¶äº¤äº’äº‹ä»¶
document.getElementById('time-perception-toggle').addEventListener('change', (e) => {
    const customTimeContainer = document.getElementById('custom-time-container');
    customTimeContainer.style.display = e.target.checked ? 'none' : 'block';
});
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// è¯·ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢ä¸Šé¢çš„é”™è¯¯ä»£ç 
document.getElementById('char-heart-btn').addEventListener('click', openInnerVoiceModal);

document.getElementById('close-inner-voice-modal').addEventListener('click', () => {
    document.getElementById('inner-voice-modal').classList.remove('visible');
});
document.getElementById('inner-voice-history-btn').addEventListener('click', toggleInnerVoiceHistory);
document.getElementById('back-from-history-btn').addEventListener('click', toggleInnerVoiceHistory);
// â–²â–²â–² å¿ƒå£°åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™ä¸€æ•´å—æ–°å‡½æ•°ï¼Œç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¯¼å‡ºå½“å‰è§’è‰²çš„èŠå¤©è®°å½•
 */
async function exportChatHistory() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. åˆ›å»ºä¸€ä¸ªåªåŒ…å«èŠå¤©è®°å½•å’Œè§’è‰²åçš„å¯¹è±¡
    const exportData = {
        characterName: chat.name,
        exportedAt: new Date().toISOString(),
        history: chat.history
    };

    // 2. å°†è¿™ä¸ªå¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸²
    const jsonString = JSON.stringify(exportData, null, 2);
    
    // 3. åˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // 4. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    // 5. è®¾ç½®ä¸‹è½½é“¾æ¥çš„å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å
    const dateStr = new Date().toISOString().split('T')[0];
    link.href = url;
    link.download = `[${chat.name}]-èŠå¤©è®°å½•-${dateStr}.json`;
    
    // 6. æ¨¡æ‹Ÿç‚¹å‡»é“¾æ¥æ¥è§¦å‘ä¸‹è½½
    document.body.appendChild(link);
    link.click();
    
    // 7. æ¸…ç†ä¸´æ—¶åˆ›å»ºçš„å…ƒç´ å’ŒURL
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    await showCustomAlert('å¯¼å‡ºæˆåŠŸ', `ä¸â€œ${chat.name}â€çš„èŠå¤©è®°å½•å·²å¼€å§‹ä¸‹è½½ï¼`);
}

/**
 * ã€å…¨æ–°ã€‘å¯¼å…¥èŠå¤©è®°å½•åˆ°å½“å‰è§’è‰²
 */
async function importChatHistory(file) {
    if (!file) return;
    if (!state.activeChatId) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);

            // å…³é”®éªŒè¯ï¼šæ£€æŸ¥å¯¼å…¥çš„æ–‡ä»¶æ˜¯å¦åŒ…å«ä¸€ä¸ªåä¸º 'history' çš„æ•°ç»„
            if (!data.history || !Array.isArray(data.history)) {
                throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘æœ‰æ•ˆçš„'history'æ•°æ®ã€‚");
            }

            const chat = state.chats[state.activeChatId];
            
            // å®‰å…¨è­¦å‘Šï¼šæé†’ç”¨æˆ·è¿™å°†è¦†ç›–ç°æœ‰è®°å½•
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤å¯¼å…¥',
                `è¿™å°†ä¼šã€è¦†ç›–ã€‘ä½ ä¸â€œ${chat.name}â€çš„å½“å‰æ‰€æœ‰èŠå¤©è®°å½•ã€‚æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`,
                { confirmButtonClass: 'btn-danger' }
            );

            if (confirmed) {
                // æ›¿æ¢å†å²è®°å½•
                chat.history = data.history;
                // ä¿å­˜åˆ°æ•°æ®åº“
                await db.chats.put(chat);
                // åˆ·æ–°ç•Œé¢
                renderChatInterface(state.activeChatId);
                renderChatList(); // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'èŠå¤©è®°å½•å·²æˆåŠŸå¯¼å…¥å¹¶è¦†ç›–ï¼');
            }
        } catch (error) {
            console.error("å¯¼å…¥èŠå¤©è®°å½•å¤±è´¥:", error);
            await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ— æ³•å¯¼å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæ­£ç¡®çš„èŠå¤©è®°å½•å¤‡ä»½æ–‡ä»¶ã€‚\n\né”™è¯¯: ${error.message}`);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡æ ·å¼é¢„è®¾å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ â–¼â–¼â–¼

/**
 * å¯¼å‡ºå½“å‰é€‰ä¸­çš„æ°”æ³¡æ ·å¼é¢„è®¾
 */
async function exportSelectedBubblePreset() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (!selectedId) {
        alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„é¢„è®¾ã€‚");
        return;
    }

    const preset = await db.bubbleStylePresets.get(selectedId);
    if (!preset) {
        alert("æ‰¾ä¸åˆ°é€‰ä¸­çš„é¢„è®¾ã€‚");
        return;
    }

    // å‡†å¤‡è¦å¯¼å‡ºçš„æ•°æ®
    const exportData = {
        presetName: preset.name,
        presetCss: preset.css
    };

    // åˆ›å»ºå¹¶è§¦å‘ä¸‹è½½
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `[EPhoneæ°”æ³¡]${preset.name}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/**
 * å¤„ç†å¯¼å…¥çš„æ°”æ³¡æ ·å¼é¢„è®¾æ–‡ä»¶
 * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„.jsonæ–‡ä»¶
 */
function importBubblePreset(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // éªŒè¯æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®
            if (data.presetName && typeof data.presetCss !== 'undefined') {
                const newPreset = {
                    name: `${data.presetName} (å¯¼å…¥)`,
                    css: data.presetCss
                };
                const newId = await db.bubbleStylePresets.add(newPreset);

                if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
                state.bubbleStylePresets.push({ id: newId, ...newPreset });

                // åˆ·æ–°ä¸‹æ‹‰æ¡†å¹¶è‡ªåŠ¨é€‰ä¸­æ–°å¯¼å…¥çš„é¢„è®¾
                renderBubblePresetSelector();
                document.getElementById('bubble-style-preset-select').value = newId;
                handlePresetSelectChange();
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', `æ°”æ³¡é¢„è®¾ "${newPreset.name}" å·²æˆåŠŸå¯¼å…¥ï¼`);
            } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch (error) {
            alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚ ${error.message}`);
        }
    };
    reader.readAsText(file);
}

// â–²â–²â–² æ–°å¢åŠŸèƒ½å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ã€å’Œå¾®åšç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä¸Šé¢é‚£æ®µæ—§ä»£ç  â–¼â–¼â–¼
document.getElementById('weibo-app-icon').addEventListener('click', () => {
    renderWeiboProfile(); // æ¸²æŸ“ä¸ªäººèµ„æ–™
    renderMyWeiboFeed(); // <-- å°±æ˜¯æ–°å¢äº†è¿™ä¸€è¡Œï¼ä¸»åŠ¨æ¸²æŸ“â€œæˆ‘çš„å¾®åšâ€åˆ—è¡¨
    switchToWeiboView('weibo-my-profile-view'); // é»˜è®¤æ˜¾ç¤ºâ€œæˆ‘çš„å¾®åšâ€
    showScreen('weibo-screen');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// 2. ç»‘å®šå¾®åšé¡µé¢å†…çš„å„ç§ç‚¹å‡»äº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
document.getElementById('weibo-screen').addEventListener('click', async (e) => {
    // --- ã€å…¨æ–°ã€‘å¤„ç†å¾®åšå¸–å­ä¸­å¤´åƒç‚¹å‡»çš„é€»è¾‘ ---
    const avatarWrapper = e.target.closest('.weibo-post-avatar-clickable');
    if (avatarWrapper) {
        const charId = avatarWrapper.dataset.charId;
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç”¨æˆ·è‡ªå·±ï¼Œå°±æ‰“å¼€TAçš„ä¸»é¡µ
        if (charId && charId !== 'user') {
            openWeiboCharProfile(charId);
        }
        return; // å¤„ç†å®Œå°±ç»“æŸï¼Œä¸å†æ‰§è¡Œåé¢çš„é€»è¾‘
    }
    
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    const target = e.target;
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
            // â–¼â–¼â–¼ åœ¨ 'const target = e.target;' çš„ä¸‹ä¸€è¡Œï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

            // --- ã€å…¨æ–°ã€‘å¤„ç†çƒ­æœå’Œå¹¿åœºå¸–å­çš„åˆ é™¤æŒ‰é’® ---
            const deleteBtn = target.closest('.weibo-post-delete-btn');
            if (deleteBtn) {
                const postItem = deleteBtn.closest('.weibo-post-item');
                if (postItem) {
                    // å…ˆç»™ç”¨æˆ·ä¸€ä¸ªç¡®è®¤çš„æœºä¼šï¼Œé˜²æ­¢è¯¯åˆ 
                    const confirmed = await showCustomConfirm(
                        'åˆ é™¤åŠ¨æ€',
                        'ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿï¼ˆæ­¤æ“ä½œä»…åœ¨æœ¬é¡µé¢ç”Ÿæ•ˆï¼‰',
                        { confirmButtonClass: 'btn-danger' }
                    );
                    
                    if (confirmed) {
                        // å¦‚æœç”¨æˆ·ç¡®è®¤ï¼Œå°±æ’­æ”¾ä¸€ä¸ªå¥½çœ‹çš„æ¶ˆå¤±åŠ¨ç”»ï¼Œç„¶åç§»é™¤å¸–å­
                        postItem.style.transition = 'opacity 0.3s, transform 0.3s';
                        postItem.style.opacity = '0';
                        postItem.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            postItem.remove();
                        }, 300); // ç­‰åŠ¨ç”»æ’­æ”¾å®Œå†å½»åº•åˆ é™¤
                    }
                }
                return; // â˜…â˜…â˜… å…³é”®ï¼å¤„ç†å®Œåˆ é™¤åï¼Œå¿…é¡»ç«‹åˆ»ç»“æŸï¼Œé˜²æ­¢è§¦å‘ä¸‹é¢çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶
            }
            
            // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// ã€æ ¸å¿ƒä¿®å¤ã€‘å¤„ç†å¾®åšä¸­çš„â€œæ–‡å­—å›¾â€ç‚¹å‡»äº‹ä»¶
if (target.classList.contains('weibo-post-image') && target.dataset.hiddenText) {
    showCustomAlert("å›¾ç‰‡å†…å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
    return; // å¤„ç†å®Œåï¼Œç«‹åˆ»é€€å‡ºï¼Œé¿å…è§¦å‘å…¶ä»–é€»è¾‘
}
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

    const postItem = target.closest('.weibo-post-item');
    const postId = postItem ? parseInt(postItem.dataset.postId) : null;

    // --- å¤„ç†â€œåˆ é™¤è¯„è®ºâ€æŒ‰é’® ---
    const deleteCommentBtn = target.closest('.comment-delete-btn');
    if (deleteCommentBtn) {
        const commentItem = deleteCommentBtn.closest('.weibo-comment-item');
        if (postId && commentItem && commentItem.dataset.commentId) {
            deleteWeiboComment(postId, commentItem.dataset.commentId);
        }
        return;
    }

    // --- å¤„ç†â€œç”Ÿæˆè¯„è®ºâ€æŒ‰é’® ---
    const generateBtn = target.closest('.generate-comments-btn');
    if (generateBtn) {
        if (postId) {
            generateWeiboComments(postId);
        }
        return; 
    }

    // --- å¤„ç†åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢ ---
    const navItem = target.closest('.weibo-nav-item');
    if (navItem && navItem.dataset.view) {
        switchToWeiboView(navItem.dataset.view);
        return;
    }

// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼

            const actionsBtn = target.closest('.post-actions-btn');
            if (actionsBtn) {
                // æ ¸å¿ƒä¿®æ­£1ï¼šä»æŒ‰é’®æœ¬èº«è·å–æ­£ç¡®çš„ postId
                const postId = parseInt(actionsBtn.dataset.postId);

                const confirmed = await showCustomConfirm('åˆ é™¤å¾®åš', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡å¾®åšå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' });
                
                // æ ¸å¿ƒä¿®æ­£2ï¼šæ£€æŸ¥ postId æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—
                if (confirmed && !isNaN(postId)) { 
                    await db.weiboPosts.delete(postId);
                    // åˆ é™¤åï¼Œåˆ·æ–°æ‰€æœ‰ç›¸å…³çš„å¾®åšåˆ—è¡¨å’Œä¸ªäººèµ„æ–™
                    await renderMyWeiboFeed(); 
                    await renderFollowingWeiboFeed();
                    await renderWeiboProfile();
                    alert('å¾®åšå·²åˆ é™¤ã€‚');
                }
                return;
            }

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    
    // --- å¤„ç†ç‚¹èµã€è¯„è®ºã€å›å¤ ---
    if (target.closest('.like-btn')) { if (postId) handleWeiboLike(postId); return; }
    if (target.closest('.weibo-comment-send-btn')) { const input = postItem.querySelector('.weibo-comment-input'); if (postId && input) handleWeiboComment(postId, input); return; }
    
    const commentItem = target.closest('.weibo-comment-item');
    if (commentItem) {
        const commenterName = commentItem.dataset.commenterName;
        const commentId = commentItem.dataset.commentId;
        const input = postItem.querySelector('.weibo-comment-input');
        if (input.dataset.replyToId === commentId) {
            input.placeholder = 'ç•™ä¸‹ä½ çš„ç²¾å½©è¯„è®ºå§...';
            delete input.dataset.replyToId; delete input.dataset.replyToNickname;
        } else {
            input.placeholder = `å›å¤ @${commenterName}:`;
            input.dataset.replyToId = commentId; input.dataset.replyToNickname = commenterName;
            input.focus();
        }
        return;
    }
});

// 3. ã€æ ¸å¿ƒã€‘ä¸ºå¾®åšä¸ªäººä¸»é¡µçš„æ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ ï¼Œç»‘å®šä¸“å±çš„ç¼–è¾‘å‡½æ•°
// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ weibo-profile-page äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('weibo-profile-page').addEventListener('click', async (e) => {
    const target = e.target;
    
    // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼ ---
    if (target.id === 'weibo-avatar-img' || target.closest('.weibo-avatar-container')) {
        // 1. å¼¹å‡ºä¸€ä¸ªé€‰æ‹©èœå•ï¼Œè®©ç”¨æˆ·å†³å®šæ˜¯æ¢å¤´åƒè¿˜æ˜¯æ¢æ¡†
        const choice = await showChoiceModal("ç¼–è¾‘å¤´åƒ", [
            { text: 'æ›´æ¢å¤´åƒå›¾ç‰‡', value: 'avatar' },
            { text: 'æ›´æ¢å¤´åƒæ¡†', value: 'frame' }
        ]);
        
        // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œ
        if (choice === 'avatar') {
            editWeiboAvatar(); // è°ƒç”¨åŸæ¥çš„æ›´æ¢å¤´åƒå‡½æ•°
        } else if (choice === 'frame') {
            openFrameSelectorModal('weibo_profile'); // è°ƒç”¨æˆ‘ä»¬æ–°å¢çš„æ›´æ¢å¤´åƒæ¡†å‡½æ•°
        }
        return; // å¤„ç†å®Œåç›´æ¥é€€å‡º
    } 
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    else if (target.id === 'weibo-nickname') {
        editWeiboNickname();
    } 
    else if (target.id === 'weibo-user-profession-display') {
        openWeiboUserSettingsModal();
    } 
    else if (target.id === 'weibo-background-img') {
        editWeiboBackground();
    } else if (target.closest('#weibo-fans-item')) {
        editWeiboFansCount();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// 4. ã€æ ¸å¿ƒã€‘ä¸ºâ€œå…³æ³¨â€æ•°å­—å’Œâ€œå‘å¸ƒå¾®åšâ€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('weibo-following-btn').addEventListener('click', showFollowingList);
document.getElementById('create-weibo-post-btn').addEventListener('click', openWeiboPublisherClean);
document.getElementById('close-following-list-btn').addEventListener('click', () => {
    document.getElementById('weibo-following-modal').classList.remove('visible');
});
document.getElementById('clear-following-feed-btn').addEventListener('click', clearFollowingFeed);

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²éšè—å¯è§èŒƒå›´ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ openWeiboPublisherClean å‡½æ•° â–¼â–¼â–¼
function openWeiboPublisherClean() {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal(); 
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œå¾®åšâ€æ¨¡å¼ï¼Œå¹¶ä¿®æ”¹æ ‡é¢˜å’Œæç¤ºè¯­
    modal.dataset.mode = 'weibo';
    document.getElementById('create-post-modal-title').textContent = 'å‘å¾®åš';
    document.getElementById('post-public-text').placeholder = 'æœ‰ä»€ä¹ˆæ–°é²œäº‹æƒ³åˆ†äº«ç»™å¤§å®¶ï¼Ÿ';

    // 3. ç¡®ä¿æ‰€æœ‰â€œåŠ¨æ€â€ä¸“å±çš„HTMLå…ƒç´ éƒ½è¢«éšè—
    const imageDescGroup = document.getElementById('post-image-desc-group');
    if (imageDescGroup) imageDescGroup.style.display = 'none';
    
    const commentsToggleGroup = document.getElementById('post-comments-toggle-group');
    if (commentsToggleGroup) commentsToggleGroup.style.display = 'none';

    // â–¼â–¼â–¼ å°±æ˜¯åœ¨è¿™é‡Œæ–°å¢äº†ä¸€è¡Œä»£ç ï¼â–¼â–¼â–¼
    const visibilityGroup = document.getElementById('post-visibility-group');
    if (visibilityGroup) visibilityGroup.style.display = 'none';
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    // 4. æ˜¾ç¤ºå¾®åšéœ€è¦çš„æ§ä»¶
    const modeSwitcher = document.getElementById('post-mode-switcher');
    if (modeSwitcher) modeSwitcher.style.display = 'flex';
    
    // 5. æ˜¾ç¤ºå¼¹çª—
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


document.getElementById('close-following-list-btn').addEventListener('click', () => {
    document.getElementById('weibo-following-modal').classList.remove('visible');
});
document.getElementById('clear-following-feed-btn').addEventListener('click', clearFollowingFeed);

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ `editWeiboProfileBtn` äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
    // ã€å…¨æ–°ã€‘å¾®åšç”¨æˆ·äººè®¾è®¾ç½®åŠŸèƒ½äº‹ä»¶ç»‘å®š
    document.getElementById('edit-weibo-profile-btn').addEventListener('click', openWeiboUserSettingsModal);
    document.getElementById('cancel-weibo-user-settings-btn').addEventListener('click', () => {
        document.getElementById('weibo-user-settings-modal').classList.remove('visible');
    });
    document.getElementById('save-weibo-user-settings-btn').addEventListener('click', saveWeiboUserSettings);
    document.getElementById('weibo-user-preset-select').addEventListener('change', handleWeiboUserPresetSelection);
    document.getElementById('manage-weibo-user-presets-btn').addEventListener('click', openWeiboUserPresetManager);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®ºå›åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// 1. åˆå§‹åŒ–æ—¶åˆ›å»ºé»˜è®¤å°ç»„
await initializeDefaultGroups();

// 2. å½“ç”¨æˆ·ç‚¹å‡»â€œåœˆå­â€Appå›¾æ ‡æ—¶ï¼Œæ¸²æŸ“å°ç»„åˆ—è¡¨
document.querySelector('.desktop-app-icon[onclick="showScreen(\'forum-screen\')"]').addEventListener('click', renderForumScreen);

// 3. ç»‘å®šå°ç»„é¡µå’Œå¸–å­é¡µçš„è¿”å›æŒ‰é’®
document.getElementById('back-to-forum-list').addEventListener('click', () => showScreen('forum-screen'));
document.getElementById('back-to-group-screen').addEventListener('click', () => openGroup(activeGroupId, document.getElementById('group-screen-title').textContent));

// 4. ç»‘å®šå¸–å­è¯„è®ºåŒºçš„å‘é€æŒ‰é’®
document.getElementById('send-post-comment-btn').addEventListener('click', handleAddComment);

// è¿™æ˜¯ã€ä¿®å¤åã€‘çš„ä»£ç 
document.getElementById('trigger-fanfic-generation-btn').addEventListener('click', () => {
    // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œåœ¨ç‚¹å‡»æ—¶è·å–å¹¶ä¼ å…¥å½“å‰çš„ activeGroupId
    generateFanfic(activeGroupId);
});


// ç»‘å®šæ‰€æœ‰å°ç»„å¤´éƒ¨é€šç”¨çš„â€œç”Ÿæˆâ€æŒ‰é’®
document.getElementById('generate-group-content-btn').addEventListener('click', handleGenerateGroupContent);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// 6. ç»‘å®šå¸–å­è¯¦æƒ…é¡µçš„â€œè½¬è½½â€æŒ‰é’®
document.getElementById('repost-to-chat-btn').addEventListener('click', repostToChat);

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°ä¸­ï¼Œç”¨ã€è¿™ä¸€è¡Œã€‘æ›¿æ¢æ—§çš„ create-group-btn ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('create-group-btn').addEventListener('click', openGroupCreator);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢ â–¼â–¼â–¼
document.getElementById('create-forum-post-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†å¼¹çª—æç¤ºï¼Œè€Œæ˜¯è°ƒç”¨ä¸€ä¸ªæ–°å‡½æ•°æ¥æ‰“å¼€çœŸæ­£çš„å‘å¸–çª—å£
    openCreateForumPostModal(); 
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™å—ã€æ–°ä»£ç ã€‘ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºå¸–å­è¯¦æƒ…é¡µçš„â€œç”Ÿæˆè¯„è®ºâ€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('post-detail-content').addEventListener('click', (e) => {
    if (e.target.id === 'generate-forum-comments-btn') {
        generateForumComments();
    }
});

// åœ¨ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥è¯„è®ºåï¼Œå¦‚æœè¾“å…¥æ¡†ä¸ºç©ºå°±å¤±å»ç„¦ç‚¹æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆå›å¤çŠ¶æ€
document.getElementById('post-comment-input').addEventListener('blur', (e) => {
    const input = e.target;
    if (input.value.trim() === '') {
        input.placeholder = 'å‘å¸ƒä½ çš„è¯„è®º...';
        delete input.dataset.replyTo;
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰è½¬è½½çš„å¸–å­å¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const repostCard = e.target.closest('.link-share-card[data-post-id]');
    if (repostCard) {
        const postId = parseInt(repostCard.dataset.postId);
        if (!isNaN(postId)) {
            // è°ƒç”¨ä½ å·²ç»å†™å¥½çš„â€œæ‰“å¼€å¸–å­â€å‡½æ•°
            openPost(postId);
        }
    }
});

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è®ºå›å¸–å­åˆ—è¡¨äº‹ä»¶å§”æ‰˜ â–¼â–¼â–¼
document.getElementById('group-post-list').addEventListener('click', async (e) => {
    const postItem = e.target.closest('.forum-post-item');
    if (!postItem) return;

    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
    if (e.target.classList.contains('forum-post-delete-btn')) {
        const postId = postItem.dataset.postId;
        if (!postId) return;
        
        const post = await db.forumPosts.get(parseInt(postId));
        if (!post) return;

        const confirmed = await showCustomConfirm(
            'åˆ é™¤å¸–å­', 
            `ç¡®å®šè¦åˆ é™¤å¸–å­ã€Š${post.title}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤å¸–å­ä¸‹çš„æ‰€æœ‰è¯„è®ºï¼Œä¸”æ— æ³•æ¢å¤ã€‚`, 
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            try {
                // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ¥ç¡®ä¿å¸–å­å’Œè¯„è®ºè¢«åŒæ—¶åˆ é™¤
                await db.transaction('rw', db.forumPosts, db.forumComments, async () => {
                    // 1. åˆ é™¤æ‰€æœ‰ä¸è¯¥å¸–å­å…³è”çš„è¯„è®º
                    await db.forumComments.where('postId').equals(parseInt(postId)).delete();
                    // 2. åˆ é™¤å¸–å­æœ¬èº«
                    await db.forumPosts.delete(parseInt(postId));
                });

                await showCustomAlert('åˆ é™¤æˆåŠŸ', 'å¸–å­åŠå…¶æ‰€æœ‰è¯„è®ºå·²è¢«åˆ é™¤ã€‚');
                // åˆ·æ–°å¸–å­åˆ—è¡¨
                await renderGroupPosts(activeGroupId);
            } catch (error) {
                console.error('åˆ é™¤å¸–å­å¤±è´¥:', error);
                await showCustomAlert('åˆ é™¤å¤±è´¥', `æ“ä½œå¤±è´¥: ${error.message}`);
            }
        }
    } else {
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œé‚£å°±æ˜¯ç‚¹å‡»äº†å¸–å­æœ¬èº«ï¼Œæ‰§è¡Œè·³è½¬é€»è¾‘
        const postId = postItem.dataset.postId;
        if (postId) {
            openPost(parseInt(postId));
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°ç»„é«˜çº§åŠŸèƒ½äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼

// 1. ä¸ºâ€œåœˆå­â€ä¸»é¡µå³ä¸Šè§’çš„â€œ+â€æŒ‰é’®ï¼Œç»‘å®šåˆ›å»ºå°ç»„çš„äº‹ä»¶
document.getElementById('create-group-btn').addEventListener('click', openGroupCreator);

// 2. ä¸ºå°ç»„ç¼–è¾‘å™¨å¼¹çª—çš„â€œä¿å­˜â€å’Œâ€œå–æ¶ˆâ€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('save-group-editor-btn').addEventListener('click', saveGroupSettings);
document.getElementById('cancel-group-editor-btn').addEventListener('click', () => {
    document.getElementById('forum-group-editor-modal').classList.remove('visible');
});

// 3. ä¸ºåˆ†ç±»ç®¡ç†å¼¹çª—çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('add-new-forum-category-btn').addEventListener('click', addNewForumCategory);
document.getElementById('close-forum-category-manager-btn').addEventListener('click', () => {
    document.getElementById('forum-category-manager-modal').classList.remove('visible');
});

// 4. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºåˆ†ç±»åˆ—è¡¨ä¸­çš„â€œåˆ é™¤â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('existing-forum-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) { // å¤ç”¨æ ·å¼
        const categoryId = parseInt(e.target.dataset.id);
        deleteForumCategory(categoryId);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²


// â–²â–²â–² è®ºå›äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„æœ«å°¾ï¼Œå°±åœ¨ init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

// --- å¡”ç½—ç‰Œå åœåŠŸèƒ½äº‹ä»¶ç»‘å®š ---
document.getElementById('open-tarot-btn').addEventListener('click', openTarotModal);
document.getElementById('close-tarot-modal-btn').addEventListener('click', () => {
    document.getElementById('tarot-divination-modal').classList.remove('visible');
});
document.getElementById('draw-tarot-cards-btn').addEventListener('click', handleDrawCards);
document.getElementById('back-to-tarot-setup-btn').addEventListener('click', () => {
    document.getElementById('tarot-result-view').style.display = 'none';
    document.getElementById('tarot-setup-view').style.display = 'block';
});
document.getElementById('send-tarot-result-btn').addEventListener('click', sendTarotReadingToChat);
document.getElementById('tarot-history-btn').addEventListener('click', openTarotHistory);
document.getElementById('back-to-tarot-main-btn').addEventListener('click', () => {
    document.getElementById('tarot-history-view').style.display = 'none';
    document.getElementById('tarot-setup-view').style.display = 'block';
});
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å†å²è®°å½•çš„åˆ é™¤æŒ‰é’®
document.getElementById('tarot-history-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('tarot-history-delete-btn')) {
        const readingId = parseInt(e.target.dataset.id);
        if (!isNaN(readingId)) {
            deleteTarotReading(readingId);
        }
    }
});

// --- å¡”ç½—ç‰Œå åœåŠŸèƒ½äº‹ä»¶ç»‘å®šç»“æŸ ---

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// â–¼â–¼â–¼ ç¬¬3æ­¥.3ï¼šåœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('ls-change-bg-btn').addEventListener('click', handleChangeLoversSpaceBackground);
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// ç»‘å®šä¸»å±å¹•Appå›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('lovers-space-app-icon').addEventListener('click', openLoversSpaceEntry);

// â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢ â–¼â–¼â–¼
document.getElementById('ls-char-selector-list').addEventListener('click', async (e) => {
    const item = e.target.closest('.chat-list-item');
    if (item && item.dataset.chatId) {
        const chatId = item.dataset.chatId;
        const chat = state.chats[chatId];
        
        // å…³é—­é€‰æ‹©å¼¹çª—
        document.getElementById('ls-char-selector-modal').classList.remove('visible');
        
        // ã€æ ¸å¿ƒé€»è¾‘ã€‘åˆ¤æ–­æƒ…ä¾£ç©ºé—´çŠ¶æ€
        if (chat.loversSpaceData) {
            // å¦‚æœå·²å¼€é€šï¼Œç›´æ¥è¿›å…¥
            openLoversSpace(chatId);
        } else {
            // å¦‚æœæœªå¼€é€šï¼Œå¼¹çª—ç¡®è®¤æ˜¯å¦å‘é€é‚€è¯·
            const confirmed = await showCustomConfirm(
                'é‚€è¯·å¼€å¯æƒ…ä¾£ç©ºé—´',
                `ä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´è¿˜æœªå¼€å¯ï¼Œè¦ç°åœ¨é‚€è¯·Taå—ï¼Ÿ`
            );
            if (confirmed) {
                // å¦‚æœç”¨æˆ·ç¡®è®¤ï¼Œå‘é€é‚€è¯·å¹¶è·³è½¬åˆ°èŠå¤©ç•Œé¢
                await sendLoversSpaceInvitation(chatId);
                openChat(chatId);
            }
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('ls-cancel-switch-char-btn').addEventListener('click', () => {
    document.getElementById('ls-char-selector-modal').classList.remove('visible');
});
document.getElementById('ls-switch-char-btn').addEventListener('click', openCharSelectorForLoversSpace);

// â–¼â–¼â–¼ ç”¨è¿™å—ã€ä¿®å¤åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ 'ls-tab-bar' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šé¡µç­¾åˆ‡æ¢äº‹ä»¶
document.getElementById('ls-tab-bar').addEventListener('click', (e) => {
    const tab = e.target.closest('.ls-tab-item');
    if (tab && tab.dataset.view) {
        const viewId = tab.dataset.view;
        // 1. åˆ‡æ¢é«˜äº®å’Œè§†å›¾
        document.querySelectorAll('.ls-tab-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        switchLoversSpaceTab(viewId);

        // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘æ ¹æ®ç‚¹å‡»çš„é¡µç­¾ï¼Œæ¸²æŸ“å¯¹åº”çš„å†…å®¹
        const chat = state.chats[activeLoversSpaceCharId];
        if (!chat) return;

        if (viewId === 'ls-moments-view') {
            renderLSMoments(chat.loversSpaceData.moments, chat);
        } else if (viewId === 'ls-album-view') {
            renderLSPhotos(chat.loversSpaceData.photos, chat);
        } else if (viewId === 'ls-letters-view') {
            renderLSLetters(chat.loversSpaceData.loveLetters, chat);
        } else if (viewId === 'ls-questions-view') {
            // è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„é€»è¾‘ï¼
            renderLSQuestions(chat.loversSpaceData.questions, chat);    
        }
        else if (viewId === 'ls-diary-view') {
    const now = new Date();
    renderLSDiaryView(now.getFullYear(), now.getMonth() + 1);
}
    else if (viewId === 'ls-shares-view') {
        renderLSShares(chat.loversSpaceData.shares, chat);
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™3è¡Œæ–°ä»£ç  â–¼â–¼â–¼
    else if (viewId === 'ls-pomodoro-view') {
        openPomodoroScreen();
    }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// ç»‘å®šâ€œè¯´è¯´â€åŠŸèƒ½çš„æŒ‰é’®
document.getElementById('ls-add-moment-btn').addEventListener('click', openMomentCreator);
document.getElementById('ls-cancel-moment-btn').addEventListener('click', () => {
    document.getElementById('ls-create-moment-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-moment-btn').addEventListener('click', handlePostMoment);

// ç»‘å®šâ€œç›¸å†Œâ€åŠŸèƒ½çš„æŒ‰é’®
document.getElementById('ls-add-album-btn').addEventListener('click', openAlbumCreator);
document.getElementById('ls-select-photos-btn').addEventListener('click', () => {
    document.getElementById('ls-photo-input').click();
});
document.getElementById('ls-photo-input').addEventListener('change', (e) => {
    handlePhotoSelection(e.target.files);
});
// ç»‘å®šæ–°å¼¹çª—é‡Œçš„æ¨¡å¼åˆ‡æ¢æŒ‰é’®
const lsImageModeBtn = document.getElementById('ls-switch-to-image-mode');
const lsTextImageModeBtn = document.getElementById('ls-switch-to-text-image-mode');
const lsImageModeContent = document.getElementById('ls-image-mode-content');
const lsTextImageModeContent = document.getElementById('ls-text-image-mode-content');
// â–¼â–¼â–¼ ç”¨è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä¸Šé¢é‚£æ®µé”™è¯¯çš„ä»£ç  â–¼â–¼â–¼
lsImageModeBtn.addEventListener('click', () => {
    lsImageModeBtn.classList.add('active');
    lsTextImageModeBtn.classList.remove('active');
    // æ–°å¢ä¸‹é¢è¿™ä¸¤è¡Œï¼Œè¿™æ‰æ˜¯å…³é”®ï¼
    lsImageModeContent.classList.add('active');
    lsTextImageModeContent.classList.remove('active');
    // æ—§çš„æ ·å¼æ§åˆ¶ä¹Ÿä¿ç•™ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
    lsImageModeContent.style.display = 'block';
    lsTextImageModeContent.style.display = 'none';
});

lsTextImageModeBtn.addEventListener('click', () => {
    lsTextImageModeBtn.classList.add('active');
    lsImageModeBtn.classList.remove('active');
    // æ–°å¢ä¸‹é¢è¿™ä¸¤è¡Œï¼Œè¿™æ‰æ˜¯å…³é”®ï¼
    lsTextImageModeContent.classList.add('active');
    lsImageModeContent.classList.remove('active');
    // æ—§çš„æ ·å¼æ§åˆ¶ä¹Ÿä¿ç•™ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
    lsTextImageModeContent.style.display = 'block';
    lsImageModeContent.style.display = 'none';
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

 document.getElementById('ls-cancel-album-btn').addEventListener('click', () => {
    document.getElementById('ls-create-album-modal').classList.remove('visible');
});
 document.getElementById('ls-confirm-album-btn').addEventListener('click', handleConfirmAlbum);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´è®¾ç½®åŠŸèƒ½äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
document.getElementById('ls-settings-btn').addEventListener('click', () => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (chat && chat.loversSpaceData) {
        // å°†å·²ä¿å­˜çš„æ—¥æœŸåŠ è½½åˆ°è¾“å…¥æ¡†ä¸­
        document.getElementById('ls-start-date-input').value = chat.loversSpaceData.relationshipStartDate || '';
    }
    document.getElementById('ls-settings-modal').classList.add('visible');
});

document.getElementById('ls-settings-cancel-btn').addEventListener('click', () => {
    document.getElementById('ls-settings-modal').classList.remove('visible');
});

document.getElementById('ls-settings-save-btn').addEventListener('click', async () => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    const newDate = document.getElementById('ls-start-date-input').value;
    chat.loversSpaceData.relationshipStartDate = newDate;
    
    await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
    
    // é‡æ–°æ¸²æŸ“æ•´ä¸ªç©ºé—´ä»¥æ˜¾ç¤ºæ›´æ–°
    await renderLoversSpace(chat);

    document.getElementById('ls-settings-modal').classList.remove('visible');
    alert('çºªå¿µæ—¥å·²ä¿å­˜ï¼');
});
// â–²â–²â–² äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°ä»£ç ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ â–¼â–¼â–¼

// ã€æƒ…ä¾£ç©ºé—´ç›¸å†Œã€‘äº‹ä»¶ç›‘å¬
document.getElementById('ls-album-list').addEventListener('click', (e) => {
    const item = e.target.closest('.ls-album-item');
    if (!item) return;

    const timestamp = parseInt(item.dataset.timestamp);
    if (isNaN(timestamp)) return;
    
    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
    if (e.target.classList.contains('ls-photo-delete-btn')) {
        handleDeleteLSPhoto(timestamp);
    } else {
        // å¦åˆ™ï¼Œå°±æ˜¯ç‚¹å‡»äº†å›¾ç‰‡æœ¬èº«ï¼Œæ‰§è¡ŒæŸ¥çœ‹æè¿°çš„é€»è¾‘
        const chat = state.chats[activeLoversSpaceCharId];
        if (chat && chat.loversSpaceData && chat.loversSpaceData.photos) {
            const photo = chat.loversSpaceData.photos.find(p => p.timestamp === timestamp);
            if (photo) {
                showCustomAlert(`ç…§ç‰‡æè¿° (${formatPostTimestamp(photo.timestamp)})`, photo.description);
            }
        }
    }
});
// â–²â–²â–² äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´è¯´è¯´äº’åŠ¨åŠŸèƒ½äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
document.getElementById('ls-moments-list').addEventListener('click', async (e) => {
    const target = e.target;
    const momentCard = target.closest('.ls-moment-card');
    if (!momentCard) return;

    // 1. ã€æ ¸å¿ƒã€‘ä»è¢«ç‚¹å‡»çš„å¡ç‰‡ä¸Šè·å–æ­£ç¡®çš„ç´¢å¼•
    const momentIndex = parseInt(momentCard.dataset.momentIndex);
    const chat = state.chats[activeLoversSpaceCharId];
    // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°å¯¹åº”çš„æ•°æ®
    if (!chat || !chat.loversSpaceData || !chat.loversSpaceData.moments[momentIndex]) return;
    
    const moment = chat.loversSpaceData.moments[momentIndex];

    // --- å¤„ç†â€œå‘é€è¯„è®ºâ€æŒ‰é’® ---
    if (target.classList.contains('ls-comment-send-btn')) {
        const input = momentCard.querySelector('.ls-comment-input-area input');
        const commentText = input.value.trim();
        if (!commentText) {
            alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        const newComment = {
            author: chat.settings.myNickname || 'æˆ‘',
            text: commentText
        };
        
        if (!moment.comments) {
            moment.comments = [];
        }
        moment.comments.push(newComment);
        
        await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
        renderLSMoments(chat.loversSpaceData.moments, chat); // åˆ·æ–°ç•Œé¢
    }

    // --- 2. ã€æ ¸å¿ƒã€‘å¤„ç†â€œåˆ é™¤è¯´è¯´â€æŒ‰é’® ---
    if (target.classList.contains('ls-moment-delete-btn')) {
        const confirmed = await showCustomConfirm('åˆ é™¤è¯´è¯´', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯´è¯´å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            // 2. ã€æ ¸å¿ƒã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè·å–çš„ã€ç»å¯¹æ­£ç¡®çš„ momentIndex æ¥åˆ é™¤æ•°ç»„ä¸­çš„å…ƒç´ 
            chat.loversSpaceData.moments.splice(momentIndex, 1);
            await db.chats.put(chat);
            renderLSMoments(chat.loversSpaceData.moments, chat);
        }
    }

    // --- 3. å¤„ç†â€œåˆ é™¤è¯„è®ºâ€æŒ‰é’® ---
    if (target.classList.contains('ls-comment-delete-btn')) {
        const commentIndex = parseInt(target.dataset.commentIndex);
        const confirmed = await showCustomConfirm('åˆ é™¤è¯„è®º', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            moment.comments.splice(commentIndex, 1);
            await db.chats.put(chat);
            renderLSMoments(chat.loversSpaceData.moments, chat);
        }
    }
});

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ï¼Œç²˜è´´åˆ° // â–²â–²â–² æƒ…ä¾£ç©ºé—´äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

// --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´æƒ…ä¹¦åŠŸèƒ½äº‹ä»¶ç›‘å¬ ---

// 1. ç»‘å®šâ€œå†™æƒ…ä¹¦â€çš„æµ®åŠ¨æŒ‰é’®
document.getElementById('ls-add-letter-btn').addEventListener('click', () => openLoveLetterEditor());

// 2. ç»‘å®šå†™ä¿¡å¼¹çª—çš„â€œå–æ¶ˆâ€å’Œâ€œå¯„å‡ºâ€æŒ‰é’®
document.getElementById('ls-cancel-letter-btn').addEventListener('click', () => {
    document.getElementById('ls-create-letter-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-letter-btn').addEventListener('click', handlePostLoveLetter);

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½æ›´å¼ºå¤§çš„ã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ ls-letters-list äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæƒ…ä¹¦åˆ—è¡¨ä¸­çš„æ‰€æœ‰å¡ç‰‡å’ŒæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('ls-letters-list').addEventListener('click', async (e) => {
    const letterItem = e.target.closest('.ls-love-letter-item');
    if (!letterItem) return;

    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
    if (e.target.classList.contains('ls-letter-delete-btn')) {
        const letterId = letterItem.dataset.letterId;
        const chat = state.chats[activeLoversSpaceCharId];
        const letter = chat.loversSpaceData.loveLetters.find(l => l.id === letterId);
        
        const confirmed = await showCustomConfirm(
            'åˆ é™¤æƒ…ä¹¦',
            `ç¡®å®šè¦åˆ é™¤è¿™å°å†™ç»™â€œ${letter.recipientName}â€çš„æƒ…ä¹¦å—ï¼Ÿ`,
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            chat.loversSpaceData.loveLetters = chat.loversSpaceData.loveLetters.filter(l => l.id !== letterId);
            await db.chats.put(chat);
            renderLSLetters(chat.loversSpaceData.loveLetters, chat);
            alert('æƒ…ä¹¦å·²åˆ é™¤ã€‚');
        }
    } 
    // å¦åˆ™ï¼Œå°±æ˜¯ç‚¹å‡»äº†å¡ç‰‡æœ¬èº«ï¼Œæ‰§è¡ŒæŸ¥çœ‹è¯¦æƒ…çš„é€»è¾‘
    else if (letterItem.dataset.letterId) {
        showLoveLetterDetail(letterItem.dataset.letterId);
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/* â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æŠŠè¿™æ®µæ–°ä»£ç ç²˜è´´åˆ° // â–²â–²â–² æƒ…ä¾£ç©ºé—´äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼ */

// --- ã€å…¨æ–°ã€‘æƒ…ä¹¦æŸ¥çœ‹å™¨æŒ‰é’®äº‹ä»¶ç›‘å¬ ---
document.getElementById('ls-close-letter-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-letter-viewer-modal').classList.remove('visible');
    activeLoveLetter = null; // å…³é—­æ—¶æ¸…ç†æš‚å­˜çš„æ•°æ®
});

document.getElementById('ls-reply-letter-btn').addEventListener('click', () => {
    // å…ˆå…³é—­æŸ¥çœ‹å™¨
    document.getElementById('ls-letter-viewer-modal').classList.remove('visible');
    // ç„¶åæ‰“å¼€å›å¤ç¼–è¾‘å™¨
    if (activeLoveLetter) {
        openLoveLetterEditor(activeLoveLetter);
    }
    activeLoveLetter = null; // æ¸…ç†
});

/* â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ï¼Œç²˜è´´åˆ° // â–²â–²â–² æƒ…ä¾£ç©ºé—´äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–² çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ä¾£æé—®åŠŸèƒ½äº‹ä»¶ç›‘å¬ --- */

// 1. ç»‘å®šâ€œæé—®â€çš„æµ®åŠ¨æŒ‰é’®
document.getElementById('ls-add-question-btn').addEventListener('click', openQuestionAsker);

// 2. ç»‘å®šæé—®å¼¹çª—çš„æŒ‰é’®
document.getElementById('ls-cancel-ask-btn').addEventListener('click', () => {
    document.getElementById('ls-ask-question-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-ask-btn').addEventListener('click', handlePostQuestion);

// 3. ç»‘å®šå›ç­”å¼¹çª—çš„æŒ‰é’®
document.getElementById('ls-cancel-answer-btn').addEventListener('click', () => {
    document.getElementById('ls-answer-question-modal').classList.remove('visible');
});
document.getElementById('ls-confirm-answer-btn').addEventListener('click', handlePostAnswer);

// 4. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰â€œå›ç­”â€å’Œâ€œåˆ é™¤â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('ls-questions-list').addEventListener('click', (e) => {
    // è¿™æ˜¯ä½ å·²æœ‰çš„å¤„ç†â€œå›ç­”â€æŒ‰é’®çš„é€»è¾‘
    if (e.target.classList.contains('ls-answer-btn')) {
        const questionId = e.target.dataset.questionId;
        if (questionId) {
            openAnswerEditor(questionId);
        }
    }

    // â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„å¤„ç†â€œåˆ é™¤â€æŒ‰é’®çš„é€»è¾‘ â–¼â–¼â–¼
    if (e.target.classList.contains('ls-question-delete-btn')) {
        const questionId = e.target.dataset.questionId;
        if (questionId) {
            handleDeleteLSQuestion(questionId);
        }
    }
    // â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–²
});


/* --- æƒ…ä¾£æé—®äº‹ä»¶ç›‘å¬ç»“æŸ --- */

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´ä¸“å±æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// 1. ç›‘å¬ä¸»æ’­æ”¾å™¨å†…çš„æ‰€æœ‰æŒ‰é’®
document.getElementById('ls-close-player-btn').addEventListener('click', () => {
    document.getElementById('ls-music-player-overlay').classList.remove('visible');
});
document.getElementById('ls-playlist-btn').addEventListener('click', () => {
    renderLSMusicPlaylist();
    document.getElementById('ls-music-playlist-panel').classList.add('visible');
});
document.getElementById('ls-play-pause-btn').addEventListener('click', toggleLSMusicPlayPause);
document.getElementById('ls-next-btn').addEventListener('click', playNextLSSong);
document.getElementById('ls-prev-btn').addEventListener('click', playPrevLSSong);

// 2. ç›‘å¬æ’­æ”¾åˆ—è¡¨é¢æ¿å†…çš„æ‰€æœ‰æŒ‰é’®
document.getElementById('ls-close-playlist-btn').addEventListener('click', () => {
    document.getElementById('ls-music-playlist-panel').classList.remove('visible');
});
document.getElementById('ls-clear-playlist-btn').addEventListener('click', async () => {
    const confirmed = await showCustomConfirm('æ¸…ç©ºåˆ—è¡¨', 'ç¡®å®šè¦æ¸…ç©ºæƒ…ä¾£ç©ºé—´çš„æ’­æ”¾åˆ—è¡¨å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        clearLSMusicPlaylist();
    }
});
document.getElementById('ls-playlist-body').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-track-btn')) {
        const index = parseInt(e.target.dataset.index);
        lsMusicState.playlist.splice(index, 1);
        
        // å¦‚æœåˆ é™¤çš„æ˜¯æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
        if (index === lsMusicState.currentIndex) {
            playNextLSSong();
        } else if (index < lsMusicState.currentIndex) {
            lsMusicState.currentIndex--; // ä¿®æ­£ç´¢å¼•
        }
        renderLSMusicPlaylist();
    }
});

// 3. ç›‘å¬éŸ³é¢‘æ’­æ”¾å™¨çš„çŠ¶æ€
const lsAudioPlayer = document.getElementById('ls-audio-player');
lsAudioPlayer.addEventListener('timeupdate', updateLSProgressBar);
lsAudioPlayer.addEventListener('ended', playNextLSSong);
lsAudioPlayer.addEventListener('play', () => {
    lsMusicState.isPlaying = true;
    renderLSMusicPlayerUI();
});
lsAudioPlayer.addEventListener('pause', () => {
    lsMusicState.isPlaying = false;
    renderLSMusicPlayerUI();
});

// 4. ç›‘å¬è¿›åº¦æ¡çš„ç‚¹å‡»
document.getElementById('ls-progress-bar').addEventListener('click', (e) => {
    if (!lsAudioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    lsAudioPlayer.currentTime = (clickX / barWidth) * lsAudioPlayer.duration;
});

// 5. ã€æ ¸å¿ƒã€‘æ‹¦æˆªæƒ…ä¾£ç©ºé—´åˆ†äº«åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ï¼Œä¸å†è§¦å‘â€œä¸€èµ·å¬â€
document.getElementById('ls-shares-list').addEventListener('click', async (e) => {
    const item = e.target.closest('.ls-share-item');
    if (!item || !item.dataset.shareData) return;

    const shareData = JSON.parse(item.dataset.shareData);

    // å¦‚æœæ˜¯æ­Œæ›²ï¼Œå°±è°ƒç”¨æˆ‘ä»¬æ–°çš„æ’­æ”¾å™¨å‡½æ•°ï¼
    if (shareData.shareType === 'song') {
        openLoversSpaceMusicPlayer(shareData);
    } 
    // å…¶ä»–ç±»å‹çš„åˆ†äº«ï¼Œä¿æŒåŸæ¥çš„é€»è¾‘
    else if (shareData.shareType === 'movie' || shareData.shareType === 'book') {
        await showCustomAlert(`åˆ†äº«è¯¦æƒ… - ${shareData.title}`, shareData.thoughts || shareData.summary || 'æš‚æ— ç®€ä»‹');
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™å—ã€å…¨æ–°ã€‘çš„ä»£ç  â–¼â–¼â–¼
else if (shareData.shareType === 'game') {
    // ä¸ºæ¸¸æˆåˆ†äº«å¡ç‰‡æ„å»ºä¸€ä¸ªæ›´è¯¦ç»†çš„å¼¹çª—å†…å®¹
    const gameInfo = `æ¸¸æˆåï¼š${shareData.title}\n\nç®€ä»‹ï¼š${shareData.summary || 'æš‚æ— ç®€ä»‹'}\n\nTaè¯´ï¼šâ€œ${shareData.thoughts || 'ä¸€èµ·ç©å§ï¼'}â€`;
    await showCustomAlert(`åˆ†äº«çš„æ¸¸æˆ`, gameInfo);
}
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´æ’­æ”¾å™¨å°é¢/æ­Œè¯åˆ‡æ¢äº‹ä»¶
document.getElementById('ls-display-area').addEventListener('click', () => {
    document.getElementById('ls-display-area').classList.toggle('show-lyrics');
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° init(); çš„æ­£ä¸Šæ–¹ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç•ªèŒ„é’Ÿäº‹ä»¶ç›‘å¬å™¨ --- */

// 1. ç»‘å®šâ€œå¼€å¯æ–°çš„ä¸“æ³¨æ—¶å…‰â€æŒ‰é’®
document.getElementById('ls-pomodoro-start-btn-container').addEventListener('click', openPomodoroSetup);

// 2. ç»‘å®šè®¾ç½®å¼¹çª—çš„æŒ‰é’®
document.getElementById('pomodoro-cancel-setup-btn').addEventListener('click', () => {
    document.getElementById('ls-pomodoro-setup-modal').classList.remove('visible');
});
document.getElementById('pomodoro-confirm-setup-btn').addEventListener('click', startPomodoroSession);

// 3. ã€æ ¸å¿ƒã€‘ä¸ºæˆ‘ä»¬æ–°å¢çš„â€œæœ¬åœ°ä¸Šä¼ â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('pomodoro-bg-local-upload-btn').addEventListener('click', () => {
    document.getElementById('pomodoro-bg-file-input').click();
});
document.getElementById('pomodoro-bg-file-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            pomodoroState.tempBgDataUrl = event.target.result; // å°†æœ¬åœ°å›¾ç‰‡è½¬ä¸ºDataURLæš‚å­˜èµ·æ¥
            document.getElementById('pomodoro-bg-url-input').value = `[æœ¬åœ°å›¾ç‰‡: ${file.name}]`; // åœ¨è¾“å…¥æ¡†é‡Œç»™ä¸ªæç¤º
        };
        reader.readAsDataURL(file);
    }
});

// 4. ç»‘å®šè®¡æ—¶å™¨ç•Œé¢ä¸Šçš„å…ƒç´ 
document.getElementById('pomodoro-char-avatar').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç°åœ¨å®ƒä¼šè°ƒç”¨APIæ¥ç”Ÿæˆè¯è¯­
    triggerPomodoroAIResponse('user_click');
});
document.getElementById('pomodoro-end-btn').addEventListener('click', () => {
    endPomodoroSession(false); // falseè¡¨ç¤ºæ˜¯ç”¨æˆ·æ‰‹åŠ¨ä¸­æ–­
});

// 5. ç»‘å®šå†å²è¯¦æƒ…å¼¹çª—çš„å…³é—­æŒ‰é’®
document.getElementById('pomodoro-close-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-pomodoro-history-viewer-modal').classList.remove('visible');
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºç•ªèŒ„é’Ÿè®¡æ—¶æ¨¡å¼æ–°å¢çš„äº¤äº’ä»£ç  â–¼â–¼â–¼
document.querySelector('#ls-pomodoro-setup-modal').addEventListener('change', (e) => {
    if (e.target.name === 'pomodoro-mode') {
        const durationGroup = document.getElementById('pomodoro-duration-input').parentElement;
        if (e.target.value === 'countup') {
            // å¦‚æœé€‰æ‹©æ­£è®¡æ—¶ï¼Œå°±éšè—æ—¶é•¿è¾“å…¥æ¡†
            durationGroup.style.display = 'none';
        } else {
            // å¦åˆ™ï¼ˆé€‰æ‹©å€’è®¡æ—¶ï¼‰ï¼Œå°±æ˜¾ç¤ºå®ƒ
            durationGroup.style.display = 'block';
        }
    }
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

/* --- ç•ªèŒ„é’Ÿäº‹ä»¶ç›‘å¬ç»“æŸ --- */
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™å—æ–°ä»£ç  â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘å¤„ç†æƒ…ä¾£ç©ºé—´é‚€è¯·å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    const card = e.target.closest('.waimai-card');
    if (!card) return;
    const messageBubble = card.closest('.message-bubble');
    const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));

    if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
        const choice = e.target.dataset.choice; // 'accepted' or 'rejected'
// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆé€šçŸ¥ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ æ—§çš„ if (choice) { ... } ä»£ç å— â–¼â–¼â–¼
if (choice) {
    // 1. æ›´æ–°é‚€è¯·å¡ç‰‡çš„çŠ¶æ€
    invitationMsg.status = choice;
    const chat = state.chats[state.activeChatId];
    
    // 2. åˆ¤æ–­ç”¨æˆ·çš„é€‰æ‹©
    if (choice === 'accepted') {
        // å¦‚æœåŒæ„ï¼Œåˆ›å»ºæƒ…ä¾£ç©ºé—´æ•°æ®
        chat.loversSpaceData = {
            background: 'https://i.postimg.cc/k495F4W5/profile-banner.jpg',
            relationshipStartDate: null,
            moments: [], albums: [], photos: [], loveLetters: [], shares: [], questions: [],
        };
        
        // åˆ›å»ºå¯¹ã€ç”¨æˆ·å¯è§ã€‘çš„ç³»ç»Ÿé€šçŸ¥
        const visibleNotice = {
            role: 'system',
            type: 'pat_message',
            content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleNotice);

        // åˆ›å»ºç»™ã€AIçœ‹ã€‘çš„éšè—æŒ‡ä»¤
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åŒæ„äº†ä½ å¼€å¯æƒ…ä¾£ç©ºé—´çš„é‚€è¯·ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        // (è¿™é‡Œæ²¡æœ‰ triggerAiResponse()ï¼ŒAIä¸ä¼šå›åº”)

    } else { // å¦‚æœæ‹’ç» (choice === 'rejected')
        
        // --- â–¼â–¼â–¼ è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä½ æ–°å¢çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼ ---

        // a. åˆ›å»ºä¸€æ¡å¯¹ã€ç”¨æˆ·å¯è§ã€‘çš„ç³»ç»Ÿé€šçŸ¥
        const visibleNotice = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨ç°è‰²å±…ä¸­æ°”æ³¡æ ·å¼
            content: `[ç³»ç»Ÿï¼šä½ æ‹’ç»äº†â€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´é‚€è¯·ã€‚]`,
            timestamp: Date.now()
        };
        chat.history.push(visibleNotice);

        // b. åˆ›å»ºä¸€æ¡ç»™ã€AIçœ‹ã€‘çš„éšè—æŒ‡ä»¤ï¼Œå‘Šè¯‰å®ƒè¢«æ‹’ç»äº†
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·æ‹’ç»äº†ä½ å¼€å¯æƒ…ä¾£ç©ºé—´çš„é‚€è¯·ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);

        // c. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“
        await db.chats.put(chat);

        // d. åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œè®©å¡ç‰‡çŠ¶æ€å’Œæ–°çš„ç³»ç»Ÿé€šçŸ¥éƒ½æ˜¾ç¤ºå‡ºæ¥
        renderChatInterface(state.activeChatId);
        
        // (è¿™é‡Œä¹Ÿæ²¡æœ‰ triggerAiResponse()ï¼ŒAIä¸ä¼šå›åº”)
        
        // --- â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–² ---
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


    }
});
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘å¤„ç†æƒ…ä¾£ç©ºé—´é‚€è¯·å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    // å¯»æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨é‚€è¯·å¡ç‰‡å†…
    const card = e.target.closest('.waimai-card');
    if (!card) return;
    const messageBubble = card.closest('.message-bubble');
    // é€šè¿‡æ—¶é—´æˆ³æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯æ•°æ®
    const invitationMsg = state.chats[state.activeChatId].history.find(m => m.timestamp === parseInt(messageBubble.dataset.timestamp));

    // ç¡®ä¿è¿™æ˜¯ä¸€æ¡å¾…å¤„ç†çš„æƒ…ä¾£ç©ºé—´é‚€è¯·
    if (invitationMsg && invitationMsg.type === 'lovers_space_invitation' && invitationMsg.status === 'pending') {
        const choice = e.target.dataset.choice; // è·å–ç‚¹å‡»çš„æ˜¯ 'accepted' è¿˜æ˜¯ 'rejected'
        if (choice) {
            // è°ƒç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å¤„ç†å™¨å‡½æ•°
            handleLoversSpaceResponse(invitationMsg.timestamp, choice);
        }
    }
});
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–²â–²â–² æƒ…ä¾£ç©ºé—´äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸»å±å¹•æ»‘åŠ¨åˆ†é¡µçš„JSé€»è¾‘ â–¼â–¼â–¼
function initHomeScreenSlider() {
    const slider = document.querySelector('.home-screen-slider');
    const dots = document.querySelectorAll('.pagination-dots .dot');

    if (!slider || dots.length === 0) return;

    // ç›‘å¬æ»‘åŠ¨äº‹ä»¶
    slider.addEventListener('scroll', () => {
        // è®¡ç®—å½“å‰æ»‘åˆ°äº†ç¬¬å‡ é¡µ
        const pageIndex = Math.round(slider.scrollLeft / slider.clientWidth);
        
        // æ›´æ–°å°åœ†ç‚¹çš„çŠ¶æ€
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === pageIndex);
        });
    });
}
// â–²â–²â–² æ–°å¢JSé€»è¾‘ç»“æŸ â–²â–²â–²
initHomeScreenSlider(); // åˆå§‹åŒ–ä¸»å±å¹•æ»‘åŠ¨åŠŸèƒ½

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
// ç›‘å¬ä¸»å±å¹•å›¾æ ‡å’Œå°ç»„ä»¶é¢œè‰²é€‰æ‹©å™¨çš„å®æ—¶å˜åŒ–
document.getElementById('home-icon-widget-text-color-picker').addEventListener('input', (e) => {
    applyHomeIconWidgetTextColor(e.target.value);
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// ã€å…¨æ–°ã€‘ä¸»å±å¹•å­—ä½“é˜´å½±å¼€å…³çš„å®æ—¶é¢„è§ˆäº‹ä»¶
document.getElementById('remove-home-font-shadow-toggle').addEventListener('change', (e) => {
    document.getElementById('phone-screen').classList.toggle('no-home-font-shadow', e.target.checked);
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœˆå­/å°ç»„åˆ†ç±»ç­›é€‰åŠŸèƒ½äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
// 1. ç»‘å®šä¸»é¡µå’Œå°ç»„é¡µçš„ç­›é€‰æŒ‰é’®
document.getElementById('forum-filter-btn').addEventListener('click', () => openForumFilterModal('global'));
document.getElementById('group-filter-btn').addEventListener('click', () => openForumFilterModal('group', activeGroupId));

// 2. ç»‘å®šç­›é€‰å¼¹çª—å†…çš„æŒ‰é’®
document.getElementById('apply-forum-filter-btn').addEventListener('click', applyForumFilter);
document.getElementById('cancel-forum-filter-btn').addEventListener('click', () => {
    document.getElementById('forum-filter-modal').classList.remove('visible');
});
document.getElementById('reset-forum-filter-btn').addEventListener('click', async () => {
    // æ¸…ç©ºå¤é€‰æ¡†å¹¶åº”ç”¨
    document.querySelectorAll('#forum-filter-category-list input:checked').forEach(cb => cb.checked = false);
    await applyForumFilter();
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²



// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹çš„å® ç‰©å›¾æ ‡æŒ‰é’®
document.getElementById('pet-action-btn').addEventListener('click', openPetModal);

// 2. ç»‘å®šå® ç‰©å¼¹çª—å†…çš„å„ç§æŒ‰é’®
document.getElementById('pet-modal-cancel-btn').addEventListener('click', () => {
    document.getElementById('pet-modal').classList.remove('visible');
    currentPetData = null; // å–æ¶ˆæ—¶ä¹Ÿè¦æ¸…ç†
});
document.getElementById('pet-modal-save-btn').addEventListener('click', savePetSettings);

// 3. å®æ—¶æ›´æ–°é¢„è§ˆ
document.getElementById('pet-type-input').addEventListener('input', updatePetPreview);
document.getElementById('pet-name-input').addEventListener('input', updatePetPreview);
document.getElementById('pet-image-input').addEventListener('input', updatePetPreview);

// 4. â€œåœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºâ€å¼€å…³çš„äº¤äº’
document.getElementById('pet-display-toggle').addEventListener('change', (e) => {
    document.getElementById('pet-position-controls').style.display = e.target.checked ? 'block' : 'none';
});

// 5. å°ºå¯¸æ»‘å—çš„äº¤äº’
const sizeSlider = document.getElementById('pet-size-slider');
sizeSlider.addEventListener('input', () => {
    document.getElementById('pet-size-value').textContent = `${sizeSlider.value}px`;
});

// 6. ç»‘å®šæ›´æ¢è‡ªå®šä¹‰å›¾ç‰‡çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('pet-preview-display').addEventListener('click', () => {
    document.getElementById('pet-custom-image-input').click();
});
document.getElementById('pet-custom-image-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            // å°†å›¾ç‰‡çš„Base64é“¾æ¥ç›´æ¥å¡«å…¥è¾“å…¥æ¡†
            document.getElementById('pet-image-input').value = event.target.result;
            updatePetPreview(); // å¹¶æ›´æ–°é¢„è§ˆ
        };
        reader.readAsDataURL(file);
    }
});

// 7. ç»‘å®šäº’åŠ¨æŒ‰é’® (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
document.getElementById('pet-interaction-area').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.action) {
        handlePetInteraction(e.target.dataset.action);
    }
});

// 8. åˆå§‹åŒ–å® ç‰©çš„æ‹–åŠ¨åŠŸèƒ½
initPetDragging();
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å® ç‰©èŠå¤©åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('send-to-pet-btn').addEventListener('click', handleSendToPet);
document.getElementById('pet-chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-to-pet-btn').click();
    }
});

// ä¸ºå® ç‰©èŠå¤©çª—å£çš„â€œå¤–éƒ¨â€ç‚¹å‡»æ·»åŠ å…³é—­åŠŸèƒ½
const petChatModal = document.getElementById('pet-chat-modal');
petChatModal.addEventListener('click', (e) => {
    if (e.target === petChatModal) { // åªæœ‰ç‚¹å‡»ç°è‰²é®ç½©å±‚æ‰å…³é—­
        petChatModal.classList.remove('visible');
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
// ã€å…¨æ–°ã€‘ä¸ºâ€œæ”¾ç”Ÿå® ç‰©â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('pet-abandon-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ”¾ç”Ÿ',
        'ç¡®å®šè¦å…³é—­å® ç‰©ç³»ç»Ÿå—ï¼Ÿè¿™å°†ä¼šé‡ç½®æ‰€æœ‰å® ç‰©æ•°æ®ï¼ˆæ•°å€¼ã€èŠå¤©è®°å½•ç­‰ï¼‰ï¼Œä½†ä¸ä¼šåˆ é™¤ä½ çš„è®¾ç½®ã€‚ä½ å¯ä»¥éšæ—¶é‡æ–°é¢†å…»ã€‚',
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        chat.settings.petAdopted = false; // å…³é—­é¢†å…»çŠ¶æ€
        delete chat.settings.pet; // åˆ é™¤å® ç‰©æ•°æ®å¯¹è±¡
        
        await db.chats.put(chat);
        
        renderChatPet(); // ä»èŠå¤©ç•Œé¢ç§»é™¤å® ç‰©
        document.getElementById('pet-modal').classList.remove('visible'); // å…³é—­å¼¹çª—
        alert('å® ç‰©å·²æ”¾ç”Ÿï¼Œæ±Ÿæ¹–å†è§ï¼');
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² å® ç‰©åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æƒ…ä¾£ç©ºé—´-æƒ…ç»ªæ—¥è®°äº‹ä»¶ç›‘å¬ --- */
document.getElementById('lovers-space-screen').addEventListener('click', (e) => {
    const chat = state.chats[activeLoversSpaceCharId];
    if (!chat) return;

    // æ—¥å†æœˆä»½åˆ‡æ¢
    if (e.target.id === 'ls-prev-month-btn' || e.target.id === 'ls-next-month-btn') {
        const currentDisplay = document.getElementById('ls-current-month-display').textContent;
        const [year, month] = currentDisplay.match(/\d+/g).map(Number);
        let newDate = new Date(year, month - 1, 1);
        
        if (e.target.id === 'ls-prev-month-btn') {
            newDate.setMonth(newDate.getMonth() - 1);
        } else {
            newDate.setMonth(newDate.getMonth() + 1);
        }
        renderLSDiaryView(newDate.getFullYear(), newDate.getMonth() + 1);
        return;
    }
    
    // ç‚¹å‡»æ—¥å†æ ¼å­
    const dayCell = e.target.closest('.ls-calendar-day:not(.empty)');
    if (dayCell) {
        openDiaryModal(dayCell.dataset.date);
    }
});

// æ—¥è®°ç¼–è¾‘å¼¹çª—äº‹ä»¶
document.getElementById('ls-emoji-selector').addEventListener('click', (e) => {
    if (e.target.classList.contains('emoji-option')) {
        document.querySelectorAll('#ls-emoji-selector .emoji-option').forEach(el => el.classList.remove('selected'));
        e.target.classList.add('selected');
    }
});
document.getElementById('ls-cancel-diary-btn').addEventListener('click', () => {
    document.getElementById('ls-diary-editor-modal').classList.remove('visible');
});
document.getElementById('ls-save-diary-btn').addEventListener('click', handleSaveUserDiary);

// æ—¥è®°æŸ¥çœ‹å¼¹çª—å…³é—­æŒ‰é’®
document.getElementById('ls-close-diary-viewer-btn').addEventListener('click', () => {
    document.getElementById('ls-diary-viewer-modal').classList.remove('visible');
});

/* --- æƒ…ç»ªæ—¥è®°äº‹ä»¶ç›‘å¬ç»“æŸ --- */

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾...

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™å‡ è¡Œæ–°ä»£ç  â–¼â–¼â–¼

// ç»‘å®šçº¿ä¸‹æ¨¡å¼é¢„è®¾çš„ä¸‹æ‹‰æ¡†å’Œç®¡ç†æŒ‰é’®
document.getElementById('offline-preset-select').addEventListener('change', handleOfflinePresetSelection);
document.getElementById('manage-offline-presets-btn').addEventListener('click', openOfflinePresetManager);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å·²ä¿®å¤ã€‘ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼
document.getElementById('back-from-dm-list').addEventListener('click', () => {
    // ä»ç§ä¿¡åˆ—è¡¨è¿”å›æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºå¾®åšä¸»å±å¹•
    showScreen('weibo-screen');
    // å¹¶ä¸”ç¡®ä¿é»˜è®¤æ˜¾ç¤ºçš„æ˜¯â€œæˆ‘çš„å¾®åšâ€é‚£ä¸ªé¡µç­¾
    switchToWeiboView('weibo-my-profile-view');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


document.getElementById('back-from-dm-detail').addEventListener('click', () => {
    // ä»ç§ä¿¡è¯¦æƒ…è¿”å›ç§ä¿¡åˆ—è¡¨
    showScreen('weibo-dm-list-screen');
});

// ç»‘å®šâ€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’®
document.getElementById('generate-more-dms-btn').addEventListener('click', handleGenerateMoreDms);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç§ä¿¡åˆ—è¡¨çš„ç‚¹å‡»
document.getElementById('weibo-dm-list').addEventListener('click', (e) => {
    const item = e.target.closest('.dm-list-item');
    if (item && item.dataset.fanIndex) {
        openDmDetail(parseInt(item.dataset.fanIndex));
    }
});

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç§ä¿¡è¯¦æƒ…é¡µçš„åˆ é™¤æŒ‰é’®ç‚¹å‡»
document.getElementById('weibo-dm-messages').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.dm-message-delete-btn');
    if (deleteBtn) {
        const fanIndex = parseInt(document.querySelector('.dm-list-item.active')?.dataset.fanIndex ?? document.getElementById('weibo-dm-detail-screen').dataset.currentFanIndex);
        const messageIndex = parseInt(deleteBtn.dataset.messageIndex);
        
        const conversation = state.chats[currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id].weiboDms.find(convo => convo.fanName === document.getElementById('weibo-dm-detail-title').textContent);
        const fanIdx = state.chats[currentViewingDmsFor.isNpc ? currentViewingDmsFor.ownerId : currentViewingDmsFor.id].weiboDms.indexOf(conversation);

        if (!isNaN(fanIdx) && !isNaN(messageIndex)) {
            handleDeleteWeiboDm(fanIdx, messageIndex);
        }
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²
document.getElementById('clear-all-dms-btn').addEventListener('click', handleClearAllDms);
// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©æ€»ç»“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('view-summaries-btn').addEventListener('click', openSummaryViewer);
document.getElementById('close-summary-viewer-btn').addEventListener('click', () => {
    document.getElementById('summary-viewer-modal').classList.remove('visible');
    // å…³é—­åé‡æ–°æ‰“å¼€è®¾ç½®å¼¹çª—ï¼Œå›åˆ°ä¸Šä¸€çº§
    document.getElementById('chat-settings-btn').click();
});

// â–¼â–¼â–¼ ç”¨è¿™å—ã€åŠŸèƒ½æ›´å…¨ã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ summary-list äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ€»ç»“åˆ—è¡¨ä¸­çš„æ‰€æœ‰æŒ‰é’®
document.getElementById('summary-list').addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-summary-btn');
    if (editBtn) {
        const timestamp = parseInt(editBtn.dataset.timestamp);
        editSummary(timestamp);
        return;
    }
    
    const deleteBtn = e.target.closest('.delete-summary-btn');
    if (deleteBtn) {
        const timestamp = parseInt(deleteBtn.dataset.timestamp);
        deleteSummary(timestamp);
        return;
    }

    // ã€æ ¸å¿ƒæ–°å¢ã€‘å¤„ç†å•æ¡ç²¾ç®€æŒ‰é’®çš„ç‚¹å‡»
    const conciseBtn = e.target.closest('.concise-summary-btn');
    if (conciseBtn) {
        const timestamp = parseInt(conciseBtn.dataset.timestamp);
        handleConciseSummary(timestamp);
        return;
    }
});

// ã€å…¨æ–°ã€‘ä¸ºâ€œå…¨éƒ¨ç²¾ç®€â€æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('concise-all-summaries-btn').addEventListener('click', handleConciseAllSummaries);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬3æ­¥ï¼šç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ manual-summary-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.id === 'manual-summary-btn') {
        // ç‚¹å‡»åå…ˆå…³é—­è®¾ç½®å¼¹çª—
        document.getElementById('chat-settings-modal').classList.remove('visible');
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æˆ‘ä»¬æ–°åˆ›å»ºçš„é€‰æ‹©å‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥æ€»ç»“
        openManualSummaryOptions();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ï¼Œç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå®â€App äº‹ä»¶ç›‘å¬å™¨ --- */

// 1. ç»‘å®šä¸»å±å¹•çš„Appå›¾æ ‡
document.getElementById('taobao-app-icon').addEventListener('click', openTaobaoApp);
// ç»‘å®šæ–°åŠ çš„â€œæ¸…ç©ºâ€æŒ‰é’®
document.getElementById('clear-taobao-products-btn').addEventListener('click', clearTaobaoProducts);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æ¡ƒå®è´­ç‰©è½¦åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */

// 1. ç»‘å®šAppå†…éƒ¨çš„é¡µç­¾åˆ‡æ¢
document.querySelector('.taobao-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('taobao-tab')) {
        switchTaobaoView(e.target.dataset.view);
    }
});

// 2. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå¤„ç†å•†å“åˆ—è¡¨å’Œè´­ç‰©è½¦åˆ—è¡¨ä¸­çš„æ‰€æœ‰ç‚¹å‡»
document.getElementById('taobao-screen').addEventListener('click', async (e) => {
    const target = e.target;
    
    // ç‚¹å‡»â€œåŠ å…¥è´­ç‰©è½¦â€æŒ‰é’®
    if (target.classList.contains('add-cart-btn')) {
        const productId = parseInt(target.dataset.productId);
        if (!isNaN(productId)) {
            await handleAddToCart(productId);
        }
        return;
    }
    
    // ç‚¹å‡»å•†å“å¡ç‰‡ï¼ˆå›¾ç‰‡æˆ–ä¿¡æ¯åŒºï¼‰ï¼Œæ‰“å¼€è¯¦æƒ…é¡µ
    const productCard = target.closest('.product-card');
    if (productCard && !target.classList.contains('add-cart-btn')) {
        const productId = parseInt(productCard.dataset.productId);
        if (!isNaN(productId)) {
            await openProductDetail(productId);
        }
        return;
    }
    
    // ç‚¹å‡»è´­ç‰©è½¦é‡Œçš„å•†å“ï¼ˆå›¾ç‰‡æˆ–ä¿¡æ¯åŒºï¼‰ï¼Œæ‰“å¼€è¯¦æƒ…é¡µ
    const cartItem = target.closest('.cart-item');
    if (cartItem && (target.classList.contains('product-image') || target.closest('.cart-item-info'))) {
         const productId = parseInt(target.dataset.productId);
         if (!isNaN(productId)) {
            await openProductDetail(productId);
        }
        return;
    }

    // ç‚¹å‡»è´­ç‰©è½¦æ•°é‡æ§åˆ¶æŒ‰é’®
    if (target.classList.contains('quantity-increase')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) await handleChangeCartItemQuantity(cartId, 1);
        return;
    }
    if (target.classList.contains('quantity-decrease')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) await handleChangeCartItemQuantity(cartId, -1);
        return;
    }

    // ç‚¹å‡»è´­ç‰©è½¦åˆ é™¤æŒ‰é’®
    if (target.classList.contains('delete-cart-item-btn')) {
        const cartId = parseInt(target.dataset.cartId);
        if (!isNaN(cartId)) {
            const confirmed = await showCustomConfirm('ç§»å‡ºè´­ç‰©è½¦', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®è´å—ï¼Ÿ');
            if (confirmed) await handleRemoveFromCart(cartId);
        }
        return;
    }

    // ç‚¹å‡»åˆ†ç±»é¡µç­¾
    const categoryTab = target.closest('.category-tab-btn');
    if (categoryTab) {
        const category = categoryTab.dataset.category === 'all' ? null : categoryTab.dataset.category;
        await renderTaobaoProducts(category);
        return;
    }
});

// 3. ç»‘å®šå•†å“è¯¦æƒ…å¼¹çª—çš„å…³é—­æŒ‰é’®
document.getElementById('close-product-detail-btn').addEventListener('click', () => {
    document.getElementById('product-detail-modal').classList.remove('visible');
});

// 4. ç»‘å®šç»“ç®—æŒ‰é’®
document.getElementById('checkout-btn').addEventListener('click', handleCheckout);


// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ 'top-up-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('top-up-btn').addEventListener('click', async () => {
    const amountStr = await showCustomPrompt("å……å€¼", "è¯·è¾“å…¥è¦å……å€¼çš„é‡‘é¢ (å…ƒ):", "", "number");
    if (amountStr !== null) {
        const amount = parseFloat(amountStr);
        if (!isNaN(amount) && amount > 0) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æˆ‘ä»¬çš„æ–°å‡½æ•°æ¥å¤„ç†å……å€¼å’Œè®°å½•
            await updateUserBalanceAndLogTransaction(amount, 'å……å€¼');
            await renderBalanceDetails(); // åˆ·æ–°ä½™é¢å’Œæ˜ç»†
            alert(`æˆåŠŸå……å€¼ Â¥${amount.toFixed(2)}ï¼`);
        } else {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼");
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// 4. ç»‘å®šé¦–é¡µå³ä¸Šè§’çš„â€œ+â€æŒ‰é’®
document.getElementById('add-product-btn').addEventListener('click', openAddProductChoiceModal);

// 5. ç»‘å®šæ·»åŠ æ–¹å¼é€‰æ‹©å¼¹çª—çš„æŒ‰é’®
document.getElementById('add-product-manual-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    openProductEditor();
});
document.getElementById('add-product-link-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    openAddFromLinkModal();
});
document.getElementById('add-product-ai-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
    handleGenerateProductsAI();
});
document.getElementById('cancel-add-choice-btn').addEventListener('click', () => {
    document.getElementById('add-product-choice-modal').classList.remove('visible');
});

// 6. ç»‘å®šæ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘å¼¹çª—çš„æŒ‰é’®
document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
    document.getElementById('product-editor-modal').classList.remove('visible');
});
document.getElementById('save-product-btn').addEventListener('click', saveProduct);

// 7. ç»‘å®šè¯†åˆ«é“¾æ¥å¼¹çª—çš„æŒ‰é’®
document.getElementById('cancel-link-paste-btn').addEventListener('click', () => {
    document.getElementById('add-from-link-modal').classList.remove('visible');
});
document.getElementById('confirm-link-paste-btn').addEventListener('click', handleAddFromLink);

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ 'products-view' ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('products-view').addEventListener('click', async (e) => {
    const target = e.target;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬æŠŠåŸæ¥çš„è´­ä¹°é€»è¾‘ï¼Œæ”¹æˆäº†æ‰“å¼€è¯¦æƒ…é¡µçš„é€»è¾‘
    const productCard = target.closest('.product-card');
    if (productCard && !target.classList.contains('add-cart-btn')) {
        const productId = parseInt(productCard.dataset.productId);
        if (!isNaN(productId)) {
            await openProductDetail(productId); // <--- å°±æ˜¯ä¿®æ”¹äº†è¿™é‡Œï¼
        }
        return;
    }
    
    // ä¸‹é¢è¿™ä¸¤éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜
    if (target.classList.contains('add-cart-btn')) {
        const productId = parseInt(target.dataset.productId);
        if (!isNaN(productId)) {
            await handleAddToCart(productId);
        }
        return;
    }
    const categoryTab = target.closest('.category-tab-btn');
    if (categoryTab) {
        const category = categoryTab.dataset.category === 'all' ? null : categoryTab.dataset.category;
        renderTaobaoProducts(category);
        return;
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ï¼Œç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘â€œæ¡ƒå®â€App æœç´¢ä¸AIç»“æœå¼¹çª—äº‹ä»¶ç›‘å¬å™¨ --- */

// 1. ç»‘å®šæœç´¢æŒ‰é’®
productSearchBtn.addEventListener('click', handleSearchProductsAI);
productSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        handleSearchProductsAI();
    }
});

// 2. ç»‘å®šAIç»“æœå¼¹çª—çš„å…³é—­æŒ‰é’®
document.getElementById('close-ai-products-modal-btn').addEventListener('click', async () => {
    aiGeneratedProductsModal.classList.remove('visible');
    // å…³é—­ååˆ·æ–°ä¸»é¡µï¼Œæ˜¾ç¤ºæ–°æ·»åŠ çš„å•†å“
    await renderTaobaoProducts(); 
});

// 3. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå¤„ç†ç»“æœå¼¹çª—å†…æ‰€æœ‰â€œæ·»åŠ â€æŒ‰é’®çš„ç‚¹å‡»
document.getElementById('ai-product-results-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('add-to-my-page-btn')) {
        const button = e.target;
        const productData = JSON.parse(button.dataset.product);
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœAIè¿”å›çš„å•†å“æ•°æ®é‡Œæ²¡æœ‰å›¾ç‰‡URL
        if (!productData.imageUrl) {
            // å°±è°ƒç”¨æˆ‘ä»¬çš„è¾…åŠ©å‡½æ•°ï¼Œç»™å®ƒä¸€å¼ éšæœºé»˜è®¤å›¾
            productData.imageUrl = getRandomDefaultProductImage();
            console.log(`AIç”Ÿæˆçš„å•†å“ "${productData.name}" ç¼ºå°‘å›¾ç‰‡ï¼Œå·²è‡ªåŠ¨è¡¥å……é»˜è®¤å›¾ã€‚`);
        }
        // â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // æ£€æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
        const existingProduct = await db.taobaoProducts.where('name').equals(productData.name).first();
        if (existingProduct) {
            alert('è¿™ä¸ªå•†å“å·²ç»å­˜åœ¨äºä½ çš„æ¡ƒå®ä¸»é¡µå•¦ï¼');
            button.textContent = 'å·²æ·»åŠ ';
            button.disabled = true;
            return;
        }

        // æ·»åŠ åˆ°æ•°æ®åº“
        await db.taobaoProducts.add(productData);
        
        // ç¦ç”¨æŒ‰é’®å¹¶æ›´æ–°æ–‡æœ¬ï¼Œç»™ç”¨æˆ·åé¦ˆ
        button.textContent = 'âœ“ å·²æ·»åŠ ';
        button.disabled = true;
        
        // ï¼ˆå¯é€‰ï¼‰ç»™ä¸ªå°æç¤º
        // await showCustomAlert('æ·»åŠ æˆåŠŸ', `â€œ${productData.name}â€å·²æ·»åŠ åˆ°ä½ çš„æ¡ƒå®ï¼`);
    }
});

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘æ¡ƒå®è®¢å•ç‰©æµåŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */

// 1. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºâ€œæˆ‘çš„è®¢å•â€åˆ—è¡¨ä¸­çš„æ‰€æœ‰è®¢å•é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('orders-view').addEventListener('click', (e) => {
    const item = e.target.closest('.order-item');
    if (item && item.dataset.orderId) {
        const orderId = parseInt(item.dataset.orderId);
        if (!isNaN(orderId)) {
            openLogisticsView(orderId);
        }
    }
});

// 2. ç»‘å®šç‰©æµé¡µé¢çš„è¿”å›æŒ‰é’®
document.getElementById('logistics-back-btn').addEventListener('click', () => {
    // è¿”å›æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºâ€œæ¡ƒå®â€ä¸»ç•Œé¢ï¼Œå¹¶è‡ªåŠ¨åˆ‡æ¢åˆ°â€œæˆ‘çš„è®¢å•â€é¡µç­¾
    showScreen('taobao-screen');
    switchTaobaoView('orders-view'); 
});

/* --- äº‹ä»¶ç›‘å¬ç»“æŸ --- */

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
document.getElementById('share-cart-to-char-btn').addEventListener('click', handleShareCartRequest);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸç²˜è´´ â–¼â–¼â–¼
document.getElementById('buy-for-char-btn').addEventListener('click', handleBuyForChar);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
/* --- â€œæ¡ƒå®â€App äº‹ä»¶ç›‘å¬å™¨ç»“æŸ --- */
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('character-phone-container').addEventListener('click', (e) => {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œåˆ¤æ–­ç‚¹å‡»çš„æ˜¯å“ªä¸ªæŒ‰é’®
    if (e.target.id === 'upload-char-phone-wallpaper-btn') {
        document.getElementById('char-phone-wallpaper-upload-input').click();
    } 
    else if (e.target.id === 'remove-char-phone-wallpaper-btn') {
        handleCharPhoneWallpaperChange(''); // ä¼ å…¥ç©ºå­—ç¬¦ä¸²æ¥ç§»é™¤å£çº¸
    }
    else {
        const changeIconButton = e.target.closest('.change-icon-btn');
        if (changeIconButton) {
            const iconId = changeIconButton.dataset.iconId;
            handleChangeCharPhoneIcon(iconId);
        }
    }
});

// ç›‘å¬å£çº¸æ–‡ä»¶é€‰æ‹©
document.getElementById('char-phone-wallpaper-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        handleCharPhoneWallpaperChange(dataUrl);
    }
    event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
});
// â–²â–²â–² äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšä¸»é¡µäº‹ä»¶ç›‘å¬å™¨ --- */
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ä¸ºè§’è‰²å¾®åšä¸»é¡µçš„â€œå…³æ³¨â€å’Œâ€œç²‰ä¸â€æ·»åŠ ç‚¹å‡»ç¼–è¾‘åŠŸèƒ½
document.getElementById('weibo-char-profile-page').addEventListener('click', async (e) => {
    if (!currentViewingWeiboProfileId) return;
    const chat = state.chats[currentViewingWeiboProfileId];
    if (!chat) return;

    // åˆ¤æ–­ç‚¹å‡»çš„æ˜¯å¦æ˜¯â€œå…³æ³¨â€åŒºåŸŸ
    if (e.target.closest('#weibo-char-following-item')) {
        const newFollowing = await showCustomPrompt("ç¼–è¾‘å…³æ³¨æ•°", "è¯·è¾“å…¥æ–°çš„å…³æ³¨æ•°:", chat.settings.weiboFollowingCount);
        if (newFollowing !== null) {
            chat.settings.weiboFollowingCount = newFollowing.trim() || '0';
            await db.chats.put(chat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    }
    // åˆ¤æ–­ç‚¹å‡»çš„æ˜¯å¦æ˜¯â€œç²‰ä¸â€åŒºåŸŸ
    else if (e.target.closest('#weibo-char-fans-item')) {
        const newFans = await showCustomPrompt("ç¼–è¾‘ç²‰ä¸æ•°", "è¯·è¾“å…¥æ–°çš„ç²‰ä¸æ•° (æ”¯æŒ'ä¸‡'/'äº¿'):", chat.settings.weiboFansCount);
        if (newFans !== null) {
            chat.settings.weiboFansCount = newFans.trim() || '0';
            await db.chats.put(chat);
            await renderWeiboCharProfile(currentViewingWeiboProfileId);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä¸Šé¢é‚£æ®µæ—§ä»£ç  â–¼â–¼â–¼
document.getElementById('back-from-char-profile').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æˆ‘ä»¬ä¸å†æ˜¾ç¤ºå…³æ³¨åˆ—è¡¨å¼¹çª—ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›åˆ°å¾®åšä¸»å±å¹•
    showScreen('weibo-screen'); 
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// 2. ç»‘å®šæ–°é¡µé¢å³ä¸Šè§’çš„ç¼–è¾‘æŒ‰é’®
document.getElementById('edit-char-weibo-profile-btn').addEventListener('click', openCharWeiboEditor);

// 3. ç»‘å®šè§’è‰²èµ„æ–™ç¼–è¾‘å¼¹çª—çš„æŒ‰é’®
document.getElementById('cancel-char-weibo-editor-btn').addEventListener('click', () => {
    document.getElementById('char-weibo-editor-modal').classList.remove('visible');
});
document.getElementById('save-char-weibo-editor-btn').addEventListener('click', saveCharWeiboProfile);

// 4. ä¸ºè§’è‰²èµ„æ–™ç¼–è¾‘å¼¹çª—çš„å›¾ç‰‡ä¸Šä¼ ç»‘å®šäº‹ä»¶
setupFileUpload('char-weibo-editor-avatar-input', (base64) => {
    document.getElementById('char-weibo-editor-avatar-preview').src = base64;
});
setupFileUpload('char-weibo-editor-bg-input', (base64) => {
    document.getElementById('char-weibo-editor-bg-preview').src = base64;
});

// 5. ç»‘å®šå…³æ³¨åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
document.getElementById('weibo-following-list-container').addEventListener('click', (e) => {
    const viewProfileBtn = e.target.closest('.view-profile-btn');
    if (viewProfileBtn && viewProfileBtn.dataset.charId) {
        openWeiboCharProfile(viewProfileBtn.dataset.charId);
    }
});

/* --- æ–°äº‹ä»¶ç›‘å¬ç»“æŸ --- */
// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘è§’è‰²å¾®åšèµ„æ–™ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®š --- */

// 1. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºè§’è‰²å¾®åšç¼–è¾‘å¼¹çª—å†…çš„æ‰€æœ‰æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('char-weibo-editor-modal').addEventListener('click', (e) => {
    // a. å¦‚æœç‚¹å‡»çš„æ˜¯â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®
    if (e.target.classList.contains('change-frame-btn')) {
        const type = e.target.dataset.type; // è·å–æŒ‰é’®ç±»å‹ 'char-weibo'
        const targetId = currentViewingWeiboProfileId; // è·å–å½“å‰æ­£åœ¨æŸ¥çœ‹çš„è§’è‰²ID
        
        // è°ƒç”¨å¤´åƒæ¡†é€‰æ‹©å‡½æ•°ï¼Œå¹¶ä¼ å…¥æ­£ç¡®çš„å‚æ•°
        openFrameSelectorModal(type, targetId);
    }
    // b. å¦‚æœç‚¹å‡»çš„æ˜¯â€œå–æ¶ˆâ€æŒ‰é’®
    else if (e.target.id === 'cancel-char-weibo-editor-btn') {
        document.getElementById('char-weibo-editor-modal').classList.remove('visible');
    }
    // c. å¦‚æœç‚¹å‡»çš„æ˜¯â€œä¿å­˜â€æŒ‰é’®
    else if (e.target.id === 'save-char-weibo-editor-btn') {
        saveCharWeiboProfile();
    }
});

// 2. ä¸ºè§’è‰²æ‰‹æœºçš„å›¾ç‰‡ä¸Šä¼ è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶ï¼ˆè¿™æ˜¯ä¹‹å‰å°±æœ‰çš„ï¼Œç¡®ä¿å®ƒåœ¨æ­£ç¡®çš„ä½ç½®ï¼‰
setupFileUpload('char-weibo-editor-avatar-input', (base64) => {
    document.getElementById('char-weibo-editor-avatar-preview').src = base64;
});
setupFileUpload('char-weibo-editor-bg-input', (base64) => {
    document.getElementById('char-weibo-editor-bg-preview').src = base64;
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

        /* --- ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå°ç»„ä»¶ä¸Šä¼ åŠŸèƒ½äº‹ä»¶ç»‘å®š --- */

        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å›¾ç‰‡ä¸Šä¼ çš„é€šç”¨é€»è¾‘
        const handleWidgetUpload = async (widgetKey, inputFileId) => {
            const fileInput = document.getElementById(inputFileId);
            const file = fileInput.files[0];
            if (!file) return;

            const dataUrl = await new Promise(res => {
                const reader = new FileReader();
                reader.onload = () => res(reader.result);
                reader.readAsDataURL(file);
            });
            
            const chat = state.chats[activeCharacterPhoneId];
            if (!chat.characterPhoneData.widgets) {
                chat.characterPhoneData.widgets = {};
            }
            chat.characterPhoneData.widgets[widgetKey] = dataUrl;
            
            await db.chats.put(chat);
            renderCharPhoneAppearanceScreen(); // åˆ·æ–°è®¾ç½®é¡µé¢„è§ˆ
            openCharacterPhone(activeCharacterPhoneId); // åˆ·æ–°æ‰‹æœºä¸»å±å¹•
            alert('å°ç»„ä»¶å›¾ç‰‡å·²æ›´æ–°ï¼');
            fileInput.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
        };

        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å›¾ç‰‡ç§»é™¤çš„é€šç”¨é€»è¾‘
        const handleWidgetRemove = async (widgetKey) => {
             const chat = state.chats[activeCharacterPhoneId];
             if (chat.characterPhoneData.widgets && chat.characterPhoneData.widgets[widgetKey]) {
                delete chat.characterPhoneData.widgets[widgetKey];
                await db.chats.put(chat);
                renderCharPhoneAppearanceScreen();
                openCharacterPhone(activeCharacterPhoneId);
                alert('å°ç»„ä»¶å›¾ç‰‡å·²ç§»é™¤ï¼');
             }
        };

        // ä¸ºå››ä¸ªæ–°æŒ‰é’®ç»‘å®šäº‹ä»¶
        document.getElementById('upload-widget-1-btn').addEventListener('click', () => {
            document.getElementById('char-phone-widget-1-upload-input').click();
        });
        document.getElementById('remove-widget-1-btn').addEventListener('click', () => {
            handleWidgetRemove('widget1_url');
        });
        document.getElementById('char-phone-widget-1-upload-input').addEventListener('change', () => {
            handleWidgetUpload('widget1_url', 'char-phone-widget-1-upload-input');
        });

        document.getElementById('upload-widget-2-btn').addEventListener('click', () => {
            document.getElementById('char-phone-widget-2-upload-input').click();
        });
        document.getElementById('remove-widget-2-btn').addEventListener('click', () => {
            handleWidgetRemove('widget2_url');
        });
        document.getElementById('char-phone-widget-2-upload-input').addEventListener('change', () => {
            handleWidgetUpload('widget2_url', 'char-phone-widget-2-upload-input');
        });

        /* --- å°ç»„ä»¶äº‹ä»¶ç»‘å®šç»“æŸ --- */
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('char-phone-preset-selector').addEventListener('change', handleCharPhonePresetSelection);
document.getElementById('apply-char-phone-preset-btn').addEventListener('click', applySelectedCharPhonePreset);
document.getElementById('save-char-phone-preset-btn').addEventListener('click', saveCurrentCharPhonePreset);
document.getElementById('update-char-phone-preset-btn').addEventListener('click', updateSelectedCharPhonePreset);
document.getElementById('rename-char-phone-preset-btn').addEventListener('click', renameSelectedCharPhonePreset);
document.getElementById('delete-char-phone-preset-btn').addEventListener('click', deleteSelectedCharPhonePreset);
document.getElementById('export-char-phone-preset-btn').addEventListener('click', exportCharPhonePreset);
document.getElementById('import-char-phone-preset-btn').addEventListener('click', () => {
    document.getElementById('import-char-phone-preset-input').click();
});
document.getElementById('import-char-phone-preset-input').addEventListener('change', (e) => {
    importCharPhonePreset(e.target.files[0]);
    e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
});
// â–²â–²â–² äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²æ‰‹æœºAppå†…å£çº¸åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// ç›‘å¬â€œä¸Šä¼ â€æŒ‰é’®çš„ç‚¹å‡»ï¼Œå»è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
document.getElementById('upload-char-phone-app-wallpaper-btn').addEventListener('click', () => {
    document.getElementById('char-phone-app-wallpaper-upload-input').click();
});

// ç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨çš„å˜åŒ–
document.getElementById('char-phone-app-wallpaper-upload-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if(file) {
        const dataUrl = await new Promise((res) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        // æ–‡ä»¶è¯»å–æˆåŠŸåï¼Œç«‹åˆ»è°ƒç”¨å¤„ç†å‡½æ•°æ¥ä¿å­˜å’Œåº”ç”¨
        handleCharPhoneAppWallpaperChange(dataUrl);
    }
    event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
});

// ç›‘å¬â€œç§»é™¤â€æŒ‰é’®çš„ç‚¹å‡»
document.getElementById('remove-char-phone-app-wallpaper-btn').addEventListener('click', () => {
    // è°ƒç”¨å¤„ç†å‡½æ•°ï¼Œå¹¶ä¼ å…¥ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç§»é™¤
    handleCharPhoneAppWallpaperChange('');
});

// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
    // ã€å…¨æ–°ã€‘å¿ƒå£°èƒŒæ™¯æ›´æ¢åŠŸèƒ½äº‹ä»¶ç›‘å¬
    document.getElementById('change-inner-voice-bg-btn').addEventListener('click', handleInnerVoiceBgChange);

    document.getElementById('inner-voice-bg-input').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // å°†å›¾ç‰‡æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼Œä»¥ä¾¿ä¿å­˜å’Œæ˜¾ç¤º
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
        
        // è°ƒç”¨ä¿å­˜å‡½æ•°
        await saveInnerVoiceBackground(dataUrl);

        // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
        event.target.value = null; 
    });

// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// æƒ…ä¾£ç©ºé—´å–æ¶ˆå’Œè§£é™¤â–¼â–¼â–¼
document.getElementById('ls-cancel-space-btn').addEventListener('click', handleCancelLoversSpace);
document.getElementById('ls-disconnect-space-btn').addEventListener('click', handleDisconnectLoversSpace);
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸç²˜è´´

/* --- ã€å…¨æ–°ã€‘Userå¾®åšç§ä¿¡åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */

// 1. å¾®åšä¸»é¡µå³ä¸Šè§’çš„â€œç§ä¿¡â€æŒ‰é’®
// æˆ‘ä»¬éœ€è¦æ‰¾åˆ°è¿™ä¸ªæŒ‰é’®å¹¶ç»™å®ƒä¸€ä¸ªID
// (å‡è®¾ä½ åœ¨HTMLé‡Œå·²ç»ä¸ºå®ƒè®¾ç½®äº†id="weibo-my-dms-btn")
// æ³¨æ„ï¼šè¿™ä¸ªæŒ‰é’®æ˜¯ä½ éœ€è¦æ‰‹åŠ¨åŠ åˆ° .header-actions é‡Œçš„
const userDmBtn = document.getElementById('weibo-my-dms-btn');
if (userDmBtn) {
    userDmBtn.addEventListener('click', openUserDmListScreen);
}

// 2. ç§ä¿¡åˆ—è¡¨é¡µé¢çš„è¿”å›æŒ‰é’®
document.getElementById('back-from-user-dm-list').addEventListener('click', () => {
    // è¿”å›åˆ°å¾®åšä¸»é¡µ
    showScreen('weibo-screen');
    switchToWeiboView('weibo-my-profile-view');
});

// 3. ç§ä¿¡åˆ—è¡¨é¡µé¢çš„â€œç”Ÿæˆæ–°ç§ä¿¡â€å’Œâ€œæ¸…ç©ºâ€æŒ‰é’®
document.getElementById('generate-new-user-dms-btn').addEventListener('click', () => generateUserDms(true));
document.getElementById('clear-all-user-dms-btn').addEventListener('click', handleClearAllUserDms);

// 4. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç§ä¿¡åˆ—è¡¨çš„ç‚¹å‡»ï¼Œæ‰“å¼€èŠå¤©è¯¦æƒ…
document.getElementById('user-dm-list-container').addEventListener('click', (e) => {
    const item = e.target.closest('.dm-list-item');
    if (item && item.dataset.fanIndex) {
        openUserDmDetail(parseInt(item.dataset.fanIndex));
    }
});

// 5. ç§ä¿¡è¯¦æƒ…é¡µçš„è¿”å›æŒ‰é’®
document.getElementById('back-from-user-dm-detail').addEventListener('click', () => {
    showScreen('user-dm-list-screen'); // è¿”å›åˆ°ç§ä¿¡åˆ—è¡¨
});

// 6. ç§ä¿¡è¯¦æƒ…é¡µçš„å‘é€æŒ‰é’®å’Œå›è½¦å‘é€
document.getElementById('user-dm-send-btn').addEventListener('click', handleSendUserDm);
document.getElementById('user-dm-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('user-dm-send-btn').click();
    }
});

/* --- Userå¾®åšç§ä¿¡åŠŸèƒ½äº‹ä»¶ç›‘å¬ç»“æŸ --- */
// åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸç²˜è´´

// 7. ã€æ–°å¢ã€‘ç»‘å®šç§ä¿¡è¯¦æƒ…é¡µè¾“å…¥æ¡†çš„ä¸¤ä¸ªæ–°æŒ‰é’®
document.getElementById('user-dm-trigger-ai-btn').addEventListener('click', handleTriggerUserDmAiReply);
document.getElementById('user-dm-reroll-btn').addEventListener('click', handleUserDmReroll);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Userç§ä¿¡åˆ é™¤åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // --- 1. å•æ¡æ¶ˆæ¯åˆ é™¤çš„äº‹ä»¶å§”æ‰˜ ---
        document.getElementById('user-dm-messages-container').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.user-dm-message-delete-btn');
            if (deleteBtn) {
                // currentUserDmFanIndex æ˜¯ä½ å·²æœ‰çš„å…¨å±€å˜é‡ï¼Œç”¨äºè®°å½•å½“å‰æ­£åœ¨çœ‹çš„ç²‰ä¸ç´¢å¼•
                const messageIndex = parseInt(deleteBtn.dataset.messageIndex);
                if (currentUserDmFanIndex !== null && !isNaN(messageIndex)) {
                    handleDeleteUserDmMessage(currentUserDmFanIndex, messageIndex);
                }
            }
        });

        // --- 2. æ•´ä¸ªå¯¹è¯å·¦æ»‘åˆ é™¤çš„äº‹ä»¶ ---
        const userDmListEl = document.getElementById('user-dm-list-container');
        let userDmSwipeState = { isDragging: false, startX: 0, activeContent: null };

        // å…³é—­æ‰€æœ‰å·²æ»‘å¼€çš„é¡¹
        function resetAllUserDmSwipes(exceptThisOne = null) {
            document.querySelectorAll('.user-dm-list-item-content.swiped').forEach(content => {
                if (content !== exceptThisOne) {
                    content.classList.remove('swiped');
                }
            });
        }
        
        // ç›‘å¬é¼ æ ‡/è§¦æ‘¸å¼€å§‹
        userDmListEl.addEventListener('mousedown', (e) => {
            const content = e.target.closest('.user-dm-list-item-content');
            if (content) {
                resetAllUserDmSwipes(content);
                userDmSwipeState = { isDragging: true, startX: e.pageX, activeContent: content };
                e.preventDefault();
            }
        });
        userDmListEl.addEventListener('touchstart', (e) => {
            const content = e.target.closest('.user-dm-list-item-content');
            if (content) {
                resetAllUserDmSwipes(content);
                userDmSwipeState = { isDragging: true, startX: e.touches[0].pageX, activeContent: content };
            }
        }, { passive: true });

        // ç›‘å¬é¼ æ ‡/è§¦æ‘¸ç§»åŠ¨
        document.addEventListener('mousemove', (e) => {
            if (!userDmSwipeState.isDragging || !userDmSwipeState.activeContent) return;
            const diffX = e.pageX - userDmSwipeState.startX;
            if (diffX < 0 && diffX > -90) { // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»
                userDmSwipeState.activeContent.style.transition = 'none';
                userDmSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
            }
        });
        document.addEventListener('touchmove', (e) => {
             if (!userDmSwipeState.isDragging || !userDmSwipeState.activeContent) return;
             const diffX = e.touches[0].pageX - userDmSwipeState.startX;
             if (diffX < 0 && diffX > -90) {
                 userDmSwipeState.activeContent.style.transition = 'none';
                 userDmSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
             }
        }, { passive: true });

        // ç›‘å¬é¼ æ ‡/è§¦æ‘¸ç»“æŸ
        const handleUserDmSwipeEnd = (e) => {
            if (!userDmSwipeState.isDragging || !userDmSwipeState.activeContent) return;
            
            const content = userDmSwipeState.activeContent;
            content.style.transition = 'transform 0.3s ease';
            const transformStyle = window.getComputedStyle(content).transform;
            const currentTranslateX = new DOMMatrix(transformStyle).m41;

            if (currentTranslateX < -40) { // æ»‘åŠ¨è¶…è¿‡ä¸€åŠå°±è‡ªåŠ¨æ»‘å¼€
                content.classList.add('swiped');
            } else {
                content.classList.remove('swiped');
            }
            content.style.transform = ''; // æ¸…é™¤å†…è”æ ·å¼

            userDmSwipeState = { isDragging: false, activeContent: null }; // é‡ç½®çŠ¶æ€
        };
        document.addEventListener('mouseup', handleUserDmSwipeEnd);
        document.addEventListener('touchend', handleUserDmSwipeEnd);
        
        // --- 3. ç›‘å¬åˆ é™¤æŒ‰é’®çš„ç‚¹å‡» ---
        userDmListEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('swipe-action-btn') && e.target.classList.contains('delete')) {
                const fanIndex = parseInt(e.target.dataset.fanIndex);
                if (!isNaN(fanIndex)) {
                    handleDeleteUserDmConversation(fanIndex);
                }
            }
        });

        // â–²â–²â–² Userç§ä¿¡åˆ é™¤åŠŸèƒ½äº‹ä»¶ç›‘å¬ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ 'member-management-list' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('member-management-list').addEventListener('click', (e) => {
    const button = e.target.closest('.action-btn');
    if (!button) return;

    const action = button.dataset.action;
    const memberId = button.dataset.memberId;

    if (!action || !memberId) return;

    // --- å¤„ç†ç”¨æˆ·è‡ªå·±çš„æŒ‰é’® ---
    if (memberId === 'user') {
        if (action === 'set-nickname') handleSetUserNickname();
        if (action === 'set-title') handleSetUserTitle();
        // â˜…â˜…â˜… ã€æ ¸å¿ƒæ–°å¢ã€‘ç”¨æˆ·ç‚¹å‡»è‡ªå·±çš„â€œè§£ç¦â€æŒ‰é’® â˜…â˜…â˜…
        if (action === 'unmute-self') { 
            handleUserUnmute();
        }
        return;
    }

    // --- å¤„ç†å…¶ä»–æˆå‘˜çš„æŒ‰é’® ---
    switch (action) {
        case 'toggle-admin':
            handleToggleAdmin(memberId);
            break;
        case 'set-title':
            handleSetMemberTitle(memberId);
            break;
        case 'transfer-owner':
            handleTransferOwnership(memberId);
            break;
        case 'remove-member':
            removeMemberFromGroup(memberId);
            break;
        case 'mute-member': // â˜…â˜…â˜… ç¦è¨€/è§£ç¦ç»Ÿä¸€èµ°è¿™é‡Œ â˜…â˜…â˜…
            handleMuteMember(memberId);
            break;
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘ŠåŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('group-announcement-btn').addEventListener('click', openGroupAnnouncementModal);
// â–²â–²â–² äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ  â–¼â–¼â–¼
// ç»‘å®šç”¨æˆ·è¡¨æƒ…é¢æ¿çš„æ‰¹é‡åˆ é™¤æŒ‰é’®
document.getElementById('edit-user-stickers-btn').addEventListener('click', toggleUserStickerSelectionMode);
document.getElementById('done-user-stickers-btn').addEventListener('click', toggleUserStickerSelectionMode);
document.getElementById('delete-selected-user-stickers-btn').addEventListener('click', handleBulkDeleteUserStickers);

// ã€é‡è¦ã€‘å…³é—­é¢æ¿æ—¶ï¼Œä¹Ÿè¦é€€å‡ºé€‰æ‹©æ¨¡å¼
document.getElementById('close-sticker-panel-btn').addEventListener('click', () => {
    exitUserStickerSelectionMode();
    stickerPanel.classList.remove('visible');
});
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ  â–¼â–¼â–¼
// ç»‘å®šè§’è‰²è¡¨æƒ…ç®¡ç†é¡µçš„æ‰¹é‡åˆ é™¤æŒ‰é’®
document.getElementById('edit-char-stickers-btn').addEventListener('click', toggleCharStickerSelectionMode);
document.getElementById('done-char-stickers-btn').addEventListener('click', toggleCharStickerSelectionMode);
document.getElementById('delete-selected-char-stickers-btn').addEventListener('click', handleBulkDeleteCharStickers);

// ã€é‡è¦ã€‘è¿”å›èŠå¤©è®¾ç½®æ—¶ï¼Œä¹Ÿè¦é€€å‡ºé€‰æ‹©æ¨¡å¼
document.getElementById('back-from-sticker-manager').addEventListener('click', () => {
    exitCharStickerSelectionMode();
    showScreen('chat-interface-screen');
    document.getElementById('chat-settings-btn').click();
});
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå¿ƒå£°é¢æ¿ç¼–è¾‘æŒ‰é’®æ–°å¢çš„äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
        document.getElementById('inner-voice-modal').addEventListener('click', (e) => {
            if (e.target.closest('#inner-voice-edit-btn')) {
                showInnerVoiceEditOptions();
            }
        });
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°æ ·å¼ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
const ivEditorModal = document.getElementById('inner-voice-editor-modal');
const ivPanel = document.getElementById('inner-voice-main-panel');

// å®æ—¶é¢„è§ˆåŠŸèƒ½
ivEditorModal.addEventListener('input', (e) => {
    const targetId = e.target.id;
    const value = e.target.value;

    switch (targetId) {
        case 'iv-color-clothing':
            ivPanel.style.setProperty('--iv-color-clothing', value);
            break;
        case 'iv-color-behavior':
            ivPanel.style.setProperty('--iv-color-behavior', value);
            break;
        case 'iv-color-thoughts':
            ivPanel.style.setProperty('--iv-color-thoughts', value);
            break;
        case 'iv-color-naughty':
            ivPanel.style.setProperty('--iv-color-naughty', value);
            break;
        case 'iv-card-bg-color':
            ivPanel.style.setProperty('--iv-card-bg-rgb', hexToRgb(value));
            break;
        case 'iv-opacity-slider':
            document.getElementById('iv-opacity-value').textContent = `${Math.round(value * 100)}%`;
            ivPanel.style.setProperty('--iv-card-opacity', value);
            break;
                // â˜…â˜…â˜… åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„æ–° case â˜…â˜…â˜…
        case 'iv-icon-color':
            ivPanel.style.setProperty('--iv-icon-color', value);
            break;
    }
});

// ä¿å­˜æŒ‰é’®
document.getElementById('iv-editor-save-btn').addEventListener('click', saveInnerVoiceStyles);

// å–æ¶ˆæŒ‰é’®
document.getElementById('iv-editor-cancel-btn').addEventListener('click', () => {
    ivEditorModal.classList.remove('visible');
    // å–æ¶ˆæ—¶ï¼Œé‡æ–°åº”ç”¨ä¸€ä¸‹ä¿å­˜å¥½çš„æ ·å¼ï¼Œä»¥æ’¤é”€é¢„è§ˆæ”¹åŠ¨
    applySavedInnerVoiceStyles();
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘AIç”Ÿæˆç¾¤æˆå‘˜åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('ai-generate-members-btn').addEventListener('click', openAiGenerateMembersModal);
document.getElementById('cancel-ai-generate-members-btn').addEventListener('click', () => {
    document.getElementById('ai-generate-members-modal').classList.remove('visible');
});
document.getElementById('confirm-ai-generate-members-btn').addEventListener('click', handleGenerateMembers);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */
document.getElementById('date-a-live-app-icon').addEventListener('click', openDatingApp);
document.getElementById('refresh-dating-scene-btn').addEventListener('click', refreshDatingScenes);
document.getElementById('end-date-btn').addEventListener('click', endDate); // ç»‘å®šç»“æŸçº¦ä¼šæŒ‰é’®

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ 'dating-scene-content' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åˆ é™¤å’Œç‚¹å‡»
document.getElementById('dating-scene-content').addEventListener('click', (e) => {
    const card = e.target.closest('.dating-scene-card');
    if (!card) return;

    const sceneUid = card.dataset.uid;
    const scene = currentDatingScenes.find(s => s.uid === sceneUid);
    if (!scene) return;
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®
    if (e.target.classList.contains('dating-scene-delete-btn')) {
        deleteDatingScene(sceneUid);
    } else {
        // å¦åˆ™ï¼Œç‚¹å‡»çš„æ˜¯å¡ç‰‡æœ¬èº«ï¼Œæ‰“å¼€è§’è‰²é€‰æ‹©å™¨
        openDatingCharacterSelector(scene);
    }
});
// â–²â–²â–² æ–°å¢/ä¿®æ”¹äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç”¨è¿™å—ã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„ã€æ–‡æ¸¸æ–‡æœ¬æ¡†ç‚¹å‡»äº‹ä»¶ã€‘ â–¼â–¼â–¼

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°ä¸­ï¼Œç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„æ–‡æœ¬æ¡†ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼

// ä¸ºæ–‡æ¸¸æ–‡æœ¬æ¡†ç»‘å®šâ€œç‚¹å‡»åˆ‡æ¢ä¸‹ä¸€å¥â€çš„äº‹ä»¶ (å·²å¢åŠ ä¿æŠ¤)
document.querySelector('.dating-game-textbox').addEventListener('click', () => {
    if (
        datingGameState.isActive && 
        !datingGameState.isSwitchingSentence && // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆ‡æ¢ä¸­
        datingGameState.currentSentenceIndex < datingGameState.sentences.length - 1
    ) {
        showNextSentence();
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²



/* --- äº‹ä»¶ç›‘å¬ç»“æŸ --- */
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


/* --- äº‹ä»¶ç›‘å¬ç»“æŸ --- */
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜-æ–‡æ¸¸æ¨¡å¼UIäº‹ä»¶ç»‘å®š --- */

// å³ä¸Šè§’å›¾æ ‡
document.getElementById('dating-game-settings-btn').addEventListener('click', openDatingSettingsModal);
document.getElementById('dating-game-reroll-btn').addEventListener('click', handleDatingReroll);

// è®¾ç½®å¼¹çª—å†…çš„æŒ‰é’®
document.getElementById('cancel-dating-settings-btn').addEventListener('click', () => {
    document.getElementById('dating-game-settings-modal').classList.remove('visible');
    // å–æ¶ˆæ—¶ï¼Œè¦æ¢å¤åˆ°è§’è‰²å·²ä¿å­˜çš„è®¾ç½®ï¼Œè€Œä¸æ˜¯åœåœ¨ä¸´æ—¶ä¿®æ”¹çš„çŠ¶æ€
    const chat = state.chats[datingGameState.characterId];
    currentDatingUISettings = JSON.parse(JSON.stringify(chat.settings.datingUISettings || {}));
    applyDatingUISettings();
});
document.getElementById('save-dating-settings-btn').addEventListener('click', saveDatingSettings);

// å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
document.querySelector('#dating-game-settings-modal .bg-upload-container button').addEventListener('click', () => handleDatingImageUpload('bg'));
document.querySelector('#dating-game-settings-modal .form-group:nth-of-type(5) .bg-upload-container button').addEventListener('click', () => handleDatingImageUpload('sprite'));

// å›¾ç‰‡URLè¾“å…¥å®æ—¶æ›´æ–°
document.getElementById('dating-bg-url-input').addEventListener('input', (e) => {
    currentDatingUISettings.backgroundUrl = e.target.value.trim();
    applyDatingUISettings();
});
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ•´å—æ–°ä»£ç  â–¼â–¼â–¼

/* --- ã€å…¨æ–°ã€‘çº¦ä¼šç«‹ç»˜åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */
document.getElementById('manage-sprite-groups-btn').addEventListener('click', openSpriteGroupManager);
document.getElementById('close-sprite-group-manager-btn').addEventListener('click', () => {
    document.getElementById('sprite-group-manager-modal').classList.remove('visible');
});

document.getElementById('sprite-group-list-container').addEventListener('click', (e) => {
    const target = e.target;
    if (target.tagName === 'BUTTON' && target.dataset.id) {
        const action = target.dataset.action;
        const groupId = parseInt(target.dataset.id);
        if (action === 'edit') {
            openSpriteEditor(groupId);
        } else if (action === 'delete') {
            deleteSpriteGroup(groupId);
        }
    }
});

document.getElementById('create-new-sprite-group-btn').addEventListener('click', () => openSpriteEditor());

document.getElementById('cancel-sprite-editor-btn').addEventListener('click', () => {
    document.getElementById('sprite-editor-modal').classList.remove('visible');
});

document.getElementById('save-sprite-editor-btn').addEventListener('click', saveSpriteGroup);

document.getElementById('add-new-sprite-btn').addEventListener('click', () => {
    document.getElementById('sprite-list-editor').appendChild(createSpriteEditCard());
});
/* --- çº¦ä¼šç«‹ç»˜äº‹ä»¶ç›‘å¬å™¨ç»“æŸ --- */

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// é¢„è®¾åŠŸèƒ½æŒ‰é’®
document.getElementById('dating-preset-select').addEventListener('change', handleDatingPresetSelect);
document.getElementById('manage-dating-presets-btn').addEventListener('click', openDatingPresetManager);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šç»“ç®—å¡ç‰‡äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

/* --- çº¦ä¼šç»“ç®—å¡ç‰‡äº‹ä»¶ç»‘å®š --- */
const summaryCard = document.querySelector('.dating-summary-card');
const summaryCardBackBtn = document.getElementById('summary-flip-back-btn');

// 1. ç‚¹å‡»å¡ç‰‡æ­£é¢æˆ–èƒŒé¢çš„è¿”å›æŒ‰é’®ï¼Œéƒ½ä¼šè§¦å‘ç¿»è½¬
summaryCard.addEventListener('click', (e) => {
    // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯åˆ†äº«æˆ–å…³é—­æŒ‰é’®
    if (!e.target.closest('button')) {
        summaryCard.classList.toggle('is-flipped');
    }
});
summaryCardBackBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
    summaryCard.classList.remove('is-flipped');
});

// 2. åˆ†äº«æŒ‰é’®
document.getElementById('summary-share-btn').addEventListener('click', shareDatingSummary);

// 3. å…³é—­æŒ‰é’® (å·²ä¿®å¤ï¼Œæ”¯æŒä¸åŒåœºæ™¯)
document.getElementById('summary-close-btn').addEventListener('click', async () => {
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
    if (datingGameState.isActive) {
        // å¦‚æœåœ¨çº¦ä¼šä¸­ï¼Œèµ°åŸæ¥çš„ç¡®è®¤å¹¶ç»“æŸçº¦ä¼šçš„æµç¨‹
        const confirmed = await showCustomConfirm(
            'ç¡®è®¤å…³é—­',
            'ç¡®å®šè¦å…³é—­ç»“ç®—å¡ç‰‡å—ï¼Ÿå…³é—­åçº¦ä¼šå³å‘Šç»“æŸã€‚',
            { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            finalizeAndExitDate();
        }
    } else {
        // å¦‚æœåªæ˜¯åœ¨å•èŠé‡ŒæŸ¥çœ‹åˆ†äº«ï¼Œç›´æ¥å…³é—­å¼¹çª—å³å¯
        document.getElementById('dating-summary-overlay').classList.remove('visible');
        // åŒæ—¶é‡ç½®å¡ç‰‡ç¿»è½¬çŠ¶æ€ï¼Œä»¥é˜²ä¸‹æ¬¡æ‰“å¼€æœ‰é—®é¢˜
        const card = document.querySelector('.dating-summary-card');
        if (card) {
            card.classList.remove('is-flipped');
        }
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
});



// 4. èŠå¤©è®°å½•ä¸­çš„å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const chatCard = e.target.closest('.dating-summary-chat-card');
    // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘æˆ‘ä»¬ç°åœ¨æ£€æŸ¥ data-timestamp â–¼â–¼â–¼
    if (chatCard && chatCard.dataset.timestamp) {
        try {
            const timestamp = parseInt(chatCard.dataset.timestamp);
            const chat = state.chats[state.activeChatId];
            
            // ç”¨æ—¶é—´æˆ³ä»èŠå¤©è®°å½•é‡Œæ‰¾åˆ°é‚£æ¡åŸå§‹æ¶ˆæ¯
            const message = chat.history.find(m => m.timestamp === timestamp);
            
            // å¦‚æœæ‰¾åˆ°äº†ï¼Œç›´æ¥ç”¨å®ƒçš„ payload
            if (message && message.payload) {
                reopenDatingSummary(message.payload);
            } else {
                // å¦‚æœå› ä¸ºæŸç§åŸå› æ²¡æ‰¾åˆ°ï¼Œå†ç»™ä¸€ä¸ªæç¤º
                alert("æ— æ³•æ‰¾åˆ°å¯¹åº”çš„çº¦ä¼šè®°å½•æ•°æ®ã€‚");
            }
        } catch (error) {
            // è¿™ä¸ªcatchç°åœ¨å‡ ä¹ä¸ä¼šè§¦å‘äº†ï¼Œä½†ä¿ç•™ç€ä»¥é˜²ä¸‡ä¸€
            console.error("æ‰“å¼€åˆ†äº«çš„çº¦ä¼šè®°å½•å¤±è´¥:", error);
            alert("æ‰“å¼€çº¦ä¼šè®°å½•æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚");
        }
    }
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå†å²è®°å½•åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. ä¸ºâ€œçº¦ä¼šå¤§ä½œæˆ˜â€ä¸»ç•Œé¢çš„â€œå†å²â€å›¾æ ‡ç»‘å®šæ‰“å¼€äº‹ä»¶
document.getElementById('dating-history-btn').addEventListener('click', openDatingHistory);

// 2. ä¸ºâ€œå†å²çº¦ä¼šâ€é¡µé¢çš„è¿”å›æŒ‰é’®ç»‘å®šè¿”å›äº‹ä»¶
document.getElementById('dating-history-back-btn').addEventListener('click', () => showScreen('date-a-live-screen'));

// 3. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºå†å²åˆ—è¡¨ä¸­çš„æ‰€æœ‰å¡ç‰‡ç»‘å®šâ€œç¿»è½¬â€äº‹ä»¶
document.getElementById('dating-history-list').addEventListener('click', e => {
    // æ‰¾åˆ°è¢«ç‚¹å‡»çš„å¡ç‰‡
    const card = e.target.closest('.dating-summary-card');
    if (card) {
        // åˆ‡æ¢ is-flipped ç±»å³å¯è§¦å‘CSSåŠ¨ç”»
        card.classList.toggle('is-flipped');
    }
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸç²˜è´´

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¦ä¼šå¤§ä½œæˆ˜-åˆ›å»ºåœºæ™¯åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('create-dating-scene-btn').addEventListener('click', () => {
    // æ‰“å¼€åˆ›å»ºå¼¹çª—ï¼Œå¹¶æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('scene-name-input').value = '';
    document.getElementById('scene-image-url-input').value = '';
    document.getElementById('scene-cost-input').value = '';
    document.getElementById('create-dating-scene-modal').classList.add('visible');
});

document.getElementById('cancel-create-scene-btn').addEventListener('click', () => {
    document.getElementById('create-dating-scene-modal').classList.remove('visible');
});

document.getElementById('save-custom-scene-btn').addEventListener('click', handleSaveCustomDatingScene);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

/* --- çº¦ä¼šç»“ç®—äº‹ä»¶ç»‘å®šç»“æŸ --- */

// â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// --- è¡¨æƒ…åˆ†ç±»åŠŸèƒ½äº‹ä»¶ç»‘å®š ---
document.getElementById('move-selected-stickers-btn').addEventListener('click', openStickerCategoryModal);
document.getElementById('cancel-sticker-category-btn').addEventListener('click', () => {
    document.getElementById('sticker-category-modal').classList.remove('visible');
});
document.getElementById('confirm-sticker-category-btn').addEventListener('click', handleMoveStickers);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²



// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²


// ===================================================================
// 5. å¯åŠ¨ï¼

// åº”ç”¨å£çº¸å¹¶æ›´æ–°æ‰€æœ‰æ—¶é’Ÿ
applyLockscreenWallpaper();
updateLockClock();

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ä½  init() å‡½æ•°ä¸­æ—§çš„é”å±å’ŒçŠ¶æ€æ å¼€å…³é€»è¾‘ â–¼â–¼â–¼

// 1. è¯»å–ã€åº”ç”¨å¹¶ç›‘å¬â€œå¯ç”¨é”å±â€è®¾ç½®
const enableLockScreenToggle = document.getElementById('enable-lock-screen-toggle');
const lockScreenEnabled = localStorage.getItem('lockScreenEnabled') !== 'false';
enableLockScreenToggle.checked = lockScreenEnabled;

// 2. è¯»å–ã€åº”ç”¨å¹¶ç›‘å¬â€œæ˜¾ç¤ºçŠ¶æ€æ â€è®¾ç½®
const showStatusBarToggle = document.getElementById('show-status-bar-toggle');
const statusBar = document.getElementById('status-bar');
// è¯»å–ä¿å­˜çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡ä¿å­˜è¿‡ï¼Œé»˜è®¤æ˜¯ true (æ˜¾ç¤º)
const showStatusBar = localStorage.getItem('showStatusBar') !== 'false'; 
// è®©å¼€å…³çš„çŠ¶æ€å’Œä¿å­˜çš„çŠ¶æ€åŒæ­¥
showStatusBarToggle.checked = showStatusBar; 
// æ ¹æ®ä¿å­˜çš„çŠ¶æ€ï¼Œå†³å®šä¸€åŠ è½½è¿›æ¥æ—¶æ˜¯å¦æ˜¾ç¤ºçŠ¶æ€æ 
if (showStatusBar) {
    statusBar.style.display = 'flex';
} else {
    statusBar.style.display = 'none';
}

// 3. ã€å…³é”®ã€‘ç»™å¼€å…³æ·»åŠ â€œå˜åŒ–â€ç›‘å¬å™¨ï¼Œè¿™æ ·ä½ æ¯æ¬¡ç‚¹å‡»å®ƒéƒ½ä¼šä¿å­˜çŠ¶æ€
showStatusBarToggle.addEventListener('change', (e) => {
    const isEnabled = e.target.checked;
    // a. å°†æ–°çš„å¼€å…³çŠ¶æ€ (true æˆ– false) ä¿å­˜åˆ°æµè§ˆå™¨çš„ localStorage é‡Œ
    localStorage.setItem('showStatusBar', isEnabled);
    // b. ç«‹åˆ»æ ¹æ®æ–°çš„çŠ¶æ€æ¥æ˜¾ç¤ºæˆ–éšè—çŠ¶æ€æ 
    statusBar.style.display = isEnabled ? 'flex' : 'none';
});

// 4. æ ¹æ®æœ€ç»ˆçš„é”å±è®¾ç½®ï¼Œå†³å®šåº”ç”¨å¯åŠ¨æ—¶ç¬¬ä¸€ä¸ªæ˜¾ç¤ºçš„å±å¹•
if (lockScreenEnabled) {
    lockPhone(); // å¦‚æœè®¾ç½®æ˜¯â€œå¯ç”¨â€ï¼Œå°±é”å®šæ‰‹æœº
} else {
    showScreen('home-screen'); // å¦åˆ™ï¼Œç›´æ¥è¿›å…¥ä¸»å±å¹•
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        }

        init();

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™ä¸ªâ€œå…¨å±€æ¥å£â€éƒ¨åˆ† â–¼â–¼â–¼

/*
 * ===================================================================
 * === å…¨å±€æ¥å£ (Public API for other scripts) ===
 * ===================================================================
 * å°†ä¸»åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½æš´éœ²ç»™å…¶ä»–è„šæœ¬æ–‡ä»¶ï¼ˆå¦‚ game-hall.jsï¼‰ä½¿ç”¨
 */
window.openChat = openChat;
window.triggerAiResponse = triggerAiResponse;

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
 // â–¼â–¼â–¼ æŠŠè¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œç²˜è´´åˆ° <script> æ ‡ç­¾å†…çš„ã€å˜é‡å®šä¹‰åŒºåŸŸã€‘çš„æœ«å°¾ â–¼â–¼â–¼

const avatarFrames = [
    { id: 'none', url: '', name: 'æ— ' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, 
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, 
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, 
    { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, 
    { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, 
    { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, 
    { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, 
    { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, 
    { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, 
    { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, 
    { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, 
    { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, 
    { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, 
    { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, 
    { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
    { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
    { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
    { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
];

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²       
    });
</script>
<!-- â–¼â–¼â–¼ è¿™æ˜¯æˆ‘ä»¬æ–°åŠ çš„éšè—æ–‡ä»¶é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
<input type="file" id="character-card-input" accept=".png, .json" style="display: none;">
<!-- â–²â–²â–² æ–‡ä»¶é€‰æ‹©å™¨ç»“æŸ â–²â–²â–² -->
<input type="file" id="world-book-import-input" accept=".json, .jsonl" style="display: none;">
<input type="file" id="ludo-qbank-import-input" accept=".json" hidden>
<input type="file" id="inner-voice-bg-input" accept="image/*" hidden>
</body>
</html>
